<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=zh class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.96.0"><meta name=robots content="index, follow"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>深入Istio系列-Sidecar 注入、透明流量劫持及流量路由过程详解 | 云原生技术圈</title><meta name=description content="本文最早是基于 Istio 1.11 撰写，之后随着 Istio 的版本陆续更新，最新更新时间为 2022 年 5 月 12 日，关于本文历史版本的更新说明请见文章最后。本文记录了详细的实践过程，力图能够让读者复现，因此事无巨细，想要理解某个部分过程的读者可以使用目录跳转到对应的小节阅读。
为了理解本文希望你先阅读以下内容：
 理解 iptables Istio 数据平面 Pod 启动过程详解  内容介绍 本文基于 Istio 1.13 版本，将为大家介绍以下内容：
 什么是 sidecar 模式和它的优势在哪里。 Istio 中是如何做 sidecar 注入的。 Sidecar 代理是如何做透明流量劫持的。 iptables 的路由规则。 Envoy 代理是如何路由流量到上游的。  请大家结合下图理解本文中的内容，本图基于 Istio 官方提供的 Bookinfo 示例绘制，展示的是 reviews Pod 的内部结构，包括 Linux Kernel 空间中的 iptables 规则、Sidecar 容器、应用容器。
productpage 访问 reviews Pod，入站流量处理过程对应于图示上的步骤：1、2、3、4、Envoy Inbound Handler、5、6、7、8、应用容器。
reviews Pod 访问 rating 服务的出站流量处理过程对应于图示上的步骤是：9、10、11、12、Envoy Outbound Handler、13、14、15。
注意：图中的路径 16 近用于路由规则说明，它不不出现在当前示例中。实际上仅当 Pod 内发出的对当前 Pod 内的服务访问的时候才会途径它。"><meta property="og:title" content="深入Istio系列-Sidecar 注入、透明流量劫持及流量路由过程详解"><meta property="og:description" content="本文最早是基于 Istio 1.11 撰写，之后随着 Istio 的版本陆续更新，最新更新时间为 2022 年 5 月 12 日，关于本文历史版本的更新说明请见文章最后。本文记录了详细的实践过程，力图能够让读者复现，因此事无巨细，想要理解某个部分过程的读者可以使用目录跳转到对应的小节阅读。
为了理解本文希望你先阅读以下内容：
 理解 iptables Istio 数据平面 Pod 启动过程详解  内容介绍 本文基于 Istio 1.13 版本，将为大家介绍以下内容：
 什么是 sidecar 模式和它的优势在哪里。 Istio 中是如何做 sidecar 注入的。 Sidecar 代理是如何做透明流量劫持的。 iptables 的路由规则。 Envoy 代理是如何路由流量到上游的。  请大家结合下图理解本文中的内容，本图基于 Istio 官方提供的 Bookinfo 示例绘制，展示的是 reviews Pod 的内部结构，包括 Linux Kernel 空间中的 iptables 规则、Sidecar 容器、应用容器。
productpage 访问 reviews Pod，入站流量处理过程对应于图示上的步骤：1、2、3、4、Envoy Inbound Handler、5、6、7、8、应用容器。
reviews Pod 访问 rating 服务的出站流量处理过程对应于图示上的步骤是：9、10、11、12、Envoy Outbound Handler、13、14、15。
注意：图中的路径 16 近用于路由规则说明，它不不出现在当前示例中。实际上仅当 Pod 内发出的对当前 Pod 内的服务访问的时候才会途径它。"><meta property="og:type" content="article"><meta property="og:url" content="https://sreionet.github.io/blog/2022/09/11/fe0ba1/"><meta property="article:section" content="blog"><meta property="article:published_time" content="2022-09-11T14:26:02+08:00"><meta property="article:modified_time" content="2022-09-11T14:26:02+08:00"><meta property="og:site_name" content="云原生技术圈"><meta itemprop=name content="深入Istio系列-Sidecar 注入、透明流量劫持及流量路由过程详解"><meta itemprop=description content="本文最早是基于 Istio 1.11 撰写，之后随着 Istio 的版本陆续更新，最新更新时间为 2022 年 5 月 12 日，关于本文历史版本的更新说明请见文章最后。本文记录了详细的实践过程，力图能够让读者复现，因此事无巨细，想要理解某个部分过程的读者可以使用目录跳转到对应的小节阅读。
为了理解本文希望你先阅读以下内容：
 理解 iptables Istio 数据平面 Pod 启动过程详解  内容介绍 本文基于 Istio 1.13 版本，将为大家介绍以下内容：
 什么是 sidecar 模式和它的优势在哪里。 Istio 中是如何做 sidecar 注入的。 Sidecar 代理是如何做透明流量劫持的。 iptables 的路由规则。 Envoy 代理是如何路由流量到上游的。  请大家结合下图理解本文中的内容，本图基于 Istio 官方提供的 Bookinfo 示例绘制，展示的是 reviews Pod 的内部结构，包括 Linux Kernel 空间中的 iptables 规则、Sidecar 容器、应用容器。
productpage 访问 reviews Pod，入站流量处理过程对应于图示上的步骤：1、2、3、4、Envoy Inbound Handler、5、6、7、8、应用容器。
reviews Pod 访问 rating 服务的出站流量处理过程对应于图示上的步骤是：9、10、11、12、Envoy Outbound Handler、13、14、15。
注意：图中的路径 16 近用于路由规则说明，它不不出现在当前示例中。实际上仅当 Pod 内发出的对当前 Pod 内的服务访问的时候才会途径它。"><meta itemprop=datePublished content="2022-09-11T14:26:02+08:00"><meta itemprop=dateModified content="2022-09-11T14:26:02+08:00"><meta itemprop=wordCount content="2388"><meta itemprop=keywords content="istio,转载,"><meta name=twitter:card content="summary"><meta name=twitter:title content="深入Istio系列-Sidecar 注入、透明流量劫持及流量路由过程详解"><meta name=twitter:description content="本文最早是基于 Istio 1.11 撰写，之后随着 Istio 的版本陆续更新，最新更新时间为 2022 年 5 月 12 日，关于本文历史版本的更新说明请见文章最后。本文记录了详细的实践过程，力图能够让读者复现，因此事无巨细，想要理解某个部分过程的读者可以使用目录跳转到对应的小节阅读。
为了理解本文希望你先阅读以下内容：
 理解 iptables Istio 数据平面 Pod 启动过程详解  内容介绍 本文基于 Istio 1.13 版本，将为大家介绍以下内容：
 什么是 sidecar 模式和它的优势在哪里。 Istio 中是如何做 sidecar 注入的。 Sidecar 代理是如何做透明流量劫持的。 iptables 的路由规则。 Envoy 代理是如何路由流量到上游的。  请大家结合下图理解本文中的内容，本图基于 Istio 官方提供的 Bookinfo 示例绘制，展示的是 reviews Pod 的内部结构，包括 Linux Kernel 空间中的 iptables 规则、Sidecar 容器、应用容器。
productpage 访问 reviews Pod，入站流量处理过程对应于图示上的步骤：1、2、3、4、Envoy Inbound Handler、5、6、7、8、应用容器。
reviews Pod 访问 rating 服务的出站流量处理过程对应于图示上的步骤是：9、10、11、12、Envoy Outbound Handler、13、14、15。
注意：图中的路径 16 近用于路由规则说明，它不不出现在当前示例中。实际上仅当 Pod 内发出的对当前 Pod 内的服务访问的时候才会途径它。"><link rel=preload href=/scss/main.min.d7bb2255c5e6435c81fb7d8f4e2d6dfb0c1b5db5f695f0117b53d4a291eeca4d.css as=style><link href=/scss/main.min.d7bb2255c5e6435c81fb7d8f4e2d6dfb0c1b5db5f695f0117b53d4a291eeca4d.css rel=stylesheet integrity><script src=https://code.jquery.com/jquery-3.6.0.min.js integrity=sha384-vtXRMe3mGCbOeY7l30aIg8H9p3GdeSe4IFlP6G8JMa7o7lXvnz3GFKzPxzJdPfGK crossorigin=anonymous></script>
<script defer src=https://unpkg.com/lunr@2.3.9/lunr.min.js integrity=sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli crossorigin=anonymous></script></head><body class="td-page td-blog"><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar"><a class=navbar-brand href=/><span class="navbar-brand__logo navbar-logo"><svg id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 500 500" style="enable-background:new 0 0 500 500"><g><path style="fill:#fff" d="M116.8525 421.9722c-5.7041.0-10.3442-4.3127-10.3442-9.6129V88.183c0-5.3002 4.6401-9.6117 10.3442-9.6117H320.858c3.0347.0 9.3959.5498 11.7506 2.6302l.3545.3442 58.905 63.2912c2.3101 2.491 2.9202 8.4928 2.9202 11.3184v256.2039c0 5.3002-4.6407 9.6129-10.3436 9.6129H116.8525z"/><g><g><g><path style="fill:#767676" d="M384.4445 423.2066H116.852c-6.3839.0-11.5786-4.8658-11.5786-10.8474V88.1831c0-5.9804 5.1947-10.8461 11.5786-10.8461h204.0062c.377.0 9.2786.0329 12.568 2.9389l.3947.3833 58.9508 63.337c3.2135 3.4652 3.2514 11.7924 3.2514 12.1593v256.2036C396.0231 418.3408 390.8284 423.2066 384.4445 423.2066zM116.5079 411.9189c.0848.0278.1999.0531.3441.0531h267.5925c.1442.0.2581-.0253.3441-.0531V156.1556c-.0076-.9033-.3593-3.7347-.7034-5.0037l-57.6527-61.9416c-1.4651-.3176-4.4533-.6389-5.5742-.6389H116.852c-.143.0-.2594.024-.3441.0531V411.9189zm267.4533-261.149zM327.0321 89.371v.0013V89.371z"/></g></g></g><g><g><path style="fill:#5b7fc0" d="M189.0874 210.1754l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.025 2.454-11.4897 6.4116-15.4473C177.5953 212.627 183.0601 210.1742 189.0874 210.1754zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403S197.0816 234.1722 197.0804 232.033z"/><path style="opacity:.3;fill:#fff" d="M189.0898 210.176c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 212.6276 183.0612 210.176 189.0898 210.176zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 236.239 197.0839 234.2399 197.0839 232.0372z"/><g><defs><path id="SVGID_1_" d="M194.7376 237.6875c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.999 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 234.2399 196.1861 236.239 194.7376 237.6875z"/></defs><clipPath id="SVGID_2_"><use xlink:href="#SVGID_1_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_2_);fill:#fff" d="M190.0704 225.0237c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 225.7247 191.9774 225.0237 190.0704 225.0237z"/><path style="opacity:.13;clip-path:url(#SVGID_2_);fill:#020202" d="M190.0704 225.0237c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 225.7247 191.9774 225.0237 190.0704 225.0237z"/></g><g><defs><path id="SVGID_3_" d="M189.0898 210.176c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 212.6276 183.0612 210.176 189.0898 210.176zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 236.239 197.0839 234.2399 197.0839 232.0372z"/></defs><clipPath id="SVGID_4_"><use xlink:href="#SVGID_3_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_4_);fill:#5b7fc0" d="M172.6595 215.6045c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8612 12.0547.0024 21.8636-9.797 21.8613-21.8612.0024-3.8475-1.0151-7.6326-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 209.1953 176.6171 211.647 172.6595 215.6045z"/></g></g><rect x="198.8952" y="225.1043" style="fill:#5b7fc0" width="122.6266" height="13.8671"/></g><g><path style="fill:#d95140" d="M189.0874 155.7611l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.0249 2.454-11.4897 6.4116-15.4473C177.5953 158.2128 183.0601 155.7599 189.0874 155.7611zm7.993 21.8577c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403C196.2508 181.7667 197.0816 179.758 197.0804 177.6188z"/><path style="opacity:.3;fill:#fff" d="M189.0898 155.7617c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 158.2134 183.0612 155.7617 189.0898 155.7617zm7.9941 21.8613c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 181.8248 197.0839 179.8256 197.0839 177.623z"/><g><defs><path id="SVGID_5_" d="M194.7376 183.2733c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.9989 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 179.8256 196.1861 181.8248 194.7376 183.2733z"/></defs><clipPath id="SVGID_6_"><use xlink:href="#SVGID_5_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_6_);fill:#fff" d="M190.0704 170.6095c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 171.3104 191.9774 170.6095 190.0704 170.6095z"/><path style="opacity:.13;clip-path:url(#SVGID_6_);fill:#020202" d="M190.0704 170.6095c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 171.3104 191.9774 170.6095 190.0704 170.6095z"/></g><g><defs><path id="SVGID_7_" d="M189.0898 155.7617c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 158.2134 183.0612 155.7617 189.0898 155.7617zm7.9941 21.8613c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 181.8248 197.0839 179.8256 197.0839 177.623z"/></defs><clipPath id="SVGID_8_"><use xlink:href="#SVGID_7_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_8_);fill:#d95140" d="M172.6595 161.1903c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8613 12.0547.0024 21.8636-9.797 21.8613-21.8613.0024-3.8474-1.0151-7.6326-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 154.7811 176.6171 157.2327 172.6595 161.1903z"/></g><rect x="198.8952" y="170.69" style="fill:#d95140" width="122.6266" height="13.8671"/></g><g><g><path style="fill:#56a55c" d="M189.5379 264.6147l.0012-.0012c7.7751.0012 15.0294 4.1862 18.932 10.9235 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032-5.8394.0-11.3281-2.2733-15.458-6.4032-4.13-4.13-6.4032-9.6186-6.4056-15.4628.0012-6.0249 2.454-11.4897 6.4116-15.4472C178.0458 267.0663 183.5105 264.6135 189.5379 264.6147zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6538 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403C196.7013 290.6202 197.5321 288.6115 197.5309 286.4723z"/><path style="opacity:.3;fill:#fff" d="M189.5403 264.6153c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8065-21.8612-21.8613.0-6.0285 2.4516-11.492 6.4116-15.452C178.0482 267.0669 183.5117 264.6153 189.5403 264.6153zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.6366 290.6783 197.5344 288.6792 197.5344 286.4765z"/><g><defs><path id="SVGID_9_" d="M195.1881 292.1268c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.9989 7.9942-7.9941 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.5344 288.6792 196.6366 290.6783 195.1881 292.1268z"/></defs><clipPath id="SVGID_10_"><use xlink:href="#SVGID_9_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_10_);fill:#fff" d="M190.5209 279.463c-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7446-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9941 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C194.239 280.164 192.4279 279.463 190.5209 279.463z"/><path style="opacity:.13;clip-path:url(#SVGID_10_);fill:#020202" d="M190.5209 279.463c-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7446-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9941 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C194.239 280.164 192.4279 279.463 190.5209 279.463z"/></g><g><defs><path id="SVGID_11_" d="M189.5403 264.6153c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8065-21.8612-21.8613.0-6.0285 2.4516-11.492 6.4116-15.452C178.0482 267.0669 183.5117 264.6153 189.5403 264.6153zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.6366 290.6783 197.5344 288.6792 197.5344 286.4765z"/></defs><clipPath id="SVGID_12_"><use xlink:href="#SVGID_11_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_12_);fill:#56a55c" d="M173.11 270.0439c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8613 12.0547.0024 21.8636-9.797 21.8613-21.8613.0024-3.8474-1.0151-7.6326-2.9353-10.9462-3.8977-6.7325-11.1497-10.9151-18.926-10.9151C182.5311 263.6346 177.0676 266.0863 173.11 270.0439z"/></g></g><rect x="199.3456" y="279.5436" style="fill:#56a55c" width="122.6266" height="13.8671"/></g><g><g><path style="fill:#f1bc42" d="M189.0874 318.7208l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3305-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.025 2.454-11.4897 6.4116-15.4472C177.5953 321.1724 183.0601 318.7196 189.0874 318.7208zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403S197.0816 342.7176 197.0804 340.5784z"/><path style="opacity:.3;fill:#fff" d="M189.0898 318.7214c7.7763.0 15.0283 4.1826 18.926 10.915 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8612-12.0547.0024-21.8636-9.8065-21.8612-21.8612.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 321.173 183.0612 318.7214 189.0898 318.7214zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 344.7844 197.0839 342.7853 197.0839 340.5826z"/><g><defs><path id="SVGID_13_" d="M194.7376 346.2329c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.999 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 342.7853 196.1861 344.7844 194.7376 346.2329z"/></defs><clipPath id="SVGID_14_"><use xlink:href="#SVGID_13_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_14_);fill:#fff" d="M190.0704 333.5691c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0834 6.1218 2.8788C193.7885 334.2701 191.9774 333.5691 190.0704 333.5691z"/><path style="opacity:.13;clip-path:url(#SVGID_14_);fill:#020202" d="M190.0704 333.5691c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0834 6.1218 2.8788C193.7885 334.2701 191.9774 333.5691 190.0704 333.5691z"/></g><g><defs><path id="SVGID_15_" d="M189.0898 318.7214c7.7763.0 15.0283 4.1826 18.926 10.915 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8612-12.0547.0024-21.8636-9.8065-21.8612-21.8612.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 321.173 183.0612 318.7214 189.0898 318.7214zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 344.7844 197.0839 342.7853 197.0839 340.5826z"/></defs><clipPath id="SVGID_16_"><use xlink:href="#SVGID_15_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_16_);fill:#f1bc42" d="M172.6595 324.15c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8612 12.0547.0024 21.8636-9.797 21.8613-21.8612.0024-3.8474-1.0151-7.6327-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 317.7407 176.6171 320.1924 172.6595 324.15z"/></g></g><rect x="198.8952" y="333.6497" style="fill:#f1bc42" width="122.6266" height="13.8671"/></g></g></svg></span><span class=navbar-brand__name>云原生技术圈</span></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/docs><span>文档</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/blog><span>博客</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=https://github.com/sreionet/sreionet.github.io/ target=_blank><i class="fa-brands fa-github"></i><span>GitHub</span></a></li><li class="nav-item dropdown mr-4 d-none d-lg-block"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>Versions</a><div class=dropdown-menu aria-labelledby=navbarDropdownMenuLink><a class=dropdown-item href=https://sreionet.github.io/v0.2>v0.2</a>
<a class=dropdown-item href=https://sreionet.github.io/v0.3>v0.3</a></div></li></ul></div><div class="navbar-nav d-none d-lg-block"><div class="td-search td-search--offline"><div class=td-search__icon></div><input type=search class="td-search__input form-control" placeholder aria-label autocomplete=off data-offline-search-index-json-src=/offline-search-index.c2b4906e6009c93538e754e13b898849.json data-offline-search-base-href=/ data-offline-search-max-results=10></div></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><aside class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none"><div id=td-sidebar-menu class=td-sidebar__inner><form class="td-sidebar__search d-flex align-items-center"><div class="td-search td-search--offline"><div class=td-search__icon></div><input type=search class="td-search__input form-control" placeholder aria-label autocomplete=off data-offline-search-index-json-src=/offline-search-index.c2b4906e6009c93538e754e13b898849.json data-offline-search-base-href=/ data-offline-search-max-results=10></div><button class="btn btn-link td-sidebar__toggle d-md-none p-0 ml-3 fas fa-bars" type=button data-toggle=collapse data-target=#td-section-nav aria-controls=td-section-nav aria-expanded=false aria-label="Toggle section navigation"></button></form><nav class="collapse td-sidebar-nav" id=td-section-nav><ul class="td-sidebar-nav__section pr-md-3 ul-0"><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-blog-li><a href=/blog/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section tree-root" id=m-blog><span>博客</span></a><ul class=ul-1><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20230112istioe58fafe8a782e6b58be680a7e7b3bbe58897-e79b91e68ea7e68c87e6a087e6b2a1e69c89e4b88ae68aa5-li><a href=/blog/2023/01/12/istio%E5%8F%AF%E8%A7%82%E6%B5%8B%E6%80%A7%E7%B3%BB%E5%88%97-%E7%9B%91%E6%8E%A7%E6%8C%87%E6%A0%87%E6%B2%A1%E6%9C%89%E4%B8%8A%E6%8A%A5/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20230112istioe58fafe8a782e6b58be680a7e7b3bbe58897-e79b91e68ea7e68c87e6a087e6b2a1e69c89e4b88ae68aa5><span>Istio可观测性系列-监控指标没有上报</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20230112istioe58fafe8a782e6b58be680a7e7b3bbe58897-e887aae5ae9ae4b989e68c87e6a087-li><a href=/blog/2023/01/12/istio%E5%8F%AF%E8%A7%82%E6%B5%8B%E6%80%A7%E7%B3%BB%E5%88%97-%E8%87%AA%E5%AE%9A%E4%B9%89%E6%8C%87%E6%A0%87/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20230112istioe58fafe8a782e6b58be680a7e7b3bbe58897-e887aae5ae9ae4b989e68c87e6a087><span>Istio可观测性系列-自定义指标</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20230112istioctle5b7a5e585b7e4bdbfe794a8e68c87e58d97-li><a href=/blog/2023/01/12/istioctl%E5%B7%A5%E5%85%B7%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20230112istioctle5b7a5e585b7e4bdbfe794a8e68c87e58d97><span>istioctl工具使用指南</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog202209163d18d6-li><a href=/blog/2022/09/16/3d18d6/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog202209163d18d6><span>深入Istio系列-Pilot agent</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog202209136899d1-li><a href=/blog/2022/09/13/6899d1/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog202209136899d1><span>Istio可观测性系列-性能指标</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog202209130affe7-li><a href=/blog/2022/09/13/0affe7/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog202209130affe7><span>Envoy性能指标</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog202209126be15f-li><a href=/blog/2022/09/12/6be15f/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog202209126be15f><span>深入Istio系列-组件详解</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog2022091161aaaf-li><a href=/blog/2022/09/11/61aaaf/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog2022091161aaaf><span>深入Istio系列-Sidecar 中的流量类型及 iptables 规则详解</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child active-path" id=m-blog20220911fe0ba1-li><a href=/blog/2022/09/11/fe0ba1/ class="align-left pl-0 active td-sidebar-link td-sidebar-link__page" id=m-blog20220911fe0ba1><span class=td-sidebar-nav-active-item>深入Istio系列-Sidecar 注入、透明流量劫持及流量路由过程详解</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20220911dd0bd7-li><a href=/blog/2022/09/11/dd0bd7/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20220911dd0bd7><span>深入Istio系列-Sidecar自动注入</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20220911bf667a-li><a href=/blog/2022/09/11/bf667a/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20220911bf667a><span>Istio部署实战</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20220910dc5625-li><a href=/blog/2022/09/10/dc5625/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20220910dc5625><span>深入Istio系列-数据平面Pod启动过程详解</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20220910b7e1eb-li><a href=/blog/2022/09/10/b7e1eb/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20220910b7e1eb><span>理解Iptable</span></a></li></ul></li></ul></nav></div></aside><aside class="d-none d-xl-block col-xl-2 td-sidebar-toc d-print-none"><div class="td-page-meta ml-2 pb-1 pt-2 mb-0"></div><div class=td-toc><nav id=TableOfContents><ul><li><a href=#内容介绍>内容介绍</a></li><li><a href=#sidecar-模式>Sidecar 模式</a><ul><li><a href=#使用-sidecar-模式的优势>使用 Sidecar 模式的优势</a></li></ul></li><li><a href=#sidecar-注入示例分析>Sidecar 注入示例分析</a></li><li><a href=#iptables-规则注入解析>iptables 规则注入解析</a><ul><li><a href=#在-minikube-中查看容器中的-iptabes-规则>在 minikube 中查看容器中的 iptabes 规则</a></li><li><a href=#在-gke-中查看容器的-iptables-规则>在 GKE 中查看容器的 iptables 规则</a></li></ul></li><li><a href=#iptables-流量劫持过程详解>iptables 流量劫持过程详解</a></li><li><a href=#流量路由过程详解>流量路由过程详解</a><ul><li><a href=#理解-inbound-handler>理解 Inbound Handler</a></li><li><a href=#理解-outbound-handler>理解 Outbound Handler</a></li></ul></li><li><a href=#小结>小结</a><ul><li><a href=#使用-iptables-做流量劫持时存在的问题>使用 iptables 做流量劫持时存在的问题</a></li><li><a href=#透明劫持方案优化>透明劫持方案优化</a></li></ul></li><li><a href=#更新说明>更新说明</a></li><li><a href=#参考>参考</a></li></ul></nav></div><div class="taxonomy taxonomy-terms-cloud taxo-categories"><h5 class=taxonomy-title>Categories</h5><ul class=taxonomy-terms><li><a class=taxonomy-term href=https://sreionet.github.io/categories/hugo/ data-taxonomy-term=hugo><span class=taxonomy-label>hugo</span><span class=taxonomy-count>2</span></a></li><li><a class=taxonomy-term href=https://sreionet.github.io/categories/istio/ data-taxonomy-term=istio><span class=taxonomy-label>istio</span><span class=taxonomy-count>5</span></a></li><li><a class=taxonomy-term href=https://sreionet.github.io/categories/%E4%BA%91%E5%8E%9F%E7%94%9F/ data-taxonomy-term=%E4%BA%91%E5%8E%9F%E7%94%9F><span class=taxonomy-label>云原生</span><span class=taxonomy-count>10</span></a></li></ul></div><div class="taxonomy taxonomy-terms-cloud taxo-tags"><h5 class=taxonomy-title>Tags</h5><ul class=taxonomy-terms><li><a class=taxonomy-term href=https://sreionet.github.io/tags/envoy/ data-taxonomy-term=envoy><span class=taxonomy-label>envoy</span><span class=taxonomy-count>1</span></a></li><li><a class=taxonomy-term href=https://sreionet.github.io/tags/githubaction/ data-taxonomy-term=githubaction><span class=taxonomy-label>GithubAction</span><span class=taxonomy-count>1</span></a></li><li><a class=taxonomy-term href=https://sreionet.github.io/tags/hugo/ data-taxonomy-term=hugo><span class=taxonomy-label>hugo</span><span class=taxonomy-count>2</span></a></li><li><a class=taxonomy-term href=https://sreionet.github.io/tags/iptable/ data-taxonomy-term=iptable><span class=taxonomy-label>iptable</span><span class=taxonomy-count>1</span></a></li><li><a class=taxonomy-term href=https://sreionet.github.io/tags/istio/ data-taxonomy-term=istio><span class=taxonomy-label>istio</span><span class=taxonomy-count>11</span></a></li><li><a class=taxonomy-term href=https://sreionet.github.io/tags/istioctl/ data-taxonomy-term=istioctl><span class=taxonomy-label>istioctl</span><span class=taxonomy-count>1</span></a></li><li><a class=taxonomy-term href=https://sreionet.github.io/tags/metrics/ data-taxonomy-term=metrics><span class=taxonomy-label>metrics</span><span class=taxonomy-count>2</span></a></li><li><a class=taxonomy-term href=https://sreionet.github.io/tags/pilot/ data-taxonomy-term=pilot><span class=taxonomy-label>pilot</span><span class=taxonomy-count>1</span></a></li><li><a class=taxonomy-term href=https://sreionet.github.io/tags/sicader/ data-taxonomy-term=sicader><span class=taxonomy-label>sicader</span><span class=taxonomy-count>2</span></a></li><li><a class=taxonomy-term href=https://sreionet.github.io/tags/sidecar/ data-taxonomy-term=sidecar><span class=taxonomy-label>Sidecar</span><span class=taxonomy-count>1</span></a></li><li><a class=taxonomy-term href=https://sreionet.github.io/tags/%E8%BD%AC%E8%BD%BD/ data-taxonomy-term=%E8%BD%AC%E8%BD%BD><span class=taxonomy-label>转载</span><span class=taxonomy-count>7</span></a></li></ul></div></aside><main class="col-12 col-md-9 col-xl-8 pl-md-5 pr-md-4" role=main><a class=td-rss-button title=RSS href=https://sreionet.github.io/blog/index.xml target=_blank rel=noopener><i class="fa-solid fa-rss" aria-hidden=true></i></a><div class=td-content><h1>深入Istio系列-Sidecar 注入、透明流量劫持及流量路由过程详解</h1><div class="td-byline mb-4"><b>kbsonlong</b> |
<time datetime=2022-09-11 class=text-muted>11.09.2022</time></div><header class=article-meta><div class="taxonomy taxonomy-terms-article taxo-categories"><h5 class=taxonomy-title>Categories:</h5><ul class=taxonomy-terms><li><a class=taxonomy-term href=https://sreionet.github.io/categories/%E4%BA%91%E5%8E%9F%E7%94%9F/ data-taxonomy-term=%E4%BA%91%E5%8E%9F%E7%94%9F><span class=taxonomy-label>云原生</span></a></li></ul></div><div class="taxonomy taxonomy-terms-article taxo-tags"><h5 class=taxonomy-title>Tags:</h5><ul class=taxonomy-terms><li><a class=taxonomy-term href=https://sreionet.github.io/tags/istio/ data-taxonomy-term=istio><span class=taxonomy-label>istio</span></a></li><li><a class=taxonomy-term href=https://sreionet.github.io/tags/%E8%BD%AC%E8%BD%BD/ data-taxonomy-term=%E8%BD%AC%E8%BD%BD><span class=taxonomy-label>转载</span></a></li></ul></div></header><p>本文最早是基于 Istio 1.11 撰写，之后随着 Istio 的版本陆续更新，最新更新时间为 2022 年 5 月 12 日，关于本文历史版本的更新说明请见文章最后。本文记录了详细的实践过程，力图能够让读者复现，因此事无巨细，想要理解某个部分过程的读者可以使用目录跳转到对应的小节阅读。</p><p>为了理解本文希望你先阅读以下内容：</p><ul><li><a href=/posts/b7e1eb/>理解 iptables</a></li><li><a href=/posts/dc5625/>Istio 数据平面 Pod 启动过程详解</a></li></ul><h2 id=内容介绍>内容介绍</h2><p>本文基于 Istio 1.13 版本，将为大家介绍以下内容：</p><ul><li>什么是 sidecar 模式和它的优势在哪里。</li><li>Istio 中是如何做 sidecar 注入的。</li><li>Sidecar 代理是如何做透明流量劫持的。</li><li>iptables 的路由规则。</li><li>Envoy 代理是如何路由流量到上游的。</li></ul><p>请大家结合下图理解本文中的内容，本图基于 Istio 官方提供的 Bookinfo 示例绘制，展示的是 <code>reviews</code> Pod 的内部结构，包括 Linux Kernel 空间中的 iptables 规则、Sidecar 容器、应用容器。</p><p><img src=https://raw.githubusercontent.com/kbsonlong/notes_statics/master/images/20220913144220.png alt="Istio 流量劫持示意图"></p><p><code>productpage</code> 访问 <code>reviews</code> Pod，入站流量处理过程对应于图示上的步骤：1、2、3、4、Envoy Inbound Handler、5、6、7、8、应用容器。</p><p><code>reviews</code> Pod 访问 <code>rating</code> 服务的出站流量处理过程对应于图示上的步骤是：9、10、11、12、Envoy Outbound Handler、13、14、15。</p><p>注意：图中的路径 16 近用于路由规则说明，它不不出现在当前示例中。实际上仅当 Pod 内发出的对当前 Pod 内的服务访问的时候才会途径它。</p><p>上图中关于流量路由部分，包含：</p><ul><li><code>productpage</code> 服务请求访问 <code>http://reviews.default.svc.cluster.local:9080/</code>，当流量进入 <code>reviews</code> Pod 内部时，流量是如何被 iptables 劫持到 Envoy 代理被 Inbound Handler 处理的；</li><li><code>reviews</code> 请求访问 <code>ratings</code> 服务的 Pod，应用程序发出的出站流量被 iptables 劫持到 Envoy 代理的 Outbound Handler 的处理。</li></ul><p>在阅读下文时，请大家确立以下已知点：</p><ul><li>首先，<code>productpage</code> 发出的对 <code>reivews</code> 的访问流量，是在 Envoy 已经通过 EDS 选择出了要请求的 <code>reviews</code> 服务的某个 Pod，知晓了其 IP 地址，直接向该 IP 发送的 TCP 连接请求。</li><li><code>reviews</code> 服务有三个版本，每个版本有一个实例，三个版本中的 sidecar 工作步骤类似，下文只以其中一个 Pod 中的 sidecar 流量转发步骤来说明。</li><li>所有进入 <code>reviews</code> Pod 的 TCP 流量都根据 Pod 中的 iptables 规则转发到了 Envoy 代理的 15006 端口，然后经过 Envoy 的处理确定转发给 Pod 内的应用容器还是透传。</li></ul><h2 id=sidecar-模式>Sidecar 模式</h2><p>将应用程序的功能划分为单独的进程运行在同一个最小调度单元中（例如 Kubernetes 中的 Pod）可以被视为 <strong>sidecar 模式</strong>。如下图所示，sidecar 模式允许您在应用程序旁边添加更多功能，而无需额外第三方组件配置或修改应用程序代码。</p><p><img src=https://raw.githubusercontent.com/kbsonlong/notes_statics/master/images/20220913144314.png alt></p><p>就像连接了 Sidecar 的三轮摩托车一样，在软件架构中， Sidecar 连接到父应用并且为其添加扩展或者增强功能。Sidecar 应用与主应用程序松散耦合。它可以屏蔽不同编程语言的差异，统一实现微服务的可观察性、监控、日志记录、配置、断路器等功能。</p><h3 id=使用-sidecar-模式的优势>使用 Sidecar 模式的优势</h3><p>使用 sidecar 模式部署服务网格时，无需在节点上运行代理，但是集群中将运行多个相同的 sidecar 副本。在 sidecar 部署方式中，每个应用的容器旁都会部署一个伴生容器（如 Envoy 或 MOSN），这个容器称之为 sidecar 容器。Sidecar 接管进出应用容器的所有流量。在 Kubernetes 的 Pod 中，在原有的应用容器旁边注入一个 Sidecar 容器，两个容器共享存储、网络等资源，可以广义的将这个包含了 sidecar 容器的 Pod 理解为一台主机，两个容器共享主机资源。</p><p>因其独特的部署结构，使得 sidecar 模式具有以下优势：</p><ul><li>将与应用业务逻辑无关的功能抽象到共同基础设施，降低了微服务代码的复杂度。</li><li>因为不再需要编写相同的第三方组件配置文件和代码，所以能够降低微服务架构中的代码重复度。</li><li>Sidecar 可独立升级，降低应用程序代码和底层平台的耦合度。</li></ul><h2 id=sidecar-注入示例分析>Sidecar 注入示例分析</h2><p>以 Istio 官方提供的 <code>bookinfo</code> 中 <code>productpage</code> 的 YAML 为例，关于 <code>bookinfo</code> 应用的详细 YAML 配置请参考 <a href=https://github.com/istio/istio/blob/master/samples/bookinfo/platform/kube/bookinfo.yaml>bookinfo.yaml</a>。</p><p>下文将从以下几个方面讲解：</p><ul><li>Sidecar 容器的注入</li><li>iptables 规则的创建</li><li>路由的详细过程</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>apps/v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Deployment</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>productpage-v1</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>app</span>: <span style=color:#ae81ff>productpage</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>version</span>: <span style=color:#ae81ff>v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>replicas</span>: <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>selector</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>matchLabels</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>app</span>: <span style=color:#ae81ff>productpage</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>version</span>: <span style=color:#ae81ff>v1</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>template</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>app</span>: <span style=color:#ae81ff>productpage</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>version</span>: <span style=color:#ae81ff>v1</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>serviceAccountName</span>: <span style=color:#ae81ff>bookinfo-productpage</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>containers</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>productpage</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>image</span>: <span style=color:#ae81ff>docker.io/istio/examples-bookinfo-productpage-v1:1.15.0</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>imagePullPolicy</span>: <span style=color:#ae81ff>IfNotPresent</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>        - <span style=color:#f92672>containerPort</span>: <span style=color:#ae81ff>9080</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>volumeMounts</span>:
</span></span><span style=display:flex><span>        - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>tmp</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>mountPath</span>: <span style=color:#ae81ff>/tmp</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>volumes</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>tmp</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>emptyDir</span>: {}
</span></span></code></pre></div><p>再查看下 <code>productpage</code> 容器的 <a href=https://github.com/istio/istio/blob/master/samples/bookinfo/src/productpage/Dockerfile>Dockerfile</a>。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-docker data-lang=docker><span style=display:flex><span><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> python:3.7.4-slim</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> requirements.txt ./<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> pip install --no-cache-dir -r requirements.txt<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> test-requirements.txt ./<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> pip install --no-cache-dir -r test-requirements.txt<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> productpage.py /opt/microservices/<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> tests/unit/* /opt/microservices/<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> templates /opt/microservices/templates<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> static /opt/microservices/static<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> requirements.txt /opt/microservices/<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ARG</span> flood_factor<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ENV</span> FLOOD_FACTOR <span style=color:#e6db74>${</span>flood_factor<span style=color:#66d9ef>:-</span>0<span style=color:#e6db74>}</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>EXPOSE</span><span style=color:#e6db74> 9080</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>WORKDIR</span><span style=color:#e6db74> /opt/microservices</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> python -m unittest discover<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>USER</span><span style=color:#e6db74> 1</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>CMD</span> [<span style=color:#e6db74>&#34;python&#34;</span>, <span style=color:#e6db74>&#34;productpage.py&#34;</span>, <span style=color:#e6db74>&#34;9080&#34;</span>]<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><p>我们看到 <code>Dockerfile</code> 中没有配置 <code>ENTRYPOINT</code>，所以 <code>CMD</code> 的配置 <code>python productpage.py 9080</code> 将作为默认的 <code>ENTRYPOINT</code>，记住这一点，再看下注入 sidecar 之后的配置。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ istioctl kube-inject -f samples/bookinfo/platform/kube/bookinfo.yaml
</span></span></code></pre></div><p>我们只截取其中与 <code>productpage</code> 相关的 <code>Deployment</code> 配置中的部分 YAML 配置。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>      <span style=color:#f92672>containers</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>image</span>: <span style=color:#ae81ff>docker.io/istio/examples-bookinfo-productpage-v1:1.15.0</span> <span style=color:#75715e># 应用镜像</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>name</span>: <span style=color:#ae81ff>productpage</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>        - <span style=color:#f92672>containerPort</span>: <span style=color:#ae81ff>9080</span>
</span></span><span style=display:flex><span>      - <span style=color:#f92672>args</span>:
</span></span><span style=display:flex><span>        - <span style=color:#ae81ff>proxy</span>
</span></span><span style=display:flex><span>        - <span style=color:#ae81ff>sidecar</span>
</span></span><span style=display:flex><span>        - --<span style=color:#ae81ff>domain</span>
</span></span><span style=display:flex><span>        - <span style=color:#ae81ff>$(POD_NAMESPACE).svc.cluster.local</span>
</span></span><span style=display:flex><span>        - --<span style=color:#ae81ff>configPath</span>
</span></span><span style=display:flex><span>        - <span style=color:#ae81ff>/etc/istio/proxy</span>
</span></span><span style=display:flex><span>        - --<span style=color:#ae81ff>binaryPath</span>
</span></span><span style=display:flex><span>        - <span style=color:#ae81ff>/usr/local/bin/envoy</span>
</span></span><span style=display:flex><span>        - --<span style=color:#ae81ff>serviceCluster</span>
</span></span><span style=display:flex><span>        - <span style=color:#ae81ff>productpage.$(POD_NAMESPACE)</span>
</span></span><span style=display:flex><span>        - --<span style=color:#ae81ff>drainDuration</span>
</span></span><span style=display:flex><span>        - <span style=color:#ae81ff>45s</span>
</span></span><span style=display:flex><span>        - --<span style=color:#ae81ff>parentShutdownDuration</span>
</span></span><span style=display:flex><span>        - <span style=color:#ae81ff>1m0s</span>
</span></span><span style=display:flex><span>        - --<span style=color:#ae81ff>discoveryAddress</span>
</span></span><span style=display:flex><span>        - <span style=color:#ae81ff>istiod.istio-system.svc:15012</span>
</span></span><span style=display:flex><span>        - --<span style=color:#ae81ff>zipkinAddress</span>
</span></span><span style=display:flex><span>        - <span style=color:#ae81ff>zipkin.istio-system:9411</span>
</span></span><span style=display:flex><span>        - --<span style=color:#ae81ff>proxyLogLevel=warning</span>
</span></span><span style=display:flex><span>        - --<span style=color:#ae81ff>proxyComponentLogLevel=misc:error</span>
</span></span><span style=display:flex><span>        - --<span style=color:#ae81ff>connectTimeout</span>
</span></span><span style=display:flex><span>        - <span style=color:#ae81ff>10s</span>
</span></span><span style=display:flex><span>        - --<span style=color:#ae81ff>proxyAdminPort</span>
</span></span><span style=display:flex><span>        - <span style=color:#e6db74>&#34;15000&#34;</span>
</span></span><span style=display:flex><span>        - --<span style=color:#ae81ff>concurrency</span>
</span></span><span style=display:flex><span>        - <span style=color:#e6db74>&#34;2&#34;</span>
</span></span><span style=display:flex><span>        - --<span style=color:#ae81ff>controlPlaneAuthPolicy</span>
</span></span><span style=display:flex><span>        - <span style=color:#ae81ff>NONE</span>
</span></span><span style=display:flex><span>        - --<span style=color:#ae81ff>dnsRefreshRate</span>
</span></span><span style=display:flex><span>        - <span style=color:#ae81ff>300s</span>
</span></span><span style=display:flex><span>        - --<span style=color:#ae81ff>statusPort</span>
</span></span><span style=display:flex><span>        - <span style=color:#e6db74>&#34;15020&#34;</span>
</span></span><span style=display:flex><span>        - --<span style=color:#ae81ff>trust-domain=cluster.local</span>
</span></span><span style=display:flex><span>        - --<span style=color:#ae81ff>controlPlaneBootstrap=false</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>image</span>: <span style=color:#ae81ff>docker.io/istio/proxyv2:1.5.1</span> <span style=color:#75715e># sidecar proxy</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>name</span>: <span style=color:#ae81ff>istio-proxy</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>        - <span style=color:#f92672>containerPort</span>: <span style=color:#ae81ff>15090</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>name</span>: <span style=color:#ae81ff>http-envoy-prom</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>protocol</span>: <span style=color:#ae81ff>TCP</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>initContainers</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>command</span>:
</span></span><span style=display:flex><span>        - <span style=color:#ae81ff>istio-iptables</span>
</span></span><span style=display:flex><span>        - -<span style=color:#ae81ff>p</span>
</span></span><span style=display:flex><span>        - <span style=color:#e6db74>&#34;15001&#34;</span>
</span></span><span style=display:flex><span>        - -<span style=color:#ae81ff>z</span>
</span></span><span style=display:flex><span>        - <span style=color:#e6db74>&#34;15006&#34;</span>
</span></span><span style=display:flex><span>        - -<span style=color:#ae81ff>u</span>
</span></span><span style=display:flex><span>        - <span style=color:#e6db74>&#34;1337&#34;</span>
</span></span><span style=display:flex><span>        - -<span style=color:#ae81ff>m</span>
</span></span><span style=display:flex><span>        - <span style=color:#ae81ff>REDIRECT</span>
</span></span><span style=display:flex><span>        - -<span style=color:#ae81ff>i</span>
</span></span><span style=display:flex><span>        - <span style=color:#e6db74>&#39;*&#39;</span>
</span></span><span style=display:flex><span>        - -<span style=color:#ae81ff>x</span>
</span></span><span style=display:flex><span>        - <span style=color:#e6db74>&#34;&#34;</span>
</span></span><span style=display:flex><span>        - -<span style=color:#ae81ff>b</span>
</span></span><span style=display:flex><span>        - <span style=color:#e6db74>&#39;*&#39;</span>
</span></span><span style=display:flex><span>        - -<span style=color:#ae81ff>d</span>
</span></span><span style=display:flex><span>        - <span style=color:#ae81ff>15090</span>,<span style=color:#ae81ff>15020</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>image</span>: <span style=color:#ae81ff>docker.io/istio/proxyv2:1.5.1</span> <span style=color:#75715e># init 容器</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>name</span>: <span style=color:#ae81ff>istio-init</span>
</span></span></code></pre></div><p>Istio 给应用 Pod 注入的配置主要包括：</p><ul><li>Init 容器 <code>istio-init</code>：用于 pod 中设置 iptables 端口转发</li><li>Sidecar 容器 <code>istio-proxy</code>：运行 sidecar 代理，如 Envoy 或 MOSN。</li></ul><h2 id=iptables-规则注入解析>iptables 规则注入解析</h2><p>为了查看 iptables 配置，我们需要登陆到 sidecar 容器中使用 root 用户来查看，因为 <code>kubectl</code> 无法使用特权模式来远程操作 docker 容器，所以我们需要登陆到 <code>productpage</code> pod 所在的主机上使用 <code>docker</code> 命令登陆容器中查看。</p><p>如果您使用 minikube 部署的 Kubernetes，可以直接登录到 minikube 的虚拟机中并切换为 root 用户。查看 iptables 配置，列出 NAT（网络地址转换）表的所有规则，因为在 Init 容器启动的时候选择给 <code>istio-iptables</code> 传递的参数中指定将入站流量重定向到 sidecar 的模式为 <code>REDIRECT</code>，因此在 iptables 中将只有 NAT 表的规格配置，如果选择 <code>TPROXY</code> 还会有 <code>mangle</code> 表配置。<code>iptables</code> 命令的详细用法请参考 <a href=https://wangchujiang.com/linux-command/c/iptables.html>iptables</a> 命令。</p><p>我们仅查看与 <code>productpage</code> 有关的 iptables 规则如下，因为这些规则是运行在该容器特定的网络空间下，因此需要使用 <code>nsenter</code> 命令进入其网络空间。进入的时候需要指定进程 ID（PID），因此首先我们需要找到 <code>productpage</code> 容器的 PID。对于在不同平台上安装的 Kubernetes，查找容器的方式会略有不同，例如在 GKE 上，执行 <code>docker ps -a</code> 命令是查看不到任何容器进程的。下面已 minikube 和 GKE 两个典型的平台为例，指导你如何进入容器的网络空间。</p><h3 id=在-minikube-中查看容器中的-iptabes-规则>在 minikube 中查看容器中的 iptabes 规则</h3><p>对于 minikube，因为所有的进程都运行在单个节点上，因此你只需要登录到 minikube 虚拟机，切换为 root 用户然后查找 <code>productpage</code> 进程即可，参考下面的步骤。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 进入 minikube 并切换为 root 用户，minikube 默认用户为 docker</span>
</span></span><span style=display:flex><span>$ minikube ssh
</span></span><span style=display:flex><span>$ sudo -i
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 查看 productpage pod 的 istio-proxy 容器中的进程</span>
</span></span><span style=display:flex><span>$ docker top <span style=color:#e6db74>`</span>docker ps|grep <span style=color:#e6db74>&#34;istio-proxy_productpage&#34;</span>|cut -d <span style=color:#e6db74>&#34; &#34;</span> -f1<span style=color:#e6db74>`</span>
</span></span><span style=display:flex><span>UID                 PID                 PPID                C                   STIME               TTY                 TIME                CMD
</span></span><span style=display:flex><span><span style=color:#ae81ff>1337</span>                <span style=color:#ae81ff>10576</span>               <span style=color:#ae81ff>10517</span>               <span style=color:#ae81ff>0</span>                   08:09               ?                   00:00:07            /usr/local/bin/pilot-agent proxy sidecar --domain default.svc.cluster.local --configPath /etc/istio/proxy --binaryPath /usr/local/bin/envoy --serviceCluster productpage.default --drainDuration 45s --parentShutdownDuration 1m0s --discoveryAddress istiod.istio-system.svc:15012 --zipkinAddress zipkin.istio-system:9411 --proxyLogLevel<span style=color:#f92672>=</span>warning --proxyComponentLogLevel<span style=color:#f92672>=</span>misc:error --connectTimeout 10s --proxyAdminPort <span style=color:#ae81ff>15000</span> --concurrency <span style=color:#ae81ff>2</span> --controlPlaneAuthPolicy NONE --dnsRefreshRate 300s --statusPort <span style=color:#ae81ff>15020</span> --trust-domain<span style=color:#f92672>=</span>cluster.local --controlPlaneBootstrap<span style=color:#f92672>=</span>false
</span></span><span style=display:flex><span><span style=color:#ae81ff>1337</span>                <span style=color:#ae81ff>10660</span>               <span style=color:#ae81ff>10576</span>               <span style=color:#ae81ff>0</span>                   08:09               ?                   00:00:33            /usr/local/bin/envoy -c /etc/istio/proxy/envoy-rev0.json --restart-epoch <span style=color:#ae81ff>0</span> --drain-time-s <span style=color:#ae81ff>45</span> --parent-shutdown-time-s <span style=color:#ae81ff>60</span> --service-cluster productpage.default --service-node sidecar~172.17.0.16~productpage-v1-7f44c4d57c-ksf9b.default~default.svc.cluster.local --max-obj-name-len <span style=color:#ae81ff>189</span> --local-address-ip-version v4 --log-format <span style=color:#f92672>[</span>Envoy <span style=color:#f92672>(</span>Epoch 0<span style=color:#f92672>)]</span> <span style=color:#f92672>[</span>%Y-%m-%d %T.%e<span style=color:#f92672>][</span>%t<span style=color:#f92672>][</span>%l<span style=color:#f92672>][</span>%n<span style=color:#f92672>]</span> %v -l warning --component-log-level misc:error --concurrency <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 使用 nsenter 进入 sidecar 容器的命名空间（以上任何一个都可以）</span>
</span></span><span style=display:flex><span>$ nsenter -n --target <span style=color:#ae81ff>10660</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 查看 NAT 表中规则配置的详细信息。</span>
</span></span><span style=display:flex><span>$ iptables -t nat -L
</span></span></code></pre></div><h3 id=在-gke-中查看容器的-iptables-规则>在 GKE 中查看容器的 iptables 规则</h3><p>如果你在 GKE 中安装的多节点的 Kubernetes 集群，首先你需要确定这个 Pod 运行在哪个节点上，然后登陆到那台主机，使用下面的命令查找进程的 PID，你会得到类似下面的输出。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ ps aux|grep <span style=color:#e6db74>&#34;productpage&#34;</span>
</span></span><span style=display:flex><span>chronos     <span style=color:#ae81ff>4268</span>  0.0  0.6  <span style=color:#ae81ff>43796</span> <span style=color:#ae81ff>24856</span> ?        Ss   Apr22   0:00 python productpage.py <span style=color:#ae81ff>9080</span>
</span></span><span style=display:flex><span>chronos     <span style=color:#ae81ff>4329</span>  0.9  0.6 <span style=color:#ae81ff>117524</span> <span style=color:#ae81ff>24616</span> ?        Sl   Apr22  13:43 /usr/local/bin/python /opt/microservices/productpage.py <span style=color:#ae81ff>9080</span>
</span></span><span style=display:flex><span>root      <span style=color:#ae81ff>361903</span>  0.0  0.0   <span style=color:#ae81ff>4536</span>   <span style=color:#ae81ff>812</span> pts/0    S+   01:54   0:00 grep --colour<span style=color:#f92672>=</span>auto productpage
</span></span></code></pre></div><p>然后在终端中输出 <code>iptables -t nat -L</code> 即可查看 iptables 规则。</p><h2 id=iptables-流量劫持过程详解>iptables 流量劫持过程详解</h2><p>经过上面的步骤，你已经可以查看到 init 容器向 Pod 中注入的 iptables 规则，如下所示。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># PREROUTING 链：用于目标地址转换（DNAT），将所有入站 TCP 流量跳转到 ISTIO_INBOUND 链上。</span>
</span></span><span style=display:flex><span>Chain PREROUTING <span style=color:#f92672>(</span>policy ACCEPT <span style=color:#ae81ff>2701</span> packets, 162K bytes<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span> pkts bytes target     prot opt in     out     source               destination
</span></span><span style=display:flex><span> <span style=color:#ae81ff>2701</span>  162K ISTIO_INBOUND  tcp  --  any    any     anywhere             anywhere
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># INPUT 链：处理输入数据包，非 TCP 流量将继续 OUTPUT 链。</span>
</span></span><span style=display:flex><span>Chain INPUT <span style=color:#f92672>(</span>policy ACCEPT <span style=color:#ae81ff>2701</span> packets, 162K bytes<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span> pkts bytes target     prot opt in     out     source               destination
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># OUTPUT 链：将所有出站数据包跳转到 ISTIO_OUTPUT 链上。</span>
</span></span><span style=display:flex><span>Chain OUTPUT <span style=color:#f92672>(</span>policy ACCEPT <span style=color:#ae81ff>79</span> packets, <span style=color:#ae81ff>6761</span> bytes<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span> pkts bytes target     prot opt in     out     source               destination
</span></span><span style=display:flex><span>   <span style=color:#ae81ff>15</span>   <span style=color:#ae81ff>900</span> ISTIO_OUTPUT  tcp  --  any    any     anywhere             anywhere
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># POSTROUTING 链：所有数据包流出网卡时都要先进入 POSTROUTING 链，内核根据数据包目的地判断是否需要转发出去，我们看到此处未做任何处理。</span>
</span></span><span style=display:flex><span>Chain POSTROUTING <span style=color:#f92672>(</span>policy ACCEPT <span style=color:#ae81ff>79</span> packets, <span style=color:#ae81ff>6761</span> bytes<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span> pkts bytes target     prot opt in     out     source               destination
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># ISTIO_INBOUND 链：将所有入站流量重定向到 ISTIO_IN_REDIRECT 链上。目的地为 15090（Prometheus 使用）和 15020（Ingress gateway 使用，用于 Pilot 健康检查）端口的流量除外，发送到以上两个端口的流量将返回 iptables 规则链的调用点，即 PREROUTING 链的后继 POSTROUTING 后直接调用原始目的地。</span>
</span></span><span style=display:flex><span>Chain ISTIO_INBOUND <span style=color:#f92672>(</span><span style=color:#ae81ff>1</span> references<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span> pkts bytes target     prot opt in     out     source               destination
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>0</span>     <span style=color:#ae81ff>0</span> RETURN     tcp  --  any    any     anywhere             anywhere             tcp dpt:ssh
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>2</span>   <span style=color:#ae81ff>120</span> RETURN     tcp  --  any    any     anywhere             anywhere             tcp dpt:15090
</span></span><span style=display:flex><span> <span style=color:#ae81ff>2699</span>  162K RETURN     tcp  --  any    any     anywhere             anywhere             tcp dpt:15020
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>0</span>     <span style=color:#ae81ff>0</span> ISTIO_IN_REDIRECT  tcp  --  any    any     anywhere             anywhere
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># ISTIO_IN_REDIRECT 链：将所有的入站流量跳转到本地的 15006 端口，至此成功的拦截了流量到 sidecar 代理的 Inbound Handler 中。</span>
</span></span><span style=display:flex><span>Chain ISTIO_IN_REDIRECT <span style=color:#f92672>(</span><span style=color:#ae81ff>3</span> references<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span> pkts bytes target     prot opt in     out     source               destination
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>0</span>     <span style=color:#ae81ff>0</span> REDIRECT   tcp  --  any    any     anywhere             anywhere             redir ports <span style=color:#ae81ff>15006</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># ISTIO_OUTPUT 链：规则比较复杂，将在下文解释</span>
</span></span><span style=display:flex><span>Chain ISTIO_OUTPUT <span style=color:#f92672>(</span><span style=color:#ae81ff>1</span> references<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span> pkts bytes target     prot opt in     out     source               destination
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>0</span>     <span style=color:#ae81ff>0</span> RETURN     all  --  any    lo      127.0.0.6            anywhere <span style=color:#75715e>#规则1</span>
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>0</span>     <span style=color:#ae81ff>0</span> ISTIO_IN_REDIRECT  all  --  any    lo      anywhere            !localhost            owner UID match <span style=color:#ae81ff>1337</span> <span style=color:#75715e>#规则2</span>
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>0</span>     <span style=color:#ae81ff>0</span> RETURN     all  --  any    lo      anywhere             anywhere             ! owner UID match <span style=color:#ae81ff>1337</span> <span style=color:#75715e>#规则3</span>
</span></span><span style=display:flex><span>   <span style=color:#ae81ff>15</span>   <span style=color:#ae81ff>900</span> RETURN     all  --  any    any     anywhere             anywhere             owner UID match <span style=color:#ae81ff>1337</span> <span style=color:#75715e>#规则4</span>
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>0</span>     <span style=color:#ae81ff>0</span> ISTIO_IN_REDIRECT  all  --  any    lo      anywhere            !localhost            owner GID match <span style=color:#ae81ff>1337</span> <span style=color:#75715e>#规则5</span>
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>0</span>     <span style=color:#ae81ff>0</span> RETURN     all  --  any    lo      anywhere             anywhere             ! owner GID match <span style=color:#ae81ff>1337</span> <span style=color:#75715e>#规则6</span>
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>0</span>     <span style=color:#ae81ff>0</span> RETURN     all  --  any    any     anywhere             anywhere             owner GID match <span style=color:#ae81ff>1337</span> <span style=color:#75715e>#规则7</span>
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>0</span>     <span style=color:#ae81ff>0</span> RETURN     all  --  any    any     anywhere             localhost <span style=color:#75715e>#规则8</span>
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>0</span>     <span style=color:#ae81ff>0</span> ISTIO_REDIRECT  all  --  any    any     anywhere             anywhere <span style=color:#75715e>#规则9</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># ISTIO_REDIRECT 链：将所有流量重定向到 Envoy 代理的 15001 端口。</span>
</span></span><span style=display:flex><span>Chain ISTIO_REDIRECT <span style=color:#f92672>(</span><span style=color:#ae81ff>1</span> references<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span> pkts bytes target     prot opt in     out     source               destination
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>0</span>     <span style=color:#ae81ff>0</span> REDIRECT   tcp  --  any    any     anywhere             anywhere             redir ports <span style=color:#ae81ff>15001</span>
</span></span></code></pre></div><p>这里着重需要解释的是 <code>ISTIO_OUTPUT</code> 链中的 9 条规则，为了便于阅读，我将以上规则中的部分内容使用表格的形式来展示如下：</p><table><thead><tr><th><strong>规则</strong></th><th><strong>target</strong></th><th><strong>in</strong></th><th><strong>out</strong></th><th><strong>source</strong></th><th><strong>destination</strong></th></tr></thead><tbody><tr><td>1</td><td>RETURN</td><td>any</td><td>lo</td><td>127.0.0.6</td><td>anywhere</td></tr><tr><td>2</td><td>ISTIO_IN_REDIRECT</td><td>any</td><td>lo</td><td>anywhere</td><td>!localhost owner UID match 1337</td></tr><tr><td>3</td><td>RETURN</td><td>any</td><td>lo</td><td>anywhere</td><td>anywhere !owner UID match 1337</td></tr><tr><td>4</td><td>RETURN</td><td>any</td><td>any</td><td>anywhere</td><td>anywhere owner UID match 1337</td></tr><tr><td>5</td><td>ISTIO_IN_REDIRECT</td><td>any</td><td>lo</td><td>anywhere</td><td>!localhost owner GID match 1337</td></tr><tr><td>6</td><td>RETURN</td><td>any</td><td>lo</td><td>anywhere</td><td>anywhere !owner GID match 1337</td></tr><tr><td>7</td><td>RETURN</td><td>any</td><td>any</td><td>anywhere</td><td>anywhere owner GID match 1337</td></tr><tr><td>8</td><td>RETURN</td><td>any</td><td>any</td><td>anywhere</td><td>localhost</td></tr><tr><td>9</td><td>ISTIO_REDIRECT</td><td>any</td><td>any</td><td>anywhere</td><td>anywhere</td></tr></tbody></table><p>下图展示了 <code>ISTIO_ROUTE</code> 规则的详细流程。</p><p><img src=https://raw.githubusercontent.com/kbsonlong/notes_statics/master/images/20220913144557.png alt></p><p>我将按照规则的出现顺序来解释每条规则的目的、对应文章开头图示中的步骤及详情。其中规则 5、6、7 是分别对规则 2、3、4 的应用范围扩大（从 UID 扩大为 GID），作用是类似的，将合并解释。注意，其中的规则是按顺序执行的，也就是说排序越靠后的规则将作为默认值。出站网卡（out）为 <code>lo</code> （本地回环地址，loopback 接口）时，表示流量的目的地是本地 Pod，对于 Pod 向外部发送的流量就不会经过这个接口。所有 <code>review</code> Pod 的出站流量只适用于规则 4、7、8、9。</p><p><strong>规则 1</strong></p><ul><li>目的：<strong>透传</strong> Envoy 代理发送到本地应用容器的流量，使其绕过 Envoy 代理，直达应用容器。</li><li>对应图示中的步骤：6 到 7。</li><li>详情：该规则使得所有来自 <code>127.0.0.6</code>（该 IP 地址将在下文解释） 的请求，跳出该链，返回 iptables 的调用点（即 <code>OUTPUT</code>）后继续执行其余路由规则，即 <code>POSTROUTING</code> 规则，把流量发送到任意目的地址，如本地 Pod 内的应用容器。如果没有这条规则，由 Pod 内 Envoy 代理发出的对 Pod 内容器访问的流量将会执行下一条规则，即规则 2，流量将再次进入到了 Inbound Handler 中，从而形成了死循环。将这条规则放在第一位可以避免流量在 Inbound Handler 中死循环的问题。</li></ul><p><strong>规则 2、5</strong></p><ul><li>目的：处理 Envoy 代理发出的站内流量（Pod 内部的流量），但不是对 localhost 的请求，通过后续规则将其转发给 Envoy 代理的 Inbound Handler。该规则适用于 Pod 对自身 IP 地址调用的场景，即 Pod 内服务之间的访问。</li><li>详情：如果流量的目的地非 localhost，且数据包是由 1337 UID（即 <code>istio-proxy</code> 用户，Envoy 代理）发出的，流量将被经过 <code>ISTIO_IN_REDIRECT</code> 最终转发到 Envoy 的 Inbound Handler。</li></ul><p><strong>规则 3、6</strong></p><ul><li>目的：<strong>透传</strong> Pod 内的应用容器的站内流量。该规则适用于容器内部的流量。例如在 Pod 内对 Pod IP 或 localhost 的访问。</li><li>对应图示中的步骤：6 到 7。</li><li>详情：如果流量不是由 Envoy 用户发出的，那么就跳出该链，返回 <code>OUTPUT</code> 调用 <code>POSTROUTING</code>，直达目的地。</li></ul><p><strong>规则 4、7</strong></p><ul><li>目的：<strong>透传</strong> Envoy 代理发出的出站请求。</li><li>对应图示中的步骤：14 到 15。</li><li>详情：如果请求是由 Envoy 代理发出的，则返回 <code>OUTPUT</code> 继续调用 <code>POSTROUTING</code> 规则，最终直接访问目的地。</li></ul><p><strong>规则 8</strong></p><ul><li>目的：<strong>透传</strong> Pod 内部对 localhost 的请求。</li><li>详情：如果请求的目的地是 localhost，则返回 OUTPUT 调用 <code>POSTROUTING</code>，直接访问 localhost。</li></ul><p><strong>规则 9</strong></p><ul><li>目的：所有其他的流量将被转发到 <code>ISTIO_REDIRECT</code> 后，最终达到 Envoy 代理的 Outbound Handler。</li><li>对应图示中的步骤：10 到 11。</li></ul><p>以上规则避免了 Envoy 代理到应用程序的路由在 iptables 规则中的死循环，保障了流量可以被正确的路由到 Envoy 代理上，也可以发出真正的出站请求。</p><p><strong>关于 RETURN target</strong></p><p>你可能留意到上述规则中有很多 RETURN target，它的意思是，指定到这条规则时，跳出该规则链，返回 iptables 的调用点（在我们的例子中即 <code>OUTPUT</code>）后继续执行其余路由规则，在我们的例子中即 <code>POSTROUTING</code> 规则，把流量发送到任意目的地址，你可以把它直观的理解为<strong>透传</strong>。</p><p><strong>关于 127.0.0.6 IP 地址</strong></p><p>127.0.0.6 这个 IP 是 Istio 中默认的 <code>InboundPassthroughClusterIpv4</code>，在 Istio 的代码中指定。即流量在进入 Envoy 代理后被绑定的 IP 地址，作用是让 Outbound 流量重新发送到 Pod 中的应用容器，即 <strong>Passthought（透传），绕过 Outbound Handler</strong>。该流量是对 Pod 自身的访问，而不是真正的对外流量。至于为什么选择这个 IP 作为流量透传，请参考 <a href=https://github.com/istio/istio/issues/29603>Istio Issue-29603</a>。</p><h2 id=流量路由过程详解>流量路由过程详解</h2><p>通过上文，你已经了解了 Istio 是如何在 Pod 中做透明流量劫持的，那么流量被劫持到 Envoy 代理中之后是如何被处理的呢？流量路由分为 Inbound 和 Outbound 两个过程，下面将根据上文中的示例及 sidecar 的配置为读者详细分析此过程。</p><h3 id=理解-inbound-handler>理解 Inbound Handler</h3><p>Inbound Handler 的作用是将 iptables 拦截到的 downstream 的流量转发给 Pod 内的应用程序容器。在我们的实例中，假设其中一个 Pod 的名字是 <code>reviews-v1-545db77b95-jkgv2</code>，运行 <code>istioctl proxy-config listener reviews-v1-545db77b95-jkgv2 --port 15006</code> 查看该 Pod 中 15006 端口上的监听器情况 ，你将看到下面的输出。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#a6e22e>ADDRESS PORT  MATCH                                                                                           DESTINATION</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>0.0.0.0 15006 Addr: *:15006                                                                                   Non-HTTP/Non-TCP</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>0.0.0.0 15006 Trans: tls; App: istio-http/1.0,istio-http/1.1,istio-h2; Addr: 0.0.0.0/0                        InboundPassthroughClusterIpv4</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>0.0.0.0 15006 Trans: raw_buffer; App: http/1.1,h2c; Addr: 0.0.0.0/0                                           InboundPassthroughClusterIpv4</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>0.0.0.0 15006 Trans: tls; App: TCP TLS; Addr: 0.0.0.0/0                                                       InboundPassthroughClusterIpv4</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>0.0.0.0 15006 Trans: raw_buffer; Addr: 0.0.0.0/0                                                              InboundPassthroughClusterIpv4</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>0.0.0.0 15006 Trans: tls; Addr: 0.0.0.0/0                                                                     InboundPassthroughClusterIpv4</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>0.0.0.0 15006 Trans: tls; App: istio,istio-peer-exchange,istio-http/1.0,istio-http/1.1,istio-h2; Addr: *:9080 Cluster: inbound|9080||</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>0.0.0.0 15006 Trans: raw_buffer; Addr: *:9080                                                                 Cluster: inbound|9080||</span>
</span></span></code></pre></div><p>下面列出了以上输出中各字段的含义：</p><ul><li>ADDRESS：下游地址</li><li>PORT：Envoy 监听器监听的端口</li><li>MATCH：请求使用的传输协议或匹配的下游地址</li><li>DESTINATION：路由目的地</li></ul><p><code>reviews</code> Pod 中的 Iptables 将入站流量劫持到 15006 端口上，从上面的输出我们可以看到 Envoy 的 Inbound Handler 在 15006 端口上监听，对目的地为任何 IP 的 9080 端口的请求将路由到 <code>inbound|9080||</code> Cluster 上。</p><p>从该 Pod 的 Listener 列表的最后两行中可以看到，<code>0.0.0.0:15006/TCP</code> 的 Listener（其实际名字是 <code>virtualInbound</code>）监听所有的 Inbound 流量，其中包含了匹配规则，来自任意 IP 的对 <code>9080</code> 端口的访问流量，将会路由到 <code>inbound|9080||</code> Cluster，如果你想以 Json 格式查看该 Listener 的详细配置，可以执行 <code>istioctl proxy-config listeners reviews-v1-545db77b95-jkgv2 --port 15006 -o json</code> 命令，你将获得类似下面的输出。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>[
</span></span><span style=display:flex><span>    <span style=color:#960050;background-color:#1e0010>/*省略部分内容*/</span>
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;virtualInbound&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;address&#34;</span>: {
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;socketAddress&#34;</span>: {
</span></span><span style=display:flex><span>                <span style=color:#f92672>&#34;address&#34;</span>: <span style=color:#e6db74>&#34;0.0.0.0&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#f92672>&#34;portValue&#34;</span>: <span style=color:#ae81ff>15006</span>
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;filterChains&#34;</span>: [
</span></span><span style=display:flex><span>            <span style=color:#960050;background-color:#1e0010>/*省略部分内容*/</span>
</span></span><span style=display:flex><span>            {
</span></span><span style=display:flex><span>                <span style=color:#f92672>&#34;filterChainMatch&#34;</span>: {
</span></span><span style=display:flex><span>                    <span style=color:#f92672>&#34;destinationPort&#34;</span>: <span style=color:#ae81ff>9080</span>,
</span></span><span style=display:flex><span>                    <span style=color:#f92672>&#34;transportProtocol&#34;</span>: <span style=color:#e6db74>&#34;tls&#34;</span>,
</span></span><span style=display:flex><span>                    <span style=color:#f92672>&#34;applicationProtocols&#34;</span>: [
</span></span><span style=display:flex><span>                        <span style=color:#e6db74>&#34;istio&#34;</span>,
</span></span><span style=display:flex><span>                        <span style=color:#e6db74>&#34;istio-peer-exchange&#34;</span>,
</span></span><span style=display:flex><span>                        <span style=color:#e6db74>&#34;istio-http/1.0&#34;</span>,
</span></span><span style=display:flex><span>                        <span style=color:#e6db74>&#34;istio-http/1.1&#34;</span>,
</span></span><span style=display:flex><span>                        <span style=color:#e6db74>&#34;istio-h2&#34;</span>
</span></span><span style=display:flex><span>                    ]
</span></span><span style=display:flex><span>                },
</span></span><span style=display:flex><span>                <span style=color:#f92672>&#34;filters&#34;</span>: [
</span></span><span style=display:flex><span>                    <span style=color:#960050;background-color:#1e0010>/*省略部分内容*/</span>
</span></span><span style=display:flex><span>                    {
</span></span><span style=display:flex><span>                        <span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;envoy.filters.network.http_connection_manager&#34;</span>,
</span></span><span style=display:flex><span>                        <span style=color:#f92672>&#34;typedConfig&#34;</span>: {
</span></span><span style=display:flex><span>                            <span style=color:#f92672>&#34;@type&#34;</span>: <span style=color:#e6db74>&#34;type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager&#34;</span>,
</span></span><span style=display:flex><span>                            <span style=color:#f92672>&#34;statPrefix&#34;</span>: <span style=color:#e6db74>&#34;inbound_0.0.0.0_9080&#34;</span>,
</span></span><span style=display:flex><span>                            <span style=color:#f92672>&#34;routeConfig&#34;</span>: {
</span></span><span style=display:flex><span>                                <span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;inbound|9080||&#34;</span>,
</span></span><span style=display:flex><span>                                <span style=color:#f92672>&#34;virtualHosts&#34;</span>: [
</span></span><span style=display:flex><span>                                    {
</span></span><span style=display:flex><span>                                        <span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;inbound|http|9080&#34;</span>,
</span></span><span style=display:flex><span>                                        <span style=color:#f92672>&#34;domains&#34;</span>: [
</span></span><span style=display:flex><span>                                            <span style=color:#e6db74>&#34;*&#34;</span>
</span></span><span style=display:flex><span>                                        ],
</span></span><span style=display:flex><span>                                        <span style=color:#f92672>&#34;routes&#34;</span>: [
</span></span><span style=display:flex><span>                                            {
</span></span><span style=display:flex><span>                                                <span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;default&#34;</span>,
</span></span><span style=display:flex><span>                                                <span style=color:#f92672>&#34;match&#34;</span>: {
</span></span><span style=display:flex><span>                                                    <span style=color:#f92672>&#34;prefix&#34;</span>: <span style=color:#e6db74>&#34;/&#34;</span>
</span></span><span style=display:flex><span>                                                },
</span></span><span style=display:flex><span>                                                <span style=color:#f92672>&#34;route&#34;</span>: {
</span></span><span style=display:flex><span>                                                    <span style=color:#f92672>&#34;cluster&#34;</span>: <span style=color:#e6db74>&#34;inbound|9080||&#34;</span>,
</span></span><span style=display:flex><span>                                                    <span style=color:#f92672>&#34;timeout&#34;</span>: <span style=color:#e6db74>&#34;0s&#34;</span>,
</span></span><span style=display:flex><span>                                                    <span style=color:#f92672>&#34;maxStreamDuration&#34;</span>: {
</span></span><span style=display:flex><span>                                                        <span style=color:#f92672>&#34;maxStreamDuration&#34;</span>: <span style=color:#e6db74>&#34;0s&#34;</span>,
</span></span><span style=display:flex><span>                                                        <span style=color:#f92672>&#34;grpcTimeoutHeaderMax&#34;</span>: <span style=color:#e6db74>&#34;0s&#34;</span>
</span></span><span style=display:flex><span>                                                    }
</span></span><span style=display:flex><span>                                                },
</span></span><span style=display:flex><span>                                                <span style=color:#f92672>&#34;decorator&#34;</span>: {
</span></span><span style=display:flex><span>                                                    <span style=color:#f92672>&#34;operation&#34;</span>: <span style=color:#e6db74>&#34;reviews.default.svc.cluster.local:9080/*&#34;</span>
</span></span><span style=display:flex><span>                                                }
</span></span><span style=display:flex><span>                                            }
</span></span><span style=display:flex><span>                                        ]
</span></span><span style=display:flex><span>                                    }
</span></span><span style=display:flex><span>                                ],
</span></span><span style=display:flex><span>                                <span style=color:#f92672>&#34;validateClusters&#34;</span>: <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>                            },
</span></span><span style=display:flex><span>                            <span style=color:#960050;background-color:#1e0010>/*省略部分内容*/</span>
</span></span><span style=display:flex><span>                        }
</span></span><span style=display:flex><span>                    }
</span></span><span style=display:flex><span>                ],
</span></span><span style=display:flex><span>            <span style=color:#960050;background-color:#1e0010>/*省略部分内容*/</span>
</span></span><span style=display:flex><span>        <span style=color:#960050;background-color:#1e0010>],</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;listenerFilters&#34;</span>: [
</span></span><span style=display:flex><span>        <span style=color:#960050;background-color:#1e0010>/*省略部分内容*/</span>
</span></span><span style=display:flex><span>        ],
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;listenerFiltersTimeout&#34;</span>: <span style=color:#e6db74>&#34;0s&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;continueOnListenerFiltersTimeout&#34;</span>: <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;trafficDirection&#34;</span>: <span style=color:#e6db74>&#34;INBOUND&#34;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>]
</span></span></code></pre></div><p>既然 Inbound Handler 的流量中将来自任意地址的对该 Pod <code>9080</code> 端口的流量路由到 <code>inbound|9080||</code> Cluster，那么我们运行 <code>istioctl pc cluster reviews-v1-545db77b95-jkgv2 --port 9080 --direction inbound -o json</code> 查看下该 Cluster 配置，你将获得类似下面的输出。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>[
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;inbound|9080||&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;type&#34;</span>: <span style=color:#e6db74>&#34;ORIGINAL_DST&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;connectTimeout&#34;</span>: <span style=color:#e6db74>&#34;10s&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;lbPolicy&#34;</span>: <span style=color:#e6db74>&#34;CLUSTER_PROVIDED&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;circuitBreakers&#34;</span>: {
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;thresholds&#34;</span>: [
</span></span><span style=display:flex><span>                {
</span></span><span style=display:flex><span>                    <span style=color:#f92672>&#34;maxConnections&#34;</span>: <span style=color:#ae81ff>4294967295</span>,
</span></span><span style=display:flex><span>                    <span style=color:#f92672>&#34;maxPendingRequests&#34;</span>: <span style=color:#ae81ff>4294967295</span>,
</span></span><span style=display:flex><span>                    <span style=color:#f92672>&#34;maxRequests&#34;</span>: <span style=color:#ae81ff>4294967295</span>,
</span></span><span style=display:flex><span>                    <span style=color:#f92672>&#34;maxRetries&#34;</span>: <span style=color:#ae81ff>4294967295</span>,
</span></span><span style=display:flex><span>                    <span style=color:#f92672>&#34;trackRemaining&#34;</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            ]
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;cleanupInterval&#34;</span>: <span style=color:#e6db74>&#34;60s&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;upstreamBindConfig&#34;</span>: {
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;sourceAddress&#34;</span>: {
</span></span><span style=display:flex><span>                <span style=color:#f92672>&#34;address&#34;</span>: <span style=color:#e6db74>&#34;127.0.0.6&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#f92672>&#34;portValue&#34;</span>: <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;metadata&#34;</span>: {
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;filterMetadata&#34;</span>: {
</span></span><span style=display:flex><span>                <span style=color:#f92672>&#34;istio&#34;</span>: {
</span></span><span style=display:flex><span>                    <span style=color:#f92672>&#34;services&#34;</span>: [
</span></span><span style=display:flex><span>                        {
</span></span><span style=display:flex><span>                            <span style=color:#f92672>&#34;host&#34;</span>: <span style=color:#e6db74>&#34;reviews.default.svc.cluster.local&#34;</span>,
</span></span><span style=display:flex><span>                            <span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;reviews&#34;</span>,
</span></span><span style=display:flex><span>                            <span style=color:#f92672>&#34;namespace&#34;</span>: <span style=color:#e6db74>&#34;default&#34;</span>
</span></span><span style=display:flex><span>                        }
</span></span><span style=display:flex><span>                    ]
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>]
</span></span></code></pre></div><p>我们看其中的 <code>TYPE</code> 为 <code>ORIGINAL_DST</code>，将流量发送到原始目标地址（Pod IP），因为原始目标地址即当前 Pod，你还应该注意到 <code>upstreamBindConfig.sourceAddress.address</code> 的值被改写为了 <code>127.0.0.6</code>，而且对于 Pod 内流量是通过 <code>lo</code> 网卡发送的，这刚好呼应了上文中的 iptables <code>ISTIO_OUTPUT</code> 链中的第一条规则，根据该规则，流量将被透传到 Pod 内的应用容器。</p><h3 id=理解-outbound-handler>理解 Outbound Handler</h3><p>在本示例中 <code>reviews</code> 会向 <code>ratings</code> 服务发送 HTTP 请求，请求的地址是：<code>http://ratings.default.svc.cluster.local:9080/</code>，Outbound Handler 的作用是将 iptables 拦截到的本地应用程序向外发出的流量，经由 Envoy 代理路由到上游。</p><p>Envoy 监听在 15001 端口上监听所有 Outbound 流量，Outbound Handler 处理，然后经过 <code>virtualOutbound</code> Listener、<code>0.0.0.0_9080</code> Listener，然后通过 Route 9080 找到上游的 cluster，进而通过 EDS 找到 Endpoint 执行路由动作。</p><p><strong><code>ratings.default.svc.cluster.local:9080</code> 路由</strong></p><p>运行 <code>istioctl proxy-config routes reviews-v1-545db77b95-jkgv2 --name 9080 -o json</code> 查看 route 配置，因为 sidecar 会根据 HTTP header 中的 domains 来匹配 VirtualHost，所以下面只列举了 <code>ratings.default.svc.cluster.local:9080</code> 这一个 VirtualHost。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>[
</span></span><span style=display:flex><span>  {
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;9080&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;virtualHosts&#34;</span>: [
</span></span><span style=display:flex><span>       {
</span></span><span style=display:flex><span>           <span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;ratings.default.svc.cluster.local:9080&#34;</span>,
</span></span><span style=display:flex><span>           <span style=color:#f92672>&#34;domains&#34;</span>: [
</span></span><span style=display:flex><span>               <span style=color:#e6db74>&#34;ratings.default.svc.cluster.local&#34;</span>,
</span></span><span style=display:flex><span>               <span style=color:#e6db74>&#34;ratings.default.svc.cluster.local:9080&#34;</span>,
</span></span><span style=display:flex><span>               <span style=color:#e6db74>&#34;ratings&#34;</span>,
</span></span><span style=display:flex><span>               <span style=color:#e6db74>&#34;ratings:9080&#34;</span>,
</span></span><span style=display:flex><span>               <span style=color:#e6db74>&#34;ratings.default.svc&#34;</span>,
</span></span><span style=display:flex><span>               <span style=color:#e6db74>&#34;ratings.default.svc:9080&#34;</span>,
</span></span><span style=display:flex><span>               <span style=color:#e6db74>&#34;ratings.default&#34;</span>,
</span></span><span style=display:flex><span>               <span style=color:#e6db74>&#34;ratings.default:9080&#34;</span>,
</span></span><span style=display:flex><span>               <span style=color:#e6db74>&#34;10.8.8.106&#34;</span>,
</span></span><span style=display:flex><span>               <span style=color:#e6db74>&#34;10.8.8.106:9080&#34;</span>
</span></span><span style=display:flex><span>           ],
</span></span><span style=display:flex><span>           <span style=color:#f92672>&#34;routes&#34;</span>: [
</span></span><span style=display:flex><span>               {
</span></span><span style=display:flex><span>                   <span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;default&#34;</span>,
</span></span><span style=display:flex><span>                   <span style=color:#f92672>&#34;match&#34;</span>: {
</span></span><span style=display:flex><span>                       <span style=color:#f92672>&#34;prefix&#34;</span>: <span style=color:#e6db74>&#34;/&#34;</span>
</span></span><span style=display:flex><span>                   },
</span></span><span style=display:flex><span>                   <span style=color:#f92672>&#34;route&#34;</span>: {
</span></span><span style=display:flex><span>                       <span style=color:#f92672>&#34;cluster&#34;</span>: <span style=color:#e6db74>&#34;outbound|9080||ratings.default.svc.cluster.local&#34;</span>,
</span></span><span style=display:flex><span>                       <span style=color:#f92672>&#34;timeout&#34;</span>: <span style=color:#e6db74>&#34;0s&#34;</span>,
</span></span><span style=display:flex><span>                       <span style=color:#f92672>&#34;retryPolicy&#34;</span>: {
</span></span><span style=display:flex><span>                           <span style=color:#f92672>&#34;retryOn&#34;</span>: <span style=color:#e6db74>&#34;connect-failure,refused-stream,unavailable,cancelled,retriable-status-codes&#34;</span>,
</span></span><span style=display:flex><span>                           <span style=color:#f92672>&#34;numRetries&#34;</span>: <span style=color:#ae81ff>2</span>,
</span></span><span style=display:flex><span>                           <span style=color:#f92672>&#34;retryHostPredicate&#34;</span>: [
</span></span><span style=display:flex><span>                               {
</span></span><span style=display:flex><span>                                   <span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;envoy.retry_host_predicates.previous_hosts&#34;</span>
</span></span><span style=display:flex><span>                               }
</span></span><span style=display:flex><span>                           ],
</span></span><span style=display:flex><span>                           <span style=color:#f92672>&#34;hostSelectionRetryMaxAttempts&#34;</span>: <span style=color:#e6db74>&#34;5&#34;</span>,
</span></span><span style=display:flex><span>                           <span style=color:#f92672>&#34;retriableStatusCodes&#34;</span>: [
</span></span><span style=display:flex><span>                               <span style=color:#ae81ff>503</span>
</span></span><span style=display:flex><span>                           ]
</span></span><span style=display:flex><span>                       },
</span></span><span style=display:flex><span>                       <span style=color:#f92672>&#34;maxStreamDuration&#34;</span>: {
</span></span><span style=display:flex><span>                           <span style=color:#f92672>&#34;maxStreamDuration&#34;</span>: <span style=color:#e6db74>&#34;0s&#34;</span>,
</span></span><span style=display:flex><span>                           <span style=color:#f92672>&#34;grpcTimeoutHeaderMax&#34;</span>: <span style=color:#e6db74>&#34;0s&#34;</span>
</span></span><span style=display:flex><span>                       }
</span></span><span style=display:flex><span>                   },
</span></span><span style=display:flex><span>                   <span style=color:#f92672>&#34;decorator&#34;</span>: {
</span></span><span style=display:flex><span>                       <span style=color:#f92672>&#34;operation&#34;</span>: <span style=color:#e6db74>&#34;ratings.default.svc.cluster.local:9080/*&#34;</span>
</span></span><span style=display:flex><span>                   }
</span></span><span style=display:flex><span>               }
</span></span><span style=display:flex><span>           ],
</span></span><span style=display:flex><span>           <span style=color:#f92672>&#34;includeRequestAttemptCount&#34;</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>       },
</span></span><span style=display:flex><span>       <span style=color:#960050;background-color:#1e0010>/*省略部分内容*/</span>
</span></span><span style=display:flex><span>     ],
</span></span><span style=display:flex><span>     <span style=color:#f92672>&#34;validateClusters&#34;</span>: <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>]
</span></span></code></pre></div><p>从该 Virtual Host 配置中可以看到将流量路由到<code>outbound|9080||ratings.default.svc.cluster.local</code> 集群。</p><p><strong><code>outbound|9080||ratings.default.svc.cluster.local</code> 集群的端点</strong></p><p>运行 <code>istioctl proxy-config endpoint reviews-v1-545db77b95-jkgv2 --port 9080 -o json --cluster "outbound|9080||ratings.default.svc.cluster.local"</code> 查看集群的 Endpoint 配置，结果如下。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>[
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;outbound|9080||ratings.default.svc.cluster.local&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;addedViaApi&#34;</span>: <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;hostStatuses&#34;</span>: [
</span></span><span style=display:flex><span>            {
</span></span><span style=display:flex><span>                <span style=color:#f92672>&#34;address&#34;</span>: {
</span></span><span style=display:flex><span>                    <span style=color:#f92672>&#34;socketAddress&#34;</span>: {
</span></span><span style=display:flex><span>                        <span style=color:#f92672>&#34;address&#34;</span>: <span style=color:#e6db74>&#34;10.4.1.12&#34;</span>,
</span></span><span style=display:flex><span>                        <span style=color:#f92672>&#34;portValue&#34;</span>: <span style=color:#ae81ff>9080</span>
</span></span><span style=display:flex><span>                    }
</span></span><span style=display:flex><span>                },
</span></span><span style=display:flex><span>                <span style=color:#f92672>&#34;stats&#34;</span>: [
</span></span><span style=display:flex><span>                    {
</span></span><span style=display:flex><span>                        <span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;cx_connect_fail&#34;</span>
</span></span><span style=display:flex><span>                    },
</span></span><span style=display:flex><span>                    {
</span></span><span style=display:flex><span>                        <span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;cx_total&#34;</span>
</span></span><span style=display:flex><span>                    },
</span></span><span style=display:flex><span>                    {
</span></span><span style=display:flex><span>                        <span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;rq_error&#34;</span>
</span></span><span style=display:flex><span>                    },
</span></span><span style=display:flex><span>                    {
</span></span><span style=display:flex><span>                        <span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;rq_success&#34;</span>
</span></span><span style=display:flex><span>                    },
</span></span><span style=display:flex><span>                    {
</span></span><span style=display:flex><span>                        <span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;rq_timeout&#34;</span>
</span></span><span style=display:flex><span>                    },
</span></span><span style=display:flex><span>                    {
</span></span><span style=display:flex><span>                        <span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;rq_total&#34;</span>
</span></span><span style=display:flex><span>                    },
</span></span><span style=display:flex><span>                    {
</span></span><span style=display:flex><span>                        <span style=color:#f92672>&#34;type&#34;</span>: <span style=color:#e6db74>&#34;GAUGE&#34;</span>,
</span></span><span style=display:flex><span>                        <span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;cx_active&#34;</span>
</span></span><span style=display:flex><span>                    },
</span></span><span style=display:flex><span>                    {
</span></span><span style=display:flex><span>                        <span style=color:#f92672>&#34;type&#34;</span>: <span style=color:#e6db74>&#34;GAUGE&#34;</span>,
</span></span><span style=display:flex><span>                        <span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;rq_active&#34;</span>
</span></span><span style=display:flex><span>                    }
</span></span><span style=display:flex><span>                ],
</span></span><span style=display:flex><span>                <span style=color:#f92672>&#34;healthStatus&#34;</span>: {
</span></span><span style=display:flex><span>                    <span style=color:#f92672>&#34;edsHealthStatus&#34;</span>: <span style=color:#e6db74>&#34;HEALTHY&#34;</span>
</span></span><span style=display:flex><span>                },
</span></span><span style=display:flex><span>                <span style=color:#f92672>&#34;weight&#34;</span>: <span style=color:#ae81ff>1</span>,
</span></span><span style=display:flex><span>                <span style=color:#f92672>&#34;locality&#34;</span>: {
</span></span><span style=display:flex><span>                    <span style=color:#f92672>&#34;region&#34;</span>: <span style=color:#e6db74>&#34;us-west2&#34;</span>,
</span></span><span style=display:flex><span>                    <span style=color:#f92672>&#34;zone&#34;</span>: <span style=color:#e6db74>&#34;us-west2-a&#34;</span>
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        ],
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;circuitBreakers&#34;</span>: {
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;thresholds&#34;</span>: [
</span></span><span style=display:flex><span>                {
</span></span><span style=display:flex><span>                    <span style=color:#f92672>&#34;maxConnections&#34;</span>: <span style=color:#ae81ff>4294967295</span>,
</span></span><span style=display:flex><span>                    <span style=color:#f92672>&#34;maxPendingRequests&#34;</span>: <span style=color:#ae81ff>4294967295</span>,
</span></span><span style=display:flex><span>                    <span style=color:#f92672>&#34;maxRequests&#34;</span>: <span style=color:#ae81ff>4294967295</span>,
</span></span><span style=display:flex><span>                    <span style=color:#f92672>&#34;maxRetries&#34;</span>: <span style=color:#ae81ff>4294967295</span>
</span></span><span style=display:flex><span>                },
</span></span><span style=display:flex><span>                {
</span></span><span style=display:flex><span>                    <span style=color:#f92672>&#34;priority&#34;</span>: <span style=color:#e6db74>&#34;HIGH&#34;</span>,
</span></span><span style=display:flex><span>                    <span style=color:#f92672>&#34;maxConnections&#34;</span>: <span style=color:#ae81ff>1024</span>,
</span></span><span style=display:flex><span>                    <span style=color:#f92672>&#34;maxPendingRequests&#34;</span>: <span style=color:#ae81ff>1024</span>,
</span></span><span style=display:flex><span>                    <span style=color:#f92672>&#34;maxRequests&#34;</span>: <span style=color:#ae81ff>1024</span>,
</span></span><span style=display:flex><span>                    <span style=color:#f92672>&#34;maxRetries&#34;</span>: <span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            ]
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;observabilityName&#34;</span>: <span style=color:#e6db74>&#34;outbound|9080||ratings.default.svc.cluster.local&#34;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>]
</span></span></code></pre></div><p>我们看到端点的地址是 <code>10.4.1.12</code>。实际上，Endpoint 可以是一个或多个，sidecar 将根据一定规则选择适当的 Endpoint 来路由。至此 <code>review</code> Pod找到了它上游服务 <code>rating</code> 的 Endpoint。</p><h2 id=小结>小结</h2><p>本文使用了 Istio 官方提供的 bookinfo 示例，按图索骥得带领读者了解了 sidecar 注入、iptables 透明流量劫持及 sidecar 中流量路由背后的实现细节。Sidecar 模式和流量透明劫持是 Istio 服务网格的特色和基础功能，理解该功能的背后过程及实现细节，将有助于大家理解 Service Mesh 的原理和 <a href=https://www.servicemesher.com/istio-handbook/>Istio Handbook</a> 后面章节中的内容，因此希望读者可以在自己的环境中从头来试验一遍以加深理解。</p><p>使用 iptables 做流量劫持只是 service mesh 的数据平面中做流量劫持的方式之一，还有更多的流量劫持方案，下面引用自 <a href=https://mosn.io/docs/products/structure/traffic-hijack/>云原生网络代理 MOSN 官网中给出的流量劫持</a>部分的描述。</p><h3 id=使用-iptables-做流量劫持时存在的问题>使用 iptables 做流量劫持时存在的问题</h3><p>目前 Istio 使用 iptables 实现透明劫持，主要存在以下三个问题：</p><ol><li>需要借助于 conntrack 模块实现连接跟踪，在连接数较多的情况下，会造成较大的消耗，同时可能会造成 track 表满的情况，为了避免这个问题，业内有关闭 conntrack 的做法。</li><li>iptables 属于常用模块，全局生效，不能显式的禁止相关联的修改，可管控性比较差。</li><li>iptables 重定向流量本质上是通过 loopback 交换数据，outbond 流量将两次穿越协议栈，在大并发场景下会损失转发性能。</li></ol><p>上述几个问题并非在所有场景中都存在，比方说某些场景下，连接数并不多，且 NAT 表未被使用到的情况下，iptables 是一个满足要求的简单方案。为了适配更加广泛的场景，透明劫持需要解决上述三个问题。</p><h3 id=透明劫持方案优化>透明劫持方案优化</h3><p>为了优化 Istio 中的透明流量劫持的性能，业界提出了以下方案。</p><p><strong>使用 Merbridge 开源项目利用 eBPF 劫持流量</strong></p><p><a href=https://github.com/merbridge/merbridge>Merbridge</a> 是由 DaoCloud 在 2022 年初开源的的一款利用 eBPF 加速 Istio 服务网格的插件。使用 Merbridge 可以在一定程度上优化数据平面的网络性能。</p><p>Merbridge 利用 eBPF 的 <code>sockops</code> 和 <code>redir</code> 能力，可以直接将数据包从 inbound socket 传输到 outbound socket。eBPF 提供了 <code>bpf_msg_redirect_hash</code> 函数可以直接转发应用程序的数据包。</p><p>详见 <a href=https://jimmysong.io/istio-handbook/ecosystem/merbridge.html>Istio 服务网格 —— 云原生应用网络构建指南</a>。</p><p><strong>使用 tproxy 处理 inbound 流量</strong></p><p>tproxy 可以用于 inbound 流量的重定向，且无需改变报文中的目的 IP/端口，不需要执行连接跟踪，不会出现 conntrack 模块创建大量连接的问题。受限于内核版本，tproxy 应用于 outbound 存在一定缺陷。目前 Istio 支持通过 tproxy 处理 inbound 流量。</p><p><strong>使用 hook connect 处理 outbound 流量</strong></p><p>为了适配更多应用场景，outbound 方向通过 hook connect 来实现，实现原理如下：</p><figure><img src=hook-connect.svg alt="hook-connect 原理示意图" width=50%><figcaption><h4>hook-connect 原理示意图</h4></figcaption></figure><p>无论采用哪种透明劫持方案，均需要解决获取真实目的 IP/端口的问题，使用 iptables 方案通过 getsockopt 方式获取，tproxy 可以直接读取目的地址，通过修改调用接口，hook connect 方案读取方式类似于 tproxy。</p><p>实现透明劫持后，在内核版本满足要求（4.16以上）的前提下，通过 sockmap 可以缩短报文穿越路径，进而改善 outbound 方向的转发性能。</p><h2 id=更新说明>更新说明</h2><p>下面是本文的几次更新说明。</p><p><strong>2020 年 4 月 27 日，第一版，基于 Istio 1.5</strong></p><p>本文的第一版，基于 Istio 1.5 创作，在此之前，我曾写过基于 Istio 1.1 版本的<a href=/blog/envoy-sidecar-injection-in-istio-service-mesh-deep-dive/>理解 Istio Service Mesh 中 Envoy 代理 Sidecar 注入及流量劫持</a>，为了更细致的理解 Istio 中透明流量劫持的全过程，专门创作本文。</p><p><strong>2022 年 1 月 17 日，第二版，基于 Istio 1.11</strong></p><p>本文第一版发布后，在社区里获得了比较大的反响，收到了很多读者的评论和留言。基于这些评论，我也发现了第一版中的很多错误，在加上 Istio 版本发布频繁，在近两年的时间内，Istio 已经作出了众多更新，其中不乏重大更新。因此笔者撰写了本文的第二版，修改了之前版本中的纰漏并根据时下 Istio 的最新版本更新了本文。</p><p>Istio 1.11 与 Istio 1.1 中的 sidecar 注入和流量劫持环节最大的变化是：</p><ul><li>iptables 改用命令行工具，不再使用 shell 脚本。</li><li>sidecar inbound 和 outbound 分别指定了端口，而之前是使用同一个端口（15001）。</li></ul><p><strong>2022 年 4 月 24，第三版，基于 Istio 1.13</strong></p><p>这个版本的文章主要是根据当时 Istio 的最新版本更新了文章的部分内容，并重新排版，增加更新说明。</p><p>Istio 1.13 相比 Istio 1.11 的变化是 <code>istioctl proxy-config</code> 命令的输出有了较大变化。</p><p><strong>2022 年 5 月 6 日，第四版，基于 Istio 1.13</strong></p><ul><li>修改了对 <code>ISTIO_ROUTE</code> iptables 规则 2、5 的解释</li><li>在示意图中增加了路径 16</li></ul><p><strong>2022 年 5 月 12 日，第五版，基于 Istio 1.13</strong></p><ul><li>将 iptables 说明和 sidecar 注入、init 容器部分独立成了两篇单独的博客，以缩减博客的篇幅，见 <a href=/blog/istio-pod-process-lifecycle/>Istio 数据平面 Pod 启动过程详解</a>和<a href=/blog/understanding-iptables/>理解 iptables</a>。</li></ul><h2 id=参考>参考</h2><ul><li><a href=https://jimmysong.io/blog/sidecar-injection-iptables-and-traffic-routing/>阅读原文</a></li><li><a href=https://istio.io/latest/docs/ops/diagnostic-tools/proxy-cmd/>Debugging Envoy and Istiod - istio.io</a></li><li><a href=https://istio.io/latest/zh/blog/2019/data-plane-setup/>揭开 Istio Sidecar 注入模型的神秘面纱 - istio.io</a></li><li><a href=https://mosn.io/docs/products/structure/traffic-hijack/>MOSN 作为 Sidecar 使用时的流量劫持方案 - mosn.io</a></li></ul><ul class="list-unstyled d-flex justify-content-between align-items-center mb-0 pt-5"><li><a href=/blog/2022/09/11/dd0bd7/ aria-label=" - 深入Istio系列-Sidecar自动注入" class="btn btn-primary"><span class=mr-1>←</span></a></li><li><a href=/blog/2022/09/11/61aaaf/ aria-label=" - 深入Istio系列-Sidecar 中的流量类型及 iptables 规则详解" class="btn btn-primary"><span class=ml-1>→</span></a></li></ul></div></main></div></div><footer class="bg-dark py-5 row d-print-none"><div class="container-fluid mx-sm-5"><div class=row><div class="col-6 col-sm-4 text-xs-center order-sm-2"></div><div class="col-6 col-sm-4 text-right text-xs-center order-sm-3"></div><div class="col-12 col-sm-4 text-center py-2 order-sm-2"><small class=text-white>&copy; 2023 The Docsy Authors</small>
<small class=ml-1><a href=https://policies.google.com/privacy target=_blank rel=noopener></a></small></div></div></div></footer></div><script src=/js/main.min.3e4a6958dccc830952d0c30c43229e6e16b26815c56825ee1948e84372c67feb.js integrity="sha256-PkppWNzMgwlS0MMMQyKebhayaBXFaCXuGUjoQ3LGf+s=" crossorigin=anonymous></script>
<script src=/js/tabpane-persist.js></script></body></html>