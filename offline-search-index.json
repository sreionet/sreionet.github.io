[
    {
        "uri": "/zh/_index",
        "title": "mydocsy",
        "content": "\ntest\n1234",
        "tags": []
    },
    {
        "uri": "/zh/blog/_index",
        "content": "---\ntitle: \"博客\"\ntype: blog\ndescription: \n    A special section with a docs layout.\n---",
        "tags": []
    },
    {
        "uri": "/zh/blog/istio/Aeraki部署",
        "content": "---\ntitle: Aeraki部署\nslug: 39c737\ndate: 2022-10-13T17:28:36+08:00\ndraft: true\npassword: 名称空间\nauthor: kbsonlong\nauthorEmail: kbsonlong@gmail.com\ntags: [Aeraki,Istio]\ncategories: [ServiceMesh]\n\n---\n下载源码\n\ngit clone https://github.com/aeraki-mesh/aeraki.git\ncd aeraki\ngit checkout 1.2.0\n\n Istio启用DNS和Aeraki管理协议\nkubectl edit cm istio -n istio-system\n\napiVersion: v1\ndata:\n  mesh: |-\n    defaultConfig:\n      proxyMetadata:\n        ISTIOMETADNS_CAPTURE: \"true\"\n      proxyStatsMatcher:\n        inclusionPrefixes:\n        thrift\n        dubbo\n        kafka\n        meta_protocol\n        inclusionRegexps:\n        .dubbo.\n        .thrift.\n        .kafka.\n        .zookeeper.\n        .meta_protocol.  \n\n 安装Aeraki CRD自定义资源\n  kubectl delete crd applicationprotocols.metaprotocol.aeraki.io || true\n  kubectl apply -f ./k8s/crd.yaml\n\n安装Aeraki\nkubectl apply -f - <<EOF\n Copyright Aeraki Authors\n Licensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\n You may obtain a copy of the License at\n     http://www.apache.org/licenses/LICENSE-2.0\n Unless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\n WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\n limitations under the License.\n\n---\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: aeraki\n  namespace: istio-system\n  labels:\n    app: aeraki\nspec:\n  selector:\n    matchLabels:\n      app: aeraki\n  replicas: 2\n  template:\n    metadata:\n      labels:\n        app: aeraki\n      annotations:\n        sidecar.istio.io/inject: \"false\"\n    spec:\n      serviceAccountName: aeraki\n      containers:\n        name: aeraki\n          image: aeraki/aeraki:1.2.0\n          # imagePullPolicy should be set to Never so Minikube can use local image for e2e testing\n          imagePullPolicy: IfNotPresent\n          env:\n            name: AERAKIISMASTER\n              value: \"true\"\n            name: AERAKIISTIODADDR\n              value: istiod.istio-system:15010\n            name: AERAKIXDSLISTEN_ADDR\n              value: \":15010\"\n            name: AERAKIENABLEENVOYFILTERNS_SCOPE\n              # False(Default): The generated envoyFilters will be placed under Istio root namespace\n              # True: The generated envoyFilters will be placed under the service namespace\n              value: \"true\"   ##https://github.com/aeraki-mesh/aeraki/pull/226\n            name: AERAKILOGLEVEL\n              value: \"all:info\"\n            name: AERAKI_NAMESPACE\n              valueFrom:\n                fieldRef:\n                  fieldPath: metadata.namespace\n            name: AERAKISERVERID\n              valueFrom:\n                fieldRef:\n                  fieldPath: metadata.name\n          volumeMounts:\n            name: istiod-ca-cert\n              mountPath: /var/run/secrets/istio\n              readOnly: true\n      volumes:\n        name: istiod-ca-cert\n          configMap:\n            name: istio-ca-root-cert\n            defaultMode: 420\n---\napiVersion: v1\nkind: Service\nmetadata:\n  labels:\n    app: aeraki\n  name: aeraki\n  namespace: istio-system\nspec:\n  ports:\n    name: grpc-xds\n      port: 15010\n      protocol: TCP\n      targetPort: 15010\n    name: https-validation\n      port: 443\n      protocol: TCP\n      targetPort: 15017\n  selector:\n    app: aeraki\n---\napiVersion: v1\nkind: ServiceAccount\nmetadata:\n  name: aeraki\n  namespace: istio-system\n---\napiVersion: rbac.authorization.k8s.io/v1\nkind: Role\nmetadata:\n  labels:\n    app: aeraki\n  name: aeraki\n  namespace: istio-system\nrules:\n  apiGroups:\n      \"\"\n    resources:\n      configmaps\n      events\n    verbs:\n      '*'\n  apiGroups:\n      coordination.k8s.io\n    resources:\n      '*'\n    verbs:\n      '*'\n---\napiVersion: rbac.authorization.k8s.io/v1\nkind: RoleBinding\nmetadata:\n  labels:\n    app: aeraki\n  name: aeraki\n  namespace: istio-system\nroleRef:\n  apiGroup: rbac.authorization.k8s.io\n  kind: Role\n  name: aeraki\nsubjects:\n  kind: ServiceAccount\n    name: aeraki\n---\napiVersion: rbac.authorization.k8s.io/v1\nkind: ClusterRole\nmetadata:\n  labels:\n    app: aeraki\n  name: aeraki\nrules:\n  apiGroups:\n      \"\"\n    resources:\n      secrets\n      namespaces\n      configmaps\n    verbs:\n      '*'\n  apiGroups:\n      networking.istio.io\n    resources:\n      '*'\n    verbs:\n      '*'\n  apiGroups:\n      redis.aeraki.io\n      dubbo.aeraki.io\n      metaprotocol.aeraki.io\n    resources:\n      '*'\n    verbs:\n      '*'\n  apiGroups:\n      networking.istio.io\n    resources:\n      virtualservices\n      destinationrules\n      envoyfilters\n      serviceentries\n    verbs:\n      '*'\n  apiGroups:\n      admissionregistration.k8s.io\n    resources:\n      validatingwebhookconfigurations\n    verbs:\n      '*'\n---\napiVersion: rbac.authorization.k8s.io/v1\nkind: ClusterRoleBinding\nmetadata:\n  labels:\n    app: aeraki\n  name: aeraki\nroleRef:\n  apiGroup: rbac.authorization.k8s.io\n  kind: ClusterRole\n  name: aeraki\nsubjects:\n  kind: ServiceAccount\n    name: aeraki\n    namespace: istio-system\n---\napiVersion: metaprotocol.aeraki.io/v1alpha1\nkind: ApplicationProtocol\nmetadata:\n  name: dubbo\nspec:\n  protocol: dubbo\n  codec: aeraki.meta_protocol.codec.dubbo\n---\napiVersion: metaprotocol.aeraki.io/v1alpha1\nkind: ApplicationProtocol\nmetadata:\n  name: thrift\nspec:\n  protocol: thrift\n  codec: aeraki.meta_protocol.codec.thrift\nEOF\n\n安装懒加载组件(Lazyxds)\n\nkubectl apply -f https://raw.githubusercontent.com/aeraki-mesh/lazyxds/master/install/lazyxds-egress.yaml\nkubectl apply -f https://raw.githubusercontent.com/aeraki-mesh/lazyxds/master/install/lazyxds-controller.yaml\n\n Copyright Aeraki Authors\n Licensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\n You may obtain a copy of the License at\n     http://www.apache.org/licenses/LICENSE-2.0\n Unless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\n WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\n limitations under the License.\n\n---\napiVersion: v1\nkind: ServiceAccount\nmetadata:\n  name: istio-egressgateway-lazyxds-service-account\n  namespace: istio-system\n  labels:\n    app: lazyxds\n    istio: egressgateway\n---\n\napiVersion: rbac.authorization.k8s.io/v1\nkind: Role\nmetadata:\n  name: istio-egressgateway-lazyxds-sds\n  namespace: istio-system\nrules:\n  apiGroups: [\"\"]\n    resources: [\"secrets\"]\n    verbs: [\"get\", \"watch\", \"list\"]\n---\n\napiVersion: rbac.authorization.k8s.io/v1\nkind: RoleBinding\nmetadata:\n  name: istio-egressgateway-lazyxds-sds\n  namespace: istio-system\nroleRef:\n  apiGroup: rbac.authorization.k8s.io\n  kind: Role\n  name: istio-egressgateway-lazyxds-sds\nsubjects:\n  kind: ServiceAccount\n    name: istio-egressgateway-lazyxds-service-account\n---\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: lazyxds-als-bootstrap\n  namespace: istio-system\ndata:\n  custom_bootstrap.json: |\n    {\n      \"static_resources\": {\n        \"clusters\": [{\n          \"name\": \"lazyxds-accesslog-service\",\n          \"type\": \"STRICT_DNS\",\n          \"connect_timeout\": \"1s\",\n          \"http2protocoloptions\": {},\n          \"dnslookupfamily\": \"V4_ONLY\",\n          \"load_assignment\": {\n            \"cluster_name\": \"lazyxds-accesslog-service\",\n            \"endpoints\": [{\n              \"lb_endpoints\": [{\n                \"endpoint\": {\n                  \"address\": {\n                    \"socket_address\": {\n                      \"address\": \"lazyxds.istio-system\",\n                      \"port_value\": 8080\n                    }\n                  }\n                }\n              }]\n            }]\n          },\n          \"respectdnsttl\": true\n        }]\n      }\n    }\n---\napiVersion: networking.istio.io/v1alpha3\nkind: EnvoyFilter\nmetadata:\n  name: lazyxds-egress-als\n  namespace: istio-system\nspec:\n  workloadSelector:\n    labels:\n      app: istio-egressgateway-lazyxds\n  configPatches:\n    applyTo: NETWORK_FILTER\n      match:\n        context: GATEWAY\n        listener:\n          filterChain:\n            filter:\n              name: \"envoy.filters.network.httpconnectionmanager\"\n      patch:\n        operation: MERGE\n        value:\n          typed_config:\n            \"@type\": \"type.googleapis.com/envoy.extensions.filters.network.httpconnectionmanager.v3.HttpConnectionManager\"\n            access_log:\n              name: envoy.access_loggers.file\n                typed_config:\n                  \"@type\": type.googleapis.com/envoy.extensions.access_loggers.file.v3.FileAccessLog\n                  path: \"/dev/stdout\"\n                  log_format:\n                    textformat: \"[%STARTTIME%] \\\"%REQ(:METHOD)% %REQ(X-ENVOY-ORIGINAL-PATH?:PATH)% %PROTOCOL%\\\" %RESPONSECODE% %RESPONSEFLAGS% \\\"%UPSTREAMTRANSPORTFAILUREREASON%\\\" %BYTESRECEIVED% %BYTESSENT% %DURATION% %RESP(X-ENVOY-UPSTREAM-SERVICE-TIME)% \\\"%REQ(X-FORWARDED-FOR)%\\\" \\\"%REQ(USER-AGENT)%\\\" \\\"%REQ(X-REQUEST-ID)%\\\" \\\"%REQ(:AUTHORITY)%\\\" \\\"%UPSTREAMHOST%\\\" %UPSTREAMCLUSTER% %UPSTREAMLOCALADDRESS% %DOWNSTREAMLOCALADDRESS% %DOWNSTREAMREMOTEADDRESS% %REQUESTEDSERVERNAME% %ROUTENAME%\\n\"\n              name: envoy.accessloggers.httpgrpc\n                typed_config:\n                  \"@type\": type.googleapis.com/envoy.extensions.access_loggers.grpc.v3.HttpGrpcAccessLogConfig\n                  common_config:\n                    logname: httpenvoy_accesslog\n                    transportapiversion: \"V3\"\n                    grpc_service:\n                      envoy_grpc:\n                        cluster_name: lazyxds-accesslog-service\n---\napiVersion: v1\nkind: Service\nmetadata:\n  name: istio-egressgateway-lazyxds\n  namespace: istio-system\n  labels:\n    app: istio-egressgateway-lazyxds\n    istio: egressgateway\nspec:\n  ports:\n    name: http2\n      port: 8080\n      protocol: TCP\n  selector:\n    app: istio-egressgateway-lazyxds\n    istio: egressgateway\n  type: ClusterIP\n---\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: istio-egressgateway-lazyxds\n  namespace: istio-system\n  labels:\n    app: istio-egressgateway-lazyxds\n    istio: egressgateway\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: istio-egressgateway-lazyxds\n      istio: egressgateway\n  template:\n    metadata:\n      annotations:\n        sidecar.istio.io/discoveryAddress: istiod.istio-system.svc:15012\n        sidecar.istio.io/inject: \"false\"\n      labels:\n        app: istio-egressgateway-lazyxds\n        istio: egressgateway\n    spec:\n      # imagePullSecrets:\n      # - name: repo-hz\n      containers:\n        args:\n            proxy\n            router\n            --domain\n            $(POD_NAMESPACE).svc.cluster.local\n            --proxyLogLevel=warning\n            --proxyComponentLogLevel=misc:error\n            --logoutputlevel=default:info\n            --serviceCluster\n            istio-egressgateway\n          env:\n            name: ISTIOBOOTSTRAPOVERRIDE\n              value: /etc/istio/custom-bootstrap/custom_bootstrap.json\n            name: JWT_POLICY\n              value: third-party-jwt\n            name: PILOTCERTPROVIDER\n              value: istiod\n            name: CA_ADDR\n              value: istiod.istio-system.svc:15012\n            name: NODE_NAME\n              valueFrom:\n                fieldRef:\n                  apiVersion: v1\n                  fieldPath: spec.nodeName\n            name: POD_NAME\n              valueFrom:\n                fieldRef:\n                  apiVersion: v1\n                  fieldPath: metadata.name\n            name: POD_NAMESPACE\n              valueFrom:\n                fieldRef:\n                  apiVersion: v1\n                  fieldPath: metadata.namespace\n            name: INSTANCE_IP\n              valueFrom:\n                fieldRef:\n                  apiVersion: v1\n                  fieldPath: status.podIP\n            name: HOST_IP\n              valueFrom:\n                fieldRef:\n                  apiVersion: v1\n                  fieldPath: status.hostIP\n            name: SERVICE_ACCOUNT\n              valueFrom:\n                fieldRef:\n                  apiVersion: v1\n                  fieldPath: spec.serviceAccountName\n            name: ISTIOMETAWORKLOAD_NAME\n              value: istio-egressgateway-lazyxds\n            name: ISTIOMETAOWNER\n              value: kubernetes://apis/apps/v1/namespaces/istio-system/deployments/istio-egressgateway-lazyxds\n            name: ISTIOMETAMESH_ID\n              value: cluster.local\n            name: ISTIOMETAROUTER_MODE\n              value: standard\n            name: ISTIOMETACLUSTER_ID\n              value: Kubernetes\n          image: registry.cn-hangzhou.aliyuncs.com/yy_default/istio-proxyv2:1.13.4\n          imagePullPolicy: IfNotPresent\n          name: istio-proxy\n          ports:\n            containerPort: 8080\n              protocol: TCP\n            containerPort: 15090\n              name: http-envoy-prom\n              protocol: TCP\n          readinessProbe:\n            httpGet:\n              path: /healthz/ready\n              port: 15021\n              scheme: HTTP\n            initialDelaySeconds: 1\n            periodSeconds: 2\n            failureThreshold: 30\n            successThreshold: 1\n            timeoutSeconds: 1\n          volumeMounts:\n            mountPath: /etc/istio/custom-bootstrap\n              name: custom-bootstrap-volume\n            mountPath: /etc/istio/proxy\n              name: istio-envoy\n            mountPath: /etc/istio/config\n              name: config-volume\n            mountPath: /var/run/secrets/istio\n              name: istiod-ca-cert\n            mountPath: /var/run/ingress_gateway\n              name: gatewaysdsudspath\n            mountPath: /var/lib/istio/data\n              name: istio-data\n            mountPath: /var/run/secrets/tokens\n              name: istio-token\n              readOnly: true\n            mountPath: /etc/istio/pod\n              name: podinfo\n            mountPath: /etc/istio/egressgateway-certs\n              name: egressgateway-certs\n              readOnly: true\n            mountPath: /etc/istio/egressgateway-ca-certs\n              name: egressgateway-ca-certs\n              readOnly: true\n      serviceAccountName: istio-egressgateway-lazyxds-service-account\n      volumes:\n        configMap:\n            defaultMode: 420\n            name: lazyxds-als-bootstrap\n          name: custom-bootstrap-volume\n        configMap:\n            defaultMode: 420\n            name: istio-ca-root-cert\n          name: istiod-ca-cert\n        downwardAPI:\n            defaultMode: 420\n            items:\n              fieldRef:\n                  apiVersion: v1\n                  fieldPath: metadata.labels\n                path: labels\n              fieldRef:\n                  apiVersion: v1\n                  fieldPath: metadata.annotations\n                path: annotations\n          name: podinfo\n        emptyDir: {}\n          name: istio-envoy\n        emptyDir: {}\n          name: gatewaysdsudspath\n        emptyDir: {}\n          name: istio-data\n        name: istio-token\n          projected:\n            defaultMode: 420\n            sources:\n            serviceAccountToken:\n                audience: istio-ca\n                expirationSeconds: 43200\n                path: istio-token\n        configMap:\n            defaultMode: 420\n            name: istio-1-8-1\n            optional: true\n          name: config-volume\n        name: egressgateway-certs\n          secret:\n            defaultMode: 420\n            optional: true\n            secretName: istio-egressgateway-lazyxds-certs\n        name: egressgateway-ca-certs\n          secret:\n            defaultMode: 420\n            optional: true\n            secretName: istio-egressgateway-lazyxds-ca-certs\n---\n\napiVersion: networking.istio.io/v1beta1\nkind: Gateway\nmetadata:\n  name: lazyxds-egress\n  namespace: istio-system\n  labels:\n    app: istio-egressgateway-lazyxds\n    istio: egressgateway\nspec:\n  selector:\n    app: istio-egressgateway-lazyxds\n    istio: egressgateway\n  servers:\n    hosts:\n        '*'\n      port:\n        name: http\n        number: 8080\n        protocol: HTTP\n---\n\nCopyright Aeraki Authors\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\n you may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\nhttp://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\n distributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n See the License for the specific language governing permissions and\nlimitations under the License.\n\n---\napiVersion: v1\nkind: ServiceAccount\nmetadata:\n  name: lazyxds\n  namespace: istio-system\n  labels:\n    app: lazyxds\n---\napiVersion: rbac.authorization.k8s.io/v1\nkind: ClusterRole\nmetadata:\n  name: lazyxds\n  labels:\n    app: lazyxds\nrules:\n  apiGroups: [\"*\"]\n    resources: [\"pods\", \"nodes\", \"namespaces\", \"endpoints\", \"secrets\"]\n    verbs: [\"get\", \"list\", \"watch\"]\n  apiGroups: [\"*\"]\n    resources: [\"configmaps\", \"deployments\", \"services\", \"roles\", \"rolebindings\", \"serviceaccounts\"]\n    verbs: [\"get\", \"list\", \"watch\", \"create\", \"update\", \"delete\"]\n  apiGroups: [\"networking.istio.io\"]\n    resources: [\"*\"]\n    verbs: [\"*\"]\n---\napiVersion: rbac.authorization.k8s.io/v1\nkind: ClusterRoleBinding\nmetadata:\n  name: lazyxds\n  labels:\n    app: lazyxds\nroleRef:\n  apiGroup: rbac.authorization.k8s.io\n  kind: ClusterRole\n  name: lazyxds\nsubjects:\n  kind: ServiceAccount\n    namespace: istio-system\n    name: lazyxds\n---\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  labels:\n    app: lazyxds\n  name: lazyxds\n  namespace: istio-system\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: lazyxds\n  template:\n    metadata:\n      labels:\n        app: lazyxds\n    spec:\n       imagePullSecrets:\n      # - name: repo-hz\n      serviceAccountName: lazyxds\n      containers:\n        image: aeraki/lazyxds:latest\n          imagePullPolicy: Always\n          name: app\n          ports:\n            containerPort: 8080\n              protocol: TCP\n---\napiVersion: v1\nkind: Service\nmetadata:\n  labels:\n    app: lazyxds\n  name: lazyxds\n  namespace: istio-system\nspec:\n  ports:\n    name: grpc-als\n      port: 8080\n      protocol: TCP\n  selector:\n    app: lazyxds\n  type: ClusterIP\n---\n\n启用Lazyxds\n\n Service 启用\nkubectl annotate service my-service lazy-xds=true --overwrite\n\n针对NameSpace启用\n\nkubectl annotate namespace my-namespace lazy-xds=true --overwrite\n",
        "tags": []
    },
    {
        "uri": "/zh/blog/istio/Envoy性能指标",
        "content": "---\ntitle: Envoy性能指标\nslug: 0affe7\ndate: 2022-09-13T10:46:39+08:00\ndraft: false\nauthor: kbsonlong\nauthorEmail: kbsonlong@gmail.com\ntags: [istio,envoy,转载]\ncategories: [云原生]\n\n---\nEnvoy 指标\n\n Envoy 指标概述\n\nEnvoy 的主要目标之一是使网络易于理解。 Envoy 会根据其配置方式产生大量统计信息。一般来说，统计数据(指标)分为三类：\n\nDownstream：Downstream 指标与外来的连接/请求有关。它们由 listener、HTTP connection manager(HCM)、TCP proxy filter 等产生。\nUpstream：Upstream 指标与外向的连接/请求有关。它们由 connection pool、router filter、tcp proxy filter等产生。\nServer：Server 指标信息描述 Envoy 服务器实例的运作情况。服务器正常运行时间或分配的内存量等统计信息。\n\n在最简单场景下，单个 Envoy Proxy 通常涉及 Downstream 和 Upstream 统计数据。这两种指标反映了取该 网络节点 的运行情况。来自整个网格的统计数据提供了每个 网络节点 和整体网络健康状况的非常详细的汇总信息。Envoy 的文档对这些指标有一些简单的说明。\n!--more--\n<!-- 从 Envoy v2 API 开始，Envoy 能够支持自定义、可插拔的 指标适配插件(Stats Sink)。 这是 Envoy 自带的 Stats Sink 列表：\n\nenvoy.statsinks.dogstatsd\nenvoy.statsinks.graphitestatsd\nenvoy.stat_sinks.hystrix\nenvoy.statsinks.metricsservice\nenvoy.stat_sinks.statsd\nenvoy.stat_sinks.wasm --\n\n!--more--\nTag\n\nEnvoy 的指标还有两个子概念，支持在指标中使用： 标签(tags)/维度(dimensions) 。这里的 tags 对等于 Prometheus 指标的 label。意义上，可以理解为：分类维度。\n\nEnvoy 的 指标 由规范的字符串来标识。这些字符串的动态部分（子字符串）被提取成为 标签(tag)。可以通过指定 tag 提取规则(Tag Specifier configuration.) 来定制 tag 。\n\n举个例子：\n 1. 原始的 Envoy 指标 ###\n\n$ kubectl exec fortio-server -c istio-proxy -- curl 'localhost:15000/stats'\n\n返回：\ncluster.outbound|8080||fortio-server-l2.mark.svc.cluster.local.external.upstreamrq2xx: 300\n\n 其中：\n- outbound|8080||fortio-server-l2.mark.svc.cluster.local 部分是 upstream cluster 的名字。可以正则提取作为 tag。\n - 2xx 部分是 HTTP Status Code 的分类。可以正则提取作为 tag。 下文将有这个提取规则的配置说明。\n\n2. 给 Prometheus 的指标 \n$ kubectl exec fortio-server -c istio-proxy -- curl 'localhost:15000/stats?format=prometheus' | grep 'outbound|8080||fortio-server-l2' | grep 'external.upstream_rq'\n\n返回：\nenvoyclusterexternalupstreamrq{responsecodeclass=\"2xx\",cluster_name=\"outbound|8080||fortio-server-l2.mark.svc.cluster.local\"} 300\n\n 指标数据类型\n\nEnvoy 发出三种类型的值作为统计信息：\n\n计数器(Counters)：无符号整数，只会增加而不会减少。例如，总请求。\n仪表(Gauges)：增加和减少的无符号整数。例如，当前活动的请求。\n直方图(Histograms)：作为指标流的一部分的无符号整数，然后由收集器聚合以最终产生汇总的百分位值(percentile，即平常说的 P99/P50/Pxx)。例如，Upsteam 响应时间。\n\n在 Envoy 的内部实现中，Counters 和 Gauges 被分批并定期刷新以提高性能。Histograms 在接收时写入。\n\n指标释义\n\n从指标的产出地点来划分，可以分为：\ncluster manager : 面向 upstream  的 L3/L4/L7 层指标\nhttp connection manager(HCM) ： 面向 upstream & downstream 的 L7 层指标\nlisteners : 面向 downstream 的 L3/L4 层指标\nserver(全局)\nwatch dog\n\n下面我只选择了部分关键的性能指标来简单说明。\n\n cluster manager\n\nEnvoy 文档:cluster manager stats\n\n上面文档已经说得比较详细了。我只补充一些在性能调优时需要关注的方面。那么，一般需要关注什么指标？\n\n我们从著名的 Utilization Saturation and Errors (USE) 方法学来分析。\n\n利用率(Utilization):\n upstreamcxtotal (Counter): 连接数\n upstreamrqactive\n\n饱和度(Saturation):\n upstreamrqtime (Histogram): 响应时间\n upstreamcxconnect_ms (Histogram)\n upstreamcxrxbytesbuffered\n upstreamcxtxbytesbuffered\n upstreamrqpending_total\n upstreamrqpending_active (Gauge)\n\n错误(Error):\n upstreamcxconnect_fail (Counter): 连接失败数\n upstreamcxconnect_timeout (Counter): 连接超时数\n upstreamcxoverflow (Counter): 集群连接断路器溢出的总次数\n upstreamcxpool_overflow\n upstreamcxdestroylocalwithactiverq\n upstreamcxdestroyremotewithactiverq\n upstreamrqtimeout\n upstreamrqretry\n upstreamrqrx_reset\n upstreamrqtx_reset\n\n其它：\n upstreamrqtotal (Counter): TPS (吞吐)\n upstreamcxdestroy_local (Counter): Envoy 主动断开的连接计数\n upstreamcxdestroy_remote (Counter): Envoy 被动断开的连接计数\n upstreamcxlength_ms (Histogram)\n\nhttp connection manager(HCM)\n\nEnvoy 文档:http connection manager(HCM) stats\n\n可以认为，这是面向 downstream & 部分 upstream 的 L7 层指标\n\n利用率(Utilization):\n downstreamcxtotal \n downstreamcxactive\n downstreamcxhttp1_active\n downstreamrqtotal\n downstreamrqhttp1_total\n downstreamrqactive\n\n饱和度(Saturation):\n downstreamcxrxbytesbuffered \n downstreamcxtxbytesbuffered\n downstreamflowcontrolpausedreading_total\n downstreamflowcontrolresumedreading_total\n\n错误(Error):\n downstreamcxdestroylocalactive_rq\n downstreamcxdestroyremoteactive_rq\n downstreamrqrx_reset\n downstreamrqtx_reset\n downstreamrqtoo_large\n downstreamrqmaxdurationreached\n downstreamrqtimeout\n downstreamrqoverload_close\n rstoolarge\n\n其它：\n downstreamcxdestroy_remote \n downstreamcxdestroy_local\n downstreamcxlength_ms\n\n listeners\n\nEnvoy 文档:listener stats\n\n可以认为，这是 downstream 的 L3/L4 层的指标。\n\n利用率(Utilization):\n downstreamcxtotal \n downstreamcxactive\n\n饱和度(Saturation):\n downstreamprecx_active\n\n错误(Error):\n downstreamcxtransportsocketconnect_timeout\n downstreamcxoverflow \n nofilterchain_match\n downstreamlistenerfilter_error\n no_certificate\n\n其它：\n downstreamcxlength_ms \n\nserver\n\nEnvoy 基础信息指标\n\nEnvoy 文档:server stats\n\n利用率(Utilization):\n concurrency \n\n错误(Error):\n daysuntilfirstcertexpiring\n\n watch dog\n\nEnvoy 文档: Watchdog\n\nEnvoy 还包括一个可配置的看门狗系统，它可以在 Envoy 没有响应时增加统计数据并选择性地终止服务器。 系统有两个独立的看门狗配置，一个用于主线程，一个用于工作线程； 因为不同的线程有不同的工作负载。 这些统计数据有助于从高层次上理解 Envoy 的事件循环是否因为它正在做太多工作、阻塞或没有被操作系统调度而没有响应。\n\n饱和度(Saturation):\n watchdogmegamiss(Counter): mega 未命中数\n watchdog_miss(Counter): 未命中数\n\n如果你对 watchdog 机制的兴趣，可以参考：\n https://github.com/envoyproxy/envoy/issues/11391\n https://github.com/envoyproxy/envoy/issues/11388\n\n ### Event loop \n Envoy 文档: Event loop\n\nEnvoy 架构旨在通过在少量线程上运行事件循环来优化可扩展性和资源利用率。 “main” 线程负责控制面处理，每个 “worker” 线程分担数据面的一部分任务。 Envoy 公开了两个统计信息来监控所有这些线程事件循环的性能。\n\n跑一轮循环的耗时：事件循环的每次迭代都会执行一些任务。任务数量会随着负载的变化而变化。但是，如果一个或多个线程具有异常长尾循环执行耗时，则可能存在性能问题。例如，负责可能在工作线程之间分配不均，或者插件中可能存在长时间阻塞操作阻碍了任务进度。\n\n轮询延迟：在事件循环的每次迭代中，事件调度程序都会轮询 I/O 事件，并在某些 I/O 事件就绪 或 发生 超时 时 “唤醒” 线程，以先发生者为准。在 超时 的情况下，我们可以测量轮询后预期唤醒时间与实际唤醒时间的差值；这种差异称为 “轮询延迟”。看到一些小的 轮询延迟 是正常的，通常等于内核调度程序的 “时间片(time slice”)” 或 “量子(quantum)” ——这取决于运行 Envoy 的操作系统 —— 但如果这个数字大大高于其正常观察到的基线，它表示内核调度程序可能发生延迟。\n\n可以通过将 enabledispatcherstats 设置为 true 来启用这些统计信息。\n\nmain 线程的事件调度器有一个以 server.dispatcher. 为根的统计树。 \n每个 worker 线程的事件调度器都有一个以 listenermanager.workerid.dispatcher. 为根的统计树。\n\n每棵树都有以下统计信息：\n\n| Name             | Type      | Description                          |\n| ---------------- | --------- | ------------------------------------ |\n| loopdurationus | Histogram | 以微秒为单位的事件循环持续时间 |\n| polldelayus    | Histogram | 以微秒为单位的轮询延迟       |\n\n请注意，此处不包括任何辅助(非 main 与 worker)线程。\n\nWatch Dog 和 Event loop 都是解决与监控事件处理延迟与时效的工具，这里有很多细节和故事，甚至可以说到 Linux Kernel。希望本书后面有时间，可以和大家一起学习和分析这些有趣的细节。\n\n配置说明\n\n本节参考：\nEnvoy 文档\n\n config.bootstrap.v3.Bootstrap\n\nEnvoy 文档:config.bootstrap.v3.Bootstrap proto\n\n{\n  \"node\": {...},\n  \"static_resources\": {...},\n  \"dynamic_resources\": {...},\n  \"cluster_manager\": {...},\n  \"stats_sinks\": [],\n  \"stats_config\": {...},\n  \"statsflushinterval\": {...},\n  \"statsflushon_admin\": ...,\n...\n}\n\n什么是 stats sink？ 本书不作说明。Istio 默认没定制相关配置。以下只说关注的部分配置。\n\nstats\\_config\n(config.metrics.v3.StatsConfig) 用于内部处理统计信息的配置。\n\nstats\\flush\\interval\n(Duration) 刷新 stats sink 的时间间隔。。出于性能原因，Envoy 不会实时刷新 counter ，仅定期刷新 counter 和 gauge 。 如果未指定，则默认值为 5000 毫秒。 statsflushinterval 或 statsflushon_admin 只能设置之一。 Duration 必须至少为 1 毫秒，最多为 5 分钟。\n\nstats\\flush\\on\\_admin\n(bool) 仅当在 管理界面(admin interface) 上查询时才将统计信息刷新到 sink。 如果设置，则不会创建刷新计时器。 只能设置 statsflushonadmin 或 statsflush_interval 之一。\n\nconfig.metrics.v3.StatsConfig\n\nEnvoy 文档:config-metrics-v3-statsconfig\n\n{\n  \"stats_tags\": [],\n  \"usealldefault_tags\": {...},\n  \"stats_matcher\": {...},\n  \"histogrambucketsettings\": []\n}\n\nstats_tags - 维度提取规则(对应 Prometheus 的 label 提取)\n  (多个 config.metrics.v3.TagSpecifier ) 每个 指标名称字符串 都通过这些标签规则独立处理。 当一个标签匹配时，第一个捕获组不会立即从名称中删除，所以后面的 TagSpecifiers 也可以重复匹配同一部分。在完成所有标签匹配后，再剪裁 指标名称字符串 的匹配部分，并作为 stats sink 的指标名，例如 Prometheus的指标名。\n\nusealldefault_tags\n  (BoolValue) 使用 Envoy 中指定的所有默认标签正则表达式。 这些可以与 stats_tags 中指定的自定义标签结合使用。 它们将在自定义标签之前进行处理。Istio 默认为 false.\n\nstats_matcher\n  (config.metrics.v3.StatsMatcher) 指定 Envoy 要产出哪些指标。支持 包含/排除 规则指定。 如果未提供，则所有指标都将产出。 阻止某些指标集的统计可以提高一点 Envoy 运行性能。\n\n config.metrics.v3.StatsMatcher\n\nEnvoy 文档:config-metrics-v3-statsmatcher\n\n用于禁用/开启统计指标计算与产出的配置。\n\n{\n  \"reject_all\": ...,\n  \"exclusion_list\": {...},\n  \"inclusion_list\": {...}\n}\n\nreject_all\n  (bool) 如果 rejectall 为 true ，则禁用所有统计信息。 如果 rejectall 为 false，则启用所有统计信息。\n\nexclusion_list\n  (type.matcher.v3.ListStringMatcher) 排除列表\n\ninclusion_list\n  (type.matcher.v3.ListStringMatcher) 包含列表\n\n本节参考了： https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/observability/statistics\n\n下一节，将以 Istio 如何使用上面的配置为例，举例说明。\n`",
        "tags": []
    },
    {
        "uri": "/zh/blog/istio/istioctl工具使用指南",
        "content": "---\ntitle: istioctl工具使用指南\ndate: 2023-01-12T10:31:40+08:00\ndraft: false\npassword: \nauthor: kbsonlong\nauthorEmail: kbsonlong@gmail.com\ntags: [istioctl]\ncategories: [istio]\n---\n\n网格预览\n\n ./istioctl ps\nNAME                                                             CLUSTER        CDS          LDS          EDS          RDS          ISTIOD                      VERSION\ntest-1.istio-system                                                             NOT SENT     NOT SENT     NOT SENT     NOT SENT     istiod-66bd9d59d8-k6qzk     65536.65536.65536\ntest-1.istio-system                                                             NOT SENT     NOT SENT     NOT SENT     NOT SENT     istiod-66bd9d59d8-k6qzk     65536.65536.65536\nistio-egressgateway-c5b57c584-rz9rw.istio-system                 Kubernetes     SYNCED       SYNCED       SYNCED       NOT SENT     istiod-66bd9d59d8-k6qzk     1.13.4\nistio-ingressgateway-7767c959b4-jkbgb.istio-system               Kubernetes     SYNCED       SYNCED       SYNCED       NOT SENT     istiod-66bd9d59d8-k6qzk     1.13.4\nmesh-demo-dubbo-consumer-test-rpzzh.pulsar-manager               Kubernetes     SYNCED       SYNCED       SYNCED       SYNCED       istiod-66bd9d59d8-k6qzk     1.14-dev\nmesh-demo-dubbo-pv1111-test-rfmtg.pulsar-manager                 Kubernetes     SYNCED       SYNCED       SYNCED       SYNCED       istiod-66bd9d59d8-k6qzk     1.14-dev\nmesh-demo-dubbo-pv2-test-gjhwb.pulsar-manager                    Kubernetes     SYNCED       SYNCED       SYNCED       SYNCED       istiod-66bd9d59d8-k6qzk     1.14-dev\nmesh-demo-httpv1-test-8b7f5.pulsar-manager                       Kubernetes     SYNCED       SYNCED       SYNCED       SYNCED       istiod-66bd9d59d8-k6qzk     1.14-dev\nmesh-demo-httpv2-test-qlkhb.pulsar-manager\n!--more--\n检查 Envoy 已加载的配置和 Istiod 发送给它的配置有什么异同\n ./istioctl proxy-status components-provider-sfkt-default-test-6gw8b.components-nacos\nClusters Match\nListeners Match\nRoutes Match (RDS last loaded at Thu, 12 Jan 2023 09:50:37 CST)\n\n查看代理(Envoy)配置\n\n 检索特定 pod 中 Envoy 实例的集群配置的信息\n\nistioctl proxy-config cluster pod-name [flags]\n\nistioctl pc c details-v1-7d88846999-lg849 --fqdn istio-egressgateway\nSERVICE FQDN                                                   PORT     SUBSET     DIRECTION     TYPE     DESTINATION RULE\nistio-egressgateway-lazyxds.istio-system.svc.cluster.local     8080     -          outbound      EDS\nistio-egressgateway.istio-system.svc.cluster.local             80       -          outbound      EDS\nistio-egressgateway.istio-system.svc.cluster.local             443      -          outbound      EDS\n\n 检索特定 pod 中 Envoy 实例的 bootstrap 配置的信息\n\n$ istioctl proxy-config bootstrap pod-name [flags]\n\nistioctl pc bootstrap details-v1-7d88846999-lg849\n{\n    \"bootstrap\": {\n        \"node\": {\n            \"id\": \"sidecar~10.244.6.15~details-v1-7d88846999-lg849.default~default.svc.cluster.local\",\n            \"cluster\": \"details.default\",\n            \"metadata\": {\n                    \"ANNOTATIONS\": {\n                                \"cni.projectcalico.org/podIP\": \"10.244.6.15/32\",\n                                \"kubectl.kubernetes.io/default-container\": \"details\",\n                                \"kubectl.kubernetes.io/default-logs-container\": \"details\",\n                                \"kubernetes.io/config.seen\": \"2023-01-04T11:58:05.195509813+08:00\",\n                                \"kubernetes.io/config.source\": \"api\",\n                                \"prometheus.io/path\": \"/stats/prometheus\",\n                                \"prometheus.io/port\": \"15020\",\n                                \"prometheus.io/scrape\": \"true\",\n                                \"sidecar.istio.io/status\": \"{\\\"initContainers\\\":[\\\"istio-init\\\"],\\\"containers\\\":[\\\"istio-proxy\\\"],\\\"volumes\\\":[\\\"workload-socket\\\",\\\"credential-socket\\\",\\\"workload-certs\\\",\\\"istio-envoy\\\",\\\"istio-data\\\",\\\"istio-podinfo\\\",\\\"istio-token\\\",\\\"istiod-ca-cert\\\"],\\\"imagePullSecrets\\\":null,\\\"revision\\\":\\\"default\\\"}\"\n                            },\n                    \"APP_CONTAINERS\": \"details\",\n                    \"CLUSTER_ID\": \"Kubernetes\",\n                    \"ENVOYPROMETHEUSPORT\": 15090,\n                    \"ENVOYSTATUSPORT\": 15021,\n                    \"INSTANCE_IPS\": \"10.244.6.15\",\n                    \"INTERCEPTION_MODE\": \"REDIRECT\",\n!--more--\n\n 检索特定 pod 中 Envoy 实例的监听器配置的信息\n\n$ istioctl proxy-config listener pod-name [flags]\n\nistioctl pc l details-v1-7d88846999-lg849\nADDRESS       PORT  MATCH                                                                                           DESTINATION\n10.96.0.10    53    ALL                                                                                             Cluster: outbound|53||kube-dns.kube-system.svc.cluster.local\n0.0.0.0       80    Trans: raw_buffer; App: http/1.1,h2c                                                            Route: 80\n0.0.0.0       80    ALL                                                                                             PassthroughCluster\n10.96.84.49   80    Trans: raw_buffer; App: http/1.1,h2c                                                            Route: wordpress.default.svc.cluster.local:80\n10.96.84.49   80    ALL                                                                                             Cluster: outbound|80||wordpress.default.svc.cluster.local\n10.96.0.1     443   ALL                                                                                             Cluster: outbound|443||kubernetes.default.svc.cluster.local\n10.96.114.129 443   ALL                                                                                             Cluster: outbound|443||istio-ingressgateway.istio-system.svc.cluster.local\n10.96.129.201 443   ALL                                                                                             Cluster: outbound|443||ingress-controller-ingress-nginx-controller-admission.ingress-nginx.svc.cluster.local\n...\n...\n...\n\n 检索特定 pod 中 Envoy 实例的路由配置的信息\n\n$ istioctl proxy-config route pod-name [flags]\n\nistioctl pc r details-v1-7d88846999-lg849\nNAME                                                          DOMAINS                                                                                          MATCH                  VIRTUAL SERVICE\n80                                                            ingress-controller-ingress-nginx-controller.ingress-nginx, 10.96.150.192                         /*\n80                                                            istio-egressgateway.istio-system, 10.96.133.49                                                   /*\n80                                                            istio-ingressgateway.istio-system, 10.96.114.129                                                 /*\n80                                                            lazyxds-placeholder-service.istio-system, 10.96.16.81                                            /*\n80                                                            tracing.istio-system, 10.96.4.72                                                                 /*\n80                                                            wordpress, wordpress.default + 1 more...                                                         /*\n8080                                                          istio-egressgateway-lazyxds.istio-system, 10.96.231.188                                          /*\n...\n...\n...\n\n 检索特定 pod 中 Envoy 实例的 endpoint 配置的信息\n\n$ istioctl proxy-config endpoints pod-name [flags]\n\n当不方便登录集群节点时，可以通过dump envoy配置，然后通过istioctl来查看\n kubectl  exec details-v1-7d88846999-lg849 -c istio-proxy -- curl 127.0.0.1:15000/config_dump  details-config.json\n\nistioctl pc r -f details-config.json\nNAME                                                          DOMAINS                                                                                          MATCH                  VIRTUAL SERVICE\n80                                                            ingress-controller-ingress-nginx-controller.ingress-nginx, 10.96.150.192                         /*\n80                                                            istio-egressgateway.istio-system, 10.96.133.49                                                   /*\n80                                                            istio-ingressgateway.istio-system, 10.96.114.129                                                 /*\n80                                                            lazyxds-placeholder-service.istio-system, 10.96.16.81                                            /*\n80                                                            tracing.istio-system, 10.96.4.72                                                                 /*\n80                                                            wordpress, wordpress.default + 1 more...                                                         /*\n...\n...\n...\n istioctl pc l -f details-config.json\nADDRESS       PORT  MATCH                                                                                           DESTINATION\n10.96.0.10    53    ALL                                                                                             Cluster: outbound|53||kube-dns.kube-system.svc.cluster.local\n0.0.0.0       80    Trans: raw_buffer; App: http/1.1,h2c                                                            Route: 80\n0.0.0.0       80    ALL                                                                                             PassthroughCluster\n10.96.84.49   80    Trans: raw_buffer; App: http/1.1,h2c                                                            Route: wordpress.default.svc.cluster.local:80\n10.96.84.49   80    ALL                                                                                             Cluster: outbound|80||wordpress.default.svc.cluster.local\n10.96.0.1     443   ALL                                                                                             Cluster: outbound|443||kubernetes.default.svc.cluster.local\n10.96.114.129 443   ALL                                                                                             Cluster: outbound|443||istio-ingressgateway.istio-system.svc.cluster.local\n10.96.129.201 443   ALL                                                                                             Cluster: outbound|443||ingress-controller-ingress-nginx-controller-admission.ingress-nginx.svc.cluster.local\n...\n...\n...\n`",
        "tags": []
    },
    {
        "uri": "/zh/blog/istio/Istio可观测性系列-性能指标",
        "content": "---\ntitle: Istio可观测性系列-性能指标\nslug: 6899d1\ndate: 2022-09-13T10:56:21+08:00\ndraft: false\nauthor: kbsonlong\nauthorEmail: kbsonlong@gmail.com\ntags: [istio,转载]\ncategories: [云原生]\n\n---\nIstio 指标\n\n Istio 自己的 Metrics\n\n标准指标说明\n\n 参考：https://istio.io/latest/docs/reference/config/metrics/\n\n Metrics\n\n对于 HTTP、HTTP/2 和 GRPC 流量，Istio 默认生成以下指标：\n\nRequest Count (istiorequeststotal): This is a COUNTER incremented for every request handled by an Istio proxy.\nRequest Duration (istiorequestduration_milliseconds): This is a DISTRIBUTION which measures the duration of requests.\nRequest Size (istiorequestbytes): This is a DISTRIBUTION which measures HTTP request body sizes.\nResponse Size (istioresponsebytes): This is a DISTRIBUTION which measures HTTP response body sizes.\ngRPC Request Message Count (istiorequestmessages_total): This is a COUNTER incremented for every gRPC message sent from a client.\ngRPC Response Message Count (istioresponsemessages_total): This is a COUNTER incremented for every gRPC message sent from a server.\n\n!--more--\n\n对于 TCP 流量，Istio 生成以下指标：\n\nTcp Bytes Sent (istiotcpsentbytestotal): This is a COUNTER which measures the size of total bytes sent during response in case of a TCP connection.\nTcp Bytes Received (istiotcpreceivedbytestotal): This is a COUNTER which measures the size of total bytes received during request in case of a TCP connection.\nTcp Connections Opened (istiotcpconnectionsopenedtotal): This is a COUNTER incremented for every opened connection.\nTcp Connections Closed (istiotcpconnectionsclosedtotal): This is a COUNTER incremented for every closed connection.\n\nPrometheus 的 Labels\n\nReporter: This identifies the reporter of the request. It is set to destination if report is from a server Istio proxy and source if report is from a client Istio proxy or a gateway.\n\nSource Workload: This identifies the name of source workload which controls the source, or “unknown” if the source information is missing.\n\nSource Workload Namespace: This identifies the namespace of the source workload, or “unknown” if the source information is missing.\n\nSource Principal: This identifies the peer principal of the traffic source. It is set when peer authentication is used.\n\nSource App: This identifies the source application based on app label of the source workload, or “unknown” if the source information is missing.\n\nSource Version: This identifies the version of the source workload, or “unknown” if the source information is missing.\n\nDestination Workload: This identifies the name of destination workload, or “unknown” if the destination information is missing.\n\nDestination Workload Namespace: This identifies the namespace of the destination workload, or “unknown” if the destination information is missing.\n\nDestination Principal: This identifies the peer principal of the traffic destination. It is set when peer authentication is used.\n\nDestination App: This identifies the destination application based on app label of the destination workload, or “unknown” if the destination information is missing.\n\nDestination Version: This identifies the version of the destination workload, or “unknown” if the destination information is missing.\n\nDestination Service: This identifies destination service host responsible for an incoming request. Ex: details.default.svc.cluster.local.\n\nDestination Service Name: This identifies the destination service name. Ex: “details”.\n\nDestination Service Namespace: This identifies the namespace of destination service.\n\nRequest Protocol: This identifies the protocol of the request. It is set to request or connection protocol.\n\nResponse Code: This identifies the response code of the request. This label is present only on HTTP metrics.\n\nConnection Security Policy: This identifies the service authentication policy of the request. It is set to mutual_tls when Istio is used to make communication secure and report is from destination. It is set to unknown when report is from source since security policy cannot be properly populated.\n\nResponse Flags: Additional details about the response or connection from proxy. In case of Envoy, see %RESPONSE_FLAGS% in Envoy Access Log for more detail.\n\nCanonical Service: A workload belongs to exactly one canonical service, whereas it can belong to multiple services. A canonical service has a name and a revision so it results in the following labels.\n\n    sourcecanonicalservice\n  sourcecanonicalrevision\n  destinationcanonicalservice\n  destinationcanonicalrevision\n  \n  \n\nDestination Cluster: This identifies the cluster of the destination workload. This is set by: global.multiCluster.clusterName at cluster install time.\n\nSource Cluster: This identifies the cluster of the source workload. This is set by: global.multiCluster.clusterName at cluster install time.\n\ngRPC Response Status: This identifies the response status of the gRPC. This label is present only on gRPC metrics.\n\n 使用\n\nistio-proxy 与应用的 Metrics 整合输出\n\n 参考：https://istio.io/v1.14/docs/ops/integrations/prometheus/option-1-metrics-merging\n\nIstio 能够完全通过 prometheus.io  annotations 来控制抓取。虽然 prometheus.io  annotations 不是 Prometheus 的核心部分，但它们已成为配置抓取的事实标准。\n\n此选项默认启用，但可以通过在 安装 期间传递 --set meshConfig.enablePrometheusMerge=false 来禁用。启用后，将向所有数据平面 pod 添加适当的 prometheus.io  annotations 以设置抓取。如果这些注释已经存在，它们将被覆盖。使用此选项，Envoy sidecar 会将 Istio 的指标与应用程序指标合并。合并后的指标将从 /stats/prometheus:15020 中抓取。\n\n此选项以明文形式公开所有指标。\n\n定制：为 Metrics 增加维度\n\n 参考： https://istio.io/latest/docs/tasks/observability/metrics/customize-metrics/custom-statistics-configuration\n\n如，增加端口、与 HTTP HOST 头 维度。\n\napiVersion: install.istio.io/v1alpha1\nkind: IstioOperator\nspec:\n  values:\n    telemetry:\n      v2:\n        prometheus:\n          configOverride:\n            inboundSidecar:\n              metrics:\n                name: requests_total\n                  dimensions:\n                    destination_port: string(destination.port)\n                    request_host: request.host\n            outboundSidecar:\n              metrics:\n                name: requests_total\n                  dimensions:\n                    destination_port: string(destination.port)\n                    request_host: request.host\n            gateway:\n              metrics:\n                name: requests_total\n                  dimensions:\n                    destination_port: string(destination.port)\n                    request_host: request.host\n\n使用以下命令将以下 annotation 应用到所有注入的 pod，其中包含要提取到 Prometheus 时间序列 的维度列表：\n\n仅当您的维度不在 [DefaultStatTags 列表] 中时才需要此步骤（https://github.com/istio/istio/blob/release-1.14/pkg/bootstrap/config.go）\n\napiVersion: apps/v1\nkind: Deployment\nspec:\n  template: # pod template\n    metadata:\n      annotations:\n        sidecar.istio.io/extraStatTags: destinationport,requesthost\n\n要在网格范围内启用额外 Tag ，您可以将 extraStatTags 添加到网格配置中：\n\nmeshConfig:\n  defaultConfig:\n    extraStatTags:\n     destination_port\n     request_host\n\n 参考 : https://istio.io/latest/docs/reference/config/proxy_extensions/stats/#MetricConfig\n\n定制：加入 request / response 元信息维度\n\n可以把 request 或 repsonse 里一些基础信息 加入到 指标的维度。如，URL Path，这在需要为相同服务分隔统计不同 REST API 的指标时，相当有用。\n\n 参考 : https://istio.io/latest/docs/tasks/observability/metrics/classify-metrics/\n\n 工作原理\n\nistio stat filter 使用\n\nIstio 在自己的定制版本 Envoy 中，加入了 stats-filter 插件，用于计算 Istio 自己想要的指标：\n\n$ k -n istio-system get envoyfilters.networking.istio.io stats-filter-1.14 -o yaml\napiVersion: networking.istio.io/v1alpha3\nkind: EnvoyFilter\nmetadata:\n  annotations:\n  labels:\n    install.operator.istio.io/owning-resource-namespace: istio-system\n    istio.io/rev: default\n    operator.istio.io/component: Pilot\n    operator.istio.io/version: 1.14.3\n  name: stats-filter-1.14\n  namespace: istio-system\nspec:\n  configPatches:\n  applyTo: HTTP_FILTER\n    match:\n      context: SIDECAR_OUTBOUND\n      listener:\n        filterChain:\n          filter:\n            name: envoy.filters.network.httpconnectionmanager\n            subFilter:\n              name: envoy.filters.http.router\n      proxy:\n        proxyVersion: ^1\\.14.*\n    patch:\n      operation: INSERT_BEFORE\n      value:\n        name: istio.stats\n        typed_config:\n          '@type': type.googleapis.com/udpa.type.v1.TypedStruct\n          type_url: type.googleapis.com/envoy.extensions.filters.http.wasm.v3.Wasm\n          value:\n            config:\n              configuration:\n                '@type': type.googleapis.com/google.protobuf.StringValue\n                value: |\n                  {\n                    \"debug\": \"false\",\n                    \"stat_prefix\": \"istio\"\n                  }\n              rootid: statsoutbound\n              vm_config:\n                code:\n                  local:\n                    inline_string: envoy.wasm.stats\n                runtime: envoy.wasm.runtime.null\n                vmid: statsoutbound\n  applyTo: HTTP_FILTER\n    match:\n      context: SIDECAR_INBOUND\n      listener:\n        filterChain:\n          filter:\n            name: envoy.filters.network.httpconnectionmanager\n            subFilter:\n              name: envoy.filters.http.router\n      proxy:\n        proxyVersion: ^1\\.14.*\n    patch:\n      operation: INSERT_BEFORE\n      value:\n        name: istio.stats\n        typed_config:\n          '@type': type.googleapis.com/udpa.type.v1.TypedStruct\n          type_url: type.googleapis.com/envoy.extensions.filters.http.wasm.v3.Wasm\n          value:\n            config:\n              configuration:\n                '@type': type.googleapis.com/google.protobuf.StringValue\n                value: |\n                  {\n                    \"debug\": \"false\",\n                    \"stat_prefix\": \"istio\",\n                    \"disablehostheader_fallback\": true,\n                    \"metrics\": [\n                      {\n                        \"dimensions\": {\n                          \"destinationcluster\": \"node.metadata['CLUSTERID']\",\n                          \"sourcecluster\": \"downstreampeer.cluster_id\"\n                        }\n                      }\n                    ]\n                  }\n              rootid: statsinbound\n              vm_config:\n                code:\n                  local:\n                    inline_string: envoy.wasm.stats\n                runtime: envoy.wasm.runtime.null\n                vmid: statsinbound\n  applyTo: HTTP_FILTER\n    match:\n      context: GATEWAY\n      listener:\n        filterChain:\n          filter:\n            name: envoy.filters.network.httpconnectionmanager\n            subFilter:\n              name: envoy.filters.http.router\n      proxy:\n        proxyVersion: ^1\\.14.*\n    patch:\n      operation: INSERT_BEFORE\n      value:\n        name: istio.stats\n        typed_config:\n          '@type': type.googleapis.com/udpa.type.v1.TypedStruct\n          type_url: type.googleapis.com/envoy.extensions.filters.http.wasm.v3.Wasm\n          value:\n            config:\n              configuration:\n                '@type': type.googleapis.com/google.protobuf.StringValue\n                value: |\n                  {\n                    \"debug\": \"false\",\n                    \"stat_prefix\": \"istio\",\n                    \"disablehostheader_fallback\": true\n                  }\n              rootid: statsoutbound\n              vm_config:\n                code:\n                  local:\n                    inline_string: envoy.wasm.stats\n                runtime: envoy.wasm.runtime.null\n                vmid: statsoutbound\n  priority: -1\n\n istio stat Plugin 实现\n\nhttps://github.com/istio/proxy/blob/release-1.14/extensions/stats/plugin.cc\n\n内置的 Metric:\n\nconst std::vectorMetricFactory& PluginRootContext::defaultMetrics() {\n  static const std::vectorMetricFactory default_metrics = {\n      // HTTP, HTTP/2, and GRPC metrics\n      MetricFactory{\"requests_total\", MetricType::Counter,\n                     - uint64_t { return 1; },\n                    staticcastuint32t(Protocol::HTTP) |\n                        staticcastuint32t(Protocol::GRPC),\n                    countstandardlabels, /* recurrent */ false},\n      MetricFactory{\"requestdurationmilliseconds\", MetricType::Histogram,\n                     - uint64_t {\n                      return request_info.duration /* in nanoseconds */ /\n                             1000000;\n                    },\n                    staticcastuint32t(Protocol::HTTP) |\n                        staticcastuint32t(Protocol::GRPC),\n                    countstandardlabels, /* recurrent */ false},\n      MetricFactory{\"request_bytes\", MetricType::Histogram,\n                     - uint64_t {\n                      return requestinfo.requestsize;\n                    },\n                    staticcastuint32t(Protocol::HTTP) |\n                        staticcastuint32t(Protocol::GRPC),\n                    countstandardlabels, /* recurrent */ false},\n      MetricFactory{\"response_bytes\", MetricType::Histogram,\n                     - uint64_t {\n                      return requestinfo.responsesize;\n                    },\n                    staticcastuint32t(Protocol::HTTP) |\n                        staticcastuint32t(Protocol::GRPC),\n                    countstandardlabels, /* recurrent */ false},\n...\n\nhttps://github.com/istio/proxy/blob/release-1.14/extensions/stats/plugin.cc#L591\n\nvoid PluginRootContext::report(::Wasm::Common::RequestInfo& request_info,\n                               bool end_stream) {\n\n...\n  map(istiodimensions, outbound, peernodeinfo.get(), requestinfo);\n\n  for (sizet i = 0; i < expressions.size(); i++) {\n    if (!evaluateExpression(expressions_[i].token,\n                            &istiodimensions.at(countstandardlabels + i))) {\n      LOG_TRACE(absl::StrCat(\"Failed to evaluate expression: <\",\n                             expressions_[i].expression, \"\"));\n      istiodimensions[countstandardlabels + i] = \"unknown\";\n    }\n  }\n\n  auto statsit = metrics.find(istiodimensions);\n  if (statsit != metrics.end()) {\n    for (auto& stat : stats_it-second) {\n      if (endstream || stat.recurrent) {\n        stat.record(request_info);\n      }\n      LOG_DEBUG(\n          absl::StrCat(\"metricKey cache hit \", \", stat=\", stat.metricid));\n    }\n    cachehitsaccumulator_++;\n    if (cachehitsaccumulator_ == 100) {\n      incrementMetric(cachehits, cachehitsaccumulator_);\n      cachehitsaccumulator_ = 0;\n    }\n    return;\n  }\n...\n}                                  \n\n 关于 Istio 的指标原理，这是一个很好的参考文章：https://blog.christianposta.com/understanding-istio-telemetry-v2/\n\nEnvoy 内置的 Metrics\n\nIstio 默认用 istio-agent 去整合 Envoy 的 metrics。\n而 Istio 默认打开的 Envoy 内置 Metrics 很少：\n\n 见：https://istio.io/latest/docs/ops/configuration/telemetry/envoy-stats/\n\ncluster_manager\nlistener_manager\nserver\ncluster.xds-grpc\n\n 定制 Envoy 内置的 Metrics\n\n 参考：https://istio.io/latest/docs/ops/configuration/telemetry/envoy-stats/\n\n如果要配置 Istio Proxy 以记录 其它 Envoy 原生的指标，您可以将 ProxyConfig.ProxyStatsMatcher 添加到网格配置中。 例如，要全局启用断路器、重试和上游连接的统计信息，您可以指定 stats matcher，如下所示：\n\n代理需要重新启动以获取统计匹配器配置。\n\napiVersion: install.istio.io/v1alpha1\nkind: IstioOperator\nspec:\n  meshConfig:\n    defaultConfig:\n      proxyStatsMatcher:\n        inclusionRegexps:\n          \".circuit_breakers.\"\n        inclusionPrefixes:\n          \"upstreamrqretry\"\n          \"upstream_cx\"\n\n您还可以使用 proxy.istio.io/config annotation 为个别代码指定配置。 例如，要配置与上面相同的统计信息，您可以将 annotation 添加到 gateway proxy 或 workload，如下所示：\n\nmetadata:\n  annotations:\n    proxy.istio.io/config: |-\n      proxyStatsMatcher:\n        inclusionRegexps:\n        \".circuit_breakers.\"\n        inclusionPrefixes:\n        \"upstreamrqretry\"\n        \"upstream_cx\"\n\n原理\n\n下面，看看 Istio 默认配置下，如何配置 Envoy。\n\nistioctl proxy-config bootstrap fortio-server | yq eval -P   envoy-config-bootstrap-default.yaml\n输出：\n\nbootstrap:\n...\n  statsConfig:\n    statsTags:  从指标名中抓取 Tag(prometheus label)\n      tagName: cluster_name\n        regex: ^cluster\\.((.+?(\\..+?\\.svc\\.cluster\\.local)?)\\.)\n      tagName: tcp_prefix\n        regex: ^tcp\\.((.*?)\\.)\\w+?$\n      tagName: response_code\n        regex: (responsecode=\\.=(.+?);\\.;)|rq(_(\\.d{3}))$\n      tagName: responsecodeclass\n        regex: rq((\\dxx))$\n      tagName: httpconnmanagerlistenerprefix\n        regex: ^listener(?=\\.).?\\.http\\.(((?:[_.[:digit:]]|[_\\[\\]aAbBcCdDeEfF[:digit:]]*))\\.)\n...\n    useAllDefaultTags: false\n    statsMatcher:\n      inclusionList:\n        patterns: # 选择要记录的指标\n          prefix: reporter=\n          prefix: cluster_manager\n          prefix: listener_manager\n          prefix: server\n          prefix: cluster.xds-grpc ## 只记录 xDS cluster. 即不记录用户自己服务的 cluster !!!\n          prefix: wasm\n          suffix: rbac.allowed\n          suffix: rbac.denied\n          suffix: shadow_allowed\n          suffix: shadow_denied\n          prefix: component\n\n这时，如果修改 pod 的定义为：\n\n    annotations:\n      proxy.istio.io/config: |-\n        proxyStatsMatcher:\n          inclusionRegexps:\n          \"cluster\\\\..fortio.\" #proxy upstream(outbound)\n          \"cluster\\\\..inbound.\" #proxy upstream(inbound，这里一般就是指到同一 pod 中运行的应用了)\n          \"http\\\\..*\"\n          \"listener\\\\..*\"\n\n产生新的 Envoy 配置：\n\n \"stats_matcher\": {\n   \"inclusion_list\": {\n     \"patterns\": [\n       {\n         \"prefix\": \"reporter=\"\n       },\n       {\n         \"prefix\": \"cluster_manager\"\n       },\n       {\n         \"prefix\": \"listener_manager\"\n       },\n       {\n         \"prefix\": \"server\"\n       },\n       {\n         \"prefix\": \"cluster.xds-grpc\"\n       },\n \n\n       {\n         \"safe_regex\": {\n           \"google_re2\": {},\n           \"regex\": \"cluster\\\\..fortio.\"\n         }\n       },\n       {\n         \"safe_regex\": {\n           \"google_re2\": {},\n           \"regex\": \"cluster\\\\..inbound.\"\n         }\n       },\n       {\n         \"safe_regex\": {\n           \"google_re2\": {},\n           \"regex\": \"http\\\\..*\"\n         }\n       },\n       {\n         \"safe_regex\": {\n           \"google_re2\": {},\n           \"regex\": \"listener\\\\..*\"\n         }\n       },\n\n总结：Istio-Proxy 指标地图\n\n要做好监控，首先要深入了解指标原理。而要了解指标原理，当然要知道指标是产生流程中的什么位置，什么组件。看完上面关于 Envoy 与 Istio 的指标说明后。可以大概得到以下结论：\n\n本节的实验环境说明见于： {ref}appendix-lab-env/appendix-lab-env-base:简单分层实验环境\n本文出自https://istio-insider.readthedocs.io/",
        "tags": []
    },
    {
        "uri": "/zh/blog/istio/Istio可观测性系列-监控指标没有上报",
        "content": "---\ntitle: Istio可观测性系列-监控指标没有上报\ndate: 2023-01-12T13:42:38+08:00\ndraft: false\npassword: \nauthor: kbsonlong\nauthorEmail: kbsonlong@gmail.com\ntags: [istio,metrics]\ncategories: [istio]\n---\n\n背景\n\nistio 版本: 1.13.4\n\naeraki 版本: 1.1.5\n\n业务反馈在测试过程中发现 istiorequesttotal 指标查找不到,通过Prometheus查看发现这个指标部分服务是正常采集上报。\n\n 通过 istioctl ps 预览集群状态\n\n./istioctl ps\nNAME                                                             CLUSTER        CDS          LDS          EDS          RDS          ISTIOD                      VERSION\ntest-1.istio-system                                                             NOT SENT     NOT SENT     NOT SENT     NOT SENT     istiod-66bd9d59d8-k6qzk     65536.65536.65536\ntest-1.istio-system                                                             NOT SENT     NOT SENT     NOT SENT     NOT SENT     istiod-66bd9d59d8-k6qzk     65536.65536.65536\ncomponents-comsumer-sfkt-default-test-rfgds.components-nacos     Kubernetes     SYNCED       SYNCED       SYNCED       SYNCED       istiod-66bd9d59d8-k6qzk     1.14-dev\ncomponents-provider-sfkt-default-test-6gw8b.components-nacos     Kubernetes     SYNCED       SYNCED       SYNCED       SYNCED       istiod-66bd9d59d8-k6qzk     1.14-dev\ncomponents-server-sfkt-default-test-frjwm.components-nacos       Kubernetes     SYNCED       SYNCED       SYNCED       SYNCED       istiod-66bd9d59d8-k6qzk     1.14-dev\nistio-egressgateway-c5b57c584-rz9rw.istio-system                 Kubernetes     SYNCED       SYNCED       SYNCED       NOT SENT     istiod-66bd9d59d8-k6qzk     1.13.4\nistio-ingressgateway-7767c959b4-jkbgb.istio-system               Kubernetes     SYNCED       SYNCED       SYNCED       NOT SENT     istiod-66bd9d59d8-k6qzk     1.13.4\nmesh-demo-dubbo-consumer-test-rpzzh.pulsar-manager               Kubernetes     SYNCED       SYNCED       SYNCED       SYNCED       istiod-66bd9d59d8-k6qzk     1.14-dev\nmesh-demo-dubbo-pv1111-test-rfmtg.pulsar-manager                 Kubernetes     SYNCED       SYNCED       SYNCED       SYNCED       istiod-66bd9d59d8-k6qzk     1.14-dev\nmesh-demo-dubbo-pv2-test-gjhwb.pulsar-manager                    Kubernetes     SYNCED       SYNCED       SYNCED       SYNCED       istiod-66bd9d59d8-k6qzk     1.14-dev\nmesh-demo-httpv1-test-8b7f5.pulsar-manager                       Kubernetes     SYNCED       SYNCED       SYNCED       SYNCED       istiod-66bd9d59d8-k6qzk     1.14-dev\nmesh-demo-httpv2-test-qlkhb.pulsar-manager                       Kubernetes     SYNCED       SYNCED       SYNCED       SYNCED       istiod-66bd9d59d8-k6qzk     1.14-dev\nsl-job-agentd-sl-job-agentd-test-fskpl-lg8hq.sl-devops           Kubernetes     SYNCED       SYNCED       SYNCED       SYNCED       istiod-66bd9d59d8-k6qzk     1.12-dev\nsl-job-agentd-sl-job-server-test-fskpl-z5b4t.sl-devops           Kubernetes     SYNCED       SYNCED       SYNCED       SYNCED       istiod-66bd9d59d8-k6qzk     1.12-dev\nsl-job-web-api-sl-job-web-api-dev-2pm6n.sl-devops                Kubernetes     SYNCED       SYNCED       SYNCED       SYNCED       istiod-66bd9d59d8-k6qzk     1.12-dev\n!--more--\n可以看到整个istio 集群下存在多个版本，其中 1.13.4 是属于istio正常安装版本，发现 1.12-dev pod能够正常上报 istiorequesttotal 指标,而 1.14-dev 没有正常上报。那么 1.12-dev 和 1.14-dev 是怎么来的呢？查看这些pod的使用的 istio-proxy 的镜像是 aeraki 项目下的 meta-protocol-proxy 代理镜像，并且使用的版本不一致，将无法正常上报指标的 istio-proxy 镜像修改后可以正常查看指标。\n\n kubectl get pod -n ns sl-starter-mesh-demo-sfkt-deve-default-deve-8hlgb -o yaml|more\napiVersion: v1\nkind: Pod\nmetadata:\n  annotations:\n    kubectl.kubernetes.io/default-container: sl-starter-mesh-demo-hades\n    kubectl.kubernetes.io/default-logs-container: sl-starter-mesh-demo-hades\n    lifecycle.apps.kruise.io/timestamp: \"2023-01-03T07:45:40Z\"\n    lxcfs-admission-webhook.aliyun.com/status: mutated\n    prometheus.io/path: /stats/prometheus\n    prometheus.io/port: \"15020\"\n    prometheus.io/scrape: \"true\"\n    sidecar.istio.io/bootstrapOverride: aeraki-bootstrap-config\n    sidecar.istio.io/inject: \"true\"\n    sidecar.istio.io/proxyImage: aeraki/meta-protocol-proxy-debug:1.1.2\n...\n...\n\nkubectl get pod -n ns components-comsumer-sfkt-default-test-rfgds -o yaml|more\napiVersion: v1\nkind: Pod\nmetadata:\n  annotations:\n    kubectl.kubernetes.io/default-container: components-comsumer\n    kubectl.kubernetes.io/default-logs-container: components-comsumer\n    lifecycle.apps.kruise.io/timestamp: \"2023-01-12T05:32:51Z\"\n    lxcfs-admission-webhook.aliyun.com/status: mutated\n    prometheus.io/path: /stats/prometheus\n    prometheus.io/port: \"15020\"\n    prometheus.io/scrape: \"true\"\n    sidecar.istio.io/bootstrapOverride: aeraki-bootstrap-config\n    sidecar.istio.io/inject: \"true\"\n    sidecar.istio.io/proxyImage: aeraki/meta-protocol-proxy-debug:1.1.5\n...\n...\n\n 根本原因\n通过Istio官方文档发现istio默认指标也是由 EnvoyFilter 控制采集，集群内安装的是1.13.4,默认配置了1.11、1.12和1.13版本的，但是没有1.14版本的，而 aeraki/meta-protocol-proxy-debug:1.1.5 是基于 istio 1.14版本开发的，由于没有集群内没有配置1.14版本的 EnvoyFilter,所以最终导致1.12版本的proxy可以正常上报指标，1.14版本的proxy没有正常上报指标\n\nkubectl get envoyfilter -n istio-system\nNAME                    AGE\nstats-filter-1.11       69d\nstats-filter-1.12       69d\nstats-filter-1.13       69d\ntcp-stats-filter-1.11   69d\ntcp-stats-filter-1.12   69d\ntcp-stats-filter-1.13   69d\n\n kubectl get envoyfilter -n istio-system\nNAME                    AGE\nstats-filter-1.11       69d\nstats-filter-1.12       69d\nstats-filter-1.13       69d\nstats-filter-1.14       2m15s\ntcp-stats-filter-1.11   69d\ntcp-stats-filter-1.12   69d\ntcp-stats-filter-1.13   69d\ntcp-stats-filter-1.14   2m8s\n\n添加1.14版本相关的 EnvoyFilter 之后指标可以正常上报\n\ncurl 10.98.211.214:15020/stats/prometheus|grep istio_request|more\n  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current\n                                 Dload  Upload   Total   Spent    Left  Speed\n100 13666    0 13666    0     0  23879      0 --:--:-- --:--:-- --:--:-- 23849 TYPE istiorequeststotal counter\nistiorequeststotal{responsecode=\"200\",reporter=\"destination\",sourceworkload=\"components-server-sfkt-default-test\",sourceworkloadnamespace=\"components-nacos\",source_pr\nincipal=\"spiffe://kubeyy.com/ns/components-nacos/sa/default\",sourceapp=\"components-server-sfkt-default-test\",sourceversion=\"unknown\",source_cluster=\"Kubernetes\",destinati\nonworkload=\"components-comsumer-sfkt-default-test\",destinationworkloadnamespace=\"components-nacos\",destinationprincipal=\"spiffe://kubeyy.com/ns/components-nacos/sa/defa\nult\",destinationapp=\"components-comsumer-sfkt-default-test\",destinationversion=\"unknown\",destination_service=\"components-comsumer-test-ps.components-nacos.svc.kubeyy.com\"\n,destinationservicename=\"components-comsumer-test-ps\",destinationservicenamespace=\"components-nacos\",destinationcluster=\"Kubernetes\",requestprotocol=\"http\",response_f\nlags=\"-\",grpcresponsestatus=\"\",connectionsecuritypolicy=\"mutualtls\",sourcecanonicalservice=\"components-server-sfkt-default-test\",destinationcanonical_service=\"compo\nnents-comsumer-sfkt-default-test\",sourcecanonicalrevision=\"latest\",destinationcanonicalrevision=\"latest\"} 699\nistiorequeststotal{responsecode=\"200\",reporter=\"destination\",sourceworkload=\"unknown\",sourceworkloadnamespace=\"unknown\",sourceprincipal=\"unknown\",sourceapp=\"unknown\n\",sourceversion=\"unknown\",sourcecluster=\"unknown\",destinationworkload=\"components-comsumer-sfkt-default-test\",destinationworkload_namespace=\"components-nacos\",destinati\nonprincipal=\"unknown\",destinationapp=\"components-comsumer-sfkt-default-test\",destinationversion=\"unknown\",destinationservice=\"svc-metrics-components-nacos-test.componen\nts-nacos.svc.kubeyy.com\",destinationservicename=\"svc-metrics-components-nacos-test\",destinationservicenamespace=\"components-nacos\",destination_cluster=\"Kubernetes\",requ\nestprotocol=\"http\",responseflags=\"-\",grpcresponsestatus=\"\",connectionsecuritypolicy=\"none\",sourcecanonicalservice=\"unknown\",destinationcanonicalservice=\"component\ns-comsumer-sfkt-default-test\",sourcecanonicalrevision=\"latest\",destinationcanonicalrevision=\"latest\"} 2\n\n",
        "tags": []
    },
    {
        "uri": "/zh/blog/istio/Istio可观测性系列-自定义指标",
        "content": "---\ntitle: Istio可观测性系列-自定义指标\ndate: 2023-01-12T13:26:23+08:00\ndraft: false\npassword: \nauthor: kbsonlong\nauthorEmail: kbsonlong@gmail.com\ntags: [istio,metrics]\ncategories: [istio]\n---\n\n默认情况下，Istio 定义并生成一组标准指标\n\nistio 默认指标\n\n stats-filter-istio_version\n\ncat << EOF | kubectl apply -f - \napiVersion: networking.istio.io/v1alpha3\nkind: EnvoyFilter\nmetadata:\n  labels:\n    istio.io/rev: default\n  name: stats-filter-1.14\n  namespace: istio-system\nspec:\n  configPatches:\n  applyTo: HTTP_FILTER\n    match:\n      context: SIDECAR_OUTBOUND\n      listener:\n        filterChain:\n          filter:\n            name: envoy.filters.network.httpconnectionmanager\n            subFilter:\n              name: envoy.filters.http.router\n      proxy:\n        proxyVersion: ^1\\.14.*\n    patch:\n      operation: INSERT_BEFORE\n      value:\n        name: istio.stats\n        typed_config:\n          '@type': type.googleapis.com/udpa.type.v1.TypedStruct\n          type_url: type.googleapis.com/envoy.extensions.filters.http.wasm.v3.Wasm\n          value:\n            config:\n              configuration:\n                '@type': type.googleapis.com/google.protobuf.StringValue\n                value: |\n                  {\n                    \"debug\": \"false\",\n                    \"stat_prefix\": \"istio\"\n                  }\n              rootid: statsoutbound\n              vm_config:\n                code:\n                  local:\n                    inline_string: envoy.wasm.stats\n                runtime: envoy.wasm.runtime.null\n                vmid: statsoutbound\n  applyTo: HTTP_FILTER\n    match:\n      context: SIDECAR_INBOUND\n      listener:\n        filterChain:\n          filter:\n            name: envoy.filters.network.httpconnectionmanager\n            subFilter:\n              name: envoy.filters.http.router\n      proxy:\n        proxyVersion: ^1\\.14.*\n    patch:\n      operation: INSERT_BEFORE\n      value:\n        name: istio.stats\n        typed_config:\n          '@type': type.googleapis.com/udpa.type.v1.TypedStruct\n          type_url: type.googleapis.com/envoy.extensions.filters.http.wasm.v3.Wasm\n          value:\n            config:\n              configuration:\n                '@type': type.googleapis.com/google.protobuf.StringValue\n                value: |\n                  {\n                    \"debug\": \"false\",\n                    \"stat_prefix\": \"istio\",\n                    \"disablehostheader_fallback\": true,\n                    \"metrics\": [\n                      {\n                        \"dimensions\": {\n                          \"destinationcluster\": \"node.metadata['CLUSTERID']\",\n                          \"sourcecluster\": \"downstreampeer.cluster_id\"\n                        }\n                      }\n                    ]\n                  }\n              rootid: statsinbound\n              vm_config:\n                code:\n                  local:\n                    inline_string: envoy.wasm.stats\n                runtime: envoy.wasm.runtime.null\n                vmid: statsinbound\n  applyTo: HTTP_FILTER\n    match:\n      context: GATEWAY\n      listener:\n        filterChain:\n          filter:\n            name: envoy.filters.network.httpconnectionmanager\n            subFilter:\n              name: envoy.filters.http.router\n      proxy:\n        proxyVersion: ^1\\.14.*\n    patch:\n      operation: INSERT_BEFORE\n      value:\n        name: istio.stats\n        typed_config:\n          '@type': type.googleapis.com/udpa.type.v1.TypedStruct\n          type_url: type.googleapis.com/envoy.extensions.filters.http.wasm.v3.Wasm\n          value:\n            config:\n              configuration:\n                '@type': type.googleapis.com/google.protobuf.StringValue\n                value: |\n                  {\n                    \"debug\": \"false\",\n                    \"stat_prefix\": \"istio\",\n                    \"disablehostheader_fallback\": true\n                  }\n              rootid: statsoutbound\n              vm_config:\n                code:\n                  local:\n                    inline_string: envoy.wasm.stats\n                runtime: envoy.wasm.runtime.null\n                vmid: statsoutbound\n  priority: -1\n\nEOF\n\ntcp-stats-filter-istio_version\ncat << EOF | kubectl apply -f - \napiVersion: networking.istio.io/v1alpha3\nkind: EnvoyFilter\nmetadata:\n  labels:\n    istio.io/rev: default\n  name: tcp-stats-filter-1.14\n  namespace: istio-system\nspec:\n  configPatches:\n  applyTo: NETWORK_FILTER\n    match:\n      context: SIDECAR_INBOUND\n      listener:\n        filterChain:\n          filter:\n            name: envoy.filters.network.tcp_proxy\n      proxy:\n        proxyVersion: ^1\\.14.*\n    patch:\n      operation: INSERT_BEFORE\n      value:\n        name: istio.stats\n        typed_config:\n          '@type': type.googleapis.com/udpa.type.v1.TypedStruct\n          type_url: type.googleapis.com/envoy.extensions.filters.network.wasm.v3.Wasm\n          value:\n            config:\n              configuration:\n                '@type': type.googleapis.com/google.protobuf.StringValue\n                value: |\n                  {\n                    \"debug\": \"false\",\n                    \"stat_prefix\": \"istio\",\n                    \"metrics\": [\n                      {\n                        \"dimensions\": {\n                          \"destinationcluster\": \"node.metadata['CLUSTERID']\",\n                          \"sourcecluster\": \"downstreampeer.cluster_id\"\n                        }\n                      }\n                    ]\n                  }\n              rootid: statsinbound\n              vm_config:\n                code:\n                  local:\n                    inline_string: envoy.wasm.stats\n                runtime: envoy.wasm.runtime.null\n                vmid: tcpstats_inbound\n  applyTo: NETWORK_FILTER\n    match:\n      context: SIDECAR_OUTBOUND\n      listener:\n        filterChain:\n          filter:\n            name: envoy.filters.network.tcp_proxy\n      proxy:\n        proxyVersion: ^1\\.14.*\n    patch:\n      operation: INSERT_BEFORE\n      value:\n        name: istio.stats\n        typed_config:\n          '@type': type.googleapis.com/udpa.type.v1.TypedStruct\n          type_url: type.googleapis.com/envoy.extensions.filters.network.wasm.v3.Wasm\n          value:\n            config:\n              configuration:\n                '@type': type.googleapis.com/google.protobuf.StringValue\n                value: |\n                  {\n                    \"debug\": \"false\",\n                    \"stat_prefix\": \"istio\"\n                  }\n              rootid: statsoutbound\n              vm_config:\n                code:\n                  local:\n                    inline_string: envoy.wasm.stats\n                runtime: envoy.wasm.runtime.null\n                vmid: tcpstats_outbound\n  applyTo: NETWORK_FILTER\n    match:\n      context: GATEWAY\n      listener:\n        filterChain:\n          filter:\n            name: envoy.filters.network.tcp_proxy\n      proxy:\n        proxyVersion: ^1\\.14.*\n    patch:\n      operation: INSERT_BEFORE\n      value:\n        name: istio.stats\n        typed_config:\n          '@type': type.googleapis.com/udpa.type.v1.TypedStruct\n          type_url: type.googleapis.com/envoy.extensions.filters.network.wasm.v3.Wasm\n          value:\n            config:\n              configuration:\n                '@type': type.googleapis.com/google.protobuf.StringValue\n                value: |\n                  {\n                    \"debug\": \"false\",\n                    \"stat_prefix\": \"istio\"\n                  }\n              rootid: statsoutbound\n              vm_config:\n                code:\n                  local:\n                    inline_string: envoy.wasm.stats\n                runtime: envoy.wasm.runtime.null\n                vmid: tcpstats_outbound\n  priority: -1\nEOF\n\n 自定义指标\n\n区分 sidecar 和 gateway 的入站和出站请求\n\n添加requesthost 和 destinationport 维度到两者发出的 requests_total 指标 入站和出站方向的网关和边车\n\n---\napiVersion: networking.istio.io/v1alpha3\nkind: EnvoyFilter\nmetadata:\n  name: stats-filter-1.13\n  namespace: istio-system\n  labels:\n    istio.io/rev: default\nspec:\n  configPatches:\n    applyTo: HTTP_FILTER\n      match:\n        context: SIDECAR_OUTBOUND\n        proxy:\n          proxyVersion: '^1\\.13.*'\n        listener:\n          filterChain:\n            filter:\n              name: \"envoy.filters.network.httpconnectionmanager\"\n              subFilter:\n                name: \"envoy.filters.http.router\"\n      patch:\n        operation: INSERT_BEFORE\n        value:\n          name: istio.stats\n          typed_config:\n            \"@type\": type.googleapis.com/udpa.type.v1.TypedStruct\n            type_url: type.googleapis.com/envoy.extensions.filters.http.wasm.v3.Wasm\n            value:\n              config:\n                rootid: statsoutbound\n                configuration:\n                  \"@type\": \"type.googleapis.com/google.protobuf.StringValue\"\n                  value: |\n                                      {\"metrics\":[{\"dimensions\":{\"destinationport\":\"string(destination.port)\",\"requesthost\":\"request.host\"},\"name\":\"requests_total\"}]}\n                vm_config:\n                  vmid: statsoutbound\n                  runtime: envoy.wasm.runtime.v8\n                  allow_precompiled: true\n                  code:\n                    local:\n                      filename: /etc/istio/extensions/stats-filter.compiled.wasm\n    applyTo: HTTP_FILTER\n      match:\n        context: SIDECAR_INBOUND\n        proxy:\n          proxyVersion: '^1\\.13.*'\n        listener:\n          filterChain:\n            filter:\n              name: \"envoy.filters.network.httpconnectionmanager\"\n              subFilter:\n                name: \"envoy.filters.http.router\"\n      patch:\n        operation: INSERT_BEFORE\n        value:\n          name: istio.stats\n          typed_config:\n            \"@type\": type.googleapis.com/udpa.type.v1.TypedStruct\n            type_url: type.googleapis.com/envoy.extensions.filters.http.wasm.v3.Wasm\n            value:\n              config:\n                rootid: statsinbound\n                configuration:\n                  \"@type\": \"type.googleapis.com/google.protobuf.StringValue\"\n                  value: |\n                                      {\"metrics\":[{\"dimensions\":{\"destinationport\":\"string(destination.port)\",\"requesthost\":\"request.host\"},\"name\":\"requests_total\"}]}\n                vm_config:\n                  vmid: statsinbound\n                  runtime: envoy.wasm.runtime.v8\n                  allow_precompiled: true\n                  code:\n                    local:\n                      filename: /etc/istio/extensions/stats-filter.compiled.wasm\n    applyTo: HTTP_FILTER\n      match:\n        context: GATEWAY\n        proxy:\n          proxyVersion: '^1\\.13.*'\n        listener:\n          filterChain:\n            filter:\n              name: \"envoy.filters.network.httpconnectionmanager\"\n              subFilter:\n                name: \"envoy.filters.http.router\"\n      patch:\n        operation: INSERT_BEFORE\n        value:\n          name: istio.stats\n          typed_config:\n            \"@type\": type.googleapis.com/udpa.type.v1.TypedStruct\n            type_url: type.googleapis.com/envoy.extensions.filters.http.wasm.v3.Wasm\n            value:\n              config:\n                rootid: statsoutbound\n                configuration:\n                  \"@type\": \"type.googleapis.com/google.protobuf.StringValue\"\n                  value: |\n                                      {\"metrics\":[{\"dimensions\":{\"destinationport\":\"string(destination.port)\",\"requesthost\":\"request.host\"},\"name\":\"requests_total\"}]}\n                vm_config:\n                  vmid: statsoutbound\n                  runtime: envoy.wasm.runtime.v8\n                  allow_precompiled: true\n                  code:\n                    local:\n                      filename: /etc/istio/extensions/stats-filter.compiled.wasm\n\n---\napiVersion: networking.istio.io/v1alpha3\nkind: EnvoyFilter\nmetadata:\n  name: tcp-stats-filter-1.13\n  namespace: istio-system\n  labels:\n    istio.io/rev: default\nspec:\n  configPatches:\n    applyTo: NETWORK_FILTER\n      match:\n        context: SIDECAR_INBOUND\n        proxy:\n          proxyVersion: '^1\\.13.*'\n        listener:\n          filterChain:\n            filter:\n              name: \"envoy.filters.network.tcp_proxy\"\n      patch:\n        operation: INSERT_BEFORE\n        value:\n          name: istio.stats\n          typed_config:\n            \"@type\": type.googleapis.com/udpa.type.v1.TypedStruct\n            type_url: type.googleapis.com/envoy.extensions.filters.network.wasm.v3.Wasm\n            value:\n              config:\n                rootid: statsinbound\n                configuration:\n                  \"@type\": \"type.googleapis.com/google.protobuf.StringValue\"\n                  value: |\n                                      {\"metrics\":[{\"dimensions\":{\"destinationport\":\"string(destination.port)\",\"requesthost\":\"request.host\"},\"name\":\"requests_total\"}]}\n                vm_config:\n                  vmid: tcpstats_inbound\n                  runtime: envoy.wasm.runtime.v8\n                  allow_precompiled: true\n                  code:\n                    local:\n                      filename: /etc/istio/extensions/stats-filter.compiled.wasm\n    applyTo: NETWORK_FILTER\n      match:\n        context: SIDECAR_OUTBOUND\n        proxy:\n          proxyVersion: '^1\\.13.*'\n        listener:\n          filterChain:\n            filter:\n              name: \"envoy.filters.network.tcp_proxy\"\n      patch:\n        operation: INSERT_BEFORE\n        value:\n          name: istio.stats\n          typed_config:\n            \"@type\": type.googleapis.com/udpa.type.v1.TypedStruct\n            type_url: type.googleapis.com/envoy.extensions.filters.network.wasm.v3.Wasm\n            value:\n              config:\n                rootid: statsoutbound\n                configuration:\n                  \"@type\": \"type.googleapis.com/google.protobuf.StringValue\"\n                  value: |\n                                      {\"metrics\":[{\"dimensions\":{\"destinationport\":\"string(destination.port)\",\"requesthost\":\"request.host\"},\"name\":\"requests_total\"}]}\n                vm_config:\n                  vmid: tcpstats_outbound\n                  runtime: envoy.wasm.runtime.v8\n                  allow_precompiled: true\n                  code:\n                    local:\n                      filename: /etc/istio/extensions/stats-filter.compiled.wasm\n    applyTo: NETWORK_FILTER\n      match:\n        context: GATEWAY\n        proxy:\n          proxyVersion: '^1\\.13.*'\n        listener:\n          filterChain:\n            filter:\n              name: \"envoy.filters.network.tcp_proxy\"\n      patch:\n        operation: INSERT_BEFORE\n        value:\n          name: istio.stats\n          typed_config:\n            \"@type\": type.googleapis.com/udpa.type.v1.TypedStruct\n            type_url: type.googleapis.com/envoy.extensions.filters.network.wasm.v3.Wasm\n            value:\n              config:\n                rootid: statsoutbound\n                configuration:\n                  \"@type\": \"type.googleapis.com/google.protobuf.StringValue\"\n                  value: |\n                                      {\"metrics\":[{\"dimensions\":{\"destinationport\":\"string(destination.port)\",\"requesthost\":\"request.host\"},\"name\":\"requests_total\"}]}\n                vm_config:\n                  vmid: tcpstats_outbound\n                  runtime: envoy.wasm.runtime.v8\n                  allow_precompiled: true\n                  code:\n                    local:\n                      filename: /etc/istio/extensions/stats-filter.compiled.wasm\n\n 参考资料\n自定义 Istio 指标",
        "tags": []
    },
    {
        "uri": "/zh/blog/istio/利用IstioOpertor安装Istio",
        "content": "---\ntitle: Istio部署实战\nslug: bf667a\ndate: 2022-09-11T10:27:29+08:00\nlastmod: 2022-09-14T14:25:25+08:00\ndraft: false\nauthor: kbsonlong\nauthorEmail: kbsonlong@gmail.com\ntags: [\"istio\"]\ncategories: [\"云原生\"]\n\n---\n\nHelm 安装\n 安装基础资源\n\nhelm template istio-base manifests/charts/base \\\n     -n istio-system \\\n     --set base.enableCRDTemplates=true\n!--more--\n---\nSource: base/templates/reader-serviceaccount.yaml\n This service account aggregates reader permissions for the revisions in a given cluster\nShould be used for remote secret creation.\napiVersion: v1\nkind: ServiceAccount\nmetadata:\n  name: istio-reader-service-account\n  namespace: istio-system\n  labels:\n    app: istio-reader\n    release: istio-base\n---\n Source: base/templates/serviceaccount.yaml\n-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-\n DO NOT EDIT!\nTHIS IS A LEGACY CHART HERE FOR BACKCOMPAT\n UPDATED CHART AT manifests/charts/istio-control/istio-discovery\n-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-\napiVersion: v1\nkind: ServiceAccount\nmetadata:\n  name: istiod-service-account\n  namespace: istio-system\n  labels:\n    app: istiod\n    release: istio-base\n---\n Source: base/templates/crds.yaml\nDO NOT EDIT - Generated by Cue OpenAPI generator based on Istio APIs.\napiVersion: apiextensions.k8s.io/v1\nkind: CustomResourceDefinition\nmetadata:\n  annotations:\n    \"helm.sh/resource-policy\": keep\n  labels:\n    app: istio-pilot\n    chart: istio\n    heritage: Tiller\n    release: istio\n  name: wasmplugins.extensions.istio.io\nspec:\n  group: extensions.istio.io\n  names:\n    categories:\n    istio-io\n    extensions-istio-io\n    kind: WasmPlugin\n    listKind: WasmPluginList\n    plural: wasmplugins\n    singular: wasmplugin\n  scope: Namespaced\n  versions:\n  additionalPrinterColumns:\n    description: 'CreationTimestamp is a timestamp representing the server time\n        when this object was created. It is not guaranteed to be set in happens-before\n        order across separate operations. Clients may not set this value. It is represented\n        in RFC3339 form and is in UTC. Populated by the system. Read-only. Null for\n        lists. More info: https://git.k8s.io/community/contributors/devel/api-conventions.mdmetadata'\n      jsonPath: .metadata.creationTimestamp\n      name: Age\n      type: date\n    name: v1alpha1\n    schema:\n      openAPIV3Schema:\n        properties:\n          spec:\n            description: 'Extend the functionality provided by the Istio proxy through\n              WebAssembly filters. See more details at: https://istio.io/docs/reference/config/proxy_extensions/wasm-plugin.html'\n            properties:\n              imagePullPolicy:\n                description: The pull behaviour to be applied when fetching an OCI\n                  image.\n                enum:\n                UNSPECIFIED_POLICY\n                IfNotPresent\n                Always\n                type: string\n              imagePullSecret:\n                description: Credentials to use for OCI image pulling.\n                type: string\n              phase:\n                description: Determines where in the filter chain this WasmPlugin\n                  is to be injected.\n                enum:\n                UNSPECIFIED_PHASE\n                AUTHN\n                AUTHZ\n                STATS\n                type: string\n              pluginConfig:\n                description: The configuration that will be passed on to the plugin.\n                type: object\n                x-kubernetes-preserve-unknown-fields: true\n              pluginName:\n                type: string\n              priority:\n                description: Determines ordering of WasmPlugins in the same phase.\n                nullable: true\n                type: integer\n              selector:\n                properties:\n                  matchLabels:\n                    additionalProperties:\n                      type: string\n                    type: object\n                type: object\n              sha256:\n                description: SHA256 checksum that will be used to verify Wasm module\n                  or OCI container.\n                type: string\n              url:\n                description: URL of a Wasm module or OCI container.\n                type: string\n              verificationKey:\n                type: string\n            type: object\n          status:\n            type: object\n            x-kubernetes-preserve-unknown-fields: true\n        type: object\n    served: true\n    storage: true\n    subresources:\n      status: {}\n---\nSource: base/templates/crds.yaml\napiVersion: apiextensions.k8s.io/v1\nkind: CustomResourceDefinition\nmetadata:\n  annotations:\n    \"helm.sh/resource-policy\": keep\n  labels:\n    app: istio-pilot\n    chart: istio\n    heritage: Tiller\n    release: istio\n  name: destinationrules.networking.istio.io\nspec:\n  group: networking.istio.io\n  names:\n    categories:\n    istio-io\n    networking-istio-io\n    kind: DestinationRule\n    listKind: DestinationRuleList\n    plural: destinationrules\n    shortNames:\n    dr\n    singular: destinationrule\n  scope: Namespaced\n  versions:\n  additionalPrinterColumns:\n    description: The name of a service from the service registry\n      jsonPath: .spec.host\n      name: Host\n      type: string\n    description: 'CreationTimestamp is a timestamp representing the server time\n        when this object was created. It is not guaranteed to be set in happens-before\n        order across separate operations. Clients may not set this value. It is represented\n        in RFC3339 form and is in UTC. Populated by the system. Read-only. Null for\n        lists. More info: https://git.k8s.io/community/contributors/devel/api-conventions.mdmetadata'\n      jsonPath: .metadata.creationTimestamp\n      name: Age\n      type: date\n    name: v1alpha3\n    schema:\n      openAPIV3Schema:\n        properties:\n          spec:\n            description: 'Configuration affecting load balancing, outlier detection,\n              etc. See more details at: https://istio.io/docs/reference/config/networking/destination-rule.html'\n            properties:\n              exportTo:\n                description: A list of namespaces to which this destination rule is\n                  exported.\n                items:\n                  type: string\n                type: array\n              host:\n                description: The name of a service from the service registry.\n                type: string\n              subsets:\n                items:\n                  properties:\n                    labels:\n                      additionalProperties:\n                        type: string\n                      type: object\n                    name:\n                      description: Name of the subset.\n                      type: string\n                    trafficPolicy:\n                      description: Traffic policies that apply to this subset.\n                      properties:\n                        connectionPool:\n                          properties:\n                            http:\n                              description: HTTP connection pool settings.\n                              properties:\n                                h2UpgradePolicy:\n                                  description: Specify if http1.1 connection should\n                                    be upgraded to http2 for the associated destination.\n                                  enum:\n                                  DEFAULT\n                                  DONOTUPGRADE\n                                  UPGRADE\n                                  type: string\n                                http1MaxPendingRequests:\n                                  description: Maximum number of pending HTTP requests\n                                    to a destination.\n                                  format: int32\n                                  type: integer\n                                http2MaxRequests:\n                                  description: Maximum number of requests to a backend.\n                                  format: int32\n                                  type: integer\n                                idleTimeout:\n                                  description: The idle timeout for upstream connection\n                                    pool connections.\n                                  type: string\n                                maxRequestsPerConnection:\n                                  description: Maximum number of requests per connection\n                                    to a backend.\n                                  format: int32\n                                  type: integer\n                                maxRetries:\n                                  format: int32\n                                  type: integer\n                                useClientProtocol:\n                                  description: If set to true, client protocol will\n                                    be preserved while initiating connection to backend.\n                                  type: boolean\n                              type: object\n                            tcp:\n                              description: Settings common to both HTTP and TCP upstream\n                                connections.\n                              properties:\n                                connectTimeout:\n                                  description: TCP connection timeout.\n                                  type: string\n                                maxConnections:\n                                  description: Maximum number of HTTP1 /TCP connections\n                                    to a destination host.\n                                  format: int32\n                                  type: integer\n                                tcpKeepalive:\n                                  description: If set then set SO_KEEPALIVE on the\n                                    socket to enable TCP Keepalives.\n                                  properties:\n                                    interval:\n                                      description: The time duration between keep-alive\n                                        probes.\n                                      type: string\n                                    probes:\n                                      type: integer\n                                    time:\n                                      type: string\n                                  type: object\n                              type: object\n                          type: object\n                        loadBalancer:\n                          description: Settings controlling the load balancer algorithms.\n                          oneOf:\n                          not:\n                              anyOf:\n                              required:\n                                simple\n                              properties:\n                                  consistentHash:\n                                    oneOf:\n                                    not:\n                                        anyOf:\n                                        required:\n                                          httpHeaderName\n                                        required:\n                                          httpCookie\n                                        required:\n                                          useSourceIp\n                                        required:\n                                          httpQueryParameterName\n                                    required:\n                                      httpHeaderName\n                                    required:\n                                      httpCookie\n                                    required:\n                                      useSourceIp\n                                    required:\n                                      httpQueryParameterName\n                                required:\n                                consistentHash\n                          required:\n                            simple\n                          properties:\n                              consistentHash:\n                                oneOf:\n                                not:\n                                    anyOf:\n                                    required:\n                                      httpHeaderName\n                                    required:\n                                      httpCookie\n                                    required:\n                                      useSourceIp\n                                    required:\n                                      httpQueryParameterName\n                                required:\n                                  httpHeaderName\n                                required:\n                                  httpCookie\n                                required:\n                                  useSourceIp\n                                required:\n                                  httpQueryParameterName\n                            required:\n                            consistentHash\n                          properties:\n                            consistentHash:\n                              properties:\n                                httpCookie:\n                                  description: Hash based on HTTP cookie.\n                                  properties:\n                                    name:\n                                      description: Name of the cookie.\n                                      type: string\n                                    path:\n                                      description: Path to set for the cookie.\n                                      type: string\n                                    ttl:\n                                      description: Lifetime of the cookie.\n                                      type: string\n                                  type: object\n                                httpHeaderName:\n                                  description: Hash based on a specific HTTP header.\n                                  type: string\n                                httpQueryParameterName:\n                                  description: Hash based on a specific HTTP query\n                                    parameter.\n                                  type: string\n                                minimumRingSize:\n                                  type: integer\n                                useSourceIp:\n                                  description: Hash based on the source IP address.\n                                  type: boolean\n                              type: object\n                            localityLbSetting:\n                              properties:\n                                distribute:\n                                  description: 'Optional: only one of distribute,\n                                    failover or failoverPriority can be set.'\n                                  items:\n                                    properties:\n                                      from:\n                                        description: Originating locality, '/' separated,\n                                          e.g.\n                                        type: string\n                                      to:\n                                        additionalProperties:\n                                          type: integer\n                                        description: Map of upstream localities to\n                                          traffic distribution weights.\n                                        type: object\n                                    type: object\n                                  type: array\n                                enabled:\n                                  description: enable locality load balancing, this\n                                    is DestinationRule-level and will override mesh\n                                    wide settings in entirety.\n                                  nullable: true\n                                  type: boolean\n                                failover:\n                                  description: 'Optional: only one of distribute,\n                                    failover or failoverPriority can be set.'\n                                  items:\n                                    properties:\n                                      from:\n                                        description: Originating region.\n                                        type: string\n                                      to:\n                                        type: string\n                                    type: object\n                                  type: array\n                                failoverPriority:\n                                  description: failoverPriority is an ordered list\n                                    of labels used to sort endpoints to do priority\n                                    based load balancing.\n                                  items:\n                                    type: string\n                                  type: array\n                              type: object\n                            simple:\n                              enum:\n                              ROUND_ROBIN\n                              LEAST_CONN\n                              RANDOM\n                              PASSTHROUGH\n                              type: string\n                          type: object\n                        outlierDetection:\n                          properties:\n                            baseEjectionTime:\n                              description: Minimum ejection duration.\n                              type: string\n                            consecutive5xxErrors:\n                              description: Number of 5xx errors before a host is ejected\n                                from the connection pool.\n                              nullable: true\n                              type: integer\n                            consecutiveErrors:\n                              format: int32\n                              type: integer\n                            consecutiveGatewayErrors:\n                              description: Number of gateway errors before a host\n                                is ejected from the connection pool.\n                              nullable: true\n                              type: integer\n                            consecutiveLocalOriginFailures:\n                              nullable: true\n                              type: integer\n                            interval:\n                              description: Time interval between ejection sweep analysis.\n                              type: string\n                            maxEjectionPercent:\n                              format: int32\n                              type: integer\n                            minHealthPercent:\n                              format: int32\n                              type: integer\n                            splitExternalLocalOriginErrors:\n                              description: Determines whether to distinguish local\n                                origin failures from external errors.\n                              type: boolean\n                          type: object\n                        portLevelSettings:\n                          description: Traffic policies specific to individual ports.\n                          items:\n                            properties:\n                              connectionPool:\n                                properties:\n                                  http:\n                                    description: HTTP connection pool settings.\n                                    properties:\n                                      h2UpgradePolicy:\n                                        description: Specify if http1.1 connection\n                                          should be upgraded to http2 for the associated\n                                          destination.\n                                        enum:\n                                        DEFAULT\n                                        DONOTUPGRADE\n                                        UPGRADE\n                                        type: string\n                                      http1MaxPendingRequests:\n                                        description: Maximum number of pending HTTP\n                                          requests to a destination.\n                                        format: int32\n                                        type: integer\n                                      http2MaxRequests:\n                                        description: Maximum number of requests to\n                                          a backend.\n                                        format: int32\n                                        type: integer\n                                      idleTimeout:\n                                        description: The idle timeout for upstream\n                                          connection pool connections.\n                                        type: string\n                                      maxRequestsPerConnection:\n                                        description: Maximum number of requests per\n                                          connection to a backend.\n                                        format: int32\n                                        type: integer\n                                      maxRetries:\n                                        format: int32\n                                        type: integer\n                                      useClientProtocol:\n                                        description: If set to true, client protocol\n                                          will be preserved while initiating connection\n                                          to backend.\n                                        type: boolean\n                                    type: object\n                                  tcp:\n                                    description: Settings common to both HTTP and\n                                      TCP upstream connections.\n                                    properties:\n                                      connectTimeout:\n                                        description: TCP connection timeout.\n                                        type: string\n                                      maxConnections:\n                                        description: Maximum number of HTTP1 /TCP\n                                          connections to a destination host.\n                                        format: int32\n                                        type: integer\n                                      tcpKeepalive:\n                                        description: If set then set SO_KEEPALIVE\n                                          on the socket to enable TCP Keepalives.\n                                        properties:\n                                          interval:\n                                            description: The time duration between\n                                              keep-alive probes.\n                                            type: string\n                                          probes:\n                                            type: integer\n                                          time:\n                                            type: string\n                                        type: object\n                                    type: object\n                                type: object\n                              loadBalancer:\n                                description: Settings controlling the load balancer\n                                  algorithms.\n                                oneOf:\n                                not:\n                                    anyOf:\n                                    required:\n                                      simple\n                                    properties:\n                                        consistentHash:\n                                          oneOf:\n                                          not:\n                                              anyOf:\n                                              required:\n                                                httpHeaderName\n                                              required:\n                                                httpCookie\n                                              required:\n                                                useSourceIp\n                                              required:\n                                                httpQueryParameterName\n                                          required:\n                                            httpHeaderName\n                                          required:\n                                            httpCookie\n                                          required:\n                                            useSourceIp\n                                          required:\n                                            httpQueryParameterName\n                                      required:\n                                      consistentHash\n                                required:\n                                  simple\n                                properties:\n                                    consistentHash:\n                                      oneOf:\n                                      not:\n                                          anyOf:\n                                          required:\n                                            httpHeaderName\n                                          required:\n                                            httpCookie\n                                          required:\n                                            useSourceIp\n                                          required:\n                                            httpQueryParameterName\n                                      required:\n                                        httpHeaderName\n                                      required:\n                                        httpCookie\n                                      required:\n                                        useSourceIp\n                                      required:\n                                        httpQueryParameterName\n                                  required:\n                                  consistentHash\n                                properties:\n                                  consistentHash:\n                                    properties:\n                                      httpCookie:\n                                        description: Hash based on HTTP cookie.\n                                        properties:\n                                          name:\n                                            description: Name of the cookie.\n                                            type: string\n                                          path:\n                                            description: Path to set for the cookie.\n                                            type: string\n                                          ttl:\n                                            description: Lifetime of the cookie.\n                                            type: string\n                                        type: object\n                                      httpHeaderName:\n                                        description: Hash based on a specific HTTP\n                                          header.\n                                        type: string\n                                      httpQueryParameterName:\n                                        description: Hash based on a specific HTTP\n                                          query parameter.\n                                        type: string\n                                      minimumRingSize:\n                                        type: integer\n                                      useSourceIp:\n                                        description: Hash based on the source IP address.\n                                        type: boolean\n                                    type: object\n                                  localityLbSetting:\n                                    properties:\n                                      distribute:\n                                        description: 'Optional: only one of distribute,\n                                          failover or failoverPriority can be set.'\n                                        items:\n                                          properties:\n                                            from:\n                                              description: Originating locality, '/'\n                                                separated, e.g.\n                                              type: string\n                                            to:\n                                              additionalProperties:\n                                                type: integer\n                                              description: Map of upstream localities\n                                                to traffic distribution weights.\n                                              type: object\n                                          type: object\n                                        type: array\n                                      enabled:\n                                        description: enable locality load balancing,\n                                          this is DestinationRule-level and will override\n                                          mesh wide settings in entirety.\n                                        nullable: true\n                                        type: boolean\n                                      failover:\n                                        description: 'Optional: only one of distribute,\n                                          failover or failoverPriority can be set.'\n                                        items:\n                                          properties:\n                                            from:\n                                              description: Originating region.\n                                              type: string\n                                            to:\n                                              type: string\n                                          type: object\n                                        type: array\n                                      failoverPriority:\n                                        description: failoverPriority is an ordered\n                                          list of labels used to sort endpoints to\n                                          do priority based load balancing.\n                                        items:\n                                          type: string\n                                        type: array\n                                    type: object\n                                  simple:\n                                    enum:\n                                    ROUND_ROBIN\n                                    LEAST_CONN\n                                    RANDOM\n                                    PASSTHROUGH\n                                    type: string\n                                type: object\n                              outlierDetection:\n                                properties:\n                                  baseEjectionTime:\n                                    description: Minimum ejection duration.\n                                    type: string\n                                  consecutive5xxErrors:\n                                    description: Number of 5xx errors before a host\n                                      is ejected from the connection pool.\n                                    nullable: true\n                                    type: integer\n                                  consecutiveErrors:\n                                    format: int32\n                                    type: integer\n                                  consecutiveGatewayErrors:\n                                    description: Number of gateway errors before a\n                                      host is ejected from the connection pool.\n                                    nullable: true\n                                    type: integer\n                                  consecutiveLocalOriginFailures:\n                                    nullable: true\n                                    type: integer\n                                  interval:\n                                    description: Time interval between ejection sweep\n                                      analysis.\n                                    type: string\n                                  maxEjectionPercent:\n                                    format: int32\n                                    type: integer\n                                  minHealthPercent:\n                                    format: int32\n                                    type: integer\n                                  splitExternalLocalOriginErrors:\n                                    description: Determines whether to distinguish\n                                      local origin failures from external errors.\n                                    type: boolean\n                                type: object\n                              port:\n                                properties:\n                                  number:\n                                    type: integer\n                                type: object\n                              tls:\n                                description: TLS related settings for connections\n                                  to the upstream service.\n                                properties:\n                                  caCertificates:\n                                    type: string\n                                  clientCertificate:\n                                    description: REQUIRED if mode is MUTUAL.\n                                    type: string\n                                  credentialName:\n                                    type: string\n                                  insecureSkipVerify:\n                                    nullable: true\n                                    type: boolean\n                                  mode:\n                                    enum:\n                                    DISABLE\n                                    SIMPLE\n                                    MUTUAL\n                                    ISTIO_MUTUAL\n                                    type: string\n                                  privateKey:\n                                    description: REQUIRED if mode is MUTUAL.\n                                    type: string\n                                  sni:\n                                    description: SNI string to present to the server\n                                      during TLS handshake.\n                                    type: string\n                                  subjectAltNames:\n                                    items:\n                                      type: string\n                                    type: array\n                                type: object\n                            type: object\n                          type: array\n                        tls:\n                          description: TLS related settings for connections to the\n                            upstream service.\n                          properties:\n                            caCertificates:\n                              type: string\n                            clientCertificate:\n                              description: REQUIRED if mode is MUTUAL.\n                              type: string\n                            credentialName:\n                              type: string\n                            insecureSkipVerify:\n                              nullable: true\n                              type: boolean\n                            mode:\n                              enum:\n                              DISABLE\n                              SIMPLE\n                              MUTUAL\n                              ISTIO_MUTUAL\n                              type: string\n                            privateKey:\n                              description: REQUIRED if mode is MUTUAL.\n                              type: string\n                            sni:\n                              description: SNI string to present to the server during\n                                TLS handshake.\n                              type: string\n                            subjectAltNames:\n                              items:\n                                type: string\n                              type: array\n                          type: object\n                      type: object\n                  type: object\n                type: array\n              trafficPolicy:\n                properties:\n                  connectionPool:\n                    properties:\n                      http:\n                        description: HTTP connection pool settings.\n                        properties:\n                          h2UpgradePolicy:\n                            description: Specify if http1.1 connection should be upgraded\n                              to http2 for the associated destination.\n                            enum:\n                            DEFAULT\n                            DONOTUPGRADE\n                            UPGRADE\n                            type: string\n                          http1MaxPendingRequests:\n                            description: Maximum number of pending HTTP requests to\n                              a destination.\n                            format: int32\n                            type: integer\n                          http2MaxRequests:\n                            description: Maximum number of requests to a backend.\n                            format: int32\n                            type: integer\n                          idleTimeout:\n                            description: The idle timeout for upstream connection\n                              pool connections.\n                            type: string\n                          maxRequestsPerConnection:\n                            description: Maximum number of requests per connection\n                              to a backend.\n                            format: int32\n                            type: integer\n                          maxRetries:\n                            format: int32\n                            type: integer\n                          useClientProtocol:\n                            description: If set to true, client protocol will be preserved\n                              while initiating connection to backend.\n                            type: boolean\n                        type: object\n                      tcp:\n                        description: Settings common to both HTTP and TCP upstream\n                          connections.\n                        properties:\n                          connectTimeout:\n                            description: TCP connection timeout.\n                            type: string\n                          maxConnections:\n                            description: Maximum number of HTTP1 /TCP connections\n                              to a destination host.\n                            format: int32\n                            type: integer\n                          tcpKeepalive:\n                            description: If set then set SO_KEEPALIVE on the socket\n                              to enable TCP Keepalives.\n                            properties:\n                              interval:\n                                description: The time duration between keep-alive\n                                  probes.\n                                type: string\n                              probes:\n                                type: integer\n                              time:\n                                type: string\n                            type: object\n                        type: object\n                    type: object\n                  loadBalancer:\n                    description: Settings controlling the load balancer algorithms.\n                    oneOf:\n                    not:\n                        anyOf:\n                        required:\n                          simple\n                        properties:\n                            consistentHash:\n                              oneOf:\n                              not:\n                                  anyOf:\n                                  required:\n                                    httpHeaderName\n                                  required:\n                                    httpCookie\n                                  required:\n                                    useSourceIp\n                                  required:\n                                    httpQueryParameterName\n                              required:\n                                httpHeaderName\n                              required:\n                                httpCookie\n                              required:\n                                useSourceIp\n                              required:\n                                httpQueryParameterName\n                          required:\n                          consistentHash\n                    required:\n                      simple\n                    properties:\n                        consistentHash:\n                          oneOf:\n                          not:\n                              anyOf:\n                              required:\n                                httpHeaderName\n                              required:\n                                httpCookie\n                              required:\n                                useSourceIp\n                              required:\n                                httpQueryParameterName\n                          required:\n                            httpHeaderName\n                          required:\n                            httpCookie\n                          required:\n                            useSourceIp\n                          required:\n                            httpQueryParameterName\n                      required:\n                      consistentHash\n                    properties:\n                      consistentHash:\n                        properties:\n                          httpCookie:\n                            description: Hash based on HTTP cookie.\n                            properties:\n                              name:\n                                description: Name of the cookie.\n                                type: string\n                              path:\n                                description: Path to set for the cookie.\n                                type: string\n                              ttl:\n                                description: Lifetime of the cookie.\n                                type: string\n                            type: object\n                          httpHeaderName:\n                            description: Hash based on a specific HTTP header.\n                            type: string\n                          httpQueryParameterName:\n                            description: Hash based on a specific HTTP query parameter.\n                            type: string\n                          minimumRingSize:\n                            type: integer\n                          useSourceIp:\n                            description: Hash based on the source IP address.\n                            type: boolean\n                        type: object\n                      localityLbSetting:\n                        properties:\n                          distribute:\n                            description: 'Optional: only one of distribute, failover\n                              or failoverPriority can be set.'\n                            items:\n                              properties:\n                                from:\n                                  description: Originating locality, '/' separated,\n                                    e.g.\n                                  type: string\n                                to:\n                                  additionalProperties:\n                                    type: integer\n                                  description: Map of upstream localities to traffic\n                                    distribution weights.\n                                  type: object\n                              type: object\n                            type: array\n                          enabled:\n                            description: enable locality load balancing, this is DestinationRule-level\n                              and will override mesh wide settings in entirety.\n                            nullable: true\n                            type: boolean\n                          failover:\n                            description: 'Optional: only one of distribute, failover\n                              or failoverPriority can be set.'\n                            items:\n                              properties:\n                                from:\n                                  description: Originating region.\n                                  type: string\n                                to:\n                                  type: string\n                              type: object\n                            type: array\n                          failoverPriority:\n                            description: failoverPriority is an ordered list of labels\n                              used to sort endpoints to do priority based load balancing.\n                            items:\n                              type: string\n                            type: array\n                        type: object\n                      simple:\n                        enum:\n                        ROUND_ROBIN\n                        LEAST_CONN\n                        RANDOM\n                        PASSTHROUGH\n                        type: string\n                    type: object\n                  outlierDetection:\n                    properties:\n                      baseEjectionTime:\n                        description: Minimum ejection duration.\n                        type: string\n                      consecutive5xxErrors:\n                        description: Number of 5xx errors before a host is ejected\n                          from the connection pool.\n                        nullable: true\n                        type: integer\n                      consecutiveErrors:\n                        format: int32\n                        type: integer\n                      consecutiveGatewayErrors:\n                        description: Number of gateway errors before a host is ejected\n                          from the connection pool.\n                        nullable: true\n                        type: integer\n                      consecutiveLocalOriginFailures:\n                        nullable: true\n                        type: integer\n                      interval:\n                        description: Time interval between ejection sweep analysis.\n                        type: string\n                      maxEjectionPercent:\n                        format: int32\n                        type: integer\n                      minHealthPercent:\n                        format: int32\n                        type: integer\n                      splitExternalLocalOriginErrors:\n                        description: Determines whether to distinguish local origin\n                          failures from external errors.\n                        type: boolean\n                    type: object\n                  portLevelSettings:\n                    description: Traffic policies specific to individual ports.\n                    items:\n                      properties:\n                        connectionPool:\n                          properties:\n                            http:\n                              description: HTTP connection pool settings.\n                              properties:\n                                h2UpgradePolicy:\n                                  description: Specify if http1.1 connection should\n                                    be upgraded to http2 for the associated destination.\n                                  enum:\n                                  DEFAULT\n                                  DONOTUPGRADE\n                                  UPGRADE\n                                  type: string\n                                http1MaxPendingRequests:\n                                  description: Maximum number of pending HTTP requests\n                                    to a destination.\n                                  format: int32\n                                  type: integer\n                                http2MaxRequests:\n                                  description: Maximum number of requests to a backend.\n                                  format: int32\n                                  type: integer\n                                idleTimeout:\n                                  description: The idle timeout for upstream connection\n                                    pool connections.\n                                  type: string\n                                maxRequestsPerConnection:\n                                  description: Maximum number of requests per connection\n                                    to a backend.\n                                  format: int32\n                                  type: integer\n                                maxRetries:\n                                  format: int32\n                                  type: integer\n                                useClientProtocol:\n                                  description: If set to true, client protocol will\n                                    be preserved while initiating connection to backend.\n                                  type: boolean\n                              type: object\n                            tcp:\n                              description: Settings common to both HTTP and TCP upstream\n                                connections.\n                              properties:\n                                connectTimeout:\n                                  description: TCP connection timeout.\n                                  type: string\n                                maxConnections:\n                                  description: Maximum number of HTTP1 /TCP connections\n                                    to a destination host.\n                                  format: int32\n                                  type: integer\n                                tcpKeepalive:\n                                  description: If set then set SO_KEEPALIVE on the\n                                    socket to enable TCP Keepalives.\n                                  properties:\n                                    interval:\n                                      description: The time duration between keep-alive\n                                        probes.\n                                      type: string\n                                    probes:\n                                      type: integer\n                                    time:\n                                      type: string\n                                  type: object\n                              type: object\n                          type: object\n                        loadBalancer:\n                          description: Settings controlling the load balancer algorithms.\n                          oneOf:\n                          not:\n                              anyOf:\n                              required:\n                                simple\n                              properties:\n                                  consistentHash:\n                                    oneOf:\n                                    not:\n                                        anyOf:\n                                        required:\n                                          httpHeaderName\n                                        required:\n                                          httpCookie\n                                        required:\n                                          useSourceIp\n                                        required:\n                                          httpQueryParameterName\n                                    required:\n                                      httpHeaderName\n                                    required:\n                                      httpCookie\n                                    required:\n                                      useSourceIp\n                                    required:\n                                      httpQueryParameterName\n                                required:\n                                consistentHash\n                          required:\n                            simple\n                          properties:\n                              consistentHash:\n                                oneOf:\n                                not:\n                                    anyOf:\n                                    required:\n                                      httpHeaderName\n                                    required:\n                                      httpCookie\n                                    required:\n                                      useSourceIp\n                                    required:\n                                      httpQueryParameterName\n                                required:\n                                  httpHeaderName\n                                required:\n                                  httpCookie\n                                required:\n                                  useSourceIp\n                                required:\n                                  httpQueryParameterName\n                            required:\n                            consistentHash\n                          properties:\n                            consistentHash:\n                              properties:\n                                httpCookie:\n                                  description: Hash based on HTTP cookie.\n                                  properties:\n                                    name:\n                                      description: Name of the cookie.\n                                      type: string\n                                    path:\n                                      description: Path to set for the cookie.\n                                      type: string\n                                    ttl:\n                                      description: Lifetime of the cookie.\n                                      type: string\n                                  type: object\n                                httpHeaderName:\n                                  description: Hash based on a specific HTTP header.\n                                  type: string\n                                httpQueryParameterName:\n                                  description: Hash based on a specific HTTP query\n                                    parameter.\n                                  type: string\n                                minimumRingSize:\n                                  type: integer\n                                useSourceIp:\n                                  description: Hash based on the source IP address.\n                                  type: boolean\n                              type: object\n                            localityLbSetting:\n                              properties:\n                                distribute:\n                                  description: 'Optional: only one of distribute,\n                                    failover or failoverPriority can be set.'\n                                  items:\n                                    properties:\n                                      from:\n                                        description: Originating locality, '/' separated,\n                                          e.g.\n                                        type: string\n                                      to:\n                                        additionalProperties:\n                                          type: integer\n                                        description: Map of upstream localities to\n                                          traffic distribution weights.\n                                        type: object\n                                    type: object\n                                  type: array\n                                enabled:\n                                  description: enable locality load balancing, this\n                                    is DestinationRule-level and will override mesh\n                                    wide settings in entirety.\n                                  nullable: true\n                                  type: boolean\n                                failover:\n                                  description: 'Optional: only one of distribute,\n                                    failover or failoverPriority can be set.'\n                                  items:\n                                    properties:\n                                      from:\n                                        description: Originating region.\n                                        type: string\n                                      to:\n                                        type: string\n                                    type: object\n                                  type: array\n                                failoverPriority:\n                                  description: failoverPriority is an ordered list\n                                    of labels used to sort endpoints to do priority\n                                    based load balancing.\n                                  items:\n                                    type: string\n                                  type: array\n                              type: object\n                            simple:\n                              enum:\n                              ROUND_ROBIN\n                              LEAST_CONN\n                              RANDOM\n                              PASSTHROUGH\n                              type: string\n                          type: object\n                        outlierDetection:\n                          properties:\n                            baseEjectionTime:\n                              description: Minimum ejection duration.\n                              type: string\n                            consecutive5xxErrors:\n                              description: Number of 5xx errors before a host is ejected\n                                from the connection pool.\n                              nullable: true\n                              type: integer\n                            consecutiveErrors:\n                              format: int32\n                              type: integer\n                            consecutiveGatewayErrors:\n                              description: Number of gateway errors before a host\n                                is ejected from the connection pool.\n                              nullable: true\n                              type: integer\n                            consecutiveLocalOriginFailures:\n                              nullable: true\n                              type: integer\n                            interval:\n                              description: Time interval between ejection sweep analysis.\n                              type: string\n                            maxEjectionPercent:\n                              format: int32\n                              type: integer\n                            minHealthPercent:\n                              format: int32\n                              type: integer\n                            splitExternalLocalOriginErrors:\n                              description: Determines whether to distinguish local\n                                origin failures from external errors.\n                              type: boolean\n                          type: object\n                        port:\n                          properties:\n                            number:\n                              type: integer\n                          type: object\n                        tls:\n                          description: TLS related settings for connections to the\n                            upstream service.\n                          properties:\n                            caCertificates:\n                              type: string\n                            clientCertificate:\n                              description: REQUIRED if mode is MUTUAL.\n                              type: string\n                            credentialName:\n                              type: string\n                            insecureSkipVerify:\n                              nullable: true\n                              type: boolean\n                            mode:\n                              enum:\n                              DISABLE\n                              SIMPLE\n                              MUTUAL\n                              ISTIO_MUTUAL\n                              type: string\n                            privateKey:\n                              description: REQUIRED if mode is MUTUAL.\n                              type: string\n                            sni:\n                              description: SNI string to present to the server during\n                                TLS handshake.\n                              type: string\n                            subjectAltNames:\n                              items:\n                                type: string\n                              type: array\n                          type: object\n                      type: object\n                    type: array\n                  tls:\n                    description: TLS related settings for connections to the upstream\n                      service.\n                    properties:\n                      caCertificates:\n                        type: string\n                      clientCertificate:\n                        description: REQUIRED if mode is MUTUAL.\n                        type: string\n                      credentialName:\n                        type: string\n                      insecureSkipVerify:\n                        nullable: true\n                        type: boolean\n                      mode:\n                        enum:\n                        DISABLE\n                        SIMPLE\n                        MUTUAL\n                        ISTIO_MUTUAL\n                        type: string\n                      privateKey:\n                        description: REQUIRED if mode is MUTUAL.\n                        type: string\n                      sni:\n                        description: SNI string to present to the server during TLS\n                          handshake.\n                        type: string\n                      subjectAltNames:\n                        items:\n                          type: string\n                        type: array\n                    type: object\n                type: object\n            type: object\n          status:\n            type: object\n            x-kubernetes-preserve-unknown-fields: true\n        type: object\n    served: true\n    storage: true\n    subresources:\n      status: {}\n  additionalPrinterColumns:\n    description: The name of a service from the service registry\n      jsonPath: .spec.host\n      name: Host\n      type: string\n    description: 'CreationTimestamp is a timestamp representing the server time\n        when this object was created. It is not guaranteed to be set in happens-before\n        order across separate operations. Clients may not set this value. It is represented\n        in RFC3339 form and is in UTC. Populated by the system. Read-only. Null for\n        lists. More info: https://git.k8s.io/community/contributors/devel/api-conventions.md#metadata'\n      jsonPath: .metadata.creationTimestamp\n      name: Age\n      type: date\n    name: v1beta1\n    schema:\n      openAPIV3Schema:\n        properties:\n          spec:\n            description: 'Configuration affecting load balancing, outlier detection,\n              etc. See more details at: https://istio.io/docs/reference/config/networking/destination-rule.html'\n            properties:\n              exportTo:\n                description: A list of namespaces to which this destination rule is\n                  exported.\n                items:\n                  type: string\n                type: array\n              host:\n                description: The name of a service from the service registry.\n                type: string\n              subsets:\n                items:\n                  properties:\n                    labels:\n                      additionalProperties:\n                        type: string\n                      type: object\n                    name:\n                      description: Name of the subset.\n                      type: string\n                    trafficPolicy:\n                      description: Traffic policies that apply to this subset.\n                      properties:\n                        connectionPool:\n                          properties:\n                            http:\n                              description: HTTP connection pool settings.\n                              properties:\n                                h2UpgradePolicy:\n                                  description: Specify if http1.1 connection should\n                                    be upgraded to http2 for the associated destination.\n                                  enum:\n                                  DEFAULT\n                                  DONOTUPGRADE\n                                  UPGRADE\n                                  type: string\n                                http1MaxPendingRequests:\n                                  description: Maximum number of pending HTTP requests\n                                    to a destination.\n                                  format: int32\n                                  type: integer\n                                http2MaxRequests:\n                                  description: Maximum number of requests to a backend.\n                                  format: int32\n                                  type: integer\n                                idleTimeout:\n                                  description: The idle timeout for upstream connection\n                                    pool connections.\n                                  type: string\n                                maxRequestsPerConnection:\n                                  description: Maximum number of requests per connection\n                                    to a backend.\n                                  format: int32\n                                  type: integer\n                                maxRetries:\n                                  format: int32\n                                  type: integer\n                                useClientProtocol:\n                                  description: If set to true, client protocol will\n                                    be preserved while initiating connection to backend.\n                                  type: boolean\n                              type: object\n                            tcp:\n                              description: Settings common to both HTTP and TCP upstream\n                                connections.\n                              properties:\n                                connectTimeout:\n                                  description: TCP connection timeout.\n                                  type: string\n                                maxConnections:\n                                  description: Maximum number of HTTP1 /TCP connections\n                                    to a destination host.\n                                  format: int32\n                                  type: integer\n                                tcpKeepalive:\n                                  description: If set then set SO_KEEPALIVE on the\n                                    socket to enable TCP Keepalives.\n                                  properties:\n                                    interval:\n                                      description: The time duration between keep-alive\n                                        probes.\n                                      type: string\n                                    probes:\n                                      type: integer\n                                    time:\n                                      type: string\n                                  type: object\n                              type: object\n                          type: object\n                        loadBalancer:\n                          description: Settings controlling the load balancer algorithms.\n                          oneOf:\n                          not:\n                              anyOf:\n                              required:\n                                simple\n                              properties:\n                                  consistentHash:\n                                    oneOf:\n                                    not:\n                                        anyOf:\n                                        required:\n                                          httpHeaderName\n                                        required:\n                                          httpCookie\n                                        required:\n                                          useSourceIp\n                                        required:\n                                          httpQueryParameterName\n                                    required:\n                                      httpHeaderName\n                                    required:\n                                      httpCookie\n                                    required:\n                                      useSourceIp\n                                    required:\n                                      httpQueryParameterName\n                                required:\n                                consistentHash\n                          required:\n                            simple\n                          properties:\n                              consistentHash:\n                                oneOf:\n                                not:\n                                    anyOf:\n                                    required:\n                                      httpHeaderName\n                                    required:\n                                      httpCookie\n                                    required:\n                                      useSourceIp\n                                    required:\n                                      httpQueryParameterName\n                                required:\n                                  httpHeaderName\n                                required:\n                                  httpCookie\n                                required:\n                                  useSourceIp\n                                required:\n                                  httpQueryParameterName\n                            required:\n                            consistentHash\n                          properties:\n                            consistentHash:\n                              properties:\n                                httpCookie:\n                                  description: Hash based on HTTP cookie.\n                                  properties:\n                                    name:\n                                      description: Name of the cookie.\n                                      type: string\n                                    path:\n                                      description: Path to set for the cookie.\n                                      type: string\n                                    ttl:\n                                      description: Lifetime of the cookie.\n                                      type: string\n                                  type: object\n                                httpHeaderName:\n                                  description: Hash based on a specific HTTP header.\n                                  type: string\n                                httpQueryParameterName:\n                                  description: Hash based on a specific HTTP query\n                                    parameter.\n                                  type: string\n                                minimumRingSize:\n                                  type: integer\n                                useSourceIp:\n                                  description: Hash based on the source IP address.\n                                  type: boolean\n                              type: object\n                            localityLbSetting:\n                              properties:\n                                distribute:\n                                  description: 'Optional: only one of distribute,\n                                    failover or failoverPriority can be set.'\n                                  items:\n                                    properties:\n                                      from:\n                                        description: Originating locality, '/' separated,\n                                          e.g.\n                                        type: string\n                                      to:\n                                        additionalProperties:\n                                          type: integer\n                                        description: Map of upstream localities to\n                                          traffic distribution weights.\n                                        type: object\n                                    type: object\n                                  type: array\n                                enabled:\n                                  description: enable locality load balancing, this\n                                    is DestinationRule-level and will override mesh\n                                    wide settings in entirety.\n                                  nullable: true\n                                  type: boolean\n                                failover:\n                                  description: 'Optional: only one of distribute,\n                                    failover or failoverPriority can be set.'\n                                  items:\n                                    properties:\n                                      from:\n                                        description: Originating region.\n                                        type: string\n                                      to:\n                                        type: string\n                                    type: object\n                                  type: array\n                                failoverPriority:\n                                  description: failoverPriority is an ordered list\n                                    of labels used to sort endpoints to do priority\n                                    based load balancing.\n                                  items:\n                                    type: string\n                                  type: array\n                              type: object\n                            simple:\n                              enum:\n                              ROUND_ROBIN\n                              LEAST_CONN\n                              RANDOM\n                              PASSTHROUGH\n                              type: string\n                          type: object\n                        outlierDetection:\n                          properties:\n                            baseEjectionTime:\n                              description: Minimum ejection duration.\n                              type: string\n                            consecutive5xxErrors:\n                              description: Number of 5xx errors before a host is ejected\n                                from the connection pool.\n                              nullable: true\n                              type: integer\n                            consecutiveErrors:\n                              format: int32\n                              type: integer\n                            consecutiveGatewayErrors:\n                              description: Number of gateway errors before a host\n                                is ejected from the connection pool.\n                              nullable: true\n                              type: integer\n                            consecutiveLocalOriginFailures:\n                              nullable: true\n                              type: integer\n                            interval:\n                              description: Time interval between ejection sweep analysis.\n                              type: string\n                            maxEjectionPercent:\n                              format: int32\n                              type: integer\n                            minHealthPercent:\n                              format: int32\n                              type: integer\n                            splitExternalLocalOriginErrors:\n                              description: Determines whether to distinguish local\n                                origin failures from external errors.\n                              type: boolean\n                          type: object\n                        portLevelSettings:\n                          description: Traffic policies specific to individual ports.\n                          items:\n                            properties:\n                              connectionPool:\n                                properties:\n                                  http:\n                                    description: HTTP connection pool settings.\n                                    properties:\n                                      h2UpgradePolicy:\n                                        description: Specify if http1.1 connection\n                                          should be upgraded to http2 for the associated\n                                          destination.\n                                        enum:\n                                        DEFAULT\n                                        DONOTUPGRADE\n                                        UPGRADE\n                                        type: string\n                                      http1MaxPendingRequests:\n                                        description: Maximum number of pending HTTP\n                                          requests to a destination.\n                                        format: int32\n                                        type: integer\n                                      http2MaxRequests:\n                                        description: Maximum number of requests to\n                                          a backend.\n                                        format: int32\n                                        type: integer\n                                      idleTimeout:\n                                        description: The idle timeout for upstream\n                                          connection pool connections.\n                                        type: string\n                                      maxRequestsPerConnection:\n                                        description: Maximum number of requests per\n                                          connection to a backend.\n                                        format: int32\n                                        type: integer\n                                      maxRetries:\n                                        format: int32\n                                        type: integer\n                                      useClientProtocol:\n                                        description: If set to true, client protocol\n                                          will be preserved while initiating connection\n                                          to backend.\n                                        type: boolean\n                                    type: object\n                                  tcp:\n                                    description: Settings common to both HTTP and\n                                      TCP upstream connections.\n                                    properties:\n                                      connectTimeout:\n                                        description: TCP connection timeout.\n                                        type: string\n                                      maxConnections:\n                                        description: Maximum number of HTTP1 /TCP\n                                          connections to a destination host.\n                                        format: int32\n                                        type: integer\n                                      tcpKeepalive:\n                                        description: If set then set SO_KEEPALIVE\n                                          on the socket to enable TCP Keepalives.\n                                        properties:\n                                          interval:\n                                            description: The time duration between\n                                              keep-alive probes.\n                                            type: string\n                                          probes:\n                                            type: integer\n                                          time:\n                                            type: string\n                                        type: object\n                                    type: object\n                                type: object\n                              loadBalancer:\n                                description: Settings controlling the load balancer\n                                  algorithms.\n                                oneOf:\n                                not:\n                                    anyOf:\n                                    required:\n                                      simple\n                                    properties:\n                                        consistentHash:\n                                          oneOf:\n                                          not:\n                                              anyOf:\n                                              required:\n                                                httpHeaderName\n                                              required:\n                                                httpCookie\n                                              required:\n                                                useSourceIp\n                                              required:\n                                                httpQueryParameterName\n                                          required:\n                                            httpHeaderName\n                                          required:\n                                            httpCookie\n                                          required:\n                                            useSourceIp\n                                          required:\n                                            httpQueryParameterName\n                                      required:\n                                      consistentHash\n                                required:\n                                  simple\n                                properties:\n                                    consistentHash:\n                                      oneOf:\n                                      not:\n                                          anyOf:\n                                          required:\n                                            httpHeaderName\n                                          required:\n                                            httpCookie\n                                          required:\n                                            useSourceIp\n                                          required:\n                                            httpQueryParameterName\n                                      required:\n                                        httpHeaderName\n                                      required:\n                                        httpCookie\n                                      required:\n                                        useSourceIp\n                                      required:\n                                        httpQueryParameterName\n                                  required:\n                                  consistentHash\n                                properties:\n                                  consistentHash:\n                                    properties:\n                                      httpCookie:\n                                        description: Hash based on HTTP cookie.\n                                        properties:\n                                          name:\n                                            description: Name of the cookie.\n                                            type: string\n                                          path:\n                                            description: Path to set for the cookie.\n                                            type: string\n                                          ttl:\n                                            description: Lifetime of the cookie.\n                                            type: string\n                                        type: object\n                                      httpHeaderName:\n                                        description: Hash based on a specific HTTP\n                                          header.\n                                        type: string\n                                      httpQueryParameterName:\n                                        description: Hash based on a specific HTTP\n                                          query parameter.\n                                        type: string\n                                      minimumRingSize:\n                                        type: integer\n                                      useSourceIp:\n                                        description: Hash based on the source IP address.\n                                        type: boolean\n                                    type: object\n                                  localityLbSetting:\n                                    properties:\n                                      distribute:\n                                        description: 'Optional: only one of distribute,\n                                          failover or failoverPriority can be set.'\n                                        items:\n                                          properties:\n                                            from:\n                                              description: Originating locality, '/'\n                                                separated, e.g.\n                                              type: string\n                                            to:\n                                              additionalProperties:\n                                                type: integer\n                                              description: Map of upstream localities\n                                                to traffic distribution weights.\n                                              type: object\n                                          type: object\n                                        type: array\n                                      enabled:\n                                        description: enable locality load balancing,\n                                          this is DestinationRule-level and will override\n                                          mesh wide settings in entirety.\n                                        nullable: true\n                                        type: boolean\n                                      failover:\n                                        description: 'Optional: only one of distribute,\n                                          failover or failoverPriority can be set.'\n                                        items:\n                                          properties:\n                                            from:\n                                              description: Originating region.\n                                              type: string\n                                            to:\n                                              type: string\n                                          type: object\n                                        type: array\n                                      failoverPriority:\n                                        description: failoverPriority is an ordered\n                                          list of labels used to sort endpoints to\n                                          do priority based load balancing.\n                                        items:\n                                          type: string\n                                        type: array\n                                    type: object\n                                  simple:\n                                    enum:\n                                    ROUND_ROBIN\n                                    LEAST_CONN\n                                    RANDOM\n                                    PASSTHROUGH\n                                    type: string\n                                type: object\n                              outlierDetection:\n                                properties:\n                                  baseEjectionTime:\n                                    description: Minimum ejection duration.\n                                    type: string\n                                  consecutive5xxErrors:\n                                    description: Number of 5xx errors before a host\n                                      is ejected from the connection pool.\n                                    nullable: true\n                                    type: integer\n                                  consecutiveErrors:\n                                    format: int32\n                                    type: integer\n                                  consecutiveGatewayErrors:\n                                    description: Number of gateway errors before a\n                                      host is ejected from the connection pool.\n                                    nullable: true\n                                    type: integer\n                                  consecutiveLocalOriginFailures:\n                                    nullable: true\n                                    type: integer\n                                  interval:\n                                    description: Time interval between ejection sweep\n                                      analysis.\n                                    type: string\n                                  maxEjectionPercent:\n                                    format: int32\n                                    type: integer\n                                  minHealthPercent:\n                                    format: int32\n                                    type: integer\n                                  splitExternalLocalOriginErrors:\n                                    description: Determines whether to distinguish\n                                      local origin failures from external errors.\n                                    type: boolean\n                                type: object\n                              port:\n                                properties:\n                                  number:\n                                    type: integer\n                                type: object\n                              tls:\n                                description: TLS related settings for connections\n                                  to the upstream service.\n                                properties:\n                                  caCertificates:\n                                    type: string\n                                  clientCertificate:\n                                    description: REQUIRED if mode is MUTUAL.\n                                    type: string\n                                  credentialName:\n                                    type: string\n                                  insecureSkipVerify:\n                                    nullable: true\n                                    type: boolean\n                                  mode:\n                                    enum:\n                                    DISABLE\n                                    SIMPLE\n                                    MUTUAL\n                                    ISTIO_MUTUAL\n                                    type: string\n                                  privateKey:\n                                    description: REQUIRED if mode is MUTUAL.\n                                    type: string\n                                  sni:\n                                    description: SNI string to present to the server\n                                      during TLS handshake.\n                                    type: string\n                                  subjectAltNames:\n                                    items:\n                                      type: string\n                                    type: array\n                                type: object\n                            type: object\n                          type: array\n                        tls:\n                          description: TLS related settings for connections to the\n                            upstream service.\n                          properties:\n                            caCertificates:\n                              type: string\n                            clientCertificate:\n                              description: REQUIRED if mode is MUTUAL.\n                              type: string\n                            credentialName:\n                              type: string\n                            insecureSkipVerify:\n                              nullable: true\n                              type: boolean\n                            mode:\n                              enum:\n                              DISABLE\n                              SIMPLE\n                              MUTUAL\n                              ISTIO_MUTUAL\n                              type: string\n                            privateKey:\n                              description: REQUIRED if mode is MUTUAL.\n                              type: string\n                            sni:\n                              description: SNI string to present to the server during\n                                TLS handshake.\n                              type: string\n                            subjectAltNames:\n                              items:\n                                type: string\n                              type: array\n                          type: object\n                      type: object\n                  type: object\n                type: array\n              trafficPolicy:\n                properties:\n                  connectionPool:\n                    properties:\n                      http:\n                        description: HTTP connection pool settings.\n                        properties:\n                          h2UpgradePolicy:\n                            description: Specify if http1.1 connection should be upgraded\n                              to http2 for the associated destination.\n                            enum:\n                            DEFAULT\n                            DONOTUPGRADE\n                            UPGRADE\n                            type: string\n                          http1MaxPendingRequests:\n                            description: Maximum number of pending HTTP requests to\n                              a destination.\n                            format: int32\n                            type: integer\n                          http2MaxRequests:\n                            description: Maximum number of requests to a backend.\n                            format: int32\n                            type: integer\n                          idleTimeout:\n                            description: The idle timeout for upstream connection\n                              pool connections.\n                            type: string\n                          maxRequestsPerConnection:\n                            description: Maximum number of requests per connection\n                              to a backend.\n                            format: int32\n                            type: integer\n                          maxRetries:\n                            format: int32\n                            type: integer\n                          useClientProtocol:\n                            description: If set to true, client protocol will be preserved\n                              while initiating connection to backend.\n                            type: boolean\n                        type: object\n                      tcp:\n                        description: Settings common to both HTTP and TCP upstream\n                          connections.\n                        properties:\n                          connectTimeout:\n                            description: TCP connection timeout.\n                            type: string\n                          maxConnections:\n                            description: Maximum number of HTTP1 /TCP connections\n                              to a destination host.\n                            format: int32\n                            type: integer\n                          tcpKeepalive:\n                            description: If set then set SO_KEEPALIVE on the socket\n                              to enable TCP Keepalives.\n                            properties:\n                              interval:\n                                description: The time duration between keep-alive\n                                  probes.\n                                type: string\n                              probes:\n                                type: integer\n                              time:\n                                type: string\n                            type: object\n                        type: object\n                    type: object\n                  loadBalancer:\n                    description: Settings controlling the load balancer algorithms.\n                    oneOf:\n                    not:\n                        anyOf:\n                        required:\n                          simple\n                        properties:\n                            consistentHash:\n                              oneOf:\n                              not:\n                                  anyOf:\n                                  required:\n                                    httpHeaderName\n                                  required:\n                                    httpCookie\n                                  required:\n                                    useSourceIp\n                                  required:\n                                    httpQueryParameterName\n                              required:\n                                httpHeaderName\n                              required:\n                                httpCookie\n                              required:\n                                useSourceIp\n                              required:\n                                httpQueryParameterName\n                          required:\n                          consistentHash\n                    required:\n                      simple\n                    properties:\n                        consistentHash:\n                          oneOf:\n                          not:\n                              anyOf:\n                              required:\n                                httpHeaderName\n                              required:\n                                httpCookie\n                              required:\n                                useSourceIp\n                              required:\n                                httpQueryParameterName\n                          required:\n                            httpHeaderName\n                          required:\n                            httpCookie\n                          required:\n                            useSourceIp\n                          required:\n                            httpQueryParameterName\n                      required:\n                      consistentHash\n                    properties:\n                      consistentHash:\n                        properties:\n                          httpCookie:\n                            description: Hash based on HTTP cookie.\n                            properties:\n                              name:\n                                description: Name of the cookie.\n                                type: string\n                              path:\n                                description: Path to set for the cookie.\n                                type: string\n                              ttl:\n                                description: Lifetime of the cookie.\n                                type: string\n                            type: object\n                          httpHeaderName:\n                            description: Hash based on a specific HTTP header.\n                            type: string\n                          httpQueryParameterName:\n                            description: Hash based on a specific HTTP query parameter.\n                            type: string\n                          minimumRingSize:\n                            type: integer\n                          useSourceIp:\n                            description: Hash based on the source IP address.\n                            type: boolean\n                        type: object\n                      localityLbSetting:\n                        properties:\n                          distribute:\n                            description: 'Optional: only one of distribute, failover\n                              or failoverPriority can be set.'\n                            items:\n                              properties:\n                                from:\n                                  description: Originating locality, '/' separated,\n                                    e.g.\n                                  type: string\n                                to:\n                                  additionalProperties:\n                                    type: integer\n                                  description: Map of upstream localities to traffic\n                                    distribution weights.\n                                  type: object\n                              type: object\n                            type: array\n                          enabled:\n                            description: enable locality load balancing, this is DestinationRule-level\n                              and will override mesh wide settings in entirety.\n                            nullable: true\n                            type: boolean\n                          failover:\n                            description: 'Optional: only one of distribute, failover\n                              or failoverPriority can be set.'\n                            items:\n                              properties:\n                                from:\n                                  description: Originating region.\n                                  type: string\n                                to:\n                                  type: string\n                              type: object\n                            type: array\n                          failoverPriority:\n                            description: failoverPriority is an ordered list of labels\n                              used to sort endpoints to do priority based load balancing.\n                            items:\n                              type: string\n                            type: array\n                        type: object\n                      simple:\n                        enum:\n                        ROUND_ROBIN\n                        LEAST_CONN\n                        RANDOM\n                        PASSTHROUGH\n                        type: string\n                    type: object\n                  outlierDetection:\n                    properties:\n                      baseEjectionTime:\n                        description: Minimum ejection duration.\n                        type: string\n                      consecutive5xxErrors:\n                        description: Number of 5xx errors before a host is ejected\n                          from the connection pool.\n                        nullable: true\n                        type: integer\n                      consecutiveErrors:\n                        format: int32\n                        type: integer\n                      consecutiveGatewayErrors:\n                        description: Number of gateway errors before a host is ejected\n                          from the connection pool.\n                        nullable: true\n                        type: integer\n                      consecutiveLocalOriginFailures:\n                        nullable: true\n                        type: integer\n                      interval:\n                        description: Time interval between ejection sweep analysis.\n                        type: string\n                      maxEjectionPercent:\n                        format: int32\n                        type: integer\n                      minHealthPercent:\n                        format: int32\n                        type: integer\n                      splitExternalLocalOriginErrors:\n                        description: Determines whether to distinguish local origin\n                          failures from external errors.\n                        type: boolean\n                    type: object\n                  portLevelSettings:\n                    description: Traffic policies specific to individual ports.\n                    items:\n                      properties:\n                        connectionPool:\n                          properties:\n                            http:\n                              description: HTTP connection pool settings.\n                              properties:\n                                h2UpgradePolicy:\n                                  description: Specify if http1.1 connection should\n                                    be upgraded to http2 for the associated destination.\n                                  enum:\n                                  DEFAULT\n                                  DONOTUPGRADE\n                                  UPGRADE\n                                  type: string\n                                http1MaxPendingRequests:\n                                  description: Maximum number of pending HTTP requests\n                                    to a destination.\n                                  format: int32\n                                  type: integer\n                                http2MaxRequests:\n                                  description: Maximum number of requests to a backend.\n                                  format: int32\n                                  type: integer\n                                idleTimeout:\n                                  description: The idle timeout for upstream connection\n                                    pool connections.\n                                  type: string\n                                maxRequestsPerConnection:\n                                  description: Maximum number of requests per connection\n                                    to a backend.\n                                  format: int32\n                                  type: integer\n                                maxRetries:\n                                  format: int32\n                                  type: integer\n                                useClientProtocol:\n                                  description: If set to true, client protocol will\n                                    be preserved while initiating connection to backend.\n                                  type: boolean\n                              type: object\n                            tcp:\n                              description: Settings common to both HTTP and TCP upstream\n                                connections.\n                              properties:\n                                connectTimeout:\n                                  description: TCP connection timeout.\n                                  type: string\n                                maxConnections:\n                                  description: Maximum number of HTTP1 /TCP connections\n                                    to a destination host.\n                                  format: int32\n                                  type: integer\n                                tcpKeepalive:\n                                  description: If set then set SO_KEEPALIVE on the\n                                    socket to enable TCP Keepalives.\n                                  properties:\n                                    interval:\n                                      description: The time duration between keep-alive\n                                        probes.\n                                      type: string\n                                    probes:\n                                      type: integer\n                                    time:\n                                      type: string\n                                  type: object\n                              type: object\n                          type: object\n                        loadBalancer:\n                          description: Settings controlling the load balancer algorithms.\n                          oneOf:\n                          not:\n                              anyOf:\n                              required:\n                                simple\n                              properties:\n                                  consistentHash:\n                                    oneOf:\n                                    not:\n                                        anyOf:\n                                        required:\n                                          httpHeaderName\n                                        required:\n                                          httpCookie\n                                        required:\n                                          useSourceIp\n                                        required:\n                                          httpQueryParameterName\n                                    required:\n                                      httpHeaderName\n                                    required:\n                                      httpCookie\n                                    required:\n                                      useSourceIp\n                                    required:\n                                      httpQueryParameterName\n                                required:\n                                consistentHash\n                          required:\n                            simple\n                          properties:\n                              consistentHash:\n                                oneOf:\n                                not:\n                                    anyOf:\n                                    required:\n                                      httpHeaderName\n                                    required:\n                                      httpCookie\n                                    required:\n                                      useSourceIp\n                                    required:\n                                      httpQueryParameterName\n                                required:\n                                  httpHeaderName\n                                required:\n                                  httpCookie\n                                required:\n                                  useSourceIp\n                                required:\n                                  httpQueryParameterName\n                            required:\n                            consistentHash\n                          properties:\n                            consistentHash:\n                              properties:\n                                httpCookie:\n                                  description: Hash based on HTTP cookie.\n                                  properties:\n                                    name:\n                                      description: Name of the cookie.\n                                      type: string\n                                    path:\n                                      description: Path to set for the cookie.\n                                      type: string\n                                    ttl:\n                                      description: Lifetime of the cookie.\n                                      type: string\n                                  type: object\n                                httpHeaderName:\n                                  description: Hash based on a specific HTTP header.\n                                  type: string\n                                httpQueryParameterName:\n                                  description: Hash based on a specific HTTP query\n                                    parameter.\n                                  type: string\n                                minimumRingSize:\n                                  type: integer\n                                useSourceIp:\n                                  description: Hash based on the source IP address.\n                                  type: boolean\n                              type: object\n                            localityLbSetting:\n                              properties:\n                                distribute:\n                                  description: 'Optional: only one of distribute,\n                                    failover or failoverPriority can be set.'\n                                  items:\n                                    properties:\n                                      from:\n                                        description: Originating locality, '/' separated,\n                                          e.g.\n                                        type: string\n                                      to:\n                                        additionalProperties:\n                                          type: integer\n                                        description: Map of upstream localities to\n                                          traffic distribution weights.\n                                        type: object\n                                    type: object\n                                  type: array\n                                enabled:\n                                  description: enable locality load balancing, this\n                                    is DestinationRule-level and will override mesh\n                                    wide settings in entirety.\n                                  nullable: true\n                                  type: boolean\n                                failover:\n                                  description: 'Optional: only one of distribute,\n                                    failover or failoverPriority can be set.'\n                                  items:\n                                    properties:\n                                      from:\n                                        description: Originating region.\n                                        type: string\n                                      to:\n                                        type: string\n                                    type: object\n                                  type: array\n                                failoverPriority:\n                                  description: failoverPriority is an ordered list\n                                    of labels used to sort endpoints to do priority\n                                    based load balancing.\n                                  items:\n                                    type: string\n                                  type: array\n                              type: object\n                            simple:\n                              enum:\n                              ROUND_ROBIN\n                              LEAST_CONN\n                              RANDOM\n                              PASSTHROUGH\n                              type: string\n                          type: object\n                        outlierDetection:\n                          properties:\n                            baseEjectionTime:\n                              description: Minimum ejection duration.\n                              type: string\n                            consecutive5xxErrors:\n                              description: Number of 5xx errors before a host is ejected\n                                from the connection pool.\n                              nullable: true\n                              type: integer\n                            consecutiveErrors:\n                              format: int32\n                              type: integer\n                            consecutiveGatewayErrors:\n                              description: Number of gateway errors before a host\n                                is ejected from the connection pool.\n                              nullable: true\n                              type: integer\n                            consecutiveLocalOriginFailures:\n                              nullable: true\n                              type: integer\n                            interval:\n                              description: Time interval between ejection sweep analysis.\n                              type: string\n                            maxEjectionPercent:\n                              format: int32\n                              type: integer\n                            minHealthPercent:\n                              format: int32\n                              type: integer\n                            splitExternalLocalOriginErrors:\n                              description: Determines whether to distinguish local\n                                origin failures from external errors.\n                              type: boolean\n                          type: object\n                        port:\n                          properties:\n                            number:\n                              type: integer\n                          type: object\n                        tls:\n                          description: TLS related settings for connections to the\n                            upstream service.\n                          properties:\n                            caCertificates:\n                              type: string\n                            clientCertificate:\n                              description: REQUIRED if mode is MUTUAL.\n                              type: string\n                            credentialName:\n                              type: string\n                            insecureSkipVerify:\n                              nullable: true\n                              type: boolean\n                            mode:\n                              enum:\n                              DISABLE\n                              SIMPLE\n                              MUTUAL\n                              ISTIO_MUTUAL\n                              type: string\n                            privateKey:\n                              description: REQUIRED if mode is MUTUAL.\n                              type: string\n                            sni:\n                              description: SNI string to present to the server during\n                                TLS handshake.\n                              type: string\n                            subjectAltNames:\n                              items:\n                                type: string\n                              type: array\n                          type: object\n                      type: object\n                    type: array\n                  tls:\n                    description: TLS related settings for connections to the upstream\n                      service.\n                    properties:\n                      caCertificates:\n                        type: string\n                      clientCertificate:\n                        description: REQUIRED if mode is MUTUAL.\n                        type: string\n                      credentialName:\n                        type: string\n                      insecureSkipVerify:\n                        nullable: true\n                        type: boolean\n                      mode:\n                        enum:\n                        DISABLE\n                        SIMPLE\n                        MUTUAL\n                        ISTIO_MUTUAL\n                        type: string\n                      privateKey:\n                        description: REQUIRED if mode is MUTUAL.\n                        type: string\n                      sni:\n                        description: SNI string to present to the server during TLS\n                          handshake.\n                        type: string\n                      subjectAltNames:\n                        items:\n                          type: string\n                        type: array\n                    type: object\n                type: object\n            type: object\n          status:\n            type: object\n            x-kubernetes-preserve-unknown-fields: true\n        type: object\n    served: true\n    storage: false\n    subresources:\n      status: {}\n---\nSource: base/templates/crds.yaml\napiVersion: apiextensions.k8s.io/v1\nkind: CustomResourceDefinition\nmetadata:\n  annotations:\n    \"helm.sh/resource-policy\": keep\n  labels:\n    app: istio-pilot\n    chart: istio\n    heritage: Tiller\n    release: istio\n  name: envoyfilters.networking.istio.io\nspec:\n  group: networking.istio.io\n  names:\n    categories:\n    istio-io\n    networking-istio-io\n    kind: EnvoyFilter\n    listKind: EnvoyFilterList\n    plural: envoyfilters\n    singular: envoyfilter\n  scope: Namespaced\n  versions:\n  name: v1alpha3\n    schema:\n      openAPIV3Schema:\n        properties:\n          spec:\n            description: 'Customizing Envoy configuration generated by Istio. See\n              more details at: https://istio.io/docs/reference/config/networking/envoy-filter.html'\n            properties:\n              configPatches:\n                description: One or more patches with match conditions.\n                items:\n                  properties:\n                    applyTo:\n                      enum:\n                      INVALID\n                      LISTENER\n                      FILTER_CHAIN\n                      NETWORK_FILTER\n                      HTTP_FILTER\n                      ROUTE_CONFIGURATION\n                      VIRTUAL_HOST\n                      HTTP_ROUTE\n                      CLUSTER\n                      EXTENSION_CONFIG\n                      BOOTSTRAP\n                      type: string\n                    match:\n                      description: Match on listener/route configuration/cluster.\n                      oneOf:\n                      not:\n                          anyOf:\n                          required:\n                            listener\n                          required:\n                            routeConfiguration\n                          required:\n                            cluster\n                      required:\n                        listener\n                      required:\n                        routeConfiguration\n                      required:\n                        cluster\n                      properties:\n                        cluster:\n                          description: Match on envoy cluster attributes.\n                          properties:\n                            name:\n                              description: The exact name of the cluster to match.\n                              type: string\n                            portNumber:\n                              description: The service port for which this cluster\n                                was generated.\n                              type: integer\n                            service:\n                              description: The fully qualified service name for this\n                                cluster.\n                              type: string\n                            subset:\n                              description: The subset associated with the service.\n                              type: string\n                          type: object\n                        context:\n                          description: The specific config generation context to match\n                            on.\n                          enum:\n                          ANY\n                          SIDECAR_INBOUND\n                          SIDECAR_OUTBOUND\n                          GATEWAY\n                          type: string\n                        listener:\n                          description: Match on envoy listener attributes.\n                          properties:\n                            filterChain:\n                              description: Match a specific filter chain in a listener.\n                              properties:\n                                applicationProtocols:\n                                  description: Applies only to sidecars.\n                                  type: string\n                                destinationPort:\n                                  description: The destination_port value used by\n                                    a filter chain's match condition.\n                                  type: integer\n                                filter:\n                                  description: The name of a specific filter to apply\n                                    the patch to.\n                                  properties:\n                                    name:\n                                      description: The filter name to match on.\n                                      type: string\n                                    subFilter:\n                                      properties:\n                                        name:\n                                          description: The filter name to match on.\n                                          type: string\n                                      type: object\n                                  type: object\n                                name:\n                                  description: The name assigned to the filter chain.\n                                  type: string\n                                sni:\n                                  description: The SNI value used by a filter chain's\n                                    match condition.\n                                  type: string\n                                transportProtocol:\n                                  description: Applies only to SIDECAR_INBOUND context.\n                                  type: string\n                              type: object\n                            name:\n                              description: Match a specific listener by its name.\n                              type: string\n                            portName:\n                              type: string\n                            portNumber:\n                              type: integer\n                          type: object\n                        proxy:\n                          description: Match on properties associated with a proxy.\n                          properties:\n                            metadata:\n                              additionalProperties:\n                                type: string\n                              type: object\n                            proxyVersion:\n                              type: string\n                          type: object\n                        routeConfiguration:\n                          description: Match on envoy HTTP route configuration attributes.\n                          properties:\n                            gateway:\n                              type: string\n                            name:\n                              description: Route configuration name to match on.\n                              type: string\n                            portName:\n                              description: Applicable only for GATEWAY context.\n                              type: string\n                            portNumber:\n                              type: integer\n                            vhost:\n                              properties:\n                                name:\n                                  type: string\n                                route:\n                                  description: Match a specific route within the virtual\n                                    host.\n                                  properties:\n                                    action:\n                                      description: Match a route with specific action\n                                        type.\n                                      enum:\n                                      ANY\n                                      ROUTE\n                                      REDIRECT\n                                      DIRECT_RESPONSE\n                                      type: string\n                                    name:\n                                      type: string\n                                  type: object\n                              type: object\n                          type: object\n                      type: object\n                    patch:\n                      description: The patch to apply along with the operation.\n                      properties:\n                        filterClass:\n                          description: Determines the filter insertion order.\n                          enum:\n                          UNSPECIFIED\n                          AUTHN\n                          AUTHZ\n                          STATS\n                          type: string\n                        operation:\n                          description: Determines how the patch should be applied.\n                          enum:\n                          INVALID\n                          MERGE\n                          ADD\n                          REMOVE\n                          INSERT_BEFORE\n                          INSERT_AFTER\n                          INSERT_FIRST\n                          REPLACE\n                          type: string\n                        value:\n                          description: The JSON config of the object being patched.\n                          type: object\n                          x-kubernetes-preserve-unknown-fields: true\n                      type: object\n                  type: object\n                type: array\n              priority:\n                description: Priority defines the order in which patch sets are applied\n                  within a context.\n                format: int32\n                type: integer\n              workloadSelector:\n                properties:\n                  labels:\n                    additionalProperties:\n                      type: string\n                    type: object\n                type: object\n            type: object\n          status:\n            type: object\n            x-kubernetes-preserve-unknown-fields: true\n        type: object\n    served: true\n    storage: true\n    subresources:\n      status: {}\n---\n Source: base/templates/crds.yaml\napiVersion: apiextensions.k8s.io/v1\nkind: CustomResourceDefinition\nmetadata:\n  annotations:\n    \"helm.sh/resource-policy\": keep\n  labels:\n    app: istio-pilot\n    chart: istio\n    heritage: Tiller\n    release: istio\n  name: gateways.networking.istio.io\nspec:\n  group: networking.istio.io\n  names:\n    categories:\n    istio-io\n    networking-istio-io\n    kind: Gateway\n    listKind: GatewayList\n    plural: gateways\n    shortNames:\n    gw\n    singular: gateway\n  scope: Namespaced\n  versions:\n  name: v1alpha3\n    schema:\n      openAPIV3Schema:\n        properties:\n          spec:\n            description: 'Configuration affecting edge load balancer. See more details\n              at: https://istio.io/docs/reference/config/networking/gateway.html'\n            properties:\n              selector:\n                additionalProperties:\n                  type: string\n                type: object\n              servers:\n                description: A list of server specifications.\n                items:\n                  properties:\n                    bind:\n                      type: string\n                    defaultEndpoint:\n                      type: string\n                    hosts:\n                      description: One or more hosts exposed by this gateway.\n                      items:\n                        type: string\n                      type: array\n                    name:\n                      description: An optional name of the server, when set must be\n                        unique across all servers.\n                      type: string\n                    port:\n                      properties:\n                        name:\n                          description: Label assigned to the port.\n                          type: string\n                        number:\n                          description: A valid non-negative integer port number.\n                          type: integer\n                        protocol:\n                          description: The protocol exposed on the port.\n                          type: string\n                        targetPort:\n                          type: integer\n                      type: object\n                    tls:\n                      description: Set of TLS related options that govern the server's\n                        behavior.\n                      properties:\n                        caCertificates:\n                          description: REQUIRED if mode is MUTUAL.\n                          type: string\n                        cipherSuites:\n                          description: 'Optional: If specified, only support the specified\n                            cipher list.'\n                          items:\n                            type: string\n                          type: array\n                        credentialName:\n                          type: string\n                        httpsRedirect:\n                          type: boolean\n                        maxProtocolVersion:\n                          description: 'Optional: Maximum TLS protocol version.'\n                          enum:\n                          TLS_AUTO\n                          TLSV1_0\n                          TLSV1_1\n                          TLSV1_2\n                          TLSV1_3\n                          type: string\n                        minProtocolVersion:\n                          description: 'Optional: Minimum TLS protocol version.'\n                          enum:\n                          TLS_AUTO\n                          TLSV1_0\n                          TLSV1_1\n                          TLSV1_2\n                          TLSV1_3\n                          type: string\n                        mode:\n                          enum:\n                          PASSTHROUGH\n                          SIMPLE\n                          MUTUAL\n                          AUTO_PASSTHROUGH\n                          ISTIO_MUTUAL\n                          type: string\n                        privateKey:\n                          description: REQUIRED if mode is SIMPLE or MUTUAL.\n                          type: string\n                        serverCertificate:\n                          description: REQUIRED if mode is SIMPLE or MUTUAL.\n                          type: string\n                        subjectAltNames:\n                          items:\n                            type: string\n                          type: array\n                        verifyCertificateHash:\n                          items:\n                            type: string\n                          type: array\n                        verifyCertificateSpki:\n                          items:\n                            type: string\n                          type: array\n                      type: object\n                  type: object\n                type: array\n            type: object\n          status:\n            type: object\n            x-kubernetes-preserve-unknown-fields: true\n        type: object\n    served: true\n    storage: true\n    subresources:\n      status: {}\n  name: v1beta1\n    schema:\n      openAPIV3Schema:\n        properties:\n          spec:\n            description: 'Configuration affecting edge load balancer. See more details\n              at: https://istio.io/docs/reference/config/networking/gateway.html'\n            properties:\n              selector:\n                additionalProperties:\n                  type: string\n                type: object\n              servers:\n                description: A list of server specifications.\n                items:\n                  properties:\n                    bind:\n                      type: string\n                    defaultEndpoint:\n                      type: string\n                    hosts:\n                      description: One or more hosts exposed by this gateway.\n                      items:\n                        type: string\n                      type: array\n                    name:\n                      description: An optional name of the server, when set must be\n                        unique across all servers.\n                      type: string\n                    port:\n                      properties:\n                        name:\n                          description: Label assigned to the port.\n                          type: string\n                        number:\n                          description: A valid non-negative integer port number.\n                          type: integer\n                        protocol:\n                          description: The protocol exposed on the port.\n                          type: string\n                        targetPort:\n                          type: integer\n                      type: object\n                    tls:\n                      description: Set of TLS related options that govern the server's\n                        behavior.\n                      properties:\n                        caCertificates:\n                          description: REQUIRED if mode is MUTUAL.\n                          type: string\n                        cipherSuites:\n                          description: 'Optional: If specified, only support the specified\n                            cipher list.'\n                          items:\n                            type: string\n                          type: array\n                        credentialName:\n                          type: string\n                        httpsRedirect:\n                          type: boolean\n                        maxProtocolVersion:\n                          description: 'Optional: Maximum TLS protocol version.'\n                          enum:\n                          TLS_AUTO\n                          TLSV1_0\n                          TLSV1_1\n                          TLSV1_2\n                          TLSV1_3\n                          type: string\n                        minProtocolVersion:\n                          description: 'Optional: Minimum TLS protocol version.'\n                          enum:\n                          TLS_AUTO\n                          TLSV1_0\n                          TLSV1_1\n                          TLSV1_2\n                          TLSV1_3\n                          type: string\n                        mode:\n                          enum:\n                          PASSTHROUGH\n                          SIMPLE\n                          MUTUAL\n                          AUTO_PASSTHROUGH\n                          ISTIO_MUTUAL\n                          type: string\n                        privateKey:\n                          description: REQUIRED if mode is SIMPLE or MUTUAL.\n                          type: string\n                        serverCertificate:\n                          description: REQUIRED if mode is SIMPLE or MUTUAL.\n                          type: string\n                        subjectAltNames:\n                          items:\n                            type: string\n                          type: array\n                        verifyCertificateHash:\n                          items:\n                            type: string\n                          type: array\n                        verifyCertificateSpki:\n                          items:\n                            type: string\n                          type: array\n                      type: object\n                  type: object\n                type: array\n            type: object\n          status:\n            type: object\n            x-kubernetes-preserve-unknown-fields: true\n        type: object\n    served: true\n    storage: false\n    subresources:\n      status: {}\n---\nSource: base/templates/crds.yaml\napiVersion: apiextensions.k8s.io/v1\nkind: CustomResourceDefinition\nmetadata:\n  annotations:\n    \"helm.sh/resource-policy\": keep\n  labels:\n    app: istio-pilot\n    chart: istio\n    heritage: Tiller\n    release: istio\n  name: proxyconfigs.networking.istio.io\nspec:\n  group: networking.istio.io\n  names:\n    categories:\n    istio-io\n    networking-istio-io\n    kind: ProxyConfig\n    listKind: ProxyConfigList\n    plural: proxyconfigs\n    singular: proxyconfig\n  scope: Namespaced\n  versions:\n  name: v1beta1\n    schema:\n      openAPIV3Schema:\n        properties:\n          spec:\n            description: 'Provides configuration for individual workloads. See more\n              details at: https://istio.io/docs/reference/config/networking/proxy-config.html'\n            properties:\n              concurrency:\n                description: The number of worker threads to run.\n                nullable: true\n                type: integer\n              environmentVariables:\n                additionalProperties:\n                  type: string\n                description: Additional environment variables for the proxy.\n                type: object\n              image:\n                description: Specifies the details of the proxy image.\n                properties:\n                  imageType:\n                    description: The image type of the image.\n                    type: string\n                type: object\n              selector:\n                description: Optional.\n                properties:\n                  matchLabels:\n                    additionalProperties:\n                      type: string\n                    type: object\n                type: object\n            type: object\n          status:\n            type: object\n            x-kubernetes-preserve-unknown-fields: true\n        type: object\n    served: true\n    storage: true\n    subresources:\n      status: {}\n---\n Source: base/templates/crds.yaml\napiVersion: apiextensions.k8s.io/v1\nkind: CustomResourceDefinition\nmetadata:\n  annotations:\n    \"helm.sh/resource-policy\": keep\n  labels:\n    app: istio-pilot\n    chart: istio\n    heritage: Tiller\n    release: istio\n  name: serviceentries.networking.istio.io\nspec:\n  group: networking.istio.io\n  names:\n    categories:\n    istio-io\n    networking-istio-io\n    kind: ServiceEntry\n    listKind: ServiceEntryList\n    plural: serviceentries\n    shortNames:\n    se\n    singular: serviceentry\n  scope: Namespaced\n  versions:\n  additionalPrinterColumns:\n    description: The hosts associated with the ServiceEntry\n      jsonPath: .spec.hosts\n      name: Hosts\n      type: string\n    description: Whether the service is external to the mesh or part of the mesh\n        (MESHEXTERNAL or MESHINTERNAL)\n      jsonPath: .spec.location\n      name: Location\n      type: string\n    description: Service discovery mode for the hosts (NONE, STATIC, or DNS)\n      jsonPath: .spec.resolution\n      name: Resolution\n      type: string\n    description: 'CreationTimestamp is a timestamp representing the server time\n        when this object was created. It is not guaranteed to be set in happens-before\n        order across separate operations. Clients may not set this value. It is represented\n        in RFC3339 form and is in UTC. Populated by the system. Read-only. Null for\n        lists. More info: https://git.k8s.io/community/contributors/devel/api-conventions.md#metadata'\n      jsonPath: .metadata.creationTimestamp\n      name: Age\n      type: date\n    name: v1alpha3\n    schema:\n      openAPIV3Schema:\n        properties:\n          spec:\n            description: 'Configuration affecting service registry. See more details\n              at: https://istio.io/docs/reference/config/networking/service-entry.html'\n            properties:\n              addresses:\n                description: The virtual IP addresses associated with the service.\n                items:\n                  type: string\n                type: array\n              endpoints:\n                description: One or more endpoints associated with the service.\n                items:\n                  properties:\n                    address:\n                      type: string\n                    labels:\n                      additionalProperties:\n                        type: string\n                      description: One or more labels associated with the endpoint.\n                      type: object\n                    locality:\n                      description: The locality associated with the endpoint.\n                      type: string\n                    network:\n                      type: string\n                    ports:\n                      additionalProperties:\n                        type: integer\n                      description: Set of ports associated with the endpoint.\n                      type: object\n                    serviceAccount:\n                      type: string\n                    weight:\n                      description: The load balancing weight associated with the endpoint.\n                      type: integer\n                  type: object\n                type: array\n              exportTo:\n                description: A list of namespaces to which this service is exported.\n                items:\n                  type: string\n                type: array\n              hosts:\n                description: The hosts associated with the ServiceEntry.\n                items:\n                  type: string\n                type: array\n              location:\n                enum:\n                MESH_EXTERNAL\n                MESH_INTERNAL\n                type: string\n              ports:\n                description: The ports associated with the external service.\n                items:\n                  properties:\n                    name:\n                      description: Label assigned to the port.\n                      type: string\n                    number:\n                      description: A valid non-negative integer port number.\n                      type: integer\n                    protocol:\n                      description: The protocol exposed on the port.\n                      type: string\n                    targetPort:\n                      type: integer\n                  type: object\n                type: array\n              resolution:\n                description: Service discovery mode for the hosts.\n                enum:\n                NONE\n                STATIC\n                DNS\n                DNSROUNDROBIN\n                type: string\n              subjectAltNames:\n                items:\n                  type: string\n                type: array\n              workloadSelector:\n                description: Applicable only for MESH_INTERNAL services.\n                properties:\n                  labels:\n                    additionalProperties:\n                      type: string\n                    type: object\n                type: object\n            type: object\n          status:\n            type: object\n            x-kubernetes-preserve-unknown-fields: true\n        type: object\n    served: true\n    storage: true\n    subresources:\n      status: {}\n  additionalPrinterColumns:\n    description: The hosts associated with the ServiceEntry\n      jsonPath: .spec.hosts\n      name: Hosts\n      type: string\n    description: Whether the service is external to the mesh or part of the mesh\n        (MESHEXTERNAL or MESHINTERNAL)\n      jsonPath: .spec.location\n      name: Location\n      type: string\n    description: Service discovery mode for the hosts (NONE, STATIC, or DNS)\n      jsonPath: .spec.resolution\n      name: Resolution\n      type: string\n    description: 'CreationTimestamp is a timestamp representing the server time\n        when this object was created. It is not guaranteed to be set in happens-before\n        order across separate operations. Clients may not set this value. It is represented\n        in RFC3339 form and is in UTC. Populated by the system. Read-only. Null for\n        lists. More info: https://git.k8s.io/community/contributors/devel/api-conventions.md#metadata'\n      jsonPath: .metadata.creationTimestamp\n      name: Age\n      type: date\n    name: v1beta1\n    schema:\n      openAPIV3Schema:\n        properties:\n          spec:\n            description: 'Configuration affecting service registry. See more details\n              at: https://istio.io/docs/reference/config/networking/service-entry.html'\n            properties:\n              addresses:\n                description: The virtual IP addresses associated with the service.\n                items:\n                  type: string\n                type: array\n              endpoints:\n                description: One or more endpoints associated with the service.\n                items:\n                  properties:\n                    address:\n                      type: string\n                    labels:\n                      additionalProperties:\n                        type: string\n                      description: One or more labels associated with the endpoint.\n                      type: object\n                    locality:\n                      description: The locality associated with the endpoint.\n                      type: string\n                    network:\n                      type: string\n                    ports:\n                      additionalProperties:\n                        type: integer\n                      description: Set of ports associated with the endpoint.\n                      type: object\n                    serviceAccount:\n                      type: string\n                    weight:\n                      description: The load balancing weight associated with the endpoint.\n                      type: integer\n                  type: object\n                type: array\n              exportTo:\n                description: A list of namespaces to which this service is exported.\n                items:\n                  type: string\n                type: array\n              hosts:\n                description: The hosts associated with the ServiceEntry.\n                items:\n                  type: string\n                type: array\n              location:\n                enum:\n                MESH_EXTERNAL\n                MESH_INTERNAL\n                type: string\n              ports:\n                description: The ports associated with the external service.\n                items:\n                  properties:\n                    name:\n                      description: Label assigned to the port.\n                      type: string\n                    number:\n                      description: A valid non-negative integer port number.\n                      type: integer\n                    protocol:\n                      description: The protocol exposed on the port.\n                      type: string\n                    targetPort:\n                      type: integer\n                  type: object\n                type: array\n              resolution:\n                description: Service discovery mode for the hosts.\n                enum:\n                NONE\n                STATIC\n                DNS\n                DNSROUNDROBIN\n                type: string\n              subjectAltNames:\n                items:\n                  type: string\n                type: array\n              workloadSelector:\n                description: Applicable only for MESH_INTERNAL services.\n                properties:\n                  labels:\n                    additionalProperties:\n                      type: string\n                    type: object\n                type: object\n            type: object\n          status:\n            type: object\n            x-kubernetes-preserve-unknown-fields: true\n        type: object\n    served: true\n    storage: false\n    subresources:\n      status: {}\n---\nSource: base/templates/crds.yaml\napiVersion: apiextensions.k8s.io/v1\nkind: CustomResourceDefinition\nmetadata:\n  annotations:\n    \"helm.sh/resource-policy\": keep\n  labels:\n    app: istio-pilot\n    chart: istio\n    heritage: Tiller\n    release: istio\n  name: sidecars.networking.istio.io\nspec:\n  group: networking.istio.io\n  names:\n    categories:\n    istio-io\n    networking-istio-io\n    kind: Sidecar\n    listKind: SidecarList\n    plural: sidecars\n    singular: sidecar\n  scope: Namespaced\n  versions:\n  name: v1alpha3\n    schema:\n      openAPIV3Schema:\n        properties:\n          spec:\n            description: 'Configuration affecting network reachability of a sidecar.\n              See more details at: https://istio.io/docs/reference/config/networking/sidecar.html'\n            properties:\n              egress:\n                items:\n                  properties:\n                    bind:\n                      type: string\n                    captureMode:\n                      enum:\n                      DEFAULT\n                      IPTABLES\n                      NONE\n                      type: string\n                    hosts:\n                      items:\n                        type: string\n                      type: array\n                    port:\n                      description: The port associated with the listener.\n                      properties:\n                        name:\n                          description: Label assigned to the port.\n                          type: string\n                        number:\n                          description: A valid non-negative integer port number.\n                          type: integer\n                        protocol:\n                          description: The protocol exposed on the port.\n                          type: string\n                        targetPort:\n                          type: integer\n                      type: object\n                  type: object\n                type: array\n              ingress:\n                items:\n                  properties:\n                    bind:\n                      description: The IP to which the listener should be bound.\n                      type: string\n                    captureMode:\n                      enum:\n                      DEFAULT\n                      IPTABLES\n                      NONE\n                      type: string\n                    defaultEndpoint:\n                      type: string\n                    port:\n                      description: The port associated with the listener.\n                      properties:\n                        name:\n                          description: Label assigned to the port.\n                          type: string\n                        number:\n                          description: A valid non-negative integer port number.\n                          type: integer\n                        protocol:\n                          description: The protocol exposed on the port.\n                          type: string\n                        targetPort:\n                          type: integer\n                      type: object\n                    tls:\n                      properties:\n                        caCertificates:\n                          description: REQUIRED if mode is MUTUAL.\n                          type: string\n                        cipherSuites:\n                          description: 'Optional: If specified, only support the specified\n                            cipher list.'\n                          items:\n                            type: string\n                          type: array\n                        credentialName:\n                          type: string\n                        httpsRedirect:\n                          type: boolean\n                        maxProtocolVersion:\n                          description: 'Optional: Maximum TLS protocol version.'\n                          enum:\n                          TLS_AUTO\n                          TLSV1_0\n                          TLSV1_1\n                          TLSV1_2\n                          TLSV1_3\n                          type: string\n                        minProtocolVersion:\n                          description: 'Optional: Minimum TLS protocol version.'\n                          enum:\n                          TLS_AUTO\n                          TLSV1_0\n                          TLSV1_1\n                          TLSV1_2\n                          TLSV1_3\n                          type: string\n                        mode:\n                          enum:\n                          PASSTHROUGH\n                          SIMPLE\n                          MUTUAL\n                          AUTO_PASSTHROUGH\n                          ISTIO_MUTUAL\n                          type: string\n                        privateKey:\n                          description: REQUIRED if mode is SIMPLE or MUTUAL.\n                          type: string\n                        serverCertificate:\n                          description: REQUIRED if mode is SIMPLE or MUTUAL.\n                          type: string\n                        subjectAltNames:\n                          items:\n                            type: string\n                          type: array\n                        verifyCertificateHash:\n                          items:\n                            type: string\n                          type: array\n                        verifyCertificateSpki:\n                          items:\n                            type: string\n                          type: array\n                      type: object\n                  type: object\n                type: array\n              outboundTrafficPolicy:\n                description: Configuration for the outbound traffic policy.\n                properties:\n                  egressProxy:\n                    properties:\n                      host:\n                        description: The name of a service from the service registry.\n                        type: string\n                      port:\n                        description: Specifies the port on the host that is being\n                          addressed.\n                        properties:\n                          number:\n                            type: integer\n                        type: object\n                      subset:\n                        description: The name of a subset within the service.\n                        type: string\n                    type: object\n                  mode:\n                    enum:\n                    REGISTRY_ONLY\n                    ALLOW_ANY\n                    type: string\n                type: object\n              workloadSelector:\n                properties:\n                  labels:\n                    additionalProperties:\n                      type: string\n                    type: object\n                type: object\n            type: object\n          status:\n            type: object\n            x-kubernetes-preserve-unknown-fields: true\n        type: object\n    served: true\n    storage: true\n    subresources:\n      status: {}\n  name: v1beta1\n    schema:\n      openAPIV3Schema:\n        properties:\n          spec:\n            description: 'Configuration affecting network reachability of a sidecar.\n              See more details at: https://istio.io/docs/reference/config/networking/sidecar.html'\n            properties:\n              egress:\n                items:\n                  properties:\n                    bind:\n                      type: string\n                    captureMode:\n                      enum:\n                      DEFAULT\n                      IPTABLES\n                      NONE\n                      type: string\n                    hosts:\n                      items:\n                        type: string\n                      type: array\n                    port:\n                      description: The port associated with the listener.\n                      properties:\n                        name:\n                          description: Label assigned to the port.\n                          type: string\n                        number:\n                          description: A valid non-negative integer port number.\n                          type: integer\n                        protocol:\n                          description: The protocol exposed on the port.\n                          type: string\n                        targetPort:\n                          type: integer\n                      type: object\n                  type: object\n                type: array\n              ingress:\n                items:\n                  properties:\n                    bind:\n                      description: The IP to which the listener should be bound.\n                      type: string\n                    captureMode:\n                      enum:\n                      DEFAULT\n                      IPTABLES\n                      NONE\n                      type: string\n                    defaultEndpoint:\n                      type: string\n                    port:\n                      description: The port associated with the listener.\n                      properties:\n                        name:\n                          description: Label assigned to the port.\n                          type: string\n                        number:\n                          description: A valid non-negative integer port number.\n                          type: integer\n                        protocol:\n                          description: The protocol exposed on the port.\n                          type: string\n                        targetPort:\n                          type: integer\n                      type: object\n                    tls:\n                      properties:\n                        caCertificates:\n                          description: REQUIRED if mode is MUTUAL.\n                          type: string\n                        cipherSuites:\n                          description: 'Optional: If specified, only support the specified\n                            cipher list.'\n                          items:\n                            type: string\n                          type: array\n                        credentialName:\n                          type: string\n                        httpsRedirect:\n                          type: boolean\n                        maxProtocolVersion:\n                          description: 'Optional: Maximum TLS protocol version.'\n                          enum:\n                          TLS_AUTO\n                          TLSV1_0\n                          TLSV1_1\n                          TLSV1_2\n                          TLSV1_3\n                          type: string\n                        minProtocolVersion:\n                          description: 'Optional: Minimum TLS protocol version.'\n                          enum:\n                          TLS_AUTO\n                          TLSV1_0\n                          TLSV1_1\n                          TLSV1_2\n                          TLSV1_3\n                          type: string\n                        mode:\n                          enum:\n                          PASSTHROUGH\n                          SIMPLE\n                          MUTUAL\n                          AUTO_PASSTHROUGH\n                          ISTIO_MUTUAL\n                          type: string\n                        privateKey:\n                          description: REQUIRED if mode is SIMPLE or MUTUAL.\n                          type: string\n                        serverCertificate:\n                          description: REQUIRED if mode is SIMPLE or MUTUAL.\n                          type: string\n                        subjectAltNames:\n                          items:\n                            type: string\n                          type: array\n                        verifyCertificateHash:\n                          items:\n                            type: string\n                          type: array\n                        verifyCertificateSpki:\n                          items:\n                            type: string\n                          type: array\n                      type: object\n                  type: object\n                type: array\n              outboundTrafficPolicy:\n                description: Configuration for the outbound traffic policy.\n                properties:\n                  egressProxy:\n                    properties:\n                      host:\n                        description: The name of a service from the service registry.\n                        type: string\n                      port:\n                        description: Specifies the port on the host that is being\n                          addressed.\n                        properties:\n                          number:\n                            type: integer\n                        type: object\n                      subset:\n                        description: The name of a subset within the service.\n                        type: string\n                    type: object\n                  mode:\n                    enum:\n                    REGISTRY_ONLY\n                    ALLOW_ANY\n                    type: string\n                type: object\n              workloadSelector:\n                properties:\n                  labels:\n                    additionalProperties:\n                      type: string\n                    type: object\n                type: object\n            type: object\n          status:\n            type: object\n            x-kubernetes-preserve-unknown-fields: true\n        type: object\n    served: true\n    storage: false\n    subresources:\n      status: {}\n---\n Source: base/templates/crds.yaml\napiVersion: apiextensions.k8s.io/v1\nkind: CustomResourceDefinition\nmetadata:\n  annotations:\n    \"helm.sh/resource-policy\": keep\n  labels:\n    app: istio-pilot\n    chart: istio\n    heritage: Tiller\n    release: istio\n  name: virtualservices.networking.istio.io\nspec:\n  group: networking.istio.io\n  names:\n    categories:\n    istio-io\n    networking-istio-io\n    kind: VirtualService\n    listKind: VirtualServiceList\n    plural: virtualservices\n    shortNames:\n    vs\n    singular: virtualservice\n  scope: Namespaced\n  versions:\n  additionalPrinterColumns:\n    description: The names of gateways and sidecars that should apply these routes\n      jsonPath: .spec.gateways\n      name: Gateways\n      type: string\n    description: The destination hosts to which traffic is being sent\n      jsonPath: .spec.hosts\n      name: Hosts\n      type: string\n    description: 'CreationTimestamp is a timestamp representing the server time\n        when this object was created. It is not guaranteed to be set in happens-before\n        order across separate operations. Clients may not set this value. It is represented\n        in RFC3339 form and is in UTC. Populated by the system. Read-only. Null for\n        lists. More info: https://git.k8s.io/community/contributors/devel/api-conventions.md#metadata'\n      jsonPath: .metadata.creationTimestamp\n      name: Age\n      type: date\n    name: v1alpha3\n    schema:\n      openAPIV3Schema:\n        properties:\n          spec:\n            description: 'Configuration affecting label/content routing, sni routing,\n              etc. See more details at: https://istio.io/docs/reference/config/networking/virtual-service.html'\n            properties:\n              exportTo:\n                description: A list of namespaces to which this virtual service is\n                  exported.\n                items:\n                  type: string\n                type: array\n              gateways:\n                description: The names of gateways and sidecars that should apply\n                  these routes.\n                items:\n                  type: string\n                type: array\n              hosts:\n                description: The destination hosts to which traffic is being sent.\n                items:\n                  type: string\n                type: array\n              http:\n                description: An ordered list of route rules for HTTP traffic.\n                items:\n                  properties:\n                    corsPolicy:\n                      description: Cross-Origin Resource Sharing policy (CORS).\n                      properties:\n                        allowCredentials:\n                          nullable: true\n                          type: boolean\n                        allowHeaders:\n                          items:\n                            type: string\n                          type: array\n                        allowMethods:\n                          description: List of HTTP methods allowed to access the\n                            resource.\n                          items:\n                            type: string\n                          type: array\n                        allowOrigin:\n                          description: The list of origins that are allowed to perform\n                            CORS requests.\n                          items:\n                            type: string\n                          type: array\n                        allowOrigins:\n                          description: String patterns that match allowed origins.\n                          items:\n                            oneOf:\n                            not:\n                                anyOf:\n                                required:\n                                  exact\n                                required:\n                                  prefix\n                                required:\n                                  regex\n                            required:\n                              exact\n                            required:\n                              prefix\n                            required:\n                              regex\n                            properties:\n                              exact:\n                                type: string\n                              prefix:\n                                type: string\n                              regex:\n                                description: RE2 style regex-based match (https://github.com/google/re2/wiki/Syntax).\n                                type: string\n                            type: object\n                          type: array\n                        exposeHeaders:\n                          items:\n                            type: string\n                          type: array\n                        maxAge:\n                          type: string\n                      type: object\n                    delegate:\n                      properties:\n                        name:\n                          description: Name specifies the name of the delegate VirtualService.\n                          type: string\n                        namespace:\n                          description: Namespace specifies the namespace where the\n                            delegate VirtualService resides.\n                          type: string\n                      type: object\n                    fault:\n                      description: Fault injection policy to apply on HTTP traffic\n                        at the client side.\n                      properties:\n                        abort:\n                          oneOf:\n                          not:\n                              anyOf:\n                              required:\n                                httpStatus\n                              required:\n                                grpcStatus\n                              required:\n                                http2Error\n                          required:\n                            httpStatus\n                          required:\n                            grpcStatus\n                          required:\n                            http2Error\n                          properties:\n                            grpcStatus:\n                              type: string\n                            http2Error:\n                              type: string\n                            httpStatus:\n                              description: HTTP status code to use to abort the Http\n                                request.\n                              format: int32\n                              type: integer\n                            percentage:\n                              description: Percentage of requests to be aborted with\n                                the error code provided.\n                              properties:\n                                value:\n                                  format: double\n                                  type: number\n                              type: object\n                          type: object\n                        delay:\n                          oneOf:\n                          not:\n                              anyOf:\n                              required:\n                                fixedDelay\n                              required:\n                                exponentialDelay\n                          required:\n                            fixedDelay\n                          required:\n                            exponentialDelay\n                          properties:\n                            exponentialDelay:\n                              type: string\n                            fixedDelay:\n                              description: Add a fixed delay before forwarding the\n                                request.\n                              type: string\n                            percent:\n                              description: Percentage of requests on which the delay\n                                will be injected (0-100).\n                              format: int32\n                              type: integer\n                            percentage:\n                              description: Percentage of requests on which the delay\n                                will be injected.\n                              properties:\n                                value:\n                                  format: double\n                                  type: number\n                              type: object\n                          type: object\n                      type: object\n                    headers:\n                      properties:\n                        request:\n                          properties:\n                            add:\n                              additionalProperties:\n                                type: string\n                              type: object\n                            remove:\n                              items:\n                                type: string\n                              type: array\n                            set:\n                              additionalProperties:\n                                type: string\n                              type: object\n                          type: object\n                        response:\n                          properties:\n                            add:\n                              additionalProperties:\n                                type: string\n                              type: object\n                            remove:\n                              items:\n                                type: string\n                              type: array\n                            set:\n                              additionalProperties:\n                                type: string\n                              type: object\n                          type: object\n                      type: object\n                    match:\n                      items:\n                        properties:\n                          authority:\n                            oneOf:\n                            not:\n                                anyOf:\n                                required:\n                                  exact\n                                required:\n                                  prefix\n                                required:\n                                  regex\n                            required:\n                              exact\n                            required:\n                              prefix\n                            required:\n                              regex\n                            properties:\n                              exact:\n                                type: string\n                              prefix:\n                                type: string\n                              regex:\n                                description: RE2 style regex-based match (https://github.com/google/re2/wiki/Syntax).\n                                type: string\n                            type: object\n                          gateways:\n                            description: Names of gateways where the rule should be\n                              applied.\n                            items:\n                              type: string\n                            type: array\n                          headers:\n                            additionalProperties:\n                              oneOf:\n                              not:\n                                  anyOf:\n                                  required:\n                                    exact\n                                  required:\n                                    prefix\n                                  required:\n                                    regex\n                              required:\n                                exact\n                              required:\n                                prefix\n                              required:\n                                regex\n                              properties:\n                                exact:\n                                  type: string\n                                prefix:\n                                  type: string\n                                regex:\n                                  description: RE2 style regex-based match (https://github.com/google/re2/wiki/Syntax).\n                                  type: string\n                              type: object\n                            type: object\n                          ignoreUriCase:\n                            description: Flag to specify whether the URI matching\n                              should be case-insensitive.\n                            type: boolean\n                          method:\n                            oneOf:\n                            not:\n                                anyOf:\n                                required:\n                                  exact\n                                required:\n                                  prefix\n                                required:\n                                  regex\n                            required:\n                              exact\n                            required:\n                              prefix\n                            required:\n                              regex\n                            properties:\n                              exact:\n                                type: string\n                              prefix:\n                                type: string\n                              regex:\n                                description: RE2 style regex-based match (https://github.com/google/re2/wiki/Syntax).\n                                type: string\n                            type: object\n                          name:\n                            description: The name assigned to a match.\n                            type: string\n                          port:\n                            description: Specifies the ports on the host that is being\n                              addressed.\n                            type: integer\n                          queryParams:\n                            additionalProperties:\n                              oneOf:\n                              not:\n                                  anyOf:\n                                  required:\n                                    exact\n                                  required:\n                                    prefix\n                                  required:\n                                    regex\n                              required:\n                                exact\n                              required:\n                                prefix\n                              required:\n                                regex\n                              properties:\n                                exact:\n                                  type: string\n                                prefix:\n                                  type: string\n                                regex:\n                                  description: RE2 style regex-based match (https://github.com/google/re2/wiki/Syntax).\n                                  type: string\n                              type: object\n                            description: Query parameters for matching.\n                            type: object\n                          scheme:\n                            oneOf:\n                            not:\n                                anyOf:\n                                required:\n                                  exact\n                                required:\n                                  prefix\n                                required:\n                                  regex\n                            required:\n                              exact\n                            required:\n                              prefix\n                            required:\n                              regex\n                            properties:\n                              exact:\n                                type: string\n                              prefix:\n                                type: string\n                              regex:\n                                description: RE2 style regex-based match (https://github.com/google/re2/wiki/Syntax).\n                                type: string\n                            type: object\n                          sourceLabels:\n                            additionalProperties:\n                              type: string\n                            type: object\n                          sourceNamespace:\n                            description: Source namespace constraining the applicability\n                              of a rule to workloads in that namespace.\n                            type: string\n                          uri:\n                            oneOf:\n                            not:\n                                anyOf:\n                                required:\n                                  exact\n                                required:\n                                  prefix\n                                required:\n                                  regex\n                            required:\n                              exact\n                            required:\n                              prefix\n                            required:\n                              regex\n                            properties:\n                              exact:\n                                type: string\n                              prefix:\n                                type: string\n                              regex:\n                                description: RE2 style regex-based match (https://github.com/google/re2/wiki/Syntax).\n                                type: string\n                            type: object\n                          withoutHeaders:\n                            additionalProperties:\n                              oneOf:\n                              not:\n                                  anyOf:\n                                  required:\n                                    exact\n                                  required:\n                                    prefix\n                                  required:\n                                    regex\n                              required:\n                                exact\n                              required:\n                                prefix\n                              required:\n                                regex\n                              properties:\n                                exact:\n                                  type: string\n                                prefix:\n                                  type: string\n                                regex:\n                                  description: RE2 style regex-based match (https://github.com/google/re2/wiki/Syntax).\n                                  type: string\n                              type: object\n                            description: withoutHeader has the same syntax with the\n                              header, but has opposite meaning.\n                            type: object\n                        type: object\n                      type: array\n                    mirror:\n                      properties:\n                        host:\n                          description: The name of a service from the service registry.\n                          type: string\n                        port:\n                          description: Specifies the port on the host that is being\n                            addressed.\n                          properties:\n                            number:\n                              type: integer\n                          type: object\n                        subset:\n                          description: The name of a subset within the service.\n                          type: string\n                      type: object\n                    mirror_percent:\n                      description: Percentage of the traffic to be mirrored by the\n                        mirror field.\n                      nullable: true\n                      type: integer\n                    mirrorPercent:\n                      description: Percentage of the traffic to be mirrored by the\n                        mirror field.\n                      nullable: true\n                      type: integer\n                    mirrorPercentage:\n                      description: Percentage of the traffic to be mirrored by the\n                        mirror field.\n                      properties:\n                        value:\n                          format: double\n                          type: number\n                      type: object\n                    name:\n                      description: The name assigned to the route for debugging purposes.\n                      type: string\n                    redirect:\n                      description: A HTTP rule can either redirect or forward (default)\n                        traffic.\n                      oneOf:\n                      not:\n                          anyOf:\n                          required:\n                            port\n                          required:\n                            derivePort\n                      required:\n                        port\n                      required:\n                        derivePort\n                      properties:\n                        authority:\n                          type: string\n                        derivePort:\n                          enum:\n                          FROMPROTOCOLDEFAULT\n                          FROMREQUESTPORT\n                          type: string\n                        port:\n                          description: On a redirect, overwrite the port portion of\n                            the URL with this value.\n                          type: integer\n                        redirectCode:\n                          type: integer\n                        scheme:\n                          description: On a redirect, overwrite the scheme portion\n                            of the URL with this value.\n                          type: string\n                        uri:\n                          type: string\n                      type: object\n                    retries:\n                      description: Retry policy for HTTP requests.\n                      properties:\n                        attempts:\n                          description: Number of retries to be allowed for a given\n                            request.\n                          format: int32\n                          type: integer\n                        perTryTimeout:\n                          description: Timeout per attempt for a given request, including\n                            the initial call and any retries.\n                          type: string\n                        retryOn:\n                          description: Specifies the conditions under which retry\n                            takes place.\n                          type: string\n                        retryRemoteLocalities:\n                          description: Flag to specify whether the retries should\n                            retry to other localities.\n                          nullable: true\n                          type: boolean\n                      type: object\n                    rewrite:\n                      description: Rewrite HTTP URIs and Authority headers.\n                      properties:\n                        authority:\n                          description: rewrite the Authority/Host header with this\n                            value.\n                          type: string\n                        uri:\n                          type: string\n                      type: object\n                    route:\n                      description: A HTTP rule can either redirect or forward (default)\n                        traffic.\n                      items:\n                        properties:\n                          destination:\n                            properties:\n                              host:\n                                description: The name of a service from the service\n                                  registry.\n                                type: string\n                              port:\n                                description: Specifies the port on the host that is\n                                  being addressed.\n                                properties:\n                                  number:\n                                    type: integer\n                                type: object\n                              subset:\n                                description: The name of a subset within the service.\n                                type: string\n                            type: object\n                          headers:\n                            properties:\n                              request:\n                                properties:\n                                  add:\n                                    additionalProperties:\n                                      type: string\n                                    type: object\n                                  remove:\n                                    items:\n                                      type: string\n                                    type: array\n                                  set:\n                                    additionalProperties:\n                                      type: string\n                                    type: object\n                                type: object\n                              response:\n                                properties:\n                                  add:\n                                    additionalProperties:\n                                      type: string\n                                    type: object\n                                  remove:\n                                    items:\n                                      type: string\n                                    type: array\n                                  set:\n                                    additionalProperties:\n                                      type: string\n                                    type: object\n                                type: object\n                            type: object\n                          weight:\n                            description: Weight specifies the relative proportion\n                              of traffic to be forwarded to the destination.\n                            format: int32\n                            type: integer\n                        type: object\n                      type: array\n                    timeout:\n                      description: Timeout for HTTP requests, default is disabled.\n                      type: string\n                  type: object\n                type: array\n              tcp:\n                description: An ordered list of route rules for opaque TCP traffic.\n                items:\n                  properties:\n                    match:\n                      items:\n                        properties:\n                          destinationSubnets:\n                            description: IPv4 or IPv6 ip addresses of destination\n                              with optional subnet.\n                            items:\n                              type: string\n                            type: array\n                          gateways:\n                            description: Names of gateways where the rule should be\n                              applied.\n                            items:\n                              type: string\n                            type: array\n                          port:\n                            description: Specifies the port on the host that is being\n                              addressed.\n                            type: integer\n                          sourceLabels:\n                            additionalProperties:\n                              type: string\n                            type: object\n                          sourceNamespace:\n                            description: Source namespace constraining the applicability\n                              of a rule to workloads in that namespace.\n                            type: string\n                          sourceSubnet:\n                            description: IPv4 or IPv6 ip address of source with optional\n                              subnet.\n                            type: string\n                        type: object\n                      type: array\n                    route:\n                      description: The destination to which the connection should\n                        be forwarded to.\n                      items:\n                        properties:\n                          destination:\n                            properties:\n                              host:\n                                description: The name of a service from the service\n                                  registry.\n                                type: string\n                              port:\n                                description: Specifies the port on the host that is\n                                  being addressed.\n                                properties:\n                                  number:\n                                    type: integer\n                                type: object\n                              subset:\n                                description: The name of a subset within the service.\n                                type: string\n                            type: object\n                          weight:\n                            description: Weight specifies the relative proportion\n                              of traffic to be forwarded to the destination.\n                            format: int32\n                            type: integer\n                        type: object\n                      type: array\n                  type: object\n                type: array\n              tls:\n                items:\n                  properties:\n                    match:\n                      items:\n                        properties:\n                          destinationSubnets:\n                            description: IPv4 or IPv6 ip addresses of destination\n                              with optional subnet.\n                            items:\n                              type: string\n                            type: array\n                          gateways:\n                            description: Names of gateways where the rule should be\n                              applied.\n                            items:\n                              type: string\n                            type: array\n                          port:\n                            description: Specifies the port on the host that is being\n                              addressed.\n                            type: integer\n                          sniHosts:\n                            description: SNI (server name indicator) to match on.\n                            items:\n                              type: string\n                            type: array\n                          sourceLabels:\n                            additionalProperties:\n                              type: string\n                            type: object\n                          sourceNamespace:\n                            description: Source namespace constraining the applicability\n                              of a rule to workloads in that namespace.\n                            type: string\n                        type: object\n                      type: array\n                    route:\n                      description: The destination to which the connection should\n                        be forwarded to.\n                      items:\n                        properties:\n                          destination:\n                            properties:\n                              host:\n                                description: The name of a service from the service\n                                  registry.\n                                type: string\n                              port:\n                                description: Specifies the port on the host that is\n                                  being addressed.\n                                properties:\n                                  number:\n                                    type: integer\n                                type: object\n                              subset:\n                                description: The name of a subset within the service.\n                                type: string\n                            type: object\n                          weight:\n                            description: Weight specifies the relative proportion\n                              of traffic to be forwarded to the destination.\n                            format: int32\n                            type: integer\n                        type: object\n                      type: array\n                  type: object\n                type: array\n            type: object\n          status:\n            type: object\n            x-kubernetes-preserve-unknown-fields: true\n        type: object\n    served: true\n    storage: true\n    subresources:\n      status: {}\n  additionalPrinterColumns:\n    description: The names of gateways and sidecars that should apply these routes\n      jsonPath: .spec.gateways\n      name: Gateways\n      type: string\n    description: The destination hosts to which traffic is being sent\n      jsonPath: .spec.hosts\n      name: Hosts\n      type: string\n    description: 'CreationTimestamp is a timestamp representing the server time\n        when this object was created. It is not guaranteed to be set in happens-before\n        order across separate operations. Clients may not set this value. It is represented\n        in RFC3339 form and is in UTC. Populated by the system. Read-only. Null for\n        lists. More info: https://git.k8s.io/community/contributors/devel/api-conventions.md#metadata'\n      jsonPath: .metadata.creationTimestamp\n      name: Age\n      type: date\n    name: v1beta1\n    schema:\n      openAPIV3Schema:\n        properties:\n          spec:\n            description: 'Configuration affecting label/content routing, sni routing,\n              etc. See more details at: https://istio.io/docs/reference/config/networking/virtual-service.html'\n            properties:\n              exportTo:\n                description: A list of namespaces to which this virtual service is\n                  exported.\n                items:\n                  type: string\n                type: array\n              gateways:\n                description: The names of gateways and sidecars that should apply\n                  these routes.\n                items:\n                  type: string\n                type: array\n              hosts:\n                description: The destination hosts to which traffic is being sent.\n                items:\n                  type: string\n                type: array\n              http:\n                description: An ordered list of route rules for HTTP traffic.\n                items:\n                  properties:\n                    corsPolicy:\n                      description: Cross-Origin Resource Sharing policy (CORS).\n                      properties:\n                        allowCredentials:\n                          nullable: true\n                          type: boolean\n                        allowHeaders:\n                          items:\n                            type: string\n                          type: array\n                        allowMethods:\n                          description: List of HTTP methods allowed to access the\n                            resource.\n                          items:\n                            type: string\n                          type: array\n                        allowOrigin:\n                          description: The list of origins that are allowed to perform\n                            CORS requests.\n                          items:\n                            type: string\n                          type: array\n                        allowOrigins:\n                          description: String patterns that match allowed origins.\n                          items:\n                            oneOf:\n                            not:\n                                anyOf:\n                                required:\n                                  exact\n                                required:\n                                  prefix\n                                required:\n                                  regex\n                            required:\n                              exact\n                            required:\n                              prefix\n                            required:\n                              regex\n                            properties:\n                              exact:\n                                type: string\n                              prefix:\n                                type: string\n                              regex:\n                                description: RE2 style regex-based match (https://github.com/google/re2/wiki/Syntax).\n                                type: string\n                            type: object\n                          type: array\n                        exposeHeaders:\n                          items:\n                            type: string\n                          type: array\n                        maxAge:\n                          type: string\n                      type: object\n                    delegate:\n                      properties:\n                        name:\n                          description: Name specifies the name of the delegate VirtualService.\n                          type: string\n                        namespace:\n                          description: Namespace specifies the namespace where the\n                            delegate VirtualService resides.\n                          type: string\n                      type: object\n                    fault:\n                      description: Fault injection policy to apply on HTTP traffic\n                        at the client side.\n                      properties:\n                        abort:\n                          oneOf:\n                          not:\n                              anyOf:\n                              required:\n                                httpStatus\n                              required:\n                                grpcStatus\n                              required:\n                                http2Error\n                          required:\n                            httpStatus\n                          required:\n                            grpcStatus\n                          required:\n                            http2Error\n                          properties:\n                            grpcStatus:\n                              type: string\n                            http2Error:\n                              type: string\n                            httpStatus:\n                              description: HTTP status code to use to abort the Http\n                                request.\n                              format: int32\n                              type: integer\n                            percentage:\n                              description: Percentage of requests to be aborted with\n                                the error code provided.\n                              properties:\n                                value:\n                                  format: double\n                                  type: number\n                              type: object\n                          type: object\n                        delay:\n                          oneOf:\n                          not:\n                              anyOf:\n                              required:\n                                fixedDelay\n                              required:\n                                exponentialDelay\n                          required:\n                            fixedDelay\n                          required:\n                            exponentialDelay\n                          properties:\n                            exponentialDelay:\n                              type: string\n                            fixedDelay:\n                              description: Add a fixed delay before forwarding the\n                                request.\n                              type: string\n                            percent:\n                              description: Percentage of requests on which the delay\n                                will be injected (0-100).\n                              format: int32\n                              type: integer\n                            percentage:\n                              description: Percentage of requests on which the delay\n                                will be injected.\n                              properties:\n                                value:\n                                  format: double\n                                  type: number\n                              type: object\n                          type: object\n                      type: object\n                    headers:\n                      properties:\n                        request:\n                          properties:\n                            add:\n                              additionalProperties:\n                                type: string\n                              type: object\n                            remove:\n                              items:\n                                type: string\n                              type: array\n                            set:\n                              additionalProperties:\n                                type: string\n                              type: object\n                          type: object\n                        response:\n                          properties:\n                            add:\n                              additionalProperties:\n                                type: string\n                              type: object\n                            remove:\n                              items:\n                                type: string\n                              type: array\n                            set:\n                              additionalProperties:\n                                type: string\n                              type: object\n                          type: object\n                      type: object\n                    match:\n                      items:\n                        properties:\n                          authority:\n                            oneOf:\n                            not:\n                                anyOf:\n                                required:\n                                  exact\n                                required:\n                                  prefix\n                                required:\n                                  regex\n                            required:\n                              exact\n                            required:\n                              prefix\n                            required:\n                              regex\n                            properties:\n                              exact:\n                                type: string\n                              prefix:\n                                type: string\n                              regex:\n                                description: RE2 style regex-based match (https://github.com/google/re2/wiki/Syntax).\n                                type: string\n                            type: object\n                          gateways:\n                            description: Names of gateways where the rule should be\n                              applied.\n                            items:\n                              type: string\n                            type: array\n                          headers:\n                            additionalProperties:\n                              oneOf:\n                              not:\n                                  anyOf:\n                                  required:\n                                    exact\n                                  required:\n                                    prefix\n                                  required:\n                                    regex\n                              required:\n                                exact\n                              required:\n                                prefix\n                              required:\n                                regex\n                              properties:\n                                exact:\n                                  type: string\n                                prefix:\n                                  type: string\n                                regex:\n                                  description: RE2 style regex-based match (https://github.com/google/re2/wiki/Syntax).\n                                  type: string\n                              type: object\n                            type: object\n                          ignoreUriCase:\n                            description: Flag to specify whether the URI matching\n                              should be case-insensitive.\n                            type: boolean\n                          method:\n                            oneOf:\n                            not:\n                                anyOf:\n                                required:\n                                  exact\n                                required:\n                                  prefix\n                                required:\n                                  regex\n                            required:\n                              exact\n                            required:\n                              prefix\n                            required:\n                              regex\n                            properties:\n                              exact:\n                                type: string\n                              prefix:\n                                type: string\n                              regex:\n                                description: RE2 style regex-based match (https://github.com/google/re2/wiki/Syntax).\n                                type: string\n                            type: object\n                          name:\n                            description: The name assigned to a match.\n                            type: string\n                          port:\n                            description: Specifies the ports on the host that is being\n                              addressed.\n                            type: integer\n                          queryParams:\n                            additionalProperties:\n                              oneOf:\n                              not:\n                                  anyOf:\n                                  required:\n                                    exact\n                                  required:\n                                    prefix\n                                  required:\n                                    regex\n                              required:\n                                exact\n                              required:\n                                prefix\n                              required:\n                                regex\n                              properties:\n                                exact:\n                                  type: string\n                                prefix:\n                                  type: string\n                                regex:\n                                  description: RE2 style regex-based match (https://github.com/google/re2/wiki/Syntax).\n                                  type: string\n                              type: object\n                            description: Query parameters for matching.\n                            type: object\n                          scheme:\n                            oneOf:\n                            not:\n                                anyOf:\n                                required:\n                                  exact\n                                required:\n                                  prefix\n                                required:\n                                  regex\n                            required:\n                              exact\n                            required:\n                              prefix\n                            required:\n                              regex\n                            properties:\n                              exact:\n                                type: string\n                              prefix:\n                                type: string\n                              regex:\n                                description: RE2 style regex-based match (https://github.com/google/re2/wiki/Syntax).\n                                type: string\n                            type: object\n                          sourceLabels:\n                            additionalProperties:\n                              type: string\n                            type: object\n                          sourceNamespace:\n                            description: Source namespace constraining the applicability\n                              of a rule to workloads in that namespace.\n                            type: string\n                          uri:\n                            oneOf:\n                            not:\n                                anyOf:\n                                required:\n                                  exact\n                                required:\n                                  prefix\n                                required:\n                                  regex\n                            required:\n                              exact\n                            required:\n                              prefix\n                            required:\n                              regex\n                            properties:\n                              exact:\n                                type: string\n                              prefix:\n                                type: string\n                              regex:\n                                description: RE2 style regex-based match (https://github.com/google/re2/wiki/Syntax).\n                                type: string\n                            type: object\n                          withoutHeaders:\n                            additionalProperties:\n                              oneOf:\n                              not:\n                                  anyOf:\n                                  required:\n                                    exact\n                                  required:\n                                    prefix\n                                  required:\n                                    regex\n                              required:\n                                exact\n                              required:\n                                prefix\n                              required:\n                                regex\n                              properties:\n                                exact:\n                                  type: string\n                                prefix:\n                                  type: string\n                                regex:\n                                  description: RE2 style regex-based match (https://github.com/google/re2/wiki/Syntax).\n                                  type: string\n                              type: object\n                            description: withoutHeader has the same syntax with the\n                              header, but has opposite meaning.\n                            type: object\n                        type: object\n                      type: array\n                    mirror:\n                      properties:\n                        host:\n                          description: The name of a service from the service registry.\n                          type: string\n                        port:\n                          description: Specifies the port on the host that is being\n                            addressed.\n                          properties:\n                            number:\n                              type: integer\n                          type: object\n                        subset:\n                          description: The name of a subset within the service.\n                          type: string\n                      type: object\n                    mirror_percent:\n                      description: Percentage of the traffic to be mirrored by the\n                        mirror field.\n                      nullable: true\n                      type: integer\n                    mirrorPercent:\n                      description: Percentage of the traffic to be mirrored by the\n                        mirror field.\n                      nullable: true\n                      type: integer\n                    mirrorPercentage:\n                      description: Percentage of the traffic to be mirrored by the\n                        mirror field.\n                      properties:\n                        value:\n                          format: double\n                          type: number\n                      type: object\n                    name:\n                      description: The name assigned to the route for debugging purposes.\n                      type: string\n                    redirect:\n                      description: A HTTP rule can either redirect or forward (default)\n                        traffic.\n                      oneOf:\n                      not:\n                          anyOf:\n                          required:\n                            port\n                          required:\n                            derivePort\n                      required:\n                        port\n                      required:\n                        derivePort\n                      properties:\n                        authority:\n                          type: string\n                        derivePort:\n                          enum:\n                          FROMPROTOCOLDEFAULT\n                          FROMREQUESTPORT\n                          type: string\n                        port:\n                          description: On a redirect, overwrite the port portion of\n                            the URL with this value.\n                          type: integer\n                        redirectCode:\n                          type: integer\n                        scheme:\n                          description: On a redirect, overwrite the scheme portion\n                            of the URL with this value.\n                          type: string\n                        uri:\n                          type: string\n                      type: object\n                    retries:\n                      description: Retry policy for HTTP requests.\n                      properties:\n                        attempts:\n                          description: Number of retries to be allowed for a given\n                            request.\n                          format: int32\n                          type: integer\n                        perTryTimeout:\n                          description: Timeout per attempt for a given request, including\n                            the initial call and any retries.\n                          type: string\n                        retryOn:\n                          description: Specifies the conditions under which retry\n                            takes place.\n                          type: string\n                        retryRemoteLocalities:\n                          description: Flag to specify whether the retries should\n                            retry to other localities.\n                          nullable: true\n                          type: boolean\n                      type: object\n                    rewrite:\n                      description: Rewrite HTTP URIs and Authority headers.\n                      properties:\n                        authority:\n                          description: rewrite the Authority/Host header with this\n                            value.\n                          type: string\n                        uri:\n                          type: string\n                      type: object\n                    route:\n                      description: A HTTP rule can either redirect or forward (default)\n                        traffic.\n                      items:\n                        properties:\n                          destination:\n                            properties:\n                              host:\n                                description: The name of a service from the service\n                                  registry.\n                                type: string\n                              port:\n                                description: Specifies the port on the host that is\n                                  being addressed.\n                                properties:\n                                  number:\n                                    type: integer\n                                type: object\n                              subset:\n                                description: The name of a subset within the service.\n                                type: string\n                            type: object\n                          headers:\n                            properties:\n                              request:\n                                properties:\n                                  add:\n                                    additionalProperties:\n                                      type: string\n                                    type: object\n                                  remove:\n                                    items:\n                                      type: string\n                                    type: array\n                                  set:\n                                    additionalProperties:\n                                      type: string\n                                    type: object\n                                type: object\n                              response:\n                                properties:\n                                  add:\n                                    additionalProperties:\n                                      type: string\n                                    type: object\n                                  remove:\n                                    items:\n                                      type: string\n                                    type: array\n                                  set:\n                                    additionalProperties:\n                                      type: string\n                                    type: object\n                                type: object\n                            type: object\n                          weight:\n                            description: Weight specifies the relative proportion\n                              of traffic to be forwarded to the destination.\n                            format: int32\n                            type: integer\n                        type: object\n                      type: array\n                    timeout:\n                      description: Timeout for HTTP requests, default is disabled.\n                      type: string\n                  type: object\n                type: array\n              tcp:\n                description: An ordered list of route rules for opaque TCP traffic.\n                items:\n                  properties:\n                    match:\n                      items:\n                        properties:\n                          destinationSubnets:\n                            description: IPv4 or IPv6 ip addresses of destination\n                              with optional subnet.\n                            items:\n                              type: string\n                            type: array\n                          gateways:\n                            description: Names of gateways where the rule should be\n                              applied.\n                            items:\n                              type: string\n                            type: array\n                          port:\n                            description: Specifies the port on the host that is being\n                              addressed.\n                            type: integer\n                          sourceLabels:\n                            additionalProperties:\n                              type: string\n                            type: object\n                          sourceNamespace:\n                            description: Source namespace constraining the applicability\n                              of a rule to workloads in that namespace.\n                            type: string\n                          sourceSubnet:\n                            description: IPv4 or IPv6 ip address of source with optional\n                              subnet.\n                            type: string\n                        type: object\n                      type: array\n                    route:\n                      description: The destination to which the connection should\n                        be forwarded to.\n                      items:\n                        properties:\n                          destination:\n                            properties:\n                              host:\n                                description: The name of a service from the service\n                                  registry.\n                                type: string\n                              port:\n                                description: Specifies the port on the host that is\n                                  being addressed.\n                                properties:\n                                  number:\n                                    type: integer\n                                type: object\n                              subset:\n                                description: The name of a subset within the service.\n                                type: string\n                            type: object\n                          weight:\n                            description: Weight specifies the relative proportion\n                              of traffic to be forwarded to the destination.\n                            format: int32\n                            type: integer\n                        type: object\n                      type: array\n                  type: object\n                type: array\n              tls:\n                items:\n                  properties:\n                    match:\n                      items:\n                        properties:\n                          destinationSubnets:\n                            description: IPv4 or IPv6 ip addresses of destination\n                              with optional subnet.\n                            items:\n                              type: string\n                            type: array\n                          gateways:\n                            description: Names of gateways where the rule should be\n                              applied.\n                            items:\n                              type: string\n                            type: array\n                          port:\n                            description: Specifies the port on the host that is being\n                              addressed.\n                            type: integer\n                          sniHosts:\n                            description: SNI (server name indicator) to match on.\n                            items:\n                              type: string\n                            type: array\n                          sourceLabels:\n                            additionalProperties:\n                              type: string\n                            type: object\n                          sourceNamespace:\n                            description: Source namespace constraining the applicability\n                              of a rule to workloads in that namespace.\n                            type: string\n                        type: object\n                      type: array\n                    route:\n                      description: The destination to which the connection should\n                        be forwarded to.\n                      items:\n                        properties:\n                          destination:\n                            properties:\n                              host:\n                                description: The name of a service from the service\n                                  registry.\n                                type: string\n                              port:\n                                description: Specifies the port on the host that is\n                                  being addressed.\n                                properties:\n                                  number:\n                                    type: integer\n                                type: object\n                              subset:\n                                description: The name of a subset within the service.\n                                type: string\n                            type: object\n                          weight:\n                            description: Weight specifies the relative proportion\n                              of traffic to be forwarded to the destination.\n                            format: int32\n                            type: integer\n                        type: object\n                      type: array\n                  type: object\n                type: array\n            type: object\n          status:\n            type: object\n            x-kubernetes-preserve-unknown-fields: true\n        type: object\n    served: true\n    storage: false\n    subresources:\n      status: {}\n---\nSource: base/templates/crds.yaml\napiVersion: apiextensions.k8s.io/v1\nkind: CustomResourceDefinition\nmetadata:\n  annotations:\n    \"helm.sh/resource-policy\": keep\n  labels:\n    app: istio-pilot\n    chart: istio\n    heritage: Tiller\n    release: istio\n  name: workloadentries.networking.istio.io\nspec:\n  group: networking.istio.io\n  names:\n    categories:\n    istio-io\n    networking-istio-io\n    kind: WorkloadEntry\n    listKind: WorkloadEntryList\n    plural: workloadentries\n    shortNames:\n    we\n    singular: workloadentry\n  scope: Namespaced\n  versions:\n  additionalPrinterColumns:\n    description: 'CreationTimestamp is a timestamp representing the server time\n        when this object was created. It is not guaranteed to be set in happens-before\n        order across separate operations. Clients may not set this value. It is represented\n        in RFC3339 form and is in UTC. Populated by the system. Read-only. Null for\n        lists. More info: https://git.k8s.io/community/contributors/devel/api-conventions.mdmetadata'\n      jsonPath: .metadata.creationTimestamp\n      name: Age\n      type: date\n    description: Address associated with the network endpoint.\n      jsonPath: .spec.address\n      name: Address\n      type: string\n    name: v1alpha3\n    schema:\n      openAPIV3Schema:\n        properties:\n          spec:\n            description: 'Configuration affecting VMs onboarded into the mesh. See\n              more details at: https://istio.io/docs/reference/config/networking/workload-entry.html'\n            properties:\n              address:\n                type: string\n              labels:\n                additionalProperties:\n                  type: string\n                description: One or more labels associated with the endpoint.\n                type: object\n              locality:\n                description: The locality associated with the endpoint.\n                type: string\n              network:\n                type: string\n              ports:\n                additionalProperties:\n                  type: integer\n                description: Set of ports associated with the endpoint.\n                type: object\n              serviceAccount:\n                type: string\n              weight:\n                description: The load balancing weight associated with the endpoint.\n                type: integer\n            type: object\n          status:\n            type: object\n            x-kubernetes-preserve-unknown-fields: true\n        type: object\n    served: true\n    storage: true\n    subresources:\n      status: {}\n  additionalPrinterColumns:\n    description: 'CreationTimestamp is a timestamp representing the server time\n        when this object was created. It is not guaranteed to be set in happens-before\n        order across separate operations. Clients may not set this value. It is represented\n        in RFC3339 form and is in UTC. Populated by the system. Read-only. Null for\n        lists. More info: https://git.k8s.io/community/contributors/devel/api-conventions.md#metadata'\n      jsonPath: .metadata.creationTimestamp\n      name: Age\n      type: date\n    description: Address associated with the network endpoint.\n      jsonPath: .spec.address\n      name: Address\n      type: string\n    name: v1beta1\n    schema:\n      openAPIV3Schema:\n        properties:\n          spec:\n            description: 'Configuration affecting VMs onboarded into the mesh. See\n              more details at: https://istio.io/docs/reference/config/networking/workload-entry.html'\n            properties:\n              address:\n                type: string\n              labels:\n                additionalProperties:\n                  type: string\n                description: One or more labels associated with the endpoint.\n                type: object\n              locality:\n                description: The locality associated with the endpoint.\n                type: string\n              network:\n                type: string\n              ports:\n                additionalProperties:\n                  type: integer\n                description: Set of ports associated with the endpoint.\n                type: object\n              serviceAccount:\n                type: string\n              weight:\n                description: The load balancing weight associated with the endpoint.\n                type: integer\n            type: object\n          status:\n            type: object\n            x-kubernetes-preserve-unknown-fields: true\n        type: object\n    served: true\n    storage: false\n    subresources:\n      status: {}\n---\nSource: base/templates/crds.yaml\napiVersion: apiextensions.k8s.io/v1\nkind: CustomResourceDefinition\nmetadata:\n  labels:\n    app: istio-pilot\n    chart: istio\n    heritage: Tiller\n    release: istio\n  name: workloadgroups.networking.istio.io\nspec:\n  group: networking.istio.io\n  names:\n    categories:\n    istio-io\n    networking-istio-io\n    kind: WorkloadGroup\n    listKind: WorkloadGroupList\n    plural: workloadgroups\n    shortNames:\n    wg\n    singular: workloadgroup\n  scope: Namespaced\n  versions:\n  additionalPrinterColumns:\n    description: 'CreationTimestamp is a timestamp representing the server time\n        when this object was created. It is not guaranteed to be set in happens-before\n        order across separate operations. Clients may not set this value. It is represented\n        in RFC3339 form and is in UTC. Populated by the system. Read-only. Null for\n        lists. More info: https://git.k8s.io/community/contributors/devel/api-conventions.mdmetadata'\n      jsonPath: .metadata.creationTimestamp\n      name: Age\n      type: date\n    name: v1alpha3\n    schema:\n      openAPIV3Schema:\n        properties:\n          spec:\n            description: 'Describes a collection of workload instances. See more details\n              at: https://istio.io/docs/reference/config/networking/workload-group.html'\n            properties:\n              metadata:\n                description: Metadata that will be used for all corresponding WorkloadEntries.\n                properties:\n                  annotations:\n                    additionalProperties:\n                      type: string\n                    type: object\n                  labels:\n                    additionalProperties:\n                      type: string\n                    type: object\n                type: object\n              probe:\n                description: 'ReadinessProbe describes the configuration the user\n                  must provide for healthchecking on their workload.'\n                oneOf:\n                not:\n                    anyOf:\n                    required:\n                      httpGet\n                    required:\n                      tcpSocket\n                    required:\n                      exec\n                required:\n                  httpGet\n                required:\n                  tcpSocket\n                required:\n                  exec\n                properties:\n                  exec:\n                    description: Health is determined by how the command that is executed\n                      exited.\n                    properties:\n                      command:\n                        description: Command to run.\n                        items:\n                          type: string\n                        type: array\n                    type: object\n                  failureThreshold:\n                    description: Minimum consecutive failures for the probe to be\n                      considered failed after having succeeded.\n                    format: int32\n                    type: integer\n                  httpGet:\n                    properties:\n                      host:\n                        description: Host name to connect to, defaults to the pod\n                          IP.\n                        type: string\n                      httpHeaders:\n                        description: Headers the proxy will pass on to make the request.\n                        items:\n                          properties:\n                            name:\n                              type: string\n                            value:\n                              type: string\n                          type: object\n                        type: array\n                      path:\n                        description: Path to access on the HTTP server.\n                        type: string\n                      port:\n                        description: Port on which the endpoint lives.\n                        type: integer\n                      scheme:\n                        type: string\n                    type: object\n                  initialDelaySeconds:\n                    description: Number of seconds after the container has started\n                      before readiness probes are initiated.\n                    format: int32\n                    type: integer\n                  periodSeconds:\n                    description: How often (in seconds) to perform the probe.\n                    format: int32\n                    type: integer\n                  successThreshold:\n                    description: Minimum consecutive successes for the probe to be\n                      considered successful after having failed.\n                    format: int32\n                    type: integer\n                  tcpSocket:\n                    description: Health is determined by if the proxy is able to connect.\n                    properties:\n                      host:\n                        type: string\n                      port:\n                        type: integer\n                    type: object\n                  timeoutSeconds:\n                    description: Number of seconds after which the probe times out.\n                    format: int32\n                    type: integer\n                type: object\n              template:\n                description: Template to be used for the generation of WorkloadEntry\n                  resources that belong to this WorkloadGroup.\n                properties:\n                  address:\n                    type: string\n                  labels:\n                    additionalProperties:\n                      type: string\n                    description: One or more labels associated with the endpoint.\n                    type: object\n                  locality:\n                    description: The locality associated with the endpoint.\n                    type: string\n                  network:\n                    type: string\n                  ports:\n                    additionalProperties:\n                      type: integer\n                    description: Set of ports associated with the endpoint.\n                    type: object\n                  serviceAccount:\n                    type: string\n                  weight:\n                    description: The load balancing weight associated with the endpoint.\n                    type: integer\n                type: object\n            type: object\n          status:\n            type: object\n            x-kubernetes-preserve-unknown-fields: true\n        type: object\n    served: true\n    storage: true\n    subresources:\n      status: {}\n  additionalPrinterColumns:\n    description: 'CreationTimestamp is a timestamp representing the server time\n        when this object was created. It is not guaranteed to be set in happens-before\n        order across separate operations. Clients may not set this value. It is represented\n        in RFC3339 form and is in UTC. Populated by the system. Read-only. Null for\n        lists. More info: https://git.k8s.io/community/contributors/devel/api-conventions.md#metadata'\n      jsonPath: .metadata.creationTimestamp\n      name: Age\n      type: date\n    name: v1beta1\n    schema:\n      openAPIV3Schema:\n        properties:\n          spec:\n            properties:\n              metadata:\n                description: Metadata that will be used for all corresponding WorkloadEntries.\n                properties:\n                  annotations:\n                    additionalProperties:\n                      type: string\n                    type: object\n                  labels:\n                    additionalProperties:\n                      type: string\n                    type: object\n                type: object\n              probe:\n                description: 'ReadinessProbe describes the configuration the user\n                  must provide for healthchecking on their workload.'\n                oneOf:\n                not:\n                    anyOf:\n                    required:\n                      httpGet\n                    required:\n                      tcpSocket\n                    required:\n                      exec\n                required:\n                  httpGet\n                required:\n                  tcpSocket\n                required:\n                  exec\n                properties:\n                  exec:\n                    description: Health is determined by how the command that is executed\n                      exited.\n                    properties:\n                      command:\n                        description: Command to run.\n                        items:\n                          type: string\n                        type: array\n                    type: object\n                  failureThreshold:\n                    description: Minimum consecutive failures for the probe to be\n                      considered failed after having succeeded.\n                    format: int32\n                    type: integer\n                  httpGet:\n                    properties:\n                      host:\n                        description: Host name to connect to, defaults to the pod\n                          IP.\n                        type: string\n                      httpHeaders:\n                        description: Headers the proxy will pass on to make the request.\n                        items:\n                          properties:\n                            name:\n                              type: string\n                            value:\n                              type: string\n                          type: object\n                        type: array\n                      path:\n                        description: Path to access on the HTTP server.\n                        type: string\n                      port:\n                        description: Port on which the endpoint lives.\n                        type: integer\n                      scheme:\n                        type: string\n                    type: object\n                  initialDelaySeconds:\n                    description: Number of seconds after the container has started\n                      before readiness probes are initiated.\n                    format: int32\n                    type: integer\n                  periodSeconds:\n                    description: How often (in seconds) to perform the probe.\n                    format: int32\n                    type: integer\n                  successThreshold:\n                    description: Minimum consecutive successes for the probe to be\n                      considered successful after having failed.\n                    format: int32\n                    type: integer\n                  tcpSocket:\n                    description: Health is determined by if the proxy is able to connect.\n                    properties:\n                      host:\n                        type: string\n                      port:\n                        type: integer\n                    type: object\n                  timeoutSeconds:\n                    description: Number of seconds after which the probe times out.\n                    format: int32\n                    type: integer\n                type: object\n              template:\n                description: Template to be used for the generation of WorkloadEntry\n                  resources that belong to this WorkloadGroup.\n                properties:\n                  address:\n                    type: string\n                  labels:\n                    additionalProperties:\n                      type: string\n                    description: One or more labels associated with the endpoint.\n                    type: object\n                  locality:\n                    description: The locality associated with the endpoint.\n                    type: string\n                  network:\n                    type: string\n                  ports:\n                    additionalProperties:\n                      type: integer\n                    description: Set of ports associated with the endpoint.\n                    type: object\n                  serviceAccount:\n                    type: string\n                  weight:\n                    description: The load balancing weight associated with the endpoint.\n                    type: integer\n                type: object\n            type: object\n          status:\n            type: object\n            x-kubernetes-preserve-unknown-fields: true\n        type: object\n    served: true\n    storage: false\n    subresources:\n      status: {}\n---\nSource: base/templates/crds.yaml\napiVersion: apiextensions.k8s.io/v1\nkind: CustomResourceDefinition\nmetadata:\n  annotations:\n    \"helm.sh/resource-policy\": keep\n  labels:\n    app: istio-pilot\n    chart: istio\n    heritage: Tiller\n    istio: security\n    release: istio\n  name: authorizationpolicies.security.istio.io\nspec:\n  group: security.istio.io\n  names:\n    categories:\n    istio-io\n    security-istio-io\n    kind: AuthorizationPolicy\n    listKind: AuthorizationPolicyList\n    plural: authorizationpolicies\n    singular: authorizationpolicy\n  scope: Namespaced\n  versions:\n  name: v1beta1\n    schema:\n      openAPIV3Schema:\n        properties:\n          spec:\n            description: 'Configuration for access control on workloads. See more\n              details at: https://istio.io/docs/reference/config/security/authorization-policy.html'\n            oneOf:\n            not:\n                anyOf:\n                required:\n                  provider\n            required:\n              provider\n            properties:\n              action:\n                description: Optional.\n                enum:\n                ALLOW\n                DENY\n                AUDIT\n                CUSTOM\n                type: string\n              provider:\n                description: Specifies detailed configuration of the CUSTOM action.\n                properties:\n                  name:\n                    description: Specifies the name of the extension provider.\n                    type: string\n                type: object\n              rules:\n                description: Optional.\n                items:\n                  properties:\n                    from:\n                      description: Optional.\n                      items:\n                        properties:\n                          source:\n                            description: Source specifies the source of a request.\n                            properties:\n                              ipBlocks:\n                                description: Optional.\n                                items:\n                                  type: string\n                                type: array\n                              namespaces:\n                                description: Optional.\n                                items:\n                                  type: string\n                                type: array\n                              notIpBlocks:\n                                description: Optional.\n                                items:\n                                  type: string\n                                type: array\n                              notNamespaces:\n                                description: Optional.\n                                items:\n                                  type: string\n                                type: array\n                              notPrincipals:\n                                description: Optional.\n                                items:\n                                  type: string\n                                type: array\n                              notRemoteIpBlocks:\n                                description: Optional.\n                                items:\n                                  type: string\n                                type: array\n                              notRequestPrincipals:\n                                description: Optional.\n                                items:\n                                  type: string\n                                type: array\n                              principals:\n                                description: Optional.\n                                items:\n                                  type: string\n                                type: array\n                              remoteIpBlocks:\n                                description: Optional.\n                                items:\n                                  type: string\n                                type: array\n                              requestPrincipals:\n                                description: Optional.\n                                items:\n                                  type: string\n                                type: array\n                            type: object\n                        type: object\n                      type: array\n                    to:\n                      description: Optional.\n                      items:\n                        properties:\n                          operation:\n                            description: Operation specifies the operation of a request.\n                            properties:\n                              hosts:\n                                description: Optional.\n                                items:\n                                  type: string\n                                type: array\n                              methods:\n                                description: Optional.\n                                items:\n                                  type: string\n                                type: array\n                              notHosts:\n                                description: Optional.\n                                items:\n                                  type: string\n                                type: array\n                              notMethods:\n                                description: Optional.\n                                items:\n                                  type: string\n                                type: array\n                              notPaths:\n                                description: Optional.\n                                items:\n                                  type: string\n                                type: array\n                              notPorts:\n                                description: Optional.\n                                items:\n                                  type: string\n                                type: array\n                              paths:\n                                description: Optional.\n                                items:\n                                  type: string\n                                type: array\n                              ports:\n                                description: Optional.\n                                items:\n                                  type: string\n                                type: array\n                            type: object\n                        type: object\n                      type: array\n                    when:\n                      description: Optional.\n                      items:\n                        properties:\n                          key:\n                            description: The name of an Istio attribute.\n                            type: string\n                          notValues:\n                            description: Optional.\n                            items:\n                              type: string\n                            type: array\n                          values:\n                            description: Optional.\n                            items:\n                              type: string\n                            type: array\n                        type: object\n                      type: array\n                  type: object\n                type: array\n              selector:\n                description: Optional.\n                properties:\n                  matchLabels:\n                    additionalProperties:\n                      type: string\n                    type: object\n                type: object\n            type: object\n          status:\n            type: object\n            x-kubernetes-preserve-unknown-fields: true\n        type: object\n    served: true\n    storage: true\n    subresources:\n      status: {}\n---\n Source: base/templates/crds.yaml\napiVersion: apiextensions.k8s.io/v1\nkind: CustomResourceDefinition\nmetadata:\n  annotations:\n    \"helm.sh/resource-policy\": keep\n  labels:\n    app: istio-pilot\n    chart: istio\n    heritage: Tiller\n    istio: security\n    release: istio\n  name: peerauthentications.security.istio.io\nspec:\n  group: security.istio.io\n  names:\n    categories:\n    istio-io\n    security-istio-io\n    kind: PeerAuthentication\n    listKind: PeerAuthenticationList\n    plural: peerauthentications\n    shortNames:\n    pa\n    singular: peerauthentication\n  scope: Namespaced\n  versions:\n  additionalPrinterColumns:\n    description: Defines the mTLS mode used for peer authentication.\n      jsonPath: .spec.mtls.mode\n      name: Mode\n      type: string\n    description: 'CreationTimestamp is a timestamp representing the server time\n        when this object was created. It is not guaranteed to be set in happens-before\n        order across separate operations. Clients may not set this value. It is represented\n        in RFC3339 form and is in UTC. Populated by the system. Read-only. Null for\n        lists. More info: https://git.k8s.io/community/contributors/devel/api-conventions.md#metadata'\n      jsonPath: .metadata.creationTimestamp\n      name: Age\n      type: date\n    name: v1beta1\n    schema:\n      openAPIV3Schema:\n        properties:\n          spec:\n            description: PeerAuthentication defines how traffic will be tunneled (or\n              not) to the sidecar.\n            properties:\n              mtls:\n                description: Mutual TLS settings for workload.\n                properties:\n                  mode:\n                    description: Defines the mTLS mode used for peer authentication.\n                    enum:\n                    UNSET\n                    DISABLE\n                    PERMISSIVE\n                    STRICT\n                    type: string\n                type: object\n              portLevelMtls:\n                additionalProperties:\n                  properties:\n                    mode:\n                      description: Defines the mTLS mode used for peer authentication.\n                      enum:\n                      UNSET\n                      DISABLE\n                      PERMISSIVE\n                      STRICT\n                      type: string\n                  type: object\n                description: Port specific mutual TLS settings.\n                type: object\n              selector:\n                description: The selector determines the workloads to apply the ChannelAuthentication\n                  on.\n                properties:\n                  matchLabels:\n                    additionalProperties:\n                      type: string\n                    type: object\n                type: object\n            type: object\n          status:\n            type: object\n            x-kubernetes-preserve-unknown-fields: true\n        type: object\n    served: true\n    storage: true\n    subresources:\n      status: {}\n---\nSource: base/templates/crds.yaml\napiVersion: apiextensions.k8s.io/v1\nkind: CustomResourceDefinition\nmetadata:\n  annotations:\n    \"helm.sh/resource-policy\": keep\n  labels:\n    app: istio-pilot\n    chart: istio\n    heritage: Tiller\n    istio: security\n    release: istio\n  name: requestauthentications.security.istio.io\nspec:\n  group: security.istio.io\n  names:\n    categories:\n    istio-io\n    security-istio-io\n    kind: RequestAuthentication\n    listKind: RequestAuthenticationList\n    plural: requestauthentications\n    shortNames:\n    ra\n    singular: requestauthentication\n  scope: Namespaced\n  versions:\n  name: v1beta1\n    schema:\n      openAPIV3Schema:\n        properties:\n          spec:\n            description: RequestAuthentication defines what request authentication\n              methods are supported by a workload.\n            properties:\n              jwtRules:\n                description: Define the list of JWTs that can be validated at the\n                  selected workloads' proxy.\n                items:\n                  properties:\n                    audiences:\n                      items:\n                        type: string\n                      type: array\n                    forwardOriginalToken:\n                      description: If set to true, the original token will be kept\n                        for the upstream request.\n                      type: boolean\n                    fromHeaders:\n                      description: List of header locations from which JWT is expected.\n                      items:\n                        properties:\n                          name:\n                            description: The HTTP header name.\n                            type: string\n                          prefix:\n                            description: The prefix that should be stripped before\n                              decoding the token.\n                            type: string\n                        type: object\n                      type: array\n                    fromParams:\n                      description: List of query parameters from which JWT is expected.\n                      items:\n                        type: string\n                      type: array\n                    issuer:\n                      description: Identifies the issuer that issued the JWT.\n                      type: string\n                    jwks:\n                      description: JSON Web Key Set of public keys to validate signature\n                        of the JWT.\n                      type: string\n                    jwks_uri:\n                      type: string\n                    jwksUri:\n                      type: string\n                    outputPayloadToHeader:\n                      type: string\n                  type: object\n                type: array\n              selector:\n                description: Optional.\n                properties:\n                  matchLabels:\n                    additionalProperties:\n                      type: string\n                    type: object\n                type: object\n            type: object\n          status:\n            type: object\n            x-kubernetes-preserve-unknown-fields: true\n        type: object\n    served: true\n    storage: true\n    subresources:\n      status: {}\n---\n Source: base/templates/crds.yaml\napiVersion: apiextensions.k8s.io/v1\nkind: CustomResourceDefinition\nmetadata:\n  annotations:\n    \"helm.sh/resource-policy\": keep\n  labels:\n    app: istio-pilot\n    chart: istio\n    heritage: Tiller\n    istio: telemetry\n    release: istio\n  name: telemetries.telemetry.istio.io\nspec:\n  group: telemetry.istio.io\n  names:\n    categories:\n    istio-io\n    telemetry-istio-io\n    kind: Telemetry\n    listKind: TelemetryList\n    plural: telemetries\n    shortNames:\n    telemetry\n    singular: telemetry\n  scope: Namespaced\n  versions:\n  additionalPrinterColumns:\n    description: 'CreationTimestamp is a timestamp representing the server time\n        when this object was created. It is not guaranteed to be set in happens-before\n        order across separate operations. Clients may not set this value. It is represented\n        in RFC3339 form and is in UTC. Populated by the system. Read-only. Null for\n        lists. More info: https://git.k8s.io/community/contributors/devel/api-conventions.md#metadata'\n      jsonPath: .metadata.creationTimestamp\n      name: Age\n      type: date\n    name: v1alpha1\n    schema:\n      openAPIV3Schema:\n        properties:\n          spec:\n            description: 'Telemetry configuration for workloads. See more details\n              at: https://istio.io/docs/reference/config/telemetry.html'\n            properties:\n              accessLogging:\n                description: Optional.\n                items:\n                  properties:\n                    disabled:\n                      description: Controls logging.\n                      nullable: true\n                      type: boolean\n                    filter:\n                      description: Optional.\n                      properties:\n                        expression:\n                          description: CEL expression for selecting when requests/connections\n                            should be logged.\n                          type: string\n                      type: object\n                    providers:\n                      description: Optional.\n                      items:\n                        properties:\n                          name:\n                            description: Required.\n                            type: string\n                        type: object\n                      type: array\n                  type: object\n                type: array\n              metrics:\n                description: Optional.\n                items:\n                  properties:\n                    overrides:\n                      description: Optional.\n                      items:\n                        properties:\n                          disabled:\n                            description: Optional.\n                            nullable: true\n                            type: boolean\n                          match:\n                            description: Match allows provides the scope of the override.\n                            oneOf:\n                            not:\n                                anyOf:\n                                required:\n                                  metric\n                                required:\n                                  customMetric\n                            required:\n                              metric\n                            required:\n                              customMetric\n                            properties:\n                              customMetric:\n                                description: Allows free-form specification of a metric.\n                                type: string\n                              metric:\n                                description: One of the well-known Istio Standard\n                                  Metrics.\n                                enum:\n                                ALL_METRICS\n                                REQUEST_COUNT\n                                REQUEST_DURATION\n                                REQUEST_SIZE\n                                RESPONSE_SIZE\n                                TCPOPENEDCONNECTIONS\n                                TCPCLOSEDCONNECTIONS\n                                TCPSENTBYTES\n                                TCPRECEIVEDBYTES\n                                GRPCREQUESTMESSAGES\n                                GRPCRESPONSEMESSAGES\n                                type: string\n                              mode:\n                                description: 'Controls which mode of metrics generation\n                                  is selected: CLIENT and/or SERVER.'\n                                enum:\n                                CLIENTANDSERVER\n                                CLIENT\n                                SERVER\n                                type: string\n                            type: object\n                          tagOverrides:\n                            additionalProperties:\n                              properties:\n                                operation:\n                                  description: Operation controls whether or not to\n                                    update/add a tag, or to remove it.\n                                  enum:\n                                  UPSERT\n                                  REMOVE\n                                  type: string\n                                value:\n                                  description: Value is only considered if the operation\n                                    is UPSERT.\n                                  type: string\n                              type: object\n                            description: Optional.\n                            type: object\n                        type: object\n                      type: array\n                    providers:\n                      description: Optional.\n                      items:\n                        properties:\n                          name:\n                            description: Required.\n                            type: string\n                        type: object\n                      type: array\n                  type: object\n                type: array\n              selector:\n                description: Optional.\n                properties:\n                  matchLabels:\n                    additionalProperties:\n                      type: string\n                    type: object\n                type: object\n              tracing:\n                description: Optional.\n                items:\n                  properties:\n                    customTags:\n                      additionalProperties:\n                        oneOf:\n                        not:\n                            anyOf:\n                            required:\n                              literal\n                            required:\n                              environment\n                            required:\n                              header\n                        required:\n                          literal\n                        required:\n                          environment\n                        required:\n                          header\n                        properties:\n                          environment:\n                            description: Environment adds the value of an environment\n                              variable to each span.\n                            properties:\n                              defaultValue:\n                                description: Optional.\n                                type: string\n                              name:\n                                description: Name of the environment variable from\n                                  which to extract the tag value.\n                                type: string\n                            type: object\n                          header:\n                            description: RequestHeader adds the value of an header\n                              from the request to each span.\n                            properties:\n                              defaultValue:\n                                description: Optional.\n                                type: string\n                              name:\n                                description: Name of the header from which to extract\n                                  the tag value.\n                                type: string\n                            type: object\n                          literal:\n                            description: Literal adds the same, hard-coded value to\n                              each span.\n                            properties:\n                              value:\n                                description: The tag value to use.\n                                type: string\n                            type: object\n                        type: object\n                      description: Optional.\n                      type: object\n                    disableSpanReporting:\n                      description: Controls span reporting.\n                      nullable: true\n                      type: boolean\n                    providers:\n                      description: Optional.\n                      items:\n                        properties:\n                          name:\n                            description: Required.\n                            type: string\n                        type: object\n                      type: array\n                    randomSamplingPercentage:\n                      nullable: true\n                      type: number\n                    useRequestIdForTraceSampling:\n                      nullable: true\n                      type: boolean\n                  type: object\n                type: array\n            type: object\n          status:\n            type: object\n            x-kubernetes-preserve-unknown-fields: true\n        type: object\n    served: true\n    storage: true\n    subresources:\n      status: {}\n---\nSource: base/templates/crds.yaml\n SYNC WITH manifests/charts/istio-operator/templates\napiVersion: apiextensions.k8s.io/v1\nkind: CustomResourceDefinition\nmetadata:\n  name: istiooperators.install.istio.io\n  labels:\n    release: istio\nspec:\n  conversion:\n    strategy: None\n  group: install.istio.io\n  names:\n    kind: IstioOperator\n    listKind: IstioOperatorList\n    plural: istiooperators\n    singular: istiooperator\n    shortNames:\n    iop\n    io\n  scope: Namespaced\n  versions:\n  additionalPrinterColumns:\n    description: Istio control plane revision\n      jsonPath: .spec.revision\n      name: Revision\n      type: string\n    description: IOP current state\n      jsonPath: .status.status\n      name: Status\n      type: string\n    description: 'CreationTimestamp is a timestamp representing the server time\n        when this object was created. It is not guaranteed to be set in happens-before\n        order across separate operations. Clients may not set this value. It is represented\n        in RFC3339 form and is in UTC. Populated by the system. Read-only. Null for\n        lists. More info: https://git.k8s.io/community/contributors/devel/api-conventions.md#metadata'\n      jsonPath: .metadata.creationTimestamp\n      name: Age\n      type: date\n    subresources:\n      status: {}\n    name: v1alpha1\n    schema:\n      openAPIV3Schema:\n        type: object\n        x-kubernetes-preserve-unknown-fields: true\n    served: true\n    storage: true\n---\nSource: base/templates/clusterrole.yaml\n -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-\nDO NOT EDIT!\n THIS IS A LEGACY CHART HERE FOR BACKCOMPAT\nUPDATED CHART AT manifests/charts/istio-control/istio-discovery\n -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-\napiVersion: rbac.authorization.k8s.io/v1\nkind: ClusterRole\nmetadata:\n  name: istiod-istio-system\n  labels:\n    app: istiod\n    release: istio-base\nrules:\n  # sidecar injection controller\n  apiGroups: [\"admissionregistration.k8s.io\"]\n    resources: [\"mutatingwebhookconfigurations\"]\n    verbs: [\"get\", \"list\", \"watch\", \"update\", \"patch\"]\n\n  # configuration validation webhook controller\n  apiGroups: [\"admissionregistration.k8s.io\"]\n    resources: [\"validatingwebhookconfigurations\"]\n    verbs: [\"get\", \"list\", \"watch\", \"update\"]\n\n  # istio configuration\n  # removing CRD permissions can break older versions of Istio running alongside this control plane (https://github.com/istio/istio/issues/29382)\n  # please proceed with caution\n  apiGroups: [\"config.istio.io\", \"security.istio.io\", \"networking.istio.io\", \"authentication.istio.io\", \"rbac.istio.io\", \"telemetry.istio.io\"]\n    verbs: [\"get\", \"watch\", \"list\"]\n    resources: [\"*\"]\n  apiGroups: [\"networking.istio.io\"]\n    verbs: [ \"get\", \"watch\", \"list\", \"update\", \"patch\", \"create\", \"delete\" ]\n    resources: [ \"workloadentries\" ]\n  apiGroups: [\"networking.istio.io\"]\n    verbs: [ \"get\", \"watch\", \"list\", \"update\", \"patch\", \"create\", \"delete\" ]\n    resources: [ \"workloadentries/status\" ]\n\n  # auto-detect installed CRD definitions\n  apiGroups: [\"apiextensions.k8s.io\"]\n    resources: [\"customresourcedefinitions\"]\n    verbs: [\"get\", \"list\", \"watch\"]\n\n  # discovery and routing\n  apiGroups: [\"\"]\n    resources: [\"pods\", \"nodes\", \"services\", \"namespaces\", \"endpoints\"]\n    verbs: [\"get\", \"list\", \"watch\"]\n  apiGroups: [\"discovery.k8s.io\"]\n    resources: [\"endpointslices\"]\n    verbs: [\"get\", \"list\", \"watch\"]\n\n  # ingress controller\n  apiGroups: [\"networking.k8s.io\"]\n    resources: [\"ingresses\", \"ingressclasses\"]\n    verbs: [\"get\", \"list\", \"watch\"]\n  apiGroups: [\"networking.k8s.io\"]\n    resources: [\"ingresses/status\"]\n    verbs: [\"*\"]\n\n  # required for CA's namespace controller\n  apiGroups: [\"\"]\n    resources: [\"configmaps\"]\n    verbs: [\"create\", \"get\", \"list\", \"watch\", \"update\"]\n\n  # Istiod and bootstrap.\n  apiGroups: [\"certificates.k8s.io\"]\n    resources:\n      \"certificatesigningrequests\"\n      \"certificatesigningrequests/approval\"\n      \"certificatesigningrequests/status\"\n    verbs: [\"update\", \"create\", \"get\", \"delete\", \"watch\"]\n  apiGroups: [\"certificates.k8s.io\"]\n    resources:\n      \"signers\"\n    resourceNames:\n    \"kubernetes.io/legacy-unknown\"\n    verbs: [\"approve\"]\n\n  # Used by Istiod to verify the JWT tokens\n  apiGroups: [\"authentication.k8s.io\"]\n    resources: [\"tokenreviews\"]\n    verbs: [\"create\"]\n\n  # Used by Istiod to verify gateway SDS\n  apiGroups: [\"authorization.k8s.io\"]\n    resources: [\"subjectaccessreviews\"]\n    verbs: [\"create\"]\n\n  # Use for Kubernetes Service APIs\n  apiGroups: [\"networking.x-k8s.io\", \"gateway.networking.k8s.io\"]\n    resources: [\"*\"]\n    verbs: [\"get\", \"watch\", \"list\"]\n  apiGroups: [\"networking.x-k8s.io\", \"gateway.networking.k8s.io\"]\n    resources: [\"*\"] # TODO: should be on just */status but wildcard is not supported\n    verbs: [\"update\"]\n\n  # Needed for multicluster secret reading, possibly ingress certs in the future\n  apiGroups: [\"\"]\n    resources: [\"secrets\"]\n    verbs: [\"get\", \"watch\", \"list\"]\n\n  # Used for MCS serviceexport management\n  apiGroups: [\"multicluster.x-k8s.io\"]\n    resources: [\"serviceexports\"]\n    verbs: [\"get\", \"watch\", \"list\", \"create\", \"delete\"]\n\n  # Used for MCS serviceimport management\n  apiGroups: [\"multicluster.x-k8s.io\"]\n    resources: [\"serviceimports\"]\n    verbs: [\"get\", \"watch\", \"list\"]\n---\nSource: base/templates/clusterrole.yaml\napiVersion: rbac.authorization.k8s.io/v1\nkind: ClusterRole\nmetadata:\n  name: istio-reader-istio-system\n  labels:\n    app: istio-reader\n    release: istio-base\nrules:\n  apiGroups:\n      \"config.istio.io\"\n      \"security.istio.io\"\n      \"networking.istio.io\"\n      \"authentication.istio.io\"\n      \"rbac.istio.io\"\n    resources: [\"*\"]\n    verbs: [\"get\", \"list\", \"watch\"]\n  apiGroups: [\"\"]\n    resources: [\"endpoints\", \"pods\", \"services\", \"nodes\", \"replicationcontrollers\", \"namespaces\", \"secrets\"]\n    verbs: [\"get\", \"list\", \"watch\"]\n  apiGroups: [\"networking.istio.io\"]\n    verbs: [ \"get\", \"watch\", \"list\" ]\n    resources: [ \"workloadentries\" ]\n  apiGroups: [\"apiextensions.k8s.io\"]\n    resources: [\"customresourcedefinitions\"]\n    verbs: [\"get\", \"list\", \"watch\"]\n  apiGroups: [\"discovery.k8s.io\"]\n    resources: [\"endpointslices\"]\n    verbs: [\"get\", \"list\", \"watch\"]\n  apiGroups: [\"apps\"]\n    resources: [\"replicasets\"]\n    verbs: [\"get\", \"list\", \"watch\"]\n  apiGroups: [\"authentication.k8s.io\"]\n    resources: [\"tokenreviews\"]\n    verbs: [\"create\"]\n  apiGroups: [\"authorization.k8s.io\"]\n    resources: [\"subjectaccessreviews\"]\n    verbs: [\"create\"]\n  apiGroups: [\"multicluster.x-k8s.io\"]\n    resources: [\"serviceexports\"]\n    verbs: [\"get\", \"watch\", \"list\"]\n  apiGroups: [\"multicluster.x-k8s.io\"]\n    resources: [\"serviceimports\"]\n    verbs: [\"get\", \"watch\", \"list\"]\n---\n Source: base/templates/clusterrolebinding.yaml\n-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-\n DO NOT EDIT!\nTHIS IS A LEGACY CHART HERE FOR BACKCOMPAT\n UPDATED CHART AT manifests/charts/istio-control/istio-discovery\n-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-\napiVersion: rbac.authorization.k8s.io/v1\nkind: ClusterRoleBinding\nmetadata:\n  name: istio-reader-istio-system\n  labels:\n    app: istio-reader\n    release: istio-base\nroleRef:\n  apiGroup: rbac.authorization.k8s.io\n  kind: ClusterRole\n  name: istio-reader-istio-system\nsubjects:\n  kind: ServiceAccount\n    name: istio-reader-service-account\n    namespace: istio-system\n---\n Source: base/templates/clusterrolebinding.yaml\napiVersion: rbac.authorization.k8s.io/v1\nkind: ClusterRoleBinding\nmetadata:\n  name: istiod-istio-system\n  labels:\n    app: istiod\n    release: istio-base\nroleRef:\n  apiGroup: rbac.authorization.k8s.io\n  kind: ClusterRole\n  name: istiod-istio-system\nsubjects:\n  kind: ServiceAccount\n    name: istiod-service-account\n    namespace: istio-system\n---\nSource: base/templates/role.yaml\n -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-\nDO NOT EDIT!\n THIS IS A LEGACY CHART HERE FOR BACKCOMPAT\nUPDATED CHART AT manifests/charts/istio-control/istio-discovery\n -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-\napiVersion: rbac.authorization.k8s.io/v1\nkind: Role\nmetadata:\n  name: istiod-istio-system\n  namespace: istio-system\n  labels:\n    app: istiod\n    release: istio-base\nrules:\npermissions to verify the webhook is ready and rejecting\n invalid config. We use --server-dry-run so no config is persisted.\napiGroups: [\"networking.istio.io\"]\n  verbs: [\"create\"]\n  resources: [\"gateways\"]\n\nFor storing CA secret\napiGroups: [\"\"]\n  resources: [\"secrets\"]\n   TODO lock this down to istio-ca-cert if not using the DNS cert mesh config\n  verbs: [\"create\", \"get\", \"watch\", \"list\", \"update\", \"delete\"]\n---\nSource: base/templates/rolebinding.yaml\n -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-\nDO NOT EDIT!\n THIS IS A LEGACY CHART HERE FOR BACKCOMPAT\nUPDATED CHART AT manifests/charts/istio-control/istio-discovery\n -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-\napiVersion: rbac.authorization.k8s.io/v1\nkind: RoleBinding\nmetadata:\n  name: istiod-istio-system\n  namespace: istio-system\n  labels:\n    app: istiod\n    release: istio-base\nroleRef:\n  apiGroup: rbac.authorization.k8s.io\n  kind: Role\n  name: istiod-istio-system\nsubjects:\n  kind: ServiceAccount\n    name: istiod-service-account\n    namespace: istio-system\n---\nSource: base/templates/default.yaml\napiVersion: admissionregistration.k8s.io/v1\nkind: ValidatingWebhookConfiguration\nmetadata:\n  name: istiod-default-validator\n  labels:\n    app: istiod\n    release: istio-base\n    istio: istiod\n    istio.io/rev: default\nwebhooks:\n  name: validation.istio.io\n    clientConfig:\n      service:\n        name: istiod\n        namespace: istio-system\n        path: \"/validate\"\n    rules:\n      operations:\n          CREATE\n          UPDATE\n        apiGroups:\n          security.istio.io\n          networking.istio.io\n        apiVersions:\n          \"*\"\n        resources:\n          \"*\"\n     Fail open until the validation webhook is ready. The webhook controller\n    # will update this to Fail and patch in the caBundle when the webhook\n    # endpoint is ready.\n    failurePolicy: Ignore\n    sideEffects: None\n    admissionReviewVersions: [\"v1beta1\", \"v1\"]\n\n安装Istiod\n\nhelm template istiod manifests/charts/istio-control/istio-discovery     \\\n     --set global.hub=\"registry.cn-hangzhou.aliyuncs.com/seam\"     \\\n     --set global.tag=\"1.13.4\"     \\\n     --set pilot.image=\"istio-pilot\" \\\n     --set meshConfig.trustDomain=\"alongparty.cn\" \\\n     --set global.proxy.clusterDomain=\"alongparty.cn\" \\\n     --set global.proxy.resources.limits.cpu=\"2000m\" \\\n     --set global.proxy.resources.limits.memory=\"4096Mi\" \\\n     --set pilot.resources.limits.cpu=\"2000m\" \\\n     --set pilot.resources.limits.memory=\"4096Mi\" \\\n     -n istio-system\n\n 安装IngressGateway\n\nhelm template istio-ingress manifests/charts/gateways/istio-ingress \\\n    --set global.hub=\"registry.cn-hangzhou.aliyuncs.com/seam\" \\\n    --set global.tag=\"1.13.4\" \\\n    --set global.proxy.image=\"istio-proxyv2\" \\\n    --set meshConfig.trustDomain=\"alongparty.cn\" \\\n    --set global.proxy.clusterDomain=\"alongparty.cn\" \\\n    -n istio-system\n\n安装EgressGateway\n\nhelm template  istio-egress manifests/charts/gateways/istio-egress \\\n    --set global.hub=\"registry.cn-hangzhou.aliyuncs.com/seam\" \\\n    --set global.tag=\"1.13.4\" \\\n    --set global.proxy.image=\"istio-proxyv2\" \\\n    --set meshConfig.trustDomain=\"alongparty.cn\" \\\n    --set global.proxy.clusterDomain=\"alongparty.cn\" \\\n    -n istio-system\n\n Istio-operator安装\n\n创建 istio-operator 名称空间\nkubectl apply -f - <<EOF\n---\napiVersion: v1\nkind: Namespace\nmetadata:\n  name: istio-operator\nEOF\n\n 部署 Istio-operator\nkubectl apply -f - <<EOF\n---\nSource: istio-operator/templates/service_account.yaml\napiVersion: v1\nkind: ServiceAccount\nmetadata:\n  namespace: istio-operator\n  name: istio-operator\n---\n Source: istio-operator/templates/crds.yaml\nSYNC WITH manifests/charts/base/files\napiVersion: apiextensions.k8s.io/v1\nkind: CustomResourceDefinition\nmetadata:\n  name: istiooperators.install.istio.io\n  labels:\n    release: istio\nspec:\n  conversion:\n    strategy: None\n  group: install.istio.io\n  names:\n    kind: IstioOperator\n    listKind: IstioOperatorList\n    plural: istiooperators\n    singular: istiooperator\n    shortNames:\n    iop\n    io\n  scope: Namespaced\n  versions:\n  additionalPrinterColumns:\n    description: Istio control plane revision\n      jsonPath: .spec.revision\n      name: Revision\n      type: string\n    description: IOP current state\n      jsonPath: .status.status\n      name: Status\n      type: string\n    description: 'CreationTimestamp is a timestamp representing the server time\n        when this object was created. It is not guaranteed to be set in happens-before\n        order across separate operations. Clients may not set this value. It is represented\n        in RFC3339 form and is in UTC. Populated by the system. Read-only. Null for\n        lists. More info: https://git.k8s.io/community/contributors/devel/api-conventions.mdmetadata'\n      jsonPath: .metadata.creationTimestamp\n      name: Age\n      type: date\n    name: v1alpha1\n    subresources:\n      status: {}\n    schema:\n      openAPIV3Schema:\n        type: object\n        x-kubernetes-preserve-unknown-fields: true\n    served: true\n    storage: true\n---\nSource: istio-operator/templates/clusterrole.yaml\napiVersion: rbac.authorization.k8s.io/v1\nkind: ClusterRole\nmetadata:\n  creationTimestamp: null\n  name: istio-operator\nrules:\n istio groups\napiGroups:\n  authentication.istio.io\n  resources:\n  '*'\n  verbs:\n  '*'\napiGroups:\n  config.istio.io\n  resources:\n  '*'\n  verbs:\n  '*'\napiGroups:\n  install.istio.io\n  resources:\n  '*'\n  verbs:\n  '*'\napiGroups:\n  networking.istio.io\n  resources:\n  '*'\n  verbs:\n  '*'\napiGroups:\n  security.istio.io\n  resources:\n  '*'\n  verbs:\n  '*'\nk8s groups\napiGroups:\n  admissionregistration.k8s.io\n  resources:\n  mutatingwebhookconfigurations\n  validatingwebhookconfigurations\n  verbs:\n  '*'\napiGroups:\n  apiextensions.k8s.io\n  resources:\n  customresourcedefinitions.apiextensions.k8s.io\n  customresourcedefinitions\n  verbs:\n  '*'\napiGroups:\n  apps\n  extensions\n  resources:\n  daemonsets\n  deployments\n  deployments/finalizers\n  replicasets\n  verbs:\n  '*'\napiGroups:\n  autoscaling\n  resources:\n  horizontalpodautoscalers\n  verbs:\n  '*'\napiGroups:\n  monitoring.coreos.com\n  resources:\n  servicemonitors\n  verbs:\n  get\n  create\n  update\napiGroups:\n  policy\n  resources:\n  poddisruptionbudgets\n  verbs:\n  '*'\napiGroups:\n  rbac.authorization.k8s.io\n  resources:\n  clusterrolebindings\n  clusterroles\n  roles\n  rolebindings\n  verbs:\n  '*'\napiGroups:\n  coordination.k8s.io\n  resources:\n  leases\n  verbs:\n  get\n  create\n  update\napiGroups:\n  \"\"\n  resources:\n  configmaps\n  endpoints\n  events\n  namespaces\n  pods\n  pods/proxy\n  pods/portforward\n  persistentvolumeclaims\n  secrets\n  services\n  serviceaccounts\n  verbs:\n  '*'\n---\n Source: istio-operator/templates/clusterrole_binding.yaml\nkind: ClusterRoleBinding\napiVersion: rbac.authorization.k8s.io/v1\nmetadata:\n  name: istio-operator\nsubjects:\nkind: ServiceAccount\n  name: istio-operator\n  namespace: istio-operator\nroleRef:\n  kind: ClusterRole\n  name: istio-operator\n  apiGroup: rbac.authorization.k8s.io\n---\nSource: istio-operator/templates/service.yaml\napiVersion: v1\nkind: Service\nmetadata:\n  namespace: istio-operator\n  labels:\n    name: istio-operator\n  name: istio-operator\nspec:\n  ports:\n  name: http-metrics\n    port: 8383\n    targetPort: 8383\n    protocol: TCP\n  selector:\n    name: istio-operator\n---\n Source: istio-operator/templates/deployment.yaml\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  namespace: istio-operator\n  name: istio-operator\nspec:\n  replicas: 1\n  revisionHistoryLimit: 10\n  selector:\n    matchLabels:\n      name: istio-operator\n  template:\n    metadata:\n      labels:\n        name: istio-operator\n    spec:\n      serviceAccountName: istio-operator\n      containers:\n        name: istio-operator\n          image: docker.io/istio/operator:1.15.0\n          command:\n          operator\n          server\n          securityContext:\n            allowPrivilegeEscalation: false\n            capabilities:\n              drop:\n              ALL\n            privileged: false\n            readOnlyRootFilesystem: true\n            runAsGroup: 1337\n            runAsUser: 1337\n            runAsNonRoot: true\n          imagePullPolicy: IfNotPresent\n          resources:\n            limits:\n              cpu: 200m\n              memory: 256Mi\n            requests:\n              cpu: 50m\n              memory: 128Mi\n          env:\n            name: WATCH_NAMESPACE\n              value: \"istio-system\"\n            name: LEADERELECTIONNAMESPACE\n              value: \"istio-operator\"\n            name: POD_NAME\n              valueFrom:\n                fieldRef:\n                  fieldPath: metadata.name\n            name: OPERATOR_NAME\n              value: \"istio-operator\"\n            name: WAITFORRESOURCES_TIMEOUT\n              value: \"300s\"\n            name: REVISION\n              value: \"\"\nEOF\n\n创建 istio-system 名称空间\nkubectl apply -f - <<EOF\n---\napiVersion: v1\nkind: Namespace\nmetadata:\n  name: istio-system\nEOF\n 使用demo配置项安装istio组件\nkubectl apply -f - <<EOF\napiVersion: install.istio.io/v1alpha1\nkind: IstioOperator\nmetadata:\n  namespace: istio-system\n  name: istiocontrolplane\nspec:\n  profile: demo\nEOF\n\n更新IstioOperator\nkubectl apply -f - <<EOF\napiVersion: install.istio.io/v1alpha1\nkind: IstioOperator\nmetadata:\n  namespace: istio-system\n  name: istiocontrolplane\nspec:\n  profile: default\nEOF\n\n 启用 istio-egressgateway 组件并增加 pilot 的资源要求和HPA\nkubectl apply -f - <<EOF\napiVersion: install.istio.io/v1alpha1\nkind: IstioOperator\nmetadata:\n  namespace: istio-system\n  name: istiocontrolplane\nspec:\n  profile: default\n  components:\n    pilot:\n      k8s:\n        resources:\n          requests:\n            cpu: 1000m # override from default 500m\n            memory: 4096Mi # ... default 2048Mi\n        hpaSpec:\n          maxReplicas: 10 # ... default 5\n          minReplicas: 2  # ... default 1\n    egressGateways:\n    name: istio-egressgateway\n      enabled: true\nEOF\n\noperator 渲染顺序",
        "tags": []
    },
    {
        "uri": "/zh/blog/istio/深入Istio系列-Istio组件",
        "content": "---\ntitle: 深入Istio系列-Istio组件\nslug: 4bbbf9\ndate: 2022-09-16T18:05:10+08:00\ndraft: true\npassword: 深入Istio\nauthor: kbsonlong\nauthorEmail: kbsonlong@gmail.com\ntags: [\"istio\"]\ncategories: [\"istio\",\"云原生\"]\n\n---\n",
        "tags": []
    },
    {
        "uri": "/zh/blog/istio/深入Istio系列-Pilot agent",
        "content": "---\ntitle: 深入Istio系列-Pilot agent\nslug: 3d18d6\ndate: 2022-09-16T17:25:59+08:00\ndraft: false\npassword: \nauthor: kbsonlong\nauthorEmail: kbsonlong@gmail.com\ntags: [istio,pilot]\ncategories: [\"云原生\",\"Istio\"]\n\n---\n\n查看监听端口和进程\n\nistio-proxy@istio-ingressgateway-799bbc9474-hf7kv:/$ ss -ntlp\nState           Recv-Q          Send-Q                     Local Address:Port                      Peer Address:Port          Process                                       \nLISTEN          0               128                            127.0.0.1:15000                          0.0.0.0:*              users:((\"envoy\",pid=16,fd=18))               \nLISTEN          0               128                            127.0.0.1:15004                          0.0.0.0:*              users:((\"pilot-agent\",pid=1,fd=15))          \nLISTEN          0               128                              0.0.0.0:15021                          0.0.0.0:*              users:((\"envoy\",pid=16,fd=24))               \nLISTEN          0               128                              0.0.0.0:15021                          0.0.0.0:*              users:((\"envoy\",pid=16,fd=23))               \nLISTEN          0               128                              0.0.0.0:8080                           0.0.0.0:*              users:((\"envoy\",pid=16,fd=40))               \nLISTEN          0               128                              0.0.0.0:8080                           0.0.0.0:*              users:((\"envoy\",pid=16,fd=39))               \nLISTEN          0               128                              0.0.0.0:15090                          0.0.0.0:*              users:((\"envoy\",pid=16,fd=22))               \nLISTEN          0               128                              0.0.0.0:15090                          0.0.0.0:*              users:((\"envoy\",pid=16,fd=21))               \nLISTEN          0               128                                    :15020                                *:              users:((\"pilot-agent\",pid=1,fd=12))          \nistio-proxy@istio-ingressgateway-799bbc9474-hf7kv:/$ ps -ef |grep pilot-agent\nistio-p+     1     0  0 Sep14 ?        00:01:27 /usr/local/bin/pilot-agent proxy router --domain istio-system.svc.cluster.local --proxyLogLevel=warning --proxyComponentLogLevel=misc:error --logoutputlevel=default:info\nistio-p+    74    30  0 09:37 pts/0    00:00:00 grep --color=auto pilot-agent\n\n{{ figure src=\"https://raw.githubusercontent.com/kbsonlong/notes_statics/master/images/20220916173915.png\" title=\"\" }}\n!--more--\n\n pilot-agent proxy router 启动参数 \n\nistio-proxy@istio-ingressgateway-799bbc9474-hf7kv:/$ /usr/local/bin/pilot-agent proxy router --help\nXDS proxy agent\n\nUsage:\n  pilot-agent proxy [flags]\n\nFlags:\n      --concurrency int                 number of worker threads to run\n      --domain string                   DNS domain suffix. If not provided uses ${POD_NAMESPACE}.svc.cluster.local\n  -h, --help                            help for proxy\n      --meshConfig string               File name for Istio mesh configuration. If not specified, a default mesh will be used. This may be overridden by PROXY_CONFIG environment variable or proxy.istio.io/config annotation. (default \"./etc/istio/config/mesh\")\n      --outlierLogPath string           The log path for outlier detection\n      --proxyComponentLogLevel string   The component log level used to start the Envoy proxy. Deprecated, use proxyLogLevel instead\n      --proxyLogLevel string            The log level used to start the Envoy proxy (choose from {trace, debug, info, warning, error, critical, off}).Level may also include one or more scopes, such as 'info,misc:error,upstream:debug' (default \"warning,misc:error\")\n      --serviceCluster string           Service cluster (default \"istio-proxy\")\n      --stsPort int                     HTTP Port on which to serve Security Token Service (STS). If zero, STS service will not be provided.\n      --templateFile string             Go template bootstrap config\n      --tokenManagerPlugin string       Token provider specific plugin name. (default \"GoogleTokenExchange\")\n\nGlobal Flags:\n      --logasjson                   Whether to format output as JSON or in plain console-friendly format\n      --log_caller string             Comma-separated list of scopes for which to include caller information, scopes can be any of [ads, all, authn, authorization, ca, cache, citadelclient, controllers, default, delta, dns, gcecred, googleca, googlecas, grpcgen, healthcheck, iptables, klog, mockcred, model, proxyconfig, sds, security, serviceentry, spiffe, stsclient, stsserver, telemetry, token, trustBundle, validation, wasm, wle, xdsproxy]\n      --logoutputlevel string       Comma-separated minimum per-scope logging level of messages to output, in the form of scope:level,scope:level,... where scope can be one of [ads, all, authn, authorization, ca, cache, citadelclient, controllers, default, delta, dns, gcecred, googleca, googlecas, grpcgen, healthcheck, iptables, klog, mockcred, model, proxyconfig, sds, security, serviceentry, spiffe, stsclient, stsserver, telemetry, token, trustBundle, validation, wasm, wle, xdsproxy] and level can be one of [debug, info, warn, error, fatal, none] (default \"default:info\")\n      --log_rotate string             The path for the optional rotating log file\n      --logrotatemax_age int        The maximum age in days of a log file beyond which the file is rotated (0 indicates no limit) (default 30)\n      --logrotatemax_backups int    The maximum number of log file backups to keep before older files are deleted (0 indicates no limit) (default 1000)\n      --logrotatemax_size int       The maximum size in megabytes of a log file beyond which the file is rotated (default 104857600)\n      --logstacktracelevel string   Comma-separated minimum per-scope logging level at which stack traces are captured, in the form of scope:level,scope:level,... where scope can be one of [ads, all, authn, authorization, ca, cache, citadelclient, controllers, default, delta, dns, gcecred, googleca, googlecas, grpcgen, healthcheck, iptables, klog, mockcred, model, proxyconfig, sds, security, serviceentry, spiffe, stsclient, stsserver, telemetry, token, trustBundle, validation, wasm, wle, xdsproxy] and level can be one of [debug, info, warn, error, fatal, none] (default \"default:none\")\n      --log_target stringArray        The set of paths where to output the log. This can be any path as well as the special values stdout and stderr (default [stdout])\n      --vklog Level                   number for the log level verbosity. Like -v flag. ex: --vklog=9\nistio-proxy@istio-ingressgateway-799bbc9474-hf7kv:/$ \n\n{{ figure src=\"https://raw.githubusercontent.com/kbsonlong/notes_statics/master/images/20220916174047.png\" title=\"20220916174047\" }}\n\n查看meshconfig配置\n\nistio-proxy@istio-ingressgateway-799bbc9474-hf7kv:/$ cat ./etc/istio/config/mesh\naccessLogFile: /dev/stdout\ndefaultConfig:\n  discoveryAddress: istiod.istio-system.svc:15012\n  proxyMetadata: {}\n  tracing:\n    zipkin:\n      address: zipkin.istio-system:9411\nenablePrometheusMerge: true\nextensionProviders:\nenvoyOtelAls:\n    port: 4317\n    service: opentelemetry-collector.istio-system.svc.cluster.local\n  name: otel\nrootNamespace: istio-system\ntrustDomain: cluster.local\nistio-proxy@istio-ingressgateway-799bbc9474-hf7kv:/$ \n\n{{ figure src=\"https://raw.githubusercontent.com/kbsonlong/notes_statics/master/images/20220916174246.png\" title=\"20220916174246\" }}\n",
        "tags": []
    },
    {
        "uri": "/zh/blog/istio/深入Istio系列-Pilot 服务发现",
        "content": "---\ntitle: 深入Istio源码- Pilot 服务发现\nslug: 0d0b74\ndate: 2022-09-16T15:47:38+08:00\ndraft: true\npassword: \nauthor: kbsonlong\nauthorEmail: kbsonlong@gmail.com\ntags: [\"istio\",\"pilot\"]\ncategories: [\"云原生\",\"Istio\"]\n\n---\nPilot \n\nPilot 主要功能是从注册中心( Kubernetes 或者 consul )获取信息并汇总，从Kubernetes API Servcer 中获取流量规则，并将服务信息和流量规则转化为数据面可以理解的格式,通过标准的数据面 API 下发到网格中的各个 SideCar。\n!--more--\npilot-discovery 包含了服务发现、配置规则发现、XDS配置下发。\n\n{{ figure src=\"https://raw.githubusercontent.com/kbsonlong/notes_statics/master/images/20220916154637.png\" title=\"Pilot-Discovery架构\" }}\n\n 服务发现工作机制\n\nPilot初始化\nfile: pilot/cmd/pilot-discovery/app/cmd.go\nfunc newDiscoveryCommand() *cobra.Command {\n\treturn &cobra.Command{\n\t\tUse:   \"discovery\",\n\t\tShort: \"Start Istio proxy discovery service.\",\n\t\tArgs:  cobra.ExactArgs(0),\n\t\tPreRunE: func(c *cobra.Command, args []string) error {\n            // 日志配置\n\t\t\tif err := log.Configure(loggingOptions); err != nil {\n\t\t\t\treturn err\n\t\t\t}\n            // 配置参数校验\n\t\t\tif err := validateFlags(serverArgs); err != nil {\n\t\t\t\treturn err\n\t\t\t}\n\t\t\tif err := serverArgs.Complete(); err != nil {\n\t\t\t\treturn err\n\t\t\t}\n\t\t\treturn nil\n\t\t},\n\t\tRunE: func(c *cobra.Command, args []string) error {\n\t\t\tcmd.PrintFlags(c.Flags())\n\n\t\t\t// Create the stop channel for all of the servers.\n\t\t\tstop := make(chan struct{})\n\n\t\t\t// Create the server for the discovery service.\n            // 创建 XDS 服务\n\t\t\tdiscoveryServer, err := bootstrap.NewServer(serverArgs)\n\t\t\tif err != nil {\n\t\t\t\treturn fmt.Errorf(\"failed to create discovery service: %v\", err)\n\t\t\t}\n\n\t\t\t// Start the server\n            // 启动 XDS 服务\n\t\t\tif err := discoveryServer.Start(stop); err != nil {\n\t\t\t\treturn fmt.Errorf(\"failed to start discovery service: %v\", err)\n\t\t\t}\n\n\t\t\tcmd.WaitSignal(stop)\n\t\t\t// Wait until we shut down. In theory this could block forever; in practice we will get\n\t\t\t// forcibly shut down after 30s in Kubernetes.\n            // 等待进程推出\n\t\t\tdiscoveryServer.WaitUntilCompletion()\n\t\t\treturn nil\n\t\t},\n\t}\n}\nPilot服务在运行之前首先会初始化日志配置、校验服务配置，然后创建 XDS 服务。XDS指的是 X Discovery Service的意思。其中 X 代表了一系列的组件如: Cluster、Endpoint、Listener、Route等。\n\nfile: pilot/pkg/bootstrap/server.go\nfunc NewServer(args PilotArgs, initFuncs ...func(Server)) (*Server, error) {\n\te := &model.Environment{\n\t\tPushContext:  model.NewPushContext(),\n\t\tDomainSuffix: args.RegistryOptions.KubeOptions.DomainSuffix,\n\t}\n\te.SetLedger(buildLedger(args.RegistryOptions))\n\n\tac := aggregate.NewController(aggregate.Options{\n\t\tMeshHolder: e,\n\t})\n\te.ServiceDiscovery = ac\n\n\ts := &Server{\n\t\tclusterID:               getClusterID(args),\n\t\tenvironment:             e,\n\t\tfileWatcher:             filewatcher.NewWatcher(),\n\t\thttpMux:                 http.NewServeMux(),\n\t\tmonitoringMux:           http.NewServeMux(),\n\t\treadinessProbes:         make(map[string]readinessProbe),\n\t\tworkloadTrustBundle:     tb.NewTrustBundle(nil),\n\t\tserver:                  server.New(),\n\t\tshutdownDuration:        args.ShutdownDuration,\n\t\tinternalStop:            make(chan struct{}),\n\t\tistiodCertBundleWatcher: keycertbundle.NewWatcher(),\n\t}\n\t// Apply custom initialization functions.\n    // 加载自定义初始化函数\n\tfor _, fn := range initFuncs {\n\t\tfn(s)\n\t}\n\t// Initialize workload Trust Bundle before XDS Server\n\te.TrustBundle = s.workloadTrustBundle\n\ts.XDSServer = xds.NewDiscoveryServer(e, args.Plugins, args.PodName, args.Namespace, args.RegistryOptions.KubeOptions.ClusterAliases)\n\n\tprometheus.EnableHandlingTimeHistogram()\n\n\t// Apply the arguments to the configuration.\n\tif err := s.initKubeClient(args); err != nil {\n\t\treturn nil, fmt.Errorf(\"error initializing kube client: %v\", err)\n\t}\n\n\t// used for both initKubeRegistry and initClusterRegistries\n\targs.RegistryOptions.KubeOptions.EndpointMode = kubecontroller.DetectEndpointMode(s.kubeClient)\n\n\ts.initMeshConfiguration(args, s.fileWatcher)\n\tspiffe.SetTrustDomain(s.environment.Mesh().GetTrustDomain())\n\n\ts.initMeshNetworks(args, s.fileWatcher)\n\ts.initMeshHandlers()\n\ts.environment.Init()\n\tif err := s.environment.InitNetworksManager(s.XDSServer); err != nil {\n\t\treturn nil, err\n\t}\n\n\t// Options based on the current 'defaults' in istio.\n\tcaOpts := &caOptions{\n\t\tTrustDomain:      s.environment.Mesh().TrustDomain,\n\t\tNamespace:        args.Namespace,\n\t\tExternalCAType:   ra.CaExternalType(externalCaType),\n\t\tCertSignerDomain: features.CertSignerDomain,\n\t}\n\n\tif caOpts.ExternalCAType == ra.ExtCAK8s {\n\t\t// Older environment variable preserved for backward compatibility\n\t\tcaOpts.ExternalCASigner = k8sSigner\n\t}\n\t// CA signing certificate must be created first if needed.\n\tif err := s.maybeCreateCA(caOpts); err != nil {\n\t\treturn nil, err\n\t}\n\n    // 初始化处理Istio Config的控制器\n\tif err := s.initControllers(args); err != nil {\n\t\treturn nil, err\n\t}\n\n\ts.XDSServer.InitGenerators(e, args.Namespace)\n\n\t// Initialize workloadTrustBundle after CA has been initialized\n\tif err := s.initWorkloadTrustBundle(args); err != nil {\n\t\treturn nil, err\n\t}\n\n\t// Parse and validate Istiod Address.\n\tistiodHost, _, err := e.GetDiscoveryAddress()\n\tif err != nil {\n\t\treturn nil, err\n\t}\n\n\t// Create Istiod certs and setup watches.\n\tif err := s.initIstiodCerts(args, string(istiodHost)); err != nil {\n\t\treturn nil, err\n\t}\n\n\t// Secure gRPC Server must be initialized after CA is created as may use a Citadel generated cert.\n\tif err := s.initSecureDiscoveryService(args); err != nil {\n\t\treturn nil, fmt.Errorf(\"error initializing secure gRPC Listener: %v\", err)\n\t}\n\n\tvar wh *inject.Webhook\n\t// common https server for webhooks (e.g. injection, validation)\n\tif s.kubeClient != nil {\n\t\ts.initSecureWebhookServer(args)\n\t\twh, err = s.initSidecarInjector(args)\n\t\tif err != nil {\n\t\t\treturn nil, fmt.Errorf(\"error initializing sidecar injector: %v\", err)\n\t\t}\n\t\tif err := s.initConfigValidation(args); err != nil {\n\t\t\treturn nil, fmt.Errorf(\"error initializing config validator: %v\", err)\n\t\t}\n\t}\n\n\twhc := func() map[string]string {\n\t\tif wh != nil {\n\t\t\treturn wh.Config.Templates\n\t\t}\n\t\treturn map[string]string{}\n\t}\n\n\t// Used for readiness, monitoring and debug handlers.\n\tif err := s.initIstiodAdminServer(args, whc); err != nil {\n\t\treturn nil, fmt.Errorf(\"error initializing debug server: %v\", err)\n\t}\n\t// This should be called only after controllers are initialized.\n\ts.initRegistryEventHandlers()\n\n\ts.initDiscoveryService(args)\n\n\ts.initSDSServer()\n\n\t// Notice that the order of authenticators matters, since at runtime\n\t// authenticators are activated sequentially and the first successful attempt\n\t// is used as the authentication result.\n\tauthenticators := []security.Authenticator{\n\t\t&authenticate.ClientCertAuthenticator{},\n\t}\n\tif args.JwtRule != \"\" {\n\t\tjwtAuthn, err := initOIDC(args, s.environment.Mesh().TrustDomain)\n\t\tif err != nil {\n\t\t\treturn nil, fmt.Errorf(\"error initializing OIDC: %v\", err)\n\t\t}\n\t\tif jwtAuthn == nil {\n\t\t\treturn nil, fmt.Errorf(\"JWT authenticator is nil\")\n\t\t}\n\t\tauthenticators = append(authenticators, jwtAuthn)\n\t}\n\t// The k8s JWT authenticator requires the multicluster registry to be initialized,\n\t// so we build it later.\n\tauthenticators = append(authenticators,\n\t\tkubeauth.NewKubeJWTAuthenticator(s.environment.Watcher, s.kubeClient, s.clusterID, s.multiclusterController.GetRemoteKubeClient, features.JwtPolicy))\n\tif features.XDSAuth {\n\t\ts.XDSServer.Authenticators = authenticators\n\t}\n\tcaOpts.Authenticators = authenticators\n\n\t// Start CA or RA server. This should be called after CA and Istiod certs have been created.\n\ts.startCA(caOpts)\n\n\t// TODO: don't run this if galley is started, one ctlz is enough\n\tif args.CtrlZOptions != nil {\n\t\t_, _ = ctrlz.Run(args.CtrlZOptions, nil)\n\t}\n\n\t// This must be last, otherwise we will not know which informers to register\n\tif s.kubeClient != nil {\n\t\ts.addStartFunc(func(stop <-chan struct{}) error {\n\t\t\ts.kubeClient.RunAndWait(stop)\n\t\t\treturn nil\n\t\t})\n\t}\n\n\ts.addReadinessProbe(\"discovery\", func() (bool, error) {\n\t\treturn s.XDSServer.IsServerReady(), nil\n\t})\n\n\treturn s, nil\n}\n\n",
        "tags": []
    },
    {
        "uri": "/zh/blog/istio/深入Istio系列-Sidecar 中的流量类型及 iptables 规则详解",
        "content": "---\ntitle: 深入Istio系列-Sidecar 中的流量类型及 iptables 规则详解\nslug: 61aaaf\ndate: 2022-09-11T14:56:39+08:00\ndraft: false\nauthor: kbsonlong\nauthorEmail: kbsonlong@gmail.com\ntags: [sicader,转载]\ncategories: [云原生]\n\n---\n\n我在之前的一篇博客中讲解过 Istio 中 sidecar 的注入、使用 iptables 进行透明流量拦截及流量路由的详细过程，并以 Bookinfo 示例中的 productpage 服务访问 reviews 服务，和 reviews 服务访问 ratings 服务为例绘制了透明流量劫持示意图。在那个示意图中仅展示了 reviews pod 接收流量和对外访问的路由，实际上 sidecar 内的流量远不止于此。\n\nISTIO_OUTPUT 规则\n\n在所有的 iptables 调用链中最复杂的一个是 ISTIO_OUTPUT，其中共有 9 条规则如下：\n\n| Rule | target        | in | out | source | destination                 |\n| -------- | ----------------- | ------ | ------- | ---------- | ------------------------------- |\n| 1        | RETURN            | any    | lo      | 127.0.0.6  | anywhere                        |\n| 2        | ISTIOINREDIRECT | any    | lo      | anywhere   | !localhost owner UID match 1337 |\n| 3        | RETURN            | any    | lo      | anywhere   | anywhere !owner UID match 1337  |\n| 4        | RETURN            | any    | any     | anywhere   | anywhere owner UID match 1337   |\n| 5        | ISTIOINREDIRECT | any    | lo      | anywhere   | !localhost owner GID match 1337 |\n| 6        | RETURN            | any    | lo      | anywhere   | anywhere !owner GID match 1337  |\n| 7        | RETURN            | any    | any     | anywhere   | anywhere owner GID match 1337   |\n| 8        | RETURN            | any    | any     | anywhere   | localhost                       |\n| 9        | ISTIO_REDIRECT    | any    | any     | anywhere   | anywhere                        |\n\n本文将向你展示 Istio sidecar 中的六种流量类型及其 iptables 规则， 以示意图的形式带你一览其全貌，其中详细指出了路由具体使用的是 ISTIO_OUTPUT 中的哪一条规则。\n\n Sidecar 中的 iptables 流量路由\n\nSidecar 中的流量可以划分为以下几类：\n\n远程服务访问本地服务：Remote Pod - Local Pod\n本地服务访问远程服务：Local Pod - Remote Pod\nPrometheus 抓取本地服务的 metrics：Prometheus - Local Pod\n本地 Pod 服务间的流量：Local Pod - Local Pod\nEnvoy 内部的进程间 TCP 流量\nSidecar 到 Istiod 的流量\n\n下面将依次解释每个场景下 Sidecar 内的 iptables 路由规则。\n\n类型一：Remote Pod - Local Pod\n\n以下是远程服务、应用或客户端访问数据平面本地 Pod IP 的 iptables 规则。\n\nRemote Pod - RREROUTING - ISTIOINBOUND - ISTIOINREDIRECT - Envoy 15006（Inbound）- OUTPUT - **ISTIOOUTPUT RULE 1** - POSTROUTING - Local Pod\n\n我们看到流量只经过一次 Envoy 15006 Inbound 端口。这种场景下的 iptables 规则的示意图如下。\n\n 类型二：Local Pod - Remote Pod\n\n以下是本地 Pod IP 访问远程服务经过的 iptables 规则。\n\nLocal Pod- OUTPUT - ISTIO_OUTPUT RULE 9 - ISTIOREDIRECT - Envoy 15001（Outbound）- OUTPUT - **ISTIOOUTPUT RULE 4** - POSTROUTING - Remote Pod\n\n我们看到流量只经过 Envoy 15001 Outbound 端口。\n\n以上两种场景中的流量都只经过一次 Envoy，因为该 Pod 中只有发出或接受请求一种场景发生。\n\n类型三：Prometheus - Local Pod\n\nPrometheus 抓取数据平面 metrics 的流量不会也无须经过 Envoy 代理。\n\n这些流量通过的 iptables 规则如下。\n\nPrometheus- RREROUTING - ISTIO_INBOUND（对目的地为 15002、15090 端口流量将转到 INPUT）- INPUT -  Local Pod\n\n这种场景下的 iptables 规则的示意图如下。\n\n 类型四：Local Pod - Local Pod\n\n一个 Pod 可能同时存在两个或多个服务，如果 Local Pod 访问的服务也在该当前 Pod 上，流量会依次经过 Envoy 15001 和 Envoy 15006 端口最后到达本地 Pod 的服务端口上。\n\n这些流量通过的 iptables 规则如下。\n\nLocal Pod- OUTPUT - ISTIO_OUTPUT RULE 9 - ISTIOREDIRECT - Envoy 15001（Outbound）- OUTPUT - **ISTIOOUTPUT RULE 2* - ISTIO_IN_REDIRECT - Envoy 15006（Inbound）- OUTPUT - *ISTIO_OUTPUT RULE 1** - POSTROUTING - Local Pod\n\n类型五：Envoy 内部的进程间 TCP 流量\n\nEnvoy 内部进程的 UID 和 GID 为 1337，它们之间的流量将使用 lo 网卡，使用 localhost 域名来通信。\n\n这些流量通过的 iptables 规则如下。\n\nEnvoy 进程（Localhost） - OUTPUT - ISTIO_OUTPUT RULE 8 - POSTROUTING - Envoy 进程（Localhost）\n\n 类型六：Sidecar 到 Istiod 的流量\n\nSidecar 需要访问 Istiod 以同步配置，pilot-agent 进程会向 Istiod 发送请求，以同步配置。\n\n这些流量通过的 iptables 规则如下。\n\npilot-agent 进程 - OUTPUT - Istio_OUTPUT RULE 9 - Envoy 15001 (Outbound Handler) - OUTPUT - ISTIO_OUTPUT RULE 4 - POSTROUTING  - Istiod\n\n总结\n\nIstio 注入在 Pod 内或虚拟机中安装的所有 sidecar 代理组成了服务网格的数据平面，也是 Istio 的主要工作负载所在地，通过 Istio 中的透明流量劫持 及这篇博客，相信你一定对 sidecar 代理中的流量有了一个深刻的了解，但这还只是管中窥豹，略见一斑，在我的下一篇博客中，我将带你了解 Envoy 中各个组件的端口及其功能，这样可以让我们对 Istio 中的流量有一个更全面的了解。\n",
        "tags": []
    },
    {
        "uri": "/zh/blog/istio/深入Istio系列-Sidecar 注入、透明流量劫持及流量路由过程详解",
        "content": "---\ntitle: 深入Istio系列-Sidecar 注入、透明流量劫持及流量路由过程详解\nslug: fe0ba1\ndate: 2022-09-11T14:26:02+08:00\ndraft: false\nauthor: kbsonlong\nauthorEmail: kbsonlong@gmail.com\ntags: [istio,转载]\ncategories: [云原生]\n\n---\n\n本文最早是基于 Istio 1.11 撰写，之后随着 Istio 的版本陆续更新，最新更新时间为 2022 年 5 月 12 日，关于本文历史版本的更新说明请见文章最后。本文记录了详细的实践过程，力图能够让读者复现，因此事无巨细，想要理解某个部分过程的读者可以使用目录跳转到对应的小节阅读。\n\n为了理解本文希望你先阅读以下内容：\n\n理解 iptables\nIstio 数据平面 Pod 启动过程详解\n\n内容介绍\n\n本文基于 Istio 1.13 版本，将为大家介绍以下内容：\n\n什么是 sidecar 模式和它的优势在哪里。\nIstio 中是如何做 sidecar 注入的。\nSidecar 代理是如何做透明流量劫持的。\niptables 的路由规则。\nEnvoy 代理是如何路由流量到上游的。\n\n请大家结合下图理解本文中的内容，本图基于 Istio 官方提供的 Bookinfo 示例绘制，展示的是 reviews Pod 的内部结构，包括 Linux Kernel 空间中的 iptables 规则、Sidecar 容器、应用容器。\n\nproductpage 访问 reviews Pod，入站流量处理过程对应于图示上的步骤：1、2、3、4、Envoy Inbound Handler、5、6、7、8、应用容器。\n\nreviews Pod 访问 rating 服务的出站流量处理过程对应于图示上的步骤是：9、10、11、12、Envoy Outbound Handler、13、14、15。\n\n注意：图中的路径 16 近用于路由规则说明，它不不出现在当前示例中。实际上仅当 Pod 内发出的对当前 Pod 内的服务访问的时候才会途径它。\n\n上图中关于流量路由部分，包含：\n\nproductpage 服务请求访问 http://reviews.default.svc.cluster.local:9080/，当流量进入 reviews Pod 内部时，流量是如何被 iptables 劫持到 Envoy 代理被 Inbound Handler 处理的；\nreviews 请求访问 ratings 服务的 Pod，应用程序发出的出站流量被 iptables 劫持到 Envoy 代理的 Outbound Handler 的处理。\n\n在阅读下文时，请大家确立以下已知点：\n\n首先，productpage 发出的对 reivews 的访问流量，是在 Envoy 已经通过 EDS 选择出了要请求的 reviews 服务的某个 Pod，知晓了其 IP 地址，直接向该 IP 发送的 TCP 连接请求。\nreviews 服务有三个版本，每个版本有一个实例，三个版本中的 sidecar 工作步骤类似，下文只以其中一个 Pod 中的 sidecar 流量转发步骤来说明。\n所有进入 reviews Pod 的 TCP 流量都根据 Pod 中的 iptables 规则转发到了 Envoy 代理的 15006 端口，然后经过 Envoy 的处理确定转发给 Pod 内的应用容器还是透传。\n\n Sidecar 模式\n\n将应用程序的功能划分为单独的进程运行在同一个最小调度单元中（例如 Kubernetes 中的 Pod）可以被视为 sidecar 模式。如下图所示，sidecar 模式允许您在应用程序旁边添加更多功能，而无需额外第三方组件配置或修改应用程序代码。\n\n就像连接了 Sidecar 的三轮摩托车一样，在软件架构中， Sidecar 连接到父应用并且为其添加扩展或者增强功能。Sidecar 应用与主应用程序松散耦合。它可以屏蔽不同编程语言的差异，统一实现微服务的可观察性、监控、日志记录、配置、断路器等功能。\n\n使用 Sidecar 模式的优势\n\n使用 sidecar 模式部署服务网格时，无需在节点上运行代理，但是集群中将运行多个相同的 sidecar 副本。在 sidecar 部署方式中，每个应用的容器旁都会部署一个伴生容器（如 Envoy 或 MOSN），这个容器称之为 sidecar 容器。Sidecar 接管进出应用容器的所有流量。在 Kubernetes 的 Pod 中，在原有的应用容器旁边注入一个 Sidecar 容器，两个容器共享存储、网络等资源，可以广义的将这个包含了 sidecar 容器的 Pod 理解为一台主机，两个容器共享主机资源。\n\n因其独特的部署结构，使得 sidecar 模式具有以下优势：\n\n将与应用业务逻辑无关的功能抽象到共同基础设施，降低了微服务代码的复杂度。\n因为不再需要编写相同的第三方组件配置文件和代码，所以能够降低微服务架构中的代码重复度。\nSidecar 可独立升级，降低应用程序代码和底层平台的耦合度。\n\n Sidecar 注入示例分析\n\n以 Istio 官方提供的 bookinfo 中 productpage 的 YAML 为例，关于 bookinfo 应用的详细 YAML 配置请参考 bookinfo.yaml。\n\n下文将从以下几个方面讲解：\n\nSidecar 容器的注入\niptables 规则的创建\n路由的详细过程\n\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: productpage-v1\n  labels:\n    app: productpage\n    version: v1\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: productpage\n      version: v1\n  template:\n    metadata:\n      labels:\n        app: productpage\n        version: v1\n    spec:\n      serviceAccountName: bookinfo-productpage\n      containers:\n      name: productpage\n        image: docker.io/istio/examples-bookinfo-productpage-v1:1.15.0\n        imagePullPolicy: IfNotPresent\n        ports:\n        containerPort: 9080\n        volumeMounts:\n        name: tmp\n          mountPath: /tmp\n      volumes:\n      name: tmp\n        emptyDir: {}\n\n再查看下 productpage 容器的 Dockerfile。\n\nFROM python:3.7.4-slim\n\nCOPY requirements.txt ./\nRUN pip install --no-cache-dir -r requirements.txt\n\nCOPY test-requirements.txt ./\nRUN pip install --no-cache-dir -r test-requirements.txt\n\nCOPY productpage.py /opt/microservices/\nCOPY tests/unit/* /opt/microservices/\nCOPY templates /opt/microservices/templates\nCOPY static /opt/microservices/static\nCOPY requirements.txt /opt/microservices/\n\nARG flood_factor\nENV FLOODFACTOR ${floodfactor:-0}\n\nEXPOSE 9080\nWORKDIR /opt/microservices\nRUN python -m unittest discover\n\nUSER 1\n\nCMD [\"python\", \"productpage.py\", \"9080\"]\n\n我们看到 Dockerfile 中没有配置 ENTRYPOINT，所以 CMD 的配置 python productpage.py 9080 将作为默认的 ENTRYPOINT，记住这一点，再看下注入 sidecar 之后的配置。\n\n$ istioctl kube-inject -f samples/bookinfo/platform/kube/bookinfo.yaml\n\n我们只截取其中与 productpage 相关的 Deployment 配置中的部分 YAML 配置。\n\n      containers:\n      image: docker.io/istio/examples-bookinfo-productpage-v1:1.15.0 # 应用镜像\n        name: productpage\n        ports:\n        containerPort: 9080\n      args:\n        proxy\n        sidecar\n        --domain\n        $(POD_NAMESPACE).svc.cluster.local\n        --configPath\n        /etc/istio/proxy\n        --binaryPath\n        /usr/local/bin/envoy\n        --serviceCluster\n        productpage.$(POD_NAMESPACE)\n        --drainDuration\n        45s\n        --parentShutdownDuration\n        1m0s\n        --discoveryAddress\n        istiod.istio-system.svc:15012\n        --zipkinAddress\n        zipkin.istio-system:9411\n        --proxyLogLevel=warning\n        --proxyComponentLogLevel=misc:error\n        --connectTimeout\n        10s\n        --proxyAdminPort\n        \"15000\"\n        --concurrency\n        \"2\"\n        --controlPlaneAuthPolicy\n        NONE\n        --dnsRefreshRate\n        300s\n        --statusPort\n        \"15020\"\n        --trust-domain=cluster.local\n        --controlPlaneBootstrap=false\n        image: docker.io/istio/proxyv2:1.5.1 # sidecar proxy\n        name: istio-proxy\n        ports:\n        containerPort: 15090\n          name: http-envoy-prom\n          protocol: TCP\n      initContainers:\n      command:\n        istio-iptables\n        -p\n        \"15001\"\n        -z\n        \"15006\"\n        -u\n        \"1337\"\n        -m\n        REDIRECT\n        -i\n        '*'\n        -x\n        \"\"\n        -b\n        '*'\n        -d\n        15090,15020\n        image: docker.io/istio/proxyv2:1.5.1 # init 容器\n        name: istio-init\n\nIstio 给应用 Pod 注入的配置主要包括：\n\nInit 容器 istio-init：用于 pod 中设置 iptables 端口转发\nSidecar 容器 istio-proxy：运行 sidecar 代理，如 Envoy 或 MOSN。\n\niptables 规则注入解析\n\n为了查看 iptables 配置，我们需要登陆到 sidecar 容器中使用 root 用户来查看，因为 kubectl 无法使用特权模式来远程操作 docker 容器，所以我们需要登陆到 productpage pod 所在的主机上使用 docker 命令登陆容器中查看。\n\n如果您使用 minikube 部署的 Kubernetes，可以直接登录到 minikube 的虚拟机中并切换为 root 用户。查看 iptables 配置，列出 NAT（网络地址转换）表的所有规则，因为在 Init 容器启动的时候选择给 istio-iptables 传递的参数中指定将入站流量重定向到 sidecar 的模式为 REDIRECT，因此在 iptables 中将只有 NAT 表的规格配置，如果选择 TPROXY 还会有 mangle 表配置。iptables 命令的详细用法请参考 iptables 命令。\n\n我们仅查看与 productpage 有关的 iptables 规则如下，因为这些规则是运行在该容器特定的网络空间下，因此需要使用 nsenter 命令进入其网络空间。进入的时候需要指定进程 ID（PID），因此首先我们需要找到 productpage 容器的 PID。对于在不同平台上安装的 Kubernetes，查找容器的方式会略有不同，例如在 GKE 上，执行 docker ps -a 命令是查看不到任何容器进程的。下面已 minikube 和 GKE 两个典型的平台为例，指导你如何进入容器的网络空间。\n\n 在 minikube 中查看容器中的 iptabes 规则\n\n对于 minikube，因为所有的进程都运行在单个节点上，因此你只需要登录到 minikube 虚拟机，切换为 root 用户然后查找 productpage 进程即可，参考下面的步骤。\n\n进入 minikube 并切换为 root 用户，minikube 默认用户为 docker\n$ minikube ssh\n$ sudo -i\n\n 查看 productpage pod 的 istio-proxy 容器中的进程\n$ docker top docker ps|grep \"istio-proxy_productpage\"|cut -d \" \" -f1\nUID                 PID                 PPID                C                   STIME               TTY                 TIME                CMD\n1337                10576               10517               0                   08:09               ?                   00:00:07            /usr/local/bin/pilot-agent proxy sidecar --domain default.svc.cluster.local --configPath /etc/istio/proxy --binaryPath /usr/local/bin/envoy --serviceCluster productpage.default --drainDuration 45s --parentShutdownDuration 1m0s --discoveryAddress istiod.istio-system.svc:15012 --zipkinAddress zipkin.istio-system:9411 --proxyLogLevel=warning --proxyComponentLogLevel=misc:error --connectTimeout 10s --proxyAdminPort 15000 --concurrency 2 --controlPlaneAuthPolicy NONE --dnsRefreshRate 300s --statusPort 15020 --trust-domain=cluster.local --controlPlaneBootstrap=false\n1337                10660               10576               0                   08:09               ?                   00:00:33            /usr/local/bin/envoy -c /etc/istio/proxy/envoy-rev0.json --restart-epoch 0 --drain-time-s 45 --parent-shutdown-time-s 60 --service-cluster productpage.default --service-node sidecar~172.17.0.16~productpage-v1-7f44c4d57c-ksf9b.default~default.svc.cluster.local --max-obj-name-len 189 --local-address-ip-version v4 --log-format Envoy (Epoch 0)] [%Y-%m-%d %T.%e%l %v -l warning --component-log-level misc:error --concurrency 2\n\n使用 nsenter 进入 sidecar 容器的命名空间（以上任何一个都可以）\n$ nsenter -n --target 10660\n\n 查看 NAT 表中规则配置的详细信息。\n$ iptables -t nat -L\n\n在 GKE 中查看容器的 iptables 规则\n\n如果你在 GKE 中安装的多节点的 Kubernetes 集群，首先你需要确定这个 Pod 运行在哪个节点上，然后登陆到那台主机，使用下面的命令查找进程的 PID，你会得到类似下面的输出。\n\n$ ps aux|grep \"productpage\"\nchronos     4268  0.0  0.6  43796 24856 ?        Ss   Apr22   0:00 python productpage.py 9080\nchronos     4329  0.9  0.6 117524 24616 ?        Sl   Apr22  13:43 /usr/local/bin/python /opt/microservices/productpage.py 9080\nroot      361903  0.0  0.0   4536   812 pts/0    S+   01:54   0:00 grep --colour=auto productpage\n\n然后在终端中输出 iptables -t nat -L 即可查看 iptables 规则。\n\n iptables 流量劫持过程详解\n\n经过上面的步骤，你已经可以查看到 init 容器向 Pod 中注入的 iptables 规则，如下所示。\n\nPREROUTING 链：用于目标地址转换（DNAT），将所有入站 TCP 流量跳转到 ISTIO_INBOUND 链上。\nChain PREROUTING (policy ACCEPT 2701 packets, 162K bytes)\n pkts bytes target     prot opt in     out     source               destination\n 2701  162K ISTIO_INBOUND  tcp  --  any    any     anywhere             anywhere\n\n INPUT 链：处理输入数据包，非 TCP 流量将继续 OUTPUT 链。\nChain INPUT (policy ACCEPT 2701 packets, 162K bytes)\n pkts bytes target     prot opt in     out     source               destination\n\nOUTPUT 链：将所有出站数据包跳转到 ISTIO_OUTPUT 链上。\nChain OUTPUT (policy ACCEPT 79 packets, 6761 bytes)\n pkts bytes target     prot opt in     out     source               destination\n   15   900 ISTIO_OUTPUT  tcp  --  any    any     anywhere             anywhere\n\n POSTROUTING 链：所有数据包流出网卡时都要先进入 POSTROUTING 链，内核根据数据包目的地判断是否需要转发出去，我们看到此处未做任何处理。\nChain POSTROUTING (policy ACCEPT 79 packets, 6761 bytes)\n pkts bytes target     prot opt in     out     source               destination\n\nISTIOINBOUND 链：将所有入站流量重定向到 ISTIOIN_REDIRECT 链上。目的地为 15090（Prometheus 使用）和 15020（Ingress gateway 使用，用于 Pilot 健康检查）端口的流量除外，发送到以上两个端口的流量将返回 iptables 规则链的调用点，即 PREROUTING 链的后继 POSTROUTING 后直接调用原始目的地。\nChain ISTIO_INBOUND (1 references)\n pkts bytes target     prot opt in     out     source               destination\n    0     0 RETURN     tcp  --  any    any     anywhere             anywhere             tcp dpt:ssh\n    2   120 RETURN     tcp  --  any    any     anywhere             anywhere             tcp dpt:15090\n 2699  162K RETURN     tcp  --  any    any     anywhere             anywhere             tcp dpt:15020\n    0     0 ISTIOINREDIRECT  tcp  --  any    any     anywhere             anywhere\n\n ISTIOINREDIRECT 链：将所有的入站流量跳转到本地的 15006 端口，至此成功的拦截了流量到 sidecar 代理的 Inbound Handler 中。\nChain ISTIOINREDIRECT (3 references)\n pkts bytes target     prot opt in     out     source               destination\n    0     0 REDIRECT   tcp  --  any    any     anywhere             anywhere             redir ports 15006\n\nISTIO_OUTPUT 链：规则比较复杂，将在下文解释\nChain ISTIO_OUTPUT (1 references)\n pkts bytes target     prot opt in     out     source               destination\n    0     0 RETURN     all  --  any    lo      127.0.0.6            anywhere 规则1\n    0     0 ISTIOINREDIRECT  all  --  any    lo      anywhere            !localhost            owner UID match 1337 #规则2\n    0     0 RETURN     all  --  any    lo      anywhere             anywhere             ! owner UID match 1337 #规则3\n   15   900 RETURN     all  --  any    any     anywhere             anywhere             owner UID match 1337 #规则4\n    0     0 ISTIOINREDIRECT  all  --  any    lo      anywhere            !localhost            owner GID match 1337 #规则5\n    0     0 RETURN     all  --  any    lo      anywhere             anywhere             ! owner GID match 1337 #规则6\n    0     0 RETURN     all  --  any    any     anywhere             anywhere             owner GID match 1337 #规则7\n    0     0 RETURN     all  --  any    any     anywhere             localhost #规则8\n    0     0 ISTIO_REDIRECT  all  --  any    any     anywhere             anywhere #规则9\n\nISTIO_REDIRECT 链：将所有流量重定向到 Envoy 代理的 15001 端口。\nChain ISTIO_REDIRECT (1 references)\n pkts bytes target     prot opt in     out     source               destination\n    0     0 REDIRECT   tcp  --  any    any     anywhere             anywhere             redir ports 15001\n\n这里着重需要解释的是 ISTIO_OUTPUT 链中的 9 条规则，为了便于阅读，我将以上规则中的部分内容使用表格的形式来展示如下：\n\n| 规则 | target        | in | out | source | destination                 |\n| -------- | ----------------- | ------ | ------- | ---------- | ------------------------------- |\n| 1        | RETURN            | any    | lo      | 127.0.0.6  | anywhere                        |\n| 2        | ISTIOINREDIRECT | any    | lo      | anywhere   | !localhost owner UID match 1337 |\n| 3        | RETURN            | any    | lo      | anywhere   | anywhere !owner UID match 1337  |\n| 4        | RETURN            | any    | any     | anywhere   | anywhere owner UID match 1337   |\n| 5        | ISTIOINREDIRECT | any    | lo      | anywhere   | !localhost owner GID match 1337 |\n| 6        | RETURN            | any    | lo      | anywhere   | anywhere !owner GID match 1337  |\n| 7        | RETURN            | any    | any     | anywhere   | anywhere owner GID match 1337   |\n| 8        | RETURN            | any    | any     | anywhere   | localhost                       |\n| 9        | ISTIO_REDIRECT    | any    | any     | anywhere   | anywhere                        |\n\n下图展示了 ISTIO_ROUTE 规则的详细流程。\n\n我将按照规则的出现顺序来解释每条规则的目的、对应文章开头图示中的步骤及详情。其中规则 5、6、7 是分别对规则 2、3、4 的应用范围扩大（从 UID 扩大为 GID），作用是类似的，将合并解释。注意，其中的规则是按顺序执行的，也就是说排序越靠后的规则将作为默认值。出站网卡（out）为 lo （本地回环地址，loopback 接口）时，表示流量的目的地是本地 Pod，对于 Pod 向外部发送的流量就不会经过这个接口。所有 review Pod 的出站流量只适用于规则 4、7、8、9。\n\n规则 1\n\n目的：透传 Envoy 代理发送到本地应用容器的流量，使其绕过 Envoy 代理，直达应用容器。\n对应图示中的步骤：6 到 7。\n详情：该规则使得所有来自 127.0.0.6（该 IP 地址将在下文解释） 的请求，跳出该链，返回 iptables 的调用点（即 OUTPUT）后继续执行其余路由规则，即 POSTROUTING 规则，把流量发送到任意目的地址，如本地 Pod 内的应用容器。如果没有这条规则，由 Pod 内 Envoy 代理发出的对 Pod 内容器访问的流量将会执行下一条规则，即规则 2，流量将再次进入到了 Inbound Handler 中，从而形成了死循环。将这条规则放在第一位可以避免流量在 Inbound Handler 中死循环的问题。\n\n规则 2、5\n\n目的：处理 Envoy 代理发出的站内流量（Pod 内部的流量），但不是对 localhost 的请求，通过后续规则将其转发给 Envoy 代理的 Inbound Handler。该规则适用于 Pod 对自身 IP 地址调用的场景，即 Pod 内服务之间的访问。\n详情：如果流量的目的地非 localhost，且数据包是由 1337 UID（即 istio-proxy 用户，Envoy 代理）发出的，流量将被经过 ISTIOINREDIRECT 最终转发到 Envoy 的 Inbound Handler。\n\n规则 3、6\n\n目的：透传 Pod 内的应用容器的站内流量。该规则适用于容器内部的流量。例如在 Pod 内对 Pod IP 或 localhost 的访问。\n对应图示中的步骤：6 到 7。\n详情：如果流量不是由 Envoy 用户发出的，那么就跳出该链，返回 OUTPUT 调用 POSTROUTING，直达目的地。\n\n规则 4、7\n\n目的：透传  Envoy 代理发出的出站请求。\n对应图示中的步骤：14 到 15。\n详情：如果请求是由 Envoy 代理发出的，则返回 OUTPUT 继续调用 POSTROUTING 规则，最终直接访问目的地。\n\n规则 8\n\n目的：透传 Pod 内部对 localhost 的请求。\n详情：如果请求的目的地是 localhost，则返回 OUTPUT 调用 POSTROUTING，直接访问 localhost。\n\n规则 9\n\n目的：所有其他的流量将被转发到 ISTIO_REDIRECT 后，最终达到 Envoy 代理的 Outbound Handler。\n对应图示中的步骤：10 到 11。\n\n以上规则避免了 Envoy 代理到应用程序的路由在 iptables 规则中的死循环，保障了流量可以被正确的路由到 Envoy 代理上，也可以发出真正的出站请求。\n\n关于 RETURN target\n\n你可能留意到上述规则中有很多 RETURN target，它的意思是，指定到这条规则时，跳出该规则链，返回 iptables 的调用点（在我们的例子中即 OUTPUT）后继续执行其余路由规则，在我们的例子中即 POSTROUTING 规则，把流量发送到任意目的地址，你可以把它直观的理解为透传。\n\n关于 127.0.0.6 IP 地址\n\n127.0.0.6 这个 IP 是 Istio 中默认的 InboundPassthroughClusterIpv4，在 Istio 的代码中指定。即流量在进入 Envoy 代理后被绑定的 IP 地址，作用是让 Outbound 流量重新发送到  Pod 中的应用容器，即 Passthought（透传），绕过 Outbound Handler。该流量是对 Pod 自身的访问，而不是真正的对外流量。至于为什么选择这个 IP 作为流量透传，请参考 Istio Issue-29603。\n\n 流量路由过程详解\n\n通过上文，你已经了解了 Istio 是如何在 Pod 中做透明流量劫持的，那么流量被劫持到 Envoy 代理中之后是如何被处理的呢？流量路由分为 Inbound 和 Outbound 两个过程，下面将根据上文中的示例及 sidecar 的配置为读者详细分析此过程。\n\n理解 Inbound Handler\n\nInbound Handler 的作用是将 iptables 拦截到的 downstream 的流量转发给 Pod 内的应用程序容器。在我们的实例中，假设其中一个 Pod 的名字是 reviews-v1-545db77b95-jkgv2，运行 istioctl proxy-config listener reviews-v1-545db77b95-jkgv2 --port 15006 查看该 Pod 中 15006 端口上的监听器情况 ，你将看到下面的输出。\n\nADDRESS PORT  MATCH                                                                                           DESTINATION\n0.0.0.0 15006 Addr: *:15006                                                                                   Non-HTTP/Non-TCP\n0.0.0.0 15006 Trans: tls; App: istio-http/1.0,istio-http/1.1,istio-h2; Addr: 0.0.0.0/0                        InboundPassthroughClusterIpv4\n0.0.0.0 15006 Trans: raw_buffer; App: http/1.1,h2c; Addr: 0.0.0.0/0                                           InboundPassthroughClusterIpv4\n0.0.0.0 15006 Trans: tls; App: TCP TLS; Addr: 0.0.0.0/0                                                       InboundPassthroughClusterIpv4\n0.0.0.0 15006 Trans: raw_buffer; Addr: 0.0.0.0/0                                                              InboundPassthroughClusterIpv4\n0.0.0.0 15006 Trans: tls; Addr: 0.0.0.0/0                                                                     InboundPassthroughClusterIpv4\n0.0.0.0 15006 Trans: tls; App: istio,istio-peer-exchange,istio-http/1.0,istio-http/1.1,istio-h2; Addr: *:9080 Cluster: inbound|9080||\n0.0.0.0 15006 Trans: raw_buffer; Addr: *:9080                                                                 Cluster: inbound|9080||\n\n下面列出了以上输出中各字段的含义：\n\nADDRESS：下游地址\nPORT：Envoy 监听器监听的端口\nMATCH：请求使用的传输协议或匹配的下游地址\nDESTINATION：路由目的地\n\nreviews Pod 中的 Iptables 将入站流量劫持到 15006 端口上，从上面的输出我们可以看到 Envoy 的 Inbound Handler 在 15006 端口上监听，对目的地为任何 IP 的 9080 端口的请求将路由到 inbound|9080|| Cluster 上。\n\n从该 Pod 的 Listener 列表的最后两行中可以看到，0.0.0.0:15006/TCP 的 Listener（其实际名字是 virtualInbound）监听所有的 Inbound 流量，其中包含了匹配规则，来自任意 IP 的对 9080 端口的访问流量，将会路由到 inbound|9080|| Cluster，如果你想以 Json 格式查看该 Listener 的详细配置，可以执行 istioctl proxy-config listeners reviews-v1-545db77b95-jkgv2 --port 15006 -o json 命令，你将获得类似下面的输出。\n\n[\n    /省略部分内容/\n    {\n        \"name\": \"virtualInbound\",\n        \"address\": {\n            \"socketAddress\": {\n                \"address\": \"0.0.0.0\",\n                \"portValue\": 15006\n            }\n        },\n        \"filterChains\": [\n            /省略部分内容/\n            {\n                \"filterChainMatch\": {\n                    \"destinationPort\": 9080,\n                    \"transportProtocol\": \"tls\",\n                    \"applicationProtocols\": [\n                        \"istio\",\n                        \"istio-peer-exchange\",\n                        \"istio-http/1.0\",\n                        \"istio-http/1.1\",\n                        \"istio-h2\"\n                    ]\n                },\n                \"filters\": [\n                    /省略部分内容/\n                    {\n                        \"name\": \"envoy.filters.network.httpconnectionmanager\",\n                        \"typedConfig\": {\n                            \"@type\": \"type.googleapis.com/envoy.extensions.filters.network.httpconnectionmanager.v3.HttpConnectionManager\",\n                            \"statPrefix\": \"inbound0.0.0.09080\",\n                            \"routeConfig\": {\n                                \"name\": \"inbound|9080||\",\n                                \"virtualHosts\": [\n                                    {\n                                        \"name\": \"inbound|http|9080\",\n                                        \"domains\": [\n                                            \"*\"\n                                        ],\n                                        \"routes\": [\n                                            {\n                                                \"name\": \"default\",\n                                                \"match\": {\n                                                    \"prefix\": \"/\"\n                                                },\n                                                \"route\": {\n                                                    \"cluster\": \"inbound|9080||\",\n                                                    \"timeout\": \"0s\",\n                                                    \"maxStreamDuration\": {\n                                                        \"maxStreamDuration\": \"0s\",\n                                                        \"grpcTimeoutHeaderMax\": \"0s\"\n                                                    }\n                                                },\n                                                \"decorator\": {\n                                                    \"operation\": \"reviews.default.svc.cluster.local:9080/*\"\n                                                }\n                                            }\n                                        ]\n                                    }\n                                ],\n                                \"validateClusters\": false\n                            },\n                            /省略部分内容/\n                        }\n                    }\n                ],\n            /省略部分内容/\n        ],\n        \"listenerFilters\": [\n        /省略部分内容/\n        ],\n        \"listenerFiltersTimeout\": \"0s\",\n        \"continueOnListenerFiltersTimeout\": true,\n        \"trafficDirection\": \"INBOUND\"\n    }\n]\n\n既然 Inbound Handler 的流量中将来自任意地址的对该 Pod 9080 端口的流量路由到 inbound|9080|| Cluster，那么我们运行 istioctl pc cluster reviews-v1-545db77b95-jkgv2 --port 9080 --direction inbound -o json 查看下该 Cluster 配置，你将获得类似下面的输出。\n\n[\n    {\n        \"name\": \"inbound|9080||\",\n        \"type\": \"ORIGINAL_DST\",\n        \"connectTimeout\": \"10s\",\n        \"lbPolicy\": \"CLUSTER_PROVIDED\",\n        \"circuitBreakers\": {\n            \"thresholds\": [\n                {\n                    \"maxConnections\": 4294967295,\n                    \"maxPendingRequests\": 4294967295,\n                    \"maxRequests\": 4294967295,\n                    \"maxRetries\": 4294967295,\n                    \"trackRemaining\": true\n                }\n            ]\n        },\n        \"cleanupInterval\": \"60s\",\n        \"upstreamBindConfig\": {\n            \"sourceAddress\": {\n                \"address\": \"127.0.0.6\",\n                \"portValue\": 0\n            }\n        },\n        \"metadata\": {\n            \"filterMetadata\": {\n                \"istio\": {\n                    \"services\": [\n                        {\n                            \"host\": \"reviews.default.svc.cluster.local\",\n                            \"name\": \"reviews\",\n                            \"namespace\": \"default\"\n                        }\n                    ]\n                }\n            }\n        }\n    }\n]\n\n我们看其中的 TYPE 为 ORIGINALDST，将流量发送到原始目标地址（Pod IP），因为原始目标地址即当前 Pod，你还应该注意到 upstreamBindConfig.sourceAddress.address 的值被改写为了 127.0.0.6，而且对于 Pod 内流量是通过 lo 网卡发送的，这刚好呼应了上文中的 iptables ISTIOOUTPUT 链中的第一条规则，根据该规则，流量将被透传到 Pod 内的应用容器。\n\n 理解 Outbound Handler\n\n在本示例中 reviews 会向 ratings 服务发送 HTTP 请求，请求的地址是：http://ratings.default.svc.cluster.local:9080/，Outbound Handler 的作用是将 iptables 拦截到的本地应用程序向外发出的流量，经由 Envoy 代理路由到上游。\n\nEnvoy 监听在 15001 端口上监听所有 Outbound 流量，Outbound Handler 处理，然后经过 virtualOutbound Listener、0.0.0.0_9080 Listener，然后通过 Route 9080 找到上游的 cluster，进而通过 EDS 找到 Endpoint 执行路由动作。\n\nratings.default.svc.cluster.local:9080 路由\n\n运行 istioctl proxy-config routes reviews-v1-545db77b95-jkgv2 --name 9080 -o json 查看 route 配置，因为 sidecar 会根据 HTTP header 中的 domains 来匹配 VirtualHost，所以下面只列举了 ratings.default.svc.cluster.local:9080 这一个 VirtualHost。\n\n[\n  {\n    \"name\": \"9080\",\n    \"virtualHosts\": [\n       {\n           \"name\": \"ratings.default.svc.cluster.local:9080\",\n           \"domains\": [\n               \"ratings.default.svc.cluster.local\",\n               \"ratings.default.svc.cluster.local:9080\",\n               \"ratings\",\n               \"ratings:9080\",\n               \"ratings.default.svc\",\n               \"ratings.default.svc:9080\",\n               \"ratings.default\",\n               \"ratings.default:9080\",\n               \"10.8.8.106\",\n               \"10.8.8.106:9080\"\n           ],\n           \"routes\": [\n               {\n                   \"name\": \"default\",\n                   \"match\": {\n                       \"prefix\": \"/\"\n                   },\n                   \"route\": {\n                       \"cluster\": \"outbound|9080||ratings.default.svc.cluster.local\",\n                       \"timeout\": \"0s\",\n                       \"retryPolicy\": {\n                           \"retryOn\": \"connect-failure,refused-stream,unavailable,cancelled,retriable-status-codes\",\n                           \"numRetries\": 2,\n                           \"retryHostPredicate\": [\n                               {\n                                   \"name\": \"envoy.retryhostpredicates.previous_hosts\"\n                               }\n                           ],\n                           \"hostSelectionRetryMaxAttempts\": \"5\",\n                           \"retriableStatusCodes\": [\n                               503\n                           ]\n                       },\n                       \"maxStreamDuration\": {\n                           \"maxStreamDuration\": \"0s\",\n                           \"grpcTimeoutHeaderMax\": \"0s\"\n                       }\n                   },\n                   \"decorator\": {\n                       \"operation\": \"ratings.default.svc.cluster.local:9080/*\"\n                   }\n               }\n           ],\n           \"includeRequestAttemptCount\": true\n       },\n       /省略部分内容/\n     ],\n     \"validateClusters\": false\n    }\n]\n\n从该 Virtual Host 配置中可以看到将流量路由到outbound|9080||ratings.default.svc.cluster.local 集群。\n\noutbound|9080||ratings.default.svc.cluster.local 集群的端点\n\n运行 istioctl proxy-config endpoint reviews-v1-545db77b95-jkgv2 --port 9080 -o json --cluster \"outbound|9080||ratings.default.svc.cluster.local\" 查看集群的 Endpoint 配置，结果如下。\n\n[\n    {\n        \"name\": \"outbound|9080||ratings.default.svc.cluster.local\",\n        \"addedViaApi\": true,\n        \"hostStatuses\": [\n            {\n                \"address\": {\n                    \"socketAddress\": {\n                        \"address\": \"10.4.1.12\",\n                        \"portValue\": 9080\n                    }\n                },\n                \"stats\": [\n                    {\n                        \"name\": \"cxconnectfail\"\n                    },\n                    {\n                        \"name\": \"cx_total\"\n                    },\n                    {\n                        \"name\": \"rq_error\"\n                    },\n                    {\n                        \"name\": \"rq_success\"\n                    },\n                    {\n                        \"name\": \"rq_timeout\"\n                    },\n                    {\n                        \"name\": \"rq_total\"\n                    },\n                    {\n                        \"type\": \"GAUGE\",\n                        \"name\": \"cx_active\"\n                    },\n                    {\n                        \"type\": \"GAUGE\",\n                        \"name\": \"rq_active\"\n                    }\n                ],\n                \"healthStatus\": {\n                    \"edsHealthStatus\": \"HEALTHY\"\n                },\n                \"weight\": 1,\n                \"locality\": {\n                    \"region\": \"us-west2\",\n                    \"zone\": \"us-west2-a\"\n                }\n            }\n        ],\n        \"circuitBreakers\": {\n            \"thresholds\": [\n                {\n                    \"maxConnections\": 4294967295,\n                    \"maxPendingRequests\": 4294967295,\n                    \"maxRequests\": 4294967295,\n                    \"maxRetries\": 4294967295\n                },\n                {\n                    \"priority\": \"HIGH\",\n                    \"maxConnections\": 1024,\n                    \"maxPendingRequests\": 1024,\n                    \"maxRequests\": 1024,\n                    \"maxRetries\": 3\n                }\n            ]\n        },\n        \"observabilityName\": \"outbound|9080||ratings.default.svc.cluster.local\"\n    }\n]\n\n我们看到端点的地址是 10.4.1.12。实际上，Endpoint 可以是一个或多个，sidecar 将根据一定规则选择适当的 Endpoint 来路由。至此 review Pod找到了它上游服务 rating 的 Endpoint。\n\n小结\n\n本文使用了 Istio 官方提供的 bookinfo 示例，按图索骥得带领读者了解了 sidecar 注入、iptables 透明流量劫持及 sidecar 中流量路由背后的实现细节。Sidecar 模式和流量透明劫持是 Istio 服务网格的特色和基础功能，理解该功能的背后过程及实现细节，将有助于大家理解 Service Mesh 的原理和 Istio Handbook 后面章节中的内容，因此希望读者可以在自己的环境中从头来试验一遍以加深理解。\n\n使用 iptables 做流量劫持只是 service mesh 的数据平面中做流量劫持的方式之一，还有更多的流量劫持方案，下面引用自 云原生网络代理 MOSN 官网中给出的流量劫持部分的描述。\n\n 使用 iptables 做流量劫持时存在的问题\n\n目前 Istio 使用 iptables 实现透明劫持，主要存在以下三个问题：\n\n需要借助于 conntrack 模块实现连接跟踪，在连接数较多的情况下，会造成较大的消耗，同时可能会造成 track 表满的情况，为了避免这个问题，业内有关闭 conntrack 的做法。\niptables 属于常用模块，全局生效，不能显式的禁止相关联的修改，可管控性比较差。\niptables 重定向流量本质上是通过 loopback 交换数据，outbond 流量将两次穿越协议栈，在大并发场景下会损失转发性能。\n\n上述几个问题并非在所有场景中都存在，比方说某些场景下，连接数并不多，且 NAT 表未被使用到的情况下，iptables 是一个满足要求的简单方案。为了适配更加广泛的场景，透明劫持需要解决上述三个问题。\n\n透明劫持方案优化\n\n为了优化 Istio 中的透明流量劫持的性能，业界提出了以下方案。\n\n使用 Merbridge 开源项目利用 eBPF 劫持流量\n\nMerbridge 是由 DaoCloud 在 2022 年初开源的的一款利用 eBPF 加速 Istio 服务网格的插件。使用 Merbridge 可以在一定程度上优化数据平面的网络性能。\n\nMerbridge 利用 eBPF 的 sockops 和 redir 能力，可以直接将数据包从 inbound socket 传输到 outbound socket。eBPF 提供了 bpfmsgredirect_hash 函数可以直接转发应用程序的数据包。\n\n详见 Istio 服务网格 —— 云原生应用网络构建指南。\n\n使用 tproxy 处理 inbound 流量\n\ntproxy 可以用于 inbound 流量的重定向，且无需改变报文中的目的 IP/端口，不需要执行连接跟踪，不会出现 conntrack 模块创建大量连接的问题。受限于内核版本，tproxy 应用于 outbound 存在一定缺陷。目前 Istio 支持通过 tproxy 处理 inbound 流量。\n\n使用 hook connect 处理 outbound 流量\n\n为了适配更多应用场景，outbound 方向通过 hook connect 来实现，实现原理如下：\n\n{{figure src=\"hook-connect.svg\" alt=\"hook-connect 原理示意图\" title=\"hook-connect 原理示意图\" width=\"50%\"}}\n\n无论采用哪种透明劫持方案，均需要解决获取真实目的 IP/端口的问题，使用 iptables 方案通过 getsockopt 方式获取，tproxy 可以直接读取目的地址，通过修改调用接口，hook connect 方案读取方式类似于 tproxy。\n\n实现透明劫持后，在内核版本满足要求（4.16以上）的前提下，通过 sockmap 可以缩短报文穿越路径，进而改善 outbound 方向的转发性能。\n\n 更新说明\n\n下面是本文的几次更新说明。\n\n2020 年 4 月 27 日，第一版，基于 Istio 1.5\n\n本文的第一版，基于 Istio 1.5 创作，在此之前，我曾写过基于 Istio 1.1 版本的理解 Istio Service Mesh 中 Envoy 代理 Sidecar 注入及流量劫持，为了更细致的理解 Istio 中透明流量劫持的全过程，专门创作本文。\n\n2022 年  1 月 17 日，第二版，基于 Istio 1.11\n\n本文第一版发布后，在社区里获得了比较大的反响，收到了很多读者的评论和留言。基于这些评论，我也发现了第一版中的很多错误，在加上 Istio 版本发布频繁，在近两年的时间内，Istio 已经作出了众多更新，其中不乏重大更新。因此笔者撰写了本文的第二版，修改了之前版本中的纰漏并根据时下 Istio 的最新版本更新了本文。\n\nIstio 1.11 与 Istio 1.1 中的 sidecar 注入和流量劫持环节最大的变化是：\n\niptables 改用命令行工具，不再使用 shell 脚本。\nsidecar inbound 和 outbound 分别指定了端口，而之前是使用同一个端口（15001）。\n\n2022 年 4 月 24，第三版，基于 Istio  1.13\n\n这个版本的文章主要是根据当时 Istio 的最新版本更新了文章的部分内容，并重新排版，增加更新说明。\n\nIstio 1.13 相比 Istio 1.11 的变化是 istioctl proxy-config 命令的输出有了较大变化。\n\n2022 年 5 月 6 日，第四版，基于 Istio 1.13\n\n修改了对 ISTIO_ROUTE iptables 规则 2、5 的解释\n在示意图中增加了路径 16\n\n2022 年 5 月 12 日，第五版，基于 Istio 1.13\n\n将 iptables 说明和 sidecar 注入、init 容器部分独立成了两篇单独的博客，以缩减博客的篇幅，见 Istio 数据平面 Pod 启动过程详解和理解 iptables。\n\n参考\n阅读原文\nDebugging Envoy and Istiod - istio.io\n揭开 Istio Sidecar 注入模型的神秘面纱 - istio.io\nMOSN 作为 Sidecar 使用时的流量劫持方案 - mosn.io\n",
        "tags": []
    },
    {
        "uri": "/zh/blog/istio/深入Istio系列-Sidecar自动注入",
        "content": "---\ntitle: 深入Istio系列-Sidecar自动注入\nslug: dd0bd7\ndate: 2022-09-11T10:29:36+08:00\ndraft: false\nauthor: kbsonlong\nauthorEmail: kbsonlong@gmail.com\ntags: [\"istio\",\"Sidecar\"]\ncategories: [\"云原生\",\"Istio\"]\n\n---\n\nSidecar 自动注入机制是将 sidecar 代理自动添加到用户创建的 pod。\n\n它使用 MutatingWebhook 机制在 pod 创建的时候将 sidecar 的容器和卷添加到每个 pod 的模版里。\n\n用户可以通过 webhooks namespaceSelector 机制来限定需要启动自动注入的范围，也可以通过注解的方式针对每个 pod 来单独启用和禁用自动注入功能。\n\nSidecar 是否会被自动注入取决于下面 3 条配置和 2 条安全规则：\n!--more--\n配置:\n\nwebhooks namespaceSelector\n默认策略 policy\npod 级别的覆盖注解\n\n 安全规则:\n\nsidecar 默认不能被注入到 kube-system 和 kube-public 这两个 namespace\nsidecar 不能被注入到使用 host network 网络的 pod 里\n\n下面的表格展示了基于上述三个配置条件的最终注入状态。上述的安全规则不会被覆盖。\n\n| namespaceSelector 匹配 | 默认策略 | sidecar.istio.io/inject 注解 | Sidecar 是否注入 |\n| -- | -- | -- | -- |\n| 是 | enabled | true (default)\t | 是 |\n| 是 | enabled | false\t | 否 |\n| 是 | disabled | true \t | 是 |\n| 是 | disabled | false (default)\t | 否 |\n| 否 | enabled | true (default)\t | 否 |\n| 否 | enabled | false\t | 否 |\n| 否 | disabled | true\t | 否 |\n| 否 | disabled | false (default)\t | 否 |\n\n以下内容基于Istio 1.13.2版本\n\nNewWehook方法\npkg/kube/inject/webhook.go\nfunc NewWebhook(p WebhookParameters) (*Webhook, error) {\n\tif p.Mux == nil {\n\t\treturn nil, errors.New(\"expected mux to be passed, but was not passed\")\n\t}\n\n\twh := &Webhook{\n\t\twatcher:    p.Watcher,\n\t\tmeshConfig: p.Env.Mesh(),\n\t\tenv:        p.Env,\n\t\trevision:   p.Revision,\n\t}\n\n\tp.Watcher.SetHandler(wh.updateConfig)\n\tsidecarConfig, valuesConfig, err := p.Watcher.Get()\n\tif err != nil {\n\t\treturn nil, err\n\t}\n\twh.updateConfig(sidecarConfig, valuesConfig)\n    //初始化Webhook实例的时候注册/inject对应的处理器\n\tp.Mux.HandleFunc(\"/inject\", wh.serveInject)\n\tp.Mux.HandleFunc(\"/inject/\", wh.serveInject)\n\n\tp.Env.Watcher.AddMeshHandler(func() {\n\t\twh.mu.Lock()\n\t\twh.meshConfig = p.Env.Mesh()\n\t\twh.mu.Unlock()\n\t})\n\n\treturn wh, nil\n}\n\n serveInject方法 \npkg/kube/inject/webhook.go  大概825-895行\n\nfunc (wh *Webhook) serveInject(w http.ResponseWriter, r *http.Request) {\n\ttotalInjections.Increment()\n\tvar body []byte\n    // 获取请求体\n\tif r.Body != nil {\n\t\tif data, err := kube.HTTPConfigReader(r); err == nil {\n\t\t\tbody = data\n\t\t} else {\n\t\t\thttp.Error(w, err.Error(), http.StatusBadRequest)\n\t\t\treturn\n\t\t}\n\t}\n\tif len(body) == 0 {\n\t\thandleError(\"no body found\")\n\t\thttp.Error(w, \"no body found\", http.StatusBadRequest)\n\t\treturn\n\t}\n\n\t// verify the content type is accurate\n\tcontentType := r.Header.Get(\"Content-Type\")\n\tif contentType != \"application/json\" {\n\t\thandleError(fmt.Sprintf(\"contentType=%s, expect application/json\", contentType))\n\t\thttp.Error(w, \"invalid Content-Type, want application/json\", http.StatusUnsupportedMediaType)\n\t\treturn\n\t}\n\n\tpath := \"\"\n\tif r.URL != nil {\n\t\tpath = r.URL.Path\n\t}\n\n\tvar reviewResponse *kube.AdmissionResponse\n\tvar obj runtime.Object\n\tvar ar *kube.AdmissionReview\n    // 解码请求体\n\tif out, _, err := deserializer.Decode(body, nil, obj); err != nil {\n\t\thandleError(fmt.Sprintf(\"Could not decode body: %v\", err))\n\t\treviewResponse = toAdmissionResponse(err)\n\t} else {\n\t\tlog.Debugf(\"AdmissionRequest for path=%s\\n\", path)\n\t\tar, err = kube.AdmissionReviewKubeToAdapter(out)\n\t\tif err != nil {\n\t\t\thandleError(fmt.Sprintf(\"Could not decode object: %v\", err))\n\t\t}\n        // 进入inject方法逻辑判断\n\t\treviewResponse = wh.inject(ar, path)\n\t}\n\n\tresponse := kube.AdmissionReview{}\n\tresponse.Response = reviewResponse\n\tvar responseKube runtime.Object\n\tvar apiVersion string\n\tif ar != nil {\n\t\tapiVersion = ar.APIVersion\n\t\tresponse.TypeMeta = ar.TypeMeta\n\t\tif response.Response != nil {\n\t\t\tif ar.Request != nil {\n\t\t\t\tresponse.Response.UID = ar.Request.UID\n\t\t\t}\n\t\t}\n\t}\n\tresponseKube = kube.AdmissionReviewAdapterToKube(&response, apiVersion)\n\tresp, err := json.Marshal(responseKube)\n\tif err != nil {\n\t\tlog.Errorf(\"Could not encode response: %v\", err)\n\t\thttp.Error(w, fmt.Sprintf(\"could not encode response: %v\", err), http.StatusInternalServerError)\n\t}\n\tif _, err := w.Write(resp); err != nil {\n\t\tlog.Errorf(\"Could not write response: %v\", err)\n\t\thttp.Error(w, fmt.Sprintf(\"could not write response: %v\", err), http.StatusInternalServerError)\n\t}\n}\n\ninject方法\npkg/kube/inject/webhook.go   大概在748-823行\n\nfunc (wh *Webhook) inject(ar *kube.AdmissionReview, path string) *kube.AdmissionResponse {\n\treq := ar.Request\n\tvar pod corev1.Pod\n\tif err := json.Unmarshal(req.Object.Raw, &pod); err != nil {\n\t\thandleError(fmt.Sprintf(\"Could not unmarshal raw object: %v %s\", err,\n\t\t\tstring(req.Object.Raw)))\n\t\treturn toAdmissionResponse(err)\n\t}\n\t// Managed fields is sometimes extremely large, leading to excessive CPU time on patch generation\n\t// It does not impact the injection output at all, so we can just remove it.\n\tpod.ManagedFields = nil\n\n\t// Deal with potential empty fields, e.g., when the pod is created by a deployment\n\tpodName := potentialPodName(pod.ObjectMeta)\n\tif pod.ObjectMeta.Namespace == \"\" {\n\t\tpod.ObjectMeta.Namespace = req.Namespace\n\t}\n\tlog.Infof(\"Sidecar injection request for %v/%v\", req.Namespace, podName)\n\tlog.Debugf(\"Object: %v\", string(req.Object.Raw))\n\tlog.Debugf(\"OldObject: %v\", string(req.OldObject.Raw))\n\n\twh.mu.RLock()\n\t// Sicader注入判断逻辑\n\tif !injectRequired(IgnoredNamespaces.UnsortedList(), wh.Config, &pod.Spec, pod.ObjectMeta) {\n\t\tlog.Infof(\"Skipping %s/%s due to policy check\", pod.ObjectMeta.Namespace, podName)\n\t\ttotalSkippedInjections.Increment()\n\t\twh.mu.RUnlock()\n\t\treturn &kube.AdmissionResponse{\n\t\t\tAllowed: true,\n\t\t}\n\t}\n\n\tproxyConfig := mesh.DefaultProxyConfig()\n\tif wh.env.PushContext != nil && wh.env.PushContext.ProxyConfigs != nil {\n\t\tif generatedProxyConfig := wh.env.PushContext.ProxyConfigs.EffectiveProxyConfig(\n\t\t\t&model.NodeMetadata{\n\t\t\t\tNamespace:   pod.Namespace,\n\t\t\t\tLabels:      pod.Labels,\n\t\t\t\tAnnotations: pod.Annotations,\n\t\t\t}, wh.meshConfig); generatedProxyConfig != nil {\n\t\t\tproxyConfig = *generatedProxyConfig\n\t\t}\n\t}\n\tdeploy, typeMeta := kube.GetDeployMetaFromPod(&pod)\n\tparams := InjectionParameters{\n\t\tpod:                 &pod,\n\t\tdeployMeta:          deploy,\n\t\ttypeMeta:            typeMeta,\n\t\ttemplates:           wh.Config.Templates,\n\t\tdefaultTemplate:     wh.Config.DefaultTemplates,\n\t\taliases:             wh.Config.Aliases,\n\t\tmeshConfig:          wh.meshConfig,\n\t\tproxyConfig:         &proxyConfig,\n\t\tvaluesConfig:        wh.valuesConfig,\n\t\trevision:            wh.revision,\n\t\tinjectedAnnotations: wh.Config.InjectedAnnotations,\n\t\tproxyEnvs:           parseInjectEnvs(path),\n\t}\n\twh.mu.RUnlock()\n\n\tpatchBytes, err := injectPod(params)\n\tif err != nil {\n\t\thandleError(fmt.Sprintf(\"Pod injection failed: %v\", err))\n\t\treturn toAdmissionResponse(err)\n\t}\n\n\treviewResponse := kube.AdmissionResponse{\n\t\tAllowed: true,\n\t\tPatch:   patchBytes,\n\t\tPatchType: func() *string {\n\t\t\tpt := \"JSONPatch\"\n\t\t\treturn &pt\n\t\t}(),\n\t}\n\ttotalSuccessfulInjections.Increment()\n\treturn &reviewResponse\n}\n\n injectRequired方法 \npkg/kube/inject/inject.go    大概在180-290行\n\nfunc injectRequired(ignored []string, config *Config, podSpec *corev1.PodSpec, metadata metav1.ObjectMeta) bool { // nolint: lll\n\t// Skip injection when host networking is enabled. The problem is\n\t// that the iptables changes are assumed to be within the pod when,\n\t// in fact, they are changing the routing at the host level. This\n\t// often results in routing failures within a node which can\n\t// affect the network provider within the cluster causing\n\t// additional pod failures.\n\n    // 主机网络模式不注入sicader\n\tif podSpec.HostNetwork {\n\t\treturn false\n\t}\n\n\t// skip special kubernetes system namespaces\n    // kube-system、kube-public、kube-node-lease、local-path-storage四个名称空间不被注入sicader\n\tfor _, namespace := range ignored {\n\t\tif metadata.Namespace == namespace {\n\t\t\treturn false\n\t\t}\n\t}\n\n\tannos := metadata.GetAnnotations()\n\n\tvar useDefault bool\n\tvar inject bool\n    // annotation 是否开启注入 sidecar.istio.io/inject: \"true\"\n\tobjectSelector := annos[annotation.SidecarInject.Name]\n\tif lbl, labelPresent := metadata.GetLabels()[annotation.SidecarInject.Name]; labelPresent {\n\t\t// The label is the new API; if both are present we prefer the label\n\t\tobjectSelector = lbl\n\t}\n\tswitch strings.ToLower(objectSelector) {\n\t// http://yaml.org/type/bool.html\n\tcase \"y\", \"yes\", \"true\", \"on\":\n\t\tinject = true\n\tcase \"\":\n\t\tuseDefault = true\n\t}\n\n\t// If an annotation is not explicitly given, check the LabelSelectors, starting with NeverInject\n    // 判断 configmap istio-sidecar-injector NeverInject 匹配标签选择器\n\tif useDefault {\n\t\tfor _, neverSelector := range config.NeverInjectSelector {\n\t\t\tselector, err := metav1.LabelSelectorAsSelector(&neverSelector)\n\t\t\tif err != nil {\n\t\t\t\tlog.Warnf(\"Invalid selector for NeverInjectSelector: %v (%v)\", neverSelector, err)\n\t\t\t} else if !selector.Empty() && selector.Matches(labels.Set(metadata.Labels)) {\n\t\t\t\tlog.Debugf(\"Explicitly disabling injection for pod %s/%s due to pod labels matching NeverInjectSelector config map entry.\",\n\t\t\t\t\tmetadata.Namespace, potentialPodName(metadata))\n\t\t\t\tinject = false\n\t\t\t\tuseDefault = false\n\t\t\t\tbreak\n\t\t\t}\n\t\t}\n\t}\n\n\t// If there's no annotation nor a NeverInjectSelector, check the AlwaysInject one\n    //  判断 configmap istio-sidecar-injector AlwaysInject 匹配标签选择器\n\tif useDefault {\n\t\tfor _, alwaysSelector := range config.AlwaysInjectSelector {\n\t\t\tselector, err := metav1.LabelSelectorAsSelector(&alwaysSelector)\n\t\t\tif err != nil {\n\t\t\t\tlog.Warnf(\"Invalid selector for AlwaysInjectSelector: %v (%v)\", alwaysSelector, err)\n\t\t\t} else if !selector.Empty() && selector.Matches(labels.Set(metadata.Labels)) {\n\t\t\t\tlog.Debugf(\"Explicitly enabling injection for pod %s/%s due to pod labels matching AlwaysInjectSelector config map entry.\",\n\t\t\t\t\tmetadata.Namespace, potentialPodName(metadata))\n\t\t\t\tinject = true\n\t\t\t\tuseDefault = false\n\t\t\t\tbreak\n\t\t\t}\n\t\t}\n\t}\n\n\tvar required bool\n    //   判断 configmap istio-sidecar-injector  默认策略policy\n\tswitch config.Policy {\n\tdefault: // InjectionPolicyOff\n\t\tlog.Errorf(\"Illegal value for autoInject:%s, must be one of [%s,%s]. Auto injection disabled!\",\n\t\t\tconfig.Policy, InjectionPolicyDisabled, InjectionPolicyEnabled)\n\t\trequired = false\n\tcase InjectionPolicyDisabled:\n\t\tif useDefault {\n\t\t\trequired = false\n\t\t} else {\n\t\t\trequired = inject\n\t\t}\n\tcase InjectionPolicyEnabled:\n\t\tif useDefault {\n\t\t\trequired = true\n\t\t} else {\n\t\t\trequired = inject\n\t\t}\n\t}\n\n\tif log.DebugEnabled() {\n\t\t// Build a log message for the annotations.\n\t\tannotationStr := \"\"\n\t\tfor name := range AnnotationValidation {\n\t\t\tvalue, ok := annos[name]\n\t\t\tif !ok {\n\t\t\t\tvalue = \"(unset)\"\n\t\t\t}\n\t\t\tannotationStr += fmt.Sprintf(\"%s:%s \", name, value)\n\t\t}\n\n\t\tlog.Debugf(\"Sidecar injection policy for %v/%v: namespacePolicy:%v useDefault:%v inject:%v required:%v %s\",\n\t\t\tmetadata.Namespace,\n\t\t\tpotentialPodName(metadata),\n\t\t\tconfig.Policy,\n\t\t\tuseDefault,\n\t\t\tinject,\n\t\t\trequired,\n\t\t\tannotationStr)\n\t}\n\n\treturn required\n}\n\n",
        "tags": []
    },
    {
        "uri": "/zh/blog/istio/深入Istio系列-数据平面Pod启动过程详解",
        "content": "---\ntitle: 深入Istio系列-数据平面Pod启动过程详解\nslug: dc5625\ndate: 2022-09-10T14:33:42+08:00\ndraft: false\nauthor: kbsonlong\nauthorEmail: kbsonlong@gmail.com\ntags: [istio,转载]\ncategories: [云原生]\n\n---\n\n本文将为你讲解：\n\nIstio 中 sidecar 自动注入过程\nIstio 中的 init 容器启动过程\n启用了 Sidecar 自动注入的 Pod 的启动流程\n\n下图中展示了 Istio 数据平面中的 Pod 启动完后的组件。\n\nIstio 中的 sidecar 注入\n\nIstio 中提供了以下两种 sidecar 注入方式：\n\n使用 istioctl 手动注入。\n基于 Kubernetes 的 突变 webhook 准入控制器（mutating webhook addmission controller 的自动 sidecar 注入方式。\n\n不论是手动注入还是自动注入，sidecar 的注入过程都需要遵循如下步骤：\n\nKubernetes 需要了解待注入的 sidecar 所连接的 Istio 集群及其配置；\nKubernetes 需要了解待注入的 sidecar 容器本身的配置，如镜像地址、启动参数等；\nKubernetes 根据 sidecar 注入模板和以上配置填充 sidecar 的配置参数，将以上配置注入到应用容器的一侧；\n\n使用下面的命令可以手动注入 sidecar。\n\nistioctl kube-inject -f ${YAML_FILE} | kuebectl apply -f -\n\n该命令会使用 Istio 内置的 sidecar 配置来注入，下面使用 Istio详细配置请参考 Istio 官网。\n\n注入完成后您将看到 Istio 为原有 pod template 注入了 initContainer 及 sidecar proxy相关的配置。\n\n Init 容器\n\nInit 容器是一种专用容器，它在应用程序容器启动之前运行，用来包含一些应用镜像中不存在的实用工具或安装脚本。\n\n一个 Pod 中可以指定多个 Init 容器，如果指定了多个，那么 Init 容器将会按顺序依次运行。只有当前面的 Init 容器必须运行成功后，才可以运行下一个 Init 容器。当所有的 Init 容器运行完成后，Kubernetes 才初始化 Pod 和运行应用容器。\n\nInit 容器使用 Linux Namespace，所以相对应用程序容器来说具有不同的文件系统视图。因此，它们能够具有访问 Secret 的权限，而应用程序容器则不能。\n\n在 Pod 启动过程中，Init 容器会按顺序在网络和数据卷初始化之后启动。每个容器必须在下一个容器启动之前成功退出。如果由于运行时或失败退出，将导致容器启动失败，它会根据 Pod 的 restartPolicy 指定的策略进行重试。然而，如果 Pod 的 restartPolicy 设置为 Always，Init 容器失败时会使用 RestartPolicy 策略。\n\n在所有的 Init 容器没有成功之前，Pod 将不会变成 Ready 状态。Init 容器的端口将不会在 Service中进行聚集。 正在初始化中的 Pod 处于 Pending 状态，但应该会将 Initializing 状态设置为 true。Init 容器运行完成以后就会自动终止。\n\n关于 Init 容器的详细信息请参考 Init 容器 - Kubernetes 中文指南/云原生应用架构实践手册。\n\nInit 容器解析\n\nIstio 在 pod 中注入的 Init 容器名为 istio-init，我们在上面 Istio 注入完成后的 YAML 文件中看到了该容器的启动命令是：\n\nistio-iptables -p 15001 -z 15006 -u 1337 -m REDIRECT -i '' -x \"\" -b '' -d 15090,15020\n\n我们再检查下该容器的 Dockerfile 看看 ENTRYPOINT 是怎么确定启动时执行的命令。\n\n 前面的内容省略\nThe pilot-agent will bootstrap Envoy.\nENTRYPOINT [\"/usr/local/bin/pilot-agent\"]\n\n我们看到 istio-init 容器的入口是 /usr/local/bin/istio-iptables 命令行，该命令行工具的代码的位置在 Istio 源码仓库的 tools/istio-iptables 目录。\n\n注意：在 Istio 1.1 版本时还是使用 isito-iptables.sh 命令行来操作 IPtables。\n\n Init 容器启动入口\n\nInit 容器的启动入口是 istio-iptables 命令行，该命令行工具的用法如下：\n\n$ istio-iptables [flags]\n  -p: 指定重定向所有 TCP 流量的 sidecar 端口（默认为 $ENVOY_PORT = 15001）\n  -m: 指定入站连接重定向到 sidecar 的模式，“REDIRECT” 或 “TPROXY”（默认为 $ISTIOINBOUNDINTERCEPTION_MODE)\n  -b: 逗号分隔的入站端口列表，其流量将重定向到 Envoy（可选）。使用通配符 “*” 表示重定向所有端口。为空时表示禁用所有入站重定向（默认为 $ISTIOINBOUNDPORTS）\n  -d: 指定要从重定向到 sidecar 中排除的入站端口列表（可选），以逗号格式分隔。使用通配符“*” 表示重定向所有入站流量（默认为 $ISTIOLOCALEXCLUDE_PORTS）\n  -o：逗号分隔的出站端口列表，不包括重定向到 Envoy 的端口。\n  -i: 指定重定向到 sidecar 的 IP 地址范围（可选），以逗号分隔的 CIDR 格式列表。使用通配符 “*” 表示重定向所有出站流量。空列表将禁用所有出站重定向（默认为 $ISTIOSERVICECIDR）\n  -x: 指定将从重定向中排除的 IP 地址范围，以逗号分隔的 CIDR 格式列表。使用通配符 “*” 表示重定向所有出站流量（默认为 $ISTIOSERVICEEXCLUDE_CIDR）。\n  -k：逗号分隔的虚拟接口列表，其入站流量（来自虚拟机的）将被视为出站流量。\n  -g：指定不应用重定向的用户的 GID。(默认值与 -u param 相同)\n  -u：指定不应用重定向的用户的 UID。通常情况下，这是代理容器的 UID（默认值是 1337，即 istio-proxy 的 UID）。\n  -z: 所有进入 pod/VM 的 TCP 流量应被重定向到的端口（默认 $INBOUNDCAPTUREPORT = 15006）。\n\n以上传入的参数都会重新组装成 iptables 规则，关于该命令的详细用法请访问 tools/istio-iptables/pkg/cmd/root.go。\n\n该容器存在的意义就是让 sidecar 代理可以拦截所有的进出 pod 的流量，15090 端口（Mixer 使用）和 15092 端口（Ingress Gateway）除外的所有入站（inbound）流量重定向到 15006 端口（sidecar），再拦截应用容器的出站（outbound）流量经过 sidecar 处理（通过 15001 端口监听）后再出站。关于 Istio 中端口用途请参考 Istio 官方文档。\n\n命令解析\n\n这条启动命令的作用是：\n\n将应用容器的所有流量都转发到 sidecar 的 15006 端口。\n使用 istio-proxy 用户身份运行， UID 为 1337，即 sidecar 所处的用户空间，这也是 istio-proxy 容器默认使用的用户，见 YAML 配置中的 runAsUser 字段。\n使用默认的 REDIRECT 模式来重定向流量。\n将所有出站流量都重定向到 sidecar 代理（通过 15001 端口）。\n\n因为 Init 容器初始化完毕后就会自动终止，因为我们无法登陆到容器中查看 iptables 信息，但是 Init 容器初始化结果会保留到应用容器和 sidecar 容器中。\n\nPod 启动流程\n\n启用了 Sidecar 自动注入的 Pod 启动流程如下：\n\nInit 容器先启动，向 Pod 中注入 iptables 规则，进行透明流量拦截。\n随后，Kubernetes 会根据 Pod Spec 中容器的声明顺序依次启动容器，但这是非阻塞的，无法保证第一个容器启动完成后才启动下一个。istio-proxy 容器启动时，pilot-agent 将作为 PID 1 号进程，它是 Linux 用户空间的第一个进程，负责拉起其他进程和处理僵尸进程。pilot-agent 将生成 Envoy bootstrap 配置并拉起 envoy 进程；应用容器几乎跟 istio-proxy 容器同时启动，为了防止 Pod 内的容器在还没启动好的情况而接收到外界流量，这时候就绪探针就派上用场了。Kubernetes 会在 istio-proxy 容器的 15021 端口进行就绪检查，直到 isito-proxy 启动完成后 kubelet 才会将流量路由到 Pod 内。\n在 Pod 启动完成后，pilot-agent  将变为守护进程监视系统其他进程，除此之外，该进程还为 Envoy 提供 Bootstrap 配置、证书、健康检查、配置热加载、身份支持及进程生命周期管理等。\n\n Pod 内容器启动顺序问题\n\n在 Pod 启动的过程中存在容器启动顺序问题，假设下面这种情况，应用容器先启动，请求其他服务，这时候 istio-proxy 容器还没启动完成，那么该请求将会失败，如果你的应用的健壮性不足，甚至可能导致应用容器崩溃，进而 Pod 重启。对于这种情况的解决方案是：\n\n修改应用程序，增加超时重试。\n增加应用容器中进程的启动延迟，比如增加 sleep 时间。\n在应用容器中增加一个 postStart 配置，检测应用进程是否启动完成，只有当检测成功时，Kubernetes 才会将 Pod 的状态标记为 Running。\n\n总结\n\n这篇文章带领大家了解了 Istio 数据平面中的 Pod 启动过程，还有因为 Pod 内容器启动顺序带来的问题。\n\n 参考\n\n阅读原文\n\nistio 常见问题: Sidecar 启动顺序问题 - imroc.cc\n",
        "tags": []
    },
    {
        "uri": "/zh/blog/istio/深入Istio系列-组件详解",
        "content": "---\ntitle: 深入Istio系列-组件详解\nslug: 6be15f\ndate: 2022-09-12T08:19:28+08:00\ndraft: false\nauthor: kbsonlong\nauthorEmail: kbsonlong@gmail.com\ntags: [istio,sicader,转载]\ncategories: [云原生]\n\n---\n\n在前两篇博客中：\n\nIstio 中的 Sidecar 注入、透明流量劫持及流量路由过程详解\nSidecar 中的流量类型及 iptables 规则详解\n\n我向你详细介绍了 Istio 数据平面中的流量，但数据平面并不能孤立的存在，本文将向你展示 Istio 中的控制平面和数据平面各组件的端口及其功能，有助于你了解这些流量之间的关系及故障排查。\n\nIstio 中的组件及端口示意图\n\n按照习惯，我们首先展示一个全局示意图。下图展示的是 Istio 数据平面中 sidecar 的组成，以及与其交互的对象。\n\n我们可以使用 nsenter 命令进入Bookinfo 示例的 productpage  Pod的网络空间，查看其内部监听的端口信息。\n\n从图中我们可以看到除了 productpage 应用本身监听的 9080 端口以外，Sidecar 容器还有监听大量的其他端口，如 15000、15001、15004、15006、15021、15090 等，你可以在 Istio 文档上了解 Istio 中使用的端口。\n\n我们再进入 productpage Pod 中，使用 lsof -i 命令查看它打开的端口，如下图所示。\n\n!\n\n我们可以看到其中有 pilot-agent 与 istiod 建立了 TCP 连接，上文中所述的监听中的端口，还有在 Pod 内部建立的 TCP 连接，这些连接对应了文章开头的示意图。\n\nSidecar 容器（istio-proxy ）的根进程是 pilot-agent，启动命令如下图所示：\n\n从图中我们可以看到，它 pilot-agent 进程的 PID 是 1，是它拉起了 envoy 进程。\n\n在 istiod 的 Pod 中查看它打开的端口，如下图所示。\n\n我们可以看到其中的监听的端口、进程间和远程通信连接。\n\n Istio 中各端口的功能概述\n\n这些端口在你进行问题排查时可以起着举足轻重的作用。下面将根据端口所在的组件和功能分类描述。\n\nIstiod 中的端口\n\nIstiod 中的端口相对比较少且功能单一：\n\n9876：ControlZ 用户界面，暴露 istiod 的进程信息\n8080：istiod 调试端口，通过该端口可以查询网格的配置和状态信息\n15010：暴露 xDS API 和颁发纯文本证书\n15012：功能同 15010 端口，但使用 TLS 通信\n15014：暴露控制平面的指标给 Prometheus\n15017：Sidecar 注入和配置校验端口\n\n Sidecar 中的端口\n\n从上文中，我们看到 sidecar 中有众多端口：\n\n15000：Envoy 管理接口，你可以用它来查询和修改 Envoy 代理的的配置，详情请参考 Envoy 文档。\n15001：用于处理出站流量。\n15004：调试端口，将在下文中解释。\n15006：用于处理入站流量。\n15020：汇总统计数据，对 Envoy 和 DNS 代理进行健康检查，调试 pilot-agent  进程，将在下文中详细解释。\n15021：用于 sidecar 健康检查，以判断已注入 Pod 是否准备好接收流量。我们在该端口的 /healthz/ready 路径上设置了就绪探针，Istio 把 sidecar 的就绪检测交给了 kubelet，最大化利用 Kubernetes 平台自身的功能。envoy  进程将健康检查路由到 pilot-agent 进程的 15020 端口，实际的健康检查将发生在那里。\n15053：本地 DNS 代理，用于解析 Kubernetes DNS 解析不了的集群内部域名的场景。\n15090：Envoy Prometheus 查询端口，pilot-agent 将通过此端口收集统计信息。\n\n以上端口可以分为以下几类：\n\n负责进程间通信，例如 15001、15006、15053\n负责健康检查和信息统计，例如 150021、15090\n调试：15000、15004\n\n下文将对几个重点端口详解。\n\n15000 端口\n\n15000 是 Envoy 的 Admin 接口，该接口允许我们修改 Envoy，并获得一个视图和查询指标和配置。\n\n管理接口由一个具有多个端点的 REST API 和一个简单的用户界面组成，你可以使用下面的命令开启 productpage Pod 中的 Envoy 管理接口视图。\n\nkubectl -n default port-forward deploy/productpage-v1 15000\n\n在浏览器中访问 http://localhost:15000，你将看到 Envoy Admin 界面如下图所示。\n\n 15004 端口\n\n通过 pilot-agent 代理 istiod 8080 端口上的调试端点，你可以进入数据平面 Pod 中访问 localhost 的 15004 端口查询网格信息，其效果与下面的 8080 端口等同。\n\n8080 端口\n\n你还可以在本地转发 istiod  8080 端口，请运行下面的命令。\n\nkubectl -n istio-system port-forward deploy/istiod 8080\n\n在浏览器中访问 http://localhost:8080/debug，你将看到调试端点，如下图所示。\n\n当然，这只是一种获取网格信息和调试网格的方式，你还可以使用 istioctl 命令或 Kiali 来调试，那样将更加高效和直观。\n\n 15020 端口\n\n15020 端口有三大功能：\n\n汇总统计数据：查询 15090 端口获取 envoy 的指标，也可以配置查询应用程序的指标，将 envoy、应用程序和自身的指标汇总以供 Prometheus 收集。对应的调试端点是 /stats/prometheus。\n对 Envoy 和 DNS 代理进行健康检查：对应的调试端点是 /healthz/ready 和 /app-health。\n调试 pilot-agent  进程：对应的调试端点是 /quitquitquit、debug/ndsz 和 /debug/pprof。\n\n下图展示的是使用本地端口转发后，在浏览器中打开 http://localhost:15020/debug/pprof 看到的调试信息。\n\n图中信息展示的是 pilot-agent 的堆栈信息。\n\n总结\n\n通过对 Istio 中各组件端口的了解，你应该对 Istio 中各组件的关系及其内部流量有了更进一步的认识，熟悉这些端口的功能，有助于对网格的故障排除。\n",
        "tags": []
    },
    {
        "uri": "/zh/blog/istio/理解Iptable",
        "content": "---\ntitle: 理解Iptable\nslug: b7e1eb\ndate: 2022-09-10T14:30:05+08:00\ndraft: false\nauthor: kbsonlong\nauthorEmail: kbsonlong@gmail.com\ntags: [istio,iptable,转载]\ncategories: [云原生]\n\n---\n\niptables 作为 Linux 内核中的重要功能，有着广泛的应用，在 Istio 中默认就是利用 iptables 做透明流量劫持的。理解 iptables，对于我们理解 Istio 的运作有十分重要的作用。本文将为大家简单介绍下 iptbles。\n\niptables 简介\n\niptables 是 Linux 内核中的防火墙软件 netfilter 的管理工具，位于用户空间，同时也是 netfilter 的一部分。Netfilter 位于内核空间，不仅有网络地址转换的功能，也具备数据包内容修改、以及数据包过滤等防火墙功能。\n\n在了解 Init 容器初始化的 iptables 之前，我们先来了解下 iptables 和规则配置。\n\n下图展示了 iptables 调用链。\n\n iptables 中的表\n\nInit 容器中使用的的 iptables 版本是 v1.6.0，共包含 5 张表：\n\nraw 用于配置数据包，raw 中的数据包不会被系统跟踪。\nfilter 是用于存放所有与防火墙相关操作的默认表。\nnat 用于 网络地址转换（例如：端口转发）。\nmangle 用于对特定数据包的修改（参考损坏数据包）。\nsecurity 用于强制访问控制 网络规则。\n\n*注*：在本示例中只用到了 nat 表。\n\n不同的表中的具有的链类型如下表所示：\n\n| 规则名称    | raw  | filter | nat  | mangle | security |\n| ----------- | ---- | ------ | ---- | ------ | -------- |\n| PREROUTING  | ✓    |        | ✓    | ✓      |          |\n| INPUT       |      | ✓      |      | ✓      | ✓        |\n| OUTPUT      | ✓    | ✓      | ✓    | ✓      | ✓        |\n| POSTROUTING |      |        | ✓    | ✓      |          |\n| FORWARD     |      | ✓      |      | ✓      | ✓        |\n\n理解 iptables 规则\n\n查看 istio-proxy 容器中的默认的 iptables 规则，默认查看的是 filter 表中的规则。\n\n$ iptables -L -v\nChain INPUT (policy ACCEPT 350K packets, 63M bytes)\n pkts bytes target     prot opt in     out     source               destination\n\nChain FORWARD (policy ACCEPT 0 packets, 0 bytes)\n pkts bytes target     prot opt in     out     source               destination\n\nChain OUTPUT (policy ACCEPT 18M packets, 1916M bytes)\n pkts bytes target     prot opt in     out     source               destination\n\n我们看到三个默认的链，分别是 INPUT、FORWARD 和 OUTPUT，每个链中的第一行输出表示链名称（在本例中为INPUT/FORWARD/OUTPUT），后跟默认策略（ACCEPT）。\n\n每条链中都可以添加多条规则，规则是按照顺序从前到后执行的。我们来看下规则的表头定义。\n\npkts：处理过的匹配的报文数量\nbytes：累计处理的报文大小（字节数）\ntarget：如果报文与规则匹配，指定目标就会被执行。\nprot：协议，例如 tdp、udp、icmp 和 all。\nopt：很少使用，这一列用于显示 IP 选项。\nin：入站网卡。\nout：出站网卡。\nsource：流量的源 IP 地址或子网，或者是 anywhere。\ndestination：流量的目的地 IP 地址或子网，或者是 anywhere。\n\n还有一列没有表头，显示在最后，表示规则的选项，作为规则的扩展匹配条件，用来补充前面的几列中的配置。prot、opt、in、out、source 和 destination 和显示在 destination 后面的没有表头的一列扩展条件共同组成匹配规则。当流量匹配这些规则后就会执行 target。\n\ntarget 支持的类型\n\ntarget 类型包括 ACCEPT、REJECT、DROP、LOG 、SNAT、MASQUERADE、DNAT、REDIRECT、RETURN 或者跳转到其他规则等。只要执行到某一条链中只有按照顺序有一条规则匹配后就可以确定报文的去向了，除了 RETURN 类型，类似编程语言中的 return 语句，返回到它的调用点，继续执行下一条规则。target 支持的配置详解请参考 iptables 详解（1）：iptables 概念。\n\n 总结\n\n以上就是对 iptables 的简要介绍，你已经了解了 iptables 是怎样运行的，规则链及其执行顺序。\n\n参考\n\n阅读原文",
        "tags": []
    },
    {
        "uri": "/zh/docs/_index",
        "content": "---\ntitle: \"文档\"\ntype: docs\ndescription: \n    使用指南.\n---",
        "tags": []
    },
    {
        "uri": "/zh/docs/hugo/01-hugo使用手册",
        "content": "---\ntitle: \"01 Hugo使用手册\"\ndate: 2022-07-29T10:54:52+08:00\ndraft: false\ntags: [hugo]\ncategories: [hugo]\n---\n\n前言\n\n两年前用Hexo搭建博客，但是因为各种配置问题没有继续跟进，之后就一直在简书写的博客。恰逢看到新的博客生成工具Hugo，所以重新搭建了一个个人博客网站，通过Github Pages，域名重定向来实现线上访问。本文介绍的就是如何使用Hugo搭建个人博客网站的过程。实际效果可以访问我的博客。\n\n Hugo简介\n\n不同与Hexo是用JavaScript实现的，Hugo是由Go语言实现的静态网站生成器。简单、易用、高效、易扩展、快速部署。从我的个人体验来讲，Hugo比Hexo速度更快，而且不用依赖一大堆东西，一个二进制文件就可以搞定。\n\n The world’s fastest framework for building websites. Hugo is one of the most popular open-source static site generators. With its amazing speed and flexibility, Hugo makes building websites fun again.\n\n这是Hugo的主页对自己的介绍，看这嚣张的简介，“全球最快的网站建设框架”，就不禁想让人来体验一把。\n\n那么就开始吧！\n\nHugo快速开始\n\nHugo的首页有一个显眼的按钮【Quick Start】，点击它，按步骤完成即可\n\n Hugo安装\n\nMac\n\nbrew install hugo\nhugo version\n\n Windows\n\n去Hugo releases页面下载hugoxxxWindows-64bit.zip 将它解压到一个安全的目录，然后把这个目录添加到环境变量PATH中，重启终端，运行hugo version，正确展示了版本号就说明安装成功。\n\n快速搭建博客\n\n可以进入Hugo首页，点击Quick Start快速开始，从Step 2开始抄代码，直到Step 7结束。（Step 1是安装Hugo，我们在上文已经介绍了。）\n\n也可以根据接下来的步骤依次执行：\n\n创建一个新的项目（quickstart 是项目名称，可以改成你想要的名字）\n    \n        hugo new site quickstart\n        \n添加一个主题（这里会安装一个默认主题ananke）\n    \n        cd quickstart\n    git init\n    git submodule add https://github.com/budparr/gohugo-theme-ananke.git themes/ananke\n    \n    echo 'theme = \"ananke\"'  config.toml\n        \n创建一个新的博客\n    \n        hugo new posts/my-first-post.md\n        \n    注意：博客文件开头的 draft: false要改成true，否则改博客不会被生成到public目录中。\n开启 Hugo Serve，用于本地预览\n    \n        hugo server -D\n        \n定制主题，如果对步骤2安装的默认主题不满意，可以自己选择一个主题进行替换\n    \n    重复步骤2，把你想要替换的主题GitHub路径替换一下就好，然后在配置文件config.toml里修改下面的配置\n    \n        baseURL = \"https://example.org/\"\n    languageCode = \"en-us\"\n    title = \"My New Hugo Site\"\n    theme = \"ananke\"\n        \n    baseURL 改成你的博客主页地址\n    languageCode 如果是中文博客，可以改成zh-CN\n    title 即博客名称\n    theme 这里是重点，把theme的值改成你替换的主题的名称，然后主题就生效啦。\n构建静态页面\n    \n        hugo -D\n        \n    这个命令执行以后会生成一个./public的目录，将这个目录上传到GitHub，创建一个名为dreamqyq.github.io的项目（dreamqyq 这里替换成你的GitHub账号名），然后使用GitHub Pages就可以让别人来看你的博客啦。\n\n Hugo常用命令\n\nhugo 构建静态文件\nhugo server -D 本地预览\nhugo new blogName.md 生成一个新的博客\n\n主题\n\n我的个人博客网站的主题使用了maupassant （我fork了原项目并做了一点修改，支持了博客目录显示二级目录）主题，在这个主题的Github主页README中有详细的配置方法，这里就不再赘述。如果喜欢的话可以参考教程进行配置。\n\n 遇到的问题\n\n在配置教程的时候遇到了一个问题，上文中提到的配置bashURL应该是个人博客网站的地址，由于我做了Gihubub Pages域名转发，使用了我自己的域名 https://enochqin.xyz（域名已弃用，目前的博客直接使用的GitHub Pages）。在最开始配置的时候，写成了https://www.enochqin.xyz，导致博客的很多功能各种出错，后来才意识到，我的域名没有做www的映射，导致其实https://www.enochqin.xyz这个网址是不能访问的。\n\n没有www和带www的域名是被看做两个不同的域名的。一般我们都会将两个域名设置指向相同的一个网站。但是实际上带www的和不带www的域名完全可以设置指向两个不同的服务器。这样你访问带www和不带www的地址，看到的是两个不同的网站了。\n\n（完）",
        "tags": []
    },
    {
        "uri": "/zh/docs/hugo/02-hugo github action自动部署",
        "content": "---\ntitle: \"02 Hugo Github Action自动部署静态博客\"\ndate: 2022-07-29T10:55:52+08:00\ndraft: false\ntags: [hugo,GithubAction]\ncategories: [hugo]\n---\n\n一、前言\n\n使用 Hugo 有一些时间了，把内容上传到 GitHub Pages，从一开始的手动操作，到脚本操作，终于来到了自动化部署。\n\n部署的流程：\n\n流程\n\n本地通过 Hugo 命令创建文件，编写博客，编写好后把改变的内容上传到 GitHub 博客源文件仓库。通过 GitHub Action 自动触发脚本构建，然后把静态文件通过 GitHub Deploy 到博客仓库。\n\n 二、具体步骤\n\n2.1 创建两个仓库\n\n创建博客源仓库\n\n  \n\n创建博客静态资源仓库\n\n 2.2 创建 SSH\n\n需要生成一对 SSH Key，生成的 Public Key 和 Private Key 都会用到。\n\nssh-keygen -t rsa -b 4096 -C \"ironcity.hz@gmail.com\" Generating public/private rsa key pair. Enter file in which to save the key (/Users/tc/.ssh/id\\_rsa):\n\n输入你需要指定的文件，比如 /Users/tc/.ssh/idrsahugo_deploy\n\n 只是为了防止覆盖之前创建的默认文件\n\n2.2 配置博客静态资源仓库的 Deploy Keys\n\n添加公钥到 http://funnycode-org.github.io 仓库的 Deploy Keys\n\n添加后\n\n 2.3 配置博客源内容仓库的 Secrets\n\n添加私钥到 blog 仓库的 Secrets\n\n添加后\n\n 注意这个 secrets 的名称\n\n2.4 编写博客\n\n克隆 blog 项目到本地\n\n\\ 选取一个目录 cd ~/Desktop/ # 克隆 source 仓库 git clone git@github.com:funnycode-org/blog.git # 进入仓库 cd blog\n\n创建 hugo 博客\n\n创建博客，多语言模式\nhugo new /posts/[blog-name]/index.zh-cn.md \n\n 运行预览效果\nhugo serve -D\n\n如果没有什么问题就可以准备提交代码了\n\ngit add .\ngit commit -m \"update commit\"\ngit push -u origin master\n\n2.5 GitHub Actions 说明\n\nActions 内容：\n\nname: Deploy Hugo Site to Github Pages on Master Branch\n\non:\n  push:\n    branches:\n      master\n\njobs:\n  build-deploy:\n    runs-on: ubuntu-18.04\n    steps:\n      uses: actions/checkout@v2\n        with:\n          submodules: true   Fetch Hugo themes (true OR recursive)\n          fetch-depth: 0    # Fetch all history for .GitInfo and .Lastmod\n\n      name: Setup Hugo\n        uses: peaceiris/actions-hugo@v2\n        with:\n          hugo-version: '0.76.0'\n          # extended: true\n\n      name: Build\n        run: hugo --minify\n\n      name: Deploy\n        uses: peaceiris/actions-gh-pages@v3\n        with:\n          deploykey: ${{ secrets.ACTIONSDEPLOY_KEY }}\n          external_repository: funnycode-org/funnycode-org.github.io # remote branch\n          publish_dir: \"./docs\"\n          cname: blog.funnycode.org.cn          \n          keep_files: false # remove existing files\n          publish_branch: docs  # deploying branch\n          commitmessage: ${{ github.event.headcommit.message }}\n\n 注意点：  \n\npublish\\_dir 指定发布的目录，./docs 指 blog 项目下的 docs 目录下的内容会被发布\npublish\\_branch 发布到 funnycode-org.github.io 项目的 docs 分支\nsecrets.ACTIONS\\DEPLOY\\KEY 的 ACTIONS\\DEPLOY\\KEY 则是上面设置 Private Key 的变量名\ncname 必须要配置好，和下文提到的 Setting 里面配置图对应\n\n  \n\n2.7 http://funnycode-org.github.io 配置\n\n配置 Setting\n\n验证访问\n\n输入 https://blog.funnycode.org.cn，效果：\n\n",
        "tags": []
    },
    {
        "uri": "/zh/search",
        "content": "---\ntitle: Search results\nlayout: search\n---\n",
        "tags": []
    }
]