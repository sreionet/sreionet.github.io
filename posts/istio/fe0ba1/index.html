<!doctype html><html lang=zh dir=ltr><head prefix="og: http://ogp.me/ns#"><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><title>Istio 中的 Sidecar 注入、透明流量劫持及流量路由过程详解 – 云原生技术圈</title><script defer src=/js/fuse.min.32195737929df2c8096e855a5789cbb3f1331224d9169e8705493e7008f47df8.js></script><script src=/js/enquire.min.dfb99dee1e029d51d6cfb672d847929890b1585402de17f5ed092edd72a688b4.js></script><script defer src=/js/lazysizes.min.fb649fcae62177dfe63e67081ddceb830b5ce1f05a4184e9bbb7d87ac4b8f4e5.js></script><script defer src=/js/helper/getParents.min.ccd45f158c1b17849307ba913a72beac239c410f2b6e648496a79842da84e55b.js></script><script defer src=/js/helper/fadeinout.min.1d13d3e810c3940e80cbba6216a1c76fbf42b5431fc83537ea6997863802362b.js></script><script defer src=/js/helper/closest.min.js></script><script>"use strict",window.NodeList&&!NodeList.prototype.forEach&&(NodeList.prototype.forEach=Array.prototype.forEach),String.prototype.includes||(String.prototype.includes=function(b,a){if('use strict',b instanceof RegExp)throw TypeError('first argument must not be a RegExp');return a===void 0&&(a=0),this.indexOf(b,a)!==-1}),Document.prototype.append=Element.prototype.append=function(){this.appendChild(_mutation(arguments))};function _mutation(a){if(a.length)if(a.length===1)return typeof a[0]=='string'?document.createTextNode(a[0]):a[0];else{for(var c=document.createDocumentFragment(),e=a.length,d=-1,b;++d<e;)b=a[d],c.appendChild(typeof b=='string'?document.createTextNode(b):b);return c}else throw new Error('DOM Exception 8')}String.prototype.startsWith||(String.prototype.startsWith=function(b,a){return a=a||0,this.indexOf(b,a)===a}),document.addEventListener('DOMContentLoaded',function(){var z=document.querySelector('.navbar__burger'),J,F,G,N,U,f,d,V,r,ae,Z,Q,o,g,y,k,b,s,t,P,O,e,C,h,D,B,ai,A,aj,at,ar,ab,aq,E,ap,ao,ah,an,i,j,c,am,S,T,ak,w,W,X,ag,x,n,Y,q,av,au,a,aw,R,m,L,K,I,v,p,u;z?z.addEventListener('click',function(c){var a=document.querySelector('.navbarm__collapse'),b;a&&(b=a.getAttribute('data-open'),b==='true'?(a.setAttribute('data-open','false'),a.style.maxHeight=0,z.classList.remove('is-active')):(a.setAttribute('data-open','true'),a.style.maxHeight=a.scrollHeight+"px",z.classList.add('is-active')))}):null,J=document.querySelectorAll('.single__contents > table');for(let a=0;a<J.length;a++)F=J[a],G=document.createElement('div'),G.className='table-wrapper',F.parentElement.replaceChild(G,F),G.appendChild(F);N=document.querySelectorAll('.footnote-ref'),U=document.querySelectorAll('.footnote-backref'),N?N.forEach(function(a,c){a.onmouseenter=function(){b.classList.contains('scrolling')&&b.classList.remove('scrolling')},a.onmouseleave=function(){b.classList.contains('scrolling')||setTimeout(function(){b.classList.add('scrolling')},100)},a.onclick=function(){b.classList.contains('scrolling')||(b.classList.remove('navbar--show'),b.classList.remove('navbar--hide'),b.classList.add('navbar--hide'))}}):null,U?U.forEach(function(a,c){a.onmouseenter=function(){b.classList.contains('scrolling')&&b.classList.remove('scrolling')},a.onmouseleave=function(){b.classList.contains('scrolling')||setTimeout(function(){b.classList.add('scrolling')},100)},a.onclick=function(){b.classList.contains('scrolling')||(b.classList.remove('navbar--show'),b.classList.remove('navbar--hide'),b.classList.add('navbar--hide'))}}):null,f=document.querySelector('.summary__container'),d=document.querySelector('.search-result'),V=document.querySelector('.search-result__close'),V?V.addEventListener('click',function(a){d.setAttribute('data-display','none'),f.setAttribute('data-display','block')}):null,document.querySelectorAll('.tab')?document.querySelectorAll('.tab').forEach(function(a,d){var e=a.getAttribute('id'),f=a,b=a.querySelectorAll('.tab__link'),c=a.querySelectorAll('.tab__content'),g=[];b&&b.length>0?b.forEach(function(b,d,a){b.onclick=function(e){for(var b=0;b<a.length;b++)d===parseInt(b,10)?a[b].classList.contains('active')||(a[b].classList.add('active'),c[b].style.display='block'):(a[b].classList.remove('active'),c[b].style.display='none')}}):null}):null,document.querySelectorAll('.codetab')?document.querySelectorAll('.codetab').forEach(function(a,d){var e=a.getAttribute('id'),f=a,b=a.querySelectorAll('.codetab__link'),c=a.querySelectorAll('.codetab__content'),g=[];b&&b.length>0?b.forEach(function(b,d,a){b.onclick=function(e){for(var b=0;b<a.length;b++)d===parseInt(b,10)?a[b].classList.contains('active')||(a[b].classList.add('active'),c[b].style.display='block'):(a[b].classList.remove('active'),c[b].style.display='none')}}):null}):null,r=document.getElementById("gtt"),r.style.display="none",r.addEventListener('click',function(){window.document.documentMode?document.documentElement.scrollTop=0:af(250)});function af(a){var b=-window.scrollY/(a/15),c=setInterval(function(){window.scrollY!=0?window.scrollBy(0,b):clearInterval(c)},15)}ae=function(){document.body.scrollTop>250||document.documentElement.scrollTop>250?r.style.display="block":r.style.display="none"},Z=document.querySelectorAll('.expand__button');for(let a=0;a<Z.length;a++)Z[a].addEventListener("click",function(){var a=this.nextElementSibling;a.style.maxHeight?(a.style.maxHeight=null,this.querySelector('svg').classList.add('expand-icon__right'),this.querySelector('svg').classList.remove('expand-icon__down')):(a.style.maxHeight=a.scrollHeight+"px",this.querySelector('svg').classList.remove('expand-icon__right'),this.querySelector('svg').classList.add('expand-icon__down'))});Q=window.pageYOffset||document.documentElement.scrollTop,o=document.querySelector('.toc'),g=o?o.querySelector('#TableOfContents'):null,y=document.getElementById('toggle-toc'),k=document.querySelector('.single__contents'),b=document.querySelector('.navbar'),s=document.querySelector('.toc__flexbox'),t=document.querySelector('.toc__flexbox--outer'),P=document.querySelectorAll('.expand__content'),O=document.querySelectorAll('.box'),e=null,C=JSON.parse("true"),h=JSON.parse('["h2","h3","h4"]'),h?h=h.toString():h="h1, h2, h3, h4, h5, h6",k&&k.querySelectorAll(".tab")?k.querySelectorAll(".tab").forEach(function(a){a.querySelectorAll(h).forEach(function(a){e=Array.isArray(e)?e.concat(a.getAttribute('id')):[a.getAttribute('id')]})}):null,P?P.forEach(function(a){a.querySelectorAll(h).forEach(function(a){e=Array.isArray(e)?e.concat(a.getAttribute('id')):[a.getAttribute('id')]})}):null,O?O.forEach(function(a){a.querySelectorAll(h).forEach(function(a){e=Array.isArray(e)?e.concat(a.getAttribute('id')):[a.getAttribute('id')]})}):null,window.onscroll=function(){ae();var a=window.pageYOffset||document.documentElement.scrollTop;if(a>Q){if(a<250?r.style.display="none":r.style.display="block",a<45)return null;b.classList.contains('scrolling')&&(b.classList.contains('navbar--hide')?b.classList.contains('navbar--show')&&b.classList.remove('navbar--show'):b.classList.add('navbar--hide')),k&&(k.querySelectorAll(h).length>0?k.querySelectorAll(h).forEach(function(c){var b,a;if(y&&!y.checked)return null;if(e&&e.includes(c.getAttribute('id')))return null;document.documentElement.scrollTop>=c.offsetTop&&g&&(b=c.getAttribute('id'),o.querySelectorAll('a').forEach(function(a){a.classList.remove('active')}),o.querySelector('a[href="#'+b+'"]')?o.querySelector('a[href="#'+b+'"]').classList.add('active'):null,!1===C||(g.querySelectorAll('ul')?g.querySelectorAll('ul').forEach(function(a){a.querySelectorAll('li').forEach(function(a){a.querySelectorAll('ul').forEach(function(a){a.style.display='none'})})}):null),a=g.querySelector("[href='#"+b+"']"),a&&a.nextElementSibling&&(a.nextElementSibling.style.display='block'),getParents(a,'ul')?getParents(a,'ul').forEach(function(a){a.style.display='block'}):null)}):(s&&(s.setAttribute('data-position',''),s.classList.contains('hide')||s.classList.add('hide')),t&&(t.setAttribute('data-position',''),t.classList.contains('hide')||t.classList.add('hide'))))}else a<250&&(r.style.display="none"),b.classList.contains('scrolling')&&(b.classList.contains('navbar--hide')?b.classList.remove('navbar--hide'):b.classList.contains('navbar--show')||b.classList.add('navbar--show')),k&&(k.querySelectorAll(h).length>0?k.querySelectorAll(h).forEach(function(c){var b,a;if(y&&!y.checked)return null;if(e&&e.includes(c.getAttribute('id')))return null;document.documentElement.scrollTop>=c.offsetTop&&g&&(b=c.getAttribute('id'),o.querySelectorAll('a').forEach(function(a){a.classList.remove('active')}),o.querySelector('a[href="#'+b+'"]')?o.querySelector('a[href="#'+b+'"]').classList.add('active'):null,!1===C||(g.querySelectorAll('ul')?g.querySelectorAll('ul').forEach(function(a){a.querySelectorAll('li').forEach(function(a){a.querySelectorAll('ul').forEach(function(a){a.style.display='none'})})}):null),a=g.querySelector("[href='#"+b+"']"),a&&a.nextElementSibling&&(a.nextElementSibling.style.display='block'),getParents(a,'ul')?getParents(a,'ul').forEach(function(a){a.style.display='block'}):null)}):(s&&!s.classList.contains('hide')&&s.classList.add('hide'),t&&!t.classList.contains('hide')&&t.classList.add('hide'))),g&&document.documentElement.scrollTop<250&&(!1===C||(g.querySelector('ul')?g.querySelector('ul').querySelectorAll('li').forEach(function(a){a.querySelectorAll('ul').forEach(function(a){a.style.display='none'})}):null));Q=a<=0?0:a},D=localStorage.getItem('theme'),B=document.getElementById('root'),ai=document.querySelectorAll('.select-theme'),A=document.querySelectorAll('.select-theme__item'),aj=JSON.parse('"dark"'),at=JSON.parse('"light"'),ar=JSON.parse('"hacker"'),ab=JSON.parse('"solarized"'),aq=JSON.parse('"kimbie"'),E=function(a){var b=document.getElementsByName('msapplication-TileColor')[0],c=document.getElementsByName('theme-color')[0],d=document.getElementsByName('msapplication-navbutton-color')[0],e=document.getElementsByName('apple-mobile-web-app-status-bar-style')[0];a.includes('dark')?(b.setAttribute('content','#fcfcfa'),c.setAttribute('content','#403E41'),d.setAttribute('content','#403E41'),e.setAttribute('content','#403E41')):a.includes('light')?(b.setAttribute('content','#555'),c.setAttribute('content','#eee'),d.setAttribute('content','#eee'),e.setAttribute('content','#eee')):a.includes('hacker')?(b.setAttribute('content','#e3cd26'),c.setAttribute('content','#252526'),d.setAttribute('content','#252526'),e.setAttribute('content','#252526')):a.includes('solarized')?(b.setAttribute('content','#d3af86'),c.setAttribute('content','#51412c'),d.setAttribute('content','#51412c'),e.setAttribute('content','#51412c')):a.includes('kimbie')&&(b.setAttribute('content','#586e75'),c.setAttribute('content','#eee8d5'),d.setAttribute('content','#eee8d5'),e.setAttribute('content','#eee8d5'))},ap=function(a){if(a===aj)return'dark';if(a===at)return'light';if(a===ar)return'hacker';if(a===ab)return'solarized';if(a===aq)return'kimbie'},D?(A?A.forEach(function(a){a.text.trim()===D?a.classList.add('is-active'):a.classList.remove('is-active')}):null,E(D)):E(B.className),A?A.forEach(function(a,b){a.addEventListener('click',function(c){var a=ap(c.target.text.trim()),b,d;localStorage.setItem('theme',a),E(a),B.removeAttribute('class'),B.classList.add('theme__'+a),ai.forEach(function(b){b.querySelectorAll('a').forEach(function(b){b.classList&&(b.text.trim()===a?b.classList.contains('is-active')||b.classList.add('is-active'):b.classList.contains('is-active')&&b.classList.remove('is-active'))})}),window.mermaid&&(a==="dark"||a==="hacker"?(mermaid.initialize({theme:'dark'}),location.reload()):(mermaid.initialize({theme:'default'}),location.reload())),b=document.getElementById('utterances'),b&&b.querySelector('iframe').contentWindow.postMessage({type:'set-theme',theme:a==="dark"||a==="hacker"?'photon-dark':a==='kimbie'?'github-dark-orange':'github-light'},'https://utteranc.es'),d=document.querySelectorAll('.twitter-timeline'),d&&window.postMessage({type:'set-twitter-theme',theme:a==='light'||a==='solarized'?'light':'dark'})})}):null,ao=JSON.parse('"https://sreionet.github.io"'),ah=JSON.parse('"https://sreionet.github.io/posts/istio/fe0ba1/"'),an=JSON.parse('""'),i=null,j=null,c=null,am=JSON.parse("true"),S=JSON.parse("100"),T=JSON.parse("0.4"),ak=JSON.parse("true"),w=JSON.parse("true"),W=JSON.parse('"main"'),X=JSON.parse('"posts"'),ag=JSON.parse('"page"'),x=null,am&&function(){var a=new XMLHttpRequest;X==="publication"&&ag!=="page"?a.open('GET',ah+"index.json"):a.open('GET',ao+an+"/index.json"),a.setRequestHeader('Content-Type','application/json; charset=utf-8'),a.onload=function(){a.status===200?(x=new Fuse(JSON.parse(a.response.toString('utf-8')),{keys:X.includes('publication')?['title','abstract']:ak?['title','description','content']:['title','description'],includeMatches:w,shouldSort:!0,threshold:T||.4,location:0,distance:S||100,maxPatternLength:32,minMatchCharLength:1,isCaseSensitive:!1,findAllMatches:!1,useExtendedSearch:!1}),window.fuse=x):console.error('['+a.status+']Error:',a.statusText)},a.send()}();function ac(e,a){var b=document.createElement('li'),c,d;b.className='search-result__item',c=document.createElement('a'),c.innerHTML=a.item.title,c.setAttribute('class','search-result__item--title'),c.setAttribute('href',a.item.uri),d=document.createElement('div'),d.setAttribute('class','search-result__item--desc'),a.item.description?d.innerHTML=a.item.description:a.item.content&&(d.innerHTML=a.item.content.substring(0,225)),b.appendChild(c),b.appendChild(d),e.appendChild(b)}function al(f,a){var e=document.createElement('li'),b,d,c;if(e.className='search-result__item',b=null,d=document.createElement('a'),d.innerHTML=a.item.title,d.setAttribute('class','search-result__item--title'),d.setAttribute('href',a.item.uri),a.matches&&a.matches.length){for(c=0;c<a.matches.length;c++)'title'===a.matches[c].key&&(d=document.createElement('a'),d.innerHTML=l(a.matches[c].value,a.matches[c].indices),d.setAttribute('class','search-result__item--title'),d.setAttribute('href',a.item.uri)),'description'===a.matches[c].key?(b=document.createElement('div'),b.setAttribute('class','search-result__item--desc'),b.innerHTML=l(a.item.description,a.matches[c].indices)):'content'===a.matches[c].key?b||(b=document.createElement('div'),b.setAttribute('class','search-result__item--desc'),b.innerHTML=l(a.item.content.substring(0,150),a.matches[c].indices)):a.item.description?(b=document.createElement('div'),b.setAttribute('class','search-result__item--desc'),b.innerHTML=a.item.description):(b=document.createElement('div'),b.setAttribute('class','search-result__item--desc'),b.innerHTML=a.item.content.substring(0,150));e.appendChild(d),b&&e.appendChild(b),e&&f.appendChild(e)}}function H(d,c){var a,b;for(i=document.getElementById('search-results'),j=document.getElementById('search-menu'),i.setAttribute('class','dropdown is-active'),a=document.createElement('ul'),a.setAttribute('class','dropdown-content search-content'),c.length?c.forEach(function(b){var e=document.createElement('li'),c=document.createElement('a'),f,d;c.setAttribute('href',b.uri),c.setAttribute('class','dropdown-item'),c.appendChild(e),f=document.createElement('div'),f.innerHTML=b.title,f.setAttribute('class','menu-item__title'),d=document.createElement('div'),d.setAttribute('class','menu-item__desc'),b.description?d.innerHTML=b.description:b.content&&(d.innerHTML=b.content.substring(0,150)),e.appendChild(f),e.appendChild(d),a.appendChild(c)}):(b=document.createElement('li'),b.setAttribute('class','dropdown-item'),b.innerText='No results found',a.appendChild(b));j.hasChildNodes();)j.removeChild(j.lastChild);j.appendChild(a)}function $(d,c){var a,b;for(i=document.getElementById('search-results'),j=document.getElementById('search-menu'),i.setAttribute('class','dropdown is-active'),a=document.createElement('ul'),a.setAttribute('class','dropdown-content search-content'),c.length?c.forEach(function(b){var g=document.createElement('li'),e=document.createElement('a'),c=null,f,d;if(e.setAttribute('href',b.item.uri),e.setAttribute('class','dropdown-item'),e.appendChild(g),f=document.createElement('div'),f.innerHTML=b.item.title,f.setAttribute('class','menu-item__title'),b.matches&&b.matches.length){for(d=0;d<b.matches.length;d++)'title'===b.matches[d].key&&(f.innerHTML=l(b.matches[d].value,b.matches[d].indices)),'description'===b.matches[d].key?(c=document.createElement('div'),c.setAttribute('class','menu-item__desc'),c.innerHTML=l(b.item.description,b.matches[d].indices)):'content'===b.matches[d].key?c||(c=document.createElement('div'),c.setAttribute('class','menu-item__desc'),c.innerHTML=l(b.item.content.substring(0,150),b.matches[d].indices)):b.item.description?(c=document.createElement('div'),c.setAttribute('class','menu-item__desc'),c.innerHTML=b.item.description):(c=document.createElement('div'),c.setAttribute('class','menu-item__desc'),c.innerHTML=b.item.content.substring(0,150));g.appendChild(f),c&&g.appendChild(c),a.appendChild(e)}}):(b=document.createElement('li'),b.setAttribute('class','dropdown-item'),b.innerText='No results found',a.appendChild(b));j.hasChildNodes();)j.removeChild(j.lastChild);j.appendChild(a)}function _(e,c){var a,d;i=document.getElementById('search-mobile-results'),a=document.createElement('div'),a.setAttribute('class','mobile-search__content'),c.length>0?c.forEach(function(b){var c=document.createElement('a');c.setAttribute('href',b.uri),c.innerHTML='<div class="mobile-search__item"><div class="mobile-search__item--title">📄 '+b.title+'</div><div class="mobile-search__item--desc">'+(b.description?b.description:b.content)+'</div></div>',a.appendChild(c)}):(d=document.createElement('span'),a.appendChild(d));let b=document.getElementById('search-mobile-results');while(b.firstChild)b.removeChild(b.firstChild);i.appendChild(a)}function ad(e,c){var a,d;i=document.getElementById('search-mobile-results'),a=document.createElement('div'),a.setAttribute('class','mobile-search__content'),c.length?c.forEach(function(b){var e=document.createElement('li'),g=document.createElement('a'),c=null,f,d;if(g.setAttribute('href',b.item.uri),g.appendChild(e),e.setAttribute('class','mobile-search__item'),f=document.createElement('div'),f.innerHTML=b.item.title,f.setAttribute('class','mobile-search__item--title'),b.matches&&b.matches.length){for(d=0;d<b.matches.length;d++)'title'===b.matches[d].key&&(f.innerHTML=l(b.matches[d].value,b.matches[d].indices)),'description'===b.matches[d].key?(c=document.createElement('div'),c.setAttribute('class','mobile-search__item--desc'),c.innerHTML=l(b.item.description,b.matches[d].indices)):'content'===b.matches[d].key?c||(c=document.createElement('div'),c.setAttribute('class','mobile-search__item--desc'),c.innerHTML=l(b.item.content.substring(0,150),b.matches[d].indices)):b.item.description?(c=document.createElement('div'),c.setAttribute('class','mobile-search__item--desc'),c.innerHTML=b.item.description):(c=document.createElement('div'),c.setAttribute('class','mobile-search__item--desc'),c.innerHTML=b.item.content.substring(0,150));e.appendChild(f),c&&e.appendChild(c),a.appendChild(g)}}):(d=document.createElement('span'),a.appendChild(d));let b=document.getElementById('search-mobile-results');while(b.firstChild)b.removeChild(b.firstChild);i.appendChild(a)}function l(a,d){if(!d)return a;var b='',c=0;return d.forEach(function(d){if(d[0]===d[1])return null;b+=''+a.substring(c,d[0])+'<span class="search__highlight">'+a.substring(d[0],d[1]+1)+'</span>'+'',c=d[1]+1}),b+=a.substring(c),b}n=document.getElementById('search'),Y=document.getElementById('search-mobile'),q=document.getElementById('search-results'),n?n.addEventListener('input',function(b){var a,e;if(!b.target.value|window.innerWidth<770)return q?q.setAttribute('class','dropdown'):null,d?d.setAttribute('data-display','none'):null,f?f.setAttribute('data-display','block'):null,null;c=b.target.value,a=x.search(b.target.value),W==="main"?w?aa(c,a):M(c,a):(w?$(c,a):H(c,a),e=q.querySelectorAll('.dropdown-item'),e?e.forEach(function(a){a.addEventListener('mousedown',function(a){a.target.click()})}):null)}):null,n?n.addEventListener('blur',function(){if(window.innerWidth<770)return null;q?q.setAttribute('class','dropdown'):null}):null,n?n.addEventListener('click',function(b){var a,d;if(window.innerWidth<770)return null;if(!b.target.value)return q?q.setAttribute('class','dropdown'):null,null;c=b.target.value,a=x.search(b.target.value),W==="main"?w?aa(c,a):M(c,a):(w?$(c,a):H(c,a),d=q.querySelectorAll('.dropdown-item'),d?d.forEach(function(a){a.addEventListener('mousedown',function(a){a.target.click()})}):null)}):null,av=document.getElementById("search-menu"),au=document.querySelector('#search-menu .dropdown-item.is-active'),a=null,aw=null,R=350,n?n.addEventListener('keydown',function(c){var b,e;if(window.innerWidth<770)return null;if(c.key==='Escape'&&(d?d.setAttribute('data-display','none'):null,f?f.setAttribute('data-display','block'):null),b=document.querySelectorAll('#search-menu .dropdown-item'),e=c.which||c.keyCode,!b||!b.length)return null;if(c.key==='ArrowDown'||e===40){a===null?(a=0,b[a].classList.remove('is-active')):(b[a].classList.remove('is-active'),a=a===b.length-1?0:a+1),b[a].classList.add('is-active');let c=b[a].offsetTop+b[a].clientHeight-R;c>0?document.querySelector(".search-content").scrollTop+=b[a].getBoundingClientRect().height:a===0&&(document.querySelector(".search-content").scrollTop=0)}else if(c.key==='ArrowUp'||e===38){a===null?(a=b.length-1,b[a].classList.remove('is-active')):(b[a].classList.remove('is-active'),a=a===0?b.length-1:a-1),b[a].classList.add('is-active');let c=b[a].offsetTop+b[a].clientHeight-R;c<0?document.querySelector(".search-content").scrollTop-=b[a].getBoundingClientRect().height:document.querySelector(".search-content").scrollTop=c+b[a].getBoundingClientRect().height}else c.key==='Enter'||e===13?b[a]&&b[a].getAttribute('href')&&(location.href=b[a].getAttribute('href')):(c.key==='Escape'||e===27)&&(c.target.value=null,i&&i.classList.remove('is-active'))}):null,Y?Y.addEventListener('input',function(a){if(!a.target.value){let a=document.getElementById('search-mobile-results');while(a.firstChild)a.removeChild(a.firstChild);return null}c=a.target.value;var b=x.search(a.target.value);_(c,b),w?ad(c,b):_(c,b)}):null,m=document.querySelector('#search-mobile'),L=document.querySelector('.mobile-search'),K=document.querySelectorAll('.navbar-search'),I=document.querySelector('#search-mobile-close'),v=document.querySelector('#search-mobile-container'),p=document.querySelector('#search-mobile-results'),u=document.querySelector('html'),L&&(L.style.display='none'),K?K.forEach(function(a,b){a.addEventListener('click',function(){v&&(v.style.display='block'),m&&m.focus(),u&&(u.style.overflowY='hidden')})}):null,I?I.addEventListener('click',function(){if(v&&(v.style.display='none'),m&&(m.value=''),p)while(p.firstChild)p.removeChild(p.firstChild);u&&(u.style.overflowY='visible')}):null,m?m.addEventListener('keydown',function(a){var b=a.which||a.keyCode;if(a.key==='Escape'||b===27){if(v&&(v.style.display='none'),m&&(m.value=''),p)while(p.firstChild)p.removeChild(p.firstChild);u&&(u.style.overflowY='visible')}}):null;function M(e,a){var g=document.querySelector('.search-result__body'),b=g.querySelector('ul'),c=document.createElement('ul');e?a&&a&&a.length&&(a.forEach(function(a){ac(c,a)}),d?d.setAttribute('data-display','block'):null,f?f.setAttribute('data-display','none'):null):(d?d.setAttribute('data-display','none'):null,f?f.setAttribute('data-display','block'):null),b.parentNode.replaceChild(c,b)}function aa(e,a){var g=document.querySelector('.search-result__body'),b=g.querySelector('ul'),c=document.createElement('ul');e?a&&a&&a.length&&(a.forEach(function(a){al(c,a)}),d?d.setAttribute('data-display','block'):null,f?f.setAttribute('data-display','none'):null):(d?d.setAttribute('data-display','none'):null,f?f.setAttribute('data-display','block'):null),b.parentNode.replaceChild(c,b)}})</script><link rel=stylesheet href=/css/main.min.css><meta name=description content="云原生技术圈."><meta name=keywords content="istio,转载"><meta name=created content="2022-09-11T14:26:02+0800"><meta name=modified content="2022-09-11T14:26:02+0800"><meta property="article:published_time"content="2022-09-11T14:26:02+0800"><meta name=author content="kbsonlong"><meta property="article:author"content="https://sreionet.github.io/posts/istio/fe0ba1/@kbsonlong"><meta property="og:site_name"content="云原生技术圈"><meta property="og:title"content="Istio 中的 Sidecar 注入、透明流量劫持及流量路由过程详解"><meta property="og:url"content="https://sreionet.github.io/posts/istio/fe0ba1/"><meta property="og:type"content="article"><meta property="og:description"content="云原生技术圈."><meta name=generator content="Hugo 0.76.0"><meta name=msapplication-TileColor content="#fff"><meta name=theme-color content="#fff"><meta name=msapplication-navbutton-color content="#fff"><meta name=apple-mobile-web-app-status-bar-style content="#fff"><link rel=canonical href=https://sreionet.github.io/posts/istio/fe0ba1/><link rel=manifest href=/manifest.json><link rel=apple-touch-icon sizes=57x57 href=/favicon/apple-icon-57x57.png><link rel=apple-touch-icon sizes=60x60 href=/favicon/apple-icon-60x60.png><link rel=apple-touch-icon sizes=72x72 href=/favicon/apple-icon-72x72.png><link rel=apple-touch-icon sizes=76x76 href=/favicon/apple-icon-76x76.png><link rel=apple-touch-icon sizes=114x114 href=/favicon/apple-icon-114x114.png><link rel=apple-touch-icon sizes=120x120 href=/favicon/apple-icon-120x120.png><link rel=apple-touch-icon sizes=144x144 href=/favicon/apple-icon-144x144.png><link rel=apple-touch-icon sizes=152x152 href=/favicon/apple-icon-152x152.png><link rel=apple-touch-icon sizes=180x180 href=/favicon/apple-icon-180x180.png><link rel=icon type=image/png sizes=192x192 href=/favicon/android-icon-192x192.png><link rel=icon type=image/png sizes=192x192 href=/favicon/android-icon-512x512.png><link rel=icon type=image/png sizes=32x32 href=/favicon/favicon-32x32.png><link rel=icon type=image/png sizes=96x96 href=/favicon/favicon-96x96.png><link rel=icon type=image/png sizes=16x16 href=/favicon/favicon-16x16.png><meta name=msapplication-TileColor content="#ffffff"><meta name=msapplication-TileImage content="/ms-icon-144x144.png"><script type=application/ld+json>{"@context":"https://schema.org","@type":"WebPage","headline":"Istio 中的 Sidecar 注入、透明流量劫持及流量路由过程详解","datePublished":"2022-09-11T14:26:02+08:00","dateModified":"2022-09-11T14:26:02+08:00","url":"https://sreionet.github.io/posts/istio/fe0ba1/","description":"本文最早是基于 Istio 1.11 撰写，之后随着 Istio 的版本陆续更新，最新更新时间为 2022 年 5 月 12 日，关于本文历史版本的更新说明请见文章最后。本文记录了详细的实践过","keywords":["istio","转载"],"author":{"@type":"Person","name":"kbsonlong"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://sreionet.github.io"},"publisher":{"@type":"Organization","name":"云原生技术圈","url":"https://sreionet.github.io"}}</script></head><body id=root class=theme__dark><script>var localTheme=localStorage.getItem('theme');localTheme&&(document.getElementById('root').className='theme__'+localTheme)</script><div id=container><div class=wrapper data-type=posts data-kind=page><nav class="navbar scrolling"role=navigation aria-label="main navigation"data-dir=ltr><div class=navbar__brand><a href=/ title=主页 rel=home class=navbar__logo-link><img src=/logo.png alt=Home class=navbar__logo></a>
<a href=/ title=主页 rel=home class=navbar__title-link><h6 class=navbar__title>云原生技术圈</h6></a></div><div class="theme theme-mobile"data-ani=true><div class=dropdown><button class="dropdown-trigger navbar__slide-down"aria-label="Select Theme Button"data-ani=true><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24"><path fill="none" d="M24 0H0v24h24V0z"/><path fill="currentcolor" d="M6.34 7.93c-3.12 3.12-3.12 8.19.0 11.31C7.9 20.8 9.95 21.58 12 21.58s4.1-.78 5.66-2.34c3.12-3.12 3.12-8.19.0-11.31l-4.95-4.95c-.39-.39-1.02-.39-1.41.0L6.34 7.93zM12 19.59c-1.6.0-3.11-.62-4.24-1.76C6.62 16.69 6 15.19 6 13.59s.62-3.11 1.76-4.24L12 5.1v14.49z"/></svg></button><div class="dropdown-content select-theme"><a href=# class="dropdown-item select-theme__item is-active">dark</a>
<a href=# class="dropdown-item select-theme__item">light</a></div></div></div><div class="mobile-search__btn navbar-search"data-ani=true><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="currentcolor" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><path d="M15.5 14h-.79l-.28-.27c1.2-1.4 1.82-3.31 1.48-5.34-.47-2.78-2.79-5-5.59-5.34-4.23-.52-7.79 3.04-7.27 7.27.34 2.8 2.56 5.12 5.34 5.59 2.03.34 3.94-.28 5.34-1.48l.27.28v.79l4.25 4.25c.41.41 1.08.41 1.49.0s.41-1.08.0-1.49L15.5 14zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg></div><div id=search-mobile-container class="mobile-search hide"data-dir=ltr><div class=mobile-search__top><input id=search-mobile type=text aria-label="Mobile Search"placeholder=搜索 class=mobile-search__top--input><div id=search-mobile-close class=mobile-search__top--icon><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24"><path opacity=".87" fill="none" d="M0 0h24v24H0V0z"/><path fill="currentcolor" d="M12 2C6.47 2 2 6.47 2 12s4.47 10 10 10 10-4.47 10-10S17.53 2 12 2zm0 18c-4.41.0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm3.59-13L12 10.59 8.41 7 7 8.41 10.59 12 7 15.59 8.41 17 12 13.41 15.59 17 17 15.59 13.41 12 17 8.41z"/></svg></div></div><div id=search-mobile-results class=mobile-search__body></div></div><a role=button class=navbar__burger aria-label=menu aria-expanded=false data-ani=true><span aria-hidden=true></span><span aria-hidden=true></span><span aria-hidden=true></span></a><div class=navbarm__collapse data-open=false><ul dir=ltr><li class=navbarm__menu--item><a href=/about>关于</a></li><li class=navbarm__menu--item><a href=/archive>归档</a></li><li class="navbarm__menu--item active"><a href=/posts>博客</a></li><li class=navbarm__menu--item><a href=/tags class=navbarm__menu--term data-index=0>标签</a></li><li class=navbarm__menu--item><a href=/categories class=navbarm__menu--term data-index=1>分类</a></li><li class=navbarm__menu--item><a href=/series class=navbarm__menu--term data-index=2>系列</a></li></ul></div><div class=navbar__menu><div class=theme data-ani=true><div class=dropdown><button class="dropdown-trigger navbar__slide-down"aria-label="Select Theme Button"data-ani=true><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24"><path fill="none" d="M24 0H0v24h24V0z"/><path fill="currentcolor" d="M6.34 7.93c-3.12 3.12-3.12 8.19.0 11.31C7.9 20.8 9.95 21.58 12 21.58s4.1-.78 5.66-2.34c3.12-3.12 3.12-8.19.0-11.31l-4.95-4.95c-.39-.39-1.02-.39-1.41.0L6.34 7.93zM12 19.59c-1.6.0-3.11-.62-4.24-1.76C6.62 16.69 6 15.19 6 13.59s.62-3.11 1.76-4.24L12 5.1v14.49z"/></svg></button><div class="dropdown-content select-theme"><a href=# class="dropdown-item select-theme__item is-active">dark</a>
<a href=# class="dropdown-item select-theme__item">light</a></div></div></div><a href=/about class="navbar__menu-item navbar__slide-down"dir=ltr data-ani=true>关于</a>
<a href=/archive class="navbar__menu-item navbar__slide-down"dir=ltr data-ani=true>归档</a>
<a href=/posts class="navbar__menu-item navbar__slide-down active"dir=ltr data-ani=true>博客</a></div></nav><main class="single__main main-main"><nav class="breadcrumb hide"aria-label=breadcrumbs><script>document.querySelector('.breadcrumb').classList.remove('hide')</script><ol><li><a href=https://sreionet.github.io/ class=capitalize>云原生技术圈</a></li><li><a href=https://sreionet.github.io/posts/ class=capitalize>Posts</a></li><li class=is-active><span>Istio 中的 Sidecar 注入、透明流量劫持及流量路由过程详解</span></li></ol></nav><div class=single><div class=single__nojs>Please enable Javascript to view the contents</div><script>document.querySelector('.single').classList.remove('hide'),document.querySelector('.single__nojs').classList.add('hide')</script><h2 class=single__title data-ani=true>Istio 中的 Sidecar 注入、透明流量劫持及流量路由过程详解</h2><h3 class=single__subtitle></h3><div class=single__meta><div class=single__infos><time class=single__info title=创建日期>📅&nbsp;2022年09月11日</time>
&nbsp;&#183;&nbsp; <span class=single__info title=阅读时长>☕&nbsp;18&nbsp;分钟</span>
&nbsp;&#183;&nbsp; <span class=single__info title=作者>✍️&nbsp;kbsonlong</span>
<span class=single__info></span></div><ul class="single__tags caption">🏷️<li><a href=https://sreionet.github.io/tags/istio/ class=single__tag title=istio>#istio</a></li><li><a href=https://sreionet.github.io/tags/%E8%BD%AC%E8%BD%BD/ class=single__tag title=转载>#转载</a></li></ul></div><article class=single__contents data-dir=ltr data-ani=true><p>本文最早是基于 Istio 1.11 撰写，之后随着 Istio 的版本陆续更新，最新更新时间为 2022 年 5 月 12 日，关于本文历史版本的更新说明请见文章最后。本文记录了详细的实践过程，力图能够让读者复现，因此事无巨细，想要理解某个部分过程的读者可以使用目录跳转到对应的小节阅读。</p><p>为了理解本文希望你先阅读以下内容：</p><ul><li><a href=/posts/b7e1eb/>理解 iptables</a></li><li><a href=/posts/dc5625/>Istio 数据平面 Pod 启动过程详解</a></li></ul><h2 id=内容介绍>内容介绍</h2><p>本文基于 Istio 1.13 版本，将为大家介绍以下内容：</p><ul><li>什么是 sidecar 模式和它的优势在哪里。</li><li>Istio 中是如何做 sidecar 注入的。</li><li>Sidecar 代理是如何做透明流量劫持的。</li><li>iptables 的路由规则。</li><li>Envoy 代理是如何路由流量到上游的。</li></ul><p>请大家结合下图理解本文中的内容，本图基于 Istio 官方提供的 Bookinfo 示例绘制，展示的是 <code>reviews</code> Pod 的内部结构，包括 Linux Kernel 空间中的 iptables 规则、Sidecar 容器、应用容器。</p><p><img src=https://raw.githubusercontent.com/kbsonlong/notes_statics/master/images/20220913144220.png alt="Istio 流量劫持示意图"></p><p><code>productpage</code> 访问 <code>reviews</code> Pod，入站流量处理过程对应于图示上的步骤：1、2、3、4、Envoy Inbound Handler、5、6、7、8、应用容器。</p><p><code>reviews</code> Pod 访问 <code>rating</code> 服务的出站流量处理过程对应于图示上的步骤是：9、10、11、12、Envoy Outbound Handler、13、14、15。</p><p>注意：图中的路径 16 近用于路由规则说明，它不不出现在当前示例中。实际上仅当 Pod 内发出的对当前 Pod 内的服务访问的时候才会途径它。</p><p>上图中关于流量路由部分，包含：</p><ul><li><code>productpage</code> 服务请求访问 <code>http://reviews.default.svc.cluster.local:9080/</code>，当流量进入 <code>reviews</code> Pod 内部时，流量是如何被 iptables 劫持到 Envoy 代理被 Inbound Handler 处理的；</li><li><code>reviews</code> 请求访问 <code>ratings</code> 服务的 Pod，应用程序发出的出站流量被 iptables 劫持到 Envoy 代理的 Outbound Handler 的处理。</li></ul><p>在阅读下文时，请大家确立以下已知点：</p><ul><li>首先，<code>productpage</code> 发出的对 <code>reivews</code> 的访问流量，是在 Envoy 已经通过 EDS 选择出了要请求的 <code>reviews</code> 服务的某个 Pod，知晓了其 IP 地址，直接向该 IP 发送的 TCP 连接请求。</li><li><code>reviews</code> 服务有三个版本，每个版本有一个实例，三个版本中的 sidecar 工作步骤类似，下文只以其中一个 Pod 中的 sidecar 流量转发步骤来说明。</li><li>所有进入 <code>reviews</code> Pod 的 TCP 流量都根据 Pod 中的 iptables 规则转发到了 Envoy 代理的 15006 端口，然后经过 Envoy 的处理确定转发给 Pod 内的应用容器还是透传。</li></ul><h2 id=sidecar-模式>Sidecar 模式</h2><p>将应用程序的功能划分为单独的进程运行在同一个最小调度单元中（例如 Kubernetes 中的 Pod）可以被视为 <strong>sidecar 模式</strong>。如下图所示，sidecar 模式允许您在应用程序旁边添加更多功能，而无需额外第三方组件配置或修改应用程序代码。</p><p><img src=https://raw.githubusercontent.com/kbsonlong/notes_statics/master/images/20220913144314.png alt></p><p>就像连接了 Sidecar 的三轮摩托车一样，在软件架构中， Sidecar 连接到父应用并且为其添加扩展或者增强功能。Sidecar 应用与主应用程序松散耦合。它可以屏蔽不同编程语言的差异，统一实现微服务的可观察性、监控、日志记录、配置、断路器等功能。</p><h3 id=使用-sidecar-模式的优势>使用 Sidecar 模式的优势</h3><p>使用 sidecar 模式部署服务网格时，无需在节点上运行代理，但是集群中将运行多个相同的 sidecar 副本。在 sidecar 部署方式中，每个应用的容器旁都会部署一个伴生容器（如 Envoy 或 MOSN），这个容器称之为 sidecar 容器。Sidecar 接管进出应用容器的所有流量。在 Kubernetes 的 Pod 中，在原有的应用容器旁边注入一个 Sidecar 容器，两个容器共享存储、网络等资源，可以广义的将这个包含了 sidecar 容器的 Pod 理解为一台主机，两个容器共享主机资源。</p><p>因其独特的部署结构，使得 sidecar 模式具有以下优势：</p><ul><li>将与应用业务逻辑无关的功能抽象到共同基础设施，降低了微服务代码的复杂度。</li><li>因为不再需要编写相同的第三方组件配置文件和代码，所以能够降低微服务架构中的代码重复度。</li><li>Sidecar 可独立升级，降低应用程序代码和底层平台的耦合度。</li></ul><h2 id=sidecar-注入示例分析>Sidecar 注入示例分析</h2><p>以 Istio 官方提供的 <code>bookinfo</code> 中 <code>productpage</code> 的 YAML 为例，关于 <code>bookinfo</code> 应用的详细 YAML 配置请参考 <a href=https://github.com/istio/istio/blob/master/samples/bookinfo/platform/kube/bookinfo.yaml>bookinfo.yaml</a>。</p><p>下文将从以下几个方面讲解：</p><ul><li>Sidecar 容器的注入</li><li>iptables 规则的创建</li><li>路由的详细过程</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Deployment</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>productpage-v1</span><span class=w>
</span><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>productpage</span><span class=w>
</span><span class=w>    </span><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>productpage</span><span class=w>
</span><span class=w>      </span><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>productpage</span><span class=w>
</span><span class=w>        </span><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>serviceAccountName</span><span class=p>:</span><span class=w> </span><span class=l>bookinfo-productpage</span><span class=w>
</span><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>productpage</span><span class=w>
</span><span class=w>        </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>docker.io/istio/examples-bookinfo-productpage-v1:1.15.0</span><span class=w>
</span><span class=w>        </span><span class=nt>imagePullPolicy</span><span class=p>:</span><span class=w> </span><span class=l>IfNotPresent</span><span class=w>
</span><span class=w>        </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span><span class=w>        </span>- <span class=nt>containerPort</span><span class=p>:</span><span class=w> </span><span class=m>9080</span><span class=w>
</span><span class=w>        </span><span class=nt>volumeMounts</span><span class=p>:</span><span class=w>
</span><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>tmp</span><span class=w>
</span><span class=w>          </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/tmp</span><span class=w>
</span><span class=w>      </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>tmp</span><span class=w>
</span><span class=w>        </span><span class=nt>emptyDir</span><span class=p>:</span><span class=w> </span>{}<span class=w>
</span></code></pre></td></tr></table></div></div><p>再查看下 <code>productpage</code> 容器的 <a href=https://github.com/istio/istio/blob/master/samples/bookinfo/src/productpage/Dockerfile>Dockerfile</a>。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-docker data-lang=docker><span class=k>FROM</span><span class=s> python:3.7.4-slim</span><span class=err>
</span><span class=err>
</span><span class=err></span><span class=k>COPY</span> requirements.txt ./<span class=err>
</span><span class=err></span><span class=k>RUN</span> pip install --no-cache-dir -r requirements.txt<span class=err>
</span><span class=err>
</span><span class=err></span><span class=k>COPY</span> test-requirements.txt ./<span class=err>
</span><span class=err></span><span class=k>RUN</span> pip install --no-cache-dir -r test-requirements.txt<span class=err>
</span><span class=err>
</span><span class=err></span><span class=k>COPY</span> productpage.py /opt/microservices/<span class=err>
</span><span class=err></span><span class=k>COPY</span> tests/unit/* /opt/microservices/<span class=err>
</span><span class=err></span><span class=k>COPY</span> templates /opt/microservices/templates<span class=err>
</span><span class=err></span><span class=k>COPY</span> static /opt/microservices/static<span class=err>
</span><span class=err></span><span class=k>COPY</span> requirements.txt /opt/microservices/<span class=err>
</span><span class=err>
</span><span class=err></span><span class=k>ARG</span> flood_factor<span class=err>
</span><span class=err></span><span class=k>ENV</span> FLOOD_FACTOR <span class=si>${</span><span class=nv>flood_factor</span><span class=k>:-</span><span class=nv>0</span><span class=si>}</span><span class=err>
</span><span class=err>
</span><span class=err></span><span class=k>EXPOSE</span><span class=s> 9080</span><span class=err>
</span><span class=err></span><span class=k>WORKDIR</span><span class=s> /opt/microservices</span><span class=err>
</span><span class=err></span><span class=k>RUN</span> python -m unittest discover<span class=err>
</span><span class=err>
</span><span class=err></span><span class=k>USER</span><span class=s> 1</span><span class=err>
</span><span class=err>
</span><span class=err></span><span class=k>CMD</span> <span class=p>[</span><span class=s2>&#34;python&#34;</span><span class=p>,</span> <span class=s2>&#34;productpage.py&#34;</span><span class=p>,</span> <span class=s2>&#34;9080&#34;</span><span class=p>]</span><span class=err>
</span></code></pre></td></tr></table></div></div><p>我们看到 <code>Dockerfile</code> 中没有配置 <code>ENTRYPOINT</code>，所以 <code>CMD</code> 的配置 <code>python productpage.py 9080</code> 将作为默认的 <code>ENTRYPOINT</code>，记住这一点，再看下注入 sidecar 之后的配置。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>$ istioctl kube-inject -f samples/bookinfo/platform/kube/bookinfo.yaml
</code></pre></td></tr></table></div></div><p>我们只截取其中与 <code>productpage</code> 相关的 <code>Deployment</code> 配置中的部分 YAML 配置。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-yaml data-lang=yaml><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>docker.io/istio/examples-bookinfo-productpage-v1:1.15.0</span><span class=w> </span><span class=c># 应用镜像</span><span class=w>
</span><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>productpage</span><span class=w>
</span><span class=w>        </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span><span class=w>        </span>- <span class=nt>containerPort</span><span class=p>:</span><span class=w> </span><span class=m>9080</span><span class=w>
</span><span class=w>      </span>- <span class=nt>args</span><span class=p>:</span><span class=w>
</span><span class=w>        </span>- <span class=l>proxy</span><span class=w>
</span><span class=w>        </span>- <span class=l>sidecar</span><span class=w>
</span><span class=w>        </span>- --<span class=l>domain</span><span class=w>
</span><span class=w>        </span>- <span class=l>$(POD_NAMESPACE).svc.cluster.local</span><span class=w>
</span><span class=w>        </span>- --<span class=l>configPath</span><span class=w>
</span><span class=w>        </span>- <span class=l>/etc/istio/proxy</span><span class=w>
</span><span class=w>        </span>- --<span class=l>binaryPath</span><span class=w>
</span><span class=w>        </span>- <span class=l>/usr/local/bin/envoy</span><span class=w>
</span><span class=w>        </span>- --<span class=l>serviceCluster</span><span class=w>
</span><span class=w>        </span>- <span class=l>productpage.$(POD_NAMESPACE)</span><span class=w>
</span><span class=w>        </span>- --<span class=l>drainDuration</span><span class=w>
</span><span class=w>        </span>- <span class=l>45s</span><span class=w>
</span><span class=w>        </span>- --<span class=l>parentShutdownDuration</span><span class=w>
</span><span class=w>        </span>- <span class=l>1m0s</span><span class=w>
</span><span class=w>        </span>- --<span class=l>discoveryAddress</span><span class=w>
</span><span class=w>        </span>- <span class=l>istiod.istio-system.svc:15012</span><span class=w>
</span><span class=w>        </span>- --<span class=l>zipkinAddress</span><span class=w>
</span><span class=w>        </span>- <span class=l>zipkin.istio-system:9411</span><span class=w>
</span><span class=w>        </span>- --<span class=l>proxyLogLevel=warning</span><span class=w>
</span><span class=w>        </span>- --<span class=l>proxyComponentLogLevel=misc:error</span><span class=w>
</span><span class=w>        </span>- --<span class=l>connectTimeout</span><span class=w>
</span><span class=w>        </span>- <span class=l>10s</span><span class=w>
</span><span class=w>        </span>- --<span class=l>proxyAdminPort</span><span class=w>
</span><span class=w>        </span>- <span class=s2>&#34;15000&#34;</span><span class=w>
</span><span class=w>        </span>- --<span class=l>concurrency</span><span class=w>
</span><span class=w>        </span>- <span class=s2>&#34;2&#34;</span><span class=w>
</span><span class=w>        </span>- --<span class=l>controlPlaneAuthPolicy</span><span class=w>
</span><span class=w>        </span>- <span class=l>NONE</span><span class=w>
</span><span class=w>        </span>- --<span class=l>dnsRefreshRate</span><span class=w>
</span><span class=w>        </span>- <span class=l>300s</span><span class=w>
</span><span class=w>        </span>- --<span class=l>statusPort</span><span class=w>
</span><span class=w>        </span>- <span class=s2>&#34;15020&#34;</span><span class=w>
</span><span class=w>        </span>- --<span class=l>trust-domain=cluster.local</span><span class=w>
</span><span class=w>        </span>- --<span class=l>controlPlaneBootstrap=false</span><span class=w>
</span><span class=w>        </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>docker.io/istio/proxyv2:1.5.1</span><span class=w> </span><span class=c># sidecar proxy</span><span class=w>
</span><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>istio-proxy</span><span class=w>
</span><span class=w>        </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span><span class=w>        </span>- <span class=nt>containerPort</span><span class=p>:</span><span class=w> </span><span class=m>15090</span><span class=w>
</span><span class=w>          </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>http-envoy-prom</span><span class=w>
</span><span class=w>          </span><span class=nt>protocol</span><span class=p>:</span><span class=w> </span><span class=l>TCP</span><span class=w>
</span><span class=w>      </span><span class=nt>initContainers</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=nt>command</span><span class=p>:</span><span class=w>
</span><span class=w>        </span>- <span class=l>istio-iptables</span><span class=w>
</span><span class=w>        </span>- -<span class=l>p</span><span class=w>
</span><span class=w>        </span>- <span class=s2>&#34;15001&#34;</span><span class=w>
</span><span class=w>        </span>- -<span class=l>z</span><span class=w>
</span><span class=w>        </span>- <span class=s2>&#34;15006&#34;</span><span class=w>
</span><span class=w>        </span>- -<span class=l>u</span><span class=w>
</span><span class=w>        </span>- <span class=s2>&#34;1337&#34;</span><span class=w>
</span><span class=w>        </span>- -<span class=l>m</span><span class=w>
</span><span class=w>        </span>- <span class=l>REDIRECT</span><span class=w>
</span><span class=w>        </span>- -<span class=l>i</span><span class=w>
</span><span class=w>        </span>- <span class=s1>&#39;*&#39;</span><span class=w>
</span><span class=w>        </span>- -<span class=l>x</span><span class=w>
</span><span class=w>        </span>- <span class=s2>&#34;&#34;</span><span class=w>
</span><span class=w>        </span>- -<span class=l>b</span><span class=w>
</span><span class=w>        </span>- <span class=s1>&#39;*&#39;</span><span class=w>
</span><span class=w>        </span>- -<span class=l>d</span><span class=w>
</span><span class=w>        </span>- <span class=m>15090</span><span class=p>,</span><span class=m>15020</span><span class=w>
</span><span class=w>        </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>docker.io/istio/proxyv2:1.5.1</span><span class=w> </span><span class=c># init 容器</span><span class=w>
</span><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>istio-init</span><span class=w>
</span></code></pre></td></tr></table></div></div><p>Istio 给应用 Pod 注入的配置主要包括：</p><ul><li>Init 容器 <code>istio-init</code>：用于 pod 中设置 iptables 端口转发</li><li>Sidecar 容器 <code>istio-proxy</code>：运行 sidecar 代理，如 Envoy 或 MOSN。</li></ul><h2 id=iptables-规则注入解析>iptables 规则注入解析</h2><p>为了查看 iptables 配置，我们需要登陆到 sidecar 容器中使用 root 用户来查看，因为 <code>kubectl</code> 无法使用特权模式来远程操作 docker 容器，所以我们需要登陆到 <code>productpage</code> pod 所在的主机上使用 <code>docker</code> 命令登陆容器中查看。</p><p>如果您使用 minikube 部署的 Kubernetes，可以直接登录到 minikube 的虚拟机中并切换为 root 用户。查看 iptables 配置，列出 NAT（网络地址转换）表的所有规则，因为在 Init 容器启动的时候选择给 <code>istio-iptables</code> 传递的参数中指定将入站流量重定向到 sidecar 的模式为 <code>REDIRECT</code>，因此在 iptables 中将只有 NAT 表的规格配置，如果选择 <code>TPROXY</code> 还会有 <code>mangle</code> 表配置。<code>iptables</code> 命令的详细用法请参考 <a href=https://wangchujiang.com/linux-command/c/iptables.html>iptables</a> 命令。</p><p>我们仅查看与 <code>productpage</code> 有关的 iptables 规则如下，因为这些规则是运行在该容器特定的网络空间下，因此需要使用 <code>nsenter</code> 命令进入其网络空间。进入的时候需要指定进程 ID（PID），因此首先我们需要找到 <code>productpage</code> 容器的 PID。对于在不同平台上安装的 Kubernetes，查找容器的方式会略有不同，例如在 GKE 上，执行 <code>docker ps -a</code> 命令是查看不到任何容器进程的。下面已 minikube 和 GKE 两个典型的平台为例，指导你如何进入容器的网络空间。</p><h3 id=在-minikube-中查看容器中的-iptabes-规则>在 minikube 中查看容器中的 iptabes 规则</h3><p>对于 minikube，因为所有的进程都运行在单个节点上，因此你只需要登录到 minikube 虚拟机，切换为 root 用户然后查找 <code>productpage</code> 进程即可，参考下面的步骤。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash><span class=c1># 进入 minikube 并切换为 root 用户，minikube 默认用户为 docker</span>
$ minikube ssh
$ sudo -i

<span class=c1># 查看 productpage pod 的 istio-proxy 容器中的进程</span>
$ docker top <span class=sb>`</span>docker ps<span class=p>|</span>grep <span class=s2>&#34;istio-proxy_productpage&#34;</span><span class=p>|</span>cut -d <span class=s2>&#34; &#34;</span> -f1<span class=sb>`</span>
UID                 PID                 PPID                C                   STIME               TTY                 TIME                CMD
<span class=m>1337</span>                <span class=m>10576</span>               <span class=m>10517</span>               <span class=m>0</span>                   08:09               ?                   00:00:07            /usr/local/bin/pilot-agent proxy sidecar --domain default.svc.cluster.local --configPath /etc/istio/proxy --binaryPath /usr/local/bin/envoy --serviceCluster productpage.default --drainDuration 45s --parentShutdownDuration 1m0s --discoveryAddress istiod.istio-system.svc:15012 --zipkinAddress zipkin.istio-system:9411 --proxyLogLevel<span class=o>=</span>warning --proxyComponentLogLevel<span class=o>=</span>misc:error --connectTimeout 10s --proxyAdminPort <span class=m>15000</span> --concurrency <span class=m>2</span> --controlPlaneAuthPolicy NONE --dnsRefreshRate 300s --statusPort <span class=m>15020</span> --trust-domain<span class=o>=</span>cluster.local --controlPlaneBootstrap<span class=o>=</span><span class=nb>false</span>
<span class=m>1337</span>                <span class=m>10660</span>               <span class=m>10576</span>               <span class=m>0</span>                   08:09               ?                   00:00:33            /usr/local/bin/envoy -c /etc/istio/proxy/envoy-rev0.json --restart-epoch <span class=m>0</span> --drain-time-s <span class=m>45</span> --parent-shutdown-time-s <span class=m>60</span> --service-cluster productpage.default --service-node sidecar~172.17.0.16~productpage-v1-7f44c4d57c-ksf9b.default~default.svc.cluster.local --max-obj-name-len <span class=m>189</span> --local-address-ip-version v4 --log-format <span class=o>[</span>Envoy <span class=o>(</span>Epoch 0<span class=o>)]</span> <span class=o>[</span>%Y-%m-%d %T.%e<span class=o>][</span>%t<span class=o>][</span>%l<span class=o>][</span>%n<span class=o>]</span> %v -l warning --component-log-level misc:error --concurrency <span class=m>2</span>

<span class=c1># 使用 nsenter 进入 sidecar 容器的命名空间（以上任何一个都可以）</span>
$ nsenter -n --target <span class=m>10660</span>

<span class=c1># 查看 NAT 表中规则配置的详细信息。</span>
$ iptables -t nat -L
</code></pre></td></tr></table></div></div><h3 id=在-gke-中查看容器的-iptables-规则>在 GKE 中查看容器的 iptables 规则</h3><p>如果你在 GKE 中安装的多节点的 Kubernetes 集群，首先你需要确定这个 Pod 运行在哪个节点上，然后登陆到那台主机，使用下面的命令查找进程的 PID，你会得到类似下面的输出。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>$ ps aux<span class=p>|</span>grep <span class=s2>&#34;productpage&#34;</span>
chronos     <span class=m>4268</span>  0.0  0.6  <span class=m>43796</span> <span class=m>24856</span> ?        Ss   Apr22   0:00 python productpage.py <span class=m>9080</span>
chronos     <span class=m>4329</span>  0.9  0.6 <span class=m>117524</span> <span class=m>24616</span> ?        Sl   Apr22  13:43 /usr/local/bin/python /opt/microservices/productpage.py <span class=m>9080</span>
root      <span class=m>361903</span>  0.0  0.0   <span class=m>4536</span>   <span class=m>812</span> pts/0    S+   01:54   0:00 grep --colour<span class=o>=</span>auto productpage
</code></pre></td></tr></table></div></div><p>然后在终端中输出 <code>iptables -t nat -L</code> 即可查看 iptables 规则。</p><h2 id=iptables-流量劫持过程详解>iptables 流量劫持过程详解</h2><p>经过上面的步骤，你已经可以查看到 init 容器向 Pod 中注入的 iptables 规则，如下所示。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash><span class=c1># PREROUTING 链：用于目标地址转换（DNAT），将所有入站 TCP 流量跳转到 ISTIO_INBOUND 链上。</span>
Chain PREROUTING <span class=o>(</span>policy ACCEPT <span class=m>2701</span> packets, 162K bytes<span class=o>)</span>
 pkts bytes target     prot opt in     out     <span class=nb>source</span>               destination
 <span class=m>2701</span>  162K ISTIO_INBOUND  tcp  --  any    any     anywhere             anywhere

<span class=c1># INPUT 链：处理输入数据包，非 TCP 流量将继续 OUTPUT 链。</span>
Chain INPUT <span class=o>(</span>policy ACCEPT <span class=m>2701</span> packets, 162K bytes<span class=o>)</span>
 pkts bytes target     prot opt in     out     <span class=nb>source</span>               destination

<span class=c1># OUTPUT 链：将所有出站数据包跳转到 ISTIO_OUTPUT 链上。</span>
Chain OUTPUT <span class=o>(</span>policy ACCEPT <span class=m>79</span> packets, <span class=m>6761</span> bytes<span class=o>)</span>
 pkts bytes target     prot opt in     out     <span class=nb>source</span>               destination
   <span class=m>15</span>   <span class=m>900</span> ISTIO_OUTPUT  tcp  --  any    any     anywhere             anywhere

<span class=c1># POSTROUTING 链：所有数据包流出网卡时都要先进入 POSTROUTING 链，内核根据数据包目的地判断是否需要转发出去，我们看到此处未做任何处理。</span>
Chain POSTROUTING <span class=o>(</span>policy ACCEPT <span class=m>79</span> packets, <span class=m>6761</span> bytes<span class=o>)</span>
 pkts bytes target     prot opt in     out     <span class=nb>source</span>               destination

<span class=c1># ISTIO_INBOUND 链：将所有入站流量重定向到 ISTIO_IN_REDIRECT 链上。目的地为 15090（Prometheus 使用）和 15020（Ingress gateway 使用，用于 Pilot 健康检查）端口的流量除外，发送到以上两个端口的流量将返回 iptables 规则链的调用点，即 PREROUTING 链的后继 POSTROUTING 后直接调用原始目的地。</span>
Chain ISTIO_INBOUND <span class=o>(</span><span class=m>1</span> references<span class=o>)</span>
 pkts bytes target     prot opt in     out     <span class=nb>source</span>               destination
    <span class=m>0</span>     <span class=m>0</span> RETURN     tcp  --  any    any     anywhere             anywhere             tcp dpt:ssh
    <span class=m>2</span>   <span class=m>120</span> RETURN     tcp  --  any    any     anywhere             anywhere             tcp dpt:15090
 <span class=m>2699</span>  162K RETURN     tcp  --  any    any     anywhere             anywhere             tcp dpt:15020
    <span class=m>0</span>     <span class=m>0</span> ISTIO_IN_REDIRECT  tcp  --  any    any     anywhere             anywhere

<span class=c1># ISTIO_IN_REDIRECT 链：将所有的入站流量跳转到本地的 15006 端口，至此成功的拦截了流量到 sidecar 代理的 Inbound Handler 中。</span>
Chain ISTIO_IN_REDIRECT <span class=o>(</span><span class=m>3</span> references<span class=o>)</span>
 pkts bytes target     prot opt in     out     <span class=nb>source</span>               destination
    <span class=m>0</span>     <span class=m>0</span> REDIRECT   tcp  --  any    any     anywhere             anywhere             redir ports <span class=m>15006</span>

<span class=c1># ISTIO_OUTPUT 链：规则比较复杂，将在下文解释</span>
Chain ISTIO_OUTPUT <span class=o>(</span><span class=m>1</span> references<span class=o>)</span>
 pkts bytes target     prot opt in     out     <span class=nb>source</span>               destination
    <span class=m>0</span>     <span class=m>0</span> RETURN     all  --  any    lo      127.0.0.6            anywhere <span class=c1>#规则1</span>
    <span class=m>0</span>     <span class=m>0</span> ISTIO_IN_REDIRECT  all  --  any    lo      anywhere            !localhost            owner UID match <span class=m>1337</span> <span class=c1>#规则2</span>
    <span class=m>0</span>     <span class=m>0</span> RETURN     all  --  any    lo      anywhere             anywhere             ! owner UID match <span class=m>1337</span> <span class=c1>#规则3</span>
   <span class=m>15</span>   <span class=m>900</span> RETURN     all  --  any    any     anywhere             anywhere             owner UID match <span class=m>1337</span> <span class=c1>#规则4</span>
    <span class=m>0</span>     <span class=m>0</span> ISTIO_IN_REDIRECT  all  --  any    lo      anywhere            !localhost            owner GID match <span class=m>1337</span> <span class=c1>#规则5</span>
    <span class=m>0</span>     <span class=m>0</span> RETURN     all  --  any    lo      anywhere             anywhere             ! owner GID match <span class=m>1337</span> <span class=c1>#规则6</span>
    <span class=m>0</span>     <span class=m>0</span> RETURN     all  --  any    any     anywhere             anywhere             owner GID match <span class=m>1337</span> <span class=c1>#规则7</span>
    <span class=m>0</span>     <span class=m>0</span> RETURN     all  --  any    any     anywhere             localhost <span class=c1>#规则8</span>
    <span class=m>0</span>     <span class=m>0</span> ISTIO_REDIRECT  all  --  any    any     anywhere             anywhere <span class=c1>#规则9</span>

<span class=c1># ISTIO_REDIRECT 链：将所有流量重定向到 Envoy 代理的 15001 端口。</span>
Chain ISTIO_REDIRECT <span class=o>(</span><span class=m>1</span> references<span class=o>)</span>
 pkts bytes target     prot opt in     out     <span class=nb>source</span>               destination
    <span class=m>0</span>     <span class=m>0</span> REDIRECT   tcp  --  any    any     anywhere             anywhere             redir ports <span class=m>15001</span>
</code></pre></td></tr></table></div></div><p>这里着重需要解释的是 <code>ISTIO_OUTPUT</code> 链中的 9 条规则，为了便于阅读，我将以上规则中的部分内容使用表格的形式来展示如下：</p><table><thead><tr><th><strong>规则</strong></th><th><strong>target</strong></th><th><strong>in</strong></th><th><strong>out</strong></th><th><strong>source</strong></th><th><strong>destination</strong></th></tr></thead><tbody><tr><td>1</td><td>RETURN</td><td>any</td><td>lo</td><td>127.0.0.6</td><td>anywhere</td></tr><tr><td>2</td><td>ISTIO_IN_REDIRECT</td><td>any</td><td>lo</td><td>anywhere</td><td>!localhost owner UID match 1337</td></tr><tr><td>3</td><td>RETURN</td><td>any</td><td>lo</td><td>anywhere</td><td>anywhere !owner UID match 1337</td></tr><tr><td>4</td><td>RETURN</td><td>any</td><td>any</td><td>anywhere</td><td>anywhere owner UID match 1337</td></tr><tr><td>5</td><td>ISTIO_IN_REDIRECT</td><td>any</td><td>lo</td><td>anywhere</td><td>!localhost owner GID match 1337</td></tr><tr><td>6</td><td>RETURN</td><td>any</td><td>lo</td><td>anywhere</td><td>anywhere !owner GID match 1337</td></tr><tr><td>7</td><td>RETURN</td><td>any</td><td>any</td><td>anywhere</td><td>anywhere owner GID match 1337</td></tr><tr><td>8</td><td>RETURN</td><td>any</td><td>any</td><td>anywhere</td><td>localhost</td></tr><tr><td>9</td><td>ISTIO_REDIRECT</td><td>any</td><td>any</td><td>anywhere</td><td>anywhere</td></tr></tbody></table><p>下图展示了 <code>ISTIO_ROUTE</code> 规则的详细流程。</p><p><img src=https://raw.githubusercontent.com/kbsonlong/notes_statics/master/images/20220913144557.png alt></p><p>我将按照规则的出现顺序来解释每条规则的目的、对应文章开头图示中的步骤及详情。其中规则 5、6、7 是分别对规则 2、3、4 的应用范围扩大（从 UID 扩大为 GID），作用是类似的，将合并解释。注意，其中的规则是按顺序执行的，也就是说排序越靠后的规则将作为默认值。出站网卡（out）为 <code>lo</code> （本地回环地址，loopback 接口）时，表示流量的目的地是本地 Pod，对于 Pod 向外部发送的流量就不会经过这个接口。所有 <code>review</code> Pod 的出站流量只适用于规则 4、7、8、9。</p><p><strong>规则 1</strong></p><ul><li>目的：<strong>透传</strong> Envoy 代理发送到本地应用容器的流量，使其绕过 Envoy 代理，直达应用容器。</li><li>对应图示中的步骤：6 到 7。</li><li>详情：该规则使得所有来自 <code>127.0.0.6</code>（该 IP 地址将在下文解释） 的请求，跳出该链，返回 iptables 的调用点（即 <code>OUTPUT</code>）后继续执行其余路由规则，即 <code>POSTROUTING</code> 规则，把流量发送到任意目的地址，如本地 Pod 内的应用容器。如果没有这条规则，由 Pod 内 Envoy 代理发出的对 Pod 内容器访问的流量将会执行下一条规则，即规则 2，流量将再次进入到了 Inbound Handler 中，从而形成了死循环。将这条规则放在第一位可以避免流量在 Inbound Handler 中死循环的问题。</li></ul><p><strong>规则 2、5</strong></p><ul><li>目的：处理 Envoy 代理发出的站内流量（Pod 内部的流量），但不是对 localhost 的请求，通过后续规则将其转发给 Envoy 代理的 Inbound Handler。该规则适用于 Pod 对自身 IP 地址调用的场景，即 Pod 内服务之间的访问。</li><li>详情：如果流量的目的地非 localhost，且数据包是由 1337 UID（即 <code>istio-proxy</code> 用户，Envoy 代理）发出的，流量将被经过 <code>ISTIO_IN_REDIRECT</code> 最终转发到 Envoy 的 Inbound Handler。</li></ul><p><strong>规则 3、6</strong></p><ul><li>目的：<strong>透传</strong> Pod 内的应用容器的站内流量。该规则适用于容器内部的流量。例如在 Pod 内对 Pod IP 或 localhost 的访问。</li><li>对应图示中的步骤：6 到 7。</li><li>详情：如果流量不是由 Envoy 用户发出的，那么就跳出该链，返回 <code>OUTPUT</code> 调用 <code>POSTROUTING</code>，直达目的地。</li></ul><p><strong>规则 4、7</strong></p><ul><li>目的：<strong>透传</strong> Envoy 代理发出的出站请求。</li><li>对应图示中的步骤：14 到 15。</li><li>详情：如果请求是由 Envoy 代理发出的，则返回 <code>OUTPUT</code> 继续调用 <code>POSTROUTING</code> 规则，最终直接访问目的地。</li></ul><p><strong>规则 8</strong></p><ul><li>目的：<strong>透传</strong> Pod 内部对 localhost 的请求。</li><li>详情：如果请求的目的地是 localhost，则返回 OUTPUT 调用 <code>POSTROUTING</code>，直接访问 localhost。</li></ul><p><strong>规则 9</strong></p><ul><li>目的：所有其他的流量将被转发到 <code>ISTIO_REDIRECT</code> 后，最终达到 Envoy 代理的 Outbound Handler。</li><li>对应图示中的步骤：10 到 11。</li></ul><p>以上规则避免了 Envoy 代理到应用程序的路由在 iptables 规则中的死循环，保障了流量可以被正确的路由到 Envoy 代理上，也可以发出真正的出站请求。</p><p><strong>关于 RETURN target</strong></p><p>你可能留意到上述规则中有很多 RETURN target，它的意思是，指定到这条规则时，跳出该规则链，返回 iptables 的调用点（在我们的例子中即 <code>OUTPUT</code>）后继续执行其余路由规则，在我们的例子中即 <code>POSTROUTING</code> 规则，把流量发送到任意目的地址，你可以把它直观的理解为<strong>透传</strong>。</p><p><strong>关于 127.0.0.6 IP 地址</strong></p><p>127.0.0.6 这个 IP 是 Istio 中默认的 <code>InboundPassthroughClusterIpv4</code>，在 Istio 的代码中指定。即流量在进入 Envoy 代理后被绑定的 IP 地址，作用是让 Outbound 流量重新发送到 Pod 中的应用容器，即 <strong>Passthought（透传），绕过 Outbound Handler</strong>。该流量是对 Pod 自身的访问，而不是真正的对外流量。至于为什么选择这个 IP 作为流量透传，请参考 <a href=https://github.com/istio/istio/issues/29603>Istio Issue-29603</a>。</p><h2 id=流量路由过程详解>流量路由过程详解</h2><p>通过上文，你已经了解了 Istio 是如何在 Pod 中做透明流量劫持的，那么流量被劫持到 Envoy 代理中之后是如何被处理的呢？流量路由分为 Inbound 和 Outbound 两个过程，下面将根据上文中的示例及 sidecar 的配置为读者详细分析此过程。</p><h3 id=理解-inbound-handler>理解 Inbound Handler</h3><p>Inbound Handler 的作用是将 iptables 拦截到的 downstream 的流量转发给 Pod 内的应用程序容器。在我们的实例中，假设其中一个 Pod 的名字是 <code>reviews-v1-545db77b95-jkgv2</code>，运行 <code>istioctl proxy-config listener reviews-v1-545db77b95-jkgv2 --port 15006</code> 查看该 Pod 中 15006 端口上的监听器情况 ，你将看到下面的输出。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-ini data-lang=ini><span class=na>ADDRESS PORT  MATCH                                                                                           DESTINATION</span>
<span class=na>0.0.0.0 15006 Addr: *:15006                                                                                   Non-HTTP/Non-TCP</span>
<span class=na>0.0.0.0 15006 Trans: tls; App: istio-http/1.0,istio-http/1.1,istio-h2; Addr: 0.0.0.0/0                        InboundPassthroughClusterIpv4</span>
<span class=na>0.0.0.0 15006 Trans: raw_buffer; App: http/1.1,h2c; Addr: 0.0.0.0/0                                           InboundPassthroughClusterIpv4</span>
<span class=na>0.0.0.0 15006 Trans: tls; App: TCP TLS; Addr: 0.0.0.0/0                                                       InboundPassthroughClusterIpv4</span>
<span class=na>0.0.0.0 15006 Trans: raw_buffer; Addr: 0.0.0.0/0                                                              InboundPassthroughClusterIpv4</span>
<span class=na>0.0.0.0 15006 Trans: tls; Addr: 0.0.0.0/0                                                                     InboundPassthroughClusterIpv4</span>
<span class=na>0.0.0.0 15006 Trans: tls; App: istio,istio-peer-exchange,istio-http/1.0,istio-http/1.1,istio-h2; Addr: *:9080 Cluster: inbound|9080||</span>
<span class=na>0.0.0.0 15006 Trans: raw_buffer; Addr: *:9080                                                                 Cluster: inbound|9080||</span>
</code></pre></td></tr></table></div></div><p>下面列出了以上输出中各字段的含义：</p><ul><li>ADDRESS：下游地址</li><li>PORT：Envoy 监听器监听的端口</li><li>MATCH：请求使用的传输协议或匹配的下游地址</li><li>DESTINATION：路由目的地</li></ul><p><code>reviews</code> Pod 中的 Iptables 将入站流量劫持到 15006 端口上，从上面的输出我们可以看到 Envoy 的 Inbound Handler 在 15006 端口上监听，对目的地为任何 IP 的 9080 端口的请求将路由到 <code>inbound|9080||</code> Cluster 上。</p><p>从该 Pod 的 Listener 列表的最后两行中可以看到，<code>0.0.0.0:15006/TCP</code> 的 Listener（其实际名字是 <code>virtualInbound</code>）监听所有的 Inbound 流量，其中包含了匹配规则，来自任意 IP 的对 <code>9080</code> 端口的访问流量，将会路由到 <code>inbound|9080||</code> Cluster，如果你想以 Json 格式查看该 Listener 的详细配置，可以执行 <code>istioctl proxy-config listeners reviews-v1-545db77b95-jkgv2 --port 15006 -o json</code> 命令，你将获得类似下面的输出。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-json data-lang=json><span class=p>[</span>
    <span class=err>/*省略部分内容*/</span>
    <span class=p>{</span>
        <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;virtualInbound&#34;</span><span class=p>,</span>
        <span class=nt>&#34;address&#34;</span><span class=p>:</span> <span class=p>{</span>
            <span class=nt>&#34;socketAddress&#34;</span><span class=p>:</span> <span class=p>{</span>
                <span class=nt>&#34;address&#34;</span><span class=p>:</span> <span class=s2>&#34;0.0.0.0&#34;</span><span class=p>,</span>
                <span class=nt>&#34;portValue&#34;</span><span class=p>:</span> <span class=mi>15006</span>
            <span class=p>}</span>
        <span class=p>},</span>
        <span class=nt>&#34;filterChains&#34;</span><span class=p>:</span> <span class=p>[</span>
            <span class=err>/*省略部分内容*/</span>
            <span class=p>{</span>
                <span class=nt>&#34;filterChainMatch&#34;</span><span class=p>:</span> <span class=p>{</span>
                    <span class=nt>&#34;destinationPort&#34;</span><span class=p>:</span> <span class=mi>9080</span><span class=p>,</span>
                    <span class=nt>&#34;transportProtocol&#34;</span><span class=p>:</span> <span class=s2>&#34;tls&#34;</span><span class=p>,</span>
                    <span class=nt>&#34;applicationProtocols&#34;</span><span class=p>:</span> <span class=p>[</span>
                        <span class=s2>&#34;istio&#34;</span><span class=p>,</span>
                        <span class=s2>&#34;istio-peer-exchange&#34;</span><span class=p>,</span>
                        <span class=s2>&#34;istio-http/1.0&#34;</span><span class=p>,</span>
                        <span class=s2>&#34;istio-http/1.1&#34;</span><span class=p>,</span>
                        <span class=s2>&#34;istio-h2&#34;</span>
                    <span class=p>]</span>
                <span class=p>},</span>
                <span class=nt>&#34;filters&#34;</span><span class=p>:</span> <span class=p>[</span>
                    <span class=err>/*省略部分内容*/</span>
                    <span class=p>{</span>
                        <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;envoy.filters.network.http_connection_manager&#34;</span><span class=p>,</span>
                        <span class=nt>&#34;typedConfig&#34;</span><span class=p>:</span> <span class=p>{</span>
                            <span class=nt>&#34;@type&#34;</span><span class=p>:</span> <span class=s2>&#34;type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager&#34;</span><span class=p>,</span>
                            <span class=nt>&#34;statPrefix&#34;</span><span class=p>:</span> <span class=s2>&#34;inbound_0.0.0.0_9080&#34;</span><span class=p>,</span>
                            <span class=nt>&#34;routeConfig&#34;</span><span class=p>:</span> <span class=p>{</span>
                                <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;inbound|9080||&#34;</span><span class=p>,</span>
                                <span class=nt>&#34;virtualHosts&#34;</span><span class=p>:</span> <span class=p>[</span>
                                    <span class=p>{</span>
                                        <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;inbound|http|9080&#34;</span><span class=p>,</span>
                                        <span class=nt>&#34;domains&#34;</span><span class=p>:</span> <span class=p>[</span>
                                            <span class=s2>&#34;*&#34;</span>
                                        <span class=p>],</span>
                                        <span class=nt>&#34;routes&#34;</span><span class=p>:</span> <span class=p>[</span>
                                            <span class=p>{</span>
                                                <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;default&#34;</span><span class=p>,</span>
                                                <span class=nt>&#34;match&#34;</span><span class=p>:</span> <span class=p>{</span>
                                                    <span class=nt>&#34;prefix&#34;</span><span class=p>:</span> <span class=s2>&#34;/&#34;</span>
                                                <span class=p>},</span>
                                                <span class=nt>&#34;route&#34;</span><span class=p>:</span> <span class=p>{</span>
                                                    <span class=nt>&#34;cluster&#34;</span><span class=p>:</span> <span class=s2>&#34;inbound|9080||&#34;</span><span class=p>,</span>
                                                    <span class=nt>&#34;timeout&#34;</span><span class=p>:</span> <span class=s2>&#34;0s&#34;</span><span class=p>,</span>
                                                    <span class=nt>&#34;maxStreamDuration&#34;</span><span class=p>:</span> <span class=p>{</span>
                                                        <span class=nt>&#34;maxStreamDuration&#34;</span><span class=p>:</span> <span class=s2>&#34;0s&#34;</span><span class=p>,</span>
                                                        <span class=nt>&#34;grpcTimeoutHeaderMax&#34;</span><span class=p>:</span> <span class=s2>&#34;0s&#34;</span>
                                                    <span class=p>}</span>
                                                <span class=p>},</span>
                                                <span class=nt>&#34;decorator&#34;</span><span class=p>:</span> <span class=p>{</span>
                                                    <span class=nt>&#34;operation&#34;</span><span class=p>:</span> <span class=s2>&#34;reviews.default.svc.cluster.local:9080/*&#34;</span>
                                                <span class=p>}</span>
                                            <span class=p>}</span>
                                        <span class=p>]</span>
                                    <span class=p>}</span>
                                <span class=p>],</span>
                                <span class=nt>&#34;validateClusters&#34;</span><span class=p>:</span> <span class=kc>false</span>
                            <span class=p>},</span>
                            <span class=err>/*省略部分内容*/</span>
                        <span class=p>}</span>
                    <span class=p>}</span>
                <span class=p>],</span>
            <span class=err>/*省略部分内容*/</span>
        <span class=err>],</span>
        <span class=nt>&#34;listenerFilters&#34;</span><span class=p>:</span> <span class=p>[</span>
        <span class=err>/*省略部分内容*/</span>
        <span class=p>],</span>
        <span class=nt>&#34;listenerFiltersTimeout&#34;</span><span class=p>:</span> <span class=s2>&#34;0s&#34;</span><span class=p>,</span>
        <span class=nt>&#34;continueOnListenerFiltersTimeout&#34;</span><span class=p>:</span> <span class=kc>true</span><span class=p>,</span>
        <span class=nt>&#34;trafficDirection&#34;</span><span class=p>:</span> <span class=s2>&#34;INBOUND&#34;</span>
    <span class=p>}</span>
<span class=p>]</span>
</code></pre></td></tr></table></div></div><p>既然 Inbound Handler 的流量中将来自任意地址的对该 Pod <code>9080</code> 端口的流量路由到 <code>inbound|9080||</code> Cluster，那么我们运行 <code>istioctl pc cluster reviews-v1-545db77b95-jkgv2 --port 9080 --direction inbound -o json</code> 查看下该 Cluster 配置，你将获得类似下面的输出。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-json data-lang=json><span class=p>[</span>
    <span class=p>{</span>
        <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;inbound|9080||&#34;</span><span class=p>,</span>
        <span class=nt>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;ORIGINAL_DST&#34;</span><span class=p>,</span>
        <span class=nt>&#34;connectTimeout&#34;</span><span class=p>:</span> <span class=s2>&#34;10s&#34;</span><span class=p>,</span>
        <span class=nt>&#34;lbPolicy&#34;</span><span class=p>:</span> <span class=s2>&#34;CLUSTER_PROVIDED&#34;</span><span class=p>,</span>
        <span class=nt>&#34;circuitBreakers&#34;</span><span class=p>:</span> <span class=p>{</span>
            <span class=nt>&#34;thresholds&#34;</span><span class=p>:</span> <span class=p>[</span>
                <span class=p>{</span>
                    <span class=nt>&#34;maxConnections&#34;</span><span class=p>:</span> <span class=mi>4294967295</span><span class=p>,</span>
                    <span class=nt>&#34;maxPendingRequests&#34;</span><span class=p>:</span> <span class=mi>4294967295</span><span class=p>,</span>
                    <span class=nt>&#34;maxRequests&#34;</span><span class=p>:</span> <span class=mi>4294967295</span><span class=p>,</span>
                    <span class=nt>&#34;maxRetries&#34;</span><span class=p>:</span> <span class=mi>4294967295</span><span class=p>,</span>
                    <span class=nt>&#34;trackRemaining&#34;</span><span class=p>:</span> <span class=kc>true</span>
                <span class=p>}</span>
            <span class=p>]</span>
        <span class=p>},</span>
        <span class=nt>&#34;cleanupInterval&#34;</span><span class=p>:</span> <span class=s2>&#34;60s&#34;</span><span class=p>,</span>
        <span class=nt>&#34;upstreamBindConfig&#34;</span><span class=p>:</span> <span class=p>{</span>
            <span class=nt>&#34;sourceAddress&#34;</span><span class=p>:</span> <span class=p>{</span>
                <span class=nt>&#34;address&#34;</span><span class=p>:</span> <span class=s2>&#34;127.0.0.6&#34;</span><span class=p>,</span>
                <span class=nt>&#34;portValue&#34;</span><span class=p>:</span> <span class=mi>0</span>
            <span class=p>}</span>
        <span class=p>},</span>
        <span class=nt>&#34;metadata&#34;</span><span class=p>:</span> <span class=p>{</span>
            <span class=nt>&#34;filterMetadata&#34;</span><span class=p>:</span> <span class=p>{</span>
                <span class=nt>&#34;istio&#34;</span><span class=p>:</span> <span class=p>{</span>
                    <span class=nt>&#34;services&#34;</span><span class=p>:</span> <span class=p>[</span>
                        <span class=p>{</span>
                            <span class=nt>&#34;host&#34;</span><span class=p>:</span> <span class=s2>&#34;reviews.default.svc.cluster.local&#34;</span><span class=p>,</span>
                            <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;reviews&#34;</span><span class=p>,</span>
                            <span class=nt>&#34;namespace&#34;</span><span class=p>:</span> <span class=s2>&#34;default&#34;</span>
                        <span class=p>}</span>
                    <span class=p>]</span>
                <span class=p>}</span>
            <span class=p>}</span>
        <span class=p>}</span>
    <span class=p>}</span>
<span class=p>]</span>
</code></pre></td></tr></table></div></div><p>我们看其中的 <code>TYPE</code> 为 <code>ORIGINAL_DST</code>，将流量发送到原始目标地址（Pod IP），因为原始目标地址即当前 Pod，你还应该注意到 <code>upstreamBindConfig.sourceAddress.address</code> 的值被改写为了 <code>127.0.0.6</code>，而且对于 Pod 内流量是通过 <code>lo</code> 网卡发送的，这刚好呼应了上文中的 iptables <code>ISTIO_OUTPUT</code> 链中的第一条规则，根据该规则，流量将被透传到 Pod 内的应用容器。</p><h3 id=理解-outbound-handler>理解 Outbound Handler</h3><p>在本示例中 <code>reviews</code> 会向 <code>ratings</code> 服务发送 HTTP 请求，请求的地址是：<code>http://ratings.default.svc.cluster.local:9080/</code>，Outbound Handler 的作用是将 iptables 拦截到的本地应用程序向外发出的流量，经由 Envoy 代理路由到上游。</p><p>Envoy 监听在 15001 端口上监听所有 Outbound 流量，Outbound Handler 处理，然后经过 <code>virtualOutbound</code> Listener、<code>0.0.0.0_9080</code> Listener，然后通过 Route 9080 找到上游的 cluster，进而通过 EDS 找到 Endpoint 执行路由动作。</p><p><strong><code>ratings.default.svc.cluster.local:9080</code> 路由</strong></p><p>运行 <code>istioctl proxy-config routes reviews-v1-545db77b95-jkgv2 --name 9080 -o json</code> 查看 route 配置，因为 sidecar 会根据 HTTP header 中的 domains 来匹配 VirtualHost，所以下面只列举了 <code>ratings.default.svc.cluster.local:9080</code> 这一个 VirtualHost。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-json data-lang=json><span class=p>[</span>
  <span class=p>{</span>
    <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;9080&#34;</span><span class=p>,</span>
    <span class=nt>&#34;virtualHosts&#34;</span><span class=p>:</span> <span class=p>[</span>
       <span class=p>{</span>
           <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;ratings.default.svc.cluster.local:9080&#34;</span><span class=p>,</span>
           <span class=nt>&#34;domains&#34;</span><span class=p>:</span> <span class=p>[</span>
               <span class=s2>&#34;ratings.default.svc.cluster.local&#34;</span><span class=p>,</span>
               <span class=s2>&#34;ratings.default.svc.cluster.local:9080&#34;</span><span class=p>,</span>
               <span class=s2>&#34;ratings&#34;</span><span class=p>,</span>
               <span class=s2>&#34;ratings:9080&#34;</span><span class=p>,</span>
               <span class=s2>&#34;ratings.default.svc&#34;</span><span class=p>,</span>
               <span class=s2>&#34;ratings.default.svc:9080&#34;</span><span class=p>,</span>
               <span class=s2>&#34;ratings.default&#34;</span><span class=p>,</span>
               <span class=s2>&#34;ratings.default:9080&#34;</span><span class=p>,</span>
               <span class=s2>&#34;10.8.8.106&#34;</span><span class=p>,</span>
               <span class=s2>&#34;10.8.8.106:9080&#34;</span>
           <span class=p>],</span>
           <span class=nt>&#34;routes&#34;</span><span class=p>:</span> <span class=p>[</span>
               <span class=p>{</span>
                   <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;default&#34;</span><span class=p>,</span>
                   <span class=nt>&#34;match&#34;</span><span class=p>:</span> <span class=p>{</span>
                       <span class=nt>&#34;prefix&#34;</span><span class=p>:</span> <span class=s2>&#34;/&#34;</span>
                   <span class=p>},</span>
                   <span class=nt>&#34;route&#34;</span><span class=p>:</span> <span class=p>{</span>
                       <span class=nt>&#34;cluster&#34;</span><span class=p>:</span> <span class=s2>&#34;outbound|9080||ratings.default.svc.cluster.local&#34;</span><span class=p>,</span>
                       <span class=nt>&#34;timeout&#34;</span><span class=p>:</span> <span class=s2>&#34;0s&#34;</span><span class=p>,</span>
                       <span class=nt>&#34;retryPolicy&#34;</span><span class=p>:</span> <span class=p>{</span>
                           <span class=nt>&#34;retryOn&#34;</span><span class=p>:</span> <span class=s2>&#34;connect-failure,refused-stream,unavailable,cancelled,retriable-status-codes&#34;</span><span class=p>,</span>
                           <span class=nt>&#34;numRetries&#34;</span><span class=p>:</span> <span class=mi>2</span><span class=p>,</span>
                           <span class=nt>&#34;retryHostPredicate&#34;</span><span class=p>:</span> <span class=p>[</span>
                               <span class=p>{</span>
                                   <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;envoy.retry_host_predicates.previous_hosts&#34;</span>
                               <span class=p>}</span>
                           <span class=p>],</span>
                           <span class=nt>&#34;hostSelectionRetryMaxAttempts&#34;</span><span class=p>:</span> <span class=s2>&#34;5&#34;</span><span class=p>,</span>
                           <span class=nt>&#34;retriableStatusCodes&#34;</span><span class=p>:</span> <span class=p>[</span>
                               <span class=mi>503</span>
                           <span class=p>]</span>
                       <span class=p>},</span>
                       <span class=nt>&#34;maxStreamDuration&#34;</span><span class=p>:</span> <span class=p>{</span>
                           <span class=nt>&#34;maxStreamDuration&#34;</span><span class=p>:</span> <span class=s2>&#34;0s&#34;</span><span class=p>,</span>
                           <span class=nt>&#34;grpcTimeoutHeaderMax&#34;</span><span class=p>:</span> <span class=s2>&#34;0s&#34;</span>
                       <span class=p>}</span>
                   <span class=p>},</span>
                   <span class=nt>&#34;decorator&#34;</span><span class=p>:</span> <span class=p>{</span>
                       <span class=nt>&#34;operation&#34;</span><span class=p>:</span> <span class=s2>&#34;ratings.default.svc.cluster.local:9080/*&#34;</span>
                   <span class=p>}</span>
               <span class=p>}</span>
           <span class=p>],</span>
           <span class=nt>&#34;includeRequestAttemptCount&#34;</span><span class=p>:</span> <span class=kc>true</span>
       <span class=p>},</span>
       <span class=err>/*省略部分内容*/</span>
     <span class=p>],</span>
     <span class=nt>&#34;validateClusters&#34;</span><span class=p>:</span> <span class=kc>false</span>
    <span class=p>}</span>
<span class=p>]</span>
</code></pre></td></tr></table></div></div><p>从该 Virtual Host 配置中可以看到将流量路由到<code>outbound|9080||ratings.default.svc.cluster.local</code> 集群。</p><p><strong><code>outbound|9080||ratings.default.svc.cluster.local</code> 集群的端点</strong></p><p>运行 <code>istioctl proxy-config endpoint reviews-v1-545db77b95-jkgv2 --port 9080 -o json --cluster "outbound|9080||ratings.default.svc.cluster.local"</code> 查看集群的 Endpoint 配置，结果如下。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-json data-lang=json><span class=p>[</span>
    <span class=p>{</span>
        <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;outbound|9080||ratings.default.svc.cluster.local&#34;</span><span class=p>,</span>
        <span class=nt>&#34;addedViaApi&#34;</span><span class=p>:</span> <span class=kc>true</span><span class=p>,</span>
        <span class=nt>&#34;hostStatuses&#34;</span><span class=p>:</span> <span class=p>[</span>
            <span class=p>{</span>
                <span class=nt>&#34;address&#34;</span><span class=p>:</span> <span class=p>{</span>
                    <span class=nt>&#34;socketAddress&#34;</span><span class=p>:</span> <span class=p>{</span>
                        <span class=nt>&#34;address&#34;</span><span class=p>:</span> <span class=s2>&#34;10.4.1.12&#34;</span><span class=p>,</span>
                        <span class=nt>&#34;portValue&#34;</span><span class=p>:</span> <span class=mi>9080</span>
                    <span class=p>}</span>
                <span class=p>},</span>
                <span class=nt>&#34;stats&#34;</span><span class=p>:</span> <span class=p>[</span>
                    <span class=p>{</span>
                        <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;cx_connect_fail&#34;</span>
                    <span class=p>},</span>
                    <span class=p>{</span>
                        <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;cx_total&#34;</span>
                    <span class=p>},</span>
                    <span class=p>{</span>
                        <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;rq_error&#34;</span>
                    <span class=p>},</span>
                    <span class=p>{</span>
                        <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;rq_success&#34;</span>
                    <span class=p>},</span>
                    <span class=p>{</span>
                        <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;rq_timeout&#34;</span>
                    <span class=p>},</span>
                    <span class=p>{</span>
                        <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;rq_total&#34;</span>
                    <span class=p>},</span>
                    <span class=p>{</span>
                        <span class=nt>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;GAUGE&#34;</span><span class=p>,</span>
                        <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;cx_active&#34;</span>
                    <span class=p>},</span>
                    <span class=p>{</span>
                        <span class=nt>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;GAUGE&#34;</span><span class=p>,</span>
                        <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;rq_active&#34;</span>
                    <span class=p>}</span>
                <span class=p>],</span>
                <span class=nt>&#34;healthStatus&#34;</span><span class=p>:</span> <span class=p>{</span>
                    <span class=nt>&#34;edsHealthStatus&#34;</span><span class=p>:</span> <span class=s2>&#34;HEALTHY&#34;</span>
                <span class=p>},</span>
                <span class=nt>&#34;weight&#34;</span><span class=p>:</span> <span class=mi>1</span><span class=p>,</span>
                <span class=nt>&#34;locality&#34;</span><span class=p>:</span> <span class=p>{</span>
                    <span class=nt>&#34;region&#34;</span><span class=p>:</span> <span class=s2>&#34;us-west2&#34;</span><span class=p>,</span>
                    <span class=nt>&#34;zone&#34;</span><span class=p>:</span> <span class=s2>&#34;us-west2-a&#34;</span>
                <span class=p>}</span>
            <span class=p>}</span>
        <span class=p>],</span>
        <span class=nt>&#34;circuitBreakers&#34;</span><span class=p>:</span> <span class=p>{</span>
            <span class=nt>&#34;thresholds&#34;</span><span class=p>:</span> <span class=p>[</span>
                <span class=p>{</span>
                    <span class=nt>&#34;maxConnections&#34;</span><span class=p>:</span> <span class=mi>4294967295</span><span class=p>,</span>
                    <span class=nt>&#34;maxPendingRequests&#34;</span><span class=p>:</span> <span class=mi>4294967295</span><span class=p>,</span>
                    <span class=nt>&#34;maxRequests&#34;</span><span class=p>:</span> <span class=mi>4294967295</span><span class=p>,</span>
                    <span class=nt>&#34;maxRetries&#34;</span><span class=p>:</span> <span class=mi>4294967295</span>
                <span class=p>},</span>
                <span class=p>{</span>
                    <span class=nt>&#34;priority&#34;</span><span class=p>:</span> <span class=s2>&#34;HIGH&#34;</span><span class=p>,</span>
                    <span class=nt>&#34;maxConnections&#34;</span><span class=p>:</span> <span class=mi>1024</span><span class=p>,</span>
                    <span class=nt>&#34;maxPendingRequests&#34;</span><span class=p>:</span> <span class=mi>1024</span><span class=p>,</span>
                    <span class=nt>&#34;maxRequests&#34;</span><span class=p>:</span> <span class=mi>1024</span><span class=p>,</span>
                    <span class=nt>&#34;maxRetries&#34;</span><span class=p>:</span> <span class=mi>3</span>
                <span class=p>}</span>
            <span class=p>]</span>
        <span class=p>},</span>
        <span class=nt>&#34;observabilityName&#34;</span><span class=p>:</span> <span class=s2>&#34;outbound|9080||ratings.default.svc.cluster.local&#34;</span>
    <span class=p>}</span>
<span class=p>]</span>
</code></pre></td></tr></table></div></div><p>我们看到端点的地址是 <code>10.4.1.12</code>。实际上，Endpoint 可以是一个或多个，sidecar 将根据一定规则选择适当的 Endpoint 来路由。至此 <code>review</code> Pod找到了它上游服务 <code>rating</code> 的 Endpoint。</p><h2 id=小结>小结</h2><p>本文使用了 Istio 官方提供的 bookinfo 示例，按图索骥得带领读者了解了 sidecar 注入、iptables 透明流量劫持及 sidecar 中流量路由背后的实现细节。Sidecar 模式和流量透明劫持是 Istio 服务网格的特色和基础功能，理解该功能的背后过程及实现细节，将有助于大家理解 Service Mesh 的原理和 <a href=https://www.servicemesher.com/istio-handbook/>Istio Handbook</a> 后面章节中的内容，因此希望读者可以在自己的环境中从头来试验一遍以加深理解。</p><p>使用 iptables 做流量劫持只是 service mesh 的数据平面中做流量劫持的方式之一，还有更多的流量劫持方案，下面引用自 <a href=https://mosn.io/docs/products/structure/traffic-hijack/>云原生网络代理 MOSN 官网中给出的流量劫持</a>部分的描述。</p><h3 id=使用-iptables-做流量劫持时存在的问题>使用 iptables 做流量劫持时存在的问题</h3><p>目前 Istio 使用 iptables 实现透明劫持，主要存在以下三个问题：</p><ol><li>需要借助于 conntrack 模块实现连接跟踪，在连接数较多的情况下，会造成较大的消耗，同时可能会造成 track 表满的情况，为了避免这个问题，业内有关闭 conntrack 的做法。</li><li>iptables 属于常用模块，全局生效，不能显式的禁止相关联的修改，可管控性比较差。</li><li>iptables 重定向流量本质上是通过 loopback 交换数据，outbond 流量将两次穿越协议栈，在大并发场景下会损失转发性能。</li></ol><p>上述几个问题并非在所有场景中都存在，比方说某些场景下，连接数并不多，且 NAT 表未被使用到的情况下，iptables 是一个满足要求的简单方案。为了适配更加广泛的场景，透明劫持需要解决上述三个问题。</p><h3 id=透明劫持方案优化>透明劫持方案优化</h3><p>为了优化 Istio 中的透明流量劫持的性能，业界提出了以下方案。</p><p><strong>使用 Merbridge 开源项目利用 eBPF 劫持流量</strong></p><p><a href=https://github.com/merbridge/merbridge>Merbridge</a> 是由 DaoCloud 在 2022 年初开源的的一款利用 eBPF 加速 Istio 服务网格的插件。使用 Merbridge 可以在一定程度上优化数据平面的网络性能。</p><p>Merbridge 利用 eBPF 的 <code>sockops</code> 和 <code>redir</code> 能力，可以直接将数据包从 inbound socket 传输到 outbound socket。eBPF 提供了 <code>bpf_msg_redirect_hash</code> 函数可以直接转发应用程序的数据包。</p><p>详见 <a href=https://jimmysong.io/istio-handbook/ecosystem/merbridge.html>Istio 服务网格 —— 云原生应用网络构建指南</a>。</p><p><strong>使用 tproxy 处理 inbound 流量</strong></p><p>tproxy 可以用于 inbound 流量的重定向，且无需改变报文中的目的 IP/端口，不需要执行连接跟踪，不会出现 conntrack 模块创建大量连接的问题。受限于内核版本，tproxy 应用于 outbound 存在一定缺陷。目前 Istio 支持通过 tproxy 处理 inbound 流量。</p><p><strong>使用 hook connect 处理 outbound 流量</strong></p><p>为了适配更多应用场景，outbound 方向通过 hook connect 来实现，实现原理如下：</p><figure><img src=hook-connect.svg alt="hook-connect 原理示意图"width=50%><figcaption><h4>hook-connect 原理示意图</h4></figcaption></figure><p>无论采用哪种透明劫持方案，均需要解决获取真实目的 IP/端口的问题，使用 iptables 方案通过 getsockopt 方式获取，tproxy 可以直接读取目的地址，通过修改调用接口，hook connect 方案读取方式类似于 tproxy。</p><p>实现透明劫持后，在内核版本满足要求（4.16以上）的前提下，通过 sockmap 可以缩短报文穿越路径，进而改善 outbound 方向的转发性能。</p><h2 id=更新说明>更新说明</h2><p>下面是本文的几次更新说明。</p><p><strong>2020 年 4 月 27 日，第一版，基于 Istio 1.5</strong></p><p>本文的第一版，基于 Istio 1.5 创作，在此之前，我曾写过基于 Istio 1.1 版本的<a href=/blog/envoy-sidecar-injection-in-istio-service-mesh-deep-dive/>理解 Istio Service Mesh 中 Envoy 代理 Sidecar 注入及流量劫持</a>，为了更细致的理解 Istio 中透明流量劫持的全过程，专门创作本文。</p><p><strong>2022 年 1 月 17 日，第二版，基于 Istio 1.11</strong></p><p>本文第一版发布后，在社区里获得了比较大的反响，收到了很多读者的评论和留言。基于这些评论，我也发现了第一版中的很多错误，在加上 Istio 版本发布频繁，在近两年的时间内，Istio 已经作出了众多更新，其中不乏重大更新。因此笔者撰写了本文的第二版，修改了之前版本中的纰漏并根据时下 Istio 的最新版本更新了本文。</p><p>Istio 1.11 与 Istio 1.1 中的 sidecar 注入和流量劫持环节最大的变化是：</p><ul><li>iptables 改用命令行工具，不再使用 shell 脚本。</li><li>sidecar inbound 和 outbound 分别指定了端口，而之前是使用同一个端口（15001）。</li></ul><p><strong>2022 年 4 月 24，第三版，基于 Istio 1.13</strong></p><p>这个版本的文章主要是根据当时 Istio 的最新版本更新了文章的部分内容，并重新排版，增加更新说明。</p><p>Istio 1.13 相比 Istio 1.11 的变化是 <code>istioctl proxy-config</code> 命令的输出有了较大变化。</p><p><strong>2022 年 5 月 6 日，第四版，基于 Istio 1.13</strong></p><ul><li>修改了对 <code>ISTIO_ROUTE</code> iptables 规则 2、5 的解释</li><li>在示意图中增加了路径 16</li></ul><p><strong>2022 年 5 月 12 日，第五版，基于 Istio 1.13</strong></p><ul><li>将 iptables 说明和 sidecar 注入、init 容器部分独立成了两篇单独的博客，以缩减博客的篇幅，见 <a href=/blog/istio-pod-process-lifecycle/>Istio 数据平面 Pod 启动过程详解</a>和<a href=/blog/understanding-iptables/>理解 iptables</a>。</li></ul><h2 id=参考>参考</h2><ul><li><a href=https://jimmysong.io/blog/sidecar-injection-iptables-and-traffic-routing/>阅读原文</a></li><li><a href=https://istio.io/latest/docs/ops/diagnostic-tools/proxy-cmd/>Debugging Envoy and Istiod - istio.io</a></li><li><a href=https://istio.io/latest/zh/blog/2019/data-plane-setup/>揭开 Istio Sidecar 注入模型的神秘面纱 - istio.io</a></li><li><a href=https://mosn.io/docs/products/structure/traffic-hijack/>MOSN 作为 Sidecar 使用时的流量劫持方案 - mosn.io</a></li></ul></article><script defer src=/js/clipboard.min.1626706afc88d95ebe1173b553ec732c6dc82a576989315fdf5e7779af738a44.js></script><script defer src=/js/helper/prev.min.js></script><script defer src=/js/helper/prop.min.js></script><script>'use strict',document.addEventListener('DOMContentLoaded',function(){var a=!1,b=document.querySelectorAll('pre.chroma'),c=document.querySelectorAll('.language-code'),d=document.querySelectorAll('div.language-\\$'),e=document.querySelectorAll('div.language-\\>'),f=function(c){var k=c,b=c.textContent,j,g,h,i,d,f,e;if(b.length>15){if(!a){j=new ClipboardJS('.copy-to-clipboard',{text:function(a){var c=prev(a).querySelectorAll('code');return c.length>1?b=prev(a).querySelector('code[class^="language-"]').textContent:b=prev(a).querySelector('code').textContent,b.replace(/^\$\s/gm,'')}});j.on('success',function(a){a.clearSelection(),g=prop(a.trigger.parentNode,'tagName')=='PRE',a.trigger.setAttribute('aria-label','Copied to clipboard!'),a.trigger.classList.add('tooltipped'),a.trigger.classList.add('tooltipped-w')}),j.on('error',function(a){g=prop(a.trigger.parentNode,'tagName')=='PRE',a.trigger.setAttribute('aria-label',a.action.toString()),a.trigger.classList.add('tooltipped'),a.trigger.classList.add('tooltipped-w')}),a=!0}h=['language-mermaid','language-viz','language-wave','language-chart','language-msc','language-flowchart'],i=!1,d=k.getAttribute('class');for(f=0;f<h.length;f++)if(d&&d.startsWith(h[f])){i=!0;break}i||d&&(e=document.createElement('span'),e.setAttribute('class','copy-to-clipboard'),e.setAttribute('title','Copy to clipboard'),c.parentNode.parentNode.insertBefore(e,c.parentNode.nextElementSibling))}},g=function(b){var a=document.createElement('span');a.setAttribute('class','copy-to-clipboard'),a.setAttribute('title','Copy to clipboard'),b.parentNode.parentNode.insertBefore(a,b.parentNode.nextElementSibling)};b?b.forEach(function(a){a.querySelectorAll('code').forEach(function(a){f(a)})}):null,c?c.forEach(function(a){a.querySelectorAll('code').forEach(function(a){f(a)})}):null,d?d.forEach(function(a){a.querySelectorAll('code').forEach(function(a){g(a)})}):null,e?e.forEach(function(a){a.querySelectorAll('code').forEach(function(a){g(a)})}):null})</script><script>var langCodeElem,dollarCodeElem,gtCodeElem;'use strict';function wrap(a,b){a.parentNode.insertBefore(b,a),b.appendChild(a)}!function(){var a=document.querySelector('.single__contents');a?a.querySelectorAll('pre > code').forEach(function(b){var a=b.getAttribute('data-lang'),c=document.createElement('div'),e=null,d=null;a&&a.includes(':')?(e=a.split(':')[0],d=a.split(':')[1],c.className='language-'+e,c.setAttribute('data-lang',d),b.className='language-'+e,b.setAttribute('data-lang',d),b.setAttribute('id',d)):a||(c.setAttribute('data-lang','Code'),c.className='language-code'),(!a||d)&&wrap(b.parentNode,c)}):null}(),langCodeElem=document.querySelectorAll('.language-code'),langCodeElem?langCodeElem.forEach(function(b){var a=document.createElement('span');a.className='copy-to-clipboard',a.setAttribute('title','Copy to clipboard'),b.append(a)}):null,dollarCodeElem=document.querySelectorAll('div.language-\\$'),gtCodeElem=document.querySelectorAll('div.language-\\>'),dollarCodeElem?dollarCodeElem.forEach(function(a){var b=a.parentNode.parentNode?a.parentNode.parentNode.querySelectorAll('.lnt'):null;b?b.forEach(function(a){a.innerHTML='$<br/>'}):null}):null,gtCodeElem?gtCodeElem.forEach(function(a){var b=a.parentNode.parentNode?a.parentNode.parentNode.querySelectorAll('.lnt'):null;b?b.forEach(function(a){a.innerHTML='><br/>'}):null}):null</script><div class=donation><div class=donation__message>分享</div><div class=donation__icons><a href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fsreionet.github.io%2fposts%2fistio%2ffe0ba1%2f"title=Facebook aria-label="Facebook Share Button"class=donation__item target=_blank rel=noreferrer data-type=share><svg data-name="facebook" enable-background="new 0 0 24 24" viewBox="0 0 24 24" width="35" height="35" fill="currentcolor" xmlns="http://www.w3.org/2000/svg"><path d="m15.997 3.985h2.191V.169c-.378-.052-1.678-.169-3.192-.169-3.159.0-5.323 1.987-5.323 5.639V9H6.187v4.266h3.486V24h4.274V13.267h3.345l.531-4.266h-3.877V6.062c.001-1.233.333-2.077 2.051-2.077z"/></svg></a><a href="https://twitter.com/intent/tweet?text=Istio%20%e4%b8%ad%e7%9a%84%20Sidecar%20%e6%b3%a8%e5%85%a5%e3%80%81%e9%80%8f%e6%98%8e%e6%b5%81%e9%87%8f%e5%8a%ab%e6%8c%81%e5%8f%8a%e6%b5%81%e9%87%8f%e8%b7%af%e7%94%b1%e8%bf%87%e7%a8%8b%e8%af%a6%e8%a7%a3&url=https%3a%2f%2fsreionet.github.io%2fposts%2fistio%2ffe0ba1%2f&hashtags=istio%2c%e8%bd%ac%e8%bd%bd&via=kbsonlong"title=Twitter aria-label="Twitter Share Button"class=donation__item target=_blank rel=noreferrer data-type=share><svg data-name="twitter" enable-background="new 0 0 24 24" viewBox="0 0 24 24" width="35" height="35" fill="currentcolor" xmlns="http://www.w3.org/2000/svg"><path d="m21.534 7.113C22.51 6.42 23.331 5.555 24 4.559v-.001c-.893.391-1.843.651-2.835.777 1.02-.609 1.799-1.566 2.165-2.719-.951.567-2.001.967-3.12 1.191-.903-.962-2.19-1.557-3.594-1.557-2.724.0-4.917 2.211-4.917 4.921.0.39.033.765.114 1.122-4.09-.2-7.71-2.16-10.142-5.147-.424.737-.674 1.58-.674 2.487.0 1.704.877 3.214 2.186 4.089-.791-.015-1.566-.245-2.223-.606v.054c0 2.391 1.705 4.377 3.942 4.835-.401.11-.837.162-1.29.162-.315.0-.633-.018-.931-.084.637 1.948 2.447 3.381 4.597 3.428-1.674 1.309-3.8 2.098-6.101 2.098-.403.0-.79-.018-1.177-.067 2.18 1.405 4.762 2.208 7.548 2.208 8.683.0 14.342-7.244 13.986-14.637z"/></svg></a></div></div><div class=whoami__gutter></div><hr class="hr-slash whoami-hr"><section class=whoami><div class=whoami__image-wrapper><img data-src=/images/whoami/avatar.jpg src="data:image/svg+xml,%0A%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24'%3E%3Cpath fill='none' d='M0 0h24v24H0V0z'/%3E%3Cpath fill='%23aaa' d='M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-1 16H6c-.55 0-1-.45-1-1V6c0-.55.45-1 1-1h12c.55 0 1 .45 1 1v12c0 .55-.45 1-1 1zm-4.44-6.19l-2.35 3.02-1.56-1.88c-.2-.25-.58-.24-.78.01l-1.74 2.23c-.26.33-.02.81.39.81h8.98c.41 0 .65-.47.4-.8l-2.55-3.39c-.19-.26-.59-.26-.79 0z'/%3E%3C/svg%3E"alt=kbsonlong class="lazyload whoami__image"></div><div class=whoami__contents><div class=whoami__written-by>作者</div><div class=whoami__title>kbsonlong</div><div class=whoami__desc>SRE</div><div class=whoami__social><a href=mailto:kbsonlong@gmail.com title=email aria-label=email><svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><path fill="currentcolor" d="M20 4H4c-1.1.0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1.0 2-.9 2-2V6c0-1.1-.9-2-2-2zm-.4 4.25-7.07 4.42c-.32.2-.74.2-1.06.0L4.4 8.25c-.25-.16-.4-.43-.4-.72.0-.67.73-1.07 1.3-.72L12 11l6.7-4.19c.57-.35 1.3.05 1.3.72.0.29-.15.56-.4.72z"/></svg></a><a href=https://github.com/sreionet title=github aria-label=github><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="25" height="25" viewBox="0 0 24 24"><g id="surface3680"><path fill="currentcolor" d="M10.898438 2.101562c-4.597657.5-8.296876 4.199219-8.796876 8.699219-.5 4.699219 2.199219 8.898438 6.296876 10.5C8.699219 21.398438 9 21.199219 9 20.800781V19.199219S8.601562 19.300781 8.101562 19.300781c-1.402343.0-2-1.199219-2.101562-1.902343C5.898438 17 5.699219 16.699219 5.398438 16.398438 5.101562 16.300781 5 16.300781 5 16.199219 5 16 5.300781 16 5.398438 16 6 16 6.5 16.699219 6.699219 17c.5.800781000000001 1.101562 1 1.402343 1C8.5 18 8.800781 17.898438 9 17.800781 9.101562 17.101562 9.398438 16.398438 10 16c-2.300781-.5-4-1.800781-4-4 0-1.101562.5-2.199219 1.199219-3C7.101562 8.800781 7 8.300781 7 7.601562c0-.402343.0-1 .300781-1.601562.0.0 1.398438.0 2.800781 1.300781C10.601562 7.101562 11.300781 7 12 7s1.398438.101562 2 .300781C15.300781 6 16.800781 6 16.800781 6 17 6.601562 17 7.199219 17 7.601562 17 8.398438 16.898438 8.800781 16.800781 9 17.5 9.800781 18 10.800781 18 12c0 2.199219-1.699219 3.5-4 4 .601562.5 1 1.398438 1 2.300781v2.597657C15 21.199219 15.300781 21.5 15.699219 21.398438 19.398438 19.898438 22 16.300781 22 12.101562c0-6-5.101562-10.703124-11.101562-10zm0 0"/></g></svg></a></div></div></section><hr class="hr-slash whoami-hr"><section class=related><h1 class=related__title><hr class=hr-dots><div>相关内容</div><hr class=hr-dots></h1><ul class=related-ul><li><a href=/posts/istio/dc5625/ class=related__link>Istio 数据平面Pod启动过程详解</a></li><li><a href=/posts/istio/b7e1eb/ class=related__link>理解Iptable</a></li><li><a href=/posts/istio/dd0bd7/ class=related__link>深入Istio系列-Sidecar自动注入</a></li><li><a href=/posts/istio/bf667a/ class=related__link>Istio部署实战</a></li></ul></section><div class=grow></div><nav class=pagination-single><a href=https://sreionet.github.io/posts/istio/dd0bd7/ class=pagination-single__left><div class=pagination-single__icon><svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><path fill="currentcolor" d="M19 11H7.83l4.88-4.88c.39-.39.39-1.03.0-1.42s-1.02-.39-1.41.0l-6.59 6.59c-.39.39-.39 1.02.0 1.41l6.59 6.59c.39.39 1.02.39 1.41.0s.39-1.02.0-1.41L7.83 13H19c.55.0 1-.45 1-1s-.45-1-1-1z"/></svg></div><div class=pagination-single__left-title>深入Istio系列-Sidecar自动注入</div></a><div class=grow></div><a href=https://sreionet.github.io/posts/istio/61aaaf/ class=pagination-single__right><div class=pagination-single__right-title>Sidecar 中的流量类型及 iptables 规则详解</div><div class=pagination-single__icon><svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><path fill="currentcolor" d="M5 13h11.17l-4.88 4.88c-.39.39-.39 1.03.0 1.42.39.39 1.02.39 1.41.0l6.59-6.59c.39-.39.39-1.02.0-1.41l-6.58-6.6c-.39-.39-1.02-.39-1.41.0s-.39 1.02.0 1.41L16.17 11H5c-.55.0-1 .45-1 1s.45 1 1 1z"/></svg></div></a></nav><div class="modal micromodal-slide"id=modal aria-hidden=true><div class=modal__overlay tabindex=-1 data-micromodal-close><div class=modal__container role=dialog aria-modal=true aria-labelledby=modal-title><div class=modal__content id=modal-content><div id=mySwipe class=swipe><div class=swipe-wrap></div></div></div><span class=modal__items><span class=modal__header><div class=modal__paging title="Page Info"aria-label="Current Page"></div><div class="modal__icon modal__toolbar modal__toolbar--close"title=Close aria-label="Close Button"data-micromodal-close><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 26 26" width="25" height="25"><path fill="currentcolor" d="M21.734375 19.640625l-2.097656 2.09375C19.253906 22.121094 18.628906 22.121094 18.242188 21.734375L13 16.496094 7.761719 21.734375C7.375 22.121094 6.746094 22.121094 6.363281 21.734375l-2.097656-2.09375c-.386719-.386718999999999-.386719-1.011719.0-1.398437L9.503906 13 4.265625 7.761719c-.382812-.390625-.382812-1.019531.0-1.398438L6.363281 4.265625C6.746094 3.878906 7.375 3.878906 7.761719 4.265625L13 9.507813l5.242188-5.242188c.386718000000002-.386719 1.015625-.386719 1.394531.0l2.097656 2.09375C22.121094 6.746094 22.121094 7.375 21.738281 7.761719L16.496094 13l5.238281 5.242188C22.121094 18.628906 22.121094 19.253906 21.734375 19.640625z"/></svg></div><div class="modal__icon modal__toolbar modal__toolbar--full"title="Full Screen"aria-label="Full Screen Button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="25" height="25"><path fill="currentcolor" d="M5 3C3.9069372 3 3 3.9069372 3 5V8A1.0001 1.0001.0 105 8V5H8A1.0001 1.0001.0 108 3H5zM16 3a1.0001 1.0001.0 100 2h3V8a1.0001 1.0001.0 102 0V5C21 3.9069372 20.093063 3 19 3H16zM3.984375 14.986328A1.0001 1.0001.0 003 16v3c0 1.093063.9069372 2 2 2H8a1.0001 1.0001.0 100-2H5V16A1.0001 1.0001.0 003.984375 14.986328zm16 0A1.0001 1.0001.0 0019 16v3H16a1.0001 1.0001.0 100 2h3C20.093063 21 21 20.093063 21 19V16a1.0001 1.0001.0 00-1.015625-1.013672z"/></svg></div><div class="modal__icon modal__toolbar modal__toolbar--normal"title="Normal Screen"aria-label="Normal Screen Button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" width="25" height="25"><path fill="currentcolor" d="M16.96875 4.972656C15.867188 4.988281 14.984375 5.894531 15 7v8H7C6.277344 14.988281 5.609375 15.367188 5.246094 15.992188 4.878906 16.613281 4.878906 17.386719 5.246094 18.007813 5.609375 18.632813 6.277344 19.011719 7 19H19V7C19.007813 6.460938 18.796875 5.941406 18.414063 5.558594 18.03125 5.175781 17.511719 4.964844 16.96875 4.972656zm16 0c-1.046875.015625-1.90625.839844-1.964844 1.886719C31 6.90625 31 6.953125 31 7V19H43C43.066406 19 43.132813 19 43.199219 18.992188 44.269531 18.894531 45.070313 17.972656 45.015625 16.902344 44.964844 15.828125 44.074219 14.988281 43 15H35V7C35.007813 6.460938 34.796875 5.941406 34.414063 5.558594 34.03125 5.175781 33.511719 4.964844 32.96875 4.972656zM7 31C6.277344 30.988281 5.609375 31.367188 5.246094 31.992188 4.878906 32.613281 4.878906 33.386719 5.246094 34.007813 5.609375 34.632813 6.277344 35.011719 7 35h8v8C14.988281 43.722656 15.367188 44.390625 15.992188 44.753906 16.613281 45.121094 17.386719 45.121094 18.007813 44.753906 18.632813 44.390625 19.011719 43.722656 19 43V31zm24 0V43C30.988281 43.722656 31.367188 44.390625 31.992188 44.753906 32.613281 45.121094 33.386719 45.121094 34.007813 44.753906 34.632813 44.390625 35.011719 43.722656 35 43V35h8C43.722656 35.011719 44.390625 34.632813 44.753906 34.007813 45.121094 33.386719 45.121094 32.613281 44.753906 31.992188 44.390625 31.367188 43.722656 30.988281 43 31z"/></svg></div></span><div class="modal__icon modal__arrow modal__arrow--left"title="Arrow Left"aria-label="Arrow Left Button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 26 26" width="28" height="28"><path fill="currentcolor" d="M23.28125 11 10 10V6.851563C10 6.523438 9.839844 6.277344 9.519531 6.03125 9.199219 5.949219 8.878906 5.949219 8.640625 6.113281c-3.28125 2.296875-6.402344 6.144532-6.480469 6.308594-.078125.15625-.152343.390625-.15625.554688000000001C2.003906 12.980469 2 12.988281 2 12.992188 2 13.15625 2.078125 13.402344 2.160156 13.484375 2.238281 13.648438 5.28125 17.507813 8.640625 19.804688 8.960938 19.96875 9.28125 20.050781 9.519531 19.886719 9.839844 19.722656 10 19.476563 10 19.148438V16l13.28125-1C23.679688 14.679688 24 13.875 24 12.992188 24 12.195313 23.761719 11.320313 23.28125 11z"/></svg></div><div class="modal__icon modal__arrow modal__arrow--right"title="Arrow Right"aria-label="Arrow Right Button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 26 26" width="28" height="28"><path fill="currentcolor" d="M2.71875 11.023438l13.28125-1V6.875C16 6.546875 16.160156 6.300781 16.480469 6.054688 16.800781 5.972656 17.121094 5.972656 17.359375 6.136719c3.28125 2.296875 6.402344 6.144531 6.480469 6.308594.078125.15625.152343999999999.390625.15625.554687C23.996094 13.003906 24 13.011719 24 13.015625 24 13.179688 23.921875 13.425781 23.839844 13.507813 23.761719 13.671875 20.71875 17.53125 17.359375 19.828125 17.039063 19.992188 16.71875 20.074219 16.480469 19.910156 16.160156 19.746094 16 19.5 16 19.171875V16.023438L2.71875 15.023438C2.320313 14.703125 2 13.898438 2 13.015625c0-.796875.238281-1.671875.71875-1.992187z"/></svg></div><div class=modal__caption><div class=modal__caption--text></div></div></span></div></div></div><script defer src=/js/swipe.min.c6d6f2aa260d0eb3a56533c919169aa2194b4deacc97dcce6e5350f71db19e95.js></script><script defer src=/js/micromodal.min.de01b44b2f383056bbcaf6ee921fd385d79108ec1129afd0eb2f3f5a07e11f45.js></script><script defer src=/js/helper/fadeinout.min.js></script><script>document.addEventListener('DOMContentLoaded',function(){var d=document.documentElement,g,f,s,r,m,o,l,b,c,i,n,e,h,j,a,p,q;function t(){d.requestFullscreen?d.requestFullscreen():d.mozRequestFullScreen?d.mozRequestFullScreen():d.webkitRequestFullscreen?d.webkitRequestFullscreen():d.msRequestFullscreen&&d.msRequestFullscreen()}function k(){(document.fullscreenElement||document.webkitFullscreenElement||document.mozFullScreenElement)&&(document.exitFullscreen?document.exitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitExitFullscreen?document.webkitExitFullscreen():document.msExitFullscreen&&document.msExitFullscreen())}g=document.getElementById('modal'),f=document.querySelector('.gallery__container'),s=document.querySelector('.swipe-wrap'),r=document.getElementById('mySwipe'),m=document.querySelector('.modal__arrow--left'),o=document.querySelector('.modal__arrow--right'),l=document.querySelector('.modal__toolbar--close'),b=document.querySelector('.modal__toolbar--full'),c=document.querySelector('.modal__toolbar--normal'),i=document.querySelector('.modal__caption'),n=document.querySelector('.modal__paging'),e=document.querySelector('.modal__items'),h=null,j=null,a=null,p=function(b){b.key==='ArrowRight'?g&&g.classList.contains('is-open')&&a.next():b.key==='ArrowLeft'&&g&&g.classList.contains('is-open')&&a.prev()},f?h=f.querySelectorAll('img').length:(f=document.querySelector('.single__contents'),h=f.querySelectorAll('img').length),MicroModal.init({onClose:function(){a&&(a.kill(),a=null,k()),window.removeEventListener('keydown',p)},disableScroll:!0,disableFocus:!0,awaitOpenAnimation:!1,awaitCloseAnimation:!1,debugMode:!1}),q=function(a){return new Promise(function(c,d){var b=new Image;b.onload=function(){c(b)},b.onerror=d,b.src=a})},f.querySelectorAll('img').forEach(function(g,k){var f,d;g.style.cursor='pointer',f=g.cloneNode(!0),f.style.maxHeight='100%',f.style.maxWidth='100%',f.onclick=function(a){a.stopPropagation()},d=document.createElement('div'),d.style.width='100%',d.style.height='100vh',d.setAttribute('data-micromodal-close',''),d.onclick=function(){a&&(a.kill(),a=null)},d.onmouseenter=function(){clearTimeout(j),fadeIn(e,200)},d.onmouseleave=function(){j=setTimeout(function(){fadeOut(e,200)},2500)},d.ontouchstart=function(){fadeIn(e,200)},d.append(f),s.append(d),g.addEventListener('click',async function(d){var m,l,g;MicroModal.show('modal'),a&&(a.kill(),a=null),m=d.target.getAttribute('data-src')||d.target.getAttribute('src'),l=await q(m),f.style.width=l.width+'px',f.style.height=l.height+'px',a=new Swipe(r,{startSlide:k,draggable:!0,autoRestart:!1,continuous:!1,disableScroll:!0,stopPropagation:!0,callback:async function(d,f){var a=f.querySelector('img'),g=a.getAttribute('data-src')||a.getAttribute('src'),c=await q(g),b;a.style.width=c.width+'px',a.style.height=c.height+'px',i&&a&&(b=null,a.getAttribute('data-caption')?b=a.getAttribute('data-caption'):a.getAttribute('title')?b=a.getAttribute('title'):a.getAttribute('alt')?b=a.getAttribute('alt'):b=a.getAttribute('src'),i.querySelector('.modal__caption--text').innerText=b,n.innerText=d+1+' / '+h,clearTimeout(j),fadeIn(e,200))}}),fadeIn(e),i&&(g=null,d.target.getAttribute('data-caption')?g=d.target.getAttribute('data-caption'):d.target.getAttribute('title')?g=d.target.getAttribute('title'):d.target.getAttribute('alt')?g=d.target.getAttribute('alt'):g=d.target.getAttribute('src'),i.querySelector('.modal__caption--text').innerText=g,n.innerText=k+1+' / '+h),c&&b&&(c.style.zIndex=-1,c.style.opacity=0,b.style.zIndex=25,b.style.opacity=1)}),window.addEventListener('keydown',p)}),m?m.addEventListener('click',function(b){a&&a.prev()}):null,o?o.addEventListener('click',function(b){a&&a.next()}):null,l?l.addEventListener('click',function(){a&&(a.kill(),a=null),k(),MicroModal.close('modal')}):null,b?b.addEventListener('click',function(a){t(),c&&(c.style.zIndex=25,c.style.opacity=1,b.style.zIndex=-1,b.style.opacity=0)}):null,c?c.addEventListener('click',function(a){k(),b&&(b.style.zIndex=25,b.style.opacity=1,c.style.zIndex=-1,c.style.opacity=0)}):null})</script><div class=hide><div class=search><span class=icon><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="currentcolor" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><path d="M15.5 14h-.79l-.28-.27c1.2-1.4 1.82-3.31 1.48-5.34-.47-2.78-2.79-5-5.59-5.34-4.23-.52-7.79 3.04-7.27 7.27.34 2.8 2.56 5.12 5.34 5.59 2.03.34 3.94-.28 5.34-1.48l.27.28v.79l4.25 4.25c.41.41 1.08.41 1.49.0s.41-1.08.0-1.49L15.5 14zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg></span><input id=search aria-label="Site Search"class=input type=text placeholder=搜索 autocomplete=off><div id=search-results class=dropdown><div id=search-menu class=dropdown-menu role=menu></div></div></div></div></div></main><aside class="single__side main-side"><section class="sidebar hide"><script>document.querySelector('.sidebar').classList.remove('hide')</script><div class=toc__flexbox data-position=fixed><h6 class=toc__title data-ani=true>目录</h6><label class=switch data-ani=true><input id=toggle-toc aria-label="Toggle TOC"type=checkbox checked>
<span class="slider round"></span></label></div><div class=toc data-dir=ltr data-folding=true data-ani=true><nav id=TableOfContents><ul><li><a href=#内容介绍>内容介绍</a></li><li><a href=#sidecar-模式>Sidecar 模式</a><ul><li><a href=#使用-sidecar-模式的优势>使用 Sidecar 模式的优势</a></li></ul></li><li><a href=#sidecar-注入示例分析>Sidecar 注入示例分析</a></li><li><a href=#iptables-规则注入解析>iptables 规则注入解析</a><ul><li><a href=#在-minikube-中查看容器中的-iptabes-规则>在 minikube 中查看容器中的 iptabes 规则</a></li><li><a href=#在-gke-中查看容器的-iptables-规则>在 GKE 中查看容器的 iptables 规则</a></li></ul></li><li><a href=#iptables-流量劫持过程详解>iptables 流量劫持过程详解</a></li><li><a href=#流量路由过程详解>流量路由过程详解</a><ul><li><a href=#理解-inbound-handler>理解 Inbound Handler</a></li><li><a href=#理解-outbound-handler>理解 Outbound Handler</a></li></ul></li><li><a href=#小结>小结</a><ul><li><a href=#使用-iptables-做流量劫持时存在的问题>使用 iptables 做流量劫持时存在的问题</a></li><li><a href=#透明劫持方案优化>透明劫持方案优化</a></li></ul></li><li><a href=#更新说明>更新说明</a></li><li><a href=#参考>参考</a></li></ul></nav></div></section></aside><script>var enableToc=JSON.parse("true"),toc=JSON.parse("null"),tocPosition=JSON.parse('"inner"'),singleMainElem=document.querySelector('.single__main'),singleSideElem=document.querySelector('.single__side');enquire.register("screen and (max-width: 769px)",{match:function(){(enableToc||toc)&&tocPosition!=="outer"?singleMainElem&&singleSideElem&&(singleMainElem.classList.remove('main-main'),singleMainElem.classList.add('main'),singleSideElem.classList.remove('main-side'),singleSideElem.classList.add('hide')):tocPosition==="outer"&&(singleMainElem&&!singleMainElem.classList.contains('main-main')&&(singleMainElem.classList.remove('main-main'),singleMainElem.classList.add('main')),singleSideElem&&!singleSideElem.classList.contains('hide')&&singleSideElem.classList.add('hide'))},unmatch:function(){var b,a;(enableToc||toc)&&tocPosition!=="outer"?(singleMainElem.classList.remove('main'),singleMainElem.classList.add('main-main'),singleSideElem.classList.remove('hide'),singleSideElem.classList.add('main-side')):tocPosition==="outer"&&(singleMainElem&&!singleMainElem.classList.contains('main-main')&&(singleMainElem.classList.remove('main-main'),singleMainElem.classList.add('main')),singleSideElem&&!singleSideElem.classList.contains('hide')&&singleSideElem.classList.add('hide')),b=document.querySelector('.navbar__burger'),a=document.getElementsByClassName('navbarm__collapse')[0],a&&(a.setAttribute('data-open',!1),a.style.maxHeight=0,b.classList.remove('is-active')),document.getElementsByClassName('navbar__menu')[0].classList.remove('is-active'),document.getElementsByClassName('mobile-search')[0].classList.add('hide')},setup:function(){},deferSetup:!0,destroy:function(){}})</script><script defer src=/js/helper/getParents.min.js></script><script defer src=/js/helper/closest.min.js></script><script defer src=/js/helper/prev.min.js></script><script defer src=/js/helper/prop.min.js></script><script defer src=/js/helper/fadeinout.min.js></script><script defer src=/js/helper/throttle.min.js></script><script>'use strict',window.onload=function(){var f=document.querySelector('.navbar'),D=document.querySelector('.single__contents'),E=JSON.parse("false"),J=JSON.parse("true"),s,H,F,L,k,j,A,g,u,x,d,e,l,i,I,C,K,v,N,y,r,z,b,w,t,M,h,c,G,a,m,n,o,p,B,q;E&&J&&(s=document.querySelector('#busuanzi_value_page_pv'),s.textContent=s.textContent.replace(/(\d)(?=(\d\d\d)+(?!\d))/g,"$1,")),H=JSON.parse("true"),F=JSON.parse("null"),L=JSON.parse("false"),k=document.querySelector('.toc__flexbox'),j=document.querySelector('.toc__flexbox--outer'),A=JSON.parse("true"),(H||F)&&document.querySelector('.toc')&&(g=document.querySelector('.toc').querySelector('#TableOfContents'),g.onmouseenter=function(){f.classList.contains('scrolling')&&f.classList.remove('scrolling')},g.onmouseleave=function(){f.classList.contains('scrolling')||f.classList.add('scrolling')},!1===A||(g.querySelectorAll('ul')?g.querySelectorAll('ul').forEach(function(a){a.querySelectorAll('li').forEach(function(a){a.querySelectorAll('ul').forEach(function(a){a.style.display='none'})})}):null),g&&(g.querySelectorAll('a').length>0?g.querySelectorAll('a').forEach(function(a){a.addEventListener('click',function(){var c=a.getAttribute('id'),b;f.classList.contains('scrolling')||(f.classList.remove('navbar--show'),f.classList.remove('navbar--hide'),f.classList.add('navbar--hide')),document.querySelector('.toc').querySelectorAll('a').forEach(function(a){a.classList.remove('active')}),a.classList.add('active'),b=g.querySelector('[href="#'+c+'"]'),b&&b.nextElementSibling&&(b.nextElementSibling.style.display='block'),b&&(getParents(b,'ul')?getParents(b,'ul').forEach(function(a){a.style.display='block'}):null)})}):(k&&(k.setAttribute('data-position',''),k.classList.contains('hide')||k.classList.add('hide')),j&&(j.setAttribute('data-position',''),j.classList.contains('hide')||j.classList.add('hide')))),u=document.getElementById("toggle-toc"),x=document.getElementById('visible-toc'),d=document.querySelector('.toc'),e=document.querySelector('main'),l=document.querySelector('side'),i=document.querySelector('.toc__flexbox'),u?u.addEventListener('change',function(a){a.target.checked?(d&&fadeIn(d,200),i&&i.setAttribute('data-position','fixed'),e&&(e.classList.remove('main-main'),e.classList.remove('main'),e.classList.add('main-main')),l&&l.classList.remove('main-side')):(d&&fadeOut(d,200),i&&i.setAttribute('data-position','absolute'),e&&(e.classList.remove('main-main'),e.classList.remove('main'),e.classList.add('main')),l&&l.classList.remove('main-side'))}):null,x?x.addEventListener('change',function(a){a.target.checked?d&&fadeIn(d,200):d&&fadeOut(d,200)}):null),I=120,C=70,K=function(){d&&(d.style.maxHeight=window.innerHeight-I-C+'px')},v=throttle(K,300),v(),window.addEventListener('resize',v),y=new ClipboardJS('.anchor'),r=D.querySelectorAll("h1, h2, h3, h4"),z=JSON.parse('"ltr"'),r?r.forEach(function(c){var d=parseInt(c.tagName.substr(1),10)*2,e=encodeURI(document.location.origin+document.location.pathname),f=e+"#"+c.getAttribute('id'),b=document.createElement('span'),a;b.classList.add('anchor'),b.classList.add('hide'),b.setAttribute('data-clipboard-text',decodeURI(f)),b.style.position='relative',a=document.createElement('span'),a.style.position='absolute',a.style.top='50%',a.style.left='0.75rem',a.style.transform='translateY(-50%)',a.innerHTML=`
<svg fill="currentColor" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="${32-d}px" height="${32-d}px"><path d="M 5.5625 0 C 4.136719 0 2.707031 0.542969 1.625 1.625 C -0.539063 3.789063 -0.539063 7.335938 1.625 9.5 L 5.28125 13.15625 C 5.667969 13.554688 6.304688 13.558594 6.703125 13.171875 C 7.101563 12.785156 7.105469 12.148438 6.71875 11.75 L 3.03125 8.0625 C 1.632813 6.664063 1.632813 4.429688 3.03125 3.03125 C 4.429688 1.632813 6.664063 1.632813 8.0625 3.03125 L 12.96875 7.9375 C 14.367188 9.335938 14.367188 11.570313 12.96875 12.96875 C 12.804688 13.132813 12.621094 13.25 12.4375 13.375 C 11.980469 13.6875 11.859375 14.308594 12.171875 14.765625 C 12.484375 15.222656 13.105469 15.34375 13.5625 15.03125 C 13.847656 14.835938 14.125 14.625 14.375 14.375 C 16.539063 12.210938 16.539063 8.664063 14.375 6.5 L 9.5 1.625 C 8.417969 0.542969 6.988281 0 5.5625 0 Z M 10.78125 8.875 C 10.738281 8.882813 10.695313 8.894531 10.65625 8.90625 C 10.507813 8.9375 10.371094 9 10.25 9.09375 C 10.039063 9.253906 9.820313 9.429688 9.625 9.625 C 7.460938 11.789063 7.460938 15.335938 9.625 17.5 L 14.5 22.375 C 16.664063 24.539063 20.210938 24.539063 22.375 22.375 C 24.539063 20.210938 24.539063 16.664063 22.375 14.5 L 18.71875 10.875 C 18.476563 10.578125 18.089844 10.441406 17.714844 10.527344 C 17.34375 10.613281 17.050781 10.90625 16.964844 11.277344 C 16.878906 11.652344 17.015625 12.039063 17.3125 12.28125 L 20.96875 15.9375 C 22.367188 17.335938 22.367188 19.570313 20.96875 20.96875 C 19.570313 22.367188 17.335938 22.367188 15.9375 20.96875 L 11.03125 16.0625 C 9.632813 14.664063 9.632813 12.429688 11.03125 11.03125 C 11.152344 10.90625 11.300781 10.820313 11.4375 10.71875 C 11.839844 10.472656 12.015625 9.976563 11.855469 9.53125 C 11.699219 9.085938 11.25 8.8125 10.78125 8.875 Z"/></svg>`,z==="rtl"?a.style.left='-2rem':a.style.right='-2rem',b.append(a),c.append(b),c.addEventListener('mouseenter',function(){this.querySelector('.anchor').classList.remove('hide')}),c.addEventListener('mouseleave',function(){this.querySelector('.anchor').classList.add('hide')})}):null,document.querySelectorAll('.anchor').forEach(function(a){a.addEventListener('mouseleave',function(){a.setAttribute('aria-label',null),a.classList.remove('tooltipped'),a.classList.remove('tooltipped-s'),a.classList.remove('tooltipped-w')})}),y.on('success',function(a){a.clearSelection(),a.trigger.setAttribute('aria-label','Link copied to clipboard!'),a.trigger.classList.add('tooltipped'),a.trigger.classList.add('tooltipped-s')}),b=JSON.parse("null"),b&&b.includes('mermaid')&&(w=localStorage.getItem('theme')||JSON.parse('"dark"'),w==="dark"||w==="hacker"?mermaid.initialize({theme:'dark'}):mermaid.initialize({theme:'default'}),t=[],[].push.apply(t,document.getElementsByClassName('language-mermaid')),t.forEach(function(b){var a=b.parentNode,c;a!==document.body&&(a.parentNode.insertBefore(b,a),a.parentNode.removeChild(a)),c=document.createElement('div'),c.classList.add('mermaid'),c.style.padding='34px 4px 6px',c.innerHTML=b.innerHTML,b.replaceWith(c)})),b&&b.includes('katex')&&(M=document.getElementsByClassName('math'),h={delimiters:[{left:"$$",right:"$$",display:!0},{left:"\\[",right:"\\]",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1}]},renderMathInElement(document.querySelector('.single__contents'),h)),b&&b.includes('flowchartjs')&&(h=JSON.parse('{"arrow-end":"block","element-color":"black","fill":"white","flowstate":{"approved":{"fill":"#58C4A3","font-size":12,"no-text":"n/a","yes-text":"APPROVED"},"current":{"fill":"yellow","font-color":"red","font-weight":"bold"},"future":{"fill":"#FFFF99"},"invalid":{"fill":"#444444"},"past":{"fill":"#CCCCCC","font-size":12},"rejected":{"fill":"#C45879","font-size":12,"no-text":"REJECTED","yes-text":"n/a"},"request":{"fill":"blue"}},"font-color":"black","font-size":14,"line-color":"black","line-length":50,"line-width":3,"no-text":"no","scale":1,"symbols":{"end":{"class":"end-element"},"start":{"element-color":"green","fill":"yellow","font-color":"red"}},"text-margin":10,"x":0,"y":0,"yes-text":"yes"}'),c=null,G="language-flowchart",a=0,Array.prototype.forEach.call(document.querySelectorAll("[class^="+G+"]"),function(b){var d,e;b.style.display='none',b.parentNode.style.backgroundColor="transparent",c=b.innerText,d=document.createElement('div'),d.id='flowchart'+a,b.parentNode.insertBefore(d,b),e=flowchart.parse(c),e.drawSVG("flowchart"+a,h),a+=1})),document.querySelectorAll("mjx-container").forEach(function(a){a.parentElement.classList+='has-jax'}),b&&b.includes('msc')&&(h=JSON.parse('{"theme":"hand"}'),c=null,a=0,m="language-msc",Array.prototype.forEach.call(document.querySelectorAll("[class^="+m+"]"),function(b){var d,e;b.style.display='none',b.parentNode.style.backgroundColor="transparent",c=b.innerText,d=document.createElement('div'),d.id='msc'+a,b.parentNode.insertBefore(d,b),e=Diagram.parse(c),e.drawSVG("msc"+a,h),a+=1})),b&&b.includes('chart')&&(n="#666",o="#ddd",p=2,Chart.defaults.global.elements.rectangle.borderWidth=p,Chart.defaults.global.elements.rectangle.borderColor=n,Chart.defaults.global.elements.rectangle.backgroundColor=o,Chart.defaults.global.elements.line.borderWidth=p,Chart.defaults.global.elements.line.borderColor=n,Chart.defaults.global.elements.line.backgroundColor=o,Chart.defaults.global.elements.point.borderWidth=p,Chart.defaults.global.elements.point.borderColor=n,Chart.defaults.global.elements.point.backgroundColor=o,m="language-chart",a=0,c=null,Array.prototype.forEach.call(document.querySelectorAll("[class^="+m+"]"),function(b){var d,e,f,g;b.style.display='none',b.parentNode.style.backgroundColor="transparent",c=b.innerText,d=document.createElement('canvas'),e=null,d.height=200,d.style.height=200,d.id='myChart'+a,e=JSON.parse(c),b.parentNode.insertBefore(d,b),f=document.getElementById('myChart'+a).getContext('2d'),g=new Chart(f,e),a+=1})),b&&b.includes('wavedrom')&&(B="language-wave",a=0,c=null,Array.prototype.forEach.call(document.querySelectorAll("[class^="+B+"]"),function(b){var d,e;b.style.display='none',b.parentNode.style.backgroundColor="transparent",c=b.innerText,d=document.createElement('div'),e=null,d.id='WaveDrom_Display_'+a,e=JSON.parse(c),b.parentNode.insertBefore(d,b),WaveDrom.RenderWaveForm(a,e,"WaveDrom_Display_"),a+=1})),b&&b.includes('viz')&&(q="language-viz-",Array.prototype.forEach.call(document.querySelectorAll("[class^="+q+"]"),function(a){var b,c;a.style.display='none',a.parentNode.style.backgroundColor="transparent";a.getAttribute("class").split(" ").forEach(function(a){a.startsWith(q)&&(b=a.substr(q.length))}),c=new Viz,c.renderSVGElement(a.innerText,{engine:b}).then(function(b){b.style.width="100%",a.parentNode.insertBefore(b,a)})}))}</script><footer class=footer><div class=dropdown><button class=dropdown-trigger aria-label="Select Language Button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><path fill="currentcolor" d="M12.65 15.67c.14-.36.05-.77-.23-1.05l-2.09-2.06.03-.03c1.74-1.94 2.98-4.17 3.71-6.53h1.94c.54.0.99-.45.99-.99v-.02c0-.54-.45-.99-.99-.99H10V3c0-.55-.45-1-1-1s-1 .45-1 1v1H1.99c-.54.0-.99.45-.99.99.0.55.45.99.99.99h10.18C11.5 7.92 10.44 9.75 9 11.35c-.81-.89-1.49-1.86-2.06-2.88-.16-.29-.45-.47-.78-.47-.69.0-1.13.75-.79 1.35.63 1.13 1.4 2.21 2.3 3.21L3.3 16.87c-.4.39-.4 1.03.0 1.42.39.39 1.02.39 1.42.0L9 14l2.02 2.02c.51.51 1.38.32 1.63-.35zM17.5 10c-.6.0-1.14.37-1.35.94l-3.67 9.8c-.24.61.22 1.26.87 1.26.39.0.74-.24.88-.61l.89-2.39h4.75l.9 2.39c.14.36.49.61.88.61.65.0 1.11-.65.88-1.26l-3.67-9.8c-.22-.57-.76-.94-1.36-.94zm-1.62 7 1.62-4.33L19.12 17h-3.24z"/></svg></button><div class=dropdown-content></div></div><div class=footer__social><div class=social><a href=mailto:kbsonlong@gmail.com title=email aria-label=email><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><path fill="currentcolor" d="M20 4H4c-1.1.0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1.0 2-.9 2-2V6c0-1.1-.9-2-2-2zm-.4 4.25-7.07 4.42c-.32.2-.74.2-1.06.0L4.4 8.25c-.25-.16-.4-.43-.4-.72.0-.67.73-1.07 1.3-.72L12 11l6.7-4.19c.57-.35 1.3.05 1.3.72.0.29-.15.56-.4.72z"/></svg></a><a href=https://github.com/sreionet title=github aria-label=github><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="32" height="32" viewBox="0 0 24 24"><g id="surface3680"><path fill="currentcolor" d="M10.898438 2.101562c-4.597657.5-8.296876 4.199219-8.796876 8.699219-.5 4.699219 2.199219 8.898438 6.296876 10.5C8.699219 21.398438 9 21.199219 9 20.800781V19.199219S8.601562 19.300781 8.101562 19.300781c-1.402343.0-2-1.199219-2.101562-1.902343C5.898438 17 5.699219 16.699219 5.398438 16.398438 5.101562 16.300781 5 16.300781 5 16.199219 5 16 5.300781 16 5.398438 16 6 16 6.5 16.699219 6.699219 17c.5.800781000000001 1.101562 1 1.402343 1C8.5 18 8.800781 17.898438 9 17.800781 9.101562 17.101562 9.398438 16.398438 10 16c-2.300781-.5-4-1.800781-4-4 0-1.101562.5-2.199219 1.199219-3C7.101562 8.800781 7 8.300781 7 7.601562c0-.402343.0-1 .300781-1.601562.0.0 1.398438.0 2.800781 1.300781C10.601562 7.101562 11.300781 7 12 7s1.398438.101562 2 .300781C15.300781 6 16.800781 6 16.800781 6 17 6.601562 17 7.199219 17 7.601562 17 8.398438 16.898438 8.800781 16.800781 9 17.5 9.800781 18 10.800781 18 12c0 2.199219-1.699219 3.5-4 4 .601562.5 1 1.398438 1 2.300781v2.597657C15 21.199219 15.300781 21.5 15.699219 21.398438 19.398438 19.898438 22 16.300781 22 12.101562c0-6-5.101562-10.703124-11.101562-10zm0 0"/></g></svg></a><a href=https://sreionet.github.io/posts/index.xml type=application/rss+xml title=RSS aria-label="RSS Feed Link"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><circle fill="currentcolor" cx="6.18" cy="17.82" r="2.18"/><path fill="currentcolor" d="M5.59 10.23c-.84-.14-1.59.55-1.59 1.4.0.71.53 1.28 1.23 1.4 2.92.51 5.22 2.82 5.74 5.74.12.7.69 1.23 1.4 1.23.85.0 1.54-.75 1.41-1.59-.68-4.2-3.99-7.51-8.19-8.18zm-.03-5.71C4.73 4.43 4 5.1 4 5.93c0 .73.55 1.33 1.27 1.4 6.01.6 10.79 5.38 11.39 11.39.07.73.67 1.28 1.4 1.28.84.0 1.5-.73 1.42-1.56-.73-7.34-6.57-13.19-13.92-13.92z"/></svg></a></div></div><div id=gtt><div class=gtt><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentcolor" d="M8.12 14.71 12 10.83l3.88 3.88c.39.39 1.02.39 1.41.0s.39-1.02.0-1.41L12.7 8.71c-.39-.39-1.02-.39-1.41.0L6.7 13.3c-.39.39-.39 1.02.0 1.41.39.38 1.03.39 1.42.0z"/></svg></div></div><hr><div class="basicflex flexwrap"></div><div class=footer__poweredby><p class=caption>©2023, All Rights Reserved</p><p class=caption>Powered by <a href=https://gohugo.io/ target=_blank rel=noreferrer>Hugo</a> and the <a href=https://github.com/zzossig/hugo-theme-zzo target=_blank rel=noreferrer>Zzo theme</a></p></div></footer></div><div class="wrapper__right hide"data-pad=true dir=ltr><script>document.querySelector('.wrapper__right').classList.remove('hide')</script></div></div></body></html>