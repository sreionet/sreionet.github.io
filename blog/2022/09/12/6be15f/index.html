<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=zh class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.96.0"><meta name=robots content="index, follow"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>深入Istio系列-组件详解 | 云原生技术圈</title><meta name=description content="在前两篇博客中：
 Istio 中的 Sidecar 注入、透明流量劫持及流量路由过程详解 Sidecar 中的流量类型及 iptables 规则详解  我向你详细介绍了 Istio 数据平面中的流量，但数据平面并不能孤立的存在，本文将向你展示 Istio 中的控制平面和数据平面各组件的端口及其功能，有助于你了解这些流量之间的关系及故障排查。
Istio 中的组件及端口示意图 按照习惯，我们首先展示一个全局示意图。下图展示的是 Istio 数据平面中 sidecar 的组成，以及与其交互的对象。
我们可以使用 nsenter 命令进入Bookinfo 示例的 productpage Pod的网络空间，查看其内部监听的端口信息。
从图中我们可以看到除了 productpage 应用本身监听的 9080 端口以外，Sidecar 容器还有监听大量的其他端口，如 15000、15001、15004、15006、15021、15090 等，你可以在 Istio 文档上了解 Istio 中使用的端口。
我们再进入 productpage Pod 中，使用 lsof -i 命令查看它打开的端口，如下图所示。
!我们可以看到其中有 pilot-agent 与 istiod 建立了 TCP 连接，上文中所述的监听中的端口，还有在 Pod 内部建立的 TCP 连接，这些连接对应了文章开头的示意图。
Sidecar 容器（istio-proxy ）的根进程是 pilot-agent，启动命令如下图所示：
从图中我们可以看到，它 pilot-agent 进程的 PID 是 1，是它拉起了 envoy 进程。"><meta property="og:title" content="深入Istio系列-组件详解"><meta property="og:description" content="在前两篇博客中：
 Istio 中的 Sidecar 注入、透明流量劫持及流量路由过程详解 Sidecar 中的流量类型及 iptables 规则详解  我向你详细介绍了 Istio 数据平面中的流量，但数据平面并不能孤立的存在，本文将向你展示 Istio 中的控制平面和数据平面各组件的端口及其功能，有助于你了解这些流量之间的关系及故障排查。
Istio 中的组件及端口示意图 按照习惯，我们首先展示一个全局示意图。下图展示的是 Istio 数据平面中 sidecar 的组成，以及与其交互的对象。
我们可以使用 nsenter 命令进入Bookinfo 示例的 productpage Pod的网络空间，查看其内部监听的端口信息。
从图中我们可以看到除了 productpage 应用本身监听的 9080 端口以外，Sidecar 容器还有监听大量的其他端口，如 15000、15001、15004、15006、15021、15090 等，你可以在 Istio 文档上了解 Istio 中使用的端口。
我们再进入 productpage Pod 中，使用 lsof -i 命令查看它打开的端口，如下图所示。
!我们可以看到其中有 pilot-agent 与 istiod 建立了 TCP 连接，上文中所述的监听中的端口，还有在 Pod 内部建立的 TCP 连接，这些连接对应了文章开头的示意图。
Sidecar 容器（istio-proxy ）的根进程是 pilot-agent，启动命令如下图所示：
从图中我们可以看到，它 pilot-agent 进程的 PID 是 1，是它拉起了 envoy 进程。"><meta property="og:type" content="article"><meta property="og:url" content="https://sreionet.github.io/blog/2022/09/12/6be15f/"><meta property="article:section" content="blog"><meta property="article:published_time" content="2022-09-12T08:19:28+08:00"><meta property="article:modified_time" content="2022-09-12T08:19:28+08:00"><meta property="og:site_name" content="云原生技术圈"><meta itemprop=name content="深入Istio系列-组件详解"><meta itemprop=description content="在前两篇博客中：
 Istio 中的 Sidecar 注入、透明流量劫持及流量路由过程详解 Sidecar 中的流量类型及 iptables 规则详解  我向你详细介绍了 Istio 数据平面中的流量，但数据平面并不能孤立的存在，本文将向你展示 Istio 中的控制平面和数据平面各组件的端口及其功能，有助于你了解这些流量之间的关系及故障排查。
Istio 中的组件及端口示意图 按照习惯，我们首先展示一个全局示意图。下图展示的是 Istio 数据平面中 sidecar 的组成，以及与其交互的对象。
我们可以使用 nsenter 命令进入Bookinfo 示例的 productpage Pod的网络空间，查看其内部监听的端口信息。
从图中我们可以看到除了 productpage 应用本身监听的 9080 端口以外，Sidecar 容器还有监听大量的其他端口，如 15000、15001、15004、15006、15021、15090 等，你可以在 Istio 文档上了解 Istio 中使用的端口。
我们再进入 productpage Pod 中，使用 lsof -i 命令查看它打开的端口，如下图所示。
!我们可以看到其中有 pilot-agent 与 istiod 建立了 TCP 连接，上文中所述的监听中的端口，还有在 Pod 内部建立的 TCP 连接，这些连接对应了文章开头的示意图。
Sidecar 容器（istio-proxy ）的根进程是 pilot-agent，启动命令如下图所示：
从图中我们可以看到，它 pilot-agent 进程的 PID 是 1，是它拉起了 envoy 进程。"><meta itemprop=datePublished content="2022-09-12T08:19:28+08:00"><meta itemprop=dateModified content="2022-09-12T08:19:28+08:00"><meta itemprop=wordCount content="260"><meta itemprop=keywords content="istio,sicader,转载,"><meta name=twitter:card content="summary"><meta name=twitter:title content="深入Istio系列-组件详解"><meta name=twitter:description content="在前两篇博客中：
 Istio 中的 Sidecar 注入、透明流量劫持及流量路由过程详解 Sidecar 中的流量类型及 iptables 规则详解  我向你详细介绍了 Istio 数据平面中的流量，但数据平面并不能孤立的存在，本文将向你展示 Istio 中的控制平面和数据平面各组件的端口及其功能，有助于你了解这些流量之间的关系及故障排查。
Istio 中的组件及端口示意图 按照习惯，我们首先展示一个全局示意图。下图展示的是 Istio 数据平面中 sidecar 的组成，以及与其交互的对象。
我们可以使用 nsenter 命令进入Bookinfo 示例的 productpage Pod的网络空间，查看其内部监听的端口信息。
从图中我们可以看到除了 productpage 应用本身监听的 9080 端口以外，Sidecar 容器还有监听大量的其他端口，如 15000、15001、15004、15006、15021、15090 等，你可以在 Istio 文档上了解 Istio 中使用的端口。
我们再进入 productpage Pod 中，使用 lsof -i 命令查看它打开的端口，如下图所示。
!我们可以看到其中有 pilot-agent 与 istiod 建立了 TCP 连接，上文中所述的监听中的端口，还有在 Pod 内部建立的 TCP 连接，这些连接对应了文章开头的示意图。
Sidecar 容器（istio-proxy ）的根进程是 pilot-agent，启动命令如下图所示：
从图中我们可以看到，它 pilot-agent 进程的 PID 是 1，是它拉起了 envoy 进程。"><link rel=preload href=/scss/main.min.d7bb2255c5e6435c81fb7d8f4e2d6dfb0c1b5db5f695f0117b53d4a291eeca4d.css as=style><link href=/scss/main.min.d7bb2255c5e6435c81fb7d8f4e2d6dfb0c1b5db5f695f0117b53d4a291eeca4d.css rel=stylesheet integrity><script src=https://code.jquery.com/jquery-3.6.0.min.js integrity=sha384-vtXRMe3mGCbOeY7l30aIg8H9p3GdeSe4IFlP6G8JMa7o7lXvnz3GFKzPxzJdPfGK crossorigin=anonymous></script>
<script defer src=https://unpkg.com/lunr@2.3.9/lunr.min.js integrity=sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli crossorigin=anonymous></script></head><body class="td-page td-blog"><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar"><a class=navbar-brand href=/><span class="navbar-brand__logo navbar-logo"><svg id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 500 500" style="enable-background:new 0 0 500 500"><g><path style="fill:#fff" d="M116.8525 421.9722c-5.7041.0-10.3442-4.3127-10.3442-9.6129V88.183c0-5.3002 4.6401-9.6117 10.3442-9.6117H320.858c3.0347.0 9.3959.5498 11.7506 2.6302l.3545.3442 58.905 63.2912c2.3101 2.491 2.9202 8.4928 2.9202 11.3184v256.2039c0 5.3002-4.6407 9.6129-10.3436 9.6129H116.8525z"/><g><g><g><path style="fill:#767676" d="M384.4445 423.2066H116.852c-6.3839.0-11.5786-4.8658-11.5786-10.8474V88.1831c0-5.9804 5.1947-10.8461 11.5786-10.8461h204.0062c.377.0 9.2786.0329 12.568 2.9389l.3947.3833 58.9508 63.337c3.2135 3.4652 3.2514 11.7924 3.2514 12.1593v256.2036C396.0231 418.3408 390.8284 423.2066 384.4445 423.2066zM116.5079 411.9189c.0848.0278.1999.0531.3441.0531h267.5925c.1442.0.2581-.0253.3441-.0531V156.1556c-.0076-.9033-.3593-3.7347-.7034-5.0037l-57.6527-61.9416c-1.4651-.3176-4.4533-.6389-5.5742-.6389H116.852c-.143.0-.2594.024-.3441.0531V411.9189zm267.4533-261.149zM327.0321 89.371v.0013V89.371z"/></g></g></g><g><g><path style="fill:#5b7fc0" d="M189.0874 210.1754l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.025 2.454-11.4897 6.4116-15.4473C177.5953 212.627 183.0601 210.1742 189.0874 210.1754zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403S197.0816 234.1722 197.0804 232.033z"/><path style="opacity:.3;fill:#fff" d="M189.0898 210.176c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 212.6276 183.0612 210.176 189.0898 210.176zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 236.239 197.0839 234.2399 197.0839 232.0372z"/><g><defs><path id="SVGID_1_" d="M194.7376 237.6875c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.999 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 234.2399 196.1861 236.239 194.7376 237.6875z"/></defs><clipPath id="SVGID_2_"><use xlink:href="#SVGID_1_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_2_);fill:#fff" d="M190.0704 225.0237c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 225.7247 191.9774 225.0237 190.0704 225.0237z"/><path style="opacity:.13;clip-path:url(#SVGID_2_);fill:#020202" d="M190.0704 225.0237c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 225.7247 191.9774 225.0237 190.0704 225.0237z"/></g><g><defs><path id="SVGID_3_" d="M189.0898 210.176c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 212.6276 183.0612 210.176 189.0898 210.176zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 236.239 197.0839 234.2399 197.0839 232.0372z"/></defs><clipPath id="SVGID_4_"><use xlink:href="#SVGID_3_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_4_);fill:#5b7fc0" d="M172.6595 215.6045c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8612 12.0547.0024 21.8636-9.797 21.8613-21.8612.0024-3.8475-1.0151-7.6326-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 209.1953 176.6171 211.647 172.6595 215.6045z"/></g></g><rect x="198.8952" y="225.1043" style="fill:#5b7fc0" width="122.6266" height="13.8671"/></g><g><path style="fill:#d95140" d="M189.0874 155.7611l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.0249 2.454-11.4897 6.4116-15.4473C177.5953 158.2128 183.0601 155.7599 189.0874 155.7611zm7.993 21.8577c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403C196.2508 181.7667 197.0816 179.758 197.0804 177.6188z"/><path style="opacity:.3;fill:#fff" d="M189.0898 155.7617c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 158.2134 183.0612 155.7617 189.0898 155.7617zm7.9941 21.8613c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 181.8248 197.0839 179.8256 197.0839 177.623z"/><g><defs><path id="SVGID_5_" d="M194.7376 183.2733c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.9989 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 179.8256 196.1861 181.8248 194.7376 183.2733z"/></defs><clipPath id="SVGID_6_"><use xlink:href="#SVGID_5_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_6_);fill:#fff" d="M190.0704 170.6095c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 171.3104 191.9774 170.6095 190.0704 170.6095z"/><path style="opacity:.13;clip-path:url(#SVGID_6_);fill:#020202" d="M190.0704 170.6095c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 171.3104 191.9774 170.6095 190.0704 170.6095z"/></g><g><defs><path id="SVGID_7_" d="M189.0898 155.7617c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 158.2134 183.0612 155.7617 189.0898 155.7617zm7.9941 21.8613c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 181.8248 197.0839 179.8256 197.0839 177.623z"/></defs><clipPath id="SVGID_8_"><use xlink:href="#SVGID_7_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_8_);fill:#d95140" d="M172.6595 161.1903c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8613 12.0547.0024 21.8636-9.797 21.8613-21.8613.0024-3.8474-1.0151-7.6326-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 154.7811 176.6171 157.2327 172.6595 161.1903z"/></g><rect x="198.8952" y="170.69" style="fill:#d95140" width="122.6266" height="13.8671"/></g><g><g><path style="fill:#56a55c" d="M189.5379 264.6147l.0012-.0012c7.7751.0012 15.0294 4.1862 18.932 10.9235 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032-5.8394.0-11.3281-2.2733-15.458-6.4032-4.13-4.13-6.4032-9.6186-6.4056-15.4628.0012-6.0249 2.454-11.4897 6.4116-15.4472C178.0458 267.0663 183.5105 264.6135 189.5379 264.6147zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6538 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403C196.7013 290.6202 197.5321 288.6115 197.5309 286.4723z"/><path style="opacity:.3;fill:#fff" d="M189.5403 264.6153c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8065-21.8612-21.8613.0-6.0285 2.4516-11.492 6.4116-15.452C178.0482 267.0669 183.5117 264.6153 189.5403 264.6153zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.6366 290.6783 197.5344 288.6792 197.5344 286.4765z"/><g><defs><path id="SVGID_9_" d="M195.1881 292.1268c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.9989 7.9942-7.9941 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.5344 288.6792 196.6366 290.6783 195.1881 292.1268z"/></defs><clipPath id="SVGID_10_"><use xlink:href="#SVGID_9_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_10_);fill:#fff" d="M190.5209 279.463c-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7446-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9941 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C194.239 280.164 192.4279 279.463 190.5209 279.463z"/><path style="opacity:.13;clip-path:url(#SVGID_10_);fill:#020202" d="M190.5209 279.463c-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7446-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9941 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C194.239 280.164 192.4279 279.463 190.5209 279.463z"/></g><g><defs><path id="SVGID_11_" d="M189.5403 264.6153c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8065-21.8612-21.8613.0-6.0285 2.4516-11.492 6.4116-15.452C178.0482 267.0669 183.5117 264.6153 189.5403 264.6153zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.6366 290.6783 197.5344 288.6792 197.5344 286.4765z"/></defs><clipPath id="SVGID_12_"><use xlink:href="#SVGID_11_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_12_);fill:#56a55c" d="M173.11 270.0439c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8613 12.0547.0024 21.8636-9.797 21.8613-21.8613.0024-3.8474-1.0151-7.6326-2.9353-10.9462-3.8977-6.7325-11.1497-10.9151-18.926-10.9151C182.5311 263.6346 177.0676 266.0863 173.11 270.0439z"/></g></g><rect x="199.3456" y="279.5436" style="fill:#56a55c" width="122.6266" height="13.8671"/></g><g><g><path style="fill:#f1bc42" d="M189.0874 318.7208l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3305-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.025 2.454-11.4897 6.4116-15.4472C177.5953 321.1724 183.0601 318.7196 189.0874 318.7208zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403S197.0816 342.7176 197.0804 340.5784z"/><path style="opacity:.3;fill:#fff" d="M189.0898 318.7214c7.7763.0 15.0283 4.1826 18.926 10.915 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8612-12.0547.0024-21.8636-9.8065-21.8612-21.8612.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 321.173 183.0612 318.7214 189.0898 318.7214zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 344.7844 197.0839 342.7853 197.0839 340.5826z"/><g><defs><path id="SVGID_13_" d="M194.7376 346.2329c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.999 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 342.7853 196.1861 344.7844 194.7376 346.2329z"/></defs><clipPath id="SVGID_14_"><use xlink:href="#SVGID_13_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_14_);fill:#fff" d="M190.0704 333.5691c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0834 6.1218 2.8788C193.7885 334.2701 191.9774 333.5691 190.0704 333.5691z"/><path style="opacity:.13;clip-path:url(#SVGID_14_);fill:#020202" d="M190.0704 333.5691c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0834 6.1218 2.8788C193.7885 334.2701 191.9774 333.5691 190.0704 333.5691z"/></g><g><defs><path id="SVGID_15_" d="M189.0898 318.7214c7.7763.0 15.0283 4.1826 18.926 10.915 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8612-12.0547.0024-21.8636-9.8065-21.8612-21.8612.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 321.173 183.0612 318.7214 189.0898 318.7214zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 344.7844 197.0839 342.7853 197.0839 340.5826z"/></defs><clipPath id="SVGID_16_"><use xlink:href="#SVGID_15_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_16_);fill:#f1bc42" d="M172.6595 324.15c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8612 12.0547.0024 21.8636-9.797 21.8613-21.8612.0024-3.8474-1.0151-7.6327-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 317.7407 176.6171 320.1924 172.6595 324.15z"/></g></g><rect x="198.8952" y="333.6497" style="fill:#f1bc42" width="122.6266" height="13.8671"/></g></g></svg></span><span class=navbar-brand__name>云原生技术圈</span></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/docs><span>文档</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/blog><span>博客</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=https://github.com/sreionet/sreionet.github.io/ target=_blank><i class="fa-brands fa-github"></i><span>GitHub</span></a></li><li class="nav-item dropdown mr-4 d-none d-lg-block"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>Versions</a><div class=dropdown-menu aria-labelledby=navbarDropdownMenuLink><a class=dropdown-item href=https://sreionet.github.io/v0.2>v0.2</a>
<a class=dropdown-item href=https://sreionet.github.io/v0.3>v0.3</a></div></li></ul></div><div class="navbar-nav d-none d-lg-block"><div class="td-search td-search--offline"><div class=td-search__icon></div><input type=search class="td-search__input form-control" placeholder aria-label autocomplete=off data-offline-search-index-json-src=/offline-search-index.c2b4906e6009c93538e754e13b898849.json data-offline-search-base-href=/ data-offline-search-max-results=10></div></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><aside class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none"><div id=td-sidebar-menu class=td-sidebar__inner><form class="td-sidebar__search d-flex align-items-center"><div class="td-search td-search--offline"><div class=td-search__icon></div><input type=search class="td-search__input form-control" placeholder aria-label autocomplete=off data-offline-search-index-json-src=/offline-search-index.c2b4906e6009c93538e754e13b898849.json data-offline-search-base-href=/ data-offline-search-max-results=10></div><button class="btn btn-link td-sidebar__toggle d-md-none p-0 ml-3 fas fa-bars" type=button data-toggle=collapse data-target=#td-section-nav aria-controls=td-section-nav aria-expanded=false aria-label="Toggle section navigation"></button></form><nav class="collapse td-sidebar-nav" id=td-section-nav><ul class="td-sidebar-nav__section pr-md-3 ul-0"><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-blog-li><a href=/blog/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section tree-root" id=m-blog><span>博客</span></a><ul class=ul-1><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20230112istioe58fafe8a782e6b58be680a7e7b3bbe58897-e79b91e68ea7e68c87e6a087e6b2a1e69c89e4b88ae68aa5-li><a href=/blog/2023/01/12/istio%E5%8F%AF%E8%A7%82%E6%B5%8B%E6%80%A7%E7%B3%BB%E5%88%97-%E7%9B%91%E6%8E%A7%E6%8C%87%E6%A0%87%E6%B2%A1%E6%9C%89%E4%B8%8A%E6%8A%A5/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20230112istioe58fafe8a782e6b58be680a7e7b3bbe58897-e79b91e68ea7e68c87e6a087e6b2a1e69c89e4b88ae68aa5><span>Istio可观测性系列-监控指标没有上报</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20230112istioe58fafe8a782e6b58be680a7e7b3bbe58897-e887aae5ae9ae4b989e68c87e6a087-li><a href=/blog/2023/01/12/istio%E5%8F%AF%E8%A7%82%E6%B5%8B%E6%80%A7%E7%B3%BB%E5%88%97-%E8%87%AA%E5%AE%9A%E4%B9%89%E6%8C%87%E6%A0%87/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20230112istioe58fafe8a782e6b58be680a7e7b3bbe58897-e887aae5ae9ae4b989e68c87e6a087><span>Istio可观测性系列-自定义指标</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20230112istioctle5b7a5e585b7e4bdbfe794a8e68c87e58d97-li><a href=/blog/2023/01/12/istioctl%E5%B7%A5%E5%85%B7%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20230112istioctle5b7a5e585b7e4bdbfe794a8e68c87e58d97><span>istioctl工具使用指南</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog202209163d18d6-li><a href=/blog/2022/09/16/3d18d6/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog202209163d18d6><span>深入Istio系列-Pilot agent</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog202209136899d1-li><a href=/blog/2022/09/13/6899d1/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog202209136899d1><span>Istio可观测性系列-性能指标</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog202209130affe7-li><a href=/blog/2022/09/13/0affe7/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog202209130affe7><span>Envoy性能指标</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child active-path" id=m-blog202209126be15f-li><a href=/blog/2022/09/12/6be15f/ class="align-left pl-0 active td-sidebar-link td-sidebar-link__page" id=m-blog202209126be15f><span class=td-sidebar-nav-active-item>深入Istio系列-组件详解</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog2022091161aaaf-li><a href=/blog/2022/09/11/61aaaf/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog2022091161aaaf><span>深入Istio系列-Sidecar 中的流量类型及 iptables 规则详解</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20220911fe0ba1-li><a href=/blog/2022/09/11/fe0ba1/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20220911fe0ba1><span>深入Istio系列-Sidecar 注入、透明流量劫持及流量路由过程详解</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20220911dd0bd7-li><a href=/blog/2022/09/11/dd0bd7/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20220911dd0bd7><span>深入Istio系列-Sidecar自动注入</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20220911bf667a-li><a href=/blog/2022/09/11/bf667a/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20220911bf667a><span>Istio部署实战</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20220910dc5625-li><a href=/blog/2022/09/10/dc5625/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20220910dc5625><span>深入Istio系列-数据平面Pod启动过程详解</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20220910b7e1eb-li><a href=/blog/2022/09/10/b7e1eb/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20220910b7e1eb><span>理解Iptable</span></a></li></ul></li></ul></nav></div></aside><aside class="d-none d-xl-block col-xl-2 td-sidebar-toc d-print-none"><div class="td-page-meta ml-2 pb-1 pt-2 mb-0"></div><div class=td-toc><nav id=TableOfContents><ul><li><a href=#istio-中的组件及端口示意图>Istio 中的组件及端口示意图</a></li><li><a href=#istio-中各端口的功能概述>Istio 中各端口的功能概述</a></li><li><a href=#istiod-中的端口>Istiod 中的端口</a></li><li><a href=#sidecar-中的端口>Sidecar 中的端口</a></li><li><a href=#15000-端口>15000 端口</a></li><li><a href=#15004-端口>15004 端口</a></li><li><a href=#8080-端口>8080 端口</a></li><li><a href=#15020-端口>15020 端口</a></li><li><a href=#总结>总结</a></li></ul></nav></div><div class="taxonomy taxonomy-terms-cloud taxo-categories"><h5 class=taxonomy-title>Categories</h5><ul class=taxonomy-terms><li><a class=taxonomy-term href=https://sreionet.github.io/categories/hugo/ data-taxonomy-term=hugo><span class=taxonomy-label>hugo</span><span class=taxonomy-count>2</span></a></li><li><a class=taxonomy-term href=https://sreionet.github.io/categories/istio/ data-taxonomy-term=istio><span class=taxonomy-label>istio</span><span class=taxonomy-count>5</span></a></li><li><a class=taxonomy-term href=https://sreionet.github.io/categories/%E4%BA%91%E5%8E%9F%E7%94%9F/ data-taxonomy-term=%E4%BA%91%E5%8E%9F%E7%94%9F><span class=taxonomy-label>云原生</span><span class=taxonomy-count>10</span></a></li></ul></div><div class="taxonomy taxonomy-terms-cloud taxo-tags"><h5 class=taxonomy-title>Tags</h5><ul class=taxonomy-terms><li><a class=taxonomy-term href=https://sreionet.github.io/tags/envoy/ data-taxonomy-term=envoy><span class=taxonomy-label>envoy</span><span class=taxonomy-count>1</span></a></li><li><a class=taxonomy-term href=https://sreionet.github.io/tags/githubaction/ data-taxonomy-term=githubaction><span class=taxonomy-label>GithubAction</span><span class=taxonomy-count>1</span></a></li><li><a class=taxonomy-term href=https://sreionet.github.io/tags/hugo/ data-taxonomy-term=hugo><span class=taxonomy-label>hugo</span><span class=taxonomy-count>2</span></a></li><li><a class=taxonomy-term href=https://sreionet.github.io/tags/iptable/ data-taxonomy-term=iptable><span class=taxonomy-label>iptable</span><span class=taxonomy-count>1</span></a></li><li><a class=taxonomy-term href=https://sreionet.github.io/tags/istio/ data-taxonomy-term=istio><span class=taxonomy-label>istio</span><span class=taxonomy-count>11</span></a></li><li><a class=taxonomy-term href=https://sreionet.github.io/tags/istioctl/ data-taxonomy-term=istioctl><span class=taxonomy-label>istioctl</span><span class=taxonomy-count>1</span></a></li><li><a class=taxonomy-term href=https://sreionet.github.io/tags/metrics/ data-taxonomy-term=metrics><span class=taxonomy-label>metrics</span><span class=taxonomy-count>2</span></a></li><li><a class=taxonomy-term href=https://sreionet.github.io/tags/pilot/ data-taxonomy-term=pilot><span class=taxonomy-label>pilot</span><span class=taxonomy-count>1</span></a></li><li><a class=taxonomy-term href=https://sreionet.github.io/tags/sicader/ data-taxonomy-term=sicader><span class=taxonomy-label>sicader</span><span class=taxonomy-count>2</span></a></li><li><a class=taxonomy-term href=https://sreionet.github.io/tags/sidecar/ data-taxonomy-term=sidecar><span class=taxonomy-label>Sidecar</span><span class=taxonomy-count>1</span></a></li><li><a class=taxonomy-term href=https://sreionet.github.io/tags/%E8%BD%AC%E8%BD%BD/ data-taxonomy-term=%E8%BD%AC%E8%BD%BD><span class=taxonomy-label>转载</span><span class=taxonomy-count>7</span></a></li></ul></div></aside><main class="col-12 col-md-9 col-xl-8 pl-md-5 pr-md-4" role=main><a class=td-rss-button title=RSS href=https://sreionet.github.io/blog/index.xml target=_blank rel=noopener><i class="fa-solid fa-rss" aria-hidden=true></i></a><div class=td-content><h1>深入Istio系列-组件详解</h1><div class="td-byline mb-4"><b>kbsonlong</b> |
<time datetime=2022-09-12 class=text-muted>12.09.2022</time></div><header class=article-meta><div class="taxonomy taxonomy-terms-article taxo-categories"><h5 class=taxonomy-title>Categories:</h5><ul class=taxonomy-terms><li><a class=taxonomy-term href=https://sreionet.github.io/categories/%E4%BA%91%E5%8E%9F%E7%94%9F/ data-taxonomy-term=%E4%BA%91%E5%8E%9F%E7%94%9F><span class=taxonomy-label>云原生</span></a></li></ul></div><div class="taxonomy taxonomy-terms-article taxo-tags"><h5 class=taxonomy-title>Tags:</h5><ul class=taxonomy-terms><li><a class=taxonomy-term href=https://sreionet.github.io/tags/istio/ data-taxonomy-term=istio><span class=taxonomy-label>istio</span></a></li><li><a class=taxonomy-term href=https://sreionet.github.io/tags/sicader/ data-taxonomy-term=sicader><span class=taxonomy-label>sicader</span></a></li><li><a class=taxonomy-term href=https://sreionet.github.io/tags/%E8%BD%AC%E8%BD%BD/ data-taxonomy-term=%E8%BD%AC%E8%BD%BD><span class=taxonomy-label>转载</span></a></li></ul></div></header><p>在前两篇博客中：</p><ul><li><a href=/posts/fe0ba1/>Istio 中的 Sidecar 注入、透明流量劫持及流量路由过程详解</a></li><li><a href=/posts/61aaaf/>Sidecar 中的流量类型及 iptables 规则详解</a></li></ul><p>我向你详细介绍了 Istio 数据平面中的流量，但数据平面并不能孤立的存在，本文将向你展示 Istio 中的控制平面和数据平面各组件的端口及其功能，有助于你了解这些流量之间的关系及故障排查。</p><h2 id=istio-中的组件及端口示意图>Istio 中的组件及端口示意图</h2><p>按照习惯，我们首先展示一个全局示意图。下图展示的是 Istio 数据平面中 sidecar 的组成，以及与其交互的对象。</p><p><img src=https://raw.githubusercontent.com/kbsonlong/notes_statics/master/images/20220913145000.png alt="Istio sidecar 组成示意图"></p><p>我们可以使用 <code>nsenter</code> 命令进入Bookinfo 示例的 <code>productpage</code> Pod的网络空间，查看其内部监听的端口信息。</p><p><img src=https://raw.githubusercontent.com/kbsonlong/notes_statics/master/images/20220913145055.png alt="Istio sidecar 中监听的端口信息"></p><p>从图中我们可以看到除了 <code>productpage</code> 应用本身监听的 9080 端口以外，Sidecar 容器还有监听大量的其他端口，如 <code>15000</code>、<code>15001</code>、<code>15004</code>、<code>15006</code>、<code>15021</code>、<code>15090</code> 等，你可以在 <a href=https://istio.io/latest/docs/ops/deployment/requirements/>Istio 文档</a>上了解 Istio 中使用的端口。</p><p>我们再进入 <code>productpage</code> Pod 中，使用 <code>lsof -i</code> 命令查看它打开的端口，如下图所示。</p><p>!<img src=https://raw.githubusercontent.com/kbsonlong/notes_statics/master/images/20220913145153.png alt></p><p>我们可以看到其中有 <code>pilot-agent</code> 与 <code>istiod</code> 建立了 TCP 连接，上文中所述的监听中的端口，还有在 Pod 内部建立的 TCP 连接，这些连接对应了文章开头的示意图。</p><p>Sidecar 容器（<code>istio-proxy</code> ）的根进程是 <code>pilot-agent</code>，启动命令如下图所示：</p><p><img src=https://raw.githubusercontent.com/kbsonlong/notes_statics/master/images/20220913145247.png alt></p><p>从图中我们可以看到，它 <code>pilot-agent</code> 进程的 PID 是 1，是它拉起了 <code>envoy</code> 进程。</p><p>在 <code>istiod</code> 的 Pod 中查看它打开的端口，如下图所示。</p><p><img src=https://raw.githubusercontent.com/kbsonlong/notes_statics/master/images/20220913145322.png alt></p><p>我们可以看到其中的监听的端口、进程间和远程通信连接。</p><h2 id=istio-中各端口的功能概述>Istio 中各端口的功能概述</h2><p>这些端口在你进行问题排查时可以起着举足轻重的作用。下面将根据端口所在的组件和功能分类描述。</p><h2 id=istiod-中的端口>Istiod 中的端口</h2><p>Istiod 中的端口相对比较少且功能单一：</p><ul><li>9876：ControlZ 用户界面，暴露 <code>istiod</code> 的进程信息</li><li>8080：<code>istiod</code> 调试端口，通过该端口可以查询网格的配置和状态信息</li><li>15010：暴露 xDS API 和颁发纯文本证书</li><li>15012：功能同 15010 端口，但使用 TLS 通信</li><li>15014：暴露控制平面的指标给 Prometheus</li><li>15017：Sidecar 注入和配置校验端口</li></ul><h2 id=sidecar-中的端口>Sidecar 中的端口</h2><p>从上文中，我们看到 sidecar 中有众多端口：</p><ul><li>15000：Envoy <a href=https://jimmysong.io/envoy-handbook/admin-interface/enabling-admin-interface.html>管理接口</a>，你可以用它来查询和修改 Envoy 代理的的配置，详情请参考 <a href=https://www.envoyproxy.io/docs/envoy/latest/operations/admin>Envoy 文档</a>。</li><li>15001：用于处理出站流量。</li><li>15004：调试端口，将在下文中解释。</li><li>15006：用于处理入站流量。</li><li>15020：汇总统计数据，对 Envoy 和 DNS 代理进行健康检查，调试 <code>pilot-agent</code> 进程，将在下文中详细解释。</li><li>15021：用于 sidecar 健康检查，以判断已注入 Pod 是否准备好接收流量。我们在该端口的 <code>/healthz/ready</code> 路径上设置了就绪探针，Istio 把 sidecar 的就绪检测交给了 <code>kubelet</code>，最大化利用 Kubernetes 平台自身的功能。<code>envoy</code> 进程将健康检查路由到 <code>pilot-agent</code> 进程的 15020 端口，实际的健康检查将发生在那里。</li><li>15053：本地 DNS 代理，用于解析 Kubernetes DNS 解析不了的集群内部域名的场景。</li><li>15090：Envoy Prometheus 查询端口，<code>pilot-agent</code> 将通过此端口收集统计信息。</li></ul><p>以上端口可以分为以下几类：</p><ul><li>负责进程间通信，例如 15001、15006、15053</li><li>负责健康检查和信息统计，例如 150021、15090</li><li>调试：15000、15004</li></ul><p>下文将对几个重点端口详解。</p><h2 id=15000-端口>15000 端口</h2><p>15000 是 Envoy 的 Admin 接口，该接口允许我们修改 Envoy，并获得一个视图和查询指标和配置。</p><p>管理接口由一个具有多个端点的 REST API 和一个简单的用户界面组成，你可以使用下面的命令开启 <code>productpage</code> Pod 中的 Envoy 管理接口视图。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl -n default port-forward deploy/productpage-v1 <span style=color:#ae81ff>15000</span>
</span></span></code></pre></div><p>在浏览器中访问 <code>http://localhost:15000</code>，你将看到 Envoy Admin 界面如下图所示。</p><p><img src=https://raw.githubusercontent.com/kbsonlong/notes_statics/master/images/20220913145353.png alt></p><h2 id=15004-端口>15004 端口</h2><p>通过 <code>pilot-agent</code> 代理 <code>istiod</code> 8080 端口上的调试端点，你可以进入数据平面 Pod 中访问 localhost 的 15004 端口查询网格信息，其效果与下面的 8080 端口等同。</p><h2 id=8080-端口>8080 端口</h2><p>你还可以在本地转发 <code>istiod</code> 8080 端口，请运行下面的命令。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl -n istio-system port-forward deploy/istiod <span style=color:#ae81ff>8080</span>
</span></span></code></pre></div><p>在浏览器中访问 <code>http://localhost:8080/debug</code>，你将看到调试端点，如下图所示。</p><p><img src=https://raw.githubusercontent.com/kbsonlong/notes_statics/master/images/20220913145416.png alt></p><p>当然，这只是一种获取网格信息和调试网格的方式，你还可以使用 <code>istioctl</code> 命令或 Kiali 来调试，那样将更加高效和直观。</p><h2 id=15020-端口>15020 端口</h2><p>15020 端口有三大功能：</p><ol><li>汇总统计数据：查询 15090 端口获取 <code>envoy</code> 的指标，也可以配置查询应用程序的指标，将 <code>envoy</code>、应用程序和自身的指标汇总以供 Prometheus 收集。对应的调试端点是 <code>/stats/prometheus</code>。</li><li>对 Envoy 和 DNS 代理进行健康检查：对应的调试端点是 <code>/healthz/ready</code> 和 <code>/app-health</code>。</li><li>调试 <code>pilot-agent</code> 进程：对应的调试端点是 <code>/quitquitquit</code>、<code>debug/ndsz</code> 和 <code>/debug/pprof</code>。</li></ol><p>下图展示的是使用本地端口转发后，在浏览器中打开 <code>http://localhost:15020/debug/pprof</code> 看到的调试信息。</p><p><img src=https://raw.githubusercontent.com/kbsonlong/notes_statics/master/images/20220913145443.png alt></p><p>图中信息展示的是 <code>pilot-agent</code> 的堆栈信息。</p><h2 id=总结>总结</h2><p>通过对 Istio 中各组件端口的了解，你应该对 Istio 中各组件的关系及其内部流量有了更进一步的认识，熟悉这些端口的功能，有助于对网格的故障排除。</p><ul class="list-unstyled d-flex justify-content-between align-items-center mb-0 pt-5"><li><a href=/blog/2022/09/11/61aaaf/ aria-label=" - 深入Istio系列-Sidecar 中的流量类型及 iptables 规则详解" class="btn btn-primary"><span class=mr-1>←</span></a></li><li><a href=/blog/2022/09/13/0affe7/ aria-label=" - Envoy性能指标" class="btn btn-primary"><span class=ml-1>→</span></a></li></ul></div></main></div></div><footer class="bg-dark py-5 row d-print-none"><div class="container-fluid mx-sm-5"><div class=row><div class="col-6 col-sm-4 text-xs-center order-sm-2"></div><div class="col-6 col-sm-4 text-right text-xs-center order-sm-3"></div><div class="col-12 col-sm-4 text-center py-2 order-sm-2"><small class=text-white>&copy; 2023 The Docsy Authors</small>
<small class=ml-1><a href=https://policies.google.com/privacy target=_blank rel=noopener></a></small></div></div></div></footer></div><script src=/js/main.min.3e4a6958dccc830952d0c30c43229e6e16b26815c56825ee1948e84372c67feb.js integrity="sha256-PkppWNzMgwlS0MMMQyKebhayaBXFaCXuGUjoQ3LGf+s=" crossorigin=anonymous></script>
<script src=/js/tabpane-persist.js></script></body></html>