<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>云原生技术圈 – pilot</title><link>https://sreionet.github.io/tags/pilot/</link><description>Recent content in pilot on 云原生技术圈</description><generator>Hugo -- gohugo.io</generator><language>zh-CN</language><lastBuildDate>Fri, 16 Sep 2022 17:25:59 +0800</lastBuildDate><atom:link href="https://sreionet.github.io/tags/pilot/index.xml" rel="self" type="application/rss+xml"/><item><title>Blog: 深入Istio系列-Pilot agent</title><link>https://sreionet.github.io/blog/2022/09/16/3d18d6/</link><pubDate>Fri, 16 Sep 2022 17:25:59 +0800</pubDate><guid>https://sreionet.github.io/blog/2022/09/16/3d18d6/</guid><description>
&lt;h3 id="查看监听端口和进程">查看监听端口和进程&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>istio-proxy@istio-ingressgateway-799bbc9474-hf7kv:/$ ss -ntlp
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>State Recv-Q Send-Q Local Address:Port Peer Address:Port Process
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>LISTEN &lt;span style="color:#ae81ff">0&lt;/span> &lt;span style="color:#ae81ff">128&lt;/span> 127.0.0.1:15000 0.0.0.0:* users:&lt;span style="color:#f92672">((&lt;/span>&lt;span style="color:#e6db74">&amp;#34;envoy&amp;#34;&lt;/span>,pid&lt;span style="color:#f92672">=&lt;/span>16,fd&lt;span style="color:#f92672">=&lt;/span>18&lt;span style="color:#f92672">))&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>LISTEN &lt;span style="color:#ae81ff">0&lt;/span> &lt;span style="color:#ae81ff">128&lt;/span> 127.0.0.1:15004 0.0.0.0:* users:&lt;span style="color:#f92672">((&lt;/span>&lt;span style="color:#e6db74">&amp;#34;pilot-agent&amp;#34;&lt;/span>,pid&lt;span style="color:#f92672">=&lt;/span>1,fd&lt;span style="color:#f92672">=&lt;/span>15&lt;span style="color:#f92672">))&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>LISTEN &lt;span style="color:#ae81ff">0&lt;/span> &lt;span style="color:#ae81ff">128&lt;/span> 0.0.0.0:15021 0.0.0.0:* users:&lt;span style="color:#f92672">((&lt;/span>&lt;span style="color:#e6db74">&amp;#34;envoy&amp;#34;&lt;/span>,pid&lt;span style="color:#f92672">=&lt;/span>16,fd&lt;span style="color:#f92672">=&lt;/span>24&lt;span style="color:#f92672">))&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>LISTEN &lt;span style="color:#ae81ff">0&lt;/span> &lt;span style="color:#ae81ff">128&lt;/span> 0.0.0.0:15021 0.0.0.0:* users:&lt;span style="color:#f92672">((&lt;/span>&lt;span style="color:#e6db74">&amp;#34;envoy&amp;#34;&lt;/span>,pid&lt;span style="color:#f92672">=&lt;/span>16,fd&lt;span style="color:#f92672">=&lt;/span>23&lt;span style="color:#f92672">))&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>LISTEN &lt;span style="color:#ae81ff">0&lt;/span> &lt;span style="color:#ae81ff">128&lt;/span> 0.0.0.0:8080 0.0.0.0:* users:&lt;span style="color:#f92672">((&lt;/span>&lt;span style="color:#e6db74">&amp;#34;envoy&amp;#34;&lt;/span>,pid&lt;span style="color:#f92672">=&lt;/span>16,fd&lt;span style="color:#f92672">=&lt;/span>40&lt;span style="color:#f92672">))&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>LISTEN &lt;span style="color:#ae81ff">0&lt;/span> &lt;span style="color:#ae81ff">128&lt;/span> 0.0.0.0:8080 0.0.0.0:* users:&lt;span style="color:#f92672">((&lt;/span>&lt;span style="color:#e6db74">&amp;#34;envoy&amp;#34;&lt;/span>,pid&lt;span style="color:#f92672">=&lt;/span>16,fd&lt;span style="color:#f92672">=&lt;/span>39&lt;span style="color:#f92672">))&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>LISTEN &lt;span style="color:#ae81ff">0&lt;/span> &lt;span style="color:#ae81ff">128&lt;/span> 0.0.0.0:15090 0.0.0.0:* users:&lt;span style="color:#f92672">((&lt;/span>&lt;span style="color:#e6db74">&amp;#34;envoy&amp;#34;&lt;/span>,pid&lt;span style="color:#f92672">=&lt;/span>16,fd&lt;span style="color:#f92672">=&lt;/span>22&lt;span style="color:#f92672">))&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>LISTEN &lt;span style="color:#ae81ff">0&lt;/span> &lt;span style="color:#ae81ff">128&lt;/span> 0.0.0.0:15090 0.0.0.0:* users:&lt;span style="color:#f92672">((&lt;/span>&lt;span style="color:#e6db74">&amp;#34;envoy&amp;#34;&lt;/span>,pid&lt;span style="color:#f92672">=&lt;/span>16,fd&lt;span style="color:#f92672">=&lt;/span>21&lt;span style="color:#f92672">))&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>LISTEN &lt;span style="color:#ae81ff">0&lt;/span> &lt;span style="color:#ae81ff">128&lt;/span> *:15020 *:* users:&lt;span style="color:#f92672">((&lt;/span>&lt;span style="color:#e6db74">&amp;#34;pilot-agent&amp;#34;&lt;/span>,pid&lt;span style="color:#f92672">=&lt;/span>1,fd&lt;span style="color:#f92672">=&lt;/span>12&lt;span style="color:#f92672">))&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>istio-proxy@istio-ingressgateway-799bbc9474-hf7kv:/$ ps -ef |grep pilot-agent
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>istio-p+ &lt;span style="color:#ae81ff">1&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span> Sep14 ? 00:01:27 /usr/local/bin/pilot-agent proxy router --domain istio-system.svc.cluster.local --proxyLogLevel&lt;span style="color:#f92672">=&lt;/span>warning --proxyComponentLogLevel&lt;span style="color:#f92672">=&lt;/span>misc:error --log_output_level&lt;span style="color:#f92672">=&lt;/span>default:info
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>istio-p+ &lt;span style="color:#ae81ff">74&lt;/span> &lt;span style="color:#ae81ff">30&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span> 09:37 pts/0 00:00:00 grep --color&lt;span style="color:#f92672">=&lt;/span>auto pilot-agent
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>
&lt;figure>
&lt;img src="https://raw.githubusercontent.com/kbsonlong/notes_statics/master/images/20220916173915.png"/>
&lt;/figure>
&lt;h3 id="pilot-agent-proxy-router-启动参数">pilot-agent proxy router 启动参数&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>istio-proxy@istio-ingressgateway-799bbc9474-hf7kv:/$ /usr/local/bin/pilot-agent proxy router --help
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>XDS proxy agent
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Usage:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> pilot-agent proxy &lt;span style="color:#f92672">[&lt;/span>flags&lt;span style="color:#f92672">]&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Flags:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> --concurrency int number of worker threads to run
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> --domain string DNS domain suffix. If not provided uses &lt;span style="color:#e6db74">${&lt;/span>POD_NAMESPACE&lt;span style="color:#e6db74">}&lt;/span>.svc.cluster.local
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> -h, --help help &lt;span style="color:#66d9ef">for&lt;/span> proxy
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> --meshConfig string File name &lt;span style="color:#66d9ef">for&lt;/span> Istio mesh configuration. If not specified, a default mesh will be used. This may be overridden by PROXY_CONFIG environment variable or proxy.istio.io/config annotation. &lt;span style="color:#f92672">(&lt;/span>default &lt;span style="color:#e6db74">&amp;#34;./etc/istio/config/mesh&amp;#34;&lt;/span>&lt;span style="color:#f92672">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> --outlierLogPath string The log path &lt;span style="color:#66d9ef">for&lt;/span> outlier detection
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> --proxyComponentLogLevel string The component log level used to start the Envoy proxy. Deprecated, use proxyLogLevel instead
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> --proxyLogLevel string The log level used to start the Envoy proxy &lt;span style="color:#f92672">(&lt;/span>choose from &lt;span style="color:#f92672">{&lt;/span>trace, debug, info, warning, error, critical, off&lt;span style="color:#f92672">})&lt;/span>.Level may also include one or more scopes, such as &lt;span style="color:#e6db74">&amp;#39;info,misc:error,upstream:debug&amp;#39;&lt;/span> &lt;span style="color:#f92672">(&lt;/span>default &lt;span style="color:#e6db74">&amp;#34;warning,misc:error&amp;#34;&lt;/span>&lt;span style="color:#f92672">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> --serviceCluster string Service cluster &lt;span style="color:#f92672">(&lt;/span>default &lt;span style="color:#e6db74">&amp;#34;istio-proxy&amp;#34;&lt;/span>&lt;span style="color:#f92672">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> --stsPort int HTTP Port on which to serve Security Token Service &lt;span style="color:#f92672">(&lt;/span>STS&lt;span style="color:#f92672">)&lt;/span>. If zero, STS service will not be provided.
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> --templateFile string Go template bootstrap config
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> --tokenManagerPlugin string Token provider specific plugin name. &lt;span style="color:#f92672">(&lt;/span>default &lt;span style="color:#e6db74">&amp;#34;GoogleTokenExchange&amp;#34;&lt;/span>&lt;span style="color:#f92672">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Global Flags:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> --log_as_json Whether to format output as JSON or in plain console-friendly format
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> --log_caller string Comma-separated list of scopes &lt;span style="color:#66d9ef">for&lt;/span> which to include caller information, scopes can be any of &lt;span style="color:#f92672">[&lt;/span>ads, all, authn, authorization, ca, cache, citadelclient, controllers, default, delta, dns, gcecred, googleca, googlecas, grpcgen, healthcheck, iptables, klog, mockcred, model, proxyconfig, sds, security, serviceentry, spiffe, stsclient, stsserver, telemetry, token, trustBundle, validation, wasm, wle, xdsproxy&lt;span style="color:#f92672">]&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> --log_output_level string Comma-separated minimum per-scope logging level of messages to output, in the form of &amp;lt;scope&amp;gt;:&amp;lt;level&amp;gt;,&amp;lt;scope&amp;gt;:&amp;lt;level&amp;gt;,... where scope can be one of &lt;span style="color:#f92672">[&lt;/span>ads, all, authn, authorization, ca, cache, citadelclient, controllers, default, delta, dns, gcecred, googleca, googlecas, grpcgen, healthcheck, iptables, klog, mockcred, model, proxyconfig, sds, security, serviceentry, spiffe, stsclient, stsserver, telemetry, token, trustBundle, validation, wasm, wle, xdsproxy&lt;span style="color:#f92672">]&lt;/span> and level can be one of &lt;span style="color:#f92672">[&lt;/span>debug, info, warn, error, fatal, none&lt;span style="color:#f92672">]&lt;/span> &lt;span style="color:#f92672">(&lt;/span>default &lt;span style="color:#e6db74">&amp;#34;default:info&amp;#34;&lt;/span>&lt;span style="color:#f92672">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> --log_rotate string The path &lt;span style="color:#66d9ef">for&lt;/span> the optional rotating log file
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> --log_rotate_max_age int The maximum age in days of a log file beyond which the file is rotated &lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#ae81ff">0&lt;/span> indicates no limit&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">(&lt;/span>default 30&lt;span style="color:#f92672">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> --log_rotate_max_backups int The maximum number of log file backups to keep before older files are deleted &lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#ae81ff">0&lt;/span> indicates no limit&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">(&lt;/span>default 1000&lt;span style="color:#f92672">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> --log_rotate_max_size int The maximum size in megabytes of a log file beyond which the file is rotated &lt;span style="color:#f92672">(&lt;/span>default 104857600&lt;span style="color:#f92672">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> --log_stacktrace_level string Comma-separated minimum per-scope logging level at which stack traces are captured, in the form of &amp;lt;scope&amp;gt;:&amp;lt;level&amp;gt;,&amp;lt;scope:level&amp;gt;,... where scope can be one of &lt;span style="color:#f92672">[&lt;/span>ads, all, authn, authorization, ca, cache, citadelclient, controllers, default, delta, dns, gcecred, googleca, googlecas, grpcgen, healthcheck, iptables, klog, mockcred, model, proxyconfig, sds, security, serviceentry, spiffe, stsclient, stsserver, telemetry, token, trustBundle, validation, wasm, wle, xdsproxy&lt;span style="color:#f92672">]&lt;/span> and level can be one of &lt;span style="color:#f92672">[&lt;/span>debug, info, warn, error, fatal, none&lt;span style="color:#f92672">]&lt;/span> &lt;span style="color:#f92672">(&lt;/span>default &lt;span style="color:#e6db74">&amp;#34;default:none&amp;#34;&lt;/span>&lt;span style="color:#f92672">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> --log_target stringArray The set of paths where to output the log. This can be any path as well as the special values stdout and stderr &lt;span style="color:#f92672">(&lt;/span>default &lt;span style="color:#f92672">[&lt;/span>stdout&lt;span style="color:#f92672">])&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> --vklog Level number &lt;span style="color:#66d9ef">for&lt;/span> the log level verbosity. Like -v flag. ex: --vklog&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#ae81ff">9&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>istio-proxy@istio-ingressgateway-799bbc9474-hf7kv:/$
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>
&lt;figure>
&lt;img src="https://raw.githubusercontent.com/kbsonlong/notes_statics/master/images/20220916174047.png"/> &lt;figcaption>
&lt;h4>20220916174047&lt;/h4>
&lt;/figcaption>
&lt;/figure>
&lt;h3 id="查看meshconfig配置">查看meshconfig配置&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>istio-proxy@istio-ingressgateway-799bbc9474-hf7kv:/$ cat ./etc/istio/config/mesh
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>accessLogFile: /dev/stdout
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>defaultConfig:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> discoveryAddress: istiod.istio-system.svc:15012
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> proxyMetadata: &lt;span style="color:#f92672">{}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> tracing:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> zipkin:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> address: zipkin.istio-system:9411
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>enablePrometheusMerge: true
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>extensionProviders:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>- envoyOtelAls:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> port: &lt;span style="color:#ae81ff">4317&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> service: opentelemetry-collector.istio-system.svc.cluster.local
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> name: otel
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>rootNamespace: istio-system
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>trustDomain: cluster.local
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>istio-proxy@istio-ingressgateway-799bbc9474-hf7kv:/$
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>
&lt;figure>
&lt;img src="https://raw.githubusercontent.com/kbsonlong/notes_statics/master/images/20220916174246.png"/> &lt;figcaption>
&lt;h4>20220916174246&lt;/h4>
&lt;/figcaption>
&lt;/figure></description></item></channel></rss>