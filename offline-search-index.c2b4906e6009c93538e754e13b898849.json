[{"body":"","categories":"","description":"","excerpt":"","ref":"/categories/","tags":"","title":"Categories"},{"body":"","categories":"","description":"","excerpt":"","ref":"/categories/istio/","tags":"","title":"istio"},{"body":"","categories":"","description":"","excerpt":"","ref":"/tags/istio/","tags":"","title":"istio"},{"body":"背景 istio 版本: 1.13.4\naeraki 版本: 1.1.5\n业务反馈在测试过程中发现 istio_request_total 指标查找不到,通过Prometheus查看发现这个指标部分服务是正常采集上报。\n通过 istioctl ps 预览集群状态 # ./istioctl ps NAME CLUSTER CDS LDS EDS RDS ISTIOD VERSION test-1.istio-system NOT SENT NOT SENT NOT SENT NOT SENT istiod-66bd9d59d8-k6qzk 65536.65536.65536 test-1.istio-system NOT SENT NOT SENT NOT SENT NOT SENT istiod-66bd9d59d8-k6qzk 65536.65536.65536 components-comsumer-sfkt-default-test-rfgds.components-nacos Kubernetes SYNCED SYNCED SYNCED SYNCED istiod-66bd9d59d8-k6qzk 1.14-dev components-provider-sfkt-default-test-6gw8b.components-nacos Kubernetes SYNCED SYNCED SYNCED SYNCED istiod-66bd9d59d8-k6qzk 1.14-dev components-server-sfkt-default-test-frjwm.components-nacos Kubernetes SYNCED SYNCED SYNCED SYNCED istiod-66bd9d59d8-k6qzk 1.14-dev istio-egressgateway-c5b57c584-rz9rw.istio-system Kubernetes SYNCED SYNCED SYNCED NOT SENT istiod-66bd9d59d8-k6qzk 1.13.4 istio-ingressgateway-7767c959b4-jkbgb.istio-system Kubernetes SYNCED SYNCED SYNCED NOT SENT istiod-66bd9d59d8-k6qzk 1.13.4 mesh-demo-dubbo-consumer-test-rpzzh.pulsar-manager Kubernetes SYNCED SYNCED SYNCED SYNCED istiod-66bd9d59d8-k6qzk 1.14-dev mesh-demo-dubbo-pv1111-test-rfmtg.pulsar-manager Kubernetes SYNCED SYNCED SYNCED SYNCED istiod-66bd9d59d8-k6qzk 1.14-dev mesh-demo-dubbo-pv2-test-gjhwb.pulsar-manager Kubernetes SYNCED SYNCED SYNCED SYNCED istiod-66bd9d59d8-k6qzk 1.14-dev mesh-demo-httpv1-test-8b7f5.pulsar-manager Kubernetes SYNCED SYNCED SYNCED SYNCED istiod-66bd9d59d8-k6qzk 1.14-dev mesh-demo-httpv2-test-qlkhb.pulsar-manager Kubernetes SYNCED SYNCED SYNCED SYNCED istiod-66bd9d59d8-k6qzk 1.14-dev sl-job-agentd-sl-job-agentd-test-fskpl-lg8hq.sl-devops Kubernetes SYNCED SYNCED SYNCED SYNCED istiod-66bd9d59d8-k6qzk 1.12-dev sl-job-agentd-sl-job-server-test-fskpl-z5b4t.sl-devops Kubernetes SYNCED SYNCED SYNCED SYNCED istiod-66bd9d59d8-k6qzk 1.12-dev sl-job-web-api-sl-job-web-api-dev-2pm6n.sl-devops Kubernetes SYNCED SYNCED SYNCED SYNCED istiod-66bd9d59d8-k6qzk 1.12-dev 可以看到整个istio 集群下存在多个版本，其中 1.13.4 是属于istio正常安装版本，发现 1.12-dev pod能够正常上报 istio_request_total 指标,而 1.14-dev 没有正常上报。那么 1.12-dev 和 1.14-dev 是怎么来的呢？查看这些pod的使用的 istio-proxy 的镜像是 aeraki 项目下的 meta-protocol-proxy 代理镜像，并且使用的版本不一致，将无法正常上报指标的 istio-proxy 镜像修改后可以正常查看指标。\n# kubectl get pod -n ns sl-starter-mesh-demo-sfkt-deve-default-deve-8hlgb -o yaml|more apiVersion: v1 kind: Pod metadata:  annotations:  kubectl.kubernetes.io/default-container: sl-starter-mesh-demo-hades  kubectl.kubernetes.io/default-logs-container: sl-starter-mesh-demo-hades  lifecycle.apps.kruise.io/timestamp: \"2023-01-03T07:45:40Z\"  lxcfs-admission-webhook.aliyun.com/status: mutated  prometheus.io/path: /stats/prometheus  prometheus.io/port: \"15020\"  prometheus.io/scrape: \"true\"  sidecar.istio.io/bootstrapOverride: aeraki-bootstrap-config  sidecar.istio.io/inject: \"true\"  sidecar.istio.io/proxyImage: aeraki/meta-protocol-proxy-debug:1.1.2 ... ...  # kubectl get pod -n ns components-comsumer-sfkt-default-test-rfgds -o yaml|more apiVersion: v1 kind: Pod metadata:  annotations:  kubectl.kubernetes.io/default-container: components-comsumer  kubectl.kubernetes.io/default-logs-container: components-comsumer  lifecycle.apps.kruise.io/timestamp: \"2023-01-12T05:32:51Z\"  lxcfs-admission-webhook.aliyun.com/status: mutated  prometheus.io/path: /stats/prometheus  prometheus.io/port: \"15020\"  prometheus.io/scrape: \"true\"  sidecar.istio.io/bootstrapOverride: aeraki-bootstrap-config  sidecar.istio.io/inject: \"true\"  sidecar.istio.io/proxyImage: aeraki/meta-protocol-proxy-debug:1.1.5 ... ... 根本原因 通过Istio官方文档发现istio默认指标也是由 EnvoyFilter 控制采集，集群内安装的是1.13.4,默认配置了1.11、1.12和1.13版本的，但是没有1.14版本的，而 aeraki/meta-protocol-proxy-debug:1.1.5 是基于 istio 1.14版本开发的，由于没有集群内没有配置1.14版本的 EnvoyFilter,所以最终导致1.12版本的proxy可以正常上报指标，1.14版本的proxy没有正常上报指标\n# kubectl get envoyfilter -n istio-system NAME AGE stats-filter-1.11 69d stats-filter-1.12 69d stats-filter-1.13 69d tcp-stats-filter-1.11 69d tcp-stats-filter-1.12 69d tcp-stats-filter-1.13 69d   # kubectl get envoyfilter -n istio-system NAME AGE stats-filter-1.11 69d stats-filter-1.12 69d stats-filter-1.13 69d stats-filter-1.14 2m15s tcp-stats-filter-1.11 69d tcp-stats-filter-1.12 69d tcp-stats-filter-1.13 69d tcp-stats-filter-1.14 2m8s 添加1.14版本相关的 EnvoyFilter 之后指标可以正常上报\n# curl 10.98.211.214:15020/stats/prometheus|grep istio_request|more  % Total % Received % Xferd Average Speed Time Time Time Current  Dload Upload Total Spent Left Speed 100 13666 0 13666 0 0 23879 0 --:--:-- --:--:-- --:--:-- 23849# TYPE istio_requests_total counter istio_requests_total{response_code=\"200\",reporter=\"destination\",source_workload=\"components-server-sfkt-default-test\",source_workload_namespace=\"components-nacos\",source_pr incipal=\"spiffe://kubeyy.com/ns/components-nacos/sa/default\",source_app=\"components-server-sfkt-default-test\",source_version=\"unknown\",source_cluster=\"Kubernetes\",destinati on_workload=\"components-comsumer-sfkt-default-test\",destination_workload_namespace=\"components-nacos\",destination_principal=\"spiffe://kubeyy.com/ns/components-nacos/sa/defa ult\",destination_app=\"components-comsumer-sfkt-default-test\",destination_version=\"unknown\",destination_service=\"components-comsumer-test-ps.components-nacos.svc.kubeyy.com\" ,destination_service_name=\"components-comsumer-test-ps\",destination_service_namespace=\"components-nacos\",destination_cluster=\"Kubernetes\",request_protocol=\"http\",response_f lags=\"-\",grpc_response_status=\"\",connection_security_policy=\"mutual_tls\",source_canonical_service=\"components-server-sfkt-default-test\",destination_canonical_service=\"compo nents-comsumer-sfkt-default-test\",source_canonical_revision=\"latest\",destination_canonical_revision=\"latest\"} 699 istio_requests_total{response_code=\"200\",reporter=\"destination\",source_workload=\"unknown\",source_workload_namespace=\"unknown\",source_principal=\"unknown\",source_app=\"unknown \",source_version=\"unknown\",source_cluster=\"unknown\",destination_workload=\"components-comsumer-sfkt-default-test\",destination_workload_namespace=\"components-nacos\",destinati on_principal=\"unknown\",destination_app=\"components-comsumer-sfkt-default-test\",destination_version=\"unknown\",destination_service=\"svc-metrics-components-nacos-test.componen ts-nacos.svc.kubeyy.com\",destination_service_name=\"svc-metrics-components-nacos-test\",destination_service_namespace=\"components-nacos\",destination_cluster=\"Kubernetes\",requ est_protocol=\"http\",response_flags=\"-\",grpc_response_status=\"\",connection_security_policy=\"none\",source_canonical_service=\"unknown\",destination_canonical_service=\"component s-comsumer-sfkt-default-test\",source_canonical_revision=\"latest\",destination_canonical_revision=\"latest\"} 2 ","categories":["istio"],"description":"","excerpt":"背景 istio 版本: 1.13.4\naeraki 版本: 1.1.5\n业务反馈在测试过程中发现 istio_request_total  …","ref":"/blog/2023/01/12/istio%E5%8F%AF%E8%A7%82%E6%B5%8B%E6%80%A7%E7%B3%BB%E5%88%97-%E7%9B%91%E6%8E%A7%E6%8C%87%E6%A0%87%E6%B2%A1%E6%9C%89%E4%B8%8A%E6%8A%A5/","tags":["istio","metrics"],"title":"Istio可观测性系列-监控指标没有上报"},{"body":"","categories":"","description":"","excerpt":"","ref":"/tags/metrics/","tags":"","title":"metrics"},{"body":"test 1234\n","categories":"","description":"","excerpt":"test 1234\n","ref":"/","tags":"","title":"mydocsy"},{"body":"","categories":"","description":"","excerpt":"","ref":"/tags/","tags":"","title":"Tags"},{"body":"","categories":"","description":"A special section with a docs layout.\n","excerpt":"A special section with a docs layout.\n","ref":"/blog/","tags":"","title":"博客"},{"body":"默认情况下，Istio 定义并生成一组标准指标\nistio 默认指标 stats-filter-\u003cistio_version\u003e  cat \u003c\u003c EOF | kubectl apply -f -  apiVersion: networking.istio.io/v1alpha3 kind: EnvoyFilter metadata:  labels:  istio.io/rev: default  name: stats-filter-1.14  namespace: istio-system spec:  configPatches:  - applyTo: HTTP_FILTER  match:  context: SIDECAR_OUTBOUND  listener:  filterChain:  filter:  name: envoy.filters.network.http_connection_manager  subFilter:  name: envoy.filters.http.router  proxy:  proxyVersion: ^1\\.14.*  patch:  operation: INSERT_BEFORE  value:  name: istio.stats  typed_config:  '@type': type.googleapis.com/udpa.type.v1.TypedStruct  type_url: type.googleapis.com/envoy.extensions.filters.http.wasm.v3.Wasm  value:  config:  configuration:  '@type': type.googleapis.com/google.protobuf.StringValue  value: |{ \"debug\": \"false\", \"stat_prefix\": \"istio\" }  root_id: stats_outbound  vm_config:  code:  local:  inline_string: envoy.wasm.stats  runtime: envoy.wasm.runtime.null  vm_id: stats_outbound  - applyTo: HTTP_FILTER  match:  context: SIDECAR_INBOUND  listener:  filterChain:  filter:  name: envoy.filters.network.http_connection_manager  subFilter:  name: envoy.filters.http.router  proxy:  proxyVersion: ^1\\.14.*  patch:  operation: INSERT_BEFORE  value:  name: istio.stats  typed_config:  '@type': type.googleapis.com/udpa.type.v1.TypedStruct  type_url: type.googleapis.com/envoy.extensions.filters.http.wasm.v3.Wasm  value:  config:  configuration:  '@type': type.googleapis.com/google.protobuf.StringValue  value: |{ \"debug\": \"false\", \"stat_prefix\": \"istio\", \"disable_host_header_fallback\": true, \"metrics\": [ { \"dimensions\": { \"destination_cluster\": \"node.metadata['CLUSTER_ID']\", \"source_cluster\": \"downstream_peer.cluster_id\" } } ] }  root_id: stats_inbound  vm_config:  code:  local:  inline_string: envoy.wasm.stats  runtime: envoy.wasm.runtime.null  vm_id: stats_inbound  - applyTo: HTTP_FILTER  match:  context: GATEWAY  listener:  filterChain:  filter:  name: envoy.filters.network.http_connection_manager  subFilter:  name: envoy.filters.http.router  proxy:  proxyVersion: ^1\\.14.*  patch:  operation: INSERT_BEFORE  value:  name: istio.stats  typed_config:  '@type': type.googleapis.com/udpa.type.v1.TypedStruct  type_url: type.googleapis.com/envoy.extensions.filters.http.wasm.v3.Wasm  value:  config:  configuration:  '@type': type.googleapis.com/google.protobuf.StringValue  value: |{ \"debug\": \"false\", \"stat_prefix\": \"istio\", \"disable_host_header_fallback\": true }  root_id: stats_outbound  vm_config:  code:  local:  inline_string: envoy.wasm.stats  runtime: envoy.wasm.runtime.null  vm_id: stats_outbound  priority: -1  EOF tcp-stats-filter-\u003cistio_version\u003e cat \u003c\u003c EOF | kubectl apply -f -  apiVersion: networking.istio.io/v1alpha3 kind: EnvoyFilter metadata:  labels:  istio.io/rev: default  name: tcp-stats-filter-1.14  namespace: istio-system spec:  configPatches:  - applyTo: NETWORK_FILTER  match:  context: SIDECAR_INBOUND  listener:  filterChain:  filter:  name: envoy.filters.network.tcp_proxy  proxy:  proxyVersion: ^1\\.14.*  patch:  operation: INSERT_BEFORE  value:  name: istio.stats  typed_config:  '@type': type.googleapis.com/udpa.type.v1.TypedStruct  type_url: type.googleapis.com/envoy.extensions.filters.network.wasm.v3.Wasm  value:  config:  configuration:  '@type': type.googleapis.com/google.protobuf.StringValue  value: |{ \"debug\": \"false\", \"stat_prefix\": \"istio\", \"metrics\": [ { \"dimensions\": { \"destination_cluster\": \"node.metadata['CLUSTER_ID']\", \"source_cluster\": \"downstream_peer.cluster_id\" } } ] }  root_id: stats_inbound  vm_config:  code:  local:  inline_string: envoy.wasm.stats  runtime: envoy.wasm.runtime.null  vm_id: tcp_stats_inbound  - applyTo: NETWORK_FILTER  match:  context: SIDECAR_OUTBOUND  listener:  filterChain:  filter:  name: envoy.filters.network.tcp_proxy  proxy:  proxyVersion: ^1\\.14.*  patch:  operation: INSERT_BEFORE  value:  name: istio.stats  typed_config:  '@type': type.googleapis.com/udpa.type.v1.TypedStruct  type_url: type.googleapis.com/envoy.extensions.filters.network.wasm.v3.Wasm  value:  config:  configuration:  '@type': type.googleapis.com/google.protobuf.StringValue  value: |{ \"debug\": \"false\", \"stat_prefix\": \"istio\" }  root_id: stats_outbound  vm_config:  code:  local:  inline_string: envoy.wasm.stats  runtime: envoy.wasm.runtime.null  vm_id: tcp_stats_outbound  - applyTo: NETWORK_FILTER  match:  context: GATEWAY  listener:  filterChain:  filter:  name: envoy.filters.network.tcp_proxy  proxy:  proxyVersion: ^1\\.14.*  patch:  operation: INSERT_BEFORE  value:  name: istio.stats  typed_config:  '@type': type.googleapis.com/udpa.type.v1.TypedStruct  type_url: type.googleapis.com/envoy.extensions.filters.network.wasm.v3.Wasm  value:  config:  configuration:  '@type': type.googleapis.com/google.protobuf.StringValue  value: |{ \"debug\": \"false\", \"stat_prefix\": \"istio\" }  root_id: stats_outbound  vm_config:  code:  local:  inline_string: envoy.wasm.stats  runtime: envoy.wasm.runtime.null  vm_id: tcp_stats_outbound  priority: -1 EOF 自定义指标 区分 sidecar 和 gateway 的入站和出站请求 添加request_host 和 destination_port 维度到两者发出的 requests_total 指标 入站和出站方向的网关和边车\n--- apiVersion: networking.istio.io/v1alpha3 kind: EnvoyFilter metadata:  name: stats-filter-1.13  namespace: istio-system  labels:  istio.io/rev: default spec:  configPatches:  - applyTo: HTTP_FILTER  match:  context: SIDECAR_OUTBOUND  proxy:  proxyVersion: '^1\\.13.*'  listener:  filterChain:  filter:  name: \"envoy.filters.network.http_connection_manager\"  subFilter:  name: \"envoy.filters.http.router\"  patch:  operation: INSERT_BEFORE  value:  name: istio.stats  typed_config:  \"@type\": type.googleapis.com/udpa.type.v1.TypedStruct  type_url: type.googleapis.com/envoy.extensions.filters.http.wasm.v3.Wasm  value:  config:  root_id: stats_outbound  configuration:  \"@type\": \"type.googleapis.com/google.protobuf.StringValue\"  value: | {\"metrics\":[{\"dimensions\":{\"destination_port\":\"string(destination.port)\",\"request_host\":\"request.host\"},\"name\":\"requests_total\"}]}  vm_config:  vm_id: stats_outbound  runtime: envoy.wasm.runtime.v8  allow_precompiled: true  code:  local:  filename: /etc/istio/extensions/stats-filter.compiled.wasm  - applyTo: HTTP_FILTER  match:  context: SIDECAR_INBOUND  proxy:  proxyVersion: '^1\\.13.*'  listener:  filterChain:  filter:  name: \"envoy.filters.network.http_connection_manager\"  subFilter:  name: \"envoy.filters.http.router\"  patch:  operation: INSERT_BEFORE  value:  name: istio.stats  typed_config:  \"@type\": type.googleapis.com/udpa.type.v1.TypedStruct  type_url: type.googleapis.com/envoy.extensions.filters.http.wasm.v3.Wasm  value:  config:  root_id: stats_inbound  configuration:  \"@type\": \"type.googleapis.com/google.protobuf.StringValue\"  value: | {\"metrics\":[{\"dimensions\":{\"destination_port\":\"string(destination.port)\",\"request_host\":\"request.host\"},\"name\":\"requests_total\"}]}  vm_config:  vm_id: stats_inbound  runtime: envoy.wasm.runtime.v8  allow_precompiled: true  code:  local:  filename: /etc/istio/extensions/stats-filter.compiled.wasm  - applyTo: HTTP_FILTER  match:  context: GATEWAY  proxy:  proxyVersion: '^1\\.13.*'  listener:  filterChain:  filter:  name: \"envoy.filters.network.http_connection_manager\"  subFilter:  name: \"envoy.filters.http.router\"  patch:  operation: INSERT_BEFORE  value:  name: istio.stats  typed_config:  \"@type\": type.googleapis.com/udpa.type.v1.TypedStruct  type_url: type.googleapis.com/envoy.extensions.filters.http.wasm.v3.Wasm  value:  config:  root_id: stats_outbound  configuration:  \"@type\": \"type.googleapis.com/google.protobuf.StringValue\"  value: | {\"metrics\":[{\"dimensions\":{\"destination_port\":\"string(destination.port)\",\"request_host\":\"request.host\"},\"name\":\"requests_total\"}]}  vm_config:  vm_id: stats_outbound  runtime: envoy.wasm.runtime.v8  allow_precompiled: true  code:  local:  filename: /etc/istio/extensions/stats-filter.compiled.wasm  --- apiVersion: networking.istio.io/v1alpha3 kind: EnvoyFilter metadata:  name: tcp-stats-filter-1.13  namespace: istio-system  labels:  istio.io/rev: default spec:  configPatches:  - applyTo: NETWORK_FILTER  match:  context: SIDECAR_INBOUND  proxy:  proxyVersion: '^1\\.13.*'  listener:  filterChain:  filter:  name: \"envoy.filters.network.tcp_proxy\"  patch:  operation: INSERT_BEFORE  value:  name: istio.stats  typed_config:  \"@type\": type.googleapis.com/udpa.type.v1.TypedStruct  type_url: type.googleapis.com/envoy.extensions.filters.network.wasm.v3.Wasm  value:  config:  root_id: stats_inbound  configuration:  \"@type\": \"type.googleapis.com/google.protobuf.StringValue\"  value: | {\"metrics\":[{\"dimensions\":{\"destination_port\":\"string(destination.port)\",\"request_host\":\"request.host\"},\"name\":\"requests_total\"}]}  vm_config:  vm_id: tcp_stats_inbound  runtime: envoy.wasm.runtime.v8  allow_precompiled: true  code:  local:  filename: /etc/istio/extensions/stats-filter.compiled.wasm  - applyTo: NETWORK_FILTER  match:  context: SIDECAR_OUTBOUND  proxy:  proxyVersion: '^1\\.13.*'  listener:  filterChain:  filter:  name: \"envoy.filters.network.tcp_proxy\"  patch:  operation: INSERT_BEFORE  value:  name: istio.stats  typed_config:  \"@type\": type.googleapis.com/udpa.type.v1.TypedStruct  type_url: type.googleapis.com/envoy.extensions.filters.network.wasm.v3.Wasm  value:  config:  root_id: stats_outbound  configuration:  \"@type\": \"type.googleapis.com/google.protobuf.StringValue\"  value: | {\"metrics\":[{\"dimensions\":{\"destination_port\":\"string(destination.port)\",\"request_host\":\"request.host\"},\"name\":\"requests_total\"}]}  vm_config:  vm_id: tcp_stats_outbound  runtime: envoy.wasm.runtime.v8  allow_precompiled: true  code:  local:  filename: /etc/istio/extensions/stats-filter.compiled.wasm  - applyTo: NETWORK_FILTER  match:  context: GATEWAY  proxy:  proxyVersion: '^1\\.13.*'  listener:  filterChain:  filter:  name: \"envoy.filters.network.tcp_proxy\"  patch:  operation: INSERT_BEFORE  value:  name: istio.stats  typed_config:  \"@type\": type.googleapis.com/udpa.type.v1.TypedStruct  type_url: type.googleapis.com/envoy.extensions.filters.network.wasm.v3.Wasm  value:  config:  root_id: stats_outbound  configuration:  \"@type\": \"type.googleapis.com/google.protobuf.StringValue\"  value: | {\"metrics\":[{\"dimensions\":{\"destination_port\":\"string(destination.port)\",\"request_host\":\"request.host\"},\"name\":\"requests_total\"}]}  vm_config:  vm_id: tcp_stats_outbound  runtime: envoy.wasm.runtime.v8  allow_precompiled: true  code:  local:  filename: /etc/istio/extensions/stats-filter.compiled.wasm 参考资料 自定义 Istio 指标\n","categories":["istio"],"description":"","excerpt":"默认情况下，Istio 定义并生成一组标准指标\nistio 默认指标 stats-filter-\u003cistio_version\u003e  cat …","ref":"/blog/2023/01/12/istio%E5%8F%AF%E8%A7%82%E6%B5%8B%E6%80%A7%E7%B3%BB%E5%88%97-%E8%87%AA%E5%AE%9A%E4%B9%89%E6%8C%87%E6%A0%87/","tags":["istio","metrics"],"title":"Istio可观测性系列-自定义指标"},{"body":"","categories":"","description":"","excerpt":"","ref":"/tags/istioctl/","tags":"","title":"istioctl"},{"body":"网格预览 # ./istioctl ps NAME CLUSTER CDS LDS EDS RDS ISTIOD VERSION test-1.istio-system NOT SENT NOT SENT NOT SENT NOT SENT istiod-66bd9d59d8-k6qzk 65536.65536.65536 test-1.istio-system NOT SENT NOT SENT NOT SENT NOT SENT istiod-66bd9d59d8-k6qzk 65536.65536.65536 istio-egressgateway-c5b57c584-rz9rw.istio-system Kubernetes SYNCED SYNCED SYNCED NOT SENT istiod-66bd9d59d8-k6qzk 1.13.4 istio-ingressgateway-7767c959b4-jkbgb.istio-system Kubernetes SYNCED SYNCED SYNCED NOT SENT istiod-66bd9d59d8-k6qzk 1.13.4 mesh-demo-dubbo-consumer-test-rpzzh.pulsar-manager Kubernetes SYNCED SYNCED SYNCED SYNCED istiod-66bd9d59d8-k6qzk 1.14-dev mesh-demo-dubbo-pv1111-test-rfmtg.pulsar-manager Kubernetes SYNCED SYNCED SYNCED SYNCED istiod-66bd9d59d8-k6qzk 1.14-dev mesh-demo-dubbo-pv2-test-gjhwb.pulsar-manager Kubernetes SYNCED SYNCED SYNCED SYNCED istiod-66bd9d59d8-k6qzk 1.14-dev mesh-demo-httpv1-test-8b7f5.pulsar-manager Kubernetes SYNCED SYNCED SYNCED SYNCED istiod-66bd9d59d8-k6qzk 1.14-dev mesh-demo-httpv2-test-qlkhb.pulsar-manager 检查 Envoy 已加载的配置和 Istiod 发送给它的配置有什么异同 # ./istioctl proxy-status components-provider-sfkt-default-test-6gw8b.components-nacos Clusters Match Listeners Match Routes Match (RDS last loaded at Thu, 12 Jan 2023 09:50:37 CST) 查看代理(Envoy)配置 检索特定 pod 中 Envoy 实例的集群配置的信息 istioctl proxy-config cluster \u003cpod-name\u003e [flags] # istioctl pc c details-v1-7d88846999-lg849 --fqdn istio-egressgateway SERVICE FQDN PORT SUBSET DIRECTION TYPE DESTINATION RULE istio-egressgateway-lazyxds.istio-system.svc.cluster.local 8080 - outbound EDS istio-egressgateway.istio-system.svc.cluster.local 80 - outbound EDS istio-egressgateway.istio-system.svc.cluster.local 443 - outbound EDS 检索特定 pod 中 Envoy 实例的 bootstrap 配置的信息 $ istioctl proxy-config bootstrap \u003cpod-name\u003e [flags] # istioctl pc bootstrap details-v1-7d88846999-lg849 {  \"bootstrap\": {  \"node\": {  \"id\": \"sidecar~10.244.6.15~details-v1-7d88846999-lg849.default~default.svc.cluster.local\",  \"cluster\": \"details.default\",  \"metadata\": {  \"ANNOTATIONS\": {  \"cni.projectcalico.org/podIP\": \"10.244.6.15/32\",  \"kubectl.kubernetes.io/default-container\": \"details\",  \"kubectl.kubernetes.io/default-logs-container\": \"details\",  \"kubernetes.io/config.seen\": \"2023-01-04T11:58:05.195509813+08:00\",  \"kubernetes.io/config.source\": \"api\",  \"prometheus.io/path\": \"/stats/prometheus\",  \"prometheus.io/port\": \"15020\",  \"prometheus.io/scrape\": \"true\",  \"sidecar.istio.io/status\": \"{\\\"initContainers\\\":[\\\"istio-init\\\"],\\\"containers\\\":[\\\"istio-proxy\\\"],\\\"volumes\\\":[\\\"workload-socket\\\",\\\"credential-socket\\\",\\\"workload-certs\\\",\\\"istio-envoy\\\",\\\"istio-data\\\",\\\"istio-podinfo\\\",\\\"istio-token\\\",\\\"istiod-ca-cert\\\"],\\\"imagePullSecrets\\\":null,\\\"revision\\\":\\\"default\\\"}\"  },  \"APP_CONTAINERS\": \"details\",  \"CLUSTER_ID\": \"Kubernetes\",  \"ENVOY_PROMETHEUS_PORT\": 15090,  \"ENVOY_STATUS_PORT\": 15021,  \"INSTANCE_IPS\": \"10.244.6.15\",  \"INTERCEPTION_MODE\": \"REDIRECT\", \u003c!--more--\u003e 检索特定 pod 中 Envoy 实例的监听器配置的信息 $ istioctl proxy-config listener \u003cpod-name\u003e [flags] # istioctl pc l details-v1-7d88846999-lg849 ADDRESS PORT MATCH DESTINATION 10.96.0.10 53 ALL Cluster: outbound|53||kube-dns.kube-system.svc.cluster.local 0.0.0.0 80 Trans: raw_buffer; App: http/1.1,h2c Route: 80 0.0.0.0 80 ALL PassthroughCluster 10.96.84.49 80 Trans: raw_buffer; App: http/1.1,h2c Route: wordpress.default.svc.cluster.local:80 10.96.84.49 80 ALL Cluster: outbound|80||wordpress.default.svc.cluster.local 10.96.0.1 443 ALL Cluster: outbound|443||kubernetes.default.svc.cluster.local 10.96.114.129 443 ALL Cluster: outbound|443||istio-ingressgateway.istio-system.svc.cluster.local 10.96.129.201 443 ALL Cluster: outbound|443||ingress-controller-ingress-nginx-controller-admission.ingress-nginx.svc.cluster.local ... ... ... 检索特定 pod 中 Envoy 实例的路由配置的信息 $ istioctl proxy-config route \u003cpod-name\u003e [flags] # istioctl pc r details-v1-7d88846999-lg849 NAME DOMAINS MATCH VIRTUAL SERVICE 80 ingress-controller-ingress-nginx-controller.ingress-nginx, 10.96.150.192 /* 80 istio-egressgateway.istio-system, 10.96.133.49 /* 80 istio-ingressgateway.istio-system, 10.96.114.129 /* 80 lazyxds-placeholder-service.istio-system, 10.96.16.81 /* 80 tracing.istio-system, 10.96.4.72 /* 80 wordpress, wordpress.default + 1 more... /* 8080 istio-egressgateway-lazyxds.istio-system, 10.96.231.188 /* ... ... ... 检索特定 pod 中 Envoy 实例的 endpoint 配置的信息 $ istioctl proxy-config endpoints \u003cpod-name\u003e [flags] 当不方便登录集群节点时，可以通过dump envoy配置，然后通过istioctl来查看 # kubectl exec details-v1-7d88846999-lg849 -c istio-proxy -- curl 127.0.0.1:15000/config_dump \u003e details-config.json  # istioctl pc r -f details-config.json NAME DOMAINS MATCH VIRTUAL SERVICE 80 ingress-controller-ingress-nginx-controller.ingress-nginx, 10.96.150.192 /* 80 istio-egressgateway.istio-system, 10.96.133.49 /* 80 istio-ingressgateway.istio-system, 10.96.114.129 /* 80 lazyxds-placeholder-service.istio-system, 10.96.16.81 /* 80 tracing.istio-system, 10.96.4.72 /* 80 wordpress, wordpress.default + 1 more... /* ... ... ... # istioctl pc l -f details-config.json ADDRESS PORT MATCH DESTINATION 10.96.0.10 53 ALL Cluster: outbound|53||kube-dns.kube-system.svc.cluster.local 0.0.0.0 80 Trans: raw_buffer; App: http/1.1,h2c Route: 80 0.0.0.0 80 ALL PassthroughCluster 10.96.84.49 80 Trans: raw_buffer; App: http/1.1,h2c Route: wordpress.default.svc.cluster.local:80 10.96.84.49 80 ALL Cluster: outbound|80||wordpress.default.svc.cluster.local 10.96.0.1 443 ALL Cluster: outbound|443||kubernetes.default.svc.cluster.local 10.96.114.129 443 ALL Cluster: outbound|443||istio-ingressgateway.istio-system.svc.cluster.local 10.96.129.201 443 ALL Cluster: outbound|443||ingress-controller-ingress-nginx-controller-admission.ingress-nginx.svc.cluster.local ... ... ... ","categories":["istio"],"description":"","excerpt":"网格预览 # ./istioctl ps NAME CLUSTER CDS LDS EDS RDS ISTIOD VERSION …","ref":"/blog/2023/01/12/istioctl%E5%B7%A5%E5%85%B7%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/","tags":["istioctl"],"title":"istioctl工具使用指南"},{"body":"","categories":"","description":"","excerpt":"","ref":"/tags/pilot/","tags":"","title":"pilot"},{"body":"","categories":"","description":"","excerpt":"","ref":"/categories/%E4%BA%91%E5%8E%9F%E7%94%9F/","tags":"","title":"云原生"},{"body":"查看监听端口和进程 istio-proxy@istio-ingressgateway-799bbc9474-hf7kv:/$ ss -ntlp State Recv-Q Send-Q Local Address:Port Peer Address:Port Process LISTEN 0 128 127.0.0.1:15000 0.0.0.0:* users:((\"envoy\",pid=16,fd=18)) LISTEN 0 128 127.0.0.1:15004 0.0.0.0:* users:((\"pilot-agent\",pid=1,fd=15)) LISTEN 0 128 0.0.0.0:15021 0.0.0.0:* users:((\"envoy\",pid=16,fd=24)) LISTEN 0 128 0.0.0.0:15021 0.0.0.0:* users:((\"envoy\",pid=16,fd=23)) LISTEN 0 128 0.0.0.0:8080 0.0.0.0:* users:((\"envoy\",pid=16,fd=40)) LISTEN 0 128 0.0.0.0:8080 0.0.0.0:* users:((\"envoy\",pid=16,fd=39)) LISTEN 0 128 0.0.0.0:15090 0.0.0.0:* users:((\"envoy\",pid=16,fd=22)) LISTEN 0 128 0.0.0.0:15090 0.0.0.0:* users:((\"envoy\",pid=16,fd=21)) LISTEN 0 128 *:15020 *:* users:((\"pilot-agent\",pid=1,fd=12)) istio-proxy@istio-ingressgateway-799bbc9474-hf7kv:/$ ps -ef |grep pilot-agent istio-p+ 1 0 0 Sep14 ? 00:01:27 /usr/local/bin/pilot-agent proxy router --domain istio-system.svc.cluster.local --proxyLogLevel=warning --proxyComponentLogLevel=misc:error --log_output_level=default:info istio-p+ 74 30 0 09:37 pts/0 00:00:00 grep --color=auto pilot-agent    pilot-agent proxy router 启动参数 istio-proxy@istio-ingressgateway-799bbc9474-hf7kv:/$ /usr/local/bin/pilot-agent proxy router --help XDS proxy agent  Usage:  pilot-agent proxy [flags]  Flags:  --concurrency int number of worker threads to run  --domain string DNS domain suffix. If not provided uses ${POD_NAMESPACE}.svc.cluster.local  -h, --help help for proxy  --meshConfig string File name for Istio mesh configuration. If not specified, a default mesh will be used. This may be overridden by PROXY_CONFIG environment variable or proxy.istio.io/config annotation. (default \"./etc/istio/config/mesh\")  --outlierLogPath string The log path for outlier detection  --proxyComponentLogLevel string The component log level used to start the Envoy proxy. Deprecated, use proxyLogLevel instead  --proxyLogLevel string The log level used to start the Envoy proxy (choose from {trace, debug, info, warning, error, critical, off}).Level may also include one or more scopes, such as 'info,misc:error,upstream:debug' (default \"warning,misc:error\")  --serviceCluster string Service cluster (default \"istio-proxy\")  --stsPort int HTTP Port on which to serve Security Token Service (STS). If zero, STS service will not be provided.  --templateFile string Go template bootstrap config  --tokenManagerPlugin string Token provider specific plugin name. (default \"GoogleTokenExchange\")  Global Flags:  --log_as_json Whether to format output as JSON or in plain console-friendly format  --log_caller string Comma-separated list of scopes for which to include caller information, scopes can be any of [ads, all, authn, authorization, ca, cache, citadelclient, controllers, default, delta, dns, gcecred, googleca, googlecas, grpcgen, healthcheck, iptables, klog, mockcred, model, proxyconfig, sds, security, serviceentry, spiffe, stsclient, stsserver, telemetry, token, trustBundle, validation, wasm, wle, xdsproxy]  --log_output_level string Comma-separated minimum per-scope logging level of messages to output, in the form of \u003cscope\u003e:\u003clevel\u003e,\u003cscope\u003e:\u003clevel\u003e,... where scope can be one of [ads, all, authn, authorization, ca, cache, citadelclient, controllers, default, delta, dns, gcecred, googleca, googlecas, grpcgen, healthcheck, iptables, klog, mockcred, model, proxyconfig, sds, security, serviceentry, spiffe, stsclient, stsserver, telemetry, token, trustBundle, validation, wasm, wle, xdsproxy] and level can be one of [debug, info, warn, error, fatal, none] (default \"default:info\")  --log_rotate string The path for the optional rotating log file  --log_rotate_max_age int The maximum age in days of a log file beyond which the file is rotated (0 indicates no limit) (default 30)  --log_rotate_max_backups int The maximum number of log file backups to keep before older files are deleted (0 indicates no limit) (default 1000)  --log_rotate_max_size int The maximum size in megabytes of a log file beyond which the file is rotated (default 104857600)  --log_stacktrace_level string Comma-separated minimum per-scope logging level at which stack traces are captured, in the form of \u003cscope\u003e:\u003clevel\u003e,\u003cscope:level\u003e,... where scope can be one of [ads, all, authn, authorization, ca, cache, citadelclient, controllers, default, delta, dns, gcecred, googleca, googlecas, grpcgen, healthcheck, iptables, klog, mockcred, model, proxyconfig, sds, security, serviceentry, spiffe, stsclient, stsserver, telemetry, token, trustBundle, validation, wasm, wle, xdsproxy] and level can be one of [debug, info, warn, error, fatal, none] (default \"default:none\")  --log_target stringArray The set of paths where to output the log. This can be any path as well as the special values stdout and stderr (default [stdout])  --vklog Level number for the log level verbosity. Like -v flag. ex: --vklog=9 istio-proxy@istio-ingressgateway-799bbc9474-hf7kv:/$    20220916174047   查看meshconfig配置 istio-proxy@istio-ingressgateway-799bbc9474-hf7kv:/$ cat ./etc/istio/config/mesh accessLogFile: /dev/stdout defaultConfig:  discoveryAddress: istiod.istio-system.svc:15012  proxyMetadata: {}  tracing:  zipkin:  address: zipkin.istio-system:9411 enablePrometheusMerge: true extensionProviders: - envoyOtelAls:  port: 4317  service: opentelemetry-collector.istio-system.svc.cluster.local  name: otel rootNamespace: istio-system trustDomain: cluster.local istio-proxy@istio-ingressgateway-799bbc9474-hf7kv:/$    20220916174246  ","categories":["云原生","Istio"],"description":"","excerpt":"查看监听端口和进程 istio-proxy@istio-ingressgateway-799bbc9474-hf7kv:/$ ss …","ref":"/blog/2022/09/16/3d18d6/","tags":["istio","pilot"],"title":"深入Istio系列-Pilot agent"},{"body":"Istio 指标 Istio 自己的 Metrics 标准指标说明  参考：https://istio.io/latest/docs/reference/config/metrics/\n Metrics 对于 HTTP、HTTP/2 和 GRPC 流量，Istio 默认生成以下指标：\n Request Count (istio_requests_total): This is a COUNTER incremented for every request handled by an Istio proxy. Request Duration (istio_request_duration_milliseconds): This is a DISTRIBUTION which measures the duration of requests. Request Size (istio_request_bytes): This is a DISTRIBUTION which measures HTTP request body sizes. Response Size (istio_response_bytes): This is a DISTRIBUTION which measures HTTP response body sizes. gRPC Request Message Count (istio_request_messages_total): This is a COUNTER incremented for every gRPC message sent from a client. gRPC Response Message Count (istio_response_messages_total): This is a COUNTER incremented for every gRPC message sent from a server.  对于 TCP 流量，Istio 生成以下指标：\n Tcp Bytes Sent (istio_tcp_sent_bytes_total): This is a COUNTER which measures the size of total bytes sent during response in case of a TCP connection. Tcp Bytes Received (istio_tcp_received_bytes_total): This is a COUNTER which measures the size of total bytes received during request in case of a TCP connection. Tcp Connections Opened (istio_tcp_connections_opened_total): This is a COUNTER incremented for every opened connection. Tcp Connections Closed (istio_tcp_connections_closed_total): This is a COUNTER incremented for every closed connection.  Prometheus 的 Labels   Reporter: This identifies the reporter of the request. It is set to destination if report is from a server Istio proxy and source if report is from a client Istio proxy or a gateway.\n  Source Workload: This identifies the name of source workload which controls the source, or “unknown” if the source information is missing.\n  Source Workload Namespace: This identifies the namespace of the source workload, or “unknown” if the source information is missing.\n  Source Principal: This identifies the peer principal of the traffic source. It is set when peer authentication is used.\n  Source App: This identifies the source application based on app label of the source workload, or “unknown” if the source information is missing.\n  Source Version: This identifies the version of the source workload, or “unknown” if the source information is missing.\n  Destination Workload: This identifies the name of destination workload, or “unknown” if the destination information is missing.\n  Destination Workload Namespace: This identifies the namespace of the destination workload, or “unknown” if the destination information is missing.\n  Destination Principal: This identifies the peer principal of the traffic destination. It is set when peer authentication is used.\n  Destination App: This identifies the destination application based on app label of the destination workload, or “unknown” if the destination information is missing.\n  Destination Version: This identifies the version of the destination workload, or “unknown” if the destination information is missing.\n  Destination Service: This identifies destination service host responsible for an incoming request. Ex: details.default.svc.cluster.local.\n  Destination Service Name: This identifies the destination service name. Ex: “details”.\n  Destination Service Namespace: This identifies the namespace of destination service.\n  Request Protocol: This identifies the protocol of the request. It is set to request or connection protocol.\n  Response Code: This identifies the response code of the request. This label is present only on HTTP metrics.\n  Connection Security Policy: This identifies the service authentication policy of the request. It is set to mutual_tls when Istio is used to make communication secure and report is from destination. It is set to unknown when report is from source since security policy cannot be properly populated.\n  Response Flags: Additional details about the response or connection from proxy. In case of Envoy, see %RESPONSE_FLAGS% in Envoy Access Log for more detail.\n  Canonical Service: A workload belongs to exactly one canonical service, whereas it can belong to multiple services. A canonical service has a name and a revision so it results in the following labels.\nsource_canonical_service source_canonical_revision destination_canonical_service destination_canonical_revision   Destination Cluster: This identifies the cluster of the destination workload. This is set by: global.multiCluster.clusterName at cluster install time.\n  Source Cluster: This identifies the cluster of the source workload. This is set by: global.multiCluster.clusterName at cluster install time.\n  gRPC Response Status: This identifies the response status of the gRPC. This label is present only on gRPC metrics.\n  使用 istio-proxy 与应用的 Metrics 整合输出  参考：https://istio.io/v1.14/docs/ops/integrations/prometheus/#option-1-metrics-merging\n Istio 能够完全通过 prometheus.io annotations 来控制抓取。虽然 prometheus.io annotations 不是 Prometheus 的核心部分，但它们已成为配置抓取的事实标准。\n此选项默认启用，但可以通过在 安装 期间传递 --set meshConfig.enablePrometheusMerge=false 来禁用。启用后，将向所有数据平面 pod 添加适当的 prometheus.io annotations 以设置抓取。如果这些注释已经存在，它们将被覆盖。使用此选项，Envoy sidecar 会将 Istio 的指标与应用程序指标合并。合并后的指标将从 /stats/prometheus:15020 中抓取。\n此选项以明文形式公开所有指标。\n定制：为 Metrics 增加维度  参考： https://istio.io/latest/docs/tasks/observability/metrics/customize-metrics/#custom-statistics-configuration\n 如，增加端口、与 HTTP HOST 头 维度。\n   apiVersion: install.istio.io/v1alpha1 kind: IstioOperator spec:  values:  telemetry:  v2:  prometheus:  configOverride:  inboundSidecar:  metrics:  - name: requests_total  dimensions:  destination_port: string(destination.port)  request_host: request.host  outboundSidecar:  metrics:  - name: requests_total  dimensions:  destination_port: string(destination.port)  request_host: request.host  gateway:  metrics:  - name: requests_total  dimensions:  destination_port: string(destination.port)  request_host: request.host 使用以下命令将以下 annotation 应用到所有注入的 pod，其中包含要提取到 Prometheus 时间序列 的维度列表：  仅当您的维度不在 [DefaultStatTags 列表] 中时才需要此步骤（https://github.com/istio/istio/blob/release-1.14/pkg/bootstrap/config.go）\napiVersion: apps/v1 kind: Deployment spec:  template: # pod template  metadata:  annotations:  sidecar.istio.io/extraStatTags: destination_port,request_host 要在网格范围内启用额外 Tag ，您可以将 extraStatTags 添加到网格配置中：\nmeshConfig:  defaultConfig:  extraStatTags:  - destination_port  - request_host  参考 : https://istio.io/latest/docs/reference/config/proxy_extensions/stats/#MetricConfig\n 定制：加入 request / response 元信息维度 可以把 request 或 repsonse 里一些基础信息 加入到 指标的维度。如，URL Path，这在需要为相同服务分隔统计不同 REST API 的指标时，相当有用。\n 参考 : https://istio.io/latest/docs/tasks/observability/metrics/classify-metrics/\n 工作原理 istio stat filter 使用 Istio 在自己的定制版本 Envoy 中，加入了 stats-filter 插件，用于计算 Istio 自己想要的指标：\n$ k -n istio-system get envoyfilters.networking.istio.io stats-filter-1.14 -o yaml apiVersion: networking.istio.io/v1alpha3 kind: EnvoyFilter metadata:  annotations:  labels:  install.operator.istio.io/owning-resource-namespace: istio-system  istio.io/rev: default  operator.istio.io/component: Pilot  operator.istio.io/version: 1.14.3  name: stats-filter-1.14  namespace: istio-system spec:  configPatches:  - applyTo: HTTP_FILTER  match:  context: SIDECAR_OUTBOUND  listener:  filterChain:  filter:  name: envoy.filters.network.http_connection_manager  subFilter:  name: envoy.filters.http.router  proxy:  proxyVersion: ^1\\.14.*  patch:  operation: INSERT_BEFORE  value:  name: istio.stats  typed_config:  '@type': type.googleapis.com/udpa.type.v1.TypedStruct  type_url: type.googleapis.com/envoy.extensions.filters.http.wasm.v3.Wasm  value:  config:  configuration:  '@type': type.googleapis.com/google.protobuf.StringValue  value: |{ \"debug\": \"false\", \"stat_prefix\": \"istio\" }  root_id: stats_outbound  vm_config:  code:  local:  inline_string: envoy.wasm.stats  runtime: envoy.wasm.runtime.null  vm_id: stats_outbound  - applyTo: HTTP_FILTER  match:  context: SIDECAR_INBOUND  listener:  filterChain:  filter:  name: envoy.filters.network.http_connection_manager  subFilter:  name: envoy.filters.http.router  proxy:  proxyVersion: ^1\\.14.*  patch:  operation: INSERT_BEFORE  value:  name: istio.stats  typed_config:  '@type': type.googleapis.com/udpa.type.v1.TypedStruct  type_url: type.googleapis.com/envoy.extensions.filters.http.wasm.v3.Wasm  value:  config:  configuration:  '@type': type.googleapis.com/google.protobuf.StringValue  value: |{ \"debug\": \"false\", \"stat_prefix\": \"istio\", \"disable_host_header_fallback\": true, \"metrics\": [ { \"dimensions\": { \"destination_cluster\": \"node.metadata['CLUSTER_ID']\", \"source_cluster\": \"downstream_peer.cluster_id\" } } ] }  root_id: stats_inbound  vm_config:  code:  local:  inline_string: envoy.wasm.stats  runtime: envoy.wasm.runtime.null  vm_id: stats_inbound  - applyTo: HTTP_FILTER  match:  context: GATEWAY  listener:  filterChain:  filter:  name: envoy.filters.network.http_connection_manager  subFilter:  name: envoy.filters.http.router  proxy:  proxyVersion: ^1\\.14.*  patch:  operation: INSERT_BEFORE  value:  name: istio.stats  typed_config:  '@type': type.googleapis.com/udpa.type.v1.TypedStruct  type_url: type.googleapis.com/envoy.extensions.filters.http.wasm.v3.Wasm  value:  config:  configuration:  '@type': type.googleapis.com/google.protobuf.StringValue  value: |{ \"debug\": \"false\", \"stat_prefix\": \"istio\", \"disable_host_header_fallback\": true }  root_id: stats_outbound  vm_config:  code:  local:  inline_string: envoy.wasm.stats  runtime: envoy.wasm.runtime.null  vm_id: stats_outbound  priority: -1 istio stat Plugin 实现 https://github.com/istio/proxy/blob/release-1.14/extensions/stats/plugin.cc\n内置的 Metric:\nconst std::vector\u003cMetricFactory\u003e\u0026 PluginRootContext::defaultMetrics() {  static const std::vector\u003cMetricFactory\u003e default_metrics = {  // HTTP, HTTP/2, and GRPC metrics  MetricFactory{\"requests_total\", MetricType::Counter,  [](::Wasm::Common::RequestInfo\u0026) -\u003e uint64_t { return 1; },  static_cast\u003cuint32_t\u003e(Protocol::HTTP) |  static_cast\u003cuint32_t\u003e(Protocol::GRPC),  count_standard_labels, /* recurrent */ false},  MetricFactory{\"request_duration_milliseconds\", MetricType::Histogram,  [](::Wasm::Common::RequestInfo\u0026 request_info) -\u003e uint64_t {  return request_info.duration /* in nanoseconds */ /  1000000;  },  static_cast\u003cuint32_t\u003e(Protocol::HTTP) |  static_cast\u003cuint32_t\u003e(Protocol::GRPC),  count_standard_labels, /* recurrent */ false},  MetricFactory{\"request_bytes\", MetricType::Histogram,  [](::Wasm::Common::RequestInfo\u0026 request_info) -\u003e uint64_t {  return request_info.request_size;  },  static_cast\u003cuint32_t\u003e(Protocol::HTTP) |  static_cast\u003cuint32_t\u003e(Protocol::GRPC),  count_standard_labels, /* recurrent */ false},  MetricFactory{\"response_bytes\", MetricType::Histogram,  [](::Wasm::Common::RequestInfo\u0026 request_info) -\u003e uint64_t {  return request_info.response_size;  },  static_cast\u003cuint32_t\u003e(Protocol::HTTP) |  static_cast\u003cuint32_t\u003e(Protocol::GRPC),  count_standard_labels, /* recurrent */ false}, ... https://github.com/istio/proxy/blob/release-1.14/extensions/stats/plugin.cc#L591\nvoid PluginRootContext::report(::Wasm::Common::RequestInfo\u0026 request_info,  bool end_stream) {  ...  map(istio_dimensions_, outbound_, peer_node_info.get(), request_info);   for (size_t i = 0; i \u003c expressions_.size(); i++) {  if (!evaluateExpression(expressions_[i].token,  \u0026istio_dimensions_.at(count_standard_labels + i))) {  LOG_TRACE(absl::StrCat(\"Failed to evaluate expression: \u003c\",  expressions_[i].expression, \"\u003e\"));  istio_dimensions_[count_standard_labels + i] = \"unknown\";  }  }   auto stats_it = metrics_.find(istio_dimensions_);  if (stats_it != metrics_.end()) {  for (auto\u0026 stat : stats_it-\u003esecond) {  if (end_stream || stat.recurrent_) {  stat.record(request_info);  }  LOG_DEBUG(  absl::StrCat(\"metricKey cache hit \", \", stat=\", stat.metric_id_));  }  cache_hits_accumulator_++;  if (cache_hits_accumulator_ == 100) {  incrementMetric(cache_hits_, cache_hits_accumulator_);  cache_hits_accumulator_ = 0;  }  return;  } ... }  关于 Istio 的指标原理，这是一个很好的参考文章：https://blog.christianposta.com/understanding-istio-telemetry-v2/\n Envoy 内置的 Metrics Istio 默认用 istio-agent 去整合 Envoy 的 metrics。 而 Istio 默认打开的 Envoy 内置 Metrics 很少：\n 见：https://istio.io/latest/docs/ops/configuration/telemetry/envoy-stats/\n cluster_manager listener_manager server cluster.xds-grpc 定制 Envoy 内置的 Metrics  参考：https://istio.io/latest/docs/ops/configuration/telemetry/envoy-stats/\n 如果要配置 Istio Proxy 以记录 其它 Envoy 原生的指标，您可以将 ProxyConfig.ProxyStatsMatcher 添加到网格配置中。 例如，要全局启用断路器、重试和上游连接的统计信息，您可以指定 stats matcher，如下所示：\n代理需要重新启动以获取统计匹配器配置。\napiVersion: install.istio.io/v1alpha1 kind: IstioOperator spec:  meshConfig:  defaultConfig:  proxyStatsMatcher:  inclusionRegexps:  - \".*circuit_breakers.*\"  inclusionPrefixes:  - \"upstream_rq_retry\"  - \"upstream_cx\" 您还可以使用 proxy.istio.io/config annotation 为个别代码指定配置。 例如，要配置与上面相同的统计信息，您可以将 annotation 添加到 gateway proxy 或 workload，如下所示：\nmetadata:  annotations:  proxy.istio.io/config: |-proxyStatsMatcher: inclusionRegexps: - \".*circuit_breakers.*\" inclusionPrefixes: - \"upstream_rq_retry\" - \"upstream_cx\" 原理 下面，看看 Istio 默认配置下，如何配置 Envoy。\nistioctl proxy-config bootstrap fortio-server | yq eval -P \u003e envoy-config-bootstrap-default.yaml 输出：\nbootstrap: ...  statsConfig:  statsTags: # 从指标名中抓取 Tag(prometheus label)  - tagName: cluster_name  regex: ^cluster\\.((.+?(\\..+?\\.svc\\.cluster\\.local)?)\\.)  - tagName: tcp_prefix  regex: ^tcp\\.((.*?)\\.)\\w+?$  - tagName: response_code  regex: (response_code=\\.=(.+?);\\.;)|_rq(_(\\.d{3}))$  - tagName: response_code_class  regex: _rq(_(\\dxx))$  - tagName: http_conn_manager_listener_prefix  regex: ^listener(?=\\.).*?\\.http\\.(((?:[_.[:digit:]]*|[_\\[\\]aAbBcCdDeEfF[:digit:]]*))\\.) ...  useAllDefaultTags: false  statsMatcher:  inclusionList:  patterns: # 选择要记录的指标  - prefix: reporter=  - prefix: cluster_manager  - prefix: listener_manager  - prefix: server  - prefix: cluster.xds-grpc ## 只记录 xDS cluster. 即不记录用户自己服务的 cluster !!!  - prefix: wasm  - suffix: rbac.allowed  - suffix: rbac.denied  - suffix: shadow_allowed  - suffix: shadow_denied  - prefix: component 这时，如果修改 pod 的定义为：\n annotations:  proxy.istio.io/config: |-proxyStatsMatcher: inclusionRegexps: - \"cluster\\\\..*fortio.*\" #proxy upstream(outbound) - \"cluster\\\\..*inbound.*\" #proxy upstream(inbound，这里一般就是指到同一 pod 中运行的应用了) - \"http\\\\..*\" - \"listener\\\\..*\" 产生新的 Envoy 配置：\n \"stats_matcher\": {  \"inclusion_list\": {  \"patterns\": [  {  \"prefix\": \"reporter=\"  },  {  \"prefix\": \"cluster_manager\"  },  {  \"prefix\": \"listener_manager\"  },  {  \"prefix\": \"server\"  },  {  \"prefix\": \"cluster.xds-grpc\"  },    {  \"safe_regex\": {  \"google_re2\": {},  \"regex\": \"cluster\\\\..*fortio.*\"  }  },  {  \"safe_regex\": {  \"google_re2\": {},  \"regex\": \"cluster\\\\..*inbound.*\"  }  },  {  \"safe_regex\": {  \"google_re2\": {},  \"regex\": \"http\\\\..*\"  }  },  {  \"safe_regex\": {  \"google_re2\": {},  \"regex\": \"listener\\\\..*\"  }  }, 总结：Istio-Proxy 指标地图 要做好监控，首先要深入了解指标原理。而要了解指标原理，当然要知道指标是产生流程中的什么位置，什么组件。看完上面关于 Envoy 与 Istio 的指标说明后。可以大概得到以下结论：\n本节的实验环境说明见于： {ref}`appendix-lab-env/appendix-lab-env-base:简单分层实验环境` 本文出自https://istio-insider.readthedocs.io/\n","categories":["云原生"],"description":"","excerpt":"Istio 指标 Istio 自己的 Metrics 标准指标说明  参 …","ref":"/blog/2022/09/13/6899d1/","tags":["istio","转载"],"title":"Istio可观测性系列-性能指标"},{"body":"","categories":"","description":"","excerpt":"","ref":"/tags/%E8%BD%AC%E8%BD%BD/","tags":"","title":"转载"},{"body":"","categories":"","description":"","excerpt":"","ref":"/tags/envoy/","tags":"","title":"envoy"},{"body":"Envoy 指标 Envoy 指标概述 Envoy 的主要目标之一是使网络易于理解。 Envoy 会根据其配置方式产生大量统计信息。一般来说，统计数据(指标)分为三类：\n Downstream：Downstream 指标与外来的连接/请求有关。它们由 listener、HTTP connection manager(HCM)、TCP proxy filter 等产生。 Upstream：Upstream 指标与外向的连接/请求有关。它们由 connection pool、router filter、tcp proxy filter等产生。 Server：Server 指标信息描述 Envoy 服务器实例的运作情况。服务器正常运行时间或分配的内存量等统计信息。  在最简单场景下，单个 Envoy Proxy 通常涉及 Downstream 和 Upstream 统计数据。这两种指标反映了取该 网络节点 的运行情况。来自整个网格的统计数据提供了每个 网络节点 和整体网络健康状况的非常详细的汇总信息。Envoy 的文档对这些指标有一些简单的说明。\nTag Envoy 的指标还有两个子概念，支持在指标中使用： 标签(tags)/维度(dimensions) 。这里的 tags 对等于 Prometheus 指标的 label。意义上，可以理解为：分类维度。\nEnvoy 的 指标 由规范的字符串来标识。这些字符串的动态部分（子字符串）被提取成为 标签(tag)。可以通过指定 tag 提取规则(Tag Specifier configuration.) 来定制 tag 。\n举个例子：\n### 1. 原始的 Envoy 指标 ###  $ kubectl exec fortio-server -c istio-proxy -- curl 'localhost:15000/stats'  # 返回： cluster.outbound|8080||fortio-server-l2.mark.svc.cluster.local.external.upstream_rq_2xx: 300  # 其中： # - `outbound|8080||fortio-server-l2.mark.svc.cluster.local` 部分是 upstream cluster 的名字。可以正则提取作为 tag。 # - `2xx` 部分是 HTTP Status Code 的分类。可以正则提取作为 tag。 下文将有这个提取规则的配置说明。  ### 2. 给 Prometheus 的指标 ### $ kubectl exec fortio-server -c istio-proxy -- curl 'localhost:15000/stats?format=prometheus' | grep 'outbound|8080||fortio-server-l2' | grep 'external.upstream_rq'  # 返回： envoy_cluster_external_upstream_rq{response_code_class=\"2xx\",cluster_name=\"outbound|8080||fortio-server-l2.mark.svc.cluster.local\"} 300 指标数据类型 Envoy 发出三种类型的值作为统计信息：\n 计数器(Counters)：无符号整数，只会增加而不会减少。例如，总请求。 仪表(Gauges)：增加和减少的无符号整数。例如，当前活动的请求。 直方图(Histograms)：作为指标流的一部分的无符号整数，然后由收集器聚合以最终产生汇总的百分位值(percentile，即平常说的 P99/P50/Pxx)。例如，Upsteam 响应时间。  在 Envoy 的内部实现中，Counters 和 Gauges 被分批并定期刷新以提高性能。Histograms 在接收时写入。\n指标释义 从指标的产出地点来划分，可以分为：\n cluster manager : 面向 upstream 的 L3/L4/L7 层指标 http connection manager(HCM) ： 面向 upstream \u0026 downstream 的 L7 层指标 listeners : 面向 downstream 的 L3/L4 层指标 server(全局) watch dog  下面我只选择了部分关键的性能指标来简单说明。\ncluster manager Envoy 文档:cluster manager stats\n上面文档已经说得比较详细了。我只补充一些在性能调优时需要关注的方面。那么，一般需要关注什么指标？\n我们从著名的 Utilization Saturation and Errors (USE) 方法学来分析。\n利用率(Utilization):\n upstream_cx_total (Counter): 连接数 upstream_rq_active  饱和度(Saturation):\n upstream_rq_time (Histogram): 响应时间 upstream_cx_connect_ms (Histogram) upstream_cx_rx_bytes_buffered upstream_cx_tx_bytes_buffered upstream_rq_pending_total upstream_rq_pending_active (Gauge)  错误(Error):\n upstream_cx_connect_fail (Counter): 连接失败数 upstream_cx_connect_timeout (Counter): 连接超时数 upstream_cx_overflow (Counter): 集群连接断路器溢出的总次数 upstream_cx_pool_overflow upstream_cx_destroy_local_with_active_rq upstream_cx_destroy_remote_with_active_rq upstream_rq_timeout upstream_rq_retry upstream_rq_rx_reset upstream_rq_tx_reset  其它：\n upstream_rq_total (Counter): TPS (吞吐) upstream_cx_destroy_local (Counter): Envoy 主动断开的连接计数 upstream_cx_destroy_remote (Counter): Envoy 被动断开的连接计数 upstream_cx_length_ms (Histogram)  http connection manager(HCM) Envoy 文档:http connection manager(HCM) stats\n可以认为，这是面向 downstream \u0026 部分 upstream 的 L7 层指标\n利用率(Utilization):\n downstream_cx_total downstream_cx_active downstream_cx_http1_active downstream_rq_total downstream_rq_http1_total downstream_rq_active  饱和度(Saturation):\n downstream_cx_rx_bytes_buffered downstream_cx_tx_bytes_buffered downstream_flow_control_paused_reading_total downstream_flow_control_resumed_reading_total  错误(Error):\n downstream_cx_destroy_local_active_rq downstream_cx_destroy_remote_active_rq downstream_rq_rx_reset downstream_rq_tx_reset downstream_rq_too_large downstream_rq_max_duration_reached downstream_rq_timeout downstream_rq_overload_close rs_too_large  其它：\n downstream_cx_destroy_remote downstream_cx_destroy_local downstream_cx_length_ms  listeners Envoy 文档:listener stats\n可以认为，这是 downstream 的 L3/L4 层的指标。\n利用率(Utilization):\n downstream_cx_total downstream_cx_active  饱和度(Saturation):\n downstream_pre_cx_active  错误(Error):\n downstream_cx_transport_socket_connect_timeout downstream_cx_overflow no_filter_chain_match downstream_listener_filter_error no_certificate  其它：\n downstream_cx_length_ms  server Envoy 基础信息指标\nEnvoy 文档:server stats\n利用率(Utilization):\n concurrency  错误(Error):\n days_until_first_cert_expiring  watch dog Envoy 文档: Watchdog\nEnvoy 还包括一个可配置的看门狗系统，它可以在 Envoy 没有响应时增加统计数据并选择性地终止服务器。 系统有两个独立的看门狗配置，一个用于主线程，一个用于工作线程； 因为不同的线程有不同的工作负载。 这些统计数据有助于从高层次上理解 Envoy 的事件循环是否因为它正在做太多工作、阻塞或没有被操作系统调度而没有响应。\n饱和度(Saturation):\n watchdog_mega_miss(Counter): mega 未命中数 watchdog_miss(Counter): 未命中数  如果你对 watchdog 机制的兴趣，可以参考：\n https://github.com/envoyproxy/envoy/issues/11391 https://github.com/envoyproxy/envoy/issues/11388\n Event loop Envoy 文档: Event loop\nEnvoy 架构旨在通过在少量线程上运行事件循环来优化可扩展性和资源利用率。 “main” 线程负责控制面处理，每个 “worker” 线程分担数据面的一部分任务。 Envoy 公开了两个统计信息来监控所有这些线程事件循环的性能。\n跑一轮循环的耗时：事件循环的每次迭代都会执行一些任务。任务数量会随着负载的变化而变化。但是，如果一个或多个线程具有异常长尾循环执行耗时，则可能存在性能问题。例如，负责可能在工作线程之间分配不均，或者插件中可能存在长时间阻塞操作阻碍了任务进度。\n轮询延迟：在事件循环的每次迭代中，事件调度程序都会轮询 I/O 事件，并在某些 I/O 事件就绪 或 发生 超时 时 “唤醒” 线程，以先发生者为准。在 超时 的情况下，我们可以测量轮询后预期唤醒时间与实际唤醒时间的差值；这种差异称为 “轮询延迟”。看到一些小的 轮询延迟 是正常的，通常等于内核调度程序的 “时间片(time slice”)” 或 “量子(quantum)” ——这取决于运行 Envoy 的操作系统 —— 但如果这个数字大大高于其正常观察到的基线，它表示内核调度程序可能发生延迟。\n可以通过将 enable_dispatcher_stats 设置为 true 来启用这些统计信息。\n main 线程的事件调度器有一个以 server.dispatcher. 为根的统计树。 每个 worker 线程的事件调度器都有一个以 listener_manager.worker_\u003cid\u003e.dispatcher. 为根的统计树。  每棵树都有以下统计信息：\n   Name Type Description     loop_duration_us Histogram 以微秒为单位的事件循环持续时间   poll_delay_us Histogram 以微秒为单位的轮询延迟    请注意，此处不包括任何辅助(非 main 与 worker)线程。\nWatch Dog 和 Event loop 都是解决与监控事件处理延迟与时效的工具，这里有很多细节和故事，甚至可以说到 Linux Kernel。希望本书后面有时间，可以和大家一起学习和分析这些有趣的细节。 配置说明 本节参考： [Envoy 文档](https://www.envoyproxy.io/docs/envoy/latest/api-v3/config/metrics/v3/stats.proto) config.bootstrap.v3.Bootstrap Envoy 文档:config.bootstrap.v3.Bootstrap proto\n{  \"node\": {...},  \"static_resources\": {...},  \"dynamic_resources\": {...},  \"cluster_manager\": {...},  \"stats_sinks\": [],  \"stats_config\": {...},  \"stats_flush_interval\": {...},  \"stats_flush_on_admin\": ..., ... } 什么是 `stats sink`？ 本书不作说明。Istio 默认没定制相关配置。以下只说关注的部分配置。   stats_config (config.metrics.v3.StatsConfig) 用于内部处理统计信息的配置。\n  stats_flush_interval (Duration) 刷新 stats sink 的时间间隔。。出于性能原因，Envoy 不会实时刷新 counter ，仅定期刷新 counter 和 gauge 。 如果未指定，则默认值为 5000 毫秒。 stats_flush_interval 或 stats_flush_on_admin 只能设置之一。 Duration 必须至少为 1 毫秒，最多为 5 分钟。\n  stats_flush_on_admin (bool) 仅当在 管理界面(admin interface) 上查询时才将统计信息刷新到 sink。 如果设置，则不会创建刷新计时器。 只能设置 stats_flush_on_admin 或 stats_flush_interval 之一。\n  config.metrics.v3.StatsConfig Envoy 文档:config-metrics-v3-statsconfig\n{  \"stats_tags\": [],  \"use_all_default_tags\": {...},  \"stats_matcher\": {...},  \"histogram_bucket_settings\": [] }   stats_tags - 维度提取规则(对应 Prometheus 的 label 提取) (多个 config.metrics.v3.TagSpecifier ) 每个 指标名称字符串 都通过这些标签规则独立处理。 当一个标签匹配时，第一个捕获组不会立即从名称中删除，所以后面的 TagSpecifiers 也可以重复匹配同一部分。在完成所有标签匹配后，再剪裁 指标名称字符串 的匹配部分，并作为 stats sink 的指标名，例如 Prometheus的指标名。\n  use_all_default_tags (BoolValue) 使用 Envoy 中指定的所有默认标签正则表达式。 这些可以与 stats_tags 中指定的自定义标签结合使用。 它们将在自定义标签之前进行处理。Istio 默认为 false.\n  stats_matcher (config.metrics.v3.StatsMatcher) 指定 Envoy 要产出哪些指标。支持 包含/排除 规则指定。 如果未提供，则所有指标都将产出。 阻止某些指标集的统计可以提高一点 Envoy 运行性能。\n  config.metrics.v3.StatsMatcher Envoy 文档:config-metrics-v3-statsmatcher\n用于禁用/开启统计指标计算与产出的配置。\n{  \"reject_all\": ...,  \"exclusion_list\": {...},  \"inclusion_list\": {...} }   reject_all (bool) 如果 reject_all 为 true ，则禁用所有统计信息。 如果 reject_all 为 false，则启用所有统计信息。\n  exclusion_list (type.matcher.v3.ListStringMatcher) 排除列表\n  inclusion_list (type.matcher.v3.ListStringMatcher) 包含列表\n  本节参考了： https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/observability/statistics 下一节，将以 Istio 如何使用上面的配置为例，举例说明。 ","categories":["云原生"],"description":"","excerpt":"Envoy 指标 Envoy 指标概述 Envoy 的主要目标之一是使网络易于理解。 Envoy 会根据其配置方式产生大量统计信息。一般来 …","ref":"/blog/2022/09/13/0affe7/","tags":["istio","envoy","转载"],"title":"Envoy性能指标"},{"body":"","categories":"","description":"","excerpt":"","ref":"/tags/sicader/","tags":"","title":"sicader"},{"body":"在前两篇博客中：\n Istio 中的 Sidecar 注入、透明流量劫持及流量路由过程详解 Sidecar 中的流量类型及 iptables 规则详解  我向你详细介绍了 Istio 数据平面中的流量，但数据平面并不能孤立的存在，本文将向你展示 Istio 中的控制平面和数据平面各组件的端口及其功能，有助于你了解这些流量之间的关系及故障排查。\nIstio 中的组件及端口示意图 按照习惯，我们首先展示一个全局示意图。下图展示的是 Istio 数据平面中 sidecar 的组成，以及与其交互的对象。\n我们可以使用 nsenter 命令进入Bookinfo 示例的 productpage Pod的网络空间，查看其内部监听的端口信息。\n从图中我们可以看到除了 productpage 应用本身监听的 9080 端口以外，Sidecar 容器还有监听大量的其他端口，如 15000、15001、15004、15006、15021、15090 等，你可以在 Istio 文档上了解 Istio 中使用的端口。\n我们再进入 productpage Pod 中，使用 lsof -i 命令查看它打开的端口，如下图所示。\n!我们可以看到其中有 pilot-agent 与 istiod 建立了 TCP 连接，上文中所述的监听中的端口，还有在 Pod 内部建立的 TCP 连接，这些连接对应了文章开头的示意图。\nSidecar 容器（istio-proxy ）的根进程是 pilot-agent，启动命令如下图所示：\n从图中我们可以看到，它 pilot-agent 进程的 PID 是 1，是它拉起了 envoy 进程。\n在 istiod 的 Pod 中查看它打开的端口，如下图所示。\n我们可以看到其中的监听的端口、进程间和远程通信连接。\nIstio 中各端口的功能概述 这些端口在你进行问题排查时可以起着举足轻重的作用。下面将根据端口所在的组件和功能分类描述。\nIstiod 中的端口 Istiod 中的端口相对比较少且功能单一：\n 9876：ControlZ 用户界面，暴露 istiod 的进程信息 8080：istiod 调试端口，通过该端口可以查询网格的配置和状态信息 15010：暴露 xDS API 和颁发纯文本证书 15012：功能同 15010 端口，但使用 TLS 通信 15014：暴露控制平面的指标给 Prometheus 15017：Sidecar 注入和配置校验端口  Sidecar 中的端口 从上文中，我们看到 sidecar 中有众多端口：\n 15000：Envoy 管理接口，你可以用它来查询和修改 Envoy 代理的的配置，详情请参考 Envoy 文档。 15001：用于处理出站流量。 15004：调试端口，将在下文中解释。 15006：用于处理入站流量。 15020：汇总统计数据，对 Envoy 和 DNS 代理进行健康检查，调试 pilot-agent 进程，将在下文中详细解释。 15021：用于 sidecar 健康检查，以判断已注入 Pod 是否准备好接收流量。我们在该端口的 /healthz/ready 路径上设置了就绪探针，Istio 把 sidecar 的就绪检测交给了 kubelet，最大化利用 Kubernetes 平台自身的功能。envoy 进程将健康检查路由到 pilot-agent 进程的 15020 端口，实际的健康检查将发生在那里。 15053：本地 DNS 代理，用于解析 Kubernetes DNS 解析不了的集群内部域名的场景。 15090：Envoy Prometheus 查询端口，pilot-agent 将通过此端口收集统计信息。  以上端口可以分为以下几类：\n 负责进程间通信，例如 15001、15006、15053 负责健康检查和信息统计，例如 150021、15090 调试：15000、15004  下文将对几个重点端口详解。\n15000 端口 15000 是 Envoy 的 Admin 接口，该接口允许我们修改 Envoy，并获得一个视图和查询指标和配置。\n管理接口由一个具有多个端点的 REST API 和一个简单的用户界面组成，你可以使用下面的命令开启 productpage Pod 中的 Envoy 管理接口视图。\nkubectl -n default port-forward deploy/productpage-v1 15000 在浏览器中访问 http://localhost:15000，你将看到 Envoy Admin 界面如下图所示。\n15004 端口 通过 pilot-agent 代理 istiod 8080 端口上的调试端点，你可以进入数据平面 Pod 中访问 localhost 的 15004 端口查询网格信息，其效果与下面的 8080 端口等同。\n8080 端口 你还可以在本地转发 istiod 8080 端口，请运行下面的命令。\nkubectl -n istio-system port-forward deploy/istiod 8080 在浏览器中访问 http://localhost:8080/debug，你将看到调试端点，如下图所示。\n当然，这只是一种获取网格信息和调试网格的方式，你还可以使用 istioctl 命令或 Kiali 来调试，那样将更加高效和直观。\n15020 端口 15020 端口有三大功能：\n 汇总统计数据：查询 15090 端口获取 envoy 的指标，也可以配置查询应用程序的指标，将 envoy、应用程序和自身的指标汇总以供 Prometheus 收集。对应的调试端点是 /stats/prometheus。 对 Envoy 和 DNS 代理进行健康检查：对应的调试端点是 /healthz/ready 和 /app-health。 调试 pilot-agent 进程：对应的调试端点是 /quitquitquit、debug/ndsz 和 /debug/pprof。  下图展示的是使用本地端口转发后，在浏览器中打开 http://localhost:15020/debug/pprof 看到的调试信息。\n图中信息展示的是 pilot-agent 的堆栈信息。\n总结 通过对 Istio 中各组件端口的了解，你应该对 Istio 中各组件的关系及其内部流量有了更进一步的认识，熟悉这些端口的功能，有助于对网格的故障排除。\n","categories":["云原生"],"description":"","excerpt":"在前两篇博客中：\n Istio 中的 Sidecar 注入、透明流量劫持及流量路由过程详解 Sidecar 中的流量类型及 iptables …","ref":"/blog/2022/09/12/6be15f/","tags":["istio","sicader","转载"],"title":"深入Istio系列-组件详解"},{"body":"我在之前的一篇博客中讲解过 Istio 中 sidecar 的注入、使用 iptables 进行透明流量拦截及流量路由的详细过程，并以 Bookinfo 示例中的 productpage 服务访问 reviews 服务，和 reviews 服务访问 ratings 服务为例绘制了透明流量劫持示意图。在那个示意图中仅展示了 reviews pod 接收流量和对外访问的路由，实际上 sidecar 内的流量远不止于此。\nISTIO_OUTPUT 规则 在所有的 iptables 调用链中最复杂的一个是 ISTIO_OUTPUT，其中共有 9 条规则如下：\n   Rule target in out source destination     1 RETURN any lo 127.0.0.6 anywhere   2 ISTIO_IN_REDIRECT any lo anywhere !localhost owner UID match 1337   3 RETURN any lo anywhere anywhere !owner UID match 1337   4 RETURN any any anywhere anywhere owner UID match 1337   5 ISTIO_IN_REDIRECT any lo anywhere !localhost owner GID match 1337   6 RETURN any lo anywhere anywhere !owner GID match 1337   7 RETURN any any anywhere anywhere owner GID match 1337   8 RETURN any any anywhere localhost   9 ISTIO_REDIRECT any any anywhere anywhere    本文将向你展示 Istio sidecar 中的六种流量类型及其 iptables 规则， 以示意图的形式带你一览其全貌，其中详细指出了路由具体使用的是 ISTIO_OUTPUT 中的哪一条规则。\nSidecar 中的 iptables 流量路由 Sidecar 中的流量可以划分为以下几类：\n 远程服务访问本地服务：Remote Pod -\u003e Local Pod 本地服务访问远程服务：Local Pod -\u003e Remote Pod Prometheus 抓取本地服务的 metrics：Prometheus -\u003e Local Pod 本地 Pod 服务间的流量：Local Pod -\u003e Local Pod Envoy 内部的进程间 TCP 流量 Sidecar 到 Istiod 的流量  下面将依次解释每个场景下 Sidecar 内的 iptables 路由规则。\n类型一：Remote Pod -\u003e Local Pod 以下是远程服务、应用或客户端访问数据平面本地 Pod IP 的 iptables 规则。\nRemote Pod -\u003e RREROUTING -\u003e ISTIO_INBOUND -\u003e ISTIO_IN_REDIRECT -\u003e Envoy 15006（Inbound）-\u003e OUTPUT -\u003e ISTIO_OUTPUT RULE 1 -\u003e POSTROUTING -\u003e Local Pod\n我们看到流量只经过一次 Envoy 15006 Inbound 端口。这种场景下的 iptables 规则的示意图如下。\n类型二：Local Pod -\u003e Remote Pod 以下是本地 Pod IP 访问远程服务经过的 iptables 规则。\nLocal Pod-\u003e OUTPUT -\u003e ISTIO_OUTPUT RULE 9 -\u003e ISTIO_REDIRECT -\u003e Envoy 15001（Outbound）-\u003e OUTPUT -\u003e ISTIO_OUTPUT RULE 4 -\u003e POSTROUTING -\u003e Remote Pod\n我们看到流量只经过 Envoy 15001 Outbound 端口。\n以上两种场景中的流量都只经过一次 Envoy，因为该 Pod 中只有发出或接受请求一种场景发生。\n类型三：Prometheus -\u003e Local Pod Prometheus 抓取数据平面 metrics 的流量不会也无须经过 Envoy 代理。\n这些流量通过的 iptables 规则如下。\nPrometheus-\u003e RREROUTING -\u003e ISTIO_INBOUND（对目的地为 15002、15090 端口流量将转到 INPUT）-\u003e INPUT -\u003e Local Pod\n这种场景下的 iptables 规则的示意图如下。\n类型四：Local Pod -\u003e Local Pod 一个 Pod 可能同时存在两个或多个服务，如果 Local Pod 访问的服务也在该当前 Pod 上，流量会依次经过 Envoy 15001 和 Envoy 15006 端口最后到达本地 Pod 的服务端口上。\n这些流量通过的 iptables 规则如下。\nLocal Pod-\u003e OUTPUT -\u003e ISTIO_OUTPUT RULE 9 -\u003e ISTIO_REDIRECT -\u003e Envoy 15001（Outbound）-\u003e OUTPUT -\u003e ISTIO_OUTPUT RULE 2 -\u003e ISTIO_IN_REDIRECT -\u003e Envoy 15006（Inbound）-\u003e OUTPUT -\u003e ISTIO_OUTPUT RULE 1 -\u003e POSTROUTING -\u003e Local Pod\n类型五：Envoy 内部的进程间 TCP 流量 Envoy 内部进程的 UID 和 GID 为 1337，它们之间的流量将使用 lo 网卡，使用 localhost 域名来通信。\n这些流量通过的 iptables 规则如下。\nEnvoy 进程（Localhost） -\u003e OUTPUT -\u003e ISTIO_OUTPUT RULE 8 -\u003e POSTROUTING -\u003e Envoy 进程（Localhost）\n类型六：Sidecar 到 Istiod 的流量 Sidecar 需要访问 Istiod 以同步配置，pilot-agent 进程会向 Istiod 发送请求，以同步配置。\n这些流量通过的 iptables 规则如下。\npilot-agent 进程 -\u003e OUTPUT -\u003e Istio_OUTPUT RULE 9 -\u003e Envoy 15001 (Outbound Handler) -\u003e OUTPUT -\u003e ISTIO_OUTPUT RULE 4 -\u003e POSTROUTING -\u003e Istiod\n总结 Istio 注入在 Pod 内或虚拟机中安装的所有 sidecar 代理组成了服务网格的数据平面，也是 Istio 的主要工作负载所在地，通过 Istio 中的透明流量劫持 及这篇博客，相信你一定对 sidecar 代理中的流量有了一个深刻的了解，但这还只是管中窥豹，略见一斑，在我的下一篇博客中，我将带你了解 Envoy 中各个组件的端口及其功能，这样可以让我们对 Istio 中的流量有一个更全面的了解。\n","categories":["云原生"],"description":"","excerpt":"我在之前的一篇博客中讲解过 Istio 中 sidecar 的注入、使用 iptables 进行透明流量拦截及流量路由的详细过程， …","ref":"/blog/2022/09/11/61aaaf/","tags":["sicader","转载"],"title":"深入Istio系列-Sidecar 中的流量类型及 iptables 规则详解"},{"body":"本文最早是基于 Istio 1.11 撰写，之后随着 Istio 的版本陆续更新，最新更新时间为 2022 年 5 月 12 日，关于本文历史版本的更新说明请见文章最后。本文记录了详细的实践过程，力图能够让读者复现，因此事无巨细，想要理解某个部分过程的读者可以使用目录跳转到对应的小节阅读。\n为了理解本文希望你先阅读以下内容：\n 理解 iptables Istio 数据平面 Pod 启动过程详解  内容介绍 本文基于 Istio 1.13 版本，将为大家介绍以下内容：\n 什么是 sidecar 模式和它的优势在哪里。 Istio 中是如何做 sidecar 注入的。 Sidecar 代理是如何做透明流量劫持的。 iptables 的路由规则。 Envoy 代理是如何路由流量到上游的。  请大家结合下图理解本文中的内容，本图基于 Istio 官方提供的 Bookinfo 示例绘制，展示的是 reviews Pod 的内部结构，包括 Linux Kernel 空间中的 iptables 规则、Sidecar 容器、应用容器。\nproductpage 访问 reviews Pod，入站流量处理过程对应于图示上的步骤：1、2、3、4、Envoy Inbound Handler、5、6、7、8、应用容器。\nreviews Pod 访问 rating 服务的出站流量处理过程对应于图示上的步骤是：9、10、11、12、Envoy Outbound Handler、13、14、15。\n注意：图中的路径 16 近用于路由规则说明，它不不出现在当前示例中。实际上仅当 Pod 内发出的对当前 Pod 内的服务访问的时候才会途径它。\n上图中关于流量路由部分，包含：\n productpage 服务请求访问 http://reviews.default.svc.cluster.local:9080/，当流量进入 reviews Pod 内部时，流量是如何被 iptables 劫持到 Envoy 代理被 Inbound Handler 处理的； reviews 请求访问 ratings 服务的 Pod，应用程序发出的出站流量被 iptables 劫持到 Envoy 代理的 Outbound Handler 的处理。  在阅读下文时，请大家确立以下已知点：\n 首先，productpage 发出的对 reivews 的访问流量，是在 Envoy 已经通过 EDS 选择出了要请求的 reviews 服务的某个 Pod，知晓了其 IP 地址，直接向该 IP 发送的 TCP 连接请求。 reviews 服务有三个版本，每个版本有一个实例，三个版本中的 sidecar 工作步骤类似，下文只以其中一个 Pod 中的 sidecar 流量转发步骤来说明。 所有进入 reviews Pod 的 TCP 流量都根据 Pod 中的 iptables 规则转发到了 Envoy 代理的 15006 端口，然后经过 Envoy 的处理确定转发给 Pod 内的应用容器还是透传。  Sidecar 模式 将应用程序的功能划分为单独的进程运行在同一个最小调度单元中（例如 Kubernetes 中的 Pod）可以被视为 sidecar 模式。如下图所示，sidecar 模式允许您在应用程序旁边添加更多功能，而无需额外第三方组件配置或修改应用程序代码。\n就像连接了 Sidecar 的三轮摩托车一样，在软件架构中， Sidecar 连接到父应用并且为其添加扩展或者增强功能。Sidecar 应用与主应用程序松散耦合。它可以屏蔽不同编程语言的差异，统一实现微服务的可观察性、监控、日志记录、配置、断路器等功能。\n使用 Sidecar 模式的优势 使用 sidecar 模式部署服务网格时，无需在节点上运行代理，但是集群中将运行多个相同的 sidecar 副本。在 sidecar 部署方式中，每个应用的容器旁都会部署一个伴生容器（如 Envoy 或 MOSN），这个容器称之为 sidecar 容器。Sidecar 接管进出应用容器的所有流量。在 Kubernetes 的 Pod 中，在原有的应用容器旁边注入一个 Sidecar 容器，两个容器共享存储、网络等资源，可以广义的将这个包含了 sidecar 容器的 Pod 理解为一台主机，两个容器共享主机资源。\n因其独特的部署结构，使得 sidecar 模式具有以下优势：\n 将与应用业务逻辑无关的功能抽象到共同基础设施，降低了微服务代码的复杂度。 因为不再需要编写相同的第三方组件配置文件和代码，所以能够降低微服务架构中的代码重复度。 Sidecar 可独立升级，降低应用程序代码和底层平台的耦合度。  Sidecar 注入示例分析 以 Istio 官方提供的 bookinfo 中 productpage 的 YAML 为例，关于 bookinfo 应用的详细 YAML 配置请参考 bookinfo.yaml。\n下文将从以下几个方面讲解：\n Sidecar 容器的注入 iptables 规则的创建 路由的详细过程  apiVersion: apps/v1 kind: Deployment metadata:  name: productpage-v1  labels:  app: productpage  version: v1 spec:  replicas: 1  selector:  matchLabels:  app: productpage  version: v1  template:  metadata:  labels:  app: productpage  version: v1  spec:  serviceAccountName: bookinfo-productpage  containers:  - name: productpage  image: docker.io/istio/examples-bookinfo-productpage-v1:1.15.0  imagePullPolicy: IfNotPresent  ports:  - containerPort: 9080  volumeMounts:  - name: tmp  mountPath: /tmp  volumes:  - name: tmp  emptyDir: {} 再查看下 productpage 容器的 Dockerfile。\nFROMpython:3.7.4-slimCOPY requirements.txt ./RUN pip install --no-cache-dir -r requirements.txtCOPY test-requirements.txt ./RUN pip install --no-cache-dir -r test-requirements.txtCOPY productpage.py /opt/microservices/COPY tests/unit/* /opt/microservices/COPY templates /opt/microservices/templatesCOPY static /opt/microservices/staticCOPY requirements.txt /opt/microservices/ARG flood_factorENV FLOOD_FACTOR ${flood_factor:-0}EXPOSE9080WORKDIR/opt/microservicesRUN python -m unittest discoverUSER1CMD [\"python\", \"productpage.py\", \"9080\"]我们看到 Dockerfile 中没有配置 ENTRYPOINT，所以 CMD 的配置 python productpage.py 9080 将作为默认的 ENTRYPOINT，记住这一点，再看下注入 sidecar 之后的配置。\n$ istioctl kube-inject -f samples/bookinfo/platform/kube/bookinfo.yaml 我们只截取其中与 productpage 相关的 Deployment 配置中的部分 YAML 配置。\n containers:  - image: docker.io/istio/examples-bookinfo-productpage-v1:1.15.0 # 应用镜像  name: productpage  ports:  - containerPort: 9080  - args:  - proxy  - sidecar  - --domain  - $(POD_NAMESPACE).svc.cluster.local  - --configPath  - /etc/istio/proxy  - --binaryPath  - /usr/local/bin/envoy  - --serviceCluster  - productpage.$(POD_NAMESPACE)  - --drainDuration  - 45s  - --parentShutdownDuration  - 1m0s  - --discoveryAddress  - istiod.istio-system.svc:15012  - --zipkinAddress  - zipkin.istio-system:9411  - --proxyLogLevel=warning  - --proxyComponentLogLevel=misc:error  - --connectTimeout  - 10s  - --proxyAdminPort  - \"15000\"  - --concurrency  - \"2\"  - --controlPlaneAuthPolicy  - NONE  - --dnsRefreshRate  - 300s  - --statusPort  - \"15020\"  - --trust-domain=cluster.local  - --controlPlaneBootstrap=false  image: docker.io/istio/proxyv2:1.5.1 # sidecar proxy  name: istio-proxy  ports:  - containerPort: 15090  name: http-envoy-prom  protocol: TCP  initContainers:  - command:  - istio-iptables  - -p  - \"15001\"  - -z  - \"15006\"  - -u  - \"1337\"  - -m  - REDIRECT  - -i  - '*'  - -x  - \"\"  - -b  - '*'  - -d  - 15090,15020  image: docker.io/istio/proxyv2:1.5.1 # init 容器  name: istio-init Istio 给应用 Pod 注入的配置主要包括：\n Init 容器 istio-init：用于 pod 中设置 iptables 端口转发 Sidecar 容器 istio-proxy：运行 sidecar 代理，如 Envoy 或 MOSN。  iptables 规则注入解析 为了查看 iptables 配置，我们需要登陆到 sidecar 容器中使用 root 用户来查看，因为 kubectl 无法使用特权模式来远程操作 docker 容器，所以我们需要登陆到 productpage pod 所在的主机上使用 docker 命令登陆容器中查看。\n如果您使用 minikube 部署的 Kubernetes，可以直接登录到 minikube 的虚拟机中并切换为 root 用户。查看 iptables 配置，列出 NAT（网络地址转换）表的所有规则，因为在 Init 容器启动的时候选择给 istio-iptables 传递的参数中指定将入站流量重定向到 sidecar 的模式为 REDIRECT，因此在 iptables 中将只有 NAT 表的规格配置，如果选择 TPROXY 还会有 mangle 表配置。iptables 命令的详细用法请参考 iptables 命令。\n我们仅查看与 productpage 有关的 iptables 规则如下，因为这些规则是运行在该容器特定的网络空间下，因此需要使用 nsenter 命令进入其网络空间。进入的时候需要指定进程 ID（PID），因此首先我们需要找到 productpage 容器的 PID。对于在不同平台上安装的 Kubernetes，查找容器的方式会略有不同，例如在 GKE 上，执行 docker ps -a 命令是查看不到任何容器进程的。下面已 minikube 和 GKE 两个典型的平台为例，指导你如何进入容器的网络空间。\n在 minikube 中查看容器中的 iptabes 规则 对于 minikube，因为所有的进程都运行在单个节点上，因此你只需要登录到 minikube 虚拟机，切换为 root 用户然后查找 productpage 进程即可，参考下面的步骤。\n# 进入 minikube 并切换为 root 用户，minikube 默认用户为 docker $ minikube ssh $ sudo -i  # 查看 productpage pod 的 istio-proxy 容器中的进程 $ docker top `docker ps|grep \"istio-proxy_productpage\"|cut -d \" \" -f1` UID PID PPID C STIME TTY TIME CMD 1337 10576 10517 0 08:09 ? 00:00:07 /usr/local/bin/pilot-agent proxy sidecar --domain default.svc.cluster.local --configPath /etc/istio/proxy --binaryPath /usr/local/bin/envoy --serviceCluster productpage.default --drainDuration 45s --parentShutdownDuration 1m0s --discoveryAddress istiod.istio-system.svc:15012 --zipkinAddress zipkin.istio-system:9411 --proxyLogLevel=warning --proxyComponentLogLevel=misc:error --connectTimeout 10s --proxyAdminPort 15000 --concurrency 2 --controlPlaneAuthPolicy NONE --dnsRefreshRate 300s --statusPort 15020 --trust-domain=cluster.local --controlPlaneBootstrap=false 1337 10660 10576 0 08:09 ? 00:00:33 /usr/local/bin/envoy -c /etc/istio/proxy/envoy-rev0.json --restart-epoch 0 --drain-time-s 45 --parent-shutdown-time-s 60 --service-cluster productpage.default --service-node sidecar~172.17.0.16~productpage-v1-7f44c4d57c-ksf9b.default~default.svc.cluster.local --max-obj-name-len 189 --local-address-ip-version v4 --log-format [Envoy (Epoch 0)] [%Y-%m-%d %T.%e][%t][%l][%n] %v -l warning --component-log-level misc:error --concurrency 2  # 使用 nsenter 进入 sidecar 容器的命名空间（以上任何一个都可以） $ nsenter -n --target 10660  # 查看 NAT 表中规则配置的详细信息。 $ iptables -t nat -L 在 GKE 中查看容器的 iptables 规则 如果你在 GKE 中安装的多节点的 Kubernetes 集群，首先你需要确定这个 Pod 运行在哪个节点上，然后登陆到那台主机，使用下面的命令查找进程的 PID，你会得到类似下面的输出。\n$ ps aux|grep \"productpage\" chronos 4268 0.0 0.6 43796 24856 ? Ss Apr22 0:00 python productpage.py 9080 chronos 4329 0.9 0.6 117524 24616 ? Sl Apr22 13:43 /usr/local/bin/python /opt/microservices/productpage.py 9080 root 361903 0.0 0.0 4536 812 pts/0 S+ 01:54 0:00 grep --colour=auto productpage 然后在终端中输出 iptables -t nat -L 即可查看 iptables 规则。\niptables 流量劫持过程详解 经过上面的步骤，你已经可以查看到 init 容器向 Pod 中注入的 iptables 规则，如下所示。\n# PREROUTING 链：用于目标地址转换（DNAT），将所有入站 TCP 流量跳转到 ISTIO_INBOUND 链上。 Chain PREROUTING (policy ACCEPT 2701 packets, 162K bytes)  pkts bytes target prot opt in out source destination  2701 162K ISTIO_INBOUND tcp -- any any anywhere anywhere  # INPUT 链：处理输入数据包，非 TCP 流量将继续 OUTPUT 链。 Chain INPUT (policy ACCEPT 2701 packets, 162K bytes)  pkts bytes target prot opt in out source destination  # OUTPUT 链：将所有出站数据包跳转到 ISTIO_OUTPUT 链上。 Chain OUTPUT (policy ACCEPT 79 packets, 6761 bytes)  pkts bytes target prot opt in out source destination  15 900 ISTIO_OUTPUT tcp -- any any anywhere anywhere  # POSTROUTING 链：所有数据包流出网卡时都要先进入 POSTROUTING 链，内核根据数据包目的地判断是否需要转发出去，我们看到此处未做任何处理。 Chain POSTROUTING (policy ACCEPT 79 packets, 6761 bytes)  pkts bytes target prot opt in out source destination  # ISTIO_INBOUND 链：将所有入站流量重定向到 ISTIO_IN_REDIRECT 链上。目的地为 15090（Prometheus 使用）和 15020（Ingress gateway 使用，用于 Pilot 健康检查）端口的流量除外，发送到以上两个端口的流量将返回 iptables 规则链的调用点，即 PREROUTING 链的后继 POSTROUTING 后直接调用原始目的地。 Chain ISTIO_INBOUND (1 references)  pkts bytes target prot opt in out source destination  0 0 RETURN tcp -- any any anywhere anywhere tcp dpt:ssh  2 120 RETURN tcp -- any any anywhere anywhere tcp dpt:15090  2699 162K RETURN tcp -- any any anywhere anywhere tcp dpt:15020  0 0 ISTIO_IN_REDIRECT tcp -- any any anywhere anywhere  # ISTIO_IN_REDIRECT 链：将所有的入站流量跳转到本地的 15006 端口，至此成功的拦截了流量到 sidecar 代理的 Inbound Handler 中。 Chain ISTIO_IN_REDIRECT (3 references)  pkts bytes target prot opt in out source destination  0 0 REDIRECT tcp -- any any anywhere anywhere redir ports 15006  # ISTIO_OUTPUT 链：规则比较复杂，将在下文解释 Chain ISTIO_OUTPUT (1 references)  pkts bytes target prot opt in out source destination  0 0 RETURN all -- any lo 127.0.0.6 anywhere #规则1  0 0 ISTIO_IN_REDIRECT all -- any lo anywhere !localhost owner UID match 1337 #规则2  0 0 RETURN all -- any lo anywhere anywhere ! owner UID match 1337 #规则3  15 900 RETURN all -- any any anywhere anywhere owner UID match 1337 #规则4  0 0 ISTIO_IN_REDIRECT all -- any lo anywhere !localhost owner GID match 1337 #规则5  0 0 RETURN all -- any lo anywhere anywhere ! owner GID match 1337 #规则6  0 0 RETURN all -- any any anywhere anywhere owner GID match 1337 #规则7  0 0 RETURN all -- any any anywhere localhost #规则8  0 0 ISTIO_REDIRECT all -- any any anywhere anywhere #规则9  # ISTIO_REDIRECT 链：将所有流量重定向到 Envoy 代理的 15001 端口。 Chain ISTIO_REDIRECT (1 references)  pkts bytes target prot opt in out source destination  0 0 REDIRECT tcp -- any any anywhere anywhere redir ports 15001 这里着重需要解释的是 ISTIO_OUTPUT 链中的 9 条规则，为了便于阅读，我将以上规则中的部分内容使用表格的形式来展示如下：\n   规则 target in out source destination     1 RETURN any lo 127.0.0.6 anywhere   2 ISTIO_IN_REDIRECT any lo anywhere !localhost owner UID match 1337   3 RETURN any lo anywhere anywhere !owner UID match 1337   4 RETURN any any anywhere anywhere owner UID match 1337   5 ISTIO_IN_REDIRECT any lo anywhere !localhost owner GID match 1337   6 RETURN any lo anywhere anywhere !owner GID match 1337   7 RETURN any any anywhere anywhere owner GID match 1337   8 RETURN any any anywhere localhost   9 ISTIO_REDIRECT any any anywhere anywhere    下图展示了 ISTIO_ROUTE 规则的详细流程。\n我将按照规则的出现顺序来解释每条规则的目的、对应文章开头图示中的步骤及详情。其中规则 5、6、7 是分别对规则 2、3、4 的应用范围扩大（从 UID 扩大为 GID），作用是类似的，将合并解释。注意，其中的规则是按顺序执行的，也就是说排序越靠后的规则将作为默认值。出站网卡（out）为 lo （本地回环地址，loopback 接口）时，表示流量的目的地是本地 Pod，对于 Pod 向外部发送的流量就不会经过这个接口。所有 review Pod 的出站流量只适用于规则 4、7、8、9。\n规则 1\n 目的：透传 Envoy 代理发送到本地应用容器的流量，使其绕过 Envoy 代理，直达应用容器。 对应图示中的步骤：6 到 7。 详情：该规则使得所有来自 127.0.0.6（该 IP 地址将在下文解释） 的请求，跳出该链，返回 iptables 的调用点（即 OUTPUT）后继续执行其余路由规则，即 POSTROUTING 规则，把流量发送到任意目的地址，如本地 Pod 内的应用容器。如果没有这条规则，由 Pod 内 Envoy 代理发出的对 Pod 内容器访问的流量将会执行下一条规则，即规则 2，流量将再次进入到了 Inbound Handler 中，从而形成了死循环。将这条规则放在第一位可以避免流量在 Inbound Handler 中死循环的问题。  规则 2、5\n 目的：处理 Envoy 代理发出的站内流量（Pod 内部的流量），但不是对 localhost 的请求，通过后续规则将其转发给 Envoy 代理的 Inbound Handler。该规则适用于 Pod 对自身 IP 地址调用的场景，即 Pod 内服务之间的访问。 详情：如果流量的目的地非 localhost，且数据包是由 1337 UID（即 istio-proxy 用户，Envoy 代理）发出的，流量将被经过 ISTIO_IN_REDIRECT 最终转发到 Envoy 的 Inbound Handler。  规则 3、6\n 目的：透传 Pod 内的应用容器的站内流量。该规则适用于容器内部的流量。例如在 Pod 内对 Pod IP 或 localhost 的访问。 对应图示中的步骤：6 到 7。 详情：如果流量不是由 Envoy 用户发出的，那么就跳出该链，返回 OUTPUT 调用 POSTROUTING，直达目的地。  规则 4、7\n 目的：透传 Envoy 代理发出的出站请求。 对应图示中的步骤：14 到 15。 详情：如果请求是由 Envoy 代理发出的，则返回 OUTPUT 继续调用 POSTROUTING 规则，最终直接访问目的地。  规则 8\n 目的：透传 Pod 内部对 localhost 的请求。 详情：如果请求的目的地是 localhost，则返回 OUTPUT 调用 POSTROUTING，直接访问 localhost。  规则 9\n 目的：所有其他的流量将被转发到 ISTIO_REDIRECT 后，最终达到 Envoy 代理的 Outbound Handler。 对应图示中的步骤：10 到 11。  以上规则避免了 Envoy 代理到应用程序的路由在 iptables 规则中的死循环，保障了流量可以被正确的路由到 Envoy 代理上，也可以发出真正的出站请求。\n关于 RETURN target\n你可能留意到上述规则中有很多 RETURN target，它的意思是，指定到这条规则时，跳出该规则链，返回 iptables 的调用点（在我们的例子中即 OUTPUT）后继续执行其余路由规则，在我们的例子中即 POSTROUTING 规则，把流量发送到任意目的地址，你可以把它直观的理解为透传。\n关于 127.0.0.6 IP 地址\n127.0.0.6 这个 IP 是 Istio 中默认的 InboundPassthroughClusterIpv4，在 Istio 的代码中指定。即流量在进入 Envoy 代理后被绑定的 IP 地址，作用是让 Outbound 流量重新发送到 Pod 中的应用容器，即 Passthought（透传），绕过 Outbound Handler。该流量是对 Pod 自身的访问，而不是真正的对外流量。至于为什么选择这个 IP 作为流量透传，请参考 Istio Issue-29603。\n流量路由过程详解 通过上文，你已经了解了 Istio 是如何在 Pod 中做透明流量劫持的，那么流量被劫持到 Envoy 代理中之后是如何被处理的呢？流量路由分为 Inbound 和 Outbound 两个过程，下面将根据上文中的示例及 sidecar 的配置为读者详细分析此过程。\n理解 Inbound Handler Inbound Handler 的作用是将 iptables 拦截到的 downstream 的流量转发给 Pod 内的应用程序容器。在我们的实例中，假设其中一个 Pod 的名字是 reviews-v1-545db77b95-jkgv2，运行 istioctl proxy-config listener reviews-v1-545db77b95-jkgv2 --port 15006 查看该 Pod 中 15006 端口上的监听器情况 ，你将看到下面的输出。\nADDRESS PORT MATCH DESTINATION 0.0.0.0 15006 Addr: *:15006 Non-HTTP/Non-TCP 0.0.0.0 15006 Trans: tls; App: istio-http/1.0,istio-http/1.1,istio-h2; Addr: 0.0.0.0/0 InboundPassthroughClusterIpv4 0.0.0.0 15006 Trans: raw_buffer; App: http/1.1,h2c; Addr: 0.0.0.0/0 InboundPassthroughClusterIpv4 0.0.0.0 15006 Trans: tls; App: TCP TLS; Addr: 0.0.0.0/0 InboundPassthroughClusterIpv4 0.0.0.0 15006 Trans: raw_buffer; Addr: 0.0.0.0/0 InboundPassthroughClusterIpv4 0.0.0.0 15006 Trans: tls; Addr: 0.0.0.0/0 InboundPassthroughClusterIpv4 0.0.0.0 15006 Trans: tls; App: istio,istio-peer-exchange,istio-http/1.0,istio-http/1.1,istio-h2; Addr: *:9080 Cluster: inbound|9080|| 0.0.0.0 15006 Trans: raw_buffer; Addr: *:9080 Cluster: inbound|9080|| 下面列出了以上输出中各字段的含义：\n ADDRESS：下游地址 PORT：Envoy 监听器监听的端口 MATCH：请求使用的传输协议或匹配的下游地址 DESTINATION：路由目的地  reviews Pod 中的 Iptables 将入站流量劫持到 15006 端口上，从上面的输出我们可以看到 Envoy 的 Inbound Handler 在 15006 端口上监听，对目的地为任何 IP 的 9080 端口的请求将路由到 inbound|9080|| Cluster 上。\n从该 Pod 的 Listener 列表的最后两行中可以看到，0.0.0.0:15006/TCP 的 Listener（其实际名字是 virtualInbound）监听所有的 Inbound 流量，其中包含了匹配规则，来自任意 IP 的对 9080 端口的访问流量，将会路由到 inbound|9080|| Cluster，如果你想以 Json 格式查看该 Listener 的详细配置，可以执行 istioctl proxy-config listeners reviews-v1-545db77b95-jkgv2 --port 15006 -o json 命令，你将获得类似下面的输出。\n[  /*省略部分内容*/  {  \"name\": \"virtualInbound\",  \"address\": {  \"socketAddress\": {  \"address\": \"0.0.0.0\",  \"portValue\": 15006  }  },  \"filterChains\": [  /*省略部分内容*/  {  \"filterChainMatch\": {  \"destinationPort\": 9080,  \"transportProtocol\": \"tls\",  \"applicationProtocols\": [  \"istio\",  \"istio-peer-exchange\",  \"istio-http/1.0\",  \"istio-http/1.1\",  \"istio-h2\"  ]  },  \"filters\": [  /*省略部分内容*/  {  \"name\": \"envoy.filters.network.http_connection_manager\",  \"typedConfig\": {  \"@type\": \"type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager\",  \"statPrefix\": \"inbound_0.0.0.0_9080\",  \"routeConfig\": {  \"name\": \"inbound|9080||\",  \"virtualHosts\": [  {  \"name\": \"inbound|http|9080\",  \"domains\": [  \"*\"  ],  \"routes\": [  {  \"name\": \"default\",  \"match\": {  \"prefix\": \"/\"  },  \"route\": {  \"cluster\": \"inbound|9080||\",  \"timeout\": \"0s\",  \"maxStreamDuration\": {  \"maxStreamDuration\": \"0s\",  \"grpcTimeoutHeaderMax\": \"0s\"  }  },  \"decorator\": {  \"operation\": \"reviews.default.svc.cluster.local:9080/*\"  }  }  ]  }  ],  \"validateClusters\": false  },  /*省略部分内容*/  }  }  ],  /*省略部分内容*/  ],  \"listenerFilters\": [  /*省略部分内容*/  ],  \"listenerFiltersTimeout\": \"0s\",  \"continueOnListenerFiltersTimeout\": true,  \"trafficDirection\": \"INBOUND\"  } ] 既然 Inbound Handler 的流量中将来自任意地址的对该 Pod 9080 端口的流量路由到 inbound|9080|| Cluster，那么我们运行 istioctl pc cluster reviews-v1-545db77b95-jkgv2 --port 9080 --direction inbound -o json 查看下该 Cluster 配置，你将获得类似下面的输出。\n[  {  \"name\": \"inbound|9080||\",  \"type\": \"ORIGINAL_DST\",  \"connectTimeout\": \"10s\",  \"lbPolicy\": \"CLUSTER_PROVIDED\",  \"circuitBreakers\": {  \"thresholds\": [  {  \"maxConnections\": 4294967295,  \"maxPendingRequests\": 4294967295,  \"maxRequests\": 4294967295,  \"maxRetries\": 4294967295,  \"trackRemaining\": true  }  ]  },  \"cleanupInterval\": \"60s\",  \"upstreamBindConfig\": {  \"sourceAddress\": {  \"address\": \"127.0.0.6\",  \"portValue\": 0  }  },  \"metadata\": {  \"filterMetadata\": {  \"istio\": {  \"services\": [  {  \"host\": \"reviews.default.svc.cluster.local\",  \"name\": \"reviews\",  \"namespace\": \"default\"  }  ]  }  }  }  } ] 我们看其中的 TYPE 为 ORIGINAL_DST，将流量发送到原始目标地址（Pod IP），因为原始目标地址即当前 Pod，你还应该注意到 upstreamBindConfig.sourceAddress.address 的值被改写为了 127.0.0.6，而且对于 Pod 内流量是通过 lo 网卡发送的，这刚好呼应了上文中的 iptables ISTIO_OUTPUT 链中的第一条规则，根据该规则，流量将被透传到 Pod 内的应用容器。\n理解 Outbound Handler 在本示例中 reviews 会向 ratings 服务发送 HTTP 请求，请求的地址是：http://ratings.default.svc.cluster.local:9080/，Outbound Handler 的作用是将 iptables 拦截到的本地应用程序向外发出的流量，经由 Envoy 代理路由到上游。\nEnvoy 监听在 15001 端口上监听所有 Outbound 流量，Outbound Handler 处理，然后经过 virtualOutbound Listener、0.0.0.0_9080 Listener，然后通过 Route 9080 找到上游的 cluster，进而通过 EDS 找到 Endpoint 执行路由动作。\nratings.default.svc.cluster.local:9080 路由\n运行 istioctl proxy-config routes reviews-v1-545db77b95-jkgv2 --name 9080 -o json 查看 route 配置，因为 sidecar 会根据 HTTP header 中的 domains 来匹配 VirtualHost，所以下面只列举了 ratings.default.svc.cluster.local:9080 这一个 VirtualHost。\n[  {  \"name\": \"9080\",  \"virtualHosts\": [  {  \"name\": \"ratings.default.svc.cluster.local:9080\",  \"domains\": [  \"ratings.default.svc.cluster.local\",  \"ratings.default.svc.cluster.local:9080\",  \"ratings\",  \"ratings:9080\",  \"ratings.default.svc\",  \"ratings.default.svc:9080\",  \"ratings.default\",  \"ratings.default:9080\",  \"10.8.8.106\",  \"10.8.8.106:9080\"  ],  \"routes\": [  {  \"name\": \"default\",  \"match\": {  \"prefix\": \"/\"  },  \"route\": {  \"cluster\": \"outbound|9080||ratings.default.svc.cluster.local\",  \"timeout\": \"0s\",  \"retryPolicy\": {  \"retryOn\": \"connect-failure,refused-stream,unavailable,cancelled,retriable-status-codes\",  \"numRetries\": 2,  \"retryHostPredicate\": [  {  \"name\": \"envoy.retry_host_predicates.previous_hosts\"  }  ],  \"hostSelectionRetryMaxAttempts\": \"5\",  \"retriableStatusCodes\": [  503  ]  },  \"maxStreamDuration\": {  \"maxStreamDuration\": \"0s\",  \"grpcTimeoutHeaderMax\": \"0s\"  }  },  \"decorator\": {  \"operation\": \"ratings.default.svc.cluster.local:9080/*\"  }  }  ],  \"includeRequestAttemptCount\": true  },  /*省略部分内容*/  ],  \"validateClusters\": false  } ] 从该 Virtual Host 配置中可以看到将流量路由到outbound|9080||ratings.default.svc.cluster.local 集群。\noutbound|9080||ratings.default.svc.cluster.local 集群的端点\n运行 istioctl proxy-config endpoint reviews-v1-545db77b95-jkgv2 --port 9080 -o json --cluster \"outbound|9080||ratings.default.svc.cluster.local\" 查看集群的 Endpoint 配置，结果如下。\n[  {  \"name\": \"outbound|9080||ratings.default.svc.cluster.local\",  \"addedViaApi\": true,  \"hostStatuses\": [  {  \"address\": {  \"socketAddress\": {  \"address\": \"10.4.1.12\",  \"portValue\": 9080  }  },  \"stats\": [  {  \"name\": \"cx_connect_fail\"  },  {  \"name\": \"cx_total\"  },  {  \"name\": \"rq_error\"  },  {  \"name\": \"rq_success\"  },  {  \"name\": \"rq_timeout\"  },  {  \"name\": \"rq_total\"  },  {  \"type\": \"GAUGE\",  \"name\": \"cx_active\"  },  {  \"type\": \"GAUGE\",  \"name\": \"rq_active\"  }  ],  \"healthStatus\": {  \"edsHealthStatus\": \"HEALTHY\"  },  \"weight\": 1,  \"locality\": {  \"region\": \"us-west2\",  \"zone\": \"us-west2-a\"  }  }  ],  \"circuitBreakers\": {  \"thresholds\": [  {  \"maxConnections\": 4294967295,  \"maxPendingRequests\": 4294967295,  \"maxRequests\": 4294967295,  \"maxRetries\": 4294967295  },  {  \"priority\": \"HIGH\",  \"maxConnections\": 1024,  \"maxPendingRequests\": 1024,  \"maxRequests\": 1024,  \"maxRetries\": 3  }  ]  },  \"observabilityName\": \"outbound|9080||ratings.default.svc.cluster.local\"  } ] 我们看到端点的地址是 10.4.1.12。实际上，Endpoint 可以是一个或多个，sidecar 将根据一定规则选择适当的 Endpoint 来路由。至此 review Pod找到了它上游服务 rating 的 Endpoint。\n小结 本文使用了 Istio 官方提供的 bookinfo 示例，按图索骥得带领读者了解了 sidecar 注入、iptables 透明流量劫持及 sidecar 中流量路由背后的实现细节。Sidecar 模式和流量透明劫持是 Istio 服务网格的特色和基础功能，理解该功能的背后过程及实现细节，将有助于大家理解 Service Mesh 的原理和 Istio Handbook 后面章节中的内容，因此希望读者可以在自己的环境中从头来试验一遍以加深理解。\n使用 iptables 做流量劫持只是 service mesh 的数据平面中做流量劫持的方式之一，还有更多的流量劫持方案，下面引用自 云原生网络代理 MOSN 官网中给出的流量劫持部分的描述。\n使用 iptables 做流量劫持时存在的问题 目前 Istio 使用 iptables 实现透明劫持，主要存在以下三个问题：\n 需要借助于 conntrack 模块实现连接跟踪，在连接数较多的情况下，会造成较大的消耗，同时可能会造成 track 表满的情况，为了避免这个问题，业内有关闭 conntrack 的做法。 iptables 属于常用模块，全局生效，不能显式的禁止相关联的修改，可管控性比较差。 iptables 重定向流量本质上是通过 loopback 交换数据，outbond 流量将两次穿越协议栈，在大并发场景下会损失转发性能。  上述几个问题并非在所有场景中都存在，比方说某些场景下，连接数并不多，且 NAT 表未被使用到的情况下，iptables 是一个满足要求的简单方案。为了适配更加广泛的场景，透明劫持需要解决上述三个问题。\n透明劫持方案优化 为了优化 Istio 中的透明流量劫持的性能，业界提出了以下方案。\n使用 Merbridge 开源项目利用 eBPF 劫持流量\nMerbridge 是由 DaoCloud 在 2022 年初开源的的一款利用 eBPF 加速 Istio 服务网格的插件。使用 Merbridge 可以在一定程度上优化数据平面的网络性能。\nMerbridge 利用 eBPF 的 sockops 和 redir 能力，可以直接将数据包从 inbound socket 传输到 outbound socket。eBPF 提供了 bpf_msg_redirect_hash 函数可以直接转发应用程序的数据包。\n详见 Istio 服务网格 —— 云原生应用网络构建指南。\n使用 tproxy 处理 inbound 流量\ntproxy 可以用于 inbound 流量的重定向，且无需改变报文中的目的 IP/端口，不需要执行连接跟踪，不会出现 conntrack 模块创建大量连接的问题。受限于内核版本，tproxy 应用于 outbound 存在一定缺陷。目前 Istio 支持通过 tproxy 处理 inbound 流量。\n使用 hook connect 处理 outbound 流量\n为了适配更多应用场景，outbound 方向通过 hook connect 来实现，实现原理如下：\n  hook-connect 原理示意图   无论采用哪种透明劫持方案，均需要解决获取真实目的 IP/端口的问题，使用 iptables 方案通过 getsockopt 方式获取，tproxy 可以直接读取目的地址，通过修改调用接口，hook connect 方案读取方式类似于 tproxy。\n实现透明劫持后，在内核版本满足要求（4.16以上）的前提下，通过 sockmap 可以缩短报文穿越路径，进而改善 outbound 方向的转发性能。\n更新说明 下面是本文的几次更新说明。\n2020 年 4 月 27 日，第一版，基于 Istio 1.5\n本文的第一版，基于 Istio 1.5 创作，在此之前，我曾写过基于 Istio 1.1 版本的理解 Istio Service Mesh 中 Envoy 代理 Sidecar 注入及流量劫持，为了更细致的理解 Istio 中透明流量劫持的全过程，专门创作本文。\n2022 年 1 月 17 日，第二版，基于 Istio 1.11\n本文第一版发布后，在社区里获得了比较大的反响，收到了很多读者的评论和留言。基于这些评论，我也发现了第一版中的很多错误，在加上 Istio 版本发布频繁，在近两年的时间内，Istio 已经作出了众多更新，其中不乏重大更新。因此笔者撰写了本文的第二版，修改了之前版本中的纰漏并根据时下 Istio 的最新版本更新了本文。\nIstio 1.11 与 Istio 1.1 中的 sidecar 注入和流量劫持环节最大的变化是：\n iptables 改用命令行工具，不再使用 shell 脚本。 sidecar inbound 和 outbound 分别指定了端口，而之前是使用同一个端口（15001）。  2022 年 4 月 24，第三版，基于 Istio 1.13\n这个版本的文章主要是根据当时 Istio 的最新版本更新了文章的部分内容，并重新排版，增加更新说明。\nIstio 1.13 相比 Istio 1.11 的变化是 istioctl proxy-config 命令的输出有了较大变化。\n2022 年 5 月 6 日，第四版，基于 Istio 1.13\n 修改了对 ISTIO_ROUTE iptables 规则 2、5 的解释 在示意图中增加了路径 16  2022 年 5 月 12 日，第五版，基于 Istio 1.13\n 将 iptables 说明和 sidecar 注入、init 容器部分独立成了两篇单独的博客，以缩减博客的篇幅，见 Istio 数据平面 Pod 启动过程详解和理解 iptables。  参考  阅读原文 Debugging Envoy and Istiod - istio.io 揭开 Istio Sidecar 注入模型的神秘面纱 - istio.io MOSN 作为 Sidecar 使用时的流量劫持方案 - mosn.io  ","categories":["云原生"],"description":"","excerpt":"本文最早是基于 Istio 1.11 撰写，之后随着 Istio 的版本陆续更新，最新更新时间为 2022 年 5 月 12 日，关于本文历 …","ref":"/blog/2022/09/11/fe0ba1/","tags":["istio","转载"],"title":"深入Istio系列-Sidecar 注入、透明流量劫持及流量路由过程详解"},{"body":"","categories":"","description":"","excerpt":"","ref":"/tags/sidecar/","tags":"","title":"Sidecar"},{"body":"  Sidecar 自动注入机制是将 sidecar 代理自动添加到用户创建的 pod。\n  它使用 MutatingWebhook 机制在 pod 创建的时候将 sidecar 的容器和卷添加到每个 pod 的模版里。\n  用户可以通过 webhooks namespaceSelector 机制来限定需要启动自动注入的范围，也可以通过注解的方式针对每个 pod 来单独启用和禁用自动注入功能。\n  Sidecar 是否会被自动注入取决于下面 3 条配置和 2 条安全规则：\n配置:  webhooks namespaceSelector 默认策略 policy pod 级别的覆盖注解  安全规则:  sidecar 默认不能被注入到 kube-system 和 kube-public 这两个 namespace sidecar 不能被注入到使用 host network 网络的 pod 里  下面的表格展示了基于上述三个配置条件的最终注入状态。上述的安全规则不会被覆盖。\n   namespaceSelector 匹配 默认策略 sidecar.istio.io/inject 注解 Sidecar 是否注入     是 enabled true (default) 是   是 enabled false 否   是 disabled true 是   是 disabled false (default) 否   否 enabled true (default) 否   否 enabled false 否   否 disabled true 否   否 disabled false (default) 否    以下内容基于Istio 1.13.2版本\nNewWehook方法 pkg/kube/inject/webhook.go\nfunc NewWebhook(p WebhookParameters) (*Webhook, error) { \tif p.Mux == nil { \treturn nil, errors.New(\"expected mux to be passed, but was not passed\") \t}  \twh := \u0026Webhook{ \twatcher: p.Watcher, \tmeshConfig: p.Env.Mesh(), \tenv: p.Env, \trevision: p.Revision, \t}  \tp.Watcher.SetHandler(wh.updateConfig) \tsidecarConfig, valuesConfig, err := p.Watcher.Get() \tif err != nil { \treturn nil, err \t} \twh.updateConfig(sidecarConfig, valuesConfig)  //初始化Webhook实例的时候注册/inject对应的处理器 \tp.Mux.HandleFunc(\"/inject\", wh.serveInject) \tp.Mux.HandleFunc(\"/inject/\", wh.serveInject)  \tp.Env.Watcher.AddMeshHandler(func() { \twh.mu.Lock() \twh.meshConfig = p.Env.Mesh() \twh.mu.Unlock() \t})  \treturn wh, nil } serveInject方法 pkg/kube/inject/webhook.go 大概825-895行\nfunc (wh *Webhook) serveInject(w http.ResponseWriter, r *http.Request) { \ttotalInjections.Increment() \tvar body []byte  // 获取请求体 \tif r.Body != nil { \tif data, err := kube.HTTPConfigReader(r); err == nil { \tbody = data \t} else { \thttp.Error(w, err.Error(), http.StatusBadRequest) \treturn \t} \t} \tif len(body) == 0 { \thandleError(\"no body found\") \thttp.Error(w, \"no body found\", http.StatusBadRequest) \treturn \t}  \t// verify the content type is accurate \tcontentType := r.Header.Get(\"Content-Type\") \tif contentType != \"application/json\" { \thandleError(fmt.Sprintf(\"contentType=%s, expect application/json\", contentType)) \thttp.Error(w, \"invalid Content-Type, want `application/json`\", http.StatusUnsupportedMediaType) \treturn \t}  \tpath := \"\" \tif r.URL != nil { \tpath = r.URL.Path \t}  \tvar reviewResponse *kube.AdmissionResponse \tvar obj runtime.Object \tvar ar *kube.AdmissionReview  // 解码请求体 \tif out, _, err := deserializer.Decode(body, nil, obj); err != nil { \thandleError(fmt.Sprintf(\"Could not decode body: %v\", err)) \treviewResponse = toAdmissionResponse(err) \t} else { \tlog.Debugf(\"AdmissionRequest for path=%s\\n\", path) \tar, err = kube.AdmissionReviewKubeToAdapter(out) \tif err != nil { \thandleError(fmt.Sprintf(\"Could not decode object: %v\", err)) \t}  // 进入inject方法逻辑判断 \treviewResponse = wh.inject(ar, path) \t}  \tresponse := kube.AdmissionReview{} \tresponse.Response = reviewResponse \tvar responseKube runtime.Object \tvar apiVersion string \tif ar != nil { \tapiVersion = ar.APIVersion \tresponse.TypeMeta = ar.TypeMeta \tif response.Response != nil { \tif ar.Request != nil { \tresponse.Response.UID = ar.Request.UID \t} \t} \t} \tresponseKube = kube.AdmissionReviewAdapterToKube(\u0026response, apiVersion) \tresp, err := json.Marshal(responseKube) \tif err != nil { \tlog.Errorf(\"Could not encode response: %v\", err) \thttp.Error(w, fmt.Sprintf(\"could not encode response: %v\", err), http.StatusInternalServerError) \t} \tif _, err := w.Write(resp); err != nil { \tlog.Errorf(\"Could not write response: %v\", err) \thttp.Error(w, fmt.Sprintf(\"could not write response: %v\", err), http.StatusInternalServerError) \t} } inject方法 pkg/kube/inject/webhook.go 大概在748-823行\nfunc (wh *Webhook) inject(ar *kube.AdmissionReview, path string) *kube.AdmissionResponse { \treq := ar.Request \tvar pod corev1.Pod \tif err := json.Unmarshal(req.Object.Raw, \u0026pod); err != nil { \thandleError(fmt.Sprintf(\"Could not unmarshal raw object: %v %s\", err, \tstring(req.Object.Raw))) \treturn toAdmissionResponse(err) \t} \t// Managed fields is sometimes extremely large, leading to excessive CPU time on patch generation \t// It does not impact the injection output at all, so we can just remove it. \tpod.ManagedFields = nil  \t// Deal with potential empty fields, e.g., when the pod is created by a deployment \tpodName := potentialPodName(pod.ObjectMeta) \tif pod.ObjectMeta.Namespace == \"\" { \tpod.ObjectMeta.Namespace = req.Namespace \t} \tlog.Infof(\"Sidecar injection request for %v/%v\", req.Namespace, podName) \tlog.Debugf(\"Object: %v\", string(req.Object.Raw)) \tlog.Debugf(\"OldObject: %v\", string(req.OldObject.Raw))  \twh.mu.RLock() \t// Sicader注入判断逻辑 \tif !injectRequired(IgnoredNamespaces.UnsortedList(), wh.Config, \u0026pod.Spec, pod.ObjectMeta) { \tlog.Infof(\"Skipping %s/%s due to policy check\", pod.ObjectMeta.Namespace, podName) \ttotalSkippedInjections.Increment() \twh.mu.RUnlock() \treturn \u0026kube.AdmissionResponse{ \tAllowed: true, \t} \t}  \tproxyConfig := mesh.DefaultProxyConfig() \tif wh.env.PushContext != nil \u0026\u0026 wh.env.PushContext.ProxyConfigs != nil { \tif generatedProxyConfig := wh.env.PushContext.ProxyConfigs.EffectiveProxyConfig( \t\u0026model.NodeMetadata{ \tNamespace: pod.Namespace, \tLabels: pod.Labels, \tAnnotations: pod.Annotations, \t}, wh.meshConfig); generatedProxyConfig != nil { \tproxyConfig = *generatedProxyConfig \t} \t} \tdeploy, typeMeta := kube.GetDeployMetaFromPod(\u0026pod) \tparams := InjectionParameters{ \tpod: \u0026pod, \tdeployMeta: deploy, \ttypeMeta: typeMeta, \ttemplates: wh.Config.Templates, \tdefaultTemplate: wh.Config.DefaultTemplates, \taliases: wh.Config.Aliases, \tmeshConfig: wh.meshConfig, \tproxyConfig: \u0026proxyConfig, \tvaluesConfig: wh.valuesConfig, \trevision: wh.revision, \tinjectedAnnotations: wh.Config.InjectedAnnotations, \tproxyEnvs: parseInjectEnvs(path), \t} \twh.mu.RUnlock()  \tpatchBytes, err := injectPod(params) \tif err != nil { \thandleError(fmt.Sprintf(\"Pod injection failed: %v\", err)) \treturn toAdmissionResponse(err) \t}  \treviewResponse := kube.AdmissionResponse{ \tAllowed: true, \tPatch: patchBytes, \tPatchType: func() *string { \tpt := \"JSONPatch\" \treturn \u0026pt \t}(), \t} \ttotalSuccessfulInjections.Increment() \treturn \u0026reviewResponse } injectRequired方法 pkg/kube/inject/inject.go 大概在180-290行\n func injectRequired(ignored []string, config *Config, podSpec *corev1.PodSpec, metadata metav1.ObjectMeta) bool { // nolint: lll \t// Skip injection when host networking is enabled. The problem is \t// that the iptables changes are assumed to be within the pod when, \t// in fact, they are changing the routing at the host level. This \t// often results in routing failures within a node which can \t// affect the network provider within the cluster causing \t// additional pod failures.   // 主机网络模式不注入sicader \tif podSpec.HostNetwork { \treturn false \t}  \t// skip special kubernetes system namespaces  // kube-system、kube-public、kube-node-lease、local-path-storage四个名称空间不被注入sicader \tfor _, namespace := range ignored { \tif metadata.Namespace == namespace { \treturn false \t} \t}  \tannos := metadata.GetAnnotations()  \tvar useDefault bool \tvar inject bool  // annotation 是否开启注入 `sidecar.istio.io/inject: \"true\"` \tobjectSelector := annos[annotation.SidecarInject.Name] \tif lbl, labelPresent := metadata.GetLabels()[annotation.SidecarInject.Name]; labelPresent { \t// The label is the new API; if both are present we prefer the label \tobjectSelector = lbl \t} \tswitch strings.ToLower(objectSelector) { \t// http://yaml.org/type/bool.html \tcase \"y\", \"yes\", \"true\", \"on\": \tinject = true \tcase \"\": \tuseDefault = true \t}  \t// If an annotation is not explicitly given, check the LabelSelectors, starting with NeverInject  // 判断 configmap `istio-sidecar-injector` NeverInject 匹配标签选择器 \tif useDefault { \tfor _, neverSelector := range config.NeverInjectSelector { \tselector, err := metav1.LabelSelectorAsSelector(\u0026neverSelector) \tif err != nil { \tlog.Warnf(\"Invalid selector for NeverInjectSelector: %v (%v)\", neverSelector, err) \t} else if !selector.Empty() \u0026\u0026 selector.Matches(labels.Set(metadata.Labels)) { \tlog.Debugf(\"Explicitly disabling injection for pod %s/%s due to pod labels matching NeverInjectSelector config map entry.\", \tmetadata.Namespace, potentialPodName(metadata)) \tinject = false \tuseDefault = false \tbreak \t} \t} \t}  \t// If there's no annotation nor a NeverInjectSelector, check the AlwaysInject one  // 判断 configmap `istio-sidecar-injector` AlwaysInject 匹配标签选择器 \tif useDefault { \tfor _, alwaysSelector := range config.AlwaysInjectSelector { \tselector, err := metav1.LabelSelectorAsSelector(\u0026alwaysSelector) \tif err != nil { \tlog.Warnf(\"Invalid selector for AlwaysInjectSelector: %v (%v)\", alwaysSelector, err) \t} else if !selector.Empty() \u0026\u0026 selector.Matches(labels.Set(metadata.Labels)) { \tlog.Debugf(\"Explicitly enabling injection for pod %s/%s due to pod labels matching AlwaysInjectSelector config map entry.\", \tmetadata.Namespace, potentialPodName(metadata)) \tinject = true \tuseDefault = false \tbreak \t} \t} \t}  \tvar required bool  // 判断 configmap `istio-sidecar-injector` 默认策略policy \tswitch config.Policy { \tdefault: // InjectionPolicyOff \tlog.Errorf(\"Illegal value for autoInject:%s, must be one of [%s,%s]. Auto injection disabled!\", \tconfig.Policy, InjectionPolicyDisabled, InjectionPolicyEnabled) \trequired = false \tcase InjectionPolicyDisabled: \tif useDefault { \trequired = false \t} else { \trequired = inject \t} \tcase InjectionPolicyEnabled: \tif useDefault { \trequired = true \t} else { \trequired = inject \t} \t}  \tif log.DebugEnabled() { \t// Build a log message for the annotations. \tannotationStr := \"\" \tfor name := range AnnotationValidation { \tvalue, ok := annos[name] \tif !ok { \tvalue = \"(unset)\" \t} \tannotationStr += fmt.Sprintf(\"%s:%s \", name, value) \t}  \tlog.Debugf(\"Sidecar injection policy for %v/%v: namespacePolicy:%v useDefault:%v inject:%v required:%v %s\", \tmetadata.Namespace, \tpotentialPodName(metadata), \tconfig.Policy, \tuseDefault, \tinject, \trequired, \tannotationStr) \t}  \treturn required } ","categories":["云原生","Istio"],"description":"","excerpt":"  Sidecar 自动注入机制是将 sidecar 代理自动添加到用户创建的 pod。\n  它使用 MutatingWebhook …","ref":"/blog/2022/09/11/dd0bd7/","tags":["istio","Sidecar"],"title":"深入Istio系列-Sidecar自动注入"},{"body":"Helm 安装 安装基础资源 helm template istio-base manifests/charts/base \\  -n istio-system \\  --set base.enableCRDTemplates=true --- # Source: base/templates/reader-serviceaccount.yaml # This service account aggregates reader permissions for the revisions in a given cluster # Should be used for remote secret creation. apiVersion: v1 kind: ServiceAccount metadata:  name: istio-reader-service-account  namespace: istio-system  labels:  app: istio-reader  release: istio-base --- # Source: base/templates/serviceaccount.yaml # -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=- # DO NOT EDIT! # THIS IS A LEGACY CHART HERE FOR BACKCOMPAT # UPDATED CHART AT manifests/charts/istio-control/istio-discovery # -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=- apiVersion: v1 kind: ServiceAccount metadata:  name: istiod-service-account  namespace: istio-system  labels:  app: istiod  release: istio-base --- # Source: base/templates/crds.yaml # DO NOT EDIT - Generated by Cue OpenAPI generator based on Istio APIs. apiVersion: apiextensions.k8s.io/v1 kind: CustomResourceDefinition metadata:  annotations:  \"helm.sh/resource-policy\": keep  labels:  app: istio-pilot  chart: istio  heritage: Tiller  release: istio  name: wasmplugins.extensions.istio.io spec:  group: extensions.istio.io  names:  categories:  - istio-io  - extensions-istio-io  kind: WasmPlugin  listKind: WasmPluginList  plural: wasmplugins  singular: wasmplugin  scope: Namespaced  versions:  - additionalPrinterColumns:  - description: 'CreationTimestamp is a timestamp representing the server time when this object was created. It is not guaranteed to be set in happens-before order across separate operations. Clients may not set this value. It is represented in RFC3339 form and is in UTC. Populated by the system. Read-only. Null for lists. More info: https://git.k8s.io/community/contributors/devel/api-conventions.md#metadata'  jsonPath: .metadata.creationTimestamp  name: Age  type: date  name: v1alpha1  schema:  openAPIV3Schema:  properties:  spec:  description: 'Extend the functionality provided by the Istio proxy through WebAssembly filters. See more details at: https://istio.io/docs/reference/config/proxy_extensions/wasm-plugin.html'  properties:  imagePullPolicy:  description: The pull behaviour to be applied when fetching an OCI  image.  enum:  - UNSPECIFIED_POLICY  - IfNotPresent  - Always  type: string  imagePullSecret:  description: Credentials to use for OCI image pulling.  type: string  phase:  description: Determines where in the filter chain this `WasmPlugin`  is to be injected.  enum:  - UNSPECIFIED_PHASE  - AUTHN  - AUTHZ  - STATS  type: string  pluginConfig:  description: The configuration that will be passed on to the plugin.  type: object  x-kubernetes-preserve-unknown-fields: true  pluginName:  type: string  priority:  description: Determines ordering of `WasmPlugins` in the same `phase`.  nullable: true  type: integer  selector:  properties:  matchLabels:  additionalProperties:  type: string  type: object  type: object  sha256:  description: SHA256 checksum that will be used to verify Wasm module  or OCI container.  type: string  url:  description: URL of a Wasm module or OCI container.  type: string  verificationKey:  type: string  type: object  status:  type: object  x-kubernetes-preserve-unknown-fields: true  type: object  served: true  storage: true  subresources:  status: {} --- # Source: base/templates/crds.yaml apiVersion: apiextensions.k8s.io/v1 kind: CustomResourceDefinition metadata:  annotations:  \"helm.sh/resource-policy\": keep  labels:  app: istio-pilot  chart: istio  heritage: Tiller  release: istio  name: destinationrules.networking.istio.io spec:  group: networking.istio.io  names:  categories:  - istio-io  - networking-istio-io  kind: DestinationRule  listKind: DestinationRuleList  plural: destinationrules  shortNames:  - dr  singular: destinationrule  scope: Namespaced  versions:  - additionalPrinterColumns:  - description: The name of a service from the service registry  jsonPath: .spec.host  name: Host  type: string  - description: 'CreationTimestamp is a timestamp representing the server time when this object was created. It is not guaranteed to be set in happens-before order across separate operations. Clients may not set this value. It is represented in RFC3339 form and is in UTC. Populated by the system. Read-only. Null for lists. More info: https://git.k8s.io/community/contributors/devel/api-conventions.md#metadata'  jsonPath: .metadata.creationTimestamp  name: Age  type: date  name: v1alpha3  schema:  openAPIV3Schema:  properties:  spec:  description: 'Configuration affecting load balancing, outlier detection, etc. See more details at: https://istio.io/docs/reference/config/networking/destination-rule.html'  properties:  exportTo:  description: A list of namespaces to which this destination rule is  exported.  items:  type: string  type: array  host:  description: The name of a service from the service registry.  type: string  subsets:  items:  properties:  labels:  additionalProperties:  type: string  type: object  name:  description: Name of the subset.  type: string  trafficPolicy:  description: Traffic policies that apply to this subset.  properties:  connectionPool:  properties:  http:  description: HTTP connection pool settings.  properties:  h2UpgradePolicy:  description: Specify if http1.1 connection should  be upgraded to http2 for the associated destination.  enum:  - DEFAULT  - DO_NOT_UPGRADE  - UPGRADE  type: string  http1MaxPendingRequests:  description: Maximum number of pending HTTP requests  to a destination.  format: int32  type: integer  http2MaxRequests:  description: Maximum number of requests to a backend.  format: int32  type: integer  idleTimeout:  description: The idle timeout for upstream connection  pool connections.  type: string  maxRequestsPerConnection:  description: Maximum number of requests per connection  to a backend.  format: int32  type: integer  maxRetries:  format: int32  type: integer  useClientProtocol:  description: If set to true, client protocol will  be preserved while initiating connection to backend.  type: boolean  type: object  tcp:  description: Settings common to both HTTP and TCP upstream  connections.  properties:  connectTimeout:  description: TCP connection timeout.  type: string  maxConnections:  description: Maximum number of HTTP1 /TCP connections  to a destination host.  format: int32  type: integer  tcpKeepalive:  description: If set then set SO_KEEPALIVE on the  socket to enable TCP Keepalives.  properties:  interval:  description: The time duration between keep-alive  probes.  type: string  probes:  type: integer  time:  type: string  type: object  type: object  type: object  loadBalancer:  description: Settings controlling the load balancer algorithms.  oneOf:  - not:  anyOf:  - required:  - simple  - properties:  consistentHash:  oneOf:  - not:  anyOf:  - required:  - httpHeaderName  - required:  - httpCookie  - required:  - useSourceIp  - required:  - httpQueryParameterName  - required:  - httpHeaderName  - required:  - httpCookie  - required:  - useSourceIp  - required:  - httpQueryParameterName  required:  - consistentHash  - required:  - simple  - properties:  consistentHash:  oneOf:  - not:  anyOf:  - required:  - httpHeaderName  - required:  - httpCookie  - required:  - useSourceIp  - required:  - httpQueryParameterName  - required:  - httpHeaderName  - required:  - httpCookie  - required:  - useSourceIp  - required:  - httpQueryParameterName  required:  - consistentHash  properties:  consistentHash:  properties:  httpCookie:  description: Hash based on HTTP cookie.  properties:  name:  description: Name of the cookie.  type: string  path:  description: Path to set for the cookie.  type: string  ttl:  description: Lifetime of the cookie.  type: string  type: object  httpHeaderName:  description: Hash based on a specific HTTP header.  type: string  httpQueryParameterName:  description: Hash based on a specific HTTP query  parameter.  type: string  minimumRingSize:  type: integer  useSourceIp:  description: Hash based on the source IP address.  type: boolean  type: object  localityLbSetting:  properties:  distribute:  description: 'Optional: only one of distribute,  failover or failoverPriority can be set.'  items:  properties:  from:  description: Originating locality, '/' separated,  e.g.  type: string  to:  additionalProperties:  type: integer  description: Map of upstream localities to  traffic distribution weights.  type: object  type: object  type: array  enabled:  description: enable locality load balancing, this  is DestinationRule-level and will override mesh  wide settings in entirety.  nullable: true  type: boolean  failover:  description: 'Optional: only one of distribute,  failover or failoverPriority can be set.'  items:  properties:  from:  description: Originating region.  type: string  to:  type: string  type: object  type: array  failoverPriority:  description: failoverPriority is an ordered list  of labels used to sort endpoints to do priority  based load balancing.  items:  type: string  type: array  type: object  simple:  enum:  - ROUND_ROBIN  - LEAST_CONN  - RANDOM  - PASSTHROUGH  type: string  type: object  outlierDetection:  properties:  baseEjectionTime:  description: Minimum ejection duration.  type: string  consecutive5xxErrors:  description: Number of 5xx errors before a host is ejected  from the connection pool.  nullable: true  type: integer  consecutiveErrors:  format: int32  type: integer  consecutiveGatewayErrors:  description: Number of gateway errors before a host  is ejected from the connection pool.  nullable: true  type: integer  consecutiveLocalOriginFailures:  nullable: true  type: integer  interval:  description: Time interval between ejection sweep analysis.  type: string  maxEjectionPercent:  format: int32  type: integer  minHealthPercent:  format: int32  type: integer  splitExternalLocalOriginErrors:  description: Determines whether to distinguish local  origin failures from external errors.  type: boolean  type: object  portLevelSettings:  description: Traffic policies specific to individual ports.  items:  properties:  connectionPool:  properties:  http:  description: HTTP connection pool settings.  properties:  h2UpgradePolicy:  description: Specify if http1.1 connection  should be upgraded to http2 for the associated  destination.  enum:  - DEFAULT  - DO_NOT_UPGRADE  - UPGRADE  type: string  http1MaxPendingRequests:  description: Maximum number of pending HTTP  requests to a destination.  format: int32  type: integer  http2MaxRequests:  description: Maximum number of requests to  a backend.  format: int32  type: integer  idleTimeout:  description: The idle timeout for upstream  connection pool connections.  type: string  maxRequestsPerConnection:  description: Maximum number of requests per  connection to a backend.  format: int32  type: integer  maxRetries:  format: int32  type: integer  useClientProtocol:  description: If set to true, client protocol  will be preserved while initiating connection  to backend.  type: boolean  type: object  tcp:  description: Settings common to both HTTP and  TCP upstream connections.  properties:  connectTimeout:  description: TCP connection timeout.  type: string  maxConnections:  description: Maximum number of HTTP1 /TCP  connections to a destination host.  format: int32  type: integer  tcpKeepalive:  description: If set then set SO_KEEPALIVE  on the socket to enable TCP Keepalives.  properties:  interval:  description: The time duration between  keep-alive probes.  type: string  probes:  type: integer  time:  type: string  type: object  type: object  type: object  loadBalancer:  description: Settings controlling the load balancer  algorithms.  oneOf:  - not:  anyOf:  - required:  - simple  - properties:  consistentHash:  oneOf:  - not:  anyOf:  - required:  - httpHeaderName  - required:  - httpCookie  - required:  - useSourceIp  - required:  - httpQueryParameterName  - required:  - httpHeaderName  - required:  - httpCookie  - required:  - useSourceIp  - required:  - httpQueryParameterName  required:  - consistentHash  - required:  - simple  - properties:  consistentHash:  oneOf:  - not:  anyOf:  - required:  - httpHeaderName  - required:  - httpCookie  - required:  - useSourceIp  - required:  - httpQueryParameterName  - required:  - httpHeaderName  - required:  - httpCookie  - required:  - useSourceIp  - required:  - httpQueryParameterName  required:  - consistentHash  properties:  consistentHash:  properties:  httpCookie:  description: Hash based on HTTP cookie.  properties:  name:  description: Name of the cookie.  type: string  path:  description: Path to set for the cookie.  type: string  ttl:  description: Lifetime of the cookie.  type: string  type: object  httpHeaderName:  description: Hash based on a specific HTTP  header.  type: string  httpQueryParameterName:  description: Hash based on a specific HTTP  query parameter.  type: string  minimumRingSize:  type: integer  useSourceIp:  description: Hash based on the source IP address.  type: boolean  type: object  localityLbSetting:  properties:  distribute:  description: 'Optional: only one of distribute,  failover or failoverPriority can be set.'  items:  properties:  from:  description: Originating locality, '/'  separated, e.g.  type: string  to:  additionalProperties:  type: integer  description: Map of upstream localities  to traffic distribution weights.  type: object  type: object  type: array  enabled:  description: enable locality load balancing,  this is DestinationRule-level and will override  mesh wide settings in entirety.  nullable: true  type: boolean  failover:  description: 'Optional: only one of distribute,  failover or failoverPriority can be set.'  items:  properties:  from:  description: Originating region.  type: string  to:  type: string  type: object  type: array  failoverPriority:  description: failoverPriority is an ordered  list of labels used to sort endpoints to  do priority based load balancing.  items:  type: string  type: array  type: object  simple:  enum:  - ROUND_ROBIN  - LEAST_CONN  - RANDOM  - PASSTHROUGH  type: string  type: object  outlierDetection:  properties:  baseEjectionTime:  description: Minimum ejection duration.  type: string  consecutive5xxErrors:  description: Number of 5xx errors before a host  is ejected from the connection pool.  nullable: true  type: integer  consecutiveErrors:  format: int32  type: integer  consecutiveGatewayErrors:  description: Number of gateway errors before a  host is ejected from the connection pool.  nullable: true  type: integer  consecutiveLocalOriginFailures:  nullable: true  type: integer  interval:  description: Time interval between ejection sweep  analysis.  type: string  maxEjectionPercent:  format: int32  type: integer  minHealthPercent:  format: int32  type: integer  splitExternalLocalOriginErrors:  description: Determines whether to distinguish  local origin failures from external errors.  type: boolean  type: object  port:  properties:  number:  type: integer  type: object  tls:  description: TLS related settings for connections  to the upstream service.  properties:  caCertificates:  type: string  clientCertificate:  description: REQUIRED if mode is `MUTUAL`.  type: string  credentialName:  type: string  insecureSkipVerify:  nullable: true  type: boolean  mode:  enum:  - DISABLE  - SIMPLE  - MUTUAL  - ISTIO_MUTUAL  type: string  privateKey:  description: REQUIRED if mode is `MUTUAL`.  type: string  sni:  description: SNI string to present to the server  during TLS handshake.  type: string  subjectAltNames:  items:  type: string  type: array  type: object  type: object  type: array  tls:  description: TLS related settings for connections to the  upstream service.  properties:  caCertificates:  type: string  clientCertificate:  description: REQUIRED if mode is `MUTUAL`.  type: string  credentialName:  type: string  insecureSkipVerify:  nullable: true  type: boolean  mode:  enum:  - DISABLE  - SIMPLE  - MUTUAL  - ISTIO_MUTUAL  type: string  privateKey:  description: REQUIRED if mode is `MUTUAL`.  type: string  sni:  description: SNI string to present to the server during  TLS handshake.  type: string  subjectAltNames:  items:  type: string  type: array  type: object  type: object  type: object  type: array  trafficPolicy:  properties:  connectionPool:  properties:  http:  description: HTTP connection pool settings.  properties:  h2UpgradePolicy:  description: Specify if http1.1 connection should be upgraded  to http2 for the associated destination.  enum:  - DEFAULT  - DO_NOT_UPGRADE  - UPGRADE  type: string  http1MaxPendingRequests:  description: Maximum number of pending HTTP requests to  a destination.  format: int32  type: integer  http2MaxRequests:  description: Maximum number of requests to a backend.  format: int32  type: integer  idleTimeout:  description: The idle timeout for upstream connection  pool connections.  type: string  maxRequestsPerConnection:  description: Maximum number of requests per connection  to a backend.  format: int32  type: integer  maxRetries:  format: int32  type: integer  useClientProtocol:  description: If set to true, client protocol will be preserved  while initiating connection to backend.  type: boolean  type: object  tcp:  description: Settings common to both HTTP and TCP upstream  connections.  properties:  connectTimeout:  description: TCP connection timeout.  type: string  maxConnections:  description: Maximum number of HTTP1 /TCP connections  to a destination host.  format: int32  type: integer  tcpKeepalive:  description: If set then set SO_KEEPALIVE on the socket  to enable TCP Keepalives.  properties:  interval:  description: The time duration between keep-alive  probes.  type: string  probes:  type: integer  time:  type: string  type: object  type: object  type: object  loadBalancer:  description: Settings controlling the load balancer algorithms.  oneOf:  - not:  anyOf:  - required:  - simple  - properties:  consistentHash:  oneOf:  - not:  anyOf:  - required:  - httpHeaderName  - required:  - httpCookie  - required:  - useSourceIp  - required:  - httpQueryParameterName  - required:  - httpHeaderName  - required:  - httpCookie  - required:  - useSourceIp  - required:  - httpQueryParameterName  required:  - consistentHash  - required:  - simple  - properties:  consistentHash:  oneOf:  - not:  anyOf:  - required:  - httpHeaderName  - required:  - httpCookie  - required:  - useSourceIp  - required:  - httpQueryParameterName  - required:  - httpHeaderName  - required:  - httpCookie  - required:  - useSourceIp  - required:  - httpQueryParameterName  required:  - consistentHash  properties:  consistentHash:  properties:  httpCookie:  description: Hash based on HTTP cookie.  properties:  name:  description: Name of the cookie.  type: string  path:  description: Path to set for the cookie.  type: string  ttl:  description: Lifetime of the cookie.  type: string  type: object  httpHeaderName:  description: Hash based on a specific HTTP header.  type: string  httpQueryParameterName:  description: Hash based on a specific HTTP query parameter.  type: string  minimumRingSize:  type: integer  useSourceIp:  description: Hash based on the source IP address.  type: boolean  type: object  localityLbSetting:  properties:  distribute:  description: 'Optional: only one of distribute, failover  or failoverPriority can be set.'  items:  properties:  from:  description: Originating locality, '/' separated,  e.g.  type: string  to:  additionalProperties:  type: integer  description: Map of upstream localities to traffic  distribution weights.  type: object  type: object  type: array  enabled:  description: enable locality load balancing, this is DestinationRule-level  and will override mesh wide settings in entirety.  nullable: true  type: boolean  failover:  description: 'Optional: only one of distribute, failover  or failoverPriority can be set.'  items:  properties:  from:  description: Originating region.  type: string  to:  type: string  type: object  type: array  failoverPriority:  description: failoverPriority is an ordered list of labels  used to sort endpoints to do priority based load balancing.  items:  type: string  type: array  type: object  simple:  enum:  - ROUND_ROBIN  - LEAST_CONN  - RANDOM  - PASSTHROUGH  type: string  type: object  outlierDetection:  properties:  baseEjectionTime:  description: Minimum ejection duration.  type: string  consecutive5xxErrors:  description: Number of 5xx errors before a host is ejected  from the connection pool.  nullable: true  type: integer  consecutiveErrors:  format: int32  type: integer  consecutiveGatewayErrors:  description: Number of gateway errors before a host is ejected  from the connection pool.  nullable: true  type: integer  consecutiveLocalOriginFailures:  nullable: true  type: integer  interval:  description: Time interval between ejection sweep analysis.  type: string  maxEjectionPercent:  format: int32  type: integer  minHealthPercent:  format: int32  type: integer  splitExternalLocalOriginErrors:  description: Determines whether to distinguish local origin  failures from external errors.  type: boolean  type: object  portLevelSettings:  description: Traffic policies specific to individual ports.  items:  properties:  connectionPool:  properties:  http:  description: HTTP connection pool settings.  properties:  h2UpgradePolicy:  description: Specify if http1.1 connection should  be upgraded to http2 for the associated destination.  enum:  - DEFAULT  - DO_NOT_UPGRADE  - UPGRADE  type: string  http1MaxPendingRequests:  description: Maximum number of pending HTTP requests  to a destination.  format: int32  type: integer  http2MaxRequests:  description: Maximum number of requests to a backend.  format: int32  type: integer  idleTimeout:  description: The idle timeout for upstream connection  pool connections.  type: string  maxRequestsPerConnection:  description: Maximum number of requests per connection  to a backend.  format: int32  type: integer  maxRetries:  format: int32  type: integer  useClientProtocol:  description: If set to true, client protocol will  be preserved while initiating connection to backend.  type: boolean  type: object  tcp:  description: Settings common to both HTTP and TCP upstream  connections.  properties:  connectTimeout:  description: TCP connection timeout.  type: string  maxConnections:  description: Maximum number of HTTP1 /TCP connections  to a destination host.  format: int32  type: integer  tcpKeepalive:  description: If set then set SO_KEEPALIVE on the  socket to enable TCP Keepalives.  properties:  interval:  description: The time duration between keep-alive  probes.  type: string  probes:  type: integer  time:  type: string  type: object  type: object  type: object  loadBalancer:  description: Settings controlling the load balancer algorithms.  oneOf:  - not:  anyOf:  - required:  - simple  - properties:  consistentHash:  oneOf:  - not:  anyOf:  - required:  - httpHeaderName  - required:  - httpCookie  - required:  - useSourceIp  - required:  - httpQueryParameterName  - required:  - httpHeaderName  - required:  - httpCookie  - required:  - useSourceIp  - required:  - httpQueryParameterName  required:  - consistentHash  - required:  - simple  - properties:  consistentHash:  oneOf:  - not:  anyOf:  - required:  - httpHeaderName  - required:  - httpCookie  - required:  - useSourceIp  - required:  - httpQueryParameterName  - required:  - httpHeaderName  - required:  - httpCookie  - required:  - useSourceIp  - required:  - httpQueryParameterName  required:  - consistentHash  properties:  consistentHash:  properties:  httpCookie:  description: Hash based on HTTP cookie.  properties:  name:  description: Name of the cookie.  type: string  path:  description: Path to set for the cookie.  type: string  ttl:  description: Lifetime of the cookie.  type: string  type: object  httpHeaderName:  description: Hash based on a specific HTTP header.  type: string  httpQueryParameterName:  description: Hash based on a specific HTTP query  parameter.  type: string  minimumRingSize:  type: integer  useSourceIp:  description: Hash based on the source IP address.  type: boolean  type: object  localityLbSetting:  properties:  distribute:  description: 'Optional: only one of distribute,  failover or failoverPriority can be set.'  items:  properties:  from:  description: Originating locality, '/' separated,  e.g.  type: string  to:  additionalProperties:  type: integer  description: Map of upstream localities to  traffic distribution weights.  type: object  type: object  type: array  enabled:  description: enable locality load balancing, this  is DestinationRule-level and will override mesh  wide settings in entirety.  nullable: true  type: boolean  failover:  description: 'Optional: only one of distribute,  failover or failoverPriority can be set.'  items:  properties:  from:  description: Originating region.  type: string  to:  type: string  type: object  type: array  failoverPriority:  description: failoverPriority is an ordered list  of labels used to sort endpoints to do priority  based load balancing.  items:  type: string  type: array  type: object  simple:  enum:  - ROUND_ROBIN  - LEAST_CONN  - RANDOM  - PASSTHROUGH  type: string  type: object  outlierDetection:  properties:  baseEjectionTime:  description: Minimum ejection duration.  type: string  consecutive5xxErrors:  description: Number of 5xx errors before a host is ejected  from the connection pool.  nullable: true  type: integer  consecutiveErrors:  format: int32  type: integer  consecutiveGatewayErrors:  description: Number of gateway errors before a host  is ejected from the connection pool.  nullable: true  type: integer  consecutiveLocalOriginFailures:  nullable: true  type: integer  interval:  description: Time interval between ejection sweep analysis.  type: string  maxEjectionPercent:  format: int32  type: integer  minHealthPercent:  format: int32  type: integer  splitExternalLocalOriginErrors:  description: Determines whether to distinguish local  origin failures from external errors.  type: boolean  type: object  port:  properties:  number:  type: integer  type: object  tls:  description: TLS related settings for connections to the  upstream service.  properties:  caCertificates:  type: string  clientCertificate:  description: REQUIRED if mode is `MUTUAL`.  type: string  credentialName:  type: string  insecureSkipVerify:  nullable: true  type: boolean  mode:  enum:  - DISABLE  - SIMPLE  - MUTUAL  - ISTIO_MUTUAL  type: string  privateKey:  description: REQUIRED if mode is `MUTUAL`.  type: string  sni:  description: SNI string to present to the server during  TLS handshake.  type: string  subjectAltNames:  items:  type: string  type: array  type: object  type: object  type: array  tls:  description: TLS related settings for connections to the upstream  service.  properties:  caCertificates:  type: string  clientCertificate:  description: REQUIRED if mode is `MUTUAL`.  type: string  credentialName:  type: string  insecureSkipVerify:  nullable: true  type: boolean  mode:  enum:  - DISABLE  - SIMPLE  - MUTUAL  - ISTIO_MUTUAL  type: string  privateKey:  description: REQUIRED if mode is `MUTUAL`.  type: string  sni:  description: SNI string to present to the server during TLS  handshake.  type: string  subjectAltNames:  items:  type: string  type: array  type: object  type: object  type: object  status:  type: object  x-kubernetes-preserve-unknown-fields: true  type: object  served: true  storage: true  subresources:  status: {}  - additionalPrinterColumns:  - description: The name of a service from the service registry  jsonPath: .spec.host  name: Host  type: string  - description: 'CreationTimestamp is a timestamp representing the server time when this object was created. It is not guaranteed to be set in happens-before order across separate operations. Clients may not set this value. It is represented in RFC3339 form and is in UTC. Populated by the system. Read-only. Null for lists. More info: https://git.k8s.io/community/contributors/devel/api-conventions.md#metadata'  jsonPath: .metadata.creationTimestamp  name: Age  type: date  name: v1beta1  schema:  openAPIV3Schema:  properties:  spec:  description: 'Configuration affecting load balancing, outlier detection, etc. See more details at: https://istio.io/docs/reference/config/networking/destination-rule.html'  properties:  exportTo:  description: A list of namespaces to which this destination rule is  exported.  items:  type: string  type: array  host:  description: The name of a service from the service registry.  type: string  subsets:  items:  properties:  labels:  additionalProperties:  type: string  type: object  name:  description: Name of the subset.  type: string  trafficPolicy:  description: Traffic policies that apply to this subset.  properties:  connectionPool:  properties:  http:  description: HTTP connection pool settings.  properties:  h2UpgradePolicy:  description: Specify if http1.1 connection should  be upgraded to http2 for the associated destination.  enum:  - DEFAULT  - DO_NOT_UPGRADE  - UPGRADE  type: string  http1MaxPendingRequests:  description: Maximum number of pending HTTP requests  to a destination.  format: int32  type: integer  http2MaxRequests:  description: Maximum number of requests to a backend.  format: int32  type: integer  idleTimeout:  description: The idle timeout for upstream connection  pool connections.  type: string  maxRequestsPerConnection:  description: Maximum number of requests per connection  to a backend.  format: int32  type: integer  maxRetries:  format: int32  type: integer  useClientProtocol:  description: If set to true, client protocol will  be preserved while initiating connection to backend.  type: boolean  type: object  tcp:  description: Settings common to both HTTP and TCP upstream  connections.  properties:  connectTimeout:  description: TCP connection timeout.  type: string  maxConnections:  description: Maximum number of HTTP1 /TCP connections  to a destination host.  format: int32  type: integer  tcpKeepalive:  description: If set then set SO_KEEPALIVE on the  socket to enable TCP Keepalives.  properties:  interval:  description: The time duration between keep-alive  probes.  type: string  probes:  type: integer  time:  type: string  type: object  type: object  type: object  loadBalancer:  description: Settings controlling the load balancer algorithms.  oneOf:  - not:  anyOf:  - required:  - simple  - properties:  consistentHash:  oneOf:  - not:  anyOf:  - required:  - httpHeaderName  - required:  - httpCookie  - required:  - useSourceIp  - required:  - httpQueryParameterName  - required:  - httpHeaderName  - required:  - httpCookie  - required:  - useSourceIp  - required:  - httpQueryParameterName  required:  - consistentHash  - required:  - simple  - properties:  consistentHash:  oneOf:  - not:  anyOf:  - required:  - httpHeaderName  - required:  - httpCookie  - required:  - useSourceIp  - required:  - httpQueryParameterName  - required:  - httpHeaderName  - required:  - httpCookie  - required:  - useSourceIp  - required:  - httpQueryParameterName  required:  - consistentHash  properties:  consistentHash:  properties:  httpCookie:  description: Hash based on HTTP cookie.  properties:  name:  description: Name of the cookie.  type: string  path:  description: Path to set for the cookie.  type: string  ttl:  description: Lifetime of the cookie.  type: string  type: object  httpHeaderName:  description: Hash based on a specific HTTP header.  type: string  httpQueryParameterName:  description: Hash based on a specific HTTP query  parameter.  type: string  minimumRingSize:  type: integer  useSourceIp:  description: Hash based on the source IP address.  type: boolean  type: object  localityLbSetting:  properties:  distribute:  description: 'Optional: only one of distribute,  failover or failoverPriority can be set.'  items:  properties:  from:  description: Originating locality, '/' separated,  e.g.  type: string  to:  additionalProperties:  type: integer  description: Map of upstream localities to  traffic distribution weights.  type: object  type: object  type: array  enabled:  description: enable locality load balancing, this  is DestinationRule-level and will override mesh  wide settings in entirety.  nullable: true  type: boolean  failover:  description: 'Optional: only one of distribute,  failover or failoverPriority can be set.'  items:  properties:  from:  description: Originating region.  type: string  to:  type: string  type: object  type: array  failoverPriority:  description: failoverPriority is an ordered list  of labels used to sort endpoints to do priority  based load balancing.  items:  type: string  type: array  type: object  simple:  enum:  - ROUND_ROBIN  - LEAST_CONN  - RANDOM  - PASSTHROUGH  type: string  type: object  outlierDetection:  properties:  baseEjectionTime:  description: Minimum ejection duration.  type: string  consecutive5xxErrors:  description: Number of 5xx errors before a host is ejected  from the connection pool.  nullable: true  type: integer  consecutiveErrors:  format: int32  type: integer  consecutiveGatewayErrors:  description: Number of gateway errors before a host  is ejected from the connection pool.  nullable: true  type: integer  consecutiveLocalOriginFailures:  nullable: true  type: integer  interval:  description: Time interval between ejection sweep analysis.  type: string  maxEjectionPercent:  format: int32  type: integer  minHealthPercent:  format: int32  type: integer  splitExternalLocalOriginErrors:  description: Determines whether to distinguish local  origin failures from external errors.  type: boolean  type: object  portLevelSettings:  description: Traffic policies specific to individual ports.  items:  properties:  connectionPool:  properties:  http:  description: HTTP connection pool settings.  properties:  h2UpgradePolicy:  description: Specify if http1.1 connection  should be upgraded to http2 for the associated  destination.  enum:  - DEFAULT  - DO_NOT_UPGRADE  - UPGRADE  type: string  http1MaxPendingRequests:  description: Maximum number of pending HTTP  requests to a destination.  format: int32  type: integer  http2MaxRequests:  description: Maximum number of requests to  a backend.  format: int32  type: integer  idleTimeout:  description: The idle timeout for upstream  connection pool connections.  type: string  maxRequestsPerConnection:  description: Maximum number of requests per  connection to a backend.  format: int32  type: integer  maxRetries:  format: int32  type: integer  useClientProtocol:  description: If set to true, client protocol  will be preserved while initiating connection  to backend.  type: boolean  type: object  tcp:  description: Settings common to both HTTP and  TCP upstream connections.  properties:  connectTimeout:  description: TCP connection timeout.  type: string  maxConnections:  description: Maximum number of HTTP1 /TCP  connections to a destination host.  format: int32  type: integer  tcpKeepalive:  description: If set then set SO_KEEPALIVE  on the socket to enable TCP Keepalives.  properties:  interval:  description: The time duration between  keep-alive probes.  type: string  probes:  type: integer  time:  type: string  type: object  type: object  type: object  loadBalancer:  description: Settings controlling the load balancer  algorithms.  oneOf:  - not:  anyOf:  - required:  - simple  - properties:  consistentHash:  oneOf:  - not:  anyOf:  - required:  - httpHeaderName  - required:  - httpCookie  - required:  - useSourceIp  - required:  - httpQueryParameterName  - required:  - httpHeaderName  - required:  - httpCookie  - required:  - useSourceIp  - required:  - httpQueryParameterName  required:  - consistentHash  - required:  - simple  - properties:  consistentHash:  oneOf:  - not:  anyOf:  - required:  - httpHeaderName  - required:  - httpCookie  - required:  - useSourceIp  - required:  - httpQueryParameterName  - required:  - httpHeaderName  - required:  - httpCookie  - required:  - useSourceIp  - required:  - httpQueryParameterName  required:  - consistentHash  properties:  consistentHash:  properties:  httpCookie:  description: Hash based on HTTP cookie.  properties:  name:  description: Name of the cookie.  type: string  path:  description: Path to set for the cookie.  type: string  ttl:  description: Lifetime of the cookie.  type: string  type: object  httpHeaderName:  description: Hash based on a specific HTTP  header.  type: string  httpQueryParameterName:  description: Hash based on a specific HTTP  query parameter.  type: string  minimumRingSize:  type: integer  useSourceIp:  description: Hash based on the source IP address.  type: boolean  type: object  localityLbSetting:  properties:  distribute:  description: 'Optional: only one of distribute,  failover or failoverPriority can be set.'  items:  properties:  from:  description: Originating locality, '/'  separated, e.g.  type: string  to:  additionalProperties:  type: integer  description: Map of upstream localities  to traffic distribution weights.  type: object  type: object  type: array  enabled:  description: enable locality load balancing,  this is DestinationRule-level and will override  mesh wide settings in entirety.  nullable: true  type: boolean  failover:  description: 'Optional: only one of distribute,  failover or failoverPriority can be set.'  items:  properties:  from:  description: Originating region.  type: string  to:  type: string  type: object  type: array  failoverPriority:  description: failoverPriority is an ordered  list of labels used to sort endpoints to  do priority based load balancing.  items:  type: string  type: array  type: object  simple:  enum:  - ROUND_ROBIN  - LEAST_CONN  - RANDOM  - PASSTHROUGH  type: string  type: object  outlierDetection:  properties:  baseEjectionTime:  description: Minimum ejection duration.  type: string  consecutive5xxErrors:  description: Number of 5xx errors before a host  is ejected from the connection pool.  nullable: true  type: integer  consecutiveErrors:  format: int32  type: integer  consecutiveGatewayErrors:  description: Number of gateway errors before a  host is ejected from the connection pool.  nullable: true  type: integer  consecutiveLocalOriginFailures:  nullable: true  type: integer  interval:  description: Time interval between ejection sweep  analysis.  type: string  maxEjectionPercent:  format: int32  type: integer  minHealthPercent:  format: int32  type: integer  splitExternalLocalOriginErrors:  description: Determines whether to distinguish  local origin failures from external errors.  type: boolean  type: object  port:  properties:  number:  type: integer  type: object  tls:  description: TLS related settings for connections  to the upstream service.  properties:  caCertificates:  type: string  clientCertificate:  description: REQUIRED if mode is `MUTUAL`.  type: string  credentialName:  type: string  insecureSkipVerify:  nullable: true  type: boolean  mode:  enum:  - DISABLE  - SIMPLE  - MUTUAL  - ISTIO_MUTUAL  type: string  privateKey:  description: REQUIRED if mode is `MUTUAL`.  type: string  sni:  description: SNI string to present to the server  during TLS handshake.  type: string  subjectAltNames:  items:  type: string  type: array  type: object  type: object  type: array  tls:  description: TLS related settings for connections to the  upstream service.  properties:  caCertificates:  type: string  clientCertificate:  description: REQUIRED if mode is `MUTUAL`.  type: string  credentialName:  type: string  insecureSkipVerify:  nullable: true  type: boolean  mode:  enum:  - DISABLE  - SIMPLE  - MUTUAL  - ISTIO_MUTUAL  type: string  privateKey:  description: REQUIRED if mode is `MUTUAL`.  type: string  sni:  description: SNI string to present to the server during  TLS handshake.  type: string  subjectAltNames:  items:  type: string  type: array  type: object  type: object  type: object  type: array  trafficPolicy:  properties:  connectionPool:  properties:  http:  description: HTTP connection pool settings.  properties:  h2UpgradePolicy:  description: Specify if http1.1 connection should be upgraded  to http2 for the associated destination.  enum:  - DEFAULT  - DO_NOT_UPGRADE  - UPGRADE  type: string  http1MaxPendingRequests:  description: Maximum number of pending HTTP requests to  a destination.  format: int32  type: integer  http2MaxRequests:  description: Maximum number of requests to a backend.  format: int32  type: integer  idleTimeout:  description: The idle timeout for upstream connection  pool connections.  type: string  maxRequestsPerConnection:  description: Maximum number of requests per connection  to a backend.  format: int32  type: integer  maxRetries:  format: int32  type: integer  useClientProtocol:  description: If set to true, client protocol will be preserved  while initiating connection to backend.  type: boolean  type: object  tcp:  description: Settings common to both HTTP and TCP upstream  connections.  properties:  connectTimeout:  description: TCP connection timeout.  type: string  maxConnections:  description: Maximum number of HTTP1 /TCP connections  to a destination host.  format: int32  type: integer  tcpKeepalive:  description: If set then set SO_KEEPALIVE on the socket  to enable TCP Keepalives.  properties:  interval:  description: The time duration between keep-alive  probes.  type: string  probes:  type: integer  time:  type: string  type: object  type: object  type: object  loadBalancer:  description: Settings controlling the load balancer algorithms.  oneOf:  - not:  anyOf:  - required:  - simple  - properties:  consistentHash:  oneOf:  - not:  anyOf:  - required:  - httpHeaderName  - required:  - httpCookie  - required:  - useSourceIp  - required:  - httpQueryParameterName  - required:  - httpHeaderName  - required:  - httpCookie  - required:  - useSourceIp  - required:  - httpQueryParameterName  required:  - consistentHash  - required:  - simple  - properties:  consistentHash:  oneOf:  - not:  anyOf:  - required:  - httpHeaderName  - required:  - httpCookie  - required:  - useSourceIp  - required:  - httpQueryParameterName  - required:  - httpHeaderName  - required:  - httpCookie  - required:  - useSourceIp  - required:  - httpQueryParameterName  required:  - consistentHash  properties:  consistentHash:  properties:  httpCookie:  description: Hash based on HTTP cookie.  properties:  name:  description: Name of the cookie.  type: string  path:  description: Path to set for the cookie.  type: string  ttl:  description: Lifetime of the cookie.  type: string  type: object  httpHeaderName:  description: Hash based on a specific HTTP header.  type: string  httpQueryParameterName:  description: Hash based on a specific HTTP query parameter.  type: string  minimumRingSize:  type: integer  useSourceIp:  description: Hash based on the source IP address.  type: boolean  type: object  localityLbSetting:  properties:  distribute:  description: 'Optional: only one of distribute, failover  or failoverPriority can be set.'  items:  properties:  from:  description: Originating locality, '/' separated,  e.g.  type: string  to:  additionalProperties:  type: integer  description: Map of upstream localities to traffic  distribution weights.  type: object  type: object  type: array  enabled:  description: enable locality load balancing, this is DestinationRule-level  and will override mesh wide settings in entirety.  nullable: true  type: boolean  failover:  description: 'Optional: only one of distribute, failover  or failoverPriority can be set.'  items:  properties:  from:  description: Originating region.  type: string  to:  type: string  type: object  type: array  failoverPriority:  description: failoverPriority is an ordered list of labels  used to sort endpoints to do priority based load balancing.  items:  type: string  type: array  type: object  simple:  enum:  - ROUND_ROBIN  - LEAST_CONN  - RANDOM  - PASSTHROUGH  type: string  type: object  outlierDetection:  properties:  baseEjectionTime:  description: Minimum ejection duration.  type: string  consecutive5xxErrors:  description: Number of 5xx errors before a host is ejected  from the connection pool.  nullable: true  type: integer  consecutiveErrors:  format: int32  type: integer  consecutiveGatewayErrors:  description: Number of gateway errors before a host is ejected  from the connection pool.  nullable: true  type: integer  consecutiveLocalOriginFailures:  nullable: true  type: integer  interval:  description: Time interval between ejection sweep analysis.  type: string  maxEjectionPercent:  format: int32  type: integer  minHealthPercent:  format: int32  type: integer  splitExternalLocalOriginErrors:  description: Determines whether to distinguish local origin  failures from external errors.  type: boolean  type: object  portLevelSettings:  description: Traffic policies specific to individual ports.  items:  properties:  connectionPool:  properties:  http:  description: HTTP connection pool settings.  properties:  h2UpgradePolicy:  description: Specify if http1.1 connection should  be upgraded to http2 for the associated destination.  enum:  - DEFAULT  - DO_NOT_UPGRADE  - UPGRADE  type: string  http1MaxPendingRequests:  description: Maximum number of pending HTTP requests  to a destination.  format: int32  type: integer  http2MaxRequests:  description: Maximum number of requests to a backend.  format: int32  type: integer  idleTimeout:  description: The idle timeout for upstream connection  pool connections.  type: string  maxRequestsPerConnection:  description: Maximum number of requests per connection  to a backend.  format: int32  type: integer  maxRetries:  format: int32  type: integer  useClientProtocol:  description: If set to true, client protocol will  be preserved while initiating connection to backend.  type: boolean  type: object  tcp:  description: Settings common to both HTTP and TCP upstream  connections.  properties:  connectTimeout:  description: TCP connection timeout.  type: string  maxConnections:  description: Maximum number of HTTP1 /TCP connections  to a destination host.  format: int32  type: integer  tcpKeepalive:  description: If set then set SO_KEEPALIVE on the  socket to enable TCP Keepalives.  properties:  interval:  description: The time duration between keep-alive  probes.  type: string  probes:  type: integer  time:  type: string  type: object  type: object  type: object  loadBalancer:  description: Settings controlling the load balancer algorithms.  oneOf:  - not:  anyOf:  - required:  - simple  - properties:  consistentHash:  oneOf:  - not:  anyOf:  - required:  - httpHeaderName  - required:  - httpCookie  - required:  - useSourceIp  - required:  - httpQueryParameterName  - required:  - httpHeaderName  - required:  - httpCookie  - required:  - useSourceIp  - required:  - httpQueryParameterName  required:  - consistentHash  - required:  - simple  - properties:  consistentHash:  oneOf:  - not:  anyOf:  - required:  - httpHeaderName  - required:  - httpCookie  - required:  - useSourceIp  - required:  - httpQueryParameterName  - required:  - httpHeaderName  - required:  - httpCookie  - required:  - useSourceIp  - required:  - httpQueryParameterName  required:  - consistentHash  properties:  consistentHash:  properties:  httpCookie:  description: Hash based on HTTP cookie.  properties:  name:  description: Name of the cookie.  type: string  path:  description: Path to set for the cookie.  type: string  ttl:  description: Lifetime of the cookie.  type: string  type: object  httpHeaderName:  description: Hash based on a specific HTTP header.  type: string  httpQueryParameterName:  description: Hash based on a specific HTTP query  parameter.  type: string  minimumRingSize:  type: integer  useSourceIp:  description: Hash based on the source IP address.  type: boolean  type: object  localityLbSetting:  properties:  distribute:  description: 'Optional: only one of distribute,  failover or failoverPriority can be set.'  items:  properties:  from:  description: Originating locality, '/' separated,  e.g.  type: string  to:  additionalProperties:  type: integer  description: Map of upstream localities to  traffic distribution weights.  type: object  type: object  type: array  enabled:  description: enable locality load balancing, this  is DestinationRule-level and will override mesh  wide settings in entirety.  nullable: true  type: boolean  failover:  description: 'Optional: only one of distribute,  failover or failoverPriority can be set.'  items:  properties:  from:  description: Originating region.  type: string  to:  type: string  type: object  type: array  failoverPriority:  description: failoverPriority is an ordered list  of labels used to sort endpoints to do priority  based load balancing.  items:  type: string  type: array  type: object  simple:  enum:  - ROUND_ROBIN  - LEAST_CONN  - RANDOM  - PASSTHROUGH  type: string  type: object  outlierDetection:  properties:  baseEjectionTime:  description: Minimum ejection duration.  type: string  consecutive5xxErrors:  description: Number of 5xx errors before a host is ejected  from the connection pool.  nullable: true  type: integer  consecutiveErrors:  format: int32  type: integer  consecutiveGatewayErrors:  description: Number of gateway errors before a host  is ejected from the connection pool.  nullable: true  type: integer  consecutiveLocalOriginFailures:  nullable: true  type: integer  interval:  description: Time interval between ejection sweep analysis.  type: string  maxEjectionPercent:  format: int32  type: integer  minHealthPercent:  format: int32  type: integer  splitExternalLocalOriginErrors:  description: Determines whether to distinguish local  origin failures from external errors.  type: boolean  type: object  port:  properties:  number:  type: integer  type: object  tls:  description: TLS related settings for connections to the  upstream service.  properties:  caCertificates:  type: string  clientCertificate:  description: REQUIRED if mode is `MUTUAL`.  type: string  credentialName:  type: string  insecureSkipVerify:  nullable: true  type: boolean  mode:  enum:  - DISABLE  - SIMPLE  - MUTUAL  - ISTIO_MUTUAL  type: string  privateKey:  description: REQUIRED if mode is `MUTUAL`.  type: string  sni:  description: SNI string to present to the server during  TLS handshake.  type: string  subjectAltNames:  items:  type: string  type: array  type: object  type: object  type: array  tls:  description: TLS related settings for connections to the upstream  service.  properties:  caCertificates:  type: string  clientCertificate:  description: REQUIRED if mode is `MUTUAL`.  type: string  credentialName:  type: string  insecureSkipVerify:  nullable: true  type: boolean  mode:  enum:  - DISABLE  - SIMPLE  - MUTUAL  - ISTIO_MUTUAL  type: string  privateKey:  description: REQUIRED if mode is `MUTUAL`.  type: string  sni:  description: SNI string to present to the server during TLS  handshake.  type: string  subjectAltNames:  items:  type: string  type: array  type: object  type: object  type: object  status:  type: object  x-kubernetes-preserve-unknown-fields: true  type: object  served: true  storage: false  subresources:  status: {} --- # Source: base/templates/crds.yaml apiVersion: apiextensions.k8s.io/v1 kind: CustomResourceDefinition metadata:  annotations:  \"helm.sh/resource-policy\": keep  labels:  app: istio-pilot  chart: istio  heritage: Tiller  release: istio  name: envoyfilters.networking.istio.io spec:  group: networking.istio.io  names:  categories:  - istio-io  - networking-istio-io  kind: EnvoyFilter  listKind: EnvoyFilterList  plural: envoyfilters  singular: envoyfilter  scope: Namespaced  versions:  - name: v1alpha3  schema:  openAPIV3Schema:  properties:  spec:  description: 'Customizing Envoy configuration generated by Istio. See more details at: https://istio.io/docs/reference/config/networking/envoy-filter.html'  properties:  configPatches:  description: One or more patches with match conditions.  items:  properties:  applyTo:  enum:  - INVALID  - LISTENER  - FILTER_CHAIN  - NETWORK_FILTER  - HTTP_FILTER  - ROUTE_CONFIGURATION  - VIRTUAL_HOST  - HTTP_ROUTE  - CLUSTER  - EXTENSION_CONFIG  - BOOTSTRAP  type: string  match:  description: Match on listener/route configuration/cluster.  oneOf:  - not:  anyOf:  - required:  - listener  - required:  - routeConfiguration  - required:  - cluster  - required:  - listener  - required:  - routeConfiguration  - required:  - cluster  properties:  cluster:  description: Match on envoy cluster attributes.  properties:  name:  description: The exact name of the cluster to match.  type: string  portNumber:  description: The service port for which this cluster  was generated.  type: integer  service:  description: The fully qualified service name for this  cluster.  type: string  subset:  description: The subset associated with the service.  type: string  type: object  context:  description: The specific config generation context to match  on.  enum:  - ANY  - SIDECAR_INBOUND  - SIDECAR_OUTBOUND  - GATEWAY  type: string  listener:  description: Match on envoy listener attributes.  properties:  filterChain:  description: Match a specific filter chain in a listener.  properties:  applicationProtocols:  description: Applies only to sidecars.  type: string  destinationPort:  description: The destination_port value used by  a filter chain's match condition.  type: integer  filter:  description: The name of a specific filter to apply  the patch to.  properties:  name:  description: The filter name to match on.  type: string  subFilter:  properties:  name:  description: The filter name to match on.  type: string  type: object  type: object  name:  description: The name assigned to the filter chain.  type: string  sni:  description: The SNI value used by a filter chain's  match condition.  type: string  transportProtocol:  description: Applies only to `SIDECAR_INBOUND` context.  type: string  type: object  name:  description: Match a specific listener by its name.  type: string  portName:  type: string  portNumber:  type: integer  type: object  proxy:  description: Match on properties associated with a proxy.  properties:  metadata:  additionalProperties:  type: string  type: object  proxyVersion:  type: string  type: object  routeConfiguration:  description: Match on envoy HTTP route configuration attributes.  properties:  gateway:  type: string  name:  description: Route configuration name to match on.  type: string  portName:  description: Applicable only for GATEWAY context.  type: string  portNumber:  type: integer  vhost:  properties:  name:  type: string  route:  description: Match a specific route within the virtual  host.  properties:  action:  description: Match a route with specific action  type.  enum:  - ANY  - ROUTE  - REDIRECT  - DIRECT_RESPONSE  type: string  name:  type: string  type: object  type: object  type: object  type: object  patch:  description: The patch to apply along with the operation.  properties:  filterClass:  description: Determines the filter insertion order.  enum:  - UNSPECIFIED  - AUTHN  - AUTHZ  - STATS  type: string  operation:  description: Determines how the patch should be applied.  enum:  - INVALID  - MERGE  - ADD  - REMOVE  - INSERT_BEFORE  - INSERT_AFTER  - INSERT_FIRST  - REPLACE  type: string  value:  description: The JSON config of the object being patched.  type: object  x-kubernetes-preserve-unknown-fields: true  type: object  type: object  type: array  priority:  description: Priority defines the order in which patch sets are applied  within a context.  format: int32  type: integer  workloadSelector:  properties:  labels:  additionalProperties:  type: string  type: object  type: object  type: object  status:  type: object  x-kubernetes-preserve-unknown-fields: true  type: object  served: true  storage: true  subresources:  status: {} --- # Source: base/templates/crds.yaml apiVersion: apiextensions.k8s.io/v1 kind: CustomResourceDefinition metadata:  annotations:  \"helm.sh/resource-policy\": keep  labels:  app: istio-pilot  chart: istio  heritage: Tiller  release: istio  name: gateways.networking.istio.io spec:  group: networking.istio.io  names:  categories:  - istio-io  - networking-istio-io  kind: Gateway  listKind: GatewayList  plural: gateways  shortNames:  - gw  singular: gateway  scope: Namespaced  versions:  - name: v1alpha3  schema:  openAPIV3Schema:  properties:  spec:  description: 'Configuration affecting edge load balancer. See more details at: https://istio.io/docs/reference/config/networking/gateway.html'  properties:  selector:  additionalProperties:  type: string  type: object  servers:  description: A list of server specifications.  items:  properties:  bind:  type: string  defaultEndpoint:  type: string  hosts:  description: One or more hosts exposed by this gateway.  items:  type: string  type: array  name:  description: An optional name of the server, when set must be  unique across all servers.  type: string  port:  properties:  name:  description: Label assigned to the port.  type: string  number:  description: A valid non-negative integer port number.  type: integer  protocol:  description: The protocol exposed on the port.  type: string  targetPort:  type: integer  type: object  tls:  description: Set of TLS related options that govern the server's  behavior.  properties:  caCertificates:  description: REQUIRED if mode is `MUTUAL`.  type: string  cipherSuites:  description: 'Optional: If specified, only support the specified  cipher list.'  items:  type: string  type: array  credentialName:  type: string  httpsRedirect:  type: boolean  maxProtocolVersion:  description: 'Optional: Maximum TLS protocol version.'  enum:  - TLS_AUTO  - TLSV1_0  - TLSV1_1  - TLSV1_2  - TLSV1_3  type: string  minProtocolVersion:  description: 'Optional: Minimum TLS protocol version.'  enum:  - TLS_AUTO  - TLSV1_0  - TLSV1_1  - TLSV1_2  - TLSV1_3  type: string  mode:  enum:  - PASSTHROUGH  - SIMPLE  - MUTUAL  - AUTO_PASSTHROUGH  - ISTIO_MUTUAL  type: string  privateKey:  description: REQUIRED if mode is `SIMPLE` or `MUTUAL`.  type: string  serverCertificate:  description: REQUIRED if mode is `SIMPLE` or `MUTUAL`.  type: string  subjectAltNames:  items:  type: string  type: array  verifyCertificateHash:  items:  type: string  type: array  verifyCertificateSpki:  items:  type: string  type: array  type: object  type: object  type: array  type: object  status:  type: object  x-kubernetes-preserve-unknown-fields: true  type: object  served: true  storage: true  subresources:  status: {}  - name: v1beta1  schema:  openAPIV3Schema:  properties:  spec:  description: 'Configuration affecting edge load balancer. See more details at: https://istio.io/docs/reference/config/networking/gateway.html'  properties:  selector:  additionalProperties:  type: string  type: object  servers:  description: A list of server specifications.  items:  properties:  bind:  type: string  defaultEndpoint:  type: string  hosts:  description: One or more hosts exposed by this gateway.  items:  type: string  type: array  name:  description: An optional name of the server, when set must be  unique across all servers.  type: string  port:  properties:  name:  description: Label assigned to the port.  type: string  number:  description: A valid non-negative integer port number.  type: integer  protocol:  description: The protocol exposed on the port.  type: string  targetPort:  type: integer  type: object  tls:  description: Set of TLS related options that govern the server's  behavior.  properties:  caCertificates:  description: REQUIRED if mode is `MUTUAL`.  type: string  cipherSuites:  description: 'Optional: If specified, only support the specified  cipher list.'  items:  type: string  type: array  credentialName:  type: string  httpsRedirect:  type: boolean  maxProtocolVersion:  description: 'Optional: Maximum TLS protocol version.'  enum:  - TLS_AUTO  - TLSV1_0  - TLSV1_1  - TLSV1_2  - TLSV1_3  type: string  minProtocolVersion:  description: 'Optional: Minimum TLS protocol version.'  enum:  - TLS_AUTO  - TLSV1_0  - TLSV1_1  - TLSV1_2  - TLSV1_3  type: string  mode:  enum:  - PASSTHROUGH  - SIMPLE  - MUTUAL  - AUTO_PASSTHROUGH  - ISTIO_MUTUAL  type: string  privateKey:  description: REQUIRED if mode is `SIMPLE` or `MUTUAL`.  type: string  serverCertificate:  description: REQUIRED if mode is `SIMPLE` or `MUTUAL`.  type: string  subjectAltNames:  items:  type: string  type: array  verifyCertificateHash:  items:  type: string  type: array  verifyCertificateSpki:  items:  type: string  type: array  type: object  type: object  type: array  type: object  status:  type: object  x-kubernetes-preserve-unknown-fields: true  type: object  served: true  storage: false  subresources:  status: {} --- # Source: base/templates/crds.yaml apiVersion: apiextensions.k8s.io/v1 kind: CustomResourceDefinition metadata:  annotations:  \"helm.sh/resource-policy\": keep  labels:  app: istio-pilot  chart: istio  heritage: Tiller  release: istio  name: proxyconfigs.networking.istio.io spec:  group: networking.istio.io  names:  categories:  - istio-io  - networking-istio-io  kind: ProxyConfig  listKind: ProxyConfigList  plural: proxyconfigs  singular: proxyconfig  scope: Namespaced  versions:  - name: v1beta1  schema:  openAPIV3Schema:  properties:  spec:  description: 'Provides configuration for individual workloads. See more details at: https://istio.io/docs/reference/config/networking/proxy-config.html'  properties:  concurrency:  description: The number of worker threads to run.  nullable: true  type: integer  environmentVariables:  additionalProperties:  type: string  description: Additional environment variables for the proxy.  type: object  image:  description: Specifies the details of the proxy image.  properties:  imageType:  description: The image type of the image.  type: string  type: object  selector:  description: Optional.  properties:  matchLabels:  additionalProperties:  type: string  type: object  type: object  type: object  status:  type: object  x-kubernetes-preserve-unknown-fields: true  type: object  served: true  storage: true  subresources:  status: {} --- # Source: base/templates/crds.yaml apiVersion: apiextensions.k8s.io/v1 kind: CustomResourceDefinition metadata:  annotations:  \"helm.sh/resource-policy\": keep  labels:  app: istio-pilot  chart: istio  heritage: Tiller  release: istio  name: serviceentries.networking.istio.io spec:  group: networking.istio.io  names:  categories:  - istio-io  - networking-istio-io  kind: ServiceEntry  listKind: ServiceEntryList  plural: serviceentries  shortNames:  - se  singular: serviceentry  scope: Namespaced  versions:  - additionalPrinterColumns:  - description: The hosts associated with the ServiceEntry  jsonPath: .spec.hosts  name: Hosts  type: string  - description: Whether the service is external to the mesh or part of the mesh  (MESH_EXTERNAL or MESH_INTERNAL)  jsonPath: .spec.location  name: Location  type: string  - description: Service discovery mode for the hosts (NONE, STATIC, or DNS)  jsonPath: .spec.resolution  name: Resolution  type: string  - description: 'CreationTimestamp is a timestamp representing the server time when this object was created. It is not guaranteed to be set in happens-before order across separate operations. Clients may not set this value. It is represented in RFC3339 form and is in UTC. Populated by the system. Read-only. Null for lists. More info: https://git.k8s.io/community/contributors/devel/api-conventions.md#metadata'  jsonPath: .metadata.creationTimestamp  name: Age  type: date  name: v1alpha3  schema:  openAPIV3Schema:  properties:  spec:  description: 'Configuration affecting service registry. See more details at: https://istio.io/docs/reference/config/networking/service-entry.html'  properties:  addresses:  description: The virtual IP addresses associated with the service.  items:  type: string  type: array  endpoints:  description: One or more endpoints associated with the service.  items:  properties:  address:  type: string  labels:  additionalProperties:  type: string  description: One or more labels associated with the endpoint.  type: object  locality:  description: The locality associated with the endpoint.  type: string  network:  type: string  ports:  additionalProperties:  type: integer  description: Set of ports associated with the endpoint.  type: object  serviceAccount:  type: string  weight:  description: The load balancing weight associated with the endpoint.  type: integer  type: object  type: array  exportTo:  description: A list of namespaces to which this service is exported.  items:  type: string  type: array  hosts:  description: The hosts associated with the ServiceEntry.  items:  type: string  type: array  location:  enum:  - MESH_EXTERNAL  - MESH_INTERNAL  type: string  ports:  description: The ports associated with the external service.  items:  properties:  name:  description: Label assigned to the port.  type: string  number:  description: A valid non-negative integer port number.  type: integer  protocol:  description: The protocol exposed on the port.  type: string  targetPort:  type: integer  type: object  type: array  resolution:  description: Service discovery mode for the hosts.  enum:  - NONE  - STATIC  - DNS  - DNS_ROUND_ROBIN  type: string  subjectAltNames:  items:  type: string  type: array  workloadSelector:  description: Applicable only for MESH_INTERNAL services.  properties:  labels:  additionalProperties:  type: string  type: object  type: object  type: object  status:  type: object  x-kubernetes-preserve-unknown-fields: true  type: object  served: true  storage: true  subresources:  status: {}  - additionalPrinterColumns:  - description: The hosts associated with the ServiceEntry  jsonPath: .spec.hosts  name: Hosts  type: string  - description: Whether the service is external to the mesh or part of the mesh  (MESH_EXTERNAL or MESH_INTERNAL)  jsonPath: .spec.location  name: Location  type: string  - description: Service discovery mode for the hosts (NONE, STATIC, or DNS)  jsonPath: .spec.resolution  name: Resolution  type: string  - description: 'CreationTimestamp is a timestamp representing the server time when this object was created. It is not guaranteed to be set in happens-before order across separate operations. Clients may not set this value. It is represented in RFC3339 form and is in UTC. Populated by the system. Read-only. Null for lists. More info: https://git.k8s.io/community/contributors/devel/api-conventions.md#metadata'  jsonPath: .metadata.creationTimestamp  name: Age  type: date  name: v1beta1  schema:  openAPIV3Schema:  properties:  spec:  description: 'Configuration affecting service registry. See more details at: https://istio.io/docs/reference/config/networking/service-entry.html'  properties:  addresses:  description: The virtual IP addresses associated with the service.  items:  type: string  type: array  endpoints:  description: One or more endpoints associated with the service.  items:  properties:  address:  type: string  labels:  additionalProperties:  type: string  description: One or more labels associated with the endpoint.  type: object  locality:  description: The locality associated with the endpoint.  type: string  network:  type: string  ports:  additionalProperties:  type: integer  description: Set of ports associated with the endpoint.  type: object  serviceAccount:  type: string  weight:  description: The load balancing weight associated with the endpoint.  type: integer  type: object  type: array  exportTo:  description: A list of namespaces to which this service is exported.  items:  type: string  type: array  hosts:  description: The hosts associated with the ServiceEntry.  items:  type: string  type: array  location:  enum:  - MESH_EXTERNAL  - MESH_INTERNAL  type: string  ports:  description: The ports associated with the external service.  items:  properties:  name:  description: Label assigned to the port.  type: string  number:  description: A valid non-negative integer port number.  type: integer  protocol:  description: The protocol exposed on the port.  type: string  targetPort:  type: integer  type: object  type: array  resolution:  description: Service discovery mode for the hosts.  enum:  - NONE  - STATIC  - DNS  - DNS_ROUND_ROBIN  type: string  subjectAltNames:  items:  type: string  type: array  workloadSelector:  description: Applicable only for MESH_INTERNAL services.  properties:  labels:  additionalProperties:  type: string  type: object  type: object  type: object  status:  type: object  x-kubernetes-preserve-unknown-fields: true  type: object  served: true  storage: false  subresources:  status: {} --- # Source: base/templates/crds.yaml apiVersion: apiextensions.k8s.io/v1 kind: CustomResourceDefinition metadata:  annotations:  \"helm.sh/resource-policy\": keep  labels:  app: istio-pilot  chart: istio  heritage: Tiller  release: istio  name: sidecars.networking.istio.io spec:  group: networking.istio.io  names:  categories:  - istio-io  - networking-istio-io  kind: Sidecar  listKind: SidecarList  plural: sidecars  singular: sidecar  scope: Namespaced  versions:  - name: v1alpha3  schema:  openAPIV3Schema:  properties:  spec:  description: 'Configuration affecting network reachability of a sidecar. See more details at: https://istio.io/docs/reference/config/networking/sidecar.html'  properties:  egress:  items:  properties:  bind:  type: string  captureMode:  enum:  - DEFAULT  - IPTABLES  - NONE  type: string  hosts:  items:  type: string  type: array  port:  description: The port associated with the listener.  properties:  name:  description: Label assigned to the port.  type: string  number:  description: A valid non-negative integer port number.  type: integer  protocol:  description: The protocol exposed on the port.  type: string  targetPort:  type: integer  type: object  type: object  type: array  ingress:  items:  properties:  bind:  description: The IP to which the listener should be bound.  type: string  captureMode:  enum:  - DEFAULT  - IPTABLES  - NONE  type: string  defaultEndpoint:  type: string  port:  description: The port associated with the listener.  properties:  name:  description: Label assigned to the port.  type: string  number:  description: A valid non-negative integer port number.  type: integer  protocol:  description: The protocol exposed on the port.  type: string  targetPort:  type: integer  type: object  tls:  properties:  caCertificates:  description: REQUIRED if mode is `MUTUAL`.  type: string  cipherSuites:  description: 'Optional: If specified, only support the specified  cipher list.'  items:  type: string  type: array  credentialName:  type: string  httpsRedirect:  type: boolean  maxProtocolVersion:  description: 'Optional: Maximum TLS protocol version.'  enum:  - TLS_AUTO  - TLSV1_0  - TLSV1_1  - TLSV1_2  - TLSV1_3  type: string  minProtocolVersion:  description: 'Optional: Minimum TLS protocol version.'  enum:  - TLS_AUTO  - TLSV1_0  - TLSV1_1  - TLSV1_2  - TLSV1_3  type: string  mode:  enum:  - PASSTHROUGH  - SIMPLE  - MUTUAL  - AUTO_PASSTHROUGH  - ISTIO_MUTUAL  type: string  privateKey:  description: REQUIRED if mode is `SIMPLE` or `MUTUAL`.  type: string  serverCertificate:  description: REQUIRED if mode is `SIMPLE` or `MUTUAL`.  type: string  subjectAltNames:  items:  type: string  type: array  verifyCertificateHash:  items:  type: string  type: array  verifyCertificateSpki:  items:  type: string  type: array  type: object  type: object  type: array  outboundTrafficPolicy:  description: Configuration for the outbound traffic policy.  properties:  egressProxy:  properties:  host:  description: The name of a service from the service registry.  type: string  port:  description: Specifies the port on the host that is being  addressed.  properties:  number:  type: integer  type: object  subset:  description: The name of a subset within the service.  type: string  type: object  mode:  enum:  - REGISTRY_ONLY  - ALLOW_ANY  type: string  type: object  workloadSelector:  properties:  labels:  additionalProperties:  type: string  type: object  type: object  type: object  status:  type: object  x-kubernetes-preserve-unknown-fields: true  type: object  served: true  storage: true  subresources:  status: {}  - name: v1beta1  schema:  openAPIV3Schema:  properties:  spec:  description: 'Configuration affecting network reachability of a sidecar. See more details at: https://istio.io/docs/reference/config/networking/sidecar.html'  properties:  egress:  items:  properties:  bind:  type: string  captureMode:  enum:  - DEFAULT  - IPTABLES  - NONE  type: string  hosts:  items:  type: string  type: array  port:  description: The port associated with the listener.  properties:  name:  description: Label assigned to the port.  type: string  number:  description: A valid non-negative integer port number.  type: integer  protocol:  description: The protocol exposed on the port.  type: string  targetPort:  type: integer  type: object  type: object  type: array  ingress:  items:  properties:  bind:  description: The IP to which the listener should be bound.  type: string  captureMode:  enum:  - DEFAULT  - IPTABLES  - NONE  type: string  defaultEndpoint:  type: string  port:  description: The port associated with the listener.  properties:  name:  description: Label assigned to the port.  type: string  number:  description: A valid non-negative integer port number.  type: integer  protocol:  description: The protocol exposed on the port.  type: string  targetPort:  type: integer  type: object  tls:  properties:  caCertificates:  description: REQUIRED if mode is `MUTUAL`.  type: string  cipherSuites:  description: 'Optional: If specified, only support the specified  cipher list.'  items:  type: string  type: array  credentialName:  type: string  httpsRedirect:  type: boolean  maxProtocolVersion:  description: 'Optional: Maximum TLS protocol version.'  enum:  - TLS_AUTO  - TLSV1_0  - TLSV1_1  - TLSV1_2  - TLSV1_3  type: string  minProtocolVersion:  description: 'Optional: Minimum TLS protocol version.'  enum:  - TLS_AUTO  - TLSV1_0  - TLSV1_1  - TLSV1_2  - TLSV1_3  type: string  mode:  enum:  - PASSTHROUGH  - SIMPLE  - MUTUAL  - AUTO_PASSTHROUGH  - ISTIO_MUTUAL  type: string  privateKey:  description: REQUIRED if mode is `SIMPLE` or `MUTUAL`.  type: string  serverCertificate:  description: REQUIRED if mode is `SIMPLE` or `MUTUAL`.  type: string  subjectAltNames:  items:  type: string  type: array  verifyCertificateHash:  items:  type: string  type: array  verifyCertificateSpki:  items:  type: string  type: array  type: object  type: object  type: array  outboundTrafficPolicy:  description: Configuration for the outbound traffic policy.  properties:  egressProxy:  properties:  host:  description: The name of a service from the service registry.  type: string  port:  description: Specifies the port on the host that is being  addressed.  properties:  number:  type: integer  type: object  subset:  description: The name of a subset within the service.  type: string  type: object  mode:  enum:  - REGISTRY_ONLY  - ALLOW_ANY  type: string  type: object  workloadSelector:  properties:  labels:  additionalProperties:  type: string  type: object  type: object  type: object  status:  type: object  x-kubernetes-preserve-unknown-fields: true  type: object  served: true  storage: false  subresources:  status: {} --- # Source: base/templates/crds.yaml apiVersion: apiextensions.k8s.io/v1 kind: CustomResourceDefinition metadata:  annotations:  \"helm.sh/resource-policy\": keep  labels:  app: istio-pilot  chart: istio  heritage: Tiller  release: istio  name: virtualservices.networking.istio.io spec:  group: networking.istio.io  names:  categories:  - istio-io  - networking-istio-io  kind: VirtualService  listKind: VirtualServiceList  plural: virtualservices  shortNames:  - vs  singular: virtualservice  scope: Namespaced  versions:  - additionalPrinterColumns:  - description: The names of gateways and sidecars that should apply these routes  jsonPath: .spec.gateways  name: Gateways  type: string  - description: The destination hosts to which traffic is being sent  jsonPath: .spec.hosts  name: Hosts  type: string  - description: 'CreationTimestamp is a timestamp representing the server time when this object was created. It is not guaranteed to be set in happens-before order across separate operations. Clients may not set this value. It is represented in RFC3339 form and is in UTC. Populated by the system. Read-only. Null for lists. More info: https://git.k8s.io/community/contributors/devel/api-conventions.md#metadata'  jsonPath: .metadata.creationTimestamp  name: Age  type: date  name: v1alpha3  schema:  openAPIV3Schema:  properties:  spec:  description: 'Configuration affecting label/content routing, sni routing, etc. See more details at: https://istio.io/docs/reference/config/networking/virtual-service.html'  properties:  exportTo:  description: A list of namespaces to which this virtual service is  exported.  items:  type: string  type: array  gateways:  description: The names of gateways and sidecars that should apply  these routes.  items:  type: string  type: array  hosts:  description: The destination hosts to which traffic is being sent.  items:  type: string  type: array  http:  description: An ordered list of route rules for HTTP traffic.  items:  properties:  corsPolicy:  description: Cross-Origin Resource Sharing policy (CORS).  properties:  allowCredentials:  nullable: true  type: boolean  allowHeaders:  items:  type: string  type: array  allowMethods:  description: List of HTTP methods allowed to access the  resource.  items:  type: string  type: array  allowOrigin:  description: The list of origins that are allowed to perform  CORS requests.  items:  type: string  type: array  allowOrigins:  description: String patterns that match allowed origins.  items:  oneOf:  - not:  anyOf:  - required:  - exact  - required:  - prefix  - required:  - regex  - required:  - exact  - required:  - prefix  - required:  - regex  properties:  exact:  type: string  prefix:  type: string  regex:  description: RE2 style regex-based match (https://github.com/google/re2/wiki/Syntax).  type: string  type: object  type: array  exposeHeaders:  items:  type: string  type: array  maxAge:  type: string  type: object  delegate:  properties:  name:  description: Name specifies the name of the delegate VirtualService.  type: string  namespace:  description: Namespace specifies the namespace where the  delegate VirtualService resides.  type: string  type: object  fault:  description: Fault injection policy to apply on HTTP traffic  at the client side.  properties:  abort:  oneOf:  - not:  anyOf:  - required:  - httpStatus  - required:  - grpcStatus  - required:  - http2Error  - required:  - httpStatus  - required:  - grpcStatus  - required:  - http2Error  properties:  grpcStatus:  type: string  http2Error:  type: string  httpStatus:  description: HTTP status code to use to abort the Http  request.  format: int32  type: integer  percentage:  description: Percentage of requests to be aborted with  the error code provided.  properties:  value:  format: double  type: number  type: object  type: object  delay:  oneOf:  - not:  anyOf:  - required:  - fixedDelay  - required:  - exponentialDelay  - required:  - fixedDelay  - required:  - exponentialDelay  properties:  exponentialDelay:  type: string  fixedDelay:  description: Add a fixed delay before forwarding the  request.  type: string  percent:  description: Percentage of requests on which the delay  will be injected (0-100).  format: int32  type: integer  percentage:  description: Percentage of requests on which the delay  will be injected.  properties:  value:  format: double  type: number  type: object  type: object  type: object  headers:  properties:  request:  properties:  add:  additionalProperties:  type: string  type: object  remove:  items:  type: string  type: array  set:  additionalProperties:  type: string  type: object  type: object  response:  properties:  add:  additionalProperties:  type: string  type: object  remove:  items:  type: string  type: array  set:  additionalProperties:  type: string  type: object  type: object  type: object  match:  items:  properties:  authority:  oneOf:  - not:  anyOf:  - required:  - exact  - required:  - prefix  - required:  - regex  - required:  - exact  - required:  - prefix  - required:  - regex  properties:  exact:  type: string  prefix:  type: string  regex:  description: RE2 style regex-based match (https://github.com/google/re2/wiki/Syntax).  type: string  type: object  gateways:  description: Names of gateways where the rule should be  applied.  items:  type: string  type: array  headers:  additionalProperties:  oneOf:  - not:  anyOf:  - required:  - exact  - required:  - prefix  - required:  - regex  - required:  - exact  - required:  - prefix  - required:  - regex  properties:  exact:  type: string  prefix:  type: string  regex:  description: RE2 style regex-based match (https://github.com/google/re2/wiki/Syntax).  type: string  type: object  type: object  ignoreUriCase:  description: Flag to specify whether the URI matching  should be case-insensitive.  type: boolean  method:  oneOf:  - not:  anyOf:  - required:  - exact  - required:  - prefix  - required:  - regex  - required:  - exact  - required:  - prefix  - required:  - regex  properties:  exact:  type: string  prefix:  type: string  regex:  description: RE2 style regex-based match (https://github.com/google/re2/wiki/Syntax).  type: string  type: object  name:  description: The name assigned to a match.  type: string  port:  description: Specifies the ports on the host that is being  addressed.  type: integer  queryParams:  additionalProperties:  oneOf:  - not:  anyOf:  - required:  - exact  - required:  - prefix  - required:  - regex  - required:  - exact  - required:  - prefix  - required:  - regex  properties:  exact:  type: string  prefix:  type: string  regex:  description: RE2 style regex-based match (https://github.com/google/re2/wiki/Syntax).  type: string  type: object  description: Query parameters for matching.  type: object  scheme:  oneOf:  - not:  anyOf:  - required:  - exact  - required:  - prefix  - required:  - regex  - required:  - exact  - required:  - prefix  - required:  - regex  properties:  exact:  type: string  prefix:  type: string  regex:  description: RE2 style regex-based match (https://github.com/google/re2/wiki/Syntax).  type: string  type: object  sourceLabels:  additionalProperties:  type: string  type: object  sourceNamespace:  description: Source namespace constraining the applicability  of a rule to workloads in that namespace.  type: string  uri:  oneOf:  - not:  anyOf:  - required:  - exact  - required:  - prefix  - required:  - regex  - required:  - exact  - required:  - prefix  - required:  - regex  properties:  exact:  type: string  prefix:  type: string  regex:  description: RE2 style regex-based match (https://github.com/google/re2/wiki/Syntax).  type: string  type: object  withoutHeaders:  additionalProperties:  oneOf:  - not:  anyOf:  - required:  - exact  - required:  - prefix  - required:  - regex  - required:  - exact  - required:  - prefix  - required:  - regex  properties:  exact:  type: string  prefix:  type: string  regex:  description: RE2 style regex-based match (https://github.com/google/re2/wiki/Syntax).  type: string  type: object  description: withoutHeader has the same syntax with the  header, but has opposite meaning.  type: object  type: object  type: array  mirror:  properties:  host:  description: The name of a service from the service registry.  type: string  port:  description: Specifies the port on the host that is being  addressed.  properties:  number:  type: integer  type: object  subset:  description: The name of a subset within the service.  type: string  type: object  mirror_percent:  description: Percentage of the traffic to be mirrored by the  `mirror` field.  nullable: true  type: integer  mirrorPercent:  description: Percentage of the traffic to be mirrored by the  `mirror` field.  nullable: true  type: integer  mirrorPercentage:  description: Percentage of the traffic to be mirrored by the  `mirror` field.  properties:  value:  format: double  type: number  type: object  name:  description: The name assigned to the route for debugging purposes.  type: string  redirect:  description: A HTTP rule can either redirect or forward (default)  traffic.  oneOf:  - not:  anyOf:  - required:  - port  - required:  - derivePort  - required:  - port  - required:  - derivePort  properties:  authority:  type: string  derivePort:  enum:  - FROM_PROTOCOL_DEFAULT  - FROM_REQUEST_PORT  type: string  port:  description: On a redirect, overwrite the port portion of  the URL with this value.  type: integer  redirectCode:  type: integer  scheme:  description: On a redirect, overwrite the scheme portion  of the URL with this value.  type: string  uri:  type: string  type: object  retries:  description: Retry policy for HTTP requests.  properties:  attempts:  description: Number of retries to be allowed for a given  request.  format: int32  type: integer  perTryTimeout:  description: Timeout per attempt for a given request, including  the initial call and any retries.  type: string  retryOn:  description: Specifies the conditions under which retry  takes place.  type: string  retryRemoteLocalities:  description: Flag to specify whether the retries should  retry to other localities.  nullable: true  type: boolean  type: object  rewrite:  description: Rewrite HTTP URIs and Authority headers.  properties:  authority:  description: rewrite the Authority/Host header with this  value.  type: string  uri:  type: string  type: object  route:  description: A HTTP rule can either redirect or forward (default)  traffic.  items:  properties:  destination:  properties:  host:  description: The name of a service from the service  registry.  type: string  port:  description: Specifies the port on the host that is  being addressed.  properties:  number:  type: integer  type: object  subset:  description: The name of a subset within the service.  type: string  type: object  headers:  properties:  request:  properties:  add:  additionalProperties:  type: string  type: object  remove:  items:  type: string  type: array  set:  additionalProperties:  type: string  type: object  type: object  response:  properties:  add:  additionalProperties:  type: string  type: object  remove:  items:  type: string  type: array  set:  additionalProperties:  type: string  type: object  type: object  type: object  weight:  description: Weight specifies the relative proportion  of traffic to be forwarded to the destination.  format: int32  type: integer  type: object  type: array  timeout:  description: Timeout for HTTP requests, default is disabled.  type: string  type: object  type: array  tcp:  description: An ordered list of route rules for opaque TCP traffic.  items:  properties:  match:  items:  properties:  destinationSubnets:  description: IPv4 or IPv6 ip addresses of destination  with optional subnet.  items:  type: string  type: array  gateways:  description: Names of gateways where the rule should be  applied.  items:  type: string  type: array  port:  description: Specifies the port on the host that is being  addressed.  type: integer  sourceLabels:  additionalProperties:  type: string  type: object  sourceNamespace:  description: Source namespace constraining the applicability  of a rule to workloads in that namespace.  type: string  sourceSubnet:  description: IPv4 or IPv6 ip address of source with optional  subnet.  type: string  type: object  type: array  route:  description: The destination to which the connection should  be forwarded to.  items:  properties:  destination:  properties:  host:  description: The name of a service from the service  registry.  type: string  port:  description: Specifies the port on the host that is  being addressed.  properties:  number:  type: integer  type: object  subset:  description: The name of a subset within the service.  type: string  type: object  weight:  description: Weight specifies the relative proportion  of traffic to be forwarded to the destination.  format: int32  type: integer  type: object  type: array  type: object  type: array  tls:  items:  properties:  match:  items:  properties:  destinationSubnets:  description: IPv4 or IPv6 ip addresses of destination  with optional subnet.  items:  type: string  type: array  gateways:  description: Names of gateways where the rule should be  applied.  items:  type: string  type: array  port:  description: Specifies the port on the host that is being  addressed.  type: integer  sniHosts:  description: SNI (server name indicator) to match on.  items:  type: string  type: array  sourceLabels:  additionalProperties:  type: string  type: object  sourceNamespace:  description: Source namespace constraining the applicability  of a rule to workloads in that namespace.  type: string  type: object  type: array  route:  description: The destination to which the connection should  be forwarded to.  items:  properties:  destination:  properties:  host:  description: The name of a service from the service  registry.  type: string  port:  description: Specifies the port on the host that is  being addressed.  properties:  number:  type: integer  type: object  subset:  description: The name of a subset within the service.  type: string  type: object  weight:  description: Weight specifies the relative proportion  of traffic to be forwarded to the destination.  format: int32  type: integer  type: object  type: array  type: object  type: array  type: object  status:  type: object  x-kubernetes-preserve-unknown-fields: true  type: object  served: true  storage: true  subresources:  status: {}  - additionalPrinterColumns:  - description: The names of gateways and sidecars that should apply these routes  jsonPath: .spec.gateways  name: Gateways  type: string  - description: The destination hosts to which traffic is being sent  jsonPath: .spec.hosts  name: Hosts  type: string  - description: 'CreationTimestamp is a timestamp representing the server time when this object was created. It is not guaranteed to be set in happens-before order across separate operations. Clients may not set this value. It is represented in RFC3339 form and is in UTC. Populated by the system. Read-only. Null for lists. More info: https://git.k8s.io/community/contributors/devel/api-conventions.md#metadata'  jsonPath: .metadata.creationTimestamp  name: Age  type: date  name: v1beta1  schema:  openAPIV3Schema:  properties:  spec:  description: 'Configuration affecting label/content routing, sni routing, etc. See more details at: https://istio.io/docs/reference/config/networking/virtual-service.html'  properties:  exportTo:  description: A list of namespaces to which this virtual service is  exported.  items:  type: string  type: array  gateways:  description: The names of gateways and sidecars that should apply  these routes.  items:  type: string  type: array  hosts:  description: The destination hosts to which traffic is being sent.  items:  type: string  type: array  http:  description: An ordered list of route rules for HTTP traffic.  items:  properties:  corsPolicy:  description: Cross-Origin Resource Sharing policy (CORS).  properties:  allowCredentials:  nullable: true  type: boolean  allowHeaders:  items:  type: string  type: array  allowMethods:  description: List of HTTP methods allowed to access the  resource.  items:  type: string  type: array  allowOrigin:  description: The list of origins that are allowed to perform  CORS requests.  items:  type: string  type: array  allowOrigins:  description: String patterns that match allowed origins.  items:  oneOf:  - not:  anyOf:  - required:  - exact  - required:  - prefix  - required:  - regex  - required:  - exact  - required:  - prefix  - required:  - regex  properties:  exact:  type: string  prefix:  type: string  regex:  description: RE2 style regex-based match (https://github.com/google/re2/wiki/Syntax).  type: string  type: object  type: array  exposeHeaders:  items:  type: string  type: array  maxAge:  type: string  type: object  delegate:  properties:  name:  description: Name specifies the name of the delegate VirtualService.  type: string  namespace:  description: Namespace specifies the namespace where the  delegate VirtualService resides.  type: string  type: object  fault:  description: Fault injection policy to apply on HTTP traffic  at the client side.  properties:  abort:  oneOf:  - not:  anyOf:  - required:  - httpStatus  - required:  - grpcStatus  - required:  - http2Error  - required:  - httpStatus  - required:  - grpcStatus  - required:  - http2Error  properties:  grpcStatus:  type: string  http2Error:  type: string  httpStatus:  description: HTTP status code to use to abort the Http  request.  format: int32  type: integer  percentage:  description: Percentage of requests to be aborted with  the error code provided.  properties:  value:  format: double  type: number  type: object  type: object  delay:  oneOf:  - not:  anyOf:  - required:  - fixedDelay  - required:  - exponentialDelay  - required:  - fixedDelay  - required:  - exponentialDelay  properties:  exponentialDelay:  type: string  fixedDelay:  description: Add a fixed delay before forwarding the  request.  type: string  percent:  description: Percentage of requests on which the delay  will be injected (0-100).  format: int32  type: integer  percentage:  description: Percentage of requests on which the delay  will be injected.  properties:  value:  format: double  type: number  type: object  type: object  type: object  headers:  properties:  request:  properties:  add:  additionalProperties:  type: string  type: object  remove:  items:  type: string  type: array  set:  additionalProperties:  type: string  type: object  type: object  response:  properties:  add:  additionalProperties:  type: string  type: object  remove:  items:  type: string  type: array  set:  additionalProperties:  type: string  type: object  type: object  type: object  match:  items:  properties:  authority:  oneOf:  - not:  anyOf:  - required:  - exact  - required:  - prefix  - required:  - regex  - required:  - exact  - required:  - prefix  - required:  - regex  properties:  exact:  type: string  prefix:  type: string  regex:  description: RE2 style regex-based match (https://github.com/google/re2/wiki/Syntax).  type: string  type: object  gateways:  description: Names of gateways where the rule should be  applied.  items:  type: string  type: array  headers:  additionalProperties:  oneOf:  - not:  anyOf:  - required:  - exact  - required:  - prefix  - required:  - regex  - required:  - exact  - required:  - prefix  - required:  - regex  properties:  exact:  type: string  prefix:  type: string  regex:  description: RE2 style regex-based match (https://github.com/google/re2/wiki/Syntax).  type: string  type: object  type: object  ignoreUriCase:  description: Flag to specify whether the URI matching  should be case-insensitive.  type: boolean  method:  oneOf:  - not:  anyOf:  - required:  - exact  - required:  - prefix  - required:  - regex  - required:  - exact  - required:  - prefix  - required:  - regex  properties:  exact:  type: string  prefix:  type: string  regex:  description: RE2 style regex-based match (https://github.com/google/re2/wiki/Syntax).  type: string  type: object  name:  description: The name assigned to a match.  type: string  port:  description: Specifies the ports on the host that is being  addressed.  type: integer  queryParams:  additionalProperties:  oneOf:  - not:  anyOf:  - required:  - exact  - required:  - prefix  - required:  - regex  - required:  - exact  - required:  - prefix  - required:  - regex  properties:  exact:  type: string  prefix:  type: string  regex:  description: RE2 style regex-based match (https://github.com/google/re2/wiki/Syntax).  type: string  type: object  description: Query parameters for matching.  type: object  scheme:  oneOf:  - not:  anyOf:  - required:  - exact  - required:  - prefix  - required:  - regex  - required:  - exact  - required:  - prefix  - required:  - regex  properties:  exact:  type: string  prefix:  type: string  regex:  description: RE2 style regex-based match (https://github.com/google/re2/wiki/Syntax).  type: string  type: object  sourceLabels:  additionalProperties:  type: string  type: object  sourceNamespace:  description: Source namespace constraining the applicability  of a rule to workloads in that namespace.  type: string  uri:  oneOf:  - not:  anyOf:  - required:  - exact  - required:  - prefix  - required:  - regex  - required:  - exact  - required:  - prefix  - required:  - regex  properties:  exact:  type: string  prefix:  type: string  regex:  description: RE2 style regex-based match (https://github.com/google/re2/wiki/Syntax).  type: string  type: object  withoutHeaders:  additionalProperties:  oneOf:  - not:  anyOf:  - required:  - exact  - required:  - prefix  - required:  - regex  - required:  - exact  - required:  - prefix  - required:  - regex  properties:  exact:  type: string  prefix:  type: string  regex:  description: RE2 style regex-based match (https://github.com/google/re2/wiki/Syntax).  type: string  type: object  description: withoutHeader has the same syntax with the  header, but has opposite meaning.  type: object  type: object  type: array  mirror:  properties:  host:  description: The name of a service from the service registry.  type: string  port:  description: Specifies the port on the host that is being  addressed.  properties:  number:  type: integer  type: object  subset:  description: The name of a subset within the service.  type: string  type: object  mirror_percent:  description: Percentage of the traffic to be mirrored by the  `mirror` field.  nullable: true  type: integer  mirrorPercent:  description: Percentage of the traffic to be mirrored by the  `mirror` field.  nullable: true  type: integer  mirrorPercentage:  description: Percentage of the traffic to be mirrored by the  `mirror` field.  properties:  value:  format: double  type: number  type: object  name:  description: The name assigned to the route for debugging purposes.  type: string  redirect:  description: A HTTP rule can either redirect or forward (default)  traffic.  oneOf:  - not:  anyOf:  - required:  - port  - required:  - derivePort  - required:  - port  - required:  - derivePort  properties:  authority:  type: string  derivePort:  enum:  - FROM_PROTOCOL_DEFAULT  - FROM_REQUEST_PORT  type: string  port:  description: On a redirect, overwrite the port portion of  the URL with this value.  type: integer  redirectCode:  type: integer  scheme:  description: On a redirect, overwrite the scheme portion  of the URL with this value.  type: string  uri:  type: string  type: object  retries:  description: Retry policy for HTTP requests.  properties:  attempts:  description: Number of retries to be allowed for a given  request.  format: int32  type: integer  perTryTimeout:  description: Timeout per attempt for a given request, including  the initial call and any retries.  type: string  retryOn:  description: Specifies the conditions under which retry  takes place.  type: string  retryRemoteLocalities:  description: Flag to specify whether the retries should  retry to other localities.  nullable: true  type: boolean  type: object  rewrite:  description: Rewrite HTTP URIs and Authority headers.  properties:  authority:  description: rewrite the Authority/Host header with this  value.  type: string  uri:  type: string  type: object  route:  description: A HTTP rule can either redirect or forward (default)  traffic.  items:  properties:  destination:  properties:  host:  description: The name of a service from the service  registry.  type: string  port:  description: Specifies the port on the host that is  being addressed.  properties:  number:  type: integer  type: object  subset:  description: The name of a subset within the service.  type: string  type: object  headers:  properties:  request:  properties:  add:  additionalProperties:  type: string  type: object  remove:  items:  type: string  type: array  set:  additionalProperties:  type: string  type: object  type: object  response:  properties:  add:  additionalProperties:  type: string  type: object  remove:  items:  type: string  type: array  set:  additionalProperties:  type: string  type: object  type: object  type: object  weight:  description: Weight specifies the relative proportion  of traffic to be forwarded to the destination.  format: int32  type: integer  type: object  type: array  timeout:  description: Timeout for HTTP requests, default is disabled.  type: string  type: object  type: array  tcp:  description: An ordered list of route rules for opaque TCP traffic.  items:  properties:  match:  items:  properties:  destinationSubnets:  description: IPv4 or IPv6 ip addresses of destination  with optional subnet.  items:  type: string  type: array  gateways:  description: Names of gateways where the rule should be  applied.  items:  type: string  type: array  port:  description: Specifies the port on the host that is being  addressed.  type: integer  sourceLabels:  additionalProperties:  type: string  type: object  sourceNamespace:  description: Source namespace constraining the applicability  of a rule to workloads in that namespace.  type: string  sourceSubnet:  description: IPv4 or IPv6 ip address of source with optional  subnet.  type: string  type: object  type: array  route:  description: The destination to which the connection should  be forwarded to.  items:  properties:  destination:  properties:  host:  description: The name of a service from the service  registry.  type: string  port:  description: Specifies the port on the host that is  being addressed.  properties:  number:  type: integer  type: object  subset:  description: The name of a subset within the service.  type: string  type: object  weight:  description: Weight specifies the relative proportion  of traffic to be forwarded to the destination.  format: int32  type: integer  type: object  type: array  type: object  type: array  tls:  items:  properties:  match:  items:  properties:  destinationSubnets:  description: IPv4 or IPv6 ip addresses of destination  with optional subnet.  items:  type: string  type: array  gateways:  description: Names of gateways where the rule should be  applied.  items:  type: string  type: array  port:  description: Specifies the port on the host that is being  addressed.  type: integer  sniHosts:  description: SNI (server name indicator) to match on.  items:  type: string  type: array  sourceLabels:  additionalProperties:  type: string  type: object  sourceNamespace:  description: Source namespace constraining the applicability  of a rule to workloads in that namespace.  type: string  type: object  type: array  route:  description: The destination to which the connection should  be forwarded to.  items:  properties:  destination:  properties:  host:  description: The name of a service from the service  registry.  type: string  port:  description: Specifies the port on the host that is  being addressed.  properties:  number:  type: integer  type: object  subset:  description: The name of a subset within the service.  type: string  type: object  weight:  description: Weight specifies the relative proportion  of traffic to be forwarded to the destination.  format: int32  type: integer  type: object  type: array  type: object  type: array  type: object  status:  type: object  x-kubernetes-preserve-unknown-fields: true  type: object  served: true  storage: false  subresources:  status: {} --- # Source: base/templates/crds.yaml apiVersion: apiextensions.k8s.io/v1 kind: CustomResourceDefinition metadata:  annotations:  \"helm.sh/resource-policy\": keep  labels:  app: istio-pilot  chart: istio  heritage: Tiller  release: istio  name: workloadentries.networking.istio.io spec:  group: networking.istio.io  names:  categories:  - istio-io  - networking-istio-io  kind: WorkloadEntry  listKind: WorkloadEntryList  plural: workloadentries  shortNames:  - we  singular: workloadentry  scope: Namespaced  versions:  - additionalPrinterColumns:  - description: 'CreationTimestamp is a timestamp representing the server time when this object was created. It is not guaranteed to be set in happens-before order across separate operations. Clients may not set this value. It is represented in RFC3339 form and is in UTC. Populated by the system. Read-only. Null for lists. More info: https://git.k8s.io/community/contributors/devel/api-conventions.md#metadata'  jsonPath: .metadata.creationTimestamp  name: Age  type: date  - description: Address associated with the network endpoint.  jsonPath: .spec.address  name: Address  type: string  name: v1alpha3  schema:  openAPIV3Schema:  properties:  spec:  description: 'Configuration affecting VMs onboarded into the mesh. See more details at: https://istio.io/docs/reference/config/networking/workload-entry.html'  properties:  address:  type: string  labels:  additionalProperties:  type: string  description: One or more labels associated with the endpoint.  type: object  locality:  description: The locality associated with the endpoint.  type: string  network:  type: string  ports:  additionalProperties:  type: integer  description: Set of ports associated with the endpoint.  type: object  serviceAccount:  type: string  weight:  description: The load balancing weight associated with the endpoint.  type: integer  type: object  status:  type: object  x-kubernetes-preserve-unknown-fields: true  type: object  served: true  storage: true  subresources:  status: {}  - additionalPrinterColumns:  - description: 'CreationTimestamp is a timestamp representing the server time when this object was created. It is not guaranteed to be set in happens-before order across separate operations. Clients may not set this value. It is represented in RFC3339 form and is in UTC. Populated by the system. Read-only. Null for lists. More info: https://git.k8s.io/community/contributors/devel/api-conventions.md#metadata'  jsonPath: .metadata.creationTimestamp  name: Age  type: date  - description: Address associated with the network endpoint.  jsonPath: .spec.address  name: Address  type: string  name: v1beta1  schema:  openAPIV3Schema:  properties:  spec:  description: 'Configuration affecting VMs onboarded into the mesh. See more details at: https://istio.io/docs/reference/config/networking/workload-entry.html'  properties:  address:  type: string  labels:  additionalProperties:  type: string  description: One or more labels associated with the endpoint.  type: object  locality:  description: The locality associated with the endpoint.  type: string  network:  type: string  ports:  additionalProperties:  type: integer  description: Set of ports associated with the endpoint.  type: object  serviceAccount:  type: string  weight:  description: The load balancing weight associated with the endpoint.  type: integer  type: object  status:  type: object  x-kubernetes-preserve-unknown-fields: true  type: object  served: true  storage: false  subresources:  status: {} --- # Source: base/templates/crds.yaml apiVersion: apiextensions.k8s.io/v1 kind: CustomResourceDefinition metadata:  labels:  app: istio-pilot  chart: istio  heritage: Tiller  release: istio  name: workloadgroups.networking.istio.io spec:  group: networking.istio.io  names:  categories:  - istio-io  - networking-istio-io  kind: WorkloadGroup  listKind: WorkloadGroupList  plural: workloadgroups  shortNames:  - wg  singular: workloadgroup  scope: Namespaced  versions:  - additionalPrinterColumns:  - description: 'CreationTimestamp is a timestamp representing the server time when this object was created. It is not guaranteed to be set in happens-before order across separate operations. Clients may not set this value. It is represented in RFC3339 form and is in UTC. Populated by the system. Read-only. Null for lists. More info: https://git.k8s.io/community/contributors/devel/api-conventions.md#metadata'  jsonPath: .metadata.creationTimestamp  name: Age  type: date  name: v1alpha3  schema:  openAPIV3Schema:  properties:  spec:  description: 'Describes a collection of workload instances. See more details at: https://istio.io/docs/reference/config/networking/workload-group.html'  properties:  metadata:  description: Metadata that will be used for all corresponding `WorkloadEntries`.  properties:  annotations:  additionalProperties:  type: string  type: object  labels:  additionalProperties:  type: string  type: object  type: object  probe:  description: '`ReadinessProbe` describes the configuration the user must provide for healthchecking on their workload.'  oneOf:  - not:  anyOf:  - required:  - httpGet  - required:  - tcpSocket  - required:  - exec  - required:  - httpGet  - required:  - tcpSocket  - required:  - exec  properties:  exec:  description: Health is determined by how the command that is executed  exited.  properties:  command:  description: Command to run.  items:  type: string  type: array  type: object  failureThreshold:  description: Minimum consecutive failures for the probe to be  considered failed after having succeeded.  format: int32  type: integer  httpGet:  properties:  host:  description: Host name to connect to, defaults to the pod  IP.  type: string  httpHeaders:  description: Headers the proxy will pass on to make the request.  items:  properties:  name:  type: string  value:  type: string  type: object  type: array  path:  description: Path to access on the HTTP server.  type: string  port:  description: Port on which the endpoint lives.  type: integer  scheme:  type: string  type: object  initialDelaySeconds:  description: Number of seconds after the container has started  before readiness probes are initiated.  format: int32  type: integer  periodSeconds:  description: How often (in seconds) to perform the probe.  format: int32  type: integer  successThreshold:  description: Minimum consecutive successes for the probe to be  considered successful after having failed.  format: int32  type: integer  tcpSocket:  description: Health is determined by if the proxy is able to connect.  properties:  host:  type: string  port:  type: integer  type: object  timeoutSeconds:  description: Number of seconds after which the probe times out.  format: int32  type: integer  type: object  template:  description: Template to be used for the generation of `WorkloadEntry`  resources that belong to this `WorkloadGroup`.  properties:  address:  type: string  labels:  additionalProperties:  type: string  description: One or more labels associated with the endpoint.  type: object  locality:  description: The locality associated with the endpoint.  type: string  network:  type: string  ports:  additionalProperties:  type: integer  description: Set of ports associated with the endpoint.  type: object  serviceAccount:  type: string  weight:  description: The load balancing weight associated with the endpoint.  type: integer  type: object  type: object  status:  type: object  x-kubernetes-preserve-unknown-fields: true  type: object  served: true  storage: true  subresources:  status: {}  - additionalPrinterColumns:  - description: 'CreationTimestamp is a timestamp representing the server time when this object was created. It is not guaranteed to be set in happens-before order across separate operations. Clients may not set this value. It is represented in RFC3339 form and is in UTC. Populated by the system. Read-only. Null for lists. More info: https://git.k8s.io/community/contributors/devel/api-conventions.md#metadata'  jsonPath: .metadata.creationTimestamp  name: Age  type: date  name: v1beta1  schema:  openAPIV3Schema:  properties:  spec:  properties:  metadata:  description: Metadata that will be used for all corresponding `WorkloadEntries`.  properties:  annotations:  additionalProperties:  type: string  type: object  labels:  additionalProperties:  type: string  type: object  type: object  probe:  description: '`ReadinessProbe` describes the configuration the user must provide for healthchecking on their workload.'  oneOf:  - not:  anyOf:  - required:  - httpGet  - required:  - tcpSocket  - required:  - exec  - required:  - httpGet  - required:  - tcpSocket  - required:  - exec  properties:  exec:  description: Health is determined by how the command that is executed  exited.  properties:  command:  description: Command to run.  items:  type: string  type: array  type: object  failureThreshold:  description: Minimum consecutive failures for the probe to be  considered failed after having succeeded.  format: int32  type: integer  httpGet:  properties:  host:  description: Host name to connect to, defaults to the pod  IP.  type: string  httpHeaders:  description: Headers the proxy will pass on to make the request.  items:  properties:  name:  type: string  value:  type: string  type: object  type: array  path:  description: Path to access on the HTTP server.  type: string  port:  description: Port on which the endpoint lives.  type: integer  scheme:  type: string  type: object  initialDelaySeconds:  description: Number of seconds after the container has started  before readiness probes are initiated.  format: int32  type: integer  periodSeconds:  description: How often (in seconds) to perform the probe.  format: int32  type: integer  successThreshold:  description: Minimum consecutive successes for the probe to be  considered successful after having failed.  format: int32  type: integer  tcpSocket:  description: Health is determined by if the proxy is able to connect.  properties:  host:  type: string  port:  type: integer  type: object  timeoutSeconds:  description: Number of seconds after which the probe times out.  format: int32  type: integer  type: object  template:  description: Template to be used for the generation of `WorkloadEntry`  resources that belong to this `WorkloadGroup`.  properties:  address:  type: string  labels:  additionalProperties:  type: string  description: One or more labels associated with the endpoint.  type: object  locality:  description: The locality associated with the endpoint.  type: string  network:  type: string  ports:  additionalProperties:  type: integer  description: Set of ports associated with the endpoint.  type: object  serviceAccount:  type: string  weight:  description: The load balancing weight associated with the endpoint.  type: integer  type: object  type: object  status:  type: object  x-kubernetes-preserve-unknown-fields: true  type: object  served: true  storage: false  subresources:  status: {} --- # Source: base/templates/crds.yaml apiVersion: apiextensions.k8s.io/v1 kind: CustomResourceDefinition metadata:  annotations:  \"helm.sh/resource-policy\": keep  labels:  app: istio-pilot  chart: istio  heritage: Tiller  istio: security  release: istio  name: authorizationpolicies.security.istio.io spec:  group: security.istio.io  names:  categories:  - istio-io  - security-istio-io  kind: AuthorizationPolicy  listKind: AuthorizationPolicyList  plural: authorizationpolicies  singular: authorizationpolicy  scope: Namespaced  versions:  - name: v1beta1  schema:  openAPIV3Schema:  properties:  spec:  description: 'Configuration for access control on workloads. See more details at: https://istio.io/docs/reference/config/security/authorization-policy.html'  oneOf:  - not:  anyOf:  - required:  - provider  - required:  - provider  properties:  action:  description: Optional.  enum:  - ALLOW  - DENY  - AUDIT  - CUSTOM  type: string  provider:  description: Specifies detailed configuration of the CUSTOM action.  properties:  name:  description: Specifies the name of the extension provider.  type: string  type: object  rules:  description: Optional.  items:  properties:  from:  description: Optional.  items:  properties:  source:  description: Source specifies the source of a request.  properties:  ipBlocks:  description: Optional.  items:  type: string  type: array  namespaces:  description: Optional.  items:  type: string  type: array  notIpBlocks:  description: Optional.  items:  type: string  type: array  notNamespaces:  description: Optional.  items:  type: string  type: array  notPrincipals:  description: Optional.  items:  type: string  type: array  notRemoteIpBlocks:  description: Optional.  items:  type: string  type: array  notRequestPrincipals:  description: Optional.  items:  type: string  type: array  principals:  description: Optional.  items:  type: string  type: array  remoteIpBlocks:  description: Optional.  items:  type: string  type: array  requestPrincipals:  description: Optional.  items:  type: string  type: array  type: object  type: object  type: array  to:  description: Optional.  items:  properties:  operation:  description: Operation specifies the operation of a request.  properties:  hosts:  description: Optional.  items:  type: string  type: array  methods:  description: Optional.  items:  type: string  type: array  notHosts:  description: Optional.  items:  type: string  type: array  notMethods:  description: Optional.  items:  type: string  type: array  notPaths:  description: Optional.  items:  type: string  type: array  notPorts:  description: Optional.  items:  type: string  type: array  paths:  description: Optional.  items:  type: string  type: array  ports:  description: Optional.  items:  type: string  type: array  type: object  type: object  type: array  when:  description: Optional.  items:  properties:  key:  description: The name of an Istio attribute.  type: string  notValues:  description: Optional.  items:  type: string  type: array  values:  description: Optional.  items:  type: string  type: array  type: object  type: array  type: object  type: array  selector:  description: Optional.  properties:  matchLabels:  additionalProperties:  type: string  type: object  type: object  type: object  status:  type: object  x-kubernetes-preserve-unknown-fields: true  type: object  served: true  storage: true  subresources:  status: {} --- # Source: base/templates/crds.yaml apiVersion: apiextensions.k8s.io/v1 kind: CustomResourceDefinition metadata:  annotations:  \"helm.sh/resource-policy\": keep  labels:  app: istio-pilot  chart: istio  heritage: Tiller  istio: security  release: istio  name: peerauthentications.security.istio.io spec:  group: security.istio.io  names:  categories:  - istio-io  - security-istio-io  kind: PeerAuthentication  listKind: PeerAuthenticationList  plural: peerauthentications  shortNames:  - pa  singular: peerauthentication  scope: Namespaced  versions:  - additionalPrinterColumns:  - description: Defines the mTLS mode used for peer authentication.  jsonPath: .spec.mtls.mode  name: Mode  type: string  - description: 'CreationTimestamp is a timestamp representing the server time when this object was created. It is not guaranteed to be set in happens-before order across separate operations. Clients may not set this value. It is represented in RFC3339 form and is in UTC. Populated by the system. Read-only. Null for lists. More info: https://git.k8s.io/community/contributors/devel/api-conventions.md#metadata'  jsonPath: .metadata.creationTimestamp  name: Age  type: date  name: v1beta1  schema:  openAPIV3Schema:  properties:  spec:  description: PeerAuthentication defines how traffic will be tunneled (or  not) to the sidecar.  properties:  mtls:  description: Mutual TLS settings for workload.  properties:  mode:  description: Defines the mTLS mode used for peer authentication.  enum:  - UNSET  - DISABLE  - PERMISSIVE  - STRICT  type: string  type: object  portLevelMtls:  additionalProperties:  properties:  mode:  description: Defines the mTLS mode used for peer authentication.  enum:  - UNSET  - DISABLE  - PERMISSIVE  - STRICT  type: string  type: object  description: Port specific mutual TLS settings.  type: object  selector:  description: The selector determines the workloads to apply the ChannelAuthentication  on.  properties:  matchLabels:  additionalProperties:  type: string  type: object  type: object  type: object  status:  type: object  x-kubernetes-preserve-unknown-fields: true  type: object  served: true  storage: true  subresources:  status: {} --- # Source: base/templates/crds.yaml apiVersion: apiextensions.k8s.io/v1 kind: CustomResourceDefinition metadata:  annotations:  \"helm.sh/resource-policy\": keep  labels:  app: istio-pilot  chart: istio  heritage: Tiller  istio: security  release: istio  name: requestauthentications.security.istio.io spec:  group: security.istio.io  names:  categories:  - istio-io  - security-istio-io  kind: RequestAuthentication  listKind: RequestAuthenticationList  plural: requestauthentications  shortNames:  - ra  singular: requestauthentication  scope: Namespaced  versions:  - name: v1beta1  schema:  openAPIV3Schema:  properties:  spec:  description: RequestAuthentication defines what request authentication  methods are supported by a workload.  properties:  jwtRules:  description: Define the list of JWTs that can be validated at the  selected workloads' proxy.  items:  properties:  audiences:  items:  type: string  type: array  forwardOriginalToken:  description: If set to true, the original token will be kept  for the upstream request.  type: boolean  fromHeaders:  description: List of header locations from which JWT is expected.  items:  properties:  name:  description: The HTTP header name.  type: string  prefix:  description: The prefix that should be stripped before  decoding the token.  type: string  type: object  type: array  fromParams:  description: List of query parameters from which JWT is expected.  items:  type: string  type: array  issuer:  description: Identifies the issuer that issued the JWT.  type: string  jwks:  description: JSON Web Key Set of public keys to validate signature  of the JWT.  type: string  jwks_uri:  type: string  jwksUri:  type: string  outputPayloadToHeader:  type: string  type: object  type: array  selector:  description: Optional.  properties:  matchLabels:  additionalProperties:  type: string  type: object  type: object  type: object  status:  type: object  x-kubernetes-preserve-unknown-fields: true  type: object  served: true  storage: true  subresources:  status: {} --- # Source: base/templates/crds.yaml apiVersion: apiextensions.k8s.io/v1 kind: CustomResourceDefinition metadata:  annotations:  \"helm.sh/resource-policy\": keep  labels:  app: istio-pilot  chart: istio  heritage: Tiller  istio: telemetry  release: istio  name: telemetries.telemetry.istio.io spec:  group: telemetry.istio.io  names:  categories:  - istio-io  - telemetry-istio-io  kind: Telemetry  listKind: TelemetryList  plural: telemetries  shortNames:  - telemetry  singular: telemetry  scope: Namespaced  versions:  - additionalPrinterColumns:  - description: 'CreationTimestamp is a timestamp representing the server time when this object was created. It is not guaranteed to be set in happens-before order across separate operations. Clients may not set this value. It is represented in RFC3339 form and is in UTC. Populated by the system. Read-only. Null for lists. More info: https://git.k8s.io/community/contributors/devel/api-conventions.md#metadata'  jsonPath: .metadata.creationTimestamp  name: Age  type: date  name: v1alpha1  schema:  openAPIV3Schema:  properties:  spec:  description: 'Telemetry configuration for workloads. See more details at: https://istio.io/docs/reference/config/telemetry.html'  properties:  accessLogging:  description: Optional.  items:  properties:  disabled:  description: Controls logging.  nullable: true  type: boolean  filter:  description: Optional.  properties:  expression:  description: CEL expression for selecting when requests/connections  should be logged.  type: string  type: object  providers:  description: Optional.  items:  properties:  name:  description: Required.  type: string  type: object  type: array  type: object  type: array  metrics:  description: Optional.  items:  properties:  overrides:  description: Optional.  items:  properties:  disabled:  description: Optional.  nullable: true  type: boolean  match:  description: Match allows provides the scope of the override.  oneOf:  - not:  anyOf:  - required:  - metric  - required:  - customMetric  - required:  - metric  - required:  - customMetric  properties:  customMetric:  description: Allows free-form specification of a metric.  type: string  metric:  description: One of the well-known Istio Standard  Metrics.  enum:  - ALL_METRICS  - REQUEST_COUNT  - REQUEST_DURATION  - REQUEST_SIZE  - RESPONSE_SIZE  - TCP_OPENED_CONNECTIONS  - TCP_CLOSED_CONNECTIONS  - TCP_SENT_BYTES  - TCP_RECEIVED_BYTES  - GRPC_REQUEST_MESSAGES  - GRPC_RESPONSE_MESSAGES  type: string  mode:  description: 'Controls which mode of metrics generation is selected: CLIENT and/or SERVER.'  enum:  - CLIENT_AND_SERVER  - CLIENT  - SERVER  type: string  type: object  tagOverrides:  additionalProperties:  properties:  operation:  description: Operation controls whether or not to  update/add a tag, or to remove it.  enum:  - UPSERT  - REMOVE  type: string  value:  description: Value is only considered if the operation  is `UPSERT`.  type: string  type: object  description: Optional.  type: object  type: object  type: array  providers:  description: Optional.  items:  properties:  name:  description: Required.  type: string  type: object  type: array  type: object  type: array  selector:  description: Optional.  properties:  matchLabels:  additionalProperties:  type: string  type: object  type: object  tracing:  description: Optional.  items:  properties:  customTags:  additionalProperties:  oneOf:  - not:  anyOf:  - required:  - literal  - required:  - environment  - required:  - header  - required:  - literal  - required:  - environment  - required:  - header  properties:  environment:  description: Environment adds the value of an environment  variable to each span.  properties:  defaultValue:  description: Optional.  type: string  name:  description: Name of the environment variable from  which to extract the tag value.  type: string  type: object  header:  description: RequestHeader adds the value of an header  from the request to each span.  properties:  defaultValue:  description: Optional.  type: string  name:  description: Name of the header from which to extract  the tag value.  type: string  type: object  literal:  description: Literal adds the same, hard-coded value to  each span.  properties:  value:  description: The tag value to use.  type: string  type: object  type: object  description: Optional.  type: object  disableSpanReporting:  description: Controls span reporting.  nullable: true  type: boolean  providers:  description: Optional.  items:  properties:  name:  description: Required.  type: string  type: object  type: array  randomSamplingPercentage:  nullable: true  type: number  useRequestIdForTraceSampling:  nullable: true  type: boolean  type: object  type: array  type: object  status:  type: object  x-kubernetes-preserve-unknown-fields: true  type: object  served: true  storage: true  subresources:  status: {} --- # Source: base/templates/crds.yaml # SYNC WITH manifests/charts/istio-operator/templates apiVersion: apiextensions.k8s.io/v1 kind: CustomResourceDefinition metadata:  name: istiooperators.install.istio.io  labels:  release: istio spec:  conversion:  strategy: None  group: install.istio.io  names:  kind: IstioOperator  listKind: IstioOperatorList  plural: istiooperators  singular: istiooperator  shortNames:  - iop  - io  scope: Namespaced  versions:  - additionalPrinterColumns:  - description: Istio control plane revision  jsonPath: .spec.revision  name: Revision  type: string  - description: IOP current state  jsonPath: .status.status  name: Status  type: string  - description: 'CreationTimestamp is a timestamp representing the server time when this object was created. It is not guaranteed to be set in happens-before order across separate operations. Clients may not set this value. It is represented in RFC3339 form and is in UTC. Populated by the system. Read-only. Null for lists. More info: https://git.k8s.io/community/contributors/devel/api-conventions.md#metadata'  jsonPath: .metadata.creationTimestamp  name: Age  type: date  subresources:  status: {}  name: v1alpha1  schema:  openAPIV3Schema:  type: object  x-kubernetes-preserve-unknown-fields: true  served: true  storage: true --- # Source: base/templates/clusterrole.yaml # -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=- # DO NOT EDIT! # THIS IS A LEGACY CHART HERE FOR BACKCOMPAT # UPDATED CHART AT manifests/charts/istio-control/istio-discovery # -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=- apiVersion: rbac.authorization.k8s.io/v1 kind: ClusterRole metadata:  name: istiod-istio-system  labels:  app: istiod  release: istio-base rules:  # sidecar injection controller  - apiGroups: [\"admissionregistration.k8s.io\"]  resources: [\"mutatingwebhookconfigurations\"]  verbs: [\"get\", \"list\", \"watch\", \"update\", \"patch\"]   # configuration validation webhook controller  - apiGroups: [\"admissionregistration.k8s.io\"]  resources: [\"validatingwebhookconfigurations\"]  verbs: [\"get\", \"list\", \"watch\", \"update\"]   # istio configuration  # removing CRD permissions can break older versions of Istio running alongside this control plane (https://github.com/istio/istio/issues/29382)  # please proceed with caution  - apiGroups: [\"config.istio.io\", \"security.istio.io\", \"networking.istio.io\", \"authentication.istio.io\", \"rbac.istio.io\", \"telemetry.istio.io\"]  verbs: [\"get\", \"watch\", \"list\"]  resources: [\"*\"]  - apiGroups: [\"networking.istio.io\"]  verbs: [ \"get\", \"watch\", \"list\", \"update\", \"patch\", \"create\", \"delete\" ]  resources: [ \"workloadentries\" ]  - apiGroups: [\"networking.istio.io\"]  verbs: [ \"get\", \"watch\", \"list\", \"update\", \"patch\", \"create\", \"delete\" ]  resources: [ \"workloadentries/status\" ]   # auto-detect installed CRD definitions  - apiGroups: [\"apiextensions.k8s.io\"]  resources: [\"customresourcedefinitions\"]  verbs: [\"get\", \"list\", \"watch\"]   # discovery and routing  - apiGroups: [\"\"]  resources: [\"pods\", \"nodes\", \"services\", \"namespaces\", \"endpoints\"]  verbs: [\"get\", \"list\", \"watch\"]  - apiGroups: [\"discovery.k8s.io\"]  resources: [\"endpointslices\"]  verbs: [\"get\", \"list\", \"watch\"]   # ingress controller  - apiGroups: [\"networking.k8s.io\"]  resources: [\"ingresses\", \"ingressclasses\"]  verbs: [\"get\", \"list\", \"watch\"]  - apiGroups: [\"networking.k8s.io\"]  resources: [\"ingresses/status\"]  verbs: [\"*\"]   # required for CA's namespace controller  - apiGroups: [\"\"]  resources: [\"configmaps\"]  verbs: [\"create\", \"get\", \"list\", \"watch\", \"update\"]   # Istiod and bootstrap.  - apiGroups: [\"certificates.k8s.io\"]  resources:  - \"certificatesigningrequests\"  - \"certificatesigningrequests/approval\"  - \"certificatesigningrequests/status\"  verbs: [\"update\", \"create\", \"get\", \"delete\", \"watch\"]  - apiGroups: [\"certificates.k8s.io\"]  resources:  - \"signers\"  resourceNames:  - \"kubernetes.io/legacy-unknown\"  verbs: [\"approve\"]   # Used by Istiod to verify the JWT tokens  - apiGroups: [\"authentication.k8s.io\"]  resources: [\"tokenreviews\"]  verbs: [\"create\"]   # Used by Istiod to verify gateway SDS  - apiGroups: [\"authorization.k8s.io\"]  resources: [\"subjectaccessreviews\"]  verbs: [\"create\"]   # Use for Kubernetes Service APIs  - apiGroups: [\"networking.x-k8s.io\", \"gateway.networking.k8s.io\"]  resources: [\"*\"]  verbs: [\"get\", \"watch\", \"list\"]  - apiGroups: [\"networking.x-k8s.io\", \"gateway.networking.k8s.io\"]  resources: [\"*\"] # TODO: should be on just */status but wildcard is not supported  verbs: [\"update\"]   # Needed for multicluster secret reading, possibly ingress certs in the future  - apiGroups: [\"\"]  resources: [\"secrets\"]  verbs: [\"get\", \"watch\", \"list\"]   # Used for MCS serviceexport management  - apiGroups: [\"multicluster.x-k8s.io\"]  resources: [\"serviceexports\"]  verbs: [\"get\", \"watch\", \"list\", \"create\", \"delete\"]   # Used for MCS serviceimport management  - apiGroups: [\"multicluster.x-k8s.io\"]  resources: [\"serviceimports\"]  verbs: [\"get\", \"watch\", \"list\"] --- # Source: base/templates/clusterrole.yaml apiVersion: rbac.authorization.k8s.io/v1 kind: ClusterRole metadata:  name: istio-reader-istio-system  labels:  app: istio-reader  release: istio-base rules:  - apiGroups:  - \"config.istio.io\"  - \"security.istio.io\"  - \"networking.istio.io\"  - \"authentication.istio.io\"  - \"rbac.istio.io\"  resources: [\"*\"]  verbs: [\"get\", \"list\", \"watch\"]  - apiGroups: [\"\"]  resources: [\"endpoints\", \"pods\", \"services\", \"nodes\", \"replicationcontrollers\", \"namespaces\", \"secrets\"]  verbs: [\"get\", \"list\", \"watch\"]  - apiGroups: [\"networking.istio.io\"]  verbs: [ \"get\", \"watch\", \"list\" ]  resources: [ \"workloadentries\" ]  - apiGroups: [\"apiextensions.k8s.io\"]  resources: [\"customresourcedefinitions\"]  verbs: [\"get\", \"list\", \"watch\"]  - apiGroups: [\"discovery.k8s.io\"]  resources: [\"endpointslices\"]  verbs: [\"get\", \"list\", \"watch\"]  - apiGroups: [\"apps\"]  resources: [\"replicasets\"]  verbs: [\"get\", \"list\", \"watch\"]  - apiGroups: [\"authentication.k8s.io\"]  resources: [\"tokenreviews\"]  verbs: [\"create\"]  - apiGroups: [\"authorization.k8s.io\"]  resources: [\"subjectaccessreviews\"]  verbs: [\"create\"]  - apiGroups: [\"multicluster.x-k8s.io\"]  resources: [\"serviceexports\"]  verbs: [\"get\", \"watch\", \"list\"]  - apiGroups: [\"multicluster.x-k8s.io\"]  resources: [\"serviceimports\"]  verbs: [\"get\", \"watch\", \"list\"] --- # Source: base/templates/clusterrolebinding.yaml # -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=- # DO NOT EDIT! # THIS IS A LEGACY CHART HERE FOR BACKCOMPAT # UPDATED CHART AT manifests/charts/istio-control/istio-discovery # -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=- apiVersion: rbac.authorization.k8s.io/v1 kind: ClusterRoleBinding metadata:  name: istio-reader-istio-system  labels:  app: istio-reader  release: istio-base roleRef:  apiGroup: rbac.authorization.k8s.io  kind: ClusterRole  name: istio-reader-istio-system subjects:  - kind: ServiceAccount  name: istio-reader-service-account  namespace: istio-system --- # Source: base/templates/clusterrolebinding.yaml apiVersion: rbac.authorization.k8s.io/v1 kind: ClusterRoleBinding metadata:  name: istiod-istio-system  labels:  app: istiod  release: istio-base roleRef:  apiGroup: rbac.authorization.k8s.io  kind: ClusterRole  name: istiod-istio-system subjects:  - kind: ServiceAccount  name: istiod-service-account  namespace: istio-system --- # Source: base/templates/role.yaml # -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=- # DO NOT EDIT! # THIS IS A LEGACY CHART HERE FOR BACKCOMPAT # UPDATED CHART AT manifests/charts/istio-control/istio-discovery # -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=- apiVersion: rbac.authorization.k8s.io/v1 kind: Role metadata:  name: istiod-istio-system  namespace: istio-system  labels:  app: istiod  release: istio-base rules: # permissions to verify the webhook is ready and rejecting # invalid config. We use --server-dry-run so no config is persisted. - apiGroups: [\"networking.istio.io\"]  verbs: [\"create\"]  resources: [\"gateways\"]  # For storing CA secret - apiGroups: [\"\"]  resources: [\"secrets\"]  # TODO lock this down to istio-ca-cert if not using the DNS cert mesh config  verbs: [\"create\", \"get\", \"watch\", \"list\", \"update\", \"delete\"] --- # Source: base/templates/rolebinding.yaml # -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=- # DO NOT EDIT! # THIS IS A LEGACY CHART HERE FOR BACKCOMPAT # UPDATED CHART AT manifests/charts/istio-control/istio-discovery # -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=- apiVersion: rbac.authorization.k8s.io/v1 kind: RoleBinding metadata:  name: istiod-istio-system  namespace: istio-system  labels:  app: istiod  release: istio-base roleRef:  apiGroup: rbac.authorization.k8s.io  kind: Role  name: istiod-istio-system subjects:  - kind: ServiceAccount  name: istiod-service-account  namespace: istio-system --- # Source: base/templates/default.yaml apiVersion: admissionregistration.k8s.io/v1 kind: ValidatingWebhookConfiguration metadata:  name: istiod-default-validator  labels:  app: istiod  release: istio-base  istio: istiod  istio.io/rev: default webhooks:  - name: validation.istio.io  clientConfig:  service:  name: istiod  namespace: istio-system  path: \"/validate\"  rules:  - operations:  - CREATE  - UPDATE  apiGroups:  - security.istio.io  - networking.istio.io  apiVersions:  - \"*\"  resources:  - \"*\"  # Fail open until the validation webhook is ready. The webhook controller  # will update this to `Fail` and patch in the `caBundle` when the webhook  # endpoint is ready.  failurePolicy: Ignore  sideEffects: None  admissionReviewVersions: [\"v1beta1\", \"v1\"] 安装Istiod helm template istiod manifests/charts/istio-control/istio-discovery \\  --set global.hub=\"registry.cn-hangzhou.aliyuncs.com/seam\" \\  --set global.tag=\"1.13.4\" \\  --set pilot.image=\"istio-pilot\" \\  --set meshConfig.trustDomain=\"alongparty.cn\" \\  --set global.proxy.clusterDomain=\"alongparty.cn\" \\  --set global.proxy.resources.limits.cpu=\"2000m\" \\  --set global.proxy.resources.limits.memory=\"4096Mi\" \\  --set pilot.resources.limits.cpu=\"2000m\" \\  --set pilot.resources.limits.memory=\"4096Mi\" \\  -n istio-system 安装IngressGateway helm template istio-ingress manifests/charts/gateways/istio-ingress \\  --set global.hub=\"registry.cn-hangzhou.aliyuncs.com/seam\" \\  --set global.tag=\"1.13.4\" \\  --set global.proxy.image=\"istio-proxyv2\" \\  --set meshConfig.trustDomain=\"alongparty.cn\" \\  --set global.proxy.clusterDomain=\"alongparty.cn\" \\  -n istio-system 安装EgressGateway helm template istio-egress manifests/charts/gateways/istio-egress \\  --set global.hub=\"registry.cn-hangzhou.aliyuncs.com/seam\" \\  --set global.tag=\"1.13.4\" \\  --set global.proxy.image=\"istio-proxyv2\" \\  --set meshConfig.trustDomain=\"alongparty.cn\" \\  --set global.proxy.clusterDomain=\"alongparty.cn\" \\  -n istio-system Istio-operator安装 创建 istio-operator 名称空间 kubectl apply -f - \u003c\u003cEOF --- apiVersion: v1 kind: Namespace metadata:  name: istio-operator EOF 部署 Istio-operator kubectl apply -f - \u003c\u003cEOF --- # Source: istio-operator/templates/service_account.yaml apiVersion: v1 kind: ServiceAccount metadata:  namespace: istio-operator  name: istio-operator --- # Source: istio-operator/templates/crds.yaml # SYNC WITH manifests/charts/base/files apiVersion: apiextensions.k8s.io/v1 kind: CustomResourceDefinition metadata:  name: istiooperators.install.istio.io  labels:  release: istio spec:  conversion:  strategy: None  group: install.istio.io  names:  kind: IstioOperator  listKind: IstioOperatorList  plural: istiooperators  singular: istiooperator  shortNames:  - iop  - io  scope: Namespaced  versions:  - additionalPrinterColumns:  - description: Istio control plane revision  jsonPath: .spec.revision  name: Revision  type: string  - description: IOP current state  jsonPath: .status.status  name: Status  type: string  - description: 'CreationTimestamp is a timestamp representing the server time when this object was created. It is not guaranteed to be set in happens-before order across separate operations. Clients may not set this value. It is represented in RFC3339 form and is in UTC. Populated by the system. Read-only. Null for lists. More info: https://git.k8s.io/community/contributors/devel/api-conventions.md#metadata'  jsonPath: .metadata.creationTimestamp  name: Age  type: date  name: v1alpha1  subresources:  status: {}  schema:  openAPIV3Schema:  type: object  x-kubernetes-preserve-unknown-fields: true  served: true  storage: true --- # Source: istio-operator/templates/clusterrole.yaml apiVersion: rbac.authorization.k8s.io/v1 kind: ClusterRole metadata:  creationTimestamp: null  name: istio-operator rules: # istio groups - apiGroups:  - authentication.istio.io  resources:  - '*'  verbs:  - '*' - apiGroups:  - config.istio.io  resources:  - '*'  verbs:  - '*' - apiGroups:  - install.istio.io  resources:  - '*'  verbs:  - '*' - apiGroups:  - networking.istio.io  resources:  - '*'  verbs:  - '*' - apiGroups:  - security.istio.io  resources:  - '*'  verbs:  - '*' # k8s groups - apiGroups:  - admissionregistration.k8s.io  resources:  - mutatingwebhookconfigurations  - validatingwebhookconfigurations  verbs:  - '*' - apiGroups:  - apiextensions.k8s.io  resources:  - customresourcedefinitions.apiextensions.k8s.io  - customresourcedefinitions  verbs:  - '*' - apiGroups:  - apps  - extensions  resources:  - daemonsets  - deployments  - deployments/finalizers  - replicasets  verbs:  - '*' - apiGroups:  - autoscaling  resources:  - horizontalpodautoscalers  verbs:  - '*' - apiGroups:  - monitoring.coreos.com  resources:  - servicemonitors  verbs:  - get  - create  - update - apiGroups:  - policy  resources:  - poddisruptionbudgets  verbs:  - '*' - apiGroups:  - rbac.authorization.k8s.io  resources:  - clusterrolebindings  - clusterroles  - roles  - rolebindings  verbs:  - '*' - apiGroups:  - coordination.k8s.io  resources:  - leases  verbs:  - get  - create  - update - apiGroups:  - \"\"  resources:  - configmaps  - endpoints  - events  - namespaces  - pods  - pods/proxy  - pods/portforward  - persistentvolumeclaims  - secrets  - services  - serviceaccounts  verbs:  - '*' --- # Source: istio-operator/templates/clusterrole_binding.yaml kind: ClusterRoleBinding apiVersion: rbac.authorization.k8s.io/v1 metadata:  name: istio-operator subjects: - kind: ServiceAccount  name: istio-operator  namespace: istio-operator roleRef:  kind: ClusterRole  name: istio-operator  apiGroup: rbac.authorization.k8s.io --- # Source: istio-operator/templates/service.yaml apiVersion: v1 kind: Service metadata:  namespace: istio-operator  labels:  name: istio-operator  name: istio-operator spec:  ports:  - name: http-metrics  port: 8383  targetPort: 8383  protocol: TCP  selector:  name: istio-operator --- # Source: istio-operator/templates/deployment.yaml apiVersion: apps/v1 kind: Deployment metadata:  namespace: istio-operator  name: istio-operator spec:  replicas: 1  revisionHistoryLimit: 10  selector:  matchLabels:  name: istio-operator  template:  metadata:  labels:  name: istio-operator  spec:  serviceAccountName: istio-operator  containers:  - name: istio-operator  image: docker.io/istio/operator:1.15.0  command:  - operator  - server  securityContext:  allowPrivilegeEscalation: false  capabilities:  drop:  - ALL  privileged: false  readOnlyRootFilesystem: true  runAsGroup: 1337  runAsUser: 1337  runAsNonRoot: true  imagePullPolicy: IfNotPresent  resources:  limits:  cpu: 200m  memory: 256Mi  requests:  cpu: 50m  memory: 128Mi  env:  - name: WATCH_NAMESPACE  value: \"istio-system\"  - name: LEADER_ELECTION_NAMESPACE  value: \"istio-operator\"  - name: POD_NAME  valueFrom:  fieldRef:  fieldPath: metadata.name  - name: OPERATOR_NAME  value: \"istio-operator\"  - name: WAIT_FOR_RESOURCES_TIMEOUT  value: \"300s\"  - name: REVISION  value: \"\" EOF 创建 istio-system 名称空间 kubectl apply -f - \u003c\u003cEOF --- apiVersion: v1 kind: Namespace metadata:  name: istio-system EOF 使用demo配置项安装istio组件 kubectl apply -f - \u003c\u003cEOF apiVersion: install.istio.io/v1alpha1 kind: IstioOperator metadata:  namespace: istio-system  name: istiocontrolplane spec:  profile: demo EOF 更新IstioOperator kubectl apply -f - \u003c\u003cEOF apiVersion: install.istio.io/v1alpha1 kind: IstioOperator metadata:  namespace: istio-system  name: istiocontrolplane spec:  profile: default EOF 启用 istio-egressgateway 组件并增加 pilot 的资源要求和HPA kubectl apply -f - \u003c\u003cEOF apiVersion: install.istio.io/v1alpha1 kind: IstioOperator metadata:  namespace: istio-system  name: istiocontrolplane spec:  profile: default  components:  pilot:  k8s:  resources:  requests:  cpu: 1000m # override from default 500m  memory: 4096Mi # ... default 2048Mi  hpaSpec:  maxReplicas: 10 # ... default 5  minReplicas: 2 # ... default 1  egressGateways:  - name: istio-egressgateway  enabled: true EOF operator 渲染顺序\n","categories":["云原生"],"description":"","excerpt":"Helm 安装 安装基础资源 helm template istio-base manifests/charts/base \\  -n …","ref":"/blog/2022/09/11/bf667a/","tags":["istio"],"title":"Istio部署实战"},{"body":"本文将为你讲解：\n Istio 中 sidecar 自动注入过程 Istio 中的 init 容器启动过程 启用了 Sidecar 自动注入的 Pod 的启动流程  下图中展示了 Istio 数据平面中的 Pod 启动完后的组件。\nIstio 中的 sidecar 注入 Istio 中提供了以下两种 sidecar 注入方式：\n 使用 istioctl 手动注入。 基于 Kubernetes 的 突变 webhook 准入控制器（mutating webhook addmission controller 的自动 sidecar 注入方式。  不论是手动注入还是自动注入，sidecar 的注入过程都需要遵循如下步骤：\n Kubernetes 需要了解待注入的 sidecar 所连接的 Istio 集群及其配置； Kubernetes 需要了解待注入的 sidecar 容器本身的配置，如镜像地址、启动参数等； Kubernetes 根据 sidecar 注入模板和以上配置填充 sidecar 的配置参数，将以上配置注入到应用容器的一侧；  使用下面的命令可以手动注入 sidecar。\nistioctl kube-inject -f ${YAML_FILE} | kuebectl apply -f - 该命令会使用 Istio 内置的 sidecar 配置来注入，下面使用 Istio详细配置请参考 Istio 官网。\n注入完成后您将看到 Istio 为原有 pod template 注入了 initContainer 及 sidecar proxy相关的配置。\nInit 容器 Init 容器是一种专用容器，它在应用程序容器启动之前运行，用来包含一些应用镜像中不存在的实用工具或安装脚本。\n一个 Pod 中可以指定多个 Init 容器，如果指定了多个，那么 Init 容器将会按顺序依次运行。只有当前面的 Init 容器必须运行成功后，才可以运行下一个 Init 容器。当所有的 Init 容器运行完成后，Kubernetes 才初始化 Pod 和运行应用容器。\nInit 容器使用 Linux Namespace，所以相对应用程序容器来说具有不同的文件系统视图。因此，它们能够具有访问 Secret 的权限，而应用程序容器则不能。\n在 Pod 启动过程中，Init 容器会按顺序在网络和数据卷初始化之后启动。每个容器必须在下一个容器启动之前成功退出。如果由于运行时或失败退出，将导致容器启动失败，它会根据 Pod 的 restartPolicy 指定的策略进行重试。然而，如果 Pod 的 restartPolicy 设置为 Always，Init 容器失败时会使用 RestartPolicy 策略。\n在所有的 Init 容器没有成功之前，Pod 将不会变成 Ready 状态。Init 容器的端口将不会在 Service中进行聚集。 正在初始化中的 Pod 处于 Pending 状态，但应该会将 Initializing 状态设置为 true。Init 容器运行完成以后就会自动终止。\n关于 Init 容器的详细信息请参考 Init 容器 - Kubernetes 中文指南/云原生应用架构实践手册。\nInit 容器解析 Istio 在 pod 中注入的 Init 容器名为 istio-init，我们在上面 Istio 注入完成后的 YAML 文件中看到了该容器的启动命令是：\nistio-iptables -p 15001 -z 15006 -u 1337 -m REDIRECT -i '*' -x \"\" -b '*' -d 15090,15020 我们再检查下该容器的 Dockerfile 看看 ENTRYPOINT 是怎么确定启动时执行的命令。\n# 前面的内容省略# The pilot-agent will bootstrap Envoy.ENTRYPOINT [\"/usr/local/bin/pilot-agent\"]我们看到 istio-init 容器的入口是 /usr/local/bin/istio-iptables 命令行，该命令行工具的代码的位置在 Istio 源码仓库的 tools/istio-iptables 目录。\n注意：在 Istio 1.1 版本时还是使用 isito-iptables.sh 命令行来操作 IPtables。\nInit 容器启动入口 Init 容器的启动入口是 istio-iptables 命令行，该命令行工具的用法如下：\n$ istio-iptables [flags]  -p: 指定重定向所有 TCP 流量的 sidecar 端口（默认为 $ENVOY_PORT = 15001）  -m: 指定入站连接重定向到 sidecar 的模式，“REDIRECT” 或 “TPROXY”（默认为 $ISTIO_INBOUND_INTERCEPTION_MODE)  -b: 逗号分隔的入站端口列表，其流量将重定向到 Envoy（可选）。使用通配符 “*” 表示重定向所有端口。为空时表示禁用所有入站重定向（默认为 $ISTIO_INBOUND_PORTS）  -d: 指定要从重定向到 sidecar 中排除的入站端口列表（可选），以逗号格式分隔。使用通配符“*” 表示重定向所有入站流量（默认为 $ISTIO_LOCAL_EXCLUDE_PORTS）  -o：逗号分隔的出站端口列表，不包括重定向到 Envoy 的端口。  -i: 指定重定向到 sidecar 的 IP 地址范围（可选），以逗号分隔的 CIDR 格式列表。使用通配符 “*” 表示重定向所有出站流量。空列表将禁用所有出站重定向（默认为 $ISTIO_SERVICE_CIDR）  -x: 指定将从重定向中排除的 IP 地址范围，以逗号分隔的 CIDR 格式列表。使用通配符 “*” 表示重定向所有出站流量（默认为 $ISTIO_SERVICE_EXCLUDE_CIDR）。  -k：逗号分隔的虚拟接口列表，其入站流量（来自虚拟机的）将被视为出站流量。  -g：指定不应用重定向的用户的 GID。(默认值与 -u param 相同)  -u：指定不应用重定向的用户的 UID。通常情况下，这是代理容器的 UID（默认值是 1337，即 istio-proxy 的 UID）。  -z: 所有进入 pod/VM 的 TCP 流量应被重定向到的端口（默认 $INBOUND_CAPTURE_PORT = 15006）。 以上传入的参数都会重新组装成 iptables 规则，关于该命令的详细用法请访问 tools/istio-iptables/pkg/cmd/root.go。\n该容器存在的意义就是让 sidecar 代理可以拦截所有的进出 pod 的流量，15090 端口（Mixer 使用）和 15092 端口（Ingress Gateway）除外的所有入站（inbound）流量重定向到 15006 端口（sidecar），再拦截应用容器的出站（outbound）流量经过 sidecar 处理（通过 15001 端口监听）后再出站。关于 Istio 中端口用途请参考 Istio 官方文档。\n命令解析\n这条启动命令的作用是：\n 将应用容器的所有流量都转发到 sidecar 的 15006 端口。 使用 istio-proxy 用户身份运行， UID 为 1337，即 sidecar 所处的用户空间，这也是 istio-proxy 容器默认使用的用户，见 YAML 配置中的 runAsUser 字段。 使用默认的 REDIRECT 模式来重定向流量。 将所有出站流量都重定向到 sidecar 代理（通过 15001 端口）。  因为 Init 容器初始化完毕后就会自动终止，因为我们无法登陆到容器中查看 iptables 信息，但是 Init 容器初始化结果会保留到应用容器和 sidecar 容器中。\nPod 启动流程 启用了 Sidecar 自动注入的 Pod 启动流程如下：\n Init 容器先启动，向 Pod 中注入 iptables 规则，进行透明流量拦截。 随后，Kubernetes 会根据 Pod Spec 中容器的声明顺序依次启动容器，但这是非阻塞的，无法保证第一个容器启动完成后才启动下一个。istio-proxy 容器启动时，pilot-agent 将作为 PID 1 号进程，它是 Linux 用户空间的第一个进程，负责拉起其他进程和处理僵尸进程。pilot-agent 将生成 Envoy bootstrap 配置并拉起 envoy 进程；应用容器几乎跟 istio-proxy 容器同时启动，为了防止 Pod 内的容器在还没启动好的情况而接收到外界流量，这时候就绪探针就派上用场了。Kubernetes 会在 istio-proxy 容器的 15021 端口进行就绪检查，直到 isito-proxy 启动完成后 kubelet 才会将流量路由到 Pod 内。 在 Pod 启动完成后，pilot-agent 将变为守护进程监视系统其他进程，除此之外，该进程还为 Envoy 提供 Bootstrap 配置、证书、健康检查、配置热加载、身份支持及进程生命周期管理等。  Pod 内容器启动顺序问题 在 Pod 启动的过程中存在容器启动顺序问题，假设下面这种情况，应用容器先启动，请求其他服务，这时候 istio-proxy 容器还没启动完成，那么该请求将会失败，如果你的应用的健壮性不足，甚至可能导致应用容器崩溃，进而 Pod 重启。对于这种情况的解决方案是：\n 修改应用程序，增加超时重试。 增加应用容器中进程的启动延迟，比如增加 sleep 时间。 在应用容器中增加一个 postStart 配置，检测应用进程是否启动完成，只有当检测成功时，Kubernetes 才会将 Pod 的状态标记为 Running。  总结 这篇文章带领大家了解了 Istio 数据平面中的 Pod 启动过程，还有因为 Pod 内容器启动顺序带来的问题。\n参考   阅读原文\n  istio 常见问题: Sidecar 启动顺序问题 - imroc.cc\n  ","categories":["云原生"],"description":"","excerpt":"本文将为你讲解：\n Istio 中 sidecar 自动注入过程 Istio 中的 init 容器启动过程 启用了 Sidecar 自动注入 …","ref":"/blog/2022/09/10/dc5625/","tags":["istio","转载"],"title":"深入Istio系列-数据平面Pod启动过程详解"},{"body":"","categories":"","description":"","excerpt":"","ref":"/tags/iptable/","tags":"","title":"iptable"},{"body":"iptables 作为 Linux 内核中的重要功能，有着广泛的应用，在 Istio 中默认就是利用 iptables 做透明流量劫持的。理解 iptables，对于我们理解 Istio 的运作有十分重要的作用。本文将为大家简单介绍下 iptbles。\niptables 简介 iptables 是 Linux 内核中的防火墙软件 netfilter 的管理工具，位于用户空间，同时也是 netfilter 的一部分。Netfilter 位于内核空间，不仅有网络地址转换的功能，也具备数据包内容修改、以及数据包过滤等防火墙功能。\n在了解 Init 容器初始化的 iptables 之前，我们先来了解下 iptables 和规则配置。\n下图展示了 iptables 调用链。\niptables 中的表 Init 容器中使用的的 iptables 版本是 v1.6.0，共包含 5 张表：\n raw 用于配置数据包，raw 中的数据包不会被系统跟踪。 filter 是用于存放所有与防火墙相关操作的默认表。 nat 用于 网络地址转换（例如：端口转发）。 mangle 用于对特定数据包的修改（参考损坏数据包）。 security 用于强制访问控制 网络规则。  注：在本示例中只用到了 nat 表。\n不同的表中的具有的链类型如下表所示：\n   规则名称 raw filter nat mangle security     PREROUTING ✓  ✓ ✓    INPUT  ✓  ✓ ✓   OUTPUT ✓ ✓ ✓ ✓ ✓   POSTROUTING   ✓ ✓    FORWARD  ✓  ✓ ✓    理解 iptables 规则 查看 istio-proxy 容器中的默认的 iptables 规则，默认查看的是 filter 表中的规则。\n$ iptables -L -v Chain INPUT (policy ACCEPT 350K packets, 63M bytes)  pkts bytes target prot opt in out source destination  Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)  pkts bytes target prot opt in out source destination  Chain OUTPUT (policy ACCEPT 18M packets, 1916M bytes)  pkts bytes target prot opt in out source destination 我们看到三个默认的链，分别是 INPUT、FORWARD 和 OUTPUT，每个链中的第一行输出表示链名称（在本例中为INPUT/FORWARD/OUTPUT），后跟默认策略（ACCEPT）。\n每条链中都可以添加多条规则，规则是按照顺序从前到后执行的。我们来看下规则的表头定义。\n pkts：处理过的匹配的报文数量 bytes：累计处理的报文大小（字节数） target：如果报文与规则匹配，指定目标就会被执行。 prot：协议，例如 tdp、udp、icmp 和 all。 opt：很少使用，这一列用于显示 IP 选项。 in：入站网卡。 out：出站网卡。 source：流量的源 IP 地址或子网，或者是 anywhere。 destination：流量的目的地 IP 地址或子网，或者是 anywhere。  还有一列没有表头，显示在最后，表示规则的选项，作为规则的扩展匹配条件，用来补充前面的几列中的配置。prot、opt、in、out、source 和 destination 和显示在 destination 后面的没有表头的一列扩展条件共同组成匹配规则。当流量匹配这些规则后就会执行 target。\ntarget 支持的类型\ntarget 类型包括 ACCEPT、REJECT、DROP、LOG 、SNAT、MASQUERADE、DNAT、REDIRECT、RETURN 或者跳转到其他规则等。只要执行到某一条链中只有按照顺序有一条规则匹配后就可以确定报文的去向了，除了 RETURN 类型，类似编程语言中的 return 语句，返回到它的调用点，继续执行下一条规则。target 支持的配置详解请参考 iptables 详解（1）：iptables 概念。\n总结 以上就是对 iptables 的简要介绍，你已经了解了 iptables 是怎样运行的，规则链及其执行顺序。\n参考  阅读原文  ","categories":["云原生"],"description":"","excerpt":"iptables 作为 Linux 内核中的重要功能，有着广泛的应用，在 Istio 中默认就是利用 iptables 做透明流量劫持的。理 …","ref":"/blog/2022/09/10/b7e1eb/","tags":["istio","iptable","转载"],"title":"理解Iptable"},{"body":"一、前言 使用 Hugo 有一些时间了，把内容上传到 GitHub Pages，从一开始的手动操作，到脚本操作，终于来到了自动化部署。\n部署的流程：\n流程\n本地通过 Hugo 命令创建文件，编写博客，编写好后把改变的内容上传到 GitHub 博客源文件仓库。通过 GitHub Action 自动触发脚本构建，然后把静态文件通过 GitHub Deploy 到博客仓库。\n二、具体步骤 2.1 创建两个仓库  创建博客源仓库   创建博客静态资源仓库  2.2 创建 SSH 需要生成一对 SSH Key，生成的 Public Key 和 Private Key 都会用到。\nssh-keygen -t rsa -b 4096 -C “ironcity.hz@gmail.com” Generating public/private rsa key pair. Enter file in which to save the key (/Users/tc/.ssh/id_rsa):\n输入你需要指定的文件，比如 /Users/tc/.ssh/id_rsa_hugo_deploy\n 只是为了防止覆盖之前创建的默认文件\n 2.2 配置博客静态资源仓库的 Deploy Keys  添加公钥到 http://funnycode-org.github.io 仓库的 Deploy Keys   添加后  2.3 配置博客源内容仓库的 Secrets  添加私钥到 blog 仓库的 Secrets   添加后   注意这个 secrets 的名称\n 2.4 编写博客  克隆 blog 项目到本地  # 选取一个目录 cd ~/Desktop/ # 克隆 source 仓库 git clone git@github.com:funnycode-org/blog.git # 进入仓库 cd blog\n 创建 hugo 博客  # 创建博客，多语言模式 hugo new /posts/[blog-name]/index.zh-cn.md  # 运行预览效果 hugo serve -D 如果没有什么问题就可以准备提交代码了\ngit add . git commit -m \"update commit\" git push -u origin master 2.5 GitHub Actions 说明 Actions 内容：\nname: Deploy Hugo Site to Github Pages on Master Branch  on:  push:  branches:  - master  jobs:  build-deploy:  runs-on: ubuntu-18.04  steps:  - uses: actions/checkout@v2  with:  submodules: true # Fetch Hugo themes (true OR recursive)  fetch-depth: 0 # Fetch all history for .GitInfo and .Lastmod   - name: Setup Hugo  uses: peaceiris/actions-hugo@v2  with:  hugo-version: '0.76.0'  # extended: true   - name: Build  run: hugo --minify   - name: Deploy  uses: peaceiris/actions-gh-pages@v3  with:  deploy_key: ${{ secrets.ACTIONS_DEPLOY_KEY }}  external_repository: funnycode-org/funnycode-org.github.io # remote branch  publish_dir: \"./docs\"  cname: blog.funnycode.org.cn  keep_files: false # remove existing files  publish_branch: docs # deploying branch  commit_message: ${{ github.event.head_commit.message }}  注意点：\n  publish_dir 指定发布的目录，./docs 指 blog 项目下的 docs 目录下的内容会被发布 publish_branch 发布到 funnycode-org.github.io 项目的 docs 分支 secrets.ACTIONS_DEPLOY_KEY 的 ACTIONS_DEPLOY_KEY 则是上面设置 Private Key 的变量名 cname 必须要配置好，和下文提到的 Setting 里面配置图对应  2.7 http://funnycode-org.github.io 配置  配置 Setting   验证访问  输入 https://blog.funnycode.org.cn，效果：\n","categories":["hugo"],"description":"","excerpt":"一、前言 使用 Hugo 有一些时间了，把内容上传到 GitHub Pages，从一开始的手动操作，到脚本操作，终于来到了自动化部署。\n部署 …","ref":"/docs/hugo/02-hugo-github-action%E8%87%AA%E5%8A%A8%E9%83%A8%E7%BD%B2/","tags":["hugo","GithubAction"],"title":"02 Hugo Github Action自动部署静态博客"},{"body":"","categories":"","description":"","excerpt":"","ref":"/tags/githubaction/","tags":"","title":"GithubAction"},{"body":"","categories":"","description":"","excerpt":"","ref":"/categories/hugo/","tags":"","title":"hugo"},{"body":"","categories":"","description":"","excerpt":"","ref":"/tags/hugo/","tags":"","title":"hugo"},{"body":"","categories":"","description":"使用指南.\n","excerpt":"使用指南.\n","ref":"/docs/","tags":"","title":"文档"},{"body":"前言 两年前用Hexo搭建博客，但是因为各种配置问题没有继续跟进，之后就一直在简书写的博客。恰逢看到新的博客生成工具Hugo，所以重新搭建了一个个人博客网站，通过Github Pages，域名重定向来实现线上访问。本文介绍的就是如何使用Hugo搭建个人博客网站的过程。实际效果可以访问我的博客。\nHugo简介 不同与Hexo是用JavaScript实现的，Hugo是由Go语言实现的静态网站生成器。简单、易用、高效、易扩展、快速部署。从我的个人体验来讲，Hugo比Hexo速度更快，而且不用依赖一大堆东西，一个二进制文件就可以搞定。\n The world’s fastest framework for building websites. Hugo is one of the most popular open-source static site generators. With its amazing speed and flexibility, Hugo makes building websites fun again.\n 这是Hugo的主页对自己的介绍，看这嚣张的简介，“全球最快的网站建设框架”，就不禁想让人来体验一把。\n那么就开始吧！\nHugo快速开始 Hugo的首页有一个显眼的按钮【Quick Start】，点击它，按步骤完成即可\nHugo安装 Mac brew install hugo hugo version Windows 去Hugo releases页面下载hugo_xxx_Windows-64bit.zip 将它解压到一个安全的目录，然后把这个目录添加到环境变量PATH中，重启终端，运行hugo version，正确展示了版本号就说明安装成功。\n快速搭建博客 可以进入Hugo首页，点击Quick Start快速开始，从Step 2开始抄代码，直到Step 7结束。（Step 1是安装Hugo，我们在上文已经介绍了。）\n也可以根据接下来的步骤依次执行：\n  创建一个新的项目（quickstart 是项目名称，可以改成你想要的名字）\nhugo new site quickstart   添加一个主题（这里会安装一个默认主题ananke）\ncd quickstart git init git submodule add https://github.com/budparr/gohugo-theme-ananke.git themes/ananke  echo 'theme = \"ananke\"' \u003e\u003e config.toml   创建一个新的博客\nhugo new posts/my-first-post.md 注意：博客文件开头的 draft: false要改成true，否则改博客不会被生成到public目录中。\n  开启 Hugo Serve，用于本地预览\nhugo server -D   定制主题，如果对步骤2安装的默认主题不满意，可以自己选择一个主题进行替换\n 重复步骤2，把你想要替换的主题GitHub路径替换一下就好，然后在配置文件config.toml里修改下面的配置  baseURL = \"https://example.org/\" languageCode = \"en-us\" title = \"My New Hugo Site\" theme = \"ananke\"  baseURL 改成你的博客主页地址 languageCode 如果是中文博客，可以改成zh-CN title 即博客名称 theme 这里是重点，把theme的值改成你替换的主题的名称，然后主题就生效啦。    构建静态页面\nhugo -D 这个命令执行以后会生成一个./public的目录，将这个目录上传到GitHub，创建一个名为dreamqyq.github.io的项目（dreamqyq 这里替换成你的GitHub账号名），然后使用GitHub Pages就可以让别人来看你的博客啦。\n  Hugo常用命令  hugo 构建静态文件 hugo server -D 本地预览 hugo new blogName.md 生成一个新的博客  主题 我的个人博客网站的主题使用了maupassant （我fork了原项目并做了一点修改，支持了博客目录显示二级目录）主题，在这个主题的Github主页README中有详细的配置方法，这里就不再赘述。如果喜欢的话可以参考教程进行配置。\n遇到的问题 在配置教程的时候遇到了一个问题，上文中提到的配置bashURL应该是个人博客网站的地址，由于我做了Gihubub Pages域名转发，使用了我自己的域名 https://enochqin.xyz（域名已弃用，目前的博客直接使用的GitHub Pages）。在最开始配置的时候，写成了https://www.enochqin.xyz，导致博客的很多功能各种出错，后来才意识到，我的域名没有做www的映射，导致其实https://www.enochqin.xyz这个网址是不能访问的。\n没有www和带www的域名是被看做两个不同的域名的。一般我们都会将两个域名设置指向相同的一个网站。但是实际上带www的和不带www的域名完全可以设置指向两个不同的服务器。这样你访问带www和不带www的地址，看到的是两个不同的网站了。\n（完）\n","categories":["hugo"],"description":"","excerpt":"前言 两年前用Hexo搭建博客，但是因为各种配置问题没有继续跟进，之后就一直在简书写的博客。恰逢看到新的博客生成工具Hugo，所以重新搭建了 …","ref":"/docs/hugo/01-hugo%E4%BD%BF%E7%94%A8%E6%89%8B%E5%86%8C/","tags":["hugo"],"title":"01 Hugo使用手册"},{"body":"","categories":"","description":"","excerpt":"","ref":"/search/","tags":"","title":"Search results"}]